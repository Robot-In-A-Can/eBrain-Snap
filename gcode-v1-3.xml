<blocks app="Snap! 7, https://snap.berkeley.edu" version="2"><palette><category name="Advanced eBrain" color="0,116,143,1"/></palette><block-definition s="G-code to plotter %&apos;g-code&apos;" type="command" category="Advanced eBrain"><header></header><code></code><translations></translations><inputs><input type="%s"></input></inputs><script><block s="doDeclareVariables"><list><l>master list</l><l>x coords</l><l>y coords</l><l>previousX</l><l>previousY</l></list></block><block s="doSetVar"><l>master list</l><block s="evaluate"><block s="reportJSFunction"><list><l>gcode</l></list><l>function badParsed(val) {&#xD;  if (isNaN(val)) {&#xD;    return !(val === undefined || val === null);&#xD;  } else {&#xD;    return false;&#xD;  }&#xD;} &#xD;&#xD;var units = "mm";&#xD;// Implemented commands:&#xD;// g20: inches g21: millimeters&#xD;// M2: program end&#xD;// Unimplemented, but might implement:&#xD;// g90: absolute positioning&#xD;// g91: relative positioning&#xD;&#xD;var points = [];&#xD;var lines = gcode.split(/\r?\n/);&#xD;for (l of lines) {&#xD;  // cut comment if it exists&#xD;  if (l.includes(";")) {&#xD;    l = l.split(";")[0];&#xD;  }&#xD;  if (l.startsWith("G20")) {&#xD;    units = "inches";&#xD;  } else if (l.startsWith("G21")) {&#xD;    units = "mm";&#xD;  } else if (l.startsWith("G1") || l.startsWith("G0")) {&#xD;    var line = l.split(" ");&#xD;    var point = {};&#xD;    for (const c of line) {&#xD;      if (c.startsWith("X")) {&#xD;        point.X = parseFloat(c.substring(1));&#xD;        if (units === "inches") {&#xD;          point.X *= 25.4;&#xD;        }&#xD;      } else if (c.startsWith("Y")) {&#xD;        point.Y = parseFloat(c.substring(1));&#xD;        if (units === "inches") {&#xD;          point.Y *= 25.4;&#xD;        }&#xD;      }&#xD;    }&#xD;    // if saw an X or Y but could not parse the number, stop parsing.&#xD;    if (badParsed(point.X) || badParsed(point.Y)) {&#xD;      morphicAlert("Error!", "Invalid point " + l + " for command G1");&#xD;      return new List([]);&#xD;    } else {&#xD;      // if the G1 is missing an X or Y, silently ignore it&#xD;      if (typeof point.X === &apos;number&apos; &amp;&amp; typeof point.Y === &apos;number&apos;) {&#xD;        points.push(point);&#xD;      }&#xD;    }&#xD;  } else if (l.startsWith("M2")) {&#xD;    break; // stop program when we see M2&#xD;  }&#xD;}&#xD;if (points.length === 0) {&#xD;  morphicAlert("Error!", "No points were found in the Gcode");&#xD;  return new List([]);&#xD;}&#xD;var Xcoords = [], Ycoords = [];&#xD;for (const point of points) {&#xD;  Xcoords.push(point.X);&#xD;  Ycoords.push(point.Y);&#xD;}&#xD;return new List([new List(Xcoords), new List(Ycoords)]);&#xD;</l></block><list><block var="g-code"/></list></block></block><block s="doIf"><block s="reportEquals"><l>0</l><block s="reportListAttribute"><l><option>length</option></l><block var="master list"/></block></block><script><block s="doStopThis"><l><option>this block</option></l></block></script></block><block s="doSetVar"><l>x coords</l><block s="reportListItem"><l>1</l><block var="master list"/></block></block><block s="doSetVar"><l>y coords</l><block s="reportListItem"><l>2</l><block var="master list"/></block></block><block s="doSetVar"><l>previousX</l><l>0</l></block><block s="doSetVar"><l>previousY</l><l>0</l></block><block s="doFor"><l>i</l><l>1</l><block s="reportListAttribute"><l><option>length</option></l><block var="x coords"/></block><script><block s="doDeclareVariables"><list><l>deltax</l><l>deltay</l></list></block><block s="doSetVar"><l>deltax</l><block s="reportDifference"><block s="reportListItem"><block var="i"/><block var="x coords"/></block><block var="previousX"/></block></block><block s="doSetVar"><l>deltay</l><block s="reportDifference"><block s="reportListItem"><block var="i"/><block var="y coords"/></block><block var="previousY"/></block></block><block s="doIfElse"><block s="reportGreaterThan"><block s="reportMonadic"><l><option>abs</option></l><block var="deltax"/></block><block s="reportMonadic"><l><option>abs</option></l><block var="deltay"/></block></block><script><custom-block s="Advanced Move Left distance: %s speed: %s Right distance: %s speed: %s"><block var="deltax"/><l>1</l><block var="deltay"/><block s="reportIfElse"><block s="reportEquals"><block var="deltay"/><l>0</l></block><l>1</l><block s="reportQuotient"><block s="reportMonadic"><l><option>abs</option></l><block var="deltay"/></block><block s="reportMonadic"><l><option>abs</option></l><block var="deltax"/></block></block></block></custom-block></script><script><custom-block s="Advanced Move Left distance: %s speed: %s Right distance: %s speed: %s"><block var="deltax"/><block s="reportIfElse"><block s="reportEquals"><block var="deltax"/><l>0</l></block><l>1</l><block s="reportQuotient"><block s="reportMonadic"><l><option>abs</option></l><block var="deltax"/></block><block s="reportMonadic"><l><option>abs</option></l><block var="deltay"/></block></block></block><block var="deltay"/><l>1</l></custom-block></script></block><block s="doSetVar"><l>previousX</l><block s="reportListItem"><block var="i"/><block var="x coords"/></block></block><block s="doSetVar"><l>previousY</l><block s="reportListItem"><block var="i"/><block var="y coords"/></block></block></script></block></script></block-definition></blocks>
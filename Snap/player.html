<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Snap! Build Your Own Blocks 5.0.5</title>
        <link rel="shortcut icon" href="favicon.ico">
        <script>var morphicVersion="2019-July-08",modules={},useBlurredShadows=getBlurredShadowSupport(),standardSettings={minimumFontHeight:getMinimumFontHeight(),globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:12,bubbleHelpFontSize:10,prompterFontName:"sans-serif",prompterFontSize:12,prompterSliderSize:10,handleSize:15,scrollBarSize:12,mouseScrollAmount:40,useSliderForInput:!1,useVirtualKeyboard:!0,isTouchDevice:!1,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5},touchScreenSettings={minimumFontHeight:standardSettings.minimumFontHeight,globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:24,bubbleHelpFontSize:18,prompterFontName:"sans-serif",prompterFontSize:24,prompterSliderSize:20,handleSize:26,scrollBarSize:24,mouseScrollAmount:40,useSliderForInput:!0,useVirtualKeyboard:!0,isTouchDevice:!1,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5},MorphicPreferences=standardSettings,Morph,WorldMorph,HandMorph,ShadowMorph,FrameMorph,MenuMorph,HandleMorph,StringFieldMorph,ColorPickerMorph,SliderMorph,ScrollFrameMorph,InspectorMorph,StringMorph,TextMorph,PenMorph,ColorPaletteMorph,GrayPaletteMorph,BlinkerMorph,CursorMorph,BoxMorph,SpeechBubbleMorph,DialMorph,CircleBoxMorph,SliderButtonMorph,MouseSensorMorph,ListMorph,TriggerMorph,MenuItemMorph,MenuItemMorph,BouncerMorph;function nop(){return null}function localize(t){return t}function isNil(t){return null==t}function contains(t,e){return-1!==t.indexOf(e)}function detect(t,e){for(var o=t.length,i=0;i<o;i+=1)if(e.call(null,t[i]))return t[i];return null}function sizeOf(t){var e,o=0;for(e in t)Object.prototype.hasOwnProperty.call(t,e)&&(o+=1);return o}function isString(t){return"string"==typeof t||t instanceof String}function isObject(t){return null!==t&&("object"==typeof t||t instanceof Object)}function radians(t){return t*Math.PI/180}function degrees(t){return 180*t/Math.PI}function fontHeight(t){return 1.2*Math.max(t,MorphicPreferences.minimumFontHeight)}function isWordChar(t){return t.match(/[A-zÀ-ÿ0-9]/)}function newCanvas(t,e){var o=t||{x:0,y:0},i=document.createElement("canvas");return i.width=o.x,i.height=o.y,e&&i.isRetinaEnabled&&(i.isRetinaEnabled=!1),i}function getMinimumFontHeight(){var t,e,o,i,r=document.createElement("canvas");for(r.width=50,r.height=50,(t=r.getContext("2d")).font="1px serif",e=t.measureText("I").width,t.fillStyle="black",t.textBaseline="bottom",t.fillText("I",0,50),i=0;i<50;i+=1)for(o=0;o<e;o+=1)if(0!==t.getImageData(o,i,1,1).data[3])return 50-i+1;return 0}function getBlurredShadowSupport(){var t,e,o=document.createElement("canvas");return o.width=10,o.height=10,(e=o.getContext("2d")).fillStyle="rgb(255, 0, 0)",e.beginPath(),e.arc(5,5,5,0,2*Math.PI,!0),e.closePath(),e.fill(),(t=document.createElement("canvas")).width=10,t.height=10,(e=t.getContext("2d")).shadowBlur=10,e.shadowColor="rgba(0, 0, 255, 1)",e.drawImage(o,0,0),!!e.getImageData(0,0,1,1).data[3]}function getDocumentPositionOf(t){var e,o;if(null===t)return{x:0,y:0};for(e={x:t.offsetLeft,y:t.offsetTop},o=t.offsetParent;null!==o;)e.x+=o.offsetLeft,e.y+=o.offsetTop,o!==document.body&&o!==document.documentElement&&(e.x-=o.scrollLeft,e.y-=o.scrollTop),o=o.offsetParent;return e}function copy(t){var e,o,i,r,n,s;if("object"!=typeof t)return t;if(e=t.valueOf(),t!==e)return new t.constructor(e);if(t instanceof t.constructor&&t.constructor!==Object)for(o=Object.create(t.constructor.prototype),n=(r=Object.keys(t)).length,s=0;s<n;s+=1)o[i=r[s]]=t[i];else for(i in o={},t)o[i]=t[i];return o}function enableRetinaSupport(){var t=document.createElement("canvas").getContext("2d"),e=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1,o=Math.ceil(window.devicePixelRatio),i=HTMLCanvasElement.prototype,r=CanvasRenderingContext2D.prototype,p={drawImage:r.drawImage,getImageData:r.getImageData,width:Object.getOwnPropertyDescriptor(i,"width"),height:Object.getOwnPropertyDescriptor(i,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(r,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(r,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(r,"shadowBlur")};function c(t){return t.isRetinaEnabled?(o||1)/e:1}e!==o&&(Object.keys(p).some(function(t){var e=p[t];return e.hasOwnProperty("configurable")&&!e.configurable})||(i._isRetinaEnabled=!0,i._bak=p,Object.defineProperty(i,"isRetinaEnabled",{get:function(){return this._isRetinaEnabled},set:function(t){var e=c(this),o=this.width,i=this.height;this._isRetinaEnabled=t,c(this)!=e&&(this.width=o,this.height=i)},configurable:!0}),Object.defineProperty(i,"width",{get:function(){return p.width.get.call(this)/c(this)},set:function(e){try{var t,o=c(this);p.width.set.call(this,e*o),(t=this.getContext("2d")).restore(),t.save(),t.scale(o,o)}catch(t){console.log("Retina Display Support Problem",t),p.width.set.call(this,e)}}}),Object.defineProperty(i,"height",{get:function(){return p.height.get.call(this)/c(this)},set:function(t){var e,o=c(this);p.height.set.call(this,t*o),(e=this.getContext("2d")).restore(),e.save(),e.scale(o,o)}}),r.drawImage=function(t){var e,o,i,r,n,s,h,a,l=c(t);switch(arguments.length){case 9:e=arguments[1],o=arguments[2],i=arguments[3],r=arguments[4],n=arguments[5],s=arguments[6],h=arguments[7],a=arguments[8];break;case 5:o=e=0,i=t.width,r=t.height,n=arguments[1],s=arguments[2],h=arguments[3],a=arguments[4];break;case 3:o=e=0,i=t.width,r=t.height,n=arguments[1],s=arguments[2],h=t.width,a=t.height;break;default:throw Error("Called drawImage() with "+arguments.length+" arguments")}p.drawImage.call(this,t,e*l,o*l,i*l,r*l,n,s,h,a)},r.getImageData=function(t,e,o,i){var r=c(this.canvas);return p.getImageData.call(this,t*r,e*r,o*r,i*r)},Object.defineProperty(r,"shadowOffsetX",{get:function(){return p.shadowOffsetX.get.call(this)/c(this.canvas)},set:function(t){var e=c(this.canvas);p.shadowOffsetX.set.call(this,t*e)}}),Object.defineProperty(r,"shadowOffsetY",{get:function(){return p.shadowOffsetY.get.call(this)/c(this.canvas)},set:function(t){var e=c(this.canvas);p.shadowOffsetY.set.call(this,t*e)}}),Object.defineProperty(r,"shadowBlur",{get:function(){return p.shadowBlur.get.call(this)/c(this.canvas)},set:function(t){var e=c(this.canvas);p.shadowBlur.set.call(this,t*e)}})))}function isRetinaSupported(){var t=document.createElement("canvas").getContext("2d"),e=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1,o=HTMLCanvasElement.prototype,i=CanvasRenderingContext2D.prototype,r={drawImage:i.drawImage,getImageData:i.getImageData,width:Object.getOwnPropertyDescriptor(o,"width"),height:Object.getOwnPropertyDescriptor(o,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(i,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(i,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(i,"shadowBlur")};return e!==window.devicePixelRatio&&!Object.keys(r).some(function(t){var e=r[t];return e.hasOwnProperty("configurable")&&!e.configurable})}function isRetinaEnabled(){return HTMLCanvasElement.prototype.hasOwnProperty("_isRetinaEnabled")}function disableRetinaSupport(){var t,e,o;isRetinaEnabled()&&(t=HTMLCanvasElement.prototype,e=CanvasRenderingContext2D.prototype,o=t._bak,Object.defineProperty(t,"width",o.width),Object.defineProperty(t,"height",o.height),e.drawImage=o.drawImage,e.getImageData=o.getImageData,Object.defineProperty(e,"shadowOffsetX",o.shadowOffsetX),Object.defineProperty(e,"shadowOffsetY",o.shadowOffsetY),Object.defineProperty(e,"shadowBlur",o.shadowBlur),delete t._isRetinaEnabled,delete t.isRetinaEnabled,delete t._bak)}function normalizeCanvas(t,e){var o;return t.isRetinaEnabled?((o=newCanvas(new Point(t.width,t.height),!0)).getContext("2d").drawImage(t,0,0),e?o:(t.isRetinaEnabled=!1,t.width=o.width,t.height=o.height,t.getContext("2d").drawImage(o,0,0),t)):t}function Animation(t,e,o,i,r,n){this.setter=t,this.getter=e,this.delta=o||0,this.duration=i||0,this.easing=isString(r)?this.easings[r]||this.easings.sinusoidal:r||this.easings.sinusoidal,this.onComplete=n||null,this.endTime=null,this.destination=null,this.isActive=!1,this.start()}function Color(t,e,o,i){this.r=t||0,this.g=e||0,this.b=o||0,this.a=i||(0===i?0:1)}function Point(t,e){this.x=t||0,this.y=e||0}function Rectangle(t,e,o,i){this.init(new Point(t||0,e||0),new Point(o||0,i||0))}function Node(t,e){this.init(t||null,e||[])}function Morph(){this.init()}function ShadowMorph(){this.init()}function HandleMorph(t,e,o,i,r,n){this.init(t,e,o,i,r,n)}function PenMorph(){this.init()}function ColorPaletteMorph(t,e){this.init(t||null,e||new Point(80,50))}function GrayPaletteMorph(t,e){this.init(t||null,e||new Point(80,10))}function ColorPickerMorph(t){this.init(t||new Color(255,255,255))}function BlinkerMorph(t){this.init(t)}function CursorMorph(t){this.init(t)}function BoxMorph(t,e,o){this.init(t,e,o)}function SpeechBubbleMorph(t,e,o,i,r,n,s){this.init(t,e,o,i,r,n,s)}function DialMorph(t,e,o,i,r){this.init(t,e,o,i,r)}function CircleBoxMorph(t){this.init(t||"vertical")}function SliderButtonMorph(t){this.init(t)}function SliderMorph(t,e,o,i,r,n){this.init(t||1,e||100,o||50,i||10,r||"vertical",n)}function MouseSensorMorph(t,e,o){this.init(t,e,o)}function InspectorMorph(t){this.init(t)}function MenuMorph(t,e,o,i){this.init(t,e,o,i)}function StringMorph(t,e,o,i,r,n,s,h,a,l){this.init(t,e,o,i,r,n,s,h,a,l)}function TextMorph(t,e,o,i,r,n,s,h,a,l){this.init(t,e,o,i,r,n,s,h,a,l)}function TriggerMorph(t,e,o,i,r,n,s,h,a,l,p){this.init(t,e,o,i,r,n,s,h,a,l,p)}function MenuItemMorph(t,e,o,i,r,n,s,h,a,l,p,c){this.shortcutString=c||null,this.shortcut=null,this.init(t,e,o,i,r,n,s,h,a,l,p)}function FrameMorph(t){this.init(t)}function ScrollFrameMorph(t,e,o){this.init(t,e,o)}function ListMorph(t,e,o,i){this.init(t||[],e||function(t){return isString(t)?t:t.toSource?t.toSource():t.toString()},o||[],i)}function StringFieldMorph(t,e,o,i,r,n,s){this.init(t||"",e||100,o||12,i||"sans-serif",r||!1,n||!1,s)}function BouncerMorph(){this.init()}function HandMorph(t){this.init(t)}function WorldMorph(t,e){this.init(t,e)}enableRetinaSupport(),Animation.prototype.easings={linear:function(t){return t},sinusoidal:function(t){return 1-Math.cos(radians(90*t))},quadratic:function(t){return t<.5?2*t*t:(4-2*t)*t-1},cubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},elastic:function(t){return(t-=.5)<0?(.01+.01/t)*Math.sin(50*t):(.02-.01/t)*Math.sin(50*t)+1},sine_in:function(t){return 1-Math.sin(radians(90+90*t))},quad_in:function(t){return t*t},cubic_in:function(t){return t*t*t},elastic_in:function(t){return(.04-.04/t)*Math.sin(25*t)+1},sine_out:function(t){return Math.sin(radians(90*t))},quad_out:function(t){return t*(2-t)},elastic_out:function(t){return.04*t/--t*Math.sin(25*t)}},Animation.prototype.start=function(){this.endTime=Date.now()+this.duration,this.destination=this.getter.call(this)+this.delta,this.isActive=!0},Animation.prototype.step=function(){var t;this.isActive&&((t=Date.now())>this.endTime?(this.setter(this.destination),this.isActive=!1,this.onComplete&&this.onComplete()):this.setter(this.destination-this.delta*this.easing((this.endTime-t)/this.duration)))},Color.prototype.toString=function(){return"rgba("+Math.round(this.r)+","+Math.round(this.g)+","+Math.round(this.b)+","+this.a+")"},Color.prototype.toRGBstring=function(){return"rgb("+Math.round(this.r)+","+Math.round(this.g)+","+Math.round(this.b)+")"},Color.fromString=function(t){var e=t.split(/[\(),]/).slice(1,5);return new Color(e[0],e[1],e[2],e[3])},Color.prototype.copy=function(){return new Color(this.r,this.g,this.b,this.a)},Color.prototype.eq=function(t,e){return t&&this.r===t.r&&this.g===t.g&&this.b===t.b&&(!e||this.a===t.a)},Color.prototype.isCloseTo=function(t,e,o){var i=2.55*(o||10);function r(t,e){var o=t-e;return o<0?255+o:o}return t&&r(this.r,t.r)<i&&r(this.g,t.g)<i&&r(this.b,t.b)<i&&(!e||this.a===t.a)},Color.prototype.hsv=function(){var t,e=this.r/255,o=this.g/255,i=this.b/255,r=Math.max(e,o,i),n=Math.min(e,o,i),s=r,h=r,a=r-n;if(t=0===r?0:a/r,r===n)s=0;else{switch(r){case e:s=(o-i)/a+(o<i?6:0);break;case o:s=(i-e)/a+2;break;case i:s=(e-o)/a+4}s/=6}return[s,t,h]},Color.prototype.set_hsv=function(t,e,o){var i=Math.floor(6*t),r=6*t-i,n=o*(1-e),s=o*(1-r*e),h=o*(1-(1-r)*e);switch(i%6){case 0:this.r=o,this.g=h,this.b=n;break;case 1:this.r=s,this.g=o,this.b=n;break;case 2:this.r=n,this.g=o,this.b=h;break;case 3:this.r=n,this.g=s,this.b=o;break;case 4:this.r=h,this.g=n,this.b=o;break;case 5:this.r=o,this.g=n,this.b=s}this.r*=255,this.g*=255,this.b*=255},Color.prototype.hsl=function(){var t,e,o,i=this.r/255,r=this.g/255,n=this.b/255,s=Math.max(i,r,n),h=Math.min(i,r,n),a=(s+h)/2;if(s===h)e=t=0;else{switch(o=s-h,e=.5<a?o/(2-s-h):o/(s+h),s){case i:t=(r-n)/o+(r<n?6:0);break;case r:t=(n-i)/o+2;break;case n:t=(i-r)/o+4}t/=6}return[t,e,a]},Color.prototype.set_hsl=function(t,e,o){var i,r;function n(t,e,o){return o<0&&(o+=1),1<o&&--o,o<1/6?t+6*(e-t)*o:o<.5?e:o<2/3?t+(e-t)*(2/3-o)*6:t}0==e?(this.r=o,this.g=o,this.b=o):(r=2*o-(i=o<.5?o*(1+e):o+e-o*e),this.r=n(r,i,t+1/3),this.g=n(r,i,t),this.b=n(r,i,t-1/3)),this.r*=255,this.g*=255,this.b*=255},Color.prototype.mixed=function(t,e){var o=Math.min(Math.max(t,0),1),i=1-o;return new Color(this.r*o+e.r*i,this.g*o+e.g*i,this.b*o+e.b*i)},Color.prototype.darker=function(t){var e=t?(100-t)/100:.8333;return this.mixed(e,new Color(0,0,0))},Color.prototype.lighter=function(t){var e=t?(100-t)/100:.8333;return this.mixed(e,new Color(255,255,255))},Color.prototype.dansDarker=function(){var t=this.hsv(),e=new Color,o=Math.max(t[2]-.16,0);return e.set_hsv(t[0],t[1],o),e},Color.prototype.inverted=function(){return new Color(255-this.r,255-this.g,255-this.b)},Point.prototype.toString=function(){return Math.round(this.x.toString())+"@"+Math.round(this.y.toString())},Point.prototype.copy=function(){return new Point(this.x,this.y)},Point.prototype.eq=function(t){return this.x===t.x&&this.y===t.y},Point.prototype.lt=function(t){return this.x<t.x&&this.y<t.y},Point.prototype.gt=function(t){return this.x>t.x&&this.y>t.y},Point.prototype.ge=function(t){return this.x>=t.x&&this.y>=t.y},Point.prototype.le=function(t){return this.x<=t.x&&this.y<=t.y},Point.prototype.max=function(t){return new Point(Math.max(this.x,t.x),Math.max(this.y,t.y))},Point.prototype.min=function(t){return new Point(Math.min(this.x,t.x),Math.min(this.y,t.y))},Point.prototype.round=function(){return new Point(Math.round(this.x),Math.round(this.y))},Point.prototype.abs=function(){return new Point(Math.abs(this.x),Math.abs(this.y))},Point.prototype.neg=function(){return new Point(-this.x,-this.y)},Point.prototype.mirror=function(){return new Point(this.y,this.x)},Point.prototype.floor=function(){return new Point(Math.max(Math.floor(this.x),0),Math.max(Math.floor(this.y),0))},Point.prototype.ceil=function(){return new Point(Math.ceil(this.x),Math.ceil(this.y))},Point.prototype.add=function(t){return t instanceof Point?new Point(this.x+t.x,this.y+t.y):new Point(this.x+t,this.y+t)},Point.prototype.subtract=function(t){return t instanceof Point?new Point(this.x-t.x,this.y-t.y):new Point(this.x-t,this.y-t)},Point.prototype.multiplyBy=function(t){return t instanceof Point?new Point(this.x*t.x,this.y*t.y):new Point(this.x*t,this.y*t)},Point.prototype.divideBy=function(t){return t instanceof Point?new Point(this.x/t.x,this.y/t.y):new Point(this.x/t,this.y/t)},Point.prototype.floorDivideBy=function(t){return t instanceof Point?new Point(Math.floor(this.x/t.x),Math.floor(this.y/t.y)):new Point(Math.floor(this.x/t),Math.floor(this.y/t))},Point.prototype.r=function(){var t=this.multiplyBy(this);return Math.sqrt(t.x+t.y)},Point.prototype.degrees=function(){var t,e;return 0===this.x?0<=this.y?90:270:(t=this.y/this.x,e=Math.atan(t),0<=this.x?0<=this.y?degrees(e):360+degrees(e):180+degrees(e))},Point.prototype.theta=function(){var t,e;return 0===this.x?0<=this.y?radians(90):radians(270):(t=this.y/this.x,e=Math.atan(t),0<=this.x?0<=this.y?e:radians(360)+e:radians(180)+e)},Point.prototype.crossProduct=function(t){return this.multiplyBy(t.mirror())},Point.prototype.distanceTo=function(t){return t.subtract(this).r()},Point.prototype.rotate=function(t,e){var o=this.subtract(e);return"right"===t?new Point(-o.y,o.y).add(e):"left"===t?new Point(o.y,-o.y).add(e):e.subtract(o)},Point.prototype.flip=function(t,e){return"vertical"===t?new Point(this.x,2*e.y-this.y):new Point(2*e.x-this.x,this.y)},Point.prototype.distanceAngle=function(t,e){var o,i,r=e;return 270<r?r-=360:r<-270&&(r+=360),-90<=r&&r<=90?(o=Math.sin(radians(r))*t,i=Math.sqrt(t*t-o*o),new Point(o+this.x,this.y-i)):(o=Math.sin(radians(180-r))*t,i=Math.sqrt(t*t-o*o),new Point(o+this.x,this.y+i))},Point.prototype.scaleBy=function(t){return this.multiplyBy(t)},Point.prototype.translateBy=function(t){return this.add(t)},Point.prototype.rotateBy=function(t,e){var o=e||new Point(0,0),i=this.subtract(o),r=i.r(),n=t-i.theta();return new Point(o.x+r*Math.cos(n),o.y-r*Math.sin(n))},Point.prototype.asArray=function(){return[this.x,this.y]},Rectangle.prototype.init=function(t,e){this.origin=t,this.corner=e},Rectangle.prototype.toString=function(){return"["+this.origin.toString()+" | "+this.extent().toString()+"]"},Rectangle.prototype.copy=function(){return new Rectangle(this.left(),this.top(),this.right(),this.bottom())},Point.prototype.corner=function(t){return new Rectangle(this.x,this.y,t.x,t.y)},Point.prototype.rectangle=function(t){var e=this.min(t),o=this.max(t);return new Rectangle(e.x,e.y,o.x,o.y)},Point.prototype.extent=function(t){var e=this.add(t);return new Rectangle(this.x,this.y,e.x,e.y)},Rectangle.prototype.setTo=function(t,e,o,i){this.origin=new Point(t||(0===t?0:this.left()),e||(0===e?0:this.top())),this.corner=new Point(o||(0===o?0:this.right()),i||(0===i?0:this.bottom()))},Rectangle.prototype.area=function(){var t=this.width();return t<0?0:Math.max(t*this.height(),0)},Rectangle.prototype.bottom=function(){return this.corner.y},Rectangle.prototype.bottomCenter=function(){return new Point(this.center().x,this.bottom())},Rectangle.prototype.bottomLeft=function(){return new Point(this.origin.x,this.corner.y)},Rectangle.prototype.bottomRight=function(){return this.corner.copy()},Rectangle.prototype.boundingBox=function(){return this},Rectangle.prototype.center=function(){return this.origin.add(this.corner.subtract(this.origin).floorDivideBy(2))},Rectangle.prototype.corners=function(){return[this.origin,this.bottomLeft(),this.corner,this.topRight()]},Rectangle.prototype.extent=function(){return this.corner.subtract(this.origin)},Rectangle.prototype.height=function(){return this.corner.y-this.origin.y},Rectangle.prototype.left=function(){return this.origin.x},Rectangle.prototype.leftCenter=function(){return new Point(this.left(),this.center().y)},Rectangle.prototype.right=function(){return this.corner.x},Rectangle.prototype.rightCenter=function(){return new Point(this.right(),this.center().y)},Rectangle.prototype.top=function(){return this.origin.y},Rectangle.prototype.topCenter=function(){return new Point(this.center().x,this.top())},Rectangle.prototype.topLeft=function(){return this.origin},Rectangle.prototype.topRight=function(){return new Point(this.corner.x,this.origin.y)},Rectangle.prototype.width=function(){return this.corner.x-this.origin.x},Rectangle.prototype.position=function(){return this.origin},Rectangle.prototype.eq=function(t){return this.origin.eq(t.origin)&&this.corner.eq(t.corner)},Rectangle.prototype.abs=function(){var t=this.origin.abs(),e=this.corner.max(t);return t.corner(e)},Rectangle.prototype.insetBy=function(t){var e=new Rectangle;return e.origin=this.origin.add(t),e.corner=this.corner.subtract(t),e},Rectangle.prototype.expandBy=function(t){var e=new Rectangle;return e.origin=this.origin.subtract(t),e.corner=this.corner.add(t),e},Rectangle.prototype.growBy=function(t){var e=new Rectangle;return e.origin=this.origin.copy(),e.corner=this.corner.add(t),e},Rectangle.prototype.intersect=function(t){var e=new Rectangle;return e.origin=this.origin.max(t.origin),e.corner=this.corner.min(t.corner),e},Rectangle.prototype.merge=function(t){var e=new Rectangle;return e.origin=this.origin.min(t.origin),e.corner=this.corner.max(t.corner),e},Rectangle.prototype.mergeWith=function(t){this.origin=this.origin.min(t.origin),this.corner=this.corner.max(t.corner)},Rectangle.prototype.round=function(){return this.origin.round().corner(this.corner.round())},Rectangle.prototype.spread=function(){return this.origin.floor().corner(this.corner.ceil()).expandBy(1)},Rectangle.prototype.amountToTranslateWithin=function(t){var e=0,o=0;return this.right()>t.right()&&(e=t.right()-this.right()),this.bottom()>t.bottom()&&(o=t.bottom()-this.bottom()),this.left()+e<t.left()&&(e=t.left()-this.left()),this.top()+o<t.top()&&(o=t.top()-this.top()),new Point(e,o)},Rectangle.prototype.containsPoint=function(t){return this.origin.le(t)&&t.lt(this.corner)},Rectangle.prototype.containsRectangle=function(t){return t.origin.gt(this.origin)&&t.corner.lt(this.corner)},Rectangle.prototype.intersects=function(t){var e=t.origin,o=t.corner;return o.x>=this.origin.x&&o.y>=this.origin.y&&e.x<=this.corner.x&&e.y<=this.corner.y},Rectangle.prototype.isNearTo=function(t,e){var o=t.origin,i=t.corner,r=e||0;return i.x+r>=this.origin.x&&i.y+r>=this.origin.y&&o.x-r<=this.corner.x&&o.y-r<=this.corner.y},Rectangle.prototype.scaleBy=function(t){var e=this.origin.multiplyBy(t),o=this.corner.multiplyBy(t);return new Rectangle(e.x,e.y,o.x,o.y)},Rectangle.prototype.translateBy=function(t){var e=this.origin.add(t),o=this.corner.add(t);return new Rectangle(e.x,e.y,o.x,o.y)},Rectangle.prototype.asArray=function(){return[this.left(),this.top(),this.right(),this.bottom()]},Rectangle.prototype.asArray_xywh=function(){return[this.left(),this.top(),this.width(),this.height()]},Node.prototype.init=function(t,e){this.parent=t||null,this.children=e||[]},Node.prototype.toString=function(){return"a Node["+this.children.length.toString()+"]"},Node.prototype.addChild=function(t){this.children.push(t),t.parent=this},Node.prototype.addChildFirst=function(t){this.children.splice(0,null,t),t.parent=this},Node.prototype.removeChild=function(t){var e=this.children.indexOf(t);-1!==e&&this.children.splice(e,1)},Node.prototype.root=function(){return null===this.parent?this:this.parent.root()},Node.prototype.depth=function(){return null===this.parent?0:this.parent.depth()+1},Node.prototype.allChildren=function(){var e=[this];return this.children.forEach(function(t){e=e.concat(t.allChildren())}),e},Node.prototype.forAllChildren=function(e){0<this.children.length&&this.children.forEach(function(t){t.forAllChildren(e)}),e.call(null,this)},Node.prototype.anyChild=function(t){var e;if(t.call(null,this))return!0;for(e=0;e<this.children.length;e+=1)if(this.children[e].anyChild(t))return!0;return!1},Node.prototype.allLeafs=function(){var e=[];return this.allChildren().forEach(function(t){0===t.children.length&&e.push(t)}),e},Node.prototype.allParents=function(){var t=[this];return null!==this.parent&&(t=t.concat(this.parent.allParents())),t},Node.prototype.siblings=function(){var e=this;return null===this.parent?[]:this.parent.children.filter(function(t){return t!==e})},Node.prototype.parentThatIsA=function(){for(var t=0;t<arguments.length;t+=1)if(this instanceof arguments[t])return this;return this.parent?this.parentThatIsA.apply(this.parent,arguments):null},Node.prototype.parentThatIsAnyOf=function(t){return this.parentThatIsA.apply(this,t)},Morph.prototype=new Node,Morph.prototype.constructor=Morph,Morph.uber=Node.prototype,Morph.prototype.trackChanges=!0,Morph.prototype.shadowBlur=4,Morph.prototype.init=function(t){Morph.uber.init.call(this),this.isMorph=!0,this.image=null,this.bounds=new Rectangle(0,0,50,40),this.cachedFullImage=null,this.cachedFullBounds=null,this.color=new Color(80,80,80),this.texture=null,this.cachedTexture=null,this.alpha=1,this.isVisible=!0,this.isDraggable=!1,this.isTemplate=!1,this.acceptsDrops=!1,this.noticesTransparentClick=!1,t||this.drawNew(),this.fps=0,this.customContextMenu=null,this.lastTime=Date.now(),this.onNextStep=null},Morph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+" "+this.children.length.toString()+" "+this.bounds},Morph.prototype.destroy=function(){null!==this.parent&&(this.fullChanged(),this.parent.removeChild(this))},Morph.prototype.stepFrame=function(){if(!this.step)return null;var t,e=Date.now(),o=e-this.lastTime,i=0<this.fps?1e3/this.fps-o:0;i<1&&(this.lastTime=e,this.onNextStep&&(t=this.onNextStep,this.onNextStep=null,t.call(this)),this.step(),this.children.forEach(function(t){t.stepFrame()}))},Morph.prototype.nextSteps=function(t){var e=t||[],o=e.shift(),i=this;o&&(this.onNextStep=function(){o.call(i),i.nextSteps(e)})},Morph.prototype.step=nop,Morph.prototype.left=function(){return this.bounds.left()},Morph.prototype.right=function(){return this.bounds.right()},Morph.prototype.top=function(){return this.bounds.top()},Morph.prototype.bottom=function(){return this.bounds.bottom()},Morph.prototype.center=function(){return this.bounds.center()},Morph.prototype.bottomCenter=function(){return this.bounds.bottomCenter()},Morph.prototype.bottomLeft=function(){return this.bounds.bottomLeft()},Morph.prototype.bottomRight=function(){return this.bounds.bottomRight()},Morph.prototype.boundingBox=function(){return this.bounds},Morph.prototype.corners=function(){return this.bounds.corners()},Morph.prototype.leftCenter=function(){return this.bounds.leftCenter()},Morph.prototype.rightCenter=function(){return this.bounds.rightCenter()},Morph.prototype.topCenter=function(){return this.bounds.topCenter()},Morph.prototype.topLeft=function(){return this.bounds.topLeft()},Morph.prototype.topRight=function(){return this.bounds.topRight()},Morph.prototype.position=function(){return this.bounds.origin},Morph.prototype.extent=function(){return this.bounds.extent()},Morph.prototype.width=function(){return this.bounds.width()},Morph.prototype.height=function(){return this.bounds.height()},Morph.prototype.fullBounds=function(){var e=this.bounds;return this.children.forEach(function(t){t.isVisible&&(e=e.merge(t.fullBounds()))}),e},Morph.prototype.fullBoundsNoShadow=function(){var e=this.bounds;return this.children.forEach(function(t){t instanceof ShadowMorph||!t.isVisible||(e=e.merge(t.fullBounds()))}),e},Morph.prototype.visibleBounds=function(){var e=this.bounds;return this.allParents().filter(function(t){return t instanceof FrameMorph}).forEach(function(t){e=e.intersect(t.bounds)}),e},Morph.prototype.moveBy=function(t){this.fullChanged(),this.silentMoveBy(t),this.fullChanged()},Morph.prototype.silentMoveBy=function(t){var e=this.children,o=e.length;for(this.bounds=this.bounds.translateBy(t),this.cachedFullBounds&&(this.cachedFullBounds=this.cachedFullBounds.translateBy(t));0<o;--o)e[o-1].silentMoveBy(t)},Morph.prototype.setPosition=function(t){var e=t.subtract(this.topLeft());0===e.x&&0===e.y||this.moveBy(e)},Morph.prototype.silentSetPosition=function(t){var e=t.subtract(this.topLeft());0===e.x&&0===e.y||this.silentMoveBy(e)},Morph.prototype.setLeft=function(t){this.setPosition(new Point(t,this.top()))},Morph.prototype.setRight=function(t){this.setPosition(new Point(t-this.width(),this.top()))},Morph.prototype.setTop=function(t){this.setPosition(new Point(this.left(),t))},Morph.prototype.setBottom=function(t){this.setPosition(new Point(this.left(),t-this.height()))},Morph.prototype.setCenter=function(t){this.setPosition(t.subtract(this.extent().floorDivideBy(2)))},Morph.prototype.setFullCenter=function(t){this.setPosition(t.subtract(this.fullBounds().extent().floorDivideBy(2)))},Morph.prototype.keepWithin=function(t){var e,o,i,r=this.fullBounds().right()-t.right();0<r&&this.moveBy(new Point(-r,0)),(e=this.fullBounds().left()-t.left())<0&&this.moveBy(new Point(-e,0)),0<(i=this.fullBounds().bottom()-t.bottom())&&this.moveBy(new Point(0,-i)),(o=this.fullBounds().top()-t.top())<0&&this.moveBy(new Point(0,-o))},Morph.prototype.scrollIntoView=function(){var t,e,o,i,r=this.parentThatIsA(ScrollFrameMorph);r&&(0<(e=Math.min(this.fullBounds().right()-r.right(),r.contents.right()-r.right()))&&r.contents.moveBy(new Point(-e,0)),(t=this.fullBounds().left()-r.left())<0&&r.contents.moveBy(new Point(-t,0)),(o=this.fullBounds().top()-r.top())<0&&r.contents.moveBy(new Point(0,-o)),0<(i=this.fullBounds().bottom()-r.bottom())&&r.contents.moveBy(new Point(0,-i)),r.adjustScrollBars())},Morph.prototype.setExtent=function(t,e){e?this.silentSetExtent(t):t.eq(this.extent())||(this.changed(),this.silentSetExtent(t),this.changed(),this.drawNew())},Morph.prototype.silentSetExtent=function(t){var e=t.round(),o=Math.max(e.x,0),i=Math.max(e.y,0);this.bounds.corner=new Point(this.bounds.origin.x+o,this.bounds.origin.y+i)},Morph.prototype.setWidth=function(t){this.setExtent(new Point(t||0,this.height()))},Morph.prototype.silentSetWidth=function(t){var e=Math.max(Math.round(t||0),0);this.bounds.corner=new Point(this.bounds.origin.x+e,this.bounds.corner.y)},Morph.prototype.setHeight=function(t){this.setExtent(new Point(this.width(),t||0))},Morph.prototype.silentSetHeight=function(t){var e=Math.max(Math.round(t||0),0);this.bounds.corner=new Point(this.bounds.corner.x,this.bounds.origin.y+e)},Morph.prototype.setColor=function(t){t&&(this.color.eq(t)||(this.color=t,this.changed(),this.drawNew()))},Morph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var t=this.image.getContext("2d");t.fillStyle=this.color.toString(),t.fillRect(0,0,this.width(),this.height()),this.cachedTexture?this.drawCachedTexture():this.texture&&this.drawTexture(this.texture)},Morph.prototype.drawTexture=function(t){var e=this;this.cachedTexture=new Image,this.cachedTexture.onload=function(){e.drawCachedTexture()},this.cachedTexture.src=this.texture=t},Morph.prototype.drawCachedTexture=function(){for(var t,e=this.cachedTexture,o=Math.floor(this.image.width/e.width),i=Math.floor(this.image.height/e.height),r=this.image.getContext("2d"),n=0;n<=i;n+=1)for(t=0;t<=o;t+=1)r.drawImage(e,t*e.width,n*e.height);this.changed()},Morph.prototype.drawOn=function(t,e){var o,i,r,n,s,h,a,l,p=this.cachedFullImage||this.image,c=this.cachedFullBounds||this.bounds;if(!this.isVisible)return null;if((o=(e||c).intersect(c)).extent().gt(new Point(0,0))){if(i=c.position().neg(),r=o.copy().translateBy(i),(n=t.getContext("2d")).globalAlpha=this.alpha,a=r.left(),l=r.top(),s=Math.min(r.width(),p.width-a),h=Math.min(r.height(),p.height-l),s<1||h<1)return null;n.drawImage(p,a,l,s,h,o.left(),o.top(),s,h)}},Morph.prototype.fullDrawOn=function(e,t){var o;if(!this.isVisible)return null;o=t||this.cachedFullBounds||this.fullBounds(),this.drawOn(e,o),this.cachedFullImage||this.children.forEach(function(t){t.fullDrawOn(e,o)})},Morph.prototype.hide=function(){this.isVisible=!1,this.changed(),this.children.forEach(function(t){t.hide()})},Morph.prototype.show=function(){this.isVisible=!0,this.changed(),this.children.forEach(function(t){t.show()})},Morph.prototype.toggleVisibility=function(){this.isVisible=!this.isVisible,this.changed(),this.children.forEach(function(t){t.toggleVisibility()})},Morph.prototype.fullImageClassic=function(){var t=this.cachedFullBounds||this.fullBounds(),e=newCanvas(t.extent());return e.getContext("2d").translate(-t.origin.x,-t.origin.y),this.fullDrawOn(e,t),e.globalAlpha=this.alpha,e},Morph.prototype.fullImage=function(){var t=newCanvas(this.fullBounds().extent()),e=t.getContext("2d"),o=this.fullBounds();return this.allChildren().forEach(function(t){t.isVisible&&(e.globalAlpha=t.alpha,t.image.width&&t.image.height&&e.drawImage(t.image,t.bounds.origin.x-o.origin.x,t.bounds.origin.y-o.origin.y))}),t},Morph.prototype.shadowImage=function(t,e){var o,i=t||new Point(7,7),r=e||new Color(0,0,0),n=this.fullBounds().extent(),s=this.fullImage(),h=newCanvas(n),a=h.getContext("2d");return a.drawImage(s,0,0),a.globalCompositeOperation="destination-out",a.drawImage(s,-i.x,-i.y),(a=(o=newCanvas(n)).getContext("2d")).drawImage(h,0,0),a.globalCompositeOperation="source-atop",a.fillStyle=r.toString(),a.fillRect(0,0,n.x,n.y),o},Morph.prototype.shadowImageBlurred=function(t,e){var o=t||new Point(7,7),i=this.shadowBlur,r=e||new Color(0,0,0),n=this.fullBounds().extent().add(2*i),s=this.fullImage(),h=newCanvas(n),a=h.getContext("2d");return a.shadowOffsetX=o.x,a.shadowOffsetY=o.y,a.shadowBlur=i,a.shadowColor=r.toString(),a.drawImage(s,i-o.x,i-o.y),a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0,a.globalCompositeOperation="destination-out",a.drawImage(s,i-o.x,i-o.y),h},Morph.prototype.shadow=function(t,e,o){var i=new ShadowMorph,r=t||new Point(7,7),n=e||(0===e?0:.2),s=this.fullBounds();return i.setExtent(s.extent().add(2*this.shadowBlur)),useBlurredShadows&&!MorphicPreferences.isFlat?(i.image=this.shadowImageBlurred(r,o),i.alpha=n,i.setPosition(s.origin.add(r).subtract(this.shadowBlur))):(i.image=this.shadowImage(r,o),i.alpha=n,i.setPosition(s.origin.add(r))),i},Morph.prototype.addShadow=function(t,e,o){var i=t||new Point(7,7),r=e||(0===e?0:.2),n=this.shadow(i,r,o);return this.addBack(n),this.fullChanged(),n},Morph.prototype.getShadow=function(){var t=this.children.slice(0).reverse().filter(function(t){return t instanceof ShadowMorph});return 0!==t.length?t[0]:null},Morph.prototype.removeShadow=function(){var t=this.getShadow();null!==t&&(this.fullChanged(),this.removeChild(t))},Morph.prototype.penTrails=function(){return this.image},Morph.prototype.changed=function(){var t;!this.trackChanges||(t=this.root())instanceof WorldMorph&&t.broken.push(this.visibleBounds().spread()),this.parent&&this.parent.childChanged(this)},Morph.prototype.fullChanged=function(){var t;!this.trackChanges||(t=this.root())instanceof WorldMorph&&t.broken.push((this.cachedFullBounds||this.fullBounds()).spread())},Morph.prototype.childChanged=function(){this.parent&&this.parent.childChanged(this)},Morph.prototype.world=function(){var t=this.root();return t instanceof WorldMorph?t:t instanceof HandMorph?t.world:null},Morph.prototype.add=function(t){var e=t.parent;null!==e&&e.removeChild(t),this.addChild(t)},Morph.prototype.addBack=function(t){var e=t.parent;null!==e&&e.removeChild(t),this.addChildFirst(t)},Morph.prototype.topMorphAt=function(t){var e,o;if(!this.isVisible)return null;for(e=this.children.length-1;0<=e;--e)if(o=this.children[e].topMorphAt(t))return o;return!this.bounds.containsPoint(t)||!this.noticesTransparentClick&&this.isTransparentAt(t)?null:this},Morph.prototype.topMorphSuchThat=function(t){var e;return t.call(null,this)?(e=detect(this.children.slice(0).reverse(),t))?e.topMorphSuchThat(t):this:null},Morph.prototype.overlappedMorphs=function(){var e=this.world(),o=this.fullBounds(),i=this,r=this.allParents(),n=this.allChildren();return e.allChildren().filter(function(t){return t.isVisible&&t!==i&&t!==e&&!contains(r,t)&&!contains(n,t)&&t.fullBounds().intersects(o)})},Morph.prototype.getPixelColor=function(t){var e=t.subtract(this.bounds.origin),o=this.image.getContext("2d").getImageData(e.x,e.y,1,1);return new Color(o.data[0],o.data[1],o.data[2],o.data[3]/255)},Morph.prototype.isTransparentAt=function(t){var e;return!!this.bounds.containsPoint(t)&&(!this.texture&&(e=t.subtract(this.bounds.origin),0===this.image.getContext("2d").getImageData(Math.floor(e.x),Math.floor(e.y),1,1).data[3]))},Morph.prototype.copy=function(){var t=copy(this);return t.parent=null,t.children=[],t.bounds=this.bounds.copy(),t},Morph.prototype.fullCopy=function(){var e=new Map,t=this.copyRecordingReferences(e);return t.forAllChildren(function(t){t.updateReferences(e)}),t},Morph.prototype.copyRecordingReferences=function(e){var o=this.copy();return e.set(this,o),this.children.forEach(function(t){o.add(t.copyRecordingReferences(e))}),o},Morph.prototype.updateReferences=function(t){for(var e,o,i,r=Object.keys(this),n=r.length,s=0;s<n;s+=1)(o=this[e=r[s]])&&o.isMorph&&(i=t.get(o))&&(this[e]=i)},Morph.prototype.rootForGrab=function(){return this instanceof ShadowMorph?this.parent.rootForGrab():this.parent instanceof ScrollFrameMorph?this.parent:null===this.parent||this.parent instanceof WorldMorph||this.parent instanceof FrameMorph||!0===this.isDraggable?this:this.parent.rootForGrab()},Morph.prototype.isCorrectingOutsideDrag=function(){return!0},Morph.prototype.wantsDropOf=function(t){return!(t instanceof HandleMorph||t instanceof MenuMorph||t instanceof InspectorMorph)&&this.acceptsDrops},Morph.prototype.pickUp=function(t){var e=t||this.world();this.setPosition(e.hand.position().subtract(this.extent().floorDivideBy(2))),e.hand.grab(this)},Morph.prototype.isPickedUp=function(){return null!==this.parentThatIsA(HandMorph)},Morph.prototype.situation=function(){return this.parent?{origin:this.parent,position:this.position().subtract(this.parent.position())}:null},Morph.prototype.slideBackTo=function(t,e,o,i){var r=t.origin.position().add(t.position),n=this;this.glideTo(r,e,null,function(){t.origin.add(n),o&&o(),n.justDropped&&n.justDropped(),t.origin.reactToDropOf&&t.origin.reactToDropOf(n),i&&i()})},Morph.prototype.glideTo=function(t,e,o,i){var r=this.world(),n=this,s=new Animation(function(t){n.setLeft(t)},function(){return n.left()},-(this.left()-t.x),e||100,o);r.animations.push(s),r.animations.push(new Animation(function(t){n.setTop(t)},function(){return n.top()},-(this.top()-t.y),e||100,o,function(){s.setter(s.destination),s.isActive=!1,i()}))},Morph.prototype.fadeTo=function(e,o,i,t){var r=this.world(),n=this,s=this.alpha;this.children.forEach(function(t){t.fadeTo(e,o,i)}),r.animations.push(new Animation(function(t){n.alpha=t,n.changed()},function(){return n.alpha},e-this.alpha,o||200,i,function(){n.alpha=s,t&&t()}))},Morph.prototype.perish=function(t,e){var o=this;this.fadeTo(0,t||100,null,function(){o.destroy(),e&&e()})},Morph.prototype.nop=nop,Morph.prototype.resize=function(){this.world().activeHandle=new HandleMorph(this)},Morph.prototype.move=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"move")},Morph.prototype.moveCenter=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"moveCenter")},Morph.prototype.hint=function(t){var e,o=t;t?t.toString&&(o=t.toString()):o="NULL",(e=new MenuMorph(this,o)).isDraggable=!0,e.popUpCenteredAtHand(this.world())},Morph.prototype.inform=function(t){var e,o=t;t?t.toString&&(o=t.toString()):o="NULL",(e=new MenuMorph(this,o)).addItem("Ok"),e.isDraggable=!0,e.popUpCenteredAtHand(this.world())},Morph.prototype.prompt=function(t,e,o,i,r,n,s,h){var a,l,p,c;s&&(c=!0),a=new MenuMorph(e||null,t||"",o||null),l=new StringFieldMorph(i||"",r||100,MorphicPreferences.prompterFontSize,MorphicPreferences.prompterFontName,!1,!1,c),a.items.push(l),(s||MorphicPreferences.useSliderForInput)&&((p=new SliderMorph(n||0,s,parseFloat(i),Math.floor((s-n)/4),"horizontal")).alpha=1,p.color=new Color(225,225,225),p.button.color=a.borderColor,p.button.highlightColor=p.button.color.copy(),p.button.highlightColor.b+=100,p.button.pressColor=p.button.color.copy(),p.button.pressColor.b+=150,p.setHeight(MorphicPreferences.prompterSliderSize),p.action=h?function(t){l.changed(),l.text.text=Math.round(t).toString(),l.text.drawNew(),l.text.changed(),l.text.edit()}:function(t){l.changed(),l.text.text=t.toString(),l.text.drawNew(),l.text.changed()},a.items.push(p)),a.addLine(2),a.addItem("Ok",function(){return l.string()}),a.addItem("Cancel",function(){return null}),a.isDraggable=!0,a.popUpAtHand(this.world()),l.text.edit()},Morph.prototype.pickColor=function(t,e,o,i){var r=new MenuMorph(e||null,t||"",o||null),n=new ColorPickerMorph(i);r.items.push(n),r.addLine(2),r.addItem("Ok",function(){return n.getChoice()}),r.addItem("Cancel",function(){return null}),r.isDraggable=!0,r.popUpAtHand(this.world())},Morph.prototype.inspect=function(t){var e=this.world instanceof Function?this.world():this.root()||this.world,o=new InspectorMorph(t?t:this);o.setPosition(e.hand.position()),o.keepWithin(e),e.add(o),o.changed()},Morph.prototype.contextMenu=function(){var t;return this.customContextMenu?this.customContextMenu:(t=this.world instanceof Function?this.world():this.world)&&t.isDevMode?this.parent===t?this.developersMenu():this.hierarchyMenu():this.userMenu()||this.parent&&this.parent.userMenu()},Morph.prototype.hierarchyMenu=function(){var t=this.allParents(),e=this.world instanceof Function?this.world():this.world,o=new MenuMorph(this,null);return t.forEach(function(t){t.developersMenu&&t!==e&&o.addMenu(t.toString().slice(0,50),t.developersMenu())}),o},Morph.prototype.developersMenu=function(){var t=this.world instanceof Function?this.world():this.world,e=this.userMenu()||this.parent&&this.parent.userMenu(),o=new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]);return e&&(o.addMenu("user features",e),o.addLine()),o.addItem("color...",function(){this.pickColor(o.title+localize("\ncolor:"),this.setColor,this,this.color)},"choose another color \nfor this morph"),o.addItem("transparency...",function(){this.prompt(o.title+localize("\nalpha\nvalue:"),this.setAlphaScaled,this,(100*this.alpha).toString(),null,1,100,!0)},"set this morph's\nalpha value"),o.addItem("resize...","resize","show a handle\nwhich can be dragged\nto change this morph's extent"),o.addLine(),o.addItem("duplicate",function(){this.fullCopy().pickUp(this.world())},"make a copy\nand pick it up"),o.addItem("pick up","pickUp","detach and put \ninto the hand"),o.addItem("attach...","attach","stick this morph\nto another one"),o.addItem("move...","move","show a handle\nwhich can be dragged\nto move this morph"),o.addItem("inspect...","inspect","open a window\non all properties"),o.addItem("pic...",function(){window.open(this.fullImageClassic().toDataURL())},"open a new window\nwith a picture of this morph"),o.addLine(),this.isDraggable?o.addItem("lock","toggleIsDraggable","make this morph\nunmovable"):o.addItem("unlock","toggleIsDraggable","make this morph\nmovable"),o.addItem("hide","hide"),o.addItem("delete","destroy"),this instanceof WorldMorph||(o.addLine(),o.addItem("World...",function(){t.contextMenu().popUpAtHand(t)},"show the\nWorld's menu")),o},Morph.prototype.userMenu=function(){return null},Morph.prototype.setAlphaScaled=function(t){var e,o;"number"==typeof t?(o=t/100,this.alpha=Math.min(Math.max(o,.1),1)):(e=parseFloat(t),isNaN(e)||(o=e/100,this.alpha=Math.min(Math.max(o,.1),1))),this.changed()},Morph.prototype.attach=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose new parent:"),o=this;t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){t.add(o),o.isDraggable=!1})}),0<t.length&&e.popUpAtHand(this.world())},Morph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable},Morph.prototype.colorSetters=function(){return["color"]},Morph.prototype.numericalSetters=function(){return["setLeft","setTop","setWidth","setHeight","setAlphaScaled"]},Morph.prototype.allEntryFields=function(){return this.allChildren().filter(function(t){return t.isEditable&&(t instanceof StringMorph||t instanceof TextMorph)})},Morph.prototype.nextEntryField=function(t){var e=this.allEntryFields(),o=e.indexOf(t);return-1!==o&&e.length>o+1?e[o+1]:e[0]},Morph.prototype.previousEntryField=function(t){var e=this.allEntryFields(),o=e.indexOf(t);return-1!==o?0<o?e[o-1]:e[e.length-1]:e[0]},Morph.prototype.tab=function(t){this.nextTab?this.nextTab(t):this.parent&&this.parent.tab(t)},Morph.prototype.backTab=function(t){this.previousTab?this.previousTab(t):this.parent&&this.parent.backTab(t)},Morph.prototype.escalateEvent=function(t,e){for(var o=this.parent;!o[t]&&null!==o.parent;)o=o.parent;o[t]&&o[t](e)},Morph.prototype.evaluateString=function(code){var result;try{result=eval(code),this.drawNew(),this.changed()}catch(t){this.inform(t)}return result},Morph.prototype.isTouching=function(t){var e,o,i,r=this.overlappingImage(t);if(!r.width||!r.height)return!1;for(o=(e=r.getContext("2d").getImageData(1,1,r.width,r.height).data).length,i=3;i<o;i+=4)if(0!==e[i])return!0;return!1},Morph.prototype.overlappingImage=function(t){var e=this.fullBounds(),o=t.fullBounds(),i=e.intersect(o),r=newCanvas(i.extent()),n=r.getContext("2d");return i.width()<1||i.height()<1?newCanvas(new Point(1,1)):(n.drawImage(this.fullImage(),i.origin.x-e.origin.x,i.origin.y-e.origin.y),n.globalCompositeOperation="source-in",n.drawImage(t.fullImage(),o.origin.x-i.origin.x,o.origin.y-i.origin.y),r)},ShadowMorph.prototype=new Morph,ShadowMorph.prototype.constructor=ShadowMorph,ShadowMorph.uber=Morph.prototype,ShadowMorph.prototype.topMorphAt=function(){return null},HandleMorph.prototype=new Morph,HandleMorph.prototype.constructor=HandleMorph,HandleMorph.uber=Morph.prototype,HandleMorph.prototype.init=function(t,e,o,i,r,n){var s=MorphicPreferences.handleSize;this.target=t||null,this.minExtent=new Point(e||0,o||0),this.inset=new Point(i||0,r||i||0),this.type=n||"resize",HandleMorph.uber.init.call(this),this.color=new Color(255,255,255),this.isDraggable=!1,this.noticesTransparentClick=!0,"movePivot"===this.type&&(s*=2),this.setExtent(new Point(s,s))},HandleMorph.prototype.drawNew=function(){this.normalImage=newCanvas(this.extent()),this.highlightImage=newCanvas(this.extent()),"movePivot"===this.type?(this.drawCrosshairsOnCanvas(this.normalImage,.6),this.drawCrosshairsOnCanvas(this.highlightImage,.5)):(this.drawOnCanvas(this.normalImage,this.color,new Color(100,100,100)),this.drawOnCanvas(this.highlightImage,new Color(100,100,255),new Color(255,255,255))),this.image=this.normalImage,this.target&&("moveCenter"===this.type?this.setCenter(this.target.center()):"movePivot"===this.type?this.setCenter(this.target.rotationCenter()):this.setPosition(this.target.bottomRight().subtract(this.extent().add(this.inset))),this.target.add(this),this.target.changed())},HandleMorph.prototype.drawCrosshairsOnCanvas=function(t,e){var o=t.getContext("2d"),i=t.width/2;o.fillStyle="rgba(255, 255, 255, 0.5)",o.arc(i,i,.9*i,radians(0),radians(360),!1),o.fill(),o.strokeStyle="black",o.lineWidth=1,o.beginPath(),o.arc(i,i,i*e,radians(0),radians(360),!1),o.stroke(),o.moveTo(0,i),o.lineTo(t.width,i),o.stroke(),o.moveTo(i,0),o.lineTo(i,t.height),o.stroke()},HandleMorph.prototype.drawOnCanvas=function(t,e,o){var i,r,n,s,h,a=t.getContext("2d"),l=0===this.type.indexOf("move");if(a.lineWidth=1,a.lineCap="round",a.strokeStyle=e.toString(),l)for(r=(i=this.bottomLeft().subtract(this.position())).copy(),s=(n=this.topRight().subtract(this.position())).copy(),h=0;h<=this.height();h+=6)r.y=i.y-h,s.y=n.y-h,a.beginPath(),a.moveTo(r.x,r.y),a.lineTo(s.x,s.y),a.closePath(),a.stroke();for(r=(i=this.bottomLeft().subtract(this.position())).copy(),s=(n=this.topRight().subtract(this.position())).copy(),h=0;h<=this.width();h+=6)r.x=i.x+h,s.x=n.x+h,a.beginPath(),a.moveTo(r.x,r.y),a.lineTo(s.x,s.y),a.closePath(),a.stroke();if(a.strokeStyle=o.toString(),l)for(r=(i=this.bottomLeft().subtract(this.position())).copy(),s=(n=this.topRight().subtract(this.position())).copy(),h=-2;h<=this.height();h+=6)r.y=i.y-h,s.y=n.y-h,a.beginPath(),a.moveTo(r.x,r.y),a.lineTo(s.x,s.y),a.closePath(),a.stroke();for(r=(i=this.bottomLeft().subtract(this.position())).copy(),s=(n=this.topRight().subtract(this.position())).copy(),h=2;h<=this.width();h+=6)r.x=i.x+h,s.x=n.x+h,a.beginPath(),a.moveTo(r.x,r.y),a.lineTo(s.x,s.y),a.closePath(),a.stroke()},HandleMorph.prototype.step=null,HandleMorph.prototype.mouseDownLeft=function(t){var o,i=this.root(),r=this;if(!this.target)return null;o=0===this.type.indexOf("move")?t.subtract(this.center()):t.subtract(this.bounds.origin),this.step=function(){var t,e;i.hand.mouseButton?(t=i.hand.bounds.origin.copy().subtract(o),"resize"===this.type?(e=(e=t.add(r.extent().add(r.inset)).subtract(r.target.bounds.origin)).max(r.minExtent),r.target.setExtent(e),r.setPosition(r.target.bottomRight().subtract(r.extent().add(r.inset)))):"moveCenter"===this.type?r.target.setCenter(t):"movePivot"===this.type?(r.target.setPivot(t),r.setCenter(this.target.rotationCenter())):r.target.setPosition(t.subtract(this.target.extent()).add(this.extent()))):this.step=null},this.target.step||(this.target.step=function(){nop()})},HandleMorph.prototype.rootForGrab=function(){return this},HandleMorph.prototype.mouseEnter=function(){this.image=this.highlightImage,this.changed()},HandleMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed()},HandleMorph.prototype.attach=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:"),o=this;t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){o.isDraggable=!1,o.target=t,o.drawNew(),o.noticesTransparentClick=!0})}),0<t.length&&e.popUpAtHand(this.world())},PenMorph.prototype=new Morph,PenMorph.prototype.constructor=PenMorph,PenMorph.uber=Morph.prototype,PenMorph.prototype.init=function(){var t=4*MorphicPreferences.handleSize;this.isWarped=!1,this.heading=0,this.isDown=!0,this.size=1,this.wantsRedraw=!1,this.penPoint="tip",this.penBounds=null,HandleMorph.uber.init.call(this),this.setExtent(new Point(t,t))},PenMorph.prototype.changed=function(){var t;!1===this.isWarped&&((t=this.root())instanceof WorldMorph&&t.broken.push(this.visibleBounds().spread()),this.parent&&this.parent.childChanged(this))},PenMorph.prototype.drawNew=function(t){var e,o,i,r,n,s,h=t||this.heading;this.isWarped?this.wantsRedraw=!0:(this.image=newCanvas(this.extent()),e=this.image.getContext("2d"),s=this.width()/2,o=this.center().subtract(this.bounds.origin),n="tip"===this.penPoint?(i=o.distanceAngle(.75*s,h-180),r=o.distanceAngle(s,h+195),o.distanceAngle(s,h-195)):(i=o.distanceAngle(.75*s,h),r=o.distanceAngle(.33*s,h+230),o.distanceAngle(.33*s,h-230)),this.penBounds=new Rectangle(Math.min(o.x,i.x,r.x,n.x),Math.min(o.y,i.y,r.y,n.y),Math.max(o.x,i.x,r.x,n.x),Math.max(o.y,i.y,r.y,n.y)),e.fillStyle=this.color.toString(),e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(r.x,r.y),e.lineTo(i.x,i.y),e.lineTo(n.x,n.y),e.closePath(),e.strokeStyle="white",e.lineWidth=3,e.stroke(),e.strokeStyle="black",e.lineWidth=1,e.stroke(),e.fill())},PenMorph.prototype.setHeading=function(t){this.heading=(+t%360+360)%360,this.drawNew(),this.changed()},PenMorph.prototype.numericalSetters=function(){return["setLeft","setTop","setWidth","setHeight","setAlphaScaled","setHeading"]},PenMorph.prototype.developersMenu=function(){var t=PenMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("set rotation","setRotation","interactively turn this morph\nusing a dial widget"),t},PenMorph.prototype.setRotation=function(){var t,e,o=this.name||this.constructor.name;10<o.length&&(o=o.slice(0,9)+"..."),t=new MenuMorph(this,o),(e=new DialMorph(null,null,this.heading)).rootForGrab=function(){return this},e.target=this,e.action="setHeading",t.items.push(e),t.addLine(),t.addItem("(90) right",function(){this.setHeading(90)}),t.addItem("(-90) left",function(){this.setHeading(-90)}),t.addItem("(0) up",function(){this.setHeading(0)}),t.addItem("(180) down",function(){this.setHeading(180)}),t.isDraggable=!0,t.popUpAtHand(this.world())},PenMorph.prototype.drawLine=function(t,e){var o=this.parent.penTrails().getContext("2d"),i=t.subtract(this.parent.bounds.origin),r=e.subtract(this.parent.bounds.origin);this.isDown&&(o.lineWidth=this.size,o.strokeStyle=this.color.toString(),o.lineCap="round",o.lineJoin="round",o.beginPath(),o.moveTo(i.x,i.y),o.lineTo(r.x,r.y),o.stroke(),!1===this.isWarped&&this.world().broken.push(t.rectangle(e).expandBy(Math.max(this.size/2,1)).intersect(this.parent.visibleBounds()).spread()))},PenMorph.prototype.turn=function(t){this.setHeading(this.heading+parseFloat(t))},PenMorph.prototype.forward=function(t){var e=this.center(),o=parseFloat(t),i=0<=o?this.position().distanceAngle(o,this.heading):this.position().distanceAngle(Math.abs(o),this.heading-180);this.setPosition(i),this.drawLine(e,this.center())},PenMorph.prototype.down=function(){this.isDown=!0},PenMorph.prototype.up=function(){this.isDown=!1},PenMorph.prototype.clear=function(){this.parent.drawNew(),this.parent.changed()},PenMorph.prototype.startWarp=function(){this.wantsRedraw=!1,this.isWarped=!0},PenMorph.prototype.endWarp=function(){this.isWarped=!1,this.wantsRedraw&&(this.drawNew(),this.wantsRedraw=!1),this.parent.changed()},PenMorph.prototype.warp=function(t){this.startWarp(),t.call(this),this.endWarp()},PenMorph.prototype.warpOp=function(t,e){this.startWarp(),this[t].apply(this,e),this.endWarp()},PenMorph.prototype.warpSierpinski=function(t,e){this.warpOp("sierpinski",[t,e])},PenMorph.prototype.sierpinski=function(t,e){var o;if(e<t)for(o=0;o<3;o+=1)this.sierpinski(.5*t,e),this.turn(120),this.forward(t)},PenMorph.prototype.warpTree=function(t,e,o){this.warpOp("tree",[t,e,o])},PenMorph.prototype.tree=function(t,e,o){0<t&&(this.size=t,this.forward(e),this.turn(o),this.tree(t-1,.75*e,o),this.turn(-2*o),this.tree(t-1,.75*e,o),this.turn(o),this.forward(-e))},ColorPaletteMorph.prototype=new Morph,ColorPaletteMorph.prototype.constructor=ColorPaletteMorph,ColorPaletteMorph.uber=Morph.prototype,ColorPaletteMorph.prototype.init=function(t,e){ColorPaletteMorph.uber.init.call(this),this.target=t,this.targetSetter="color",this.silentSetExtent(e),this.choice=null,this.drawNew()},ColorPaletteMorph.prototype.drawNew=function(){var t,e,o,i,r,n=this.extent();for(this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),this.choice=new Color,e=0;e<=n.x;e+=1)for(i=360*e/n.x,o=0;o<=n.y;o+=1)r=100-o/n.y*100,t.fillStyle="hsl("+i+",100%,"+r+"%)",t.fillRect(e,o,1,1)},ColorPaletteMorph.prototype.mouseMove=function(t){this.choice=this.getPixelColor(t),this.updateTarget()},ColorPaletteMorph.prototype.mouseDownLeft=function(t){this.choice=this.getPixelColor(t),this.updateTarget()},ColorPaletteMorph.prototype.updateTarget=function(){this.target instanceof Morph&&null!==this.choice&&(this.target[this.targetSetter]instanceof Function?this.target[this.targetSetter](this.choice):(this.target[this.targetSetter]=this.choice,this.target.drawNew(),this.target.changed()))},ColorPaletteMorph.prototype.developersMenu=function(){var t=ColorPaletteMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("set target","setTarget","choose another morph\nwhose color property\n will be controlled by this one"),t},ColorPaletteMorph.prototype.setTarget=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:"),o=this;t.push(this.world()),t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){o.target=t,o.setTargetSetter()})}),1===t.length?(this.target=t[0],this.setTargetSetter()):0<t.length&&e.popUpAtHand(this.world())},ColorPaletteMorph.prototype.setTargetSetter=function(){var t=this.target.colorSetters(),e=new MenuMorph(this,"choose target property:"),o=this;t.forEach(function(t){e.addItem(t,function(){o.targetSetter=t})}),1===t.length?this.targetSetter=t[0]:0<t.length&&e.popUpAtHand(this.world())},GrayPaletteMorph.prototype=new ColorPaletteMorph,GrayPaletteMorph.prototype.constructor=GrayPaletteMorph,GrayPaletteMorph.uber=ColorPaletteMorph.prototype,GrayPaletteMorph.prototype.drawNew=function(){var t,e,o=this.extent();this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),this.choice=new Color,(e=t.createLinearGradient(0,0,o.x,o.y)).addColorStop(0,"black"),e.addColorStop(1,"white"),t.fillStyle=e,t.fillRect(0,0,o.x,o.y)},ColorPickerMorph.prototype=new Morph,ColorPickerMorph.prototype.constructor=ColorPickerMorph,ColorPickerMorph.uber=Morph.prototype,ColorPickerMorph.prototype.init=function(t){this.choice=t,ColorPickerMorph.uber.init.call(this),this.color=new Color(255,255,255),this.silentSetExtent(new Point(80,80)),this.drawNew()},ColorPickerMorph.prototype.drawNew=function(){ColorPickerMorph.uber.drawNew.call(this),this.buildSubmorphs()},ColorPickerMorph.prototype.buildSubmorphs=function(){var t,e,o,i;this.children.forEach(function(t){t.destroy()}),this.children=[],this.feedback=new Morph,this.feedback.color=this.choice,this.feedback.setExtent(new Point(20,20)),t=new ColorPaletteMorph(this.feedback,new Point(this.width(),50)),e=new GrayPaletteMorph(this.feedback,new Point(this.width(),5)),t.setPosition(this.bounds.origin),this.add(t),e.setPosition(t.bottomLeft()),this.add(e),o=e.left()+Math.floor((e.width()-this.feedback.width())/2),i=e.bottom()+Math.floor((this.bottom()-e.bottom()-this.feedback.height())/2),this.feedback.setPosition(new Point(o,i)),this.add(this.feedback)},ColorPickerMorph.prototype.getChoice=function(){return this.feedback.color},ColorPickerMorph.prototype.rootForGrab=function(){return this},BlinkerMorph.prototype=new Morph,BlinkerMorph.prototype.constructor=BlinkerMorph,BlinkerMorph.uber=Morph.prototype,BlinkerMorph.prototype.init=function(t){BlinkerMorph.uber.init.call(this),this.color=new Color(0,0,0),this.fps=t||2,this.drawNew()},BlinkerMorph.prototype.step=function(){this.toggleVisibility()},CursorMorph.prototype=new BlinkerMorph,CursorMorph.prototype.constructor=CursorMorph,CursorMorph.uber=BlinkerMorph.prototype,CursorMorph.prototype.viewPadding=1,CursorMorph.prototype.init=function(t){var e;this.keyDownEventUsed=!1,this.target=t,this.originalContents=this.target.text,this.originalAlignment=this.target.alignment,this.slot=this.target.text.length,CursorMorph.uber.init.call(this),e=fontHeight(this.target.fontSize),this.setExtent(new Point(Math.max(Math.floor(e/20),1),e)),this.drawNew(),this.image.getContext("2d").font=this.target.font(),this.target instanceof TextMorph&&"left"!==this.target.alignment&&this.target.setAlignmentToLeft(),this.gotoSlot(this.slot),this.initializeClipboardHandler()},CursorMorph.prototype.initializeClipboardHandler=function(){var e=this,o=this.target.world();this.clipboardHandler=document.createElement("textarea"),this.clipboardHandler.style.position="absolute",this.clipboardHandler.style.top=window.outerHeight,this.clipboardHandler.style.right="101%",document.body.appendChild(this.clipboardHandler),this.clipboardHandler.value=this.target.selection(),this.clipboardHandler.focus(),this.clipboardHandler.select(),this.clipboardHandler.addEventListener("keypress",function(t){e.processKeyPress(t),this.value=e.target.selection(),this.select()},!1),this.clipboardHandler.addEventListener("keydown",function(t){e.processKeyDown(t),t.shiftKey&&(o.currentKey=16),this.value=e.target.selection(),this.select(),"U+0009"!==t.key&&"Tab"!==t.key||(e.processKeyPress(t),t.preventDefault())},!1),this.clipboardHandler.addEventListener("keyup",function(t){o.currentKey=null},!1),this.clipboardHandler.addEventListener("input",function(t){""===this.value&&(e.gotoSlot(e.target.selectionStartSlot()),e.target.deleteSelection())},!1)},CursorMorph.prototype.processKeyPress=function(t){return this.keyDownEventUsed?(this.keyDownEventUsed=!1,null):40===t.keyCode||40===t.charCode?(this.insert("("),null):37===t.keyCode||37===t.charCode?(this.insert("%"),null):(t.keyCode?t.ctrlKey&&!t.altKey?this.ctrl(t.keyCode,t.shiftKey):t.metaKey?this.cmd(t.keyCode,t.shiftKey):this.insert(String.fromCharCode(t.keyCode),t.shiftKey):t.charCode&&(t.ctrlKey&&!t.altKey?this.ctrl(t.charCode,t.shiftKey):t.metaKey?this.cmd(t.charCode,t.shiftKey):this.insert(String.fromCharCode(t.charCode),t.shiftKey)),void this.target.escalateEvent("reactToKeystroke",t))},CursorMorph.prototype.processKeyDown=function(t){var e=t.shiftKey,o=t.ctrlKey||t.altKey,i=0<this.target.selection().length;switch(this.keyDownEventUsed=!1,t.ctrlKey&&!t.altKey&&(this.ctrl(t.keyCode,t.shiftKey),this.target.escalateEvent("reactToKeystroke",t)),t.metaKey&&(this.cmd(t.keyCode,t.shiftKey),this.target.escalateEvent("reactToKeystroke",t)),t.keyCode){case 37:!i||e||o?this.goLeft(e,o?this.slot-this.target.previousWordFrom(this.slot):1):(this.gotoSlot(Math.min(this.target.startMark,this.target.endMark)),this.target.clearSelection()),this.keyDownEventUsed=!0;break;case 39:!i||e||o?this.goRight(e,o?this.target.nextWordFrom(this.slot)-this.slot:1):(this.gotoSlot(Math.max(this.target.startMark,this.target.endMark)),this.target.clearSelection()),this.keyDownEventUsed=!0;break;case 38:this.goUp(e),this.keyDownEventUsed=!0;break;case 40:this.goDown(e),this.keyDownEventUsed=!0;break;case 36:this.goHome(e),this.keyDownEventUsed=!0;break;case 35:this.goEnd(e),this.keyDownEventUsed=!0;break;case 46:this.deleteRight(),this.keyDownEventUsed=!0;break;case 8:this.deleteLeft(),this.keyDownEventUsed=!0;break;case 13:this.target instanceof StringMorph||e?this.accept():this.insert("\n"),this.keyDownEventUsed=!0;break;case 27:this.cancel(),this.keyDownEventUsed=!0;break;default:nop()}this.target.escalateEvent("reactToKeystroke",t)},CursorMorph.prototype.gotoSlot=function(t){var e,o,i=this.target.text.length,r=this.target.slotPosition(t);this.slot=t<0?0:i<t?i:t,this.parent&&this.target.isScrollable&&(e=this.parent.right()-this.viewPadding,o=this.parent.left()+this.viewPadding,r.x>e&&(this.target.setLeft(this.target.left()+e-r.x),r.x=e),r.x<o&&(o=Math.min(this.parent.left(),o),this.target.setLeft(this.target.left()+o-r.x),r.x=o),this.target.right()<e&&e-this.target.width()<o&&(r.x+=e-this.target.right(),this.target.setRight(e))),this.show(),this.setPosition(r),this.parent&&this.parent.parent instanceof ScrollFrameMorph&&this.target.isScrollable&&this.parent.parent.scrollCursorIntoView(this)},CursorMorph.prototype.goLeft=function(t,e){this.updateSelection(t),this.gotoSlot(this.slot-(e||1)),this.updateSelection(t)},CursorMorph.prototype.goRight=function(t,e){this.updateSelection(t),this.gotoSlot(this.slot+(e||1)),this.updateSelection(t)},CursorMorph.prototype.goUp=function(t){this.updateSelection(t),this.gotoSlot(this.target.upFrom(this.slot)),this.updateSelection(t)},CursorMorph.prototype.goDown=function(t){this.updateSelection(t),this.gotoSlot(this.target.downFrom(this.slot)),this.updateSelection(t)},CursorMorph.prototype.goHome=function(t){this.updateSelection(t),this.gotoSlot(this.target.startOfLine(this.slot)),this.updateSelection(t)},CursorMorph.prototype.goEnd=function(t){this.updateSelection(t),this.gotoSlot(this.target.endOfLine(this.slot)),this.updateSelection(t)},CursorMorph.prototype.gotoPos=function(t){this.gotoSlot(this.target.slotAt(t)),this.show()},CursorMorph.prototype.updateSelection=function(t){t?isNil(this.target.endMark)&&isNil(this.target.startMark)?(this.target.startMark=this.slot,this.target.endMark=this.slot):this.target.endMark!==this.slot&&(this.target.endMark=this.slot,this.target.drawNew(),this.target.changed()):this.target.clearSelection()},CursorMorph.prototype.accept=function(){var t=this.root();t&&t.stopEditing(),this.escalateEvent("accept",this)},CursorMorph.prototype.cancel=function(){var t=this.root();this.undo(),t&&t.stopEditing(),this.escalateEvent("cancel",this)},CursorMorph.prototype.undo=function(){this.target.text=this.originalContents,this.target.changed(),this.target.drawNew(),this.target.changed(),this.gotoSlot(0)},CursorMorph.prototype.insert=function(t,e){var o;if("\t"===t)return this.target.escalateEvent("reactToEdit",this.target),e?this.target.backTab(this.target):this.target.tab(this.target);this.target.isNumeric&&isNaN(parseFloat(t))&&!contains(["-","."],t)||(""!==this.target.selection()&&(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection()),o=(o=this.target.text).slice(0,this.slot)+t+o.slice(this.slot),this.target.text=o,this.target.drawNew(),this.target.changed(),this.goRight(!1,t.length))},CursorMorph.prototype.ctrl=function(t,e){64===t||65===t&&e?this.insert("@"):65===t?this.target.selectAll():90===t?this.undo():123===t?this.insert("{"):125===t?this.insert("}"):91===t?this.insert("["):93===t?this.insert("]"):isNil(this.target.receiver)||(68===t?this.target.doIt():73===t?this.target.inspectIt():80===t&&this.target.showIt())},CursorMorph.prototype.cmd=function(t,e){64===t||65===t&&e?this.insert("@"):65===t?this.target.selectAll():90===t?this.undo():isNil(this.target.receiver)||(68===t?this.target.doIt():73===t?this.target.inspectIt():80===t&&this.target.showIt())},CursorMorph.prototype.deleteRight=function(){var t;""!==this.target.selection()?(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection()):(t=this.target.text,this.target.changed(),t=t.slice(0,this.slot)+t.slice(this.slot+1),this.target.text=t,this.target.drawNew())},CursorMorph.prototype.deleteLeft=function(){var t;if(this.target.selection())return this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection();t=this.target.text,this.target.changed(),this.target.text=t.substring(0,this.slot-1)+t.substr(this.slot),this.target.drawNew(),this.goLeft()},CursorMorph.prototype.destroy=function(){this.target.alignment!==this.originalAlignment&&(this.target.alignment=this.originalAlignment,this.target.drawNew(),this.target.changed()),this.destroyClipboardHandler(),CursorMorph.uber.destroy.call(this)},CursorMorph.prototype.destroyClipboardHandler=function(){var t,e=document.body.children;if(this.clipboardHandler)for(t=0;t<e.length;t+=1)e[t]===this.clipboardHandler&&(document.body.removeChild(this.clipboardHandler),this.clipboardHandler=null)},CursorMorph.prototype.inspectKeyEvent=function(t){this.inform("Key pressed: "+String.fromCharCode(t.charCode)+"\n------------------------\ncharCode: "+t.charCode.toString()+"\nkeyCode: "+t.keyCode.toString()+"\nkey: "+t.key.toString()+"\nshiftKey: "+t.shiftKey.toString()+"\naltKey: "+t.altKey.toString()+"\nctrlKey: "+t.ctrlKey.toString()+"\ncmdKey: "+t.metaKey.toString())},BoxMorph.prototype=new Morph,BoxMorph.prototype.constructor=BoxMorph,BoxMorph.uber=Morph.prototype,BoxMorph.prototype.init=function(t,e,o){this.edge=t||4,this.border=e||(0===e?0:2),this.borderColor=o||new Color,BoxMorph.uber.init.call(this)},BoxMorph.prototype.drawNew=function(){var t;if(this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),0===this.edge&&0===this.border)return BoxMorph.uber.drawNew.call(this),null;t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),0<this.border&&(t.lineWidth=this.border,t.strokeStyle=this.borderColor.toString(),t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke())},BoxMorph.prototype.outlinePath=function(t,e,o){var i=e+o,r=this.width(),n=this.height();t.arc(i,i,e,radians(-180),radians(-90),!1),t.arc(r-i,i,e,radians(-90),radians(-0),!1),t.arc(r-i,n-i,e,radians(0),radians(90),!1),t.arc(i,n-i,e,radians(90),radians(180),!1)},BoxMorph.prototype.developersMenu=function(){var t=BoxMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("border width...",function(){this.prompt(t.title+"\nborder\nwidth:",this.setBorderWidth,this,this.border.toString(),null,0,100,!0)},"set the border's\nline size"),t.addItem("border color...",function(){this.pickColor(t.title+"\nborder color:",this.setBorderColor,this,this.borderColor)},"set the border's\nline color"),t.addItem("corner size...",function(){this.prompt(t.title+"\ncorner\nsize:",this.setCornerSize,this,this.edge.toString(),null,0,100,!0)},"set the corner's\nradius"),t},BoxMorph.prototype.setBorderWidth=function(t){var e;"number"==typeof t?this.border=Math.max(t,0):(e=parseFloat(t),isNaN(e)||(this.border=Math.max(e,0))),this.drawNew(),this.changed()},BoxMorph.prototype.setBorderColor=function(t){t&&(this.borderColor=t,this.drawNew(),this.changed())},BoxMorph.prototype.setCornerSize=function(t){var e;"number"==typeof t?this.edge=Math.max(t,0):(e=parseFloat(t),isNaN(e)||(this.edge=Math.max(e,0))),this.drawNew(),this.changed()},BoxMorph.prototype.colorSetters=function(){return["color","borderColor"]},BoxMorph.prototype.numericalSetters=function(){var t=BoxMorph.uber.numericalSetters.call(this);return t.push("setBorderWidth","setCornerSize"),t},SpeechBubbleMorph.prototype=new BoxMorph,SpeechBubbleMorph.prototype.constructor=SpeechBubbleMorph,SpeechBubbleMorph.uber=BoxMorph.prototype,SpeechBubbleMorph.prototype.init=function(t,e,o,i,r,n,s){this.isPointingRight=!0,this.contents=t||"",this.padding=n||0,this.isThought=s||!1,this.isClickable=!1,SpeechBubbleMorph.uber.init.call(this,o||6,i||(0===i?0:1),r||new Color(140,140,140)),this.color=e||new Color(230,230,230),this.drawNew()},SpeechBubbleMorph.prototype.popUp=function(t,e,o){this.drawNew(),this.setPosition(e.subtract(new Point(0,this.height()))),this.addShadow(new Point(2,2),80),this.keepWithin(t),t.add(this),this.fullChanged(),t.hand.destroyTemporaries(),t.hand.temporaries.push(this),o?this.isClickable=!0:this.mouseEnter=function(){this.destroy()}},SpeechBubbleMorph.prototype.drawNew=function(){this.contentsMorph&&this.contentsMorph.destroy(),this.contents instanceof Morph?this.contentsMorph=this.contents:isString(this.contents)?this.contentsMorph=new TextMorph(this.contents,MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center"):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):this.contentsMorph=new TextMorph(this.contents.toString(),MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center"),this.add(this.contentsMorph),this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))},SpeechBubbleMorph.prototype.outlinePath=function(i,t,e){var o,r=t+e,n=this.width(),s=this.height();function h(t,e,o){i.moveTo(t+o,e),i.arc(t,e,o,radians(0),radians(360))}i.arc(r,r,t,radians(-180),radians(-90),!1),i.arc(n-r,r,t,radians(-90),radians(-0),!1),i.arc(n-r,s-r-t,t,radians(0),radians(90),!1),this.isThought||(this.isPointingRight?(i.lineTo(r+t,s-r),i.lineTo(t/2+e,s-e)):(i.lineTo(n-(t/2+e),s-e),i.lineTo(n-(r+t),s-r))),i.arc(r,s-r-t,t,radians(90),radians(180),!1),!0===this.isThought&&(i.lineTo(e,r),this.isPointingRight?(h((o=t/4)+e,s-o-e,o),h(2*(o=t/3.2)+e,s-o-2*e,o),h(3*(o=t/2.8)+2*e,s-o-4*e,o)):(h(n-((o=t/4)+e),s-o-e,o),h(n-(2*(o=t/3.2)+e),s-o-2*e,o),h(n-(3*(o=t/2.8)+2*e),s-o-4*e,o)))},SpeechBubbleMorph.prototype.shadowImage=function(t,e){var o,i=t||new Point(7,7),r=e||new Color(0,0,0),n=this.extent(),s=this.image,h=newCanvas(n),a=h.getContext("2d");return a.drawImage(s,0,0),a.globalCompositeOperation="destination-out",a.drawImage(s,-i.x,-i.y),(a=(o=newCanvas(n)).getContext("2d")).drawImage(h,0,0),a.globalCompositeOperation="source-atop",a.fillStyle=r.toString(),a.fillRect(0,0,n.x,n.y),o},SpeechBubbleMorph.prototype.shadowImageBlurred=function(t,e){var o=t||new Point(7,7),i=this.shadowBlur,r=e||new Color(0,0,0),n=this.extent().add(2*i),s=this.image,h=newCanvas(n),a=h.getContext("2d");return a.shadowOffsetX=o.x,a.shadowOffsetY=o.y,a.shadowBlur=i,a.shadowColor=r.toString(),a.drawImage(s,i-o.x,i-o.y),a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0,a.globalCompositeOperation="destination-out",a.drawImage(s,i-o.x,i-o.y),h},SpeechBubbleMorph.prototype.fixLayout=function(){this.removeShadow(),this.drawNew(),this.addShadow(new Point(2,2),80)},DialMorph.prototype=new Morph,DialMorph.prototype.constructor=DialMorph,DialMorph.uber=Morph.prototype,DialMorph.prototype.init=function(t,e,o,i,r){this.target=null,this.action=null,this.min=t||0,this.max=e||360,this.value=Math.max(this.min,(o||0)%this.max),this.tick=i||15,this.fillColor=null,DialMorph.uber.init.call(this),this.color=new Color(230,230,230),this.noticesTransparentClick=!0,this.setRadius(r||4*MorphicPreferences.menuFontSize)},DialMorph.prototype.setRadius=function(t){this.radius=t,this.setExtent(new Point(2*this.radius,2*this.radius))},DialMorph.prototype.setValue=function(t,e,o){var i=this.max-this.min;t=t||0,this.value=this.min+(+t%i+i)%i,e&&(this.value<this.tick?this.value=this.min:this.value-=this.value%this.tick%this.value),this.drawNew(),this.changed(),o||this.updateTarget()},DialMorph.prototype.getValueOf=function(t){var e=this.max-this.min,o=this.center(),i=t.x-o.x,r=o.y-t.y;return e*(((Math.abs(i)<.001?r<0?90:270:Math.round((0<=i?0:180)-57.2957795131*Math.atan(r/i)))+90)/360)+this.min},DialMorph.prototype.setExtent=function(t){var e=Math.min(t.x,t.y);this.radius=e/2,DialMorph.uber.setExtent.call(this,new Point(e,e))},DialMorph.prototype.drawNew=function(){var t,e,o,i,r,n,s,h=this.color.lighter().toString(),a=this.max-this.min,l=a/this.tick,p=.75*this.radius,c=.85*p,u=.95*p;for(this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=h,t.beginPath(),t.arc(this.radius,this.radius,p+Math.min(1,this.radius-p),0,2*Math.PI,!1),t.closePath(),t.fill(),t.fillStyle=this.color.toString(),t.beginPath(),t.arc(this.radius,this.radius,p,0,2*Math.PI,!1),t.closePath(),t.fill(),o=(this.value-this.min)*(2*Math.PI)/a-Math.PI/2,t.fillStyle=(this.fillColor||this.color.darker()).toString(),t.beginPath(),t.arc(this.radius,this.radius,p,Math.PI/-2,o,!1),t.lineTo(this.radius,this.radius),t.closePath(),t.fill(),t.strokeStyle=new Color(35,35,35).toString(),t.lineWidth=1,e=0;e<l;e+=1)o=(e-3)*(2*Math.PI)/l-Math.PI/2,t.beginPath(),i=this.radius+Math.cos(o)*c,r=this.radius+Math.sin(o)*c,n=this.radius+Math.cos(o)*u,s=this.radius+Math.sin(o)*u,t.moveTo(i,r),t.lineTo(n,s),t.stroke();c=.05*p,t.fillStyle="black",t.beginPath(),t.arc(this.radius,this.radius,c,0,2*Math.PI,!1),t.closePath(),t.fill(),t.strokeStyle="black",t.lineWidth=1,o=(this.value-this.min)*(2*Math.PI)/a-Math.PI/2,u=.8*p,i=this.radius+Math.cos(o)*c,r=this.radius+Math.sin(o)*c,n=this.radius+Math.cos(o)*u,s=this.radius+Math.sin(o)*u,t.beginPath(),t.moveTo(i,r),t.lineTo(n,s),t.stroke(),c*=2,n=this.radius+Math.cos(o)*(u+c),s=this.radius+Math.sin(o)*(u+c),t.fillStyle="black",t.beginPath(),t.arc(n,s,c,0,2*Math.PI,!1),t.closePath(),t.stroke(),o=(this.value-this.min)*(2*Math.PI)/a-Math.PI/2,i=this.radius+Math.cos(o)*p,r=this.radius+Math.sin(o)*p,n=this.radius+Math.cos(o)*(this.radius-1),s=this.radius+Math.sin(o)*(this.radius-1),t.beginPath(),t.moveTo(i,r),t.lineTo(n,s),t.lineWidth=3,t.strokeStyle=h,t.stroke(),t.lineWidth=1,t.strokeStyle="black",t.stroke(),o=radians(degrees(o)-4),i=this.radius+Math.cos(o)*this.radius*.9,r=this.radius+Math.sin(o)*this.radius*.9,t.beginPath(),t.moveTo(i,r),o=radians(degrees(o)+8),i=this.radius+Math.cos(o)*this.radius*.9,r=this.radius+Math.sin(o)*this.radius*.9,t.lineTo(i,r),t.lineTo(n,s),t.closePath(),t.lineWidth=3,t.strokeStyle=h,t.stroke(),t.lineWidth=1,t.strokeStyle="black",t.stroke(),t.fill()},DialMorph.prototype.step=null,DialMorph.prototype.mouseDownLeft=function(t){var e=this,o=this.root();this.step=function(){o.hand.mouseButton?e.setValue(e.getValueOf(o.hand.bounds.origin),16!==o.currentKey):this.step=null}},DialMorph.prototype.developersMenu=function(){var t=DialMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("set target","setTarget","select another morph\nwhose numerical property\nwill be controlled by this one"),t},DialMorph.prototype.setTarget=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:"),o=this;t.push(this.world()),t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){o.target=t,o.setTargetSetter()})}),1===t.length?(this.target=t[0],this.setTargetSetter()):0<t.length&&e.popUpAtHand(this.world())},DialMorph.prototype.setTargetSetter=function(){var t=this.target.numericalSetters(),e=new MenuMorph(this,"choose target property:"),o=this;t.forEach(function(t){e.addItem(t,function(){o.action=t})}),1===t.length?this.action=t[0]:0<t.length&&e.popUpAtHand(this.world())},DialMorph.prototype.updateTarget=function(){this.action&&("function"==typeof this.action?this.action.call(this.target,this.value):this.target[this.action](this.value))},CircleBoxMorph.prototype=new Morph,CircleBoxMorph.prototype.constructor=CircleBoxMorph,CircleBoxMorph.uber=Morph.prototype,CircleBoxMorph.prototype.init=function(t){CircleBoxMorph.uber.init.call(this),this.orientation=t,this.autoOrient=!0,this.setExtent(new Point(20,100))},CircleBoxMorph.prototype.autoOrientation=function(){this.height()>this.width()?this.orientation="vertical":this.orientation="horizontal"},CircleBoxMorph.prototype.drawNew=function(){var e,t,o,i,r,n,s,h,a=this;this.autoOrient&&this.autoOrientation(),this.image=newCanvas(this.extent()),s=this.image.getContext("2d"),i="vertical"===this.orientation?(e=this.width()/2,t=new Point(r=this.center().x,this.top()+e),o=new Point(r,this.bottom()-e),this.bounds.origin.add(new Point(0,e)).corner(this.bounds.corner.subtract(new Point(0,e)))):(e=this.height()/2,n=this.center().y,t=new Point(this.left()+e,n),o=new Point(this.right()-e,n),this.bounds.origin.add(new Point(e,0)).corner(this.bounds.corner.subtract(new Point(e,0)))),[t.subtract(this.bounds.origin),o.subtract(this.bounds.origin)].forEach(function(t){s.fillStyle=a.color.toString(),s.beginPath(),s.arc(t.x,t.y,e,0,2*Math.PI,!1),s.closePath(),s.fill()}),0<(h=(i=i.translateBy(this.bounds.origin.neg())).extent()).x&&0<h.y&&s.fillRect(i.origin.x,i.origin.y,i.width(),i.height())},CircleBoxMorph.prototype.developersMenu=function(){var t=CircleBoxMorph.uber.developersMenu.call(this);return t.addLine(),"vertical"===this.orientation?t.addItem("horizontal...","toggleOrientation","toggle the\norientation"):t.addItem("vertical...","toggleOrientation","toggle the\norientation"),t},CircleBoxMorph.prototype.toggleOrientation=function(){var t=this.center();this.changed(),"vertical"===this.orientation?this.orientation="horizontal":this.orientation="vertical",this.silentSetExtent(new Point(this.height(),this.width())),this.setCenter(t),this.drawNew(),this.changed()},SliderButtonMorph.prototype=new CircleBoxMorph,SliderButtonMorph.prototype.constructor=SliderButtonMorph,SliderButtonMorph.uber=CircleBoxMorph.prototype,SliderButtonMorph.prototype.init=function(t){this.color=new Color(80,80,80),this.highlightColor=new Color(90,90,140),this.pressColor=new Color(80,80,160),this.is3D=!1,this.hasMiddleDip=!0,SliderButtonMorph.uber.init.call(this,t)},SliderButtonMorph.prototype.autoOrientation=nop,SliderButtonMorph.prototype.drawNew=function(){var t=this.color.copy();SliderButtonMorph.uber.drawNew.call(this),!this.is3D&&MorphicPreferences.isFlat||this.drawEdges(),this.normalImage=this.image,this.color=this.highlightColor.copy(),SliderButtonMorph.uber.drawNew.call(this),!this.is3D&&MorphicPreferences.isFlat||this.drawEdges(),this.highlightImage=this.image,this.color=this.pressColor.copy(),SliderButtonMorph.uber.drawNew.call(this),!this.is3D&&MorphicPreferences.isFlat||this.drawEdges(),this.pressImage=this.image,this.color=t,this.image=this.normalImage},SliderButtonMorph.prototype.drawEdges=function(){var t,e,o=this.image.getContext("2d"),i=this.width(),r=this.height();o.lineJoin="round",o.lineCap="round","vertical"===this.orientation?(o.lineWidth=i/3,(t=o.createLinearGradient(0,0,o.lineWidth,0)).addColorStop(0,"white"),t.addColorStop(1,this.color.toString()),o.strokeStyle=t,o.beginPath(),o.moveTo(.5*o.lineWidth,i/2),o.lineTo(.5*o.lineWidth,r-i/2),o.stroke(),(t=o.createLinearGradient(i-o.lineWidth,0,i,0)).addColorStop(0,this.color.toString()),t.addColorStop(1,"black"),o.strokeStyle=t,o.beginPath(),o.moveTo(i-.5*o.lineWidth,i/2),o.lineTo(i-.5*o.lineWidth,r-i/2),o.stroke(),this.hasMiddleDip&&(e=i/4,(t=o.createLinearGradient(o.lineWidth,0,i-o.lineWidth,0)).addColorStop(0,"black"),t.addColorStop(.35,this.color.toString()),t.addColorStop(.65,this.color.toString()),t.addColorStop(1,"white"),o.fillStyle=t,o.beginPath(),o.arc(i/2,r/2,e,radians(0),radians(360),!1),o.closePath(),o.fill())):"horizontal"===this.orientation&&(o.lineWidth=r/3,(t=o.createLinearGradient(0,0,0,o.lineWidth)).addColorStop(0,"white"),t.addColorStop(1,this.color.toString()),o.strokeStyle=t,o.beginPath(),o.moveTo(r/2,.5*o.lineWidth),o.lineTo(i-r/2,.5*o.lineWidth),o.stroke(),(t=o.createLinearGradient(0,r-o.lineWidth,0,r)).addColorStop(0,this.color.toString()),t.addColorStop(1,"black"),o.strokeStyle=t,o.beginPath(),o.moveTo(r/2,r-.5*o.lineWidth),o.lineTo(i-r/2,r-.5*o.lineWidth),o.stroke(),this.hasMiddleDip&&(e=r/4,(t=o.createLinearGradient(0,o.lineWidth,0,r-o.lineWidth)).addColorStop(0,"black"),t.addColorStop(.35,this.color.toString()),t.addColorStop(.65,this.color.toString()),t.addColorStop(1,"white"),o.fillStyle=t,o.beginPath(),o.arc(this.width()/2,this.height()/2,e,radians(0),radians(360),!1),o.closePath(),o.fill()))},SliderButtonMorph.prototype.mouseEnter=function(){this.image=this.highlightImage,this.changed()},SliderButtonMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed()},SliderButtonMorph.prototype.mouseDownLeft=function(t){this.image=this.pressImage,this.changed(),this.escalateEvent("mouseDownLeft",t)},SliderButtonMorph.prototype.mouseClickLeft=function(){this.image=this.highlightImage,this.changed()},SliderButtonMorph.prototype.mouseMove=function(){nop()},SliderMorph.prototype=new CircleBoxMorph,SliderMorph.prototype.constructor=SliderMorph,SliderMorph.uber=CircleBoxMorph.prototype,SliderMorph.prototype.init=function(t,e,o,i,r,n){this.target=null,this.action=null,this.start=t,this.stop=e,this.value=o,this.size=i,this.offset=null,this.button=new SliderButtonMorph,this.button.isDraggable=!1,this.button.color=new Color(200,200,200),this.button.highlightColor=new Color(210,210,255),this.button.pressColor=new Color(180,180,255),SliderMorph.uber.init.call(this,r),this.add(this.button),this.alpha=.3,this.color=n||new Color(0,0,0),this.setExtent(new Point(20,100))},SliderMorph.prototype.autoOrientation=nop,SliderMorph.prototype.rangeSize=function(){return this.stop-this.start},SliderMorph.prototype.ratio=function(){return this.size/(this.rangeSize()+1)},SliderMorph.prototype.unitSize=function(){return"vertical"===this.orientation?(this.height()-this.button.height())/this.rangeSize():(this.width()-this.button.width())/this.rangeSize()},SliderMorph.prototype.drawNew=function(){var t,e,o,i;SliderMorph.uber.drawNew.call(this),this.button.orientation=this.orientation,"vertical"===this.orientation?(t=this.width()-2,e=Math.max(t,Math.round(this.height()*this.ratio())),this.button.silentSetExtent(new Point(t,e)),o=1,i=Math.min(Math.round((this.value-this.start)*this.unitSize()),this.height()-this.button.height())):(e=this.height()-2,t=Math.max(e,Math.round(this.width()*this.ratio())),this.button.silentSetExtent(new Point(t,e)),i=1,o=Math.min(Math.round((this.value-this.start)*this.unitSize()),this.width()-this.button.width())),this.button.setPosition(new Point(o,i).add(this.bounds.origin)),this.button.drawNew(),this.button.changed()},SliderMorph.prototype.updateValue=function(){var t="vertical"===this.orientation?this.button.top()-this.top():this.button.left()-this.left();this.value=Math.round(t/this.unitSize()+this.start),this.updateTarget()},SliderMorph.prototype.updateTarget=function(){this.action&&("function"==typeof this.action?this.action.call(this.target,this.value):this.target[this.action](this.value))},SliderMorph.prototype.developersMenu=function(){var t=SliderMorph.uber.developersMenu.call(this);return t.addItem("show value...","showValue","display a dialog box\nshowing the selected number"),t.addItem("floor...",function(){this.prompt(t.title+"\nfloor:",this.setStart,this,this.start.toString(),null,0,this.stop-this.size,!0)},"set the minimum value\nwhich can be selected"),t.addItem("ceiling...",function(){this.prompt(t.title+"\nceiling:",this.setStop,this,this.stop.toString(),null,this.start+this.size,100*this.size,!0)},"set the maximum value\nwhich can be selected"),t.addItem("button size...",function(){this.prompt(t.title+"\nbutton size:",this.setSize,this,this.size.toString(),null,1,this.stop-this.start,!0)},"set the range\ncovered by\nthe slider button"),t.addLine(),t.addItem("set target","setTarget","select another morph\nwhose numerical property\nwill be controlled by this one"),t},SliderMorph.prototype.showValue=function(){this.inform(this.value)},SliderMorph.prototype.userSetStart=function(t){this.start=Math.max(t,this.stop)},SliderMorph.prototype.setStart=function(t,e){var o;"number"==typeof t?this.start=Math.min(t,this.stop-this.size):(o=parseFloat(t),isNaN(o)||(this.start=Math.min(o,this.stop-this.size))),this.value=Math.max(this.value,this.start),e||this.updateTarget(),this.drawNew(),this.changed()},SliderMorph.prototype.setStop=function(t,e){var o;"number"==typeof t?this.stop=Math.max(t,this.start+this.size):(o=parseFloat(t),isNaN(o)||(this.stop=Math.max(o,this.start+this.size))),this.value=Math.min(this.value,this.stop),e||this.updateTarget(),this.drawNew(),this.changed()},SliderMorph.prototype.setSize=function(t,e){var o;"number"==typeof t?this.size=Math.min(Math.max(t,1),this.stop-this.start):(o=parseFloat(t),isNaN(o)||(this.size=Math.min(Math.max(o,1),this.stop-this.start))),this.value=Math.min(this.value,this.stop-this.size),e||this.updateTarget(),this.drawNew(),this.changed()},SliderMorph.prototype.setTarget=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:"),o=this;t.push(this.world()),t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){o.target=t,o.setTargetSetter()})}),1===t.length?(this.target=t[0],this.setTargetSetter()):0<t.length&&e.popUpAtHand(this.world())},SliderMorph.prototype.setTargetSetter=function(){var t=this.target.numericalSetters(),e=new MenuMorph(this,"choose target property:"),o=this;t.forEach(function(t){e.addItem(t,function(){o.action=t})}),1===t.length?this.action=t[0]:0<t.length&&e.popUpAtHand(this.world())},SliderMorph.prototype.numericalSetters=function(){var t=SliderMorph.uber.numericalSetters.call(this);return t.push("setStart","setStop","setSize"),t},SliderMorph.prototype.step=null,SliderMorph.prototype.mouseDownLeft=function(t){var i,r=this;this.button.bounds.containsPoint(t)?this.offset=t.subtract(this.button.bounds.origin):this.offset=new Point,i=this.root(),this.step=function(){var t,e,o;i.hand.mouseButton?(t=i.hand.bounds.origin,"vertical"===r.orientation?(e=r.button.bounds.origin.x,o=Math.max(Math.min(t.y-r.offset.y,r.bottom()-r.button.height()),r.top())):(o=r.button.bounds.origin.y,e=Math.max(Math.min(t.x-r.offset.x,r.right()-r.button.width()),r.left())),r.button.setPosition(new Point(e,o)),r.updateValue()):this.step=null}},MouseSensorMorph.prototype=new BoxMorph,MouseSensorMorph.prototype.constructor=MouseSensorMorph,MouseSensorMorph.uber=BoxMorph.prototype,MouseSensorMorph.prototype.init=function(t,e,o){MouseSensorMorph.uber.init.call(this),this.edge=t||4,this.border=e||2,this.color=new Color(255,255,255),this.borderColor=o||new Color,this.isTouched=!1,this.upStep=.05,this.downStep=.02,this.noticesTransparentClick=!1,this.drawNew()},MouseSensorMorph.prototype.touch=function(){var t=this;this.isTouched||(this.isTouched=!0,this.alpha=.6,this.step=function(){t.isTouched?t.alpha<1&&(t.alpha=t.alpha+t.upStep):t.alpha>t.downStep?t.alpha=t.alpha-t.downStep:(t.alpha=0,t.step=null),t.changed()})},MouseSensorMorph.prototype.unTouch=function(){this.isTouched=!1},MouseSensorMorph.prototype.mouseEnter=function(){this.touch()},MouseSensorMorph.prototype.mouseLeave=function(){this.unTouch()},MouseSensorMorph.prototype.mouseDownLeft=function(){this.touch()},MouseSensorMorph.prototype.mouseClickLeft=function(){this.unTouch()},InspectorMorph.prototype=new BoxMorph,InspectorMorph.prototype.constructor=InspectorMorph,InspectorMorph.uber=BoxMorph.prototype,InspectorMorph.prototype.init=function(t){this.target=t,this.currentProperty=null,this.showing="attributes",this.markOwnProperties=!1,this.hasUserEditedDetails=!1,InspectorMorph.uber.init.call(this),this.silentSetExtent(new Point(20*MorphicPreferences.handleSize,20*MorphicPreferences.handleSize*2/3)),this.isDraggable=!0,this.border=1,this.edge=MorphicPreferences.isFlat?1:5,this.color=new Color(60,60,60),this.borderColor=new Color(95,95,95),this.fps=25,this.drawNew(),this.label=null,this.list=null,this.detail=null,this.work=null,this.buttonInspect=null,this.buttonClose=null,this.buttonSubset=null,this.buttonEdit=null,this.resizer=null,this.target&&this.buildPanes()},InspectorMorph.prototype.setTarget=function(t){this.target=t,this.currentProperty=null,this.buildPanes()},InspectorMorph.prototype.updateCurrentSelection=function(){var t,e,o,i=this.list.selected,r=this.detail.contents.children[0],n=this.root();n&&n.keyboardReceiver instanceof CursorMorph&&n.keyboardReceiver.target===r?this.hasUserEditedDetails=!0:isNil(i)||this.hasUserEditedDetails||(t=this.target[i],e=isNil(this.currentProperty=t)?"NULL":isString(t)?t:t.toString(),r.text!==e&&((o=new TextMorph(e)).isEditable=!0,o.enableSelecting(),o.setReceiver(this.target),this.detail.setContents(o)))},InspectorMorph.prototype.buildPanes=function(){var t,e,o,i,r=[],n=this;for(t in this.children.forEach(function(t){t!==this.work&&t.destroy()}),this.children=[],this.label=new TextMorph(this.target.toString()),this.label.fontSize=MorphicPreferences.menuFontSize,this.label.isBold=!0,this.label.color=new Color(255,255,255),this.label.drawNew(),this.add(this.label),this.target)t&&r.push(t);"attributes"===this.showing?r=r.filter(function(t){return"function"!=typeof n.target[t]}):"methods"===this.showing&&(r=r.filter(function(t){return"function"==typeof n.target[t]})),i=function(){var t,e;isObject(n.currentProperty)&&(t=n.world(),(e=new InspectorMorph(n.currentProperty)).setPosition(t.hand.position()),e.keepWithin(t),t.add(e),e.changed())},this.list=new ListMorph(this.target instanceof Array?r:r.sort(),null,this.markOwnProperties?[[new Color(0,0,180),function(t){return Object.prototype.hasOwnProperty.call(n.target,t)}]]:null,i),this.list.action=function(){n.hasUserEditedDetails=!1,n.updateCurrentSelection()},this.list.hBar.alpha=.6,this.list.vBar.alpha=.6,this.list.contents.step=null,this.add(this.list),this.detail=new ScrollFrameMorph,this.detail.acceptsDrops=!1,this.detail.contents.acceptsDrops=!1,this.detail.isTextLineWrapping=!0,this.detail.color=new Color(255,255,255),this.detail.hBar.alpha=.6,this.detail.vBar.alpha=.6,(e=new TextMorph("")).isEditable=!0,e.enableSelecting(),e.setReceiver(this.target),this.detail.setContents(e),this.add(this.detail),null===this.work&&(this.work=new ScrollFrameMorph,this.work.acceptsDrops=!1,this.work.contents.acceptsDrops=!1,this.work.isTextLineWrapping=!0,this.work.color=new Color(255,255,255),this.work.hBar.alpha=.6,this.work.vBar.alpha=.6,(o=new TextMorph("")).isEditable=!0,o.enableSelecting(),o.setReceiver(this.target),this.work.setContents(o)),this.add(this.work),this.buttonSubset=new TriggerMorph,this.buttonSubset.labelString="show...",this.buttonSubset.action=function(){var t=new MenuMorph;t.addItem("attributes",function(){n.showing="attributes",n.buildPanes()}),t.addItem("methods",function(){n.showing="methods",n.buildPanes()}),t.addItem("all",function(){n.showing="all",n.buildPanes()}),t.addLine(),t.addItem(n.markOwnProperties?"un-mark own":"mark own",function(){n.markOwnProperties=!n.markOwnProperties,n.buildPanes()},"highlight\n'own' properties"),t.popUpAtHand(n.world())},this.add(this.buttonSubset),this.buttonInspect=new TriggerMorph,this.buttonInspect.labelString="inspect...",this.buttonInspect.action=function(){var t,e,o;isObject(n.currentProperty)?((t=new MenuMorph).addItem("in new inspector...",function(){e=n.world(),(o=new InspectorMorph(n.currentProperty)).setPosition(e.hand.position()),o.keepWithin(e),e.add(o),o.changed()}),t.addItem("here...",function(){n.setTarget(n.currentProperty)}),t.popUpAtHand(n.world())):n.inform((null===n.currentProperty?"null":typeof n.currentProperty)+"\nis not inspectable")},this.add(this.buttonInspect),this.buttonEdit=new TriggerMorph,this.buttonEdit.labelString="edit...",this.buttonEdit.action=function(){var t=new MenuMorph(n);t.addItem("save","save","accept changes"),t.addLine(),t.addItem("add property...","addProperty"),t.addItem("rename...","renameProperty"),t.addItem("remove...","removeProperty"),t.popUpAtHand(n.world())},this.add(this.buttonEdit),this.buttonClose=new TriggerMorph,this.buttonClose.labelString="close",this.buttonClose.action=function(){n.destroy()},this.add(this.buttonClose),this.resizer=new HandleMorph(this,150,100,this.edge,this.edge),this.fixLayout()},InspectorMorph.prototype.fixLayout=function(){var t,e,o,i;Morph.prototype.trackChanges=!1,t=this.left()+this.edge,e=this.top()+this.edge,o=this.right()-this.edge-t,this.label.setPosition(new Point(t,e)),this.label.setWidth(o),this.label.height()>this.height()-50&&(this.silentSetHeight(this.label.height()+50),this.drawNew(),this.changed(),this.resizer.drawNew()),e=this.label.bottom()+2,o=Math.min(Math.floor(this.width()/3),this.list.listContents.width()),o-=this.edge,i=this.bottom()-2*this.edge-MorphicPreferences.handleSize-e,this.list.setPosition(new Point(t,e)),this.list.setExtent(new Point(o,i)),t=this.list.right()+this.edge,o=this.right()-this.edge-t,this.detail.setPosition(new Point(t,e)),this.detail.setExtent(new Point(o,2*i/3-this.edge)),e=this.detail.bottom()+this.edge,this.work.setPosition(new Point(t,e)),this.work.setExtent(new Point(o,i/3)),t=this.list.left(),e=this.list.bottom()+this.edge,o=this.list.width(),i=MorphicPreferences.handleSize,this.buttonSubset.setPosition(new Point(t,e)),this.buttonSubset.setExtent(new Point(o,i)),t=this.detail.left(),o=(o=this.detail.width()-this.edge-MorphicPreferences.handleSize)/3-this.edge/3,this.buttonInspect.setPosition(new Point(t,e)),this.buttonInspect.setExtent(new Point(o,i)),t=this.buttonInspect.right()+this.edge,this.buttonEdit.setPosition(new Point(t,e)),this.buttonEdit.setExtent(new Point(o,i)),t=this.buttonEdit.right()+this.edge,o=this.detail.right()-this.edge-MorphicPreferences.handleSize-t,this.buttonClose.setPosition(new Point(t,e)),this.buttonClose.setExtent(new Point(o,i)),Morph.prototype.trackChanges=!0,this.changed()},InspectorMorph.prototype.setExtent=function(t){InspectorMorph.uber.setExtent.call(this,t),this.fixLayout()},InspectorMorph.prototype.save=function(){var t=this.detail.contents.children[0].text.toString(),e=this.list.selected;try{this.target.evaluateString("this."+e+" = "+t),this.hasUserEditedDetails=!1,this.target.drawNew&&(this.target.changed(),this.target.drawNew(),this.target.changed())}catch(t){this.inform(t)}},InspectorMorph.prototype.addProperty=function(){var e=this;this.prompt("new property name:",function(t){t&&(e.target[t]=null,e.buildPanes(),e.target.drawNew&&(e.target.changed(),e.target.drawNew(),e.target.changed()))},this,"property")},InspectorMorph.prototype.renameProperty=function(){var e=this,o=this.list.selected;this.prompt("property name:",function(t){try{delete e.target[o],e.target[t]=e.currentProperty}catch(t){e.inform(t)}e.buildPanes(),e.target.drawNew&&(e.target.changed(),e.target.drawNew(),e.target.changed())},this,o)},InspectorMorph.prototype.removeProperty=function(){var t=this.list.selected;try{delete this.target[t],this.currentProperty=null,this.buildPanes(),this.target.drawNew&&(this.target.changed(),this.target.drawNew(),this.target.changed())}catch(t){this.inform(t)}},InspectorMorph.prototype.step=function(){this.updateCurrentSelection();var t=this.target.toString();this.label.text!==t&&(this.label.text=t,this.label.drawNew(),this.fixLayout())},InspectorMorph.prototype.updateReferences=function(t){var e=this.list.activeIndex();InspectorMorph.uber.updateReferences.call(this,t),this.buildPanes(),this.list.activateIndex(e)},MenuMorph.prototype=new BoxMorph,MenuMorph.prototype.constructor=MenuMorph,MenuMorph.uber=BoxMorph.prototype,MenuMorph.prototype.init=function(t,e,o,i){this.target=t,this.title=e||null,this.environment=o||null,this.fontSize=i||null,this.items=[],this.label=null,this.world=null,this.isListContents=!1,this.hasFocus=!1,this.selection=null,this.submenu=null,MenuMorph.uber.init.call(this),this.isDraggable=!1,this.border=null,this.edge=null},MenuMorph.prototype.addItem=function(t,e,o,i,r,n,s,h){this.items.push([localize(t||"close"),e||nop,o,i,r||!1,n||!1,s,h])},MenuMorph.prototype.addMenu=function(t,e,o){this.addPair(t,e,isNil(o)?"º":o)},MenuMorph.prototype.addPair=function(t,e,o,i){this.addItem(t,e,i,null,null,null,null,o)},MenuMorph.prototype.addLine=function(t){this.items.push([0,t||1])},MenuMorph.prototype.createLabel=function(){var t;null!==this.label&&this.label.destroy(),(t=new TextMorph(localize(this.title),this.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,!0,!1,"center")).alignment="center",t.color=new Color(255,255,255),t.backgroundColor=this.borderColor,t.drawNew(),this.label=new BoxMorph(3,0),MorphicPreferences.isFlat&&(this.label.edge=0),this.label.color=this.borderColor,this.label.borderColor=this.borderColor,this.label.setExtent(t.extent().add(4)),this.label.drawNew(),this.label.add(t),this.label.text=t},MenuMorph.prototype.drawNew=function(){var e,t,o,i,r=this,n=!1;this.children.forEach(function(t){t.destroy()}),this.children=[],this.isListContents||(this.edge=MorphicPreferences.isFlat?0:5,this.border=MorphicPreferences.isFlat?1:2),this.color=new Color(255,255,255),this.borderColor=new Color(60,60,60),this.silentSetExtent(new Point(0,0)),i=2,o=this.left()+4,this.isListContents||(i=this.title?(this.createLabel(),this.label.setPosition(this.bounds.origin.add(4)),this.add(this.label),this.label.bottom()):this.top()+4),i+=1,this.items.forEach(function(t){n=!1,t instanceof StringFieldMorph||t instanceof ColorPickerMorph||t instanceof SliderMorph||t instanceof DialMorph?e=t:0===t[0]?(n=!0,(e=new Morph).color=r.borderColor,e.setHeight(t[1])):e=new MenuItemMorph(r.target,t[1],t[0],r.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,r.environment,t[2],t[3],t[4],t[5],t[6],t[7]),n&&(i+=1),e.setPosition(new Point(o,i)),r.add(e),i+=e.height(),n&&(i+=1)}),t=this.fullBounds(),this.silentSetExtent(t.extent().add(4)),this.adjustWidths(),MenuMorph.uber.drawNew.call(this)},MenuMorph.prototype.maxWidth=function(){var e=0;return this.parent instanceof FrameMorph&&this.parent.scrollFrame instanceof ScrollFrameMorph&&(e=this.parent.scrollFrame.width()),this.children.forEach(function(t){t instanceof MenuItemMorph?e=Math.max(e,t.label.width()+8+(t.shortcut?t.shortcut.width()+4:0)):(t instanceof StringFieldMorph||t instanceof ColorPickerMorph||t instanceof SliderMorph||t instanceof DialMorph)&&(e=Math.max(e,t.width()))}),this.label&&(e=Math.max(e,this.label.width())),e},MenuMorph.prototype.adjustWidths=function(){var e,o=this.maxWidth(),i=this;this.children.forEach(function(t){t instanceof DialMorph||t.silentSetWidth(o),t instanceof MenuItemMorph?(t.fixLayout(),e=t.image===t.pressImage,t.createBackgrounds(),e&&(t.image=t.pressImage)):(t.drawNew(),t===i.label&&t.text.setPosition(t.center().subtract(t.text.extent().floorDivideBy(2))))})},MenuMorph.prototype.unselectAllItems=function(){this.children.forEach(function(t){t instanceof MenuItemMorph?t.image=t.normalImage:t instanceof ScrollFrameMorph&&t.contents.children.forEach(function(t){t instanceof MenuItemMorph&&(t.image=t.normalImage)})}),this.changed()},MenuMorph.prototype.popup=function(t,e){var o;this.drawNew(),this.setPosition(e),this.addShadow(new Point(2,2),80),this.keepWithin(t),this.bottom()>t.bottom()&&(this.removeShadow(),o=this.scroll(),this.bounds.corner.y=t.bottom()-2,MenuMorph.uber.drawNew.call(this),this.addShadow(new Point(2,2),80),o.setHeight(t.bottom()-o.top()-6),o.adjustScrollBars()),t.activeMenu&&t.activeMenu.destroy(),this.items.length<1&&!this.title||(t.add(this),(t.activeMenu=this).world=t,this.fullChanged())},MenuMorph.prototype.scroll=function(){var e=new ScrollFrameMorph,t=this.label?1:0,o=this.children[t];return e.setPosition(o.position()),this.children.slice(t).forEach(function(t){e.addContents(t)}),this.add(e),e.setWidth(o.width()),e},MenuMorph.prototype.popUpAtHand=function(t){var e=t||this.world;this.popup(e,e.hand.position())},MenuMorph.prototype.popUpCenteredAtHand=function(t){var e=t||this.world;this.drawNew(),this.popup(e,e.hand.position().subtract(this.extent().floorDivideBy(2)))},MenuMorph.prototype.popUpCenteredInWorld=function(t){var e=t||this.world;this.drawNew(),this.popup(e,e.center().subtract(this.extent().floorDivideBy(2)))},MenuMorph.prototype.closeRootMenu=function(){this.parent instanceof MenuMorph?this.parent.closeRootMenu():this.destroy()},MenuMorph.prototype.closeSubmenu=function(){this.submenu&&(this.submenu.destroy(),this.submenu=null,this.unselectAllItems())},MenuMorph.prototype.getFocus=function(){(this.world.keyboardReceiver=this).selection=null,this.selectFirst(),this.hasFocus=!0},MenuMorph.prototype.processKeyDown=function(t){switch(t.keyCode){case 13:case 32:return void(this.selection&&(this.selection.mouseClickLeft(),this.submenu&&this.submenu.getFocus()));case 27:return this.destroy();case 37:return this.leaveSubmenu();case 38:return this.selectUp();case 39:return this.enterSubmenu();case 40:return this.selectDown();default:nop()}},MenuMorph.prototype.processKeyUp=function(t){nop(t)},MenuMorph.prototype.processKeyPress=function(t){nop(t)},MenuMorph.prototype.selectFirst=function(){for(var t=detect(this.children,function(t){return t instanceof ScrollFrameMorph}),e=t?t.contents.children:this.children,o=0;o<e.length;o+=1)if(e[o]instanceof MenuItemMorph)return void this.select(e[o])},MenuMorph.prototype.selectUp=function(){var t,e=detect(this.children,function(t){return t instanceof ScrollFrameMorph}),o=(e?e.contents.children:this.children).filter(function(t){return t instanceof MenuItemMorph});this.selection?((t=o.indexOf(this.selection)-1)<0&&(t=o.length-1),this.select(o[t])):o.length&&this.select(o[0])},MenuMorph.prototype.selectDown=function(){var t,e=detect(this.children,function(t){return t instanceof ScrollFrameMorph}),o=(e?e.contents.children:this.children).filter(function(t){return t instanceof MenuItemMorph});this.selection?((t=o.indexOf(this.selection)+1)>=o.length&&(t=0),this.select(o[t])):o.length&&this.select(o[0])},MenuMorph.prototype.enterSubmenu=function(){this.selection&&this.selection.action instanceof MenuMorph&&(this.selection.popUpSubmenu(),this.submenu&&this.submenu.getFocus())},MenuMorph.prototype.leaveSubmenu=function(){var t=this.parent;this.parent instanceof MenuMorph&&(t.submenu=null,t.hasFocus=!0,this.destroy(),t.world.keyboardReceiver=t)},MenuMorph.prototype.select=function(t){this.unselectAllItems(),t.image=t.highlightImage,t.changed(),t.scrollIntoView(),this.selection=t},MenuMorph.prototype.destroy=function(){this.hasFocus&&(this.world.keyboardReceiver=null),MenuMorph.uber.destroy.call(this)},StringMorph.prototype=new Morph,StringMorph.prototype.constructor=StringMorph,StringMorph.uber=Morph.prototype,StringMorph.prototype.init=function(t,e,o,i,r,n,s,h,a,l){this.text=t||(""===t?"":"StringMorph"),this.fontSize=e||12,this.fontName=l||MorphicPreferences.globalFontFamily,this.fontStyle=o||"sans-serif",this.isBold=i||!1,this.isItalic=r||!1,this.isEditable=!1,this.isNumeric=n||!1,this.isPassword=!1,this.shadowOffset=s||new Point(0,0),this.shadowColor=h||null,this.isShowingBlanks=!1,this.blanksColor=new Color(180,140,140),this.isScrollable=!0,this.currentlySelecting=!1,this.startMark=0,this.endMark=0,this.markedTextColor=new Color(255,255,255),this.markedBackgoundColor=new Color(60,60,120),StringMorph.uber.init.call(this,!0),this.color=a||new Color(0,0,0),this.noticesTransparentClick=!0,this.drawNew()},StringMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+'("'+this.text.slice(0,30)+'...")'},StringMorph.prototype.password=function(t,e){for(var o="",i=0;i<e;i+=1)o+=t;return o},StringMorph.prototype.font=function(){var t="";return this.isBold&&(t+="bold "),this.isItalic&&(t+="italic "),t+this.fontSize+"px "+(this.fontName?this.fontName+", ":"")+this.fontStyle},StringMorph.prototype.drawNew=function(){var t,e,o,i,r,n,s,h,a,l=this.shadowOffset||new Point,p=this.isPassword?this.password("*",this.text.length):this.text;for(this.image=newCanvas(),(t=this.image.getContext("2d")).font=this.font(),e=Math.max(t.measureText(p).width+Math.abs(l.x),1),this.bounds.corner=this.bounds.origin.add(new Point(e,fontHeight(this.fontSize)+Math.abs(l.y))),this.image.width=e,this.image.height=this.height(),t.font=this.font(),t.textAlign="left",t.textBaseline="bottom",this.shadowColor&&(h=Math.max(l.x,0),a=Math.max(l.y,0),t.fillStyle=this.shadowColor.toString(),t.fillText(p,h,fontHeight(this.fontSize)+a)),h=Math.abs(Math.min(l.x,0)),a=Math.abs(Math.min(l.y,0)),t.fillStyle=this.color.toString(),this.isShowingBlanks?this.renderWithBlanks(t,h,fontHeight(this.fontSize)+a):t.fillText(p,h,fontHeight(this.fontSize)+a),o=Math.min(this.startMark,this.endMark),i=Math.max(this.startMark,this.endMark),r=o;r<i;r+=1)n=this.slotPosition(r).subtract(this.position()),s=p.charAt(r),t.fillStyle=this.markedBackgoundColor.toString(),t.fillRect(n.x,n.y,t.measureText(s).width+1+h,fontHeight(this.fontSize)+a),t.fillStyle=this.markedTextColor.toString(),t.fillText(s,n.x+h,fontHeight(this.fontSize)+a);this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},StringMorph.prototype.renderWithBlanks=function(e,t,o){var i=e.measureText(" ").width,r=newCanvas(new Point(i,this.height())),n=r.getContext("2d"),s=this.text.split(" "),h=t||0,a=!0;n.fillStyle=this.blanksColor.toString(),n.arc(i/2,r.height/2,i/2,radians(0),radians(360)),n.fill(),s.forEach(function(t){a||(e.drawImage(r,h,0),h+=i),a=!1,""!==t&&(e.fillText(t,h,o),h+=e.measureText(t).width)})},StringMorph.prototype.slotPosition=function(t){for(var e=this.isPassword?this.password("*",this.text.length):this.text,o=Math.min(Math.max(t,0),e.length),i=this.image.getContext("2d"),r=0,n=0;n<o;n+=1)r+=i.measureText(e[n]).width;return this.pos=o,new Point(this.left()+r,this.top())},StringMorph.prototype.slotAt=function(t){for(var e=this.isPassword?this.password("*",this.text.length):this.text,o=0,i=0,r=this.image.getContext("2d");t.x-this.left()>i;)if(i+=r.measureText(e[o]).width,(o+=1)===e.length&&r.measureText(e).width-r.measureText(e[o-1]).width/2<t.x-this.left())return o;return t.x-this.left()>i-r.measureText(e[o-1]).width/2?o:o-1},StringMorph.prototype.upFrom=function(t){return t},StringMorph.prototype.downFrom=function(t){return t},StringMorph.prototype.startOfLine=function(){return 0},StringMorph.prototype.endOfLine=function(){return this.text.length},StringMorph.prototype.previousWordFrom=function(t){for(var e=t-1;0<e&&!isWordChar(this.text[e]);)--e;for(;0<e&&isWordChar(this.text[e-1]);)--e;return e},StringMorph.prototype.nextWordFrom=function(t){for(var e=t;e<this.endOfLine()&&!isWordChar(this.text[e]);)e+=1;for(;e<this.endOfLine()&&isWordChar(this.text[e]);)e+=1;return e},StringMorph.prototype.rawHeight=function(){return this.height()/1.2},StringMorph.prototype.developersMenu=function(){var t=StringMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("edit","edit"),t.addItem("font size...",function(){this.prompt(t.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,500,!0)},"set this String's\nfont point size"),"serif"!==this.fontStyle&&t.addItem("serif","setSerif"),"sans-serif"!==this.fontStyle&&t.addItem("sans-serif","setSansSerif"),this.isBold?t.addItem("normal weight","toggleWeight"):t.addItem("bold","toggleWeight"),this.isItalic?t.addItem("normal style","toggleItalic"):t.addItem("italic","toggleItalic"),this.isShowingBlanks?t.addItem("hide blanks","toggleShowBlanks"):t.addItem("show blanks","toggleShowBlanks"),this.isPassword?t.addItem("show characters","toggleIsPassword"):t.addItem("hide characters","toggleIsPassword"),t},StringMorph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable,this.isDraggable?this.disableSelecting():this.enableSelecting()},StringMorph.prototype.toggleShowBlanks=function(){this.isShowingBlanks=!this.isShowingBlanks,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.toggleWeight=function(){this.isBold=!this.isBold,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.toggleItalic=function(){this.isItalic=!this.isItalic,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.toggleIsPassword=function(){this.isPassword=!this.isPassword,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setSerif=function(){this.fontStyle="serif",this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setSansSerif=function(){this.fontStyle="sans-serif",this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setFontSize=function(t){var e;"number"==typeof t?this.fontSize=Math.round(Math.min(Math.max(t,4),500)):(e=parseFloat(t),isNaN(e)||(this.fontSize=Math.round(Math.min(Math.max(e,4),500)))),this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setText=function(t){this.text=Math.round(t).toString(),this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.numericalSetters=function(){return["setLeft","setTop","setAlphaScaled","setFontSize","setText"]},StringMorph.prototype.edit=function(){this.root().edit(this)},StringMorph.prototype.selection=function(){var t=Math.min(this.startMark,this.endMark),e=Math.max(this.startMark,this.endMark);return this.text.slice(t,e)},StringMorph.prototype.selectionStartSlot=function(){return Math.min(this.startMark,this.endMark)},StringMorph.prototype.clearSelection=function(){!this.currentlySelecting&&isNil(this.startMark)&&isNil(this.endMark)||(this.currentlySelecting=!1,this.startMark=null,this.endMark=null,this.drawNew(),this.changed())},StringMorph.prototype.deleteSelection=function(){var t=this.text,e=Math.min(this.startMark,this.endMark),o=Math.max(this.startMark,this.endMark);this.text=t.slice(0,e)+t.slice(o),this.changed(),this.clearSelection()},StringMorph.prototype.selectAll=function(){var t;this.isEditable&&(this.startMark=0,(t=this.root().cursor)&&t.gotoSlot(this.text.length),this.endMark=this.text.length,this.drawNew(),this.changed())},StringMorph.prototype.mouseDownLeft=function(t){16===this.world().currentKey?this.shiftClick(t):this.isEditable?this.clearSelection():this.escalateEvent("mouseDownLeft",t)},StringMorph.prototype.shiftClick=function(t){var e=this.root().cursor;e&&(this.startMark||(this.startMark=e.slot),e.gotoPos(t),this.endMark=e.slot,this.drawNew(),this.changed()),this.currentlySelecting=!1,this.escalateEvent("mouseDownLeft",t)},StringMorph.prototype.mouseClickLeft=function(t){var e;this.isEditable?(this.currentlySelecting||this.edit(),(e=this.root().cursor)&&e.gotoPos(t),this.currentlySelecting=!0):this.escalateEvent("mouseClickLeft",t)},StringMorph.prototype.mouseDoubleClick=function(t){var e=this.slotAt(t);this.isEditable?(this.edit(),e===this.text.length&&--e,this.text[e]&&isWordChar(this.text[e])?this.selectWordAt(e):this.text[e]?this.selectBetweenWordsAt(e):this.selectAll()):this.escalateEvent("mouseDoubleClick",t)},StringMorph.prototype.selectWordAt=function(t){var e=this.root().cursor;0===t||isWordChar(this.text[t-1])?(e.gotoSlot(this.previousWordFrom(t)),this.startMark=e.slot,this.endMark=this.nextWordFrom(e.slot)):(e.gotoSlot(t),this.startMark=t,this.endMark=this.nextWordFrom(t)),this.drawNew(),this.changed()},StringMorph.prototype.selectBetweenWordsAt=function(t){var e=this.root().cursor;for(e.gotoSlot(this.nextWordFrom(this.previousWordFrom(t))),this.startMark=e.slot,this.endMark=e.slot;this.endMark<this.text.length&&!isWordChar(this.text[this.endMark]);)this.endMark+=1;this.drawNew(),this.changed()},StringMorph.prototype.enableSelecting=function(){this.mouseDownLeft=function(t){var e=this.root().cursor,o=!!e&&e.target===this;16===this.world().currentKey?this.shiftClick(t):(this.clearSelection(),this.isEditable&&!this.isDraggable&&(this.edit(),this.root().cursor.gotoPos(t),this.startMark=this.slotAt(t),this.endMark=this.startMark,this.currentlySelecting=!0,o||this.escalateEvent("mouseDownLeft",t)))},this.mouseMove=function(t){var e;!this.isEditable||!this.currentlySelecting||this.isDraggable||(e=this.slotAt(t))!==this.endMark&&(this.endMark=e,this.drawNew(),this.changed())}},StringMorph.prototype.disableSelecting=function(){this.mouseDownLeft=StringMorph.prototype.mouseDownLeft,delete this.mouseMove},TextMorph.prototype=new Morph,TextMorph.prototype.constructor=TextMorph,TextMorph.uber=Morph.prototype,TextMorph.prototype.init=function(t,e,o,i,r,n,s,h,a,l){this.text=t||(""===t?t:"TextMorph"),this.words=[],this.lines=[],this.lineSlots=[],this.fontSize=e||12,this.fontName=h||MorphicPreferences.globalFontFamily,this.fontStyle=o||"sans-serif",this.isBold=i||!1,this.isItalic=r||!1,this.alignment=n||"left",this.shadowOffset=a||new Point(0,0),this.shadowColor=l||null,this.maxWidth=s||0,this.maxLineWidth=0,this.backgroundColor=null,this.isEditable=!1,this.receiver=null,this.isScrollable=!0,this.currentlySelecting=!1,this.startMark=0,this.endMark=0,this.markedTextColor=new Color(255,255,255),this.markedBackgoundColor=new Color(60,60,120),TextMorph.uber.init.call(this),this.color=new Color(0,0,0),this.noticesTransparentClick=!0,this.drawNew()},TextMorph.prototype.toString=function(){return'a TextMorph("'+this.text.slice(0,30)+'...")'},TextMorph.prototype.font=StringMorph.prototype.font,TextMorph.prototype.parse=function(){var e,o=this,t=this.text.split("\n"),i=newCanvas().getContext("2d"),r="",n=0;i.font=this.font(),this.maxLineWidth=0,this.lines=[],this.lineSlots=[0],this.words=[],t.forEach(function(t){o.words=o.words.concat(t.split(" ")),o.words.push("\n")}),this.words.forEach(function(t){"\n"===t?(o.lines.push(r),o.lineSlots.push(n),o.maxLineWidth=Math.max(o.maxLineWidth,i.measureText(r).width),r=""):(r=0<o.maxWidth?(e=r+t+" ",i.measureText(e).width>o.maxWidth?(o.lines.push(r),o.lineSlots.push(n),o.maxLineWidth=Math.max(o.maxLineWidth,i.measureText(r).width),t+" "):e):r+t+" ",n+=t.length+1)})},TextMorph.prototype.drawNew=function(){var t,e,o,i,r,n,s,h,a,l,p,c,u,d,g;if(this.image=newCanvas(),(t=this.image.getContext("2d")).font=this.font(),this.parse(),s=Math.abs(this.shadowOffset.x),n=Math.abs(this.shadowOffset.y),e=this.lines.length*(fontHeight(this.fontSize)+n),0===this.maxWidth?this.bounds=this.bounds.origin.extent(new Point(this.maxLineWidth+s,e)):this.bounds=this.bounds.origin.extent(new Point(this.maxWidth+s,e)),this.image.width=this.width(),this.image.height=this.height(),(t=this.image.getContext("2d")).font=this.font(),t.textAlign="left",t.textBaseline="bottom",this.backgroundColor&&(t.fillStyle=this.backgroundColor.toString(),t.fillRect(0,0,this.width(),this.height())),this.shadowColor)for(h=Math.max(this.shadowOffset.x,0),a=Math.max(this.shadowOffset.y,0),t.fillStyle=this.shadowColor.toString(),o=0;o<this.lines.length;o+=1)i=this.lines[o],r=t.measureText(i).width+s,l="right"===this.alignment?this.width()-r:"center"===this.alignment?(this.width()-r)/2:0,p=(o+1)*(fontHeight(this.fontSize)+n)-n,t.fillText(i,l+h,p+a);for(h=Math.abs(Math.min(this.shadowOffset.x,0)),a=Math.abs(Math.min(this.shadowOffset.y,0)),t.fillStyle=this.color.toString(),o=0;o<this.lines.length;o+=1)i=this.lines[o],r=t.measureText(i).width+s,l="right"===this.alignment?this.width()-r:"center"===this.alignment?(this.width()-r)/2:0,p=(o+1)*(fontHeight(this.fontSize)+n)-n,t.fillText(i,l+h,p+a);for(c=Math.min(this.startMark,this.endMark),u=Math.max(this.startMark,this.endMark),o=c;o<u;o+=1)d=this.slotPosition(o).subtract(this.position()),g=this.text.charAt(o),t.fillStyle=this.markedBackgoundColor.toString(),t.fillRect(d.x,d.y,t.measureText(g).width+1,fontHeight(this.fontSize)),t.fillStyle=this.markedTextColor.toString(),t.fillText(g,d.x,d.y+fontHeight(this.fontSize));this.parent&&this.parent.layoutChanged&&this.parent.layoutChanged()},TextMorph.prototype.setExtent=function(t){this.maxWidth=Math.max(t.x,0),this.changed(),this.drawNew()},TextMorph.prototype.columnRow=function(t){for(var e,o=0,i=0;i<this.lines.length;i+=1)for(o=this.lineSlots[i],e=0;e<this.lines[i].length;e+=1){if(o===t)return new Point(e,i);o+=1}return new Point(this.lines[this.lines.length-1].length-1,this.lines.length-1)},TextMorph.prototype.slotPosition=function(t){for(var e=this.columnRow(t),o=this.image.getContext("2d"),i=Math.abs(this.shadowOffset.y),r=0,n=e.y*(fontHeight(this.fontSize)+i),s=0;s<e.x;s+=1)r+=o.measureText(this.lines[e.y][s]).width;return new Point(this.left()+r,this.top()+n)},TextMorph.prototype.slotAt=function(t){for(var e=0,o=0,i=0,r=Math.abs(this.shadowOffset.y),n=this.image.getContext("2d");t.y-this.top()>(fontHeight(this.fontSize)+r)*o;)o+=1;for(o=Math.max(o,1);t.x-this.left()>e;)e+=n.measureText(this.lines[o-1][i]).width,i+=1;return t.x-this.left()>e-n.measureText(this.lines[o-1][i]).width/2?this.lineSlots[Math.max(o-1,0)]+i:this.lineSlots[Math.max(o-1,0)]+i-1},TextMorph.prototype.upFrom=function(t){var e,o=this.columnRow(t);return o.y<1?t:(e=this.lines[o.y-1]).length<o.x-1?this.lineSlots[o.y-1]+e.length:this.lineSlots[o.y-1]+o.x},TextMorph.prototype.downFrom=function(t){var e,o=this.columnRow(t);return o.y>this.lines.length-2?t:(e=this.lines[o.y+1]).length<o.x-1?this.lineSlots[o.y+1]+e.length:this.lineSlots[o.y+1]+o.x},TextMorph.prototype.startOfLine=function(t){return this.lineSlots[this.columnRow(t).y]},TextMorph.prototype.endOfLine=function(t){return this.startOfLine(t)+this.lines[this.columnRow(t).y].length-1},TextMorph.prototype.previousWordFrom=StringMorph.prototype.previousWordFrom,TextMorph.prototype.nextWordFrom=StringMorph.prototype.nextWordFrom,TextMorph.prototype.edit=StringMorph.prototype.edit,TextMorph.prototype.selection=StringMorph.prototype.selection,TextMorph.prototype.selectionStartSlot=StringMorph.prototype.selectionStartSlot,TextMorph.prototype.clearSelection=StringMorph.prototype.clearSelection,TextMorph.prototype.deleteSelection=StringMorph.prototype.deleteSelection,TextMorph.prototype.selectAll=StringMorph.prototype.selectAll,TextMorph.prototype.mouseDownLeft=StringMorph.prototype.mouseDownLeft,TextMorph.prototype.shiftClick=StringMorph.prototype.shiftClick,TextMorph.prototype.mouseClickLeft=StringMorph.prototype.mouseClickLeft,TextMorph.prototype.mouseDoubleClick=StringMorph.prototype.mouseDoubleClick,TextMorph.prototype.selectWordAt=StringMorph.prototype.selectWordAt,TextMorph.prototype.selectBetweenWordsAt=StringMorph.prototype.selectBetweenWordsAt,TextMorph.prototype.enableSelecting=StringMorph.prototype.enableSelecting,TextMorph.prototype.disableSelecting=StringMorph.prototype.disableSelecting,TextMorph.prototype.selectAllAndEdit=function(){this.edit(),this.selectAll()},TextMorph.prototype.developersMenu=function(){var t=TextMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("edit","edit"),t.addItem("font size...",function(){this.prompt(t.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,100,!0)},"set this Text's\nfont point size"),"left"!==this.alignment&&t.addItem("align left","setAlignmentToLeft"),"right"!==this.alignment&&t.addItem("align right","setAlignmentToRight"),"center"!==this.alignment&&t.addItem("align center","setAlignmentToCenter"),t.addLine(),"serif"!==this.fontStyle&&t.addItem("serif","setSerif"),"sans-serif"!==this.fontStyle&&t.addItem("sans-serif","setSansSerif"),this.isBold?t.addItem("normal weight","toggleWeight"):t.addItem("bold","toggleWeight"),this.isItalic?t.addItem("normal style","toggleItalic"):t.addItem("italic","toggleItalic"),t},TextMorph.prototype.setAlignmentToLeft=function(){this.alignment="left",this.drawNew(),this.changed()},TextMorph.prototype.setAlignmentToRight=function(){this.alignment="right",this.drawNew(),this.changed()},TextMorph.prototype.setAlignmentToCenter=function(){this.alignment="center",this.drawNew(),this.changed()},TextMorph.prototype.toggleIsDraggable=StringMorph.prototype.toggleIsDraggable,TextMorph.prototype.toggleWeight=StringMorph.prototype.toggleWeight,TextMorph.prototype.toggleItalic=StringMorph.prototype.toggleItalic,TextMorph.prototype.setSerif=StringMorph.prototype.setSerif,TextMorph.prototype.setSansSerif=StringMorph.prototype.setSansSerif,TextMorph.prototype.setText=StringMorph.prototype.setText,TextMorph.prototype.setFontSize=StringMorph.prototype.setFontSize,TextMorph.prototype.numericalSetters=StringMorph.prototype.numericalSetters,TextMorph.prototype.evaluationMenu=function(){var t=new MenuMorph(this,null);return t.addItem("do it","doIt","evaluate the\nselected expression"),t.addItem("show it","showIt","evaluate the\nselected expression\nand show the result"),t.addItem("inspect it","inspectIt","evaluate the\nselected expression\nand inspect the result"),t.addLine(),t.addItem("select all","selectAllAndEdit"),t},TextMorph.prototype.setReceiver=function(t){this.receiver=t,this.customContextMenu=this.evaluationMenu()},TextMorph.prototype.doIt=function(){this.receiver.evaluateString(this.selection()),this.edit()},TextMorph.prototype.showIt=function(){var t=this.receiver.evaluateString(this.selection());null!==t&&this.inform(t)},TextMorph.prototype.inspectIt=function(){var t,e=this.receiver.evaluateString(this.selection()),o=this.world();isObject(e)&&((t=new InspectorMorph(e)).setPosition(o.hand.position()),t.keepWithin(o),o.add(t),t.changed())},TriggerMorph.prototype=new Morph,TriggerMorph.prototype.constructor=TriggerMorph,TriggerMorph.uber=Morph.prototype,TriggerMorph.prototype.init=function(t,e,o,i,r,n,s,h,a,l,p){this.target=t||null,this.action=e||null,this.doubleClickAction=p||null,this.environment=n||null,this.labelString=o||null,this.label=null,this.hint=s||null,this.schedule=null,this.fontSize=i||MorphicPreferences.menuFontSize,this.fontStyle=r||"sans-serif",this.highlightColor=new Color(192,192,192),this.pressColor=new Color(128,128,128),this.labelColor=h||new Color(0,0,0),this.labelBold=a||!1,this.labelItalic=l||!1,TriggerMorph.uber.init.call(this),this.color=new Color(255,255,255),this.drawNew()},TriggerMorph.prototype.drawNew=function(){this.createBackgrounds(),null!==this.labelString&&this.createLabel()},TriggerMorph.prototype.createBackgrounds=function(){var t,e=this.extent();this.normalImage=newCanvas(e),(t=this.normalImage.getContext("2d")).fillStyle=this.color.toString(),t.fillRect(0,0,e.x,e.y),this.highlightImage=newCanvas(e),(t=this.highlightImage.getContext("2d")).fillStyle=this.highlightColor.toString(),t.fillRect(0,0,e.x,e.y),this.pressImage=newCanvas(e),(t=this.pressImage.getContext("2d")).fillStyle=this.pressColor.toString(),t.fillRect(0,0,e.x,e.y),this.image=this.normalImage},TriggerMorph.prototype.createLabel=function(){null!==this.label&&this.label.destroy(),this.label=new StringMorph(this.labelString,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic,!1,null,null,this.labelColor),this.label.setPosition(this.center().subtract(this.label.extent().floorDivideBy(2))),this.add(this.label)},TriggerMorph.prototype.trigger=function(){this.schedule&&(this.schedule.isActive=!1),"function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call(),this):this.target.call(this.environment,this.action,this):"function"==typeof this.action?this.action.call(this.target):this.target[this.action]()},TriggerMorph.prototype.triggerDoubleClick=function(){this.doubleClickAction&&(this.schedule&&(this.schedule.isActive=!1),"function"==typeof this.target?"function"==typeof this.doubleClickAction?this.target.call(this.environment,this.doubleClickAction.call(),this):this.target.call(this.environment,this.doubleClickAction,this):"function"==typeof this.doubleClickAction?this.doubleClickAction.call(this.target):this.target[this.doubleClickAction]())},TriggerMorph.prototype.mouseEnter=function(){var t=this.hint instanceof Function?this.hint():this.hint;this.image=this.highlightImage,this.changed(),t&&this.bubbleHelp(t)},TriggerMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed(),this.schedule&&(this.schedule.isActive=!1),this.hint&&this.world().hand.destroyTemporaries()},TriggerMorph.prototype.mouseDownLeft=function(){this.image=this.pressImage,this.changed()},TriggerMorph.prototype.mouseClickLeft=function(){this.image=this.highlightImage,this.changed(),this.trigger()},TriggerMorph.prototype.mouseDoubleClick=function(){this.triggerDoubleClick()},TriggerMorph.prototype.rootForGrab=function(){return this.isDraggable?TriggerMorph.uber.rootForGrab.call(this):null},TriggerMorph.prototype.bubbleHelp=function(t){var e=this.world(),o=this;this.schedule=new Animation(nop,nop,0,500,nop,function(){o.popUpbubbleHelp(t)}),e.animations.push(this.schedule)},TriggerMorph.prototype.popUpbubbleHelp=function(t){new SpeechBubbleMorph(localize(t),null,null,1).popUp(this.world(),this.rightCenter().add(new Point(-8,0)))},MenuItemMorph.prototype=new TriggerMorph,MenuItemMorph.prototype.constructor=MenuItemMorph,MenuItemMorph.uber=TriggerMorph.prototype,MenuItemMorph.prototype.createLabel=function(){var t,e;this.label&&this.label.destroy(),this.label=this.createLabelPart(this.labelString),this.add(this.label),t=this.label.width(),e=this.label.height(),this.shortcut&&this.shortcut.destroy(),this.shortcutString&&(this.shortcut=this.createLabelPart(this.shortcutString),t+=this.shortcut.width()+4,e=Math.max(e,this.shortcut.height()),this.add(this.shortcut)),this.silentSetExtent(new Point(t+8,e)),this.fixLayout()},MenuItemMorph.prototype.fixLayout=function(){var t=this.center();this.label.setCenter(t),this.label.setLeft(this.left()+4),this.shortcut&&(this.shortcut.setCenter(t),this.shortcut.setRight(this.right()-4))},MenuItemMorph.prototype.createLabelPart=function(t){var e,o,i;return isString(t)?this.createLabelString(t):t instanceof Array?((e=new Morph).alpha=0,o=this.createIcon(t[0]),e.add(o),i=this.createLabelString(t[1]),e.add(i),i.setCenter(o.center()),i.setLeft(o.right()+4),e.bounds=o.bounds.merge(i.bounds),e.drawNew(),e):this.createIcon(t)},MenuItemMorph.prototype.createIcon=function(t){var e,o=new Morph;return o.image=t instanceof Morph?t.fullImage():t,t instanceof Morph&&t.getShadow()&&(e=o.image,o.image=newCanvas(t.fullBounds().extent().subtract(this.shadowBlur*(useBlurredShadows?1:2))),o.image.getContext("2d").drawImage(e,0,0)),o.silentSetWidth(o.image.width),o.silentSetHeight(o.image.height),o},MenuItemMorph.prototype.createLabelString=function(t){var e=new TextMorph(t,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic);return e.setColor(this.labelColor),e},MenuItemMorph.prototype.mouseEnter=function(){var t=this.parentThatIsA(MenuMorph);this.isShowingSubmenu()||(t&&t.closeSubmenu(),this.isListItem()||(this.image=this.highlightImage,this.changed()),this.action instanceof MenuMorph?this.delaySubmenu():this.hint&&this.bubbleHelp(this.hint))},MenuItemMorph.prototype.mouseLeave=function(){this.isListItem()||(this.isShowingSubmenu()?this.image=this.highlightImage:this.image=this.normalImage,this.changed()),this.schedule&&(this.schedule.isActive=!1),this.hint&&this.world().hand.destroyTemporaries()},MenuItemMorph.prototype.mouseDownLeft=function(t){this.isListItem()&&(this.parentThatIsA(MenuMorph).unselectAllItems(),this.escalateEvent("mouseDownLeft",t)),this.image=this.pressImage,this.changed()},MenuItemMorph.prototype.mouseMove=function(){this.isListItem()&&this.escalateEvent("mouseMove")},MenuItemMorph.prototype.mouseClickLeft=function(){this.action instanceof MenuMorph?this.popUpSubmenu():(this.isListItem()||(this.parentThatIsA(MenuMorph).closeRootMenu(),this.world().activeMenu=null),this.trigger())},MenuItemMorph.prototype.isListItem=function(){var t=this.parentThatIsA(MenuMorph);return!!t&&t.isListContents},MenuItemMorph.prototype.isSelectedListItem=function(){return!!this.isListItem()&&this.image===this.pressImage},MenuItemMorph.prototype.isShowingSubmenu=function(){var t=this.parentThatIsA(MenuMorph);return!!(t&&this.action instanceof MenuMorph)&&t.submenu===this.action},MenuItemMorph.prototype.delaySubmenu=function(){var t=this.world(),e=this;this.schedule=new Animation(nop,nop,0,500,nop,function(){e.popUpSubmenu()}),t.animations.push(this.schedule)},MenuItemMorph.prototype.popUpSubmenu=function(){var t=this.parentThatIsA(MenuMorph);this.action instanceof MenuMorph&&(this.action.drawNew(),this.action.setPosition(this.topRight().subtract(new Point(0,5))),this.action.addShadow(new Point(2,2),80),this.action.keepWithin(this.world()),this.action.items.length<1&&!this.action.title||(t.add(this.action),t.submenu=this.action,t.submenu.world=t.world,this.action.fullChanged()))},FrameMorph.prototype=new Morph,FrameMorph.prototype.constructor=FrameMorph,FrameMorph.uber=Morph.prototype,FrameMorph.prototype.init=function(t){this.scrollFrame=t||null,FrameMorph.uber.init.call(this),this.color=new Color(255,250,245),this.drawNew(),this.acceptsDrops=!0,this.scrollFrame&&(this.isDraggable=!1,this.noticesTransparentClick=!1,this.alpha=0)},FrameMorph.prototype.fullBounds=function(){var t=this.getShadow();return null!==t?this.bounds.merge(t.bounds):this.bounds},FrameMorph.prototype.fullImage=function(){return this.image},FrameMorph.prototype.fullDrawOn=function(e,t){var o,i;return this.isVisible?(o=t||this.fullBounds(),(i=this.bounds.intersect(o)).extent().gt(new Point(0,0))?(this.drawOn(e,i),void this.children.forEach(function(t){t instanceof ShadowMorph?t.fullDrawOn(e,o):t.fullDrawOn(e,i)})):null):null},FrameMorph.prototype.topMorphAt=function(t){var e,o;if(!this.isVisible||!this.bounds.containsPoint(t))return null;for(e=this.children.length-1;0<=e;--e)if(o=this.children[e].topMorphAt(t))return o;return this.noticesTransparentClick||!this.isTransparentAt(t)?this:null},FrameMorph.prototype.submorphBounds=function(){var e=null;return 0<this.children.length&&(e=this.children[0].bounds,this.children.forEach(function(t){e=e.merge(t.fullBounds())})),e},FrameMorph.prototype.keepInScrollFrame=function(){if(null===this.scrollFrame)return null;this.left()>this.scrollFrame.left()&&this.moveBy(new Point(this.scrollFrame.left()-this.left(),0)),this.right()<this.scrollFrame.right()&&this.moveBy(new Point(this.scrollFrame.right()-this.right(),0)),this.top()>this.scrollFrame.top()&&this.moveBy(new Point(0,this.scrollFrame.top()-this.top())),this.bottom()<this.scrollFrame.bottom()&&this.moveBy(0,new Point(this.scrollFrame.bottom()-this.bottom(),0))},FrameMorph.prototype.adjustBounds=function(){var t,e,o=this;if(null===this.scrollFrame)return null;e=(t=this.submorphBounds())&&!this.scrollFrame.isTextLineWrapping?t.expandBy(this.scrollFrame.padding).growBy(this.scrollFrame.growth).merge(this.scrollFrame.bounds):this.scrollFrame.bounds.copy(),this.bounds.eq(e)||(this.bounds=e,this.drawNew(),this.keepInScrollFrame()),this.scrollFrame.isTextLineWrapping&&this.children.forEach(function(t){t instanceof TextMorph&&(t.setWidth(o.width()),o.setHeight(Math.max(t.height(),o.scrollFrame.height())))}),this.scrollFrame.adjustScrollBars()},FrameMorph.prototype.reactToDropOf=function(){this.adjustBounds()},FrameMorph.prototype.reactToGrabOf=function(){this.adjustBounds()},FrameMorph.prototype.developersMenu=function(){var t=FrameMorph.uber.developersMenu.call(this);return 0<this.children.length&&(t.addLine(),t.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible")),t},FrameMorph.prototype.keepAllSubmorphsWithin=function(){var e=this;this.children.forEach(function(t){t.keepWithin(e)})},ScrollFrameMorph.prototype=new FrameMorph,ScrollFrameMorph.prototype.constructor=ScrollFrameMorph,ScrollFrameMorph.uber=FrameMorph.prototype,ScrollFrameMorph.prototype.init=function(t,e,o){var i=this;ScrollFrameMorph.uber.init.call(this),this.scrollBarSize=e||MorphicPreferences.scrollBarSize,this.autoScrollTrigger=null,this.enableAutoScrolling=!0,this.isScrollingByDragging=!0,this.hasVelocity=!0,this.padding=0,this.growth=0,this.isTextLineWrapping=!1,this.contents=t||new FrameMorph(this),this.add(this.contents),this.hBar=new SliderMorph(null,null,null,null,"horizontal",o),this.hBar.setHeight(this.scrollBarSize),this.hBar.action=function(t){i.contents.setPosition(new Point(i.left()-t,i.contents.position().y))},this.hBar.isDraggable=!1,this.add(this.hBar),this.vBar=new SliderMorph(null,null,null,null,"vertical",o),this.vBar.setWidth(this.scrollBarSize),this.vBar.action=function(t){i.contents.setPosition(new Point(i.contents.position().x,i.top()-t))},this.vBar.isDraggable=!1,this.add(this.vBar),this.toolBar=null},ScrollFrameMorph.prototype.adjustScrollBars=function(){var t=this.width()-this.scrollBarSize,e=this.height()-this.scrollBarSize;this.changed(),this.contents.width()>this.width()+MorphicPreferences.scrollBarSize?(this.hBar.show(),this.hBar.width()!==t&&this.hBar.setWidth(t),this.hBar.setPosition(new Point(this.left(),this.bottom()-this.hBar.height())),this.hBar.start=0,this.hBar.stop=this.contents.width()-this.width(),this.hBar.size=this.width()/this.contents.width()*this.hBar.stop,this.hBar.value=this.left()-this.contents.left(),this.hBar.drawNew()):this.hBar.hide(),this.contents.height()>this.height()+this.scrollBarSize?(this.vBar.show(),this.vBar.height()!==e&&this.vBar.setHeight(e),this.vBar.setPosition(new Point(this.right()-this.vBar.width(),this.top())),this.vBar.start=0,this.vBar.stop=this.contents.height()-this.height(),this.vBar.size=this.height()/this.contents.height()*this.vBar.stop,this.vBar.value=this.top()-this.contents.top(),this.vBar.drawNew()):this.vBar.hide(),this.adjustToolBar()},ScrollFrameMorph.prototype.adjustToolBar=function(){this.toolBar&&(this.toolBar.setTop(this.top()+3),this.toolBar.setRight((this.vBar.isVisible?this.vBar.left():this.right())-3))},ScrollFrameMorph.prototype.addContents=function(t){this.contents.add(t),this.contents.adjustBounds()},ScrollFrameMorph.prototype.setContents=function(t){this.contents.children.forEach(function(t){t.destroy()}),this.contents.children=[],t.setPosition(this.position().add(this.padding+2)),this.addContents(t)},ScrollFrameMorph.prototype.setExtent=function(t){this.isTextLineWrapping&&this.contents.setPosition(this.position().copy()),ScrollFrameMorph.uber.setExtent.call(this,t),this.contents.adjustBounds()},ScrollFrameMorph.prototype.scrollX=function(t){var e=this.contents.left(),o=this.left(),i=this.contents.width(),r=this.right(),n=e+t;n+i<r&&(n=r-i),o<n&&(n=o),n!==e&&this.contents.setLeft(n)},ScrollFrameMorph.prototype.scrollY=function(t){var e=this.contents.top(),o=this.top(),i=this.contents.height(),r=this.bottom(),n=e+t;n+i<r&&(n=r-i),o<n&&(n=o),n!==e&&this.contents.setTop(n)},ScrollFrameMorph.prototype.step=nop,ScrollFrameMorph.prototype.mouseDownLeft=function(t){if(!this.isScrollingByDragging)return null;var e=this.root().hand,o=t,i=this,r=0,n=0;this.step=function(){var t;if(e.mouseButton&&0===e.children.length&&i.bounds.containsPoint(e.bounds.origin)){if(e.grabPosition&&e.grabPosition.distanceTo(e.position())<=MorphicPreferences.grabThreshold)return null;t=e.bounds.origin,0!==(r=t.x-o.x)&&i.scrollX(r),0!==(n=t.y-o.y)&&i.scrollY(n),o=t}else!i.hasVelocity||Math.abs(r)<.5&&Math.abs(n)<.5?i.step=function(){nop()}:(r*=.8,i.scrollX(Math.round(r)),n*=.8,i.scrollY(Math.round(n)));this.adjustScrollBars()}},ScrollFrameMorph.prototype.startAutoScrolling=function(){var t,e,o,i=this,r=3*MorphicPreferences.scrollBarSize,n=this.world();if(!n)return null;t=n.hand,this.autoScrollTrigger||(this.autoScrollTrigger=Date.now()),this.step=function(){o=t.bounds.origin,e=i.bounds.insetBy(r),i.bounds.containsPoint(o)&&!e.containsPoint(o)&&0<t.children.length?i.autoScroll(o):(i.step=function(){nop()},i.autoScrollTrigger=null)}},ScrollFrameMorph.prototype.autoScroll=function(t){var e;if(Date.now()-this.autoScrollTrigger<500)return null;e=3*MorphicPreferences.scrollBarSize,this.topLeft().extent(new Point(this.width(),e)).containsPoint(t)&&this.scrollY(e-(t.y-this.top())),this.topLeft().extent(new Point(e,this.height())).containsPoint(t)&&this.scrollX(e-(t.x-this.left())),new Point(this.right()-e,this.top()).extent(new Point(e,this.height())).containsPoint(t)&&this.scrollX(-(e-(this.right()-t.x))),new Point(this.left(),this.bottom()-e).extent(new Point(this.width(),e)).containsPoint(t)&&this.scrollY(-(e-(this.bottom()-t.y))),this.adjustScrollBars()},ScrollFrameMorph.prototype.scrollCursorIntoView=function(t){var e=t.target,o=e.position().subtract(this.contents.position()),i=this.top()+this.padding,r=this.bottom()-this.padding;this.contents.setExtent(e.extent().add(o).add(this.padding)),t.top()<i?(this.contents.setTop(this.contents.top()+i-t.top()),t.setTop(i)):t.bottom()>r&&(this.contents.setBottom(this.contents.bottom()+r-t.bottom()),t.setBottom(r)),this.adjustScrollBars()},ScrollFrameMorph.prototype.mouseScroll=function(t,e){t&&this.scrollY(t*MorphicPreferences.mouseScrollAmount),e&&this.scrollX(e*MorphicPreferences.mouseScrollAmount),this.adjustScrollBars()},ScrollFrameMorph.prototype.updateReferences=function(t){var e=this;ScrollFrameMorph.uber.updateReferences.call(this,t),this.hBar&&(this.hBar.action=function(t){e.contents.setPosition(new Point(e.left()-t,e.contents.position().y))}),this.vBar&&(this.vBar.action=function(t){e.contents.setPosition(new Point(e.contents.position().x,e.top()-t))})},ScrollFrameMorph.prototype.developersMenu=function(){var t=ScrollFrameMorph.uber.developersMenu.call(this);return this.isTextLineWrapping?t.addItem("auto line wrap off...","toggleTextLineWrapping","turn automatic\nline wrapping\noff"):t.addItem("auto line wrap on...","toggleTextLineWrapping","enable automatic\nline wrapping"),t},ScrollFrameMorph.prototype.toggleTextLineWrapping=function(){this.isTextLineWrapping=!this.isTextLineWrapping},ListMorph.prototype=new ScrollFrameMorph,ListMorph.prototype.constructor=ListMorph,ListMorph.uber=ScrollFrameMorph.prototype,ListMorph.prototype.init=function(t,e,o,i){ListMorph.uber.init.call(this),this.contents.acceptsDrops=!1,this.color=new Color(255,255,255),this.hBar.alpha=.6,this.vBar.alpha=.6,this.elements=t||[],this.labelGetter=e,this.format=o,this.listContents=null,this.selected=null,this.active=null,this.action=null,this.doubleClickAction=i||null,this.acceptsDrops=!1,this.buildListContents()},ListMorph.prototype.buildListContents=function(){var t=this;this.listContents&&this.listContents.destroy(),this.listContents=new MenuMorph(this.select,null,this),0===this.elements.length&&(this.elements=["(empty)"]),this.elements.forEach(function(e){var o=null,i=!1,r=!1;t.format.forEach(function(t){t[1].call(null,e)&&("bold"===t[0]?i=!0:"italic"===t[0]?r=!0:o=t[0])}),t.listContents.addItem(t.labelGetter(e),e,null,o,i,r,t.doubleClickAction)}),this.listContents.isListContents=!0,this.listContents.drawNew(),this.listContents.setPosition(this.contents.position()),this.addContents(this.listContents)},ListMorph.prototype.select=function(t,e){isNil(t)||(this.selected=t,this.active=e,this.action&&this.action.call(null,t))},ListMorph.prototype.setExtent=function(t){var e=this.listContents.bounds,o=this.bounds.origin.copy().corner(this.bounds.origin.add(t));o.right()>e.right()&&o.width()<=e.width()&&this.listContents.setRight(o.right()),o.bottom()>e.bottom()&&o.height()<=e.height()&&this.listContents.setBottom(o.bottom()),ListMorph.uber.setExtent.call(this,t)},ListMorph.prototype.activeIndex=function(){return this.listContents.children.indexOf(this.active)},ListMorph.prototype.activateIndex=function(t){var e=this.listContents.children[t];e&&(e.image=e.pressImage,e.changed(),e.trigger())},StringFieldMorph.prototype=new FrameMorph,StringFieldMorph.prototype.constructor=StringFieldMorph,StringFieldMorph.uber=FrameMorph.prototype,StringFieldMorph.prototype.init=function(t,e,o,i,r,n,s){this.defaultContents=t,this.minWidth=e,this.fontSize=o,this.fontStyle=i,this.isBold=r,this.isItalic=n,this.isNumeric=s||!1,this.text=null,StringFieldMorph.uber.init.call(this),this.color=new Color(255,255,255),this.isEditable=!0,this.acceptsDrops=!1,this.drawNew()},StringFieldMorph.prototype.drawNew=function(){var t=this.text?this.string():this.defaultContents;this.text=null,this.children.forEach(function(t){t.destroy()}),this.children=[],this.text=new StringMorph(t,this.fontSize,this.fontStyle,this.isBold,this.isItalic,this.isNumeric),this.text.isNumeric=this.isNumeric,this.text.setPosition(this.bounds.origin.copy()),this.text.isEditable=this.isEditable,this.text.isDraggable=!1,this.text.enableSelecting(),this.silentSetExtent(new Point(Math.max(this.width(),this.minWidth),this.text.height())),StringFieldMorph.uber.drawNew.call(this),this.add(this.text)},StringFieldMorph.prototype.string=function(){return this.text.text},StringFieldMorph.prototype.mouseClickLeft=function(t){this.isEditable?this.text.edit():this.escalateEvent("mouseClickLeft",t)},BouncerMorph.prototype=new Morph,BouncerMorph.prototype.constructor=BouncerMorph,BouncerMorph.uber=Morph.prototype,BouncerMorph.prototype.init=function(t,e){BouncerMorph.uber.init.call(this),this.fps=50,this.isStopped=!1,this.type=t||"vertical","vertical"===this.type?this.direction="down":this.direction="right",this.speed=e||1},BouncerMorph.prototype.moveUp=function(){this.moveBy(new Point(0,-this.speed))},BouncerMorph.prototype.moveDown=function(){this.moveBy(new Point(0,this.speed))},BouncerMorph.prototype.moveRight=function(){this.moveBy(new Point(this.speed,0))},BouncerMorph.prototype.moveLeft=function(){this.moveBy(new Point(-this.speed,0))},BouncerMorph.prototype.step=function(){this.isStopped||("vertical"===this.type?("down"===this.direction?this.moveDown():this.moveUp(),this.fullBounds().top()<this.parent.top()&&"up"===this.direction&&(this.direction="down"),this.fullBounds().bottom()>this.parent.bottom()&&"down"===this.direction&&(this.direction="up")):"horizontal"===this.type&&("right"===this.direction?this.moveRight():this.moveLeft(),this.fullBounds().left()<this.parent.left()&&"left"===this.direction&&(this.direction="right"),this.fullBounds().right()>this.parent.right()&&"right"===this.direction&&(this.direction="left")))},HandMorph.prototype=new Morph,HandMorph.prototype.constructor=HandMorph,HandMorph.uber=Morph.prototype,HandMorph.prototype.init=function(t){HandMorph.uber.init.call(this,!0),this.bounds=new Rectangle,this.world=t,this.mouseButton=null,this.mouseOverList=[],this.morphToGrab=null,this.grabPosition=null,this.grabOrigin=null,this.temporaries=[],this.touchHoldTimeout=null,this.contextMenuEnabled=!1},HandMorph.prototype.changed=function(){var t;null!==this.world&&((t=this.fullBounds()).extent().eq(new Point)||this.world.broken.push(t.spread()))},HandMorph.prototype.fullChanged=HandMorph.prototype.changed,HandMorph.prototype.morphAtPointer=function(){return this.world.topMorphAt(this.bounds.origin)||this.world},HandMorph.prototype.allMorphsAtPointer=function(){var t=this.world.allChildren(),e=this;return t.filter(function(t){return t.isVisible&&t.visibleBounds().containsPoint(e.bounds.origin)})},HandMorph.prototype.dropTargetFor=function(t){for(var e=this.morphAtPointer();!e.wantsDropOf(t);)e=e.parent;return e},HandMorph.prototype.grab=function(t){var e=t.parent;if(t instanceof WorldMorph)return null;0===this.children.length&&(this.world.stopEditing(),this.grabOrigin=t.situation(),t instanceof MenuMorph||t.addShadow(),t.prepareToBeGrabbed&&t.prepareToBeGrabbed(this),t.cachedFullImage=t.fullImageClassic(),t.cachedFullBounds=t.fullBounds(),this.add(t),this.changed(),e&&e.reactToGrabOf&&e.reactToGrabOf(t))},HandMorph.prototype.drop=function(){var t,e;0!==this.children.length&&(e=this.children[0],t=(t=this.dropTargetFor(e)).selectForEdit?t.selectForEdit():t,this.changed(),t.add(e),e.cachedFullImage=null,e.cachedFullBounds=null,e.changed(),e instanceof MenuMorph||e.removeShadow(),this.children=[],this.setExtent(new Point),e.justDropped&&e.justDropped(this),t.reactToDropOf&&t.reactToDropOf(e,this))},HandMorph.prototype.processMouseDown=function(t){var e,o;if(this.destroyTemporaries(),this.contextMenuEnabled=!0,this.morphToGrab=null,this.grabPosition=null,0!==this.children.length)this.drop(),this.mouseButton=null;else{for(e=this.morphAtPointer(),this.world.activeMenu&&(contains(e.allParents(),this.world.activeMenu)?clearInterval(this.touchHoldTimeout):this.world.activeMenu.destroy()),this.world.activeHandle&&e!==this.world.activeHandle&&this.world.activeHandle.destroy(),this.world.cursor&&e!==this.world.cursor.target&&this.world.stopEditing(),e.mouseMove||(this.morphToGrab=e.rootForGrab(),this.grabPosition=this.bounds.origin.copy()),o=2===t.button||t.ctrlKey?(this.mouseButton="right","mouseDownRight"):(this.mouseButton="left","mouseDownLeft");!e[o];)e=e.parent;e[o](this.bounds.origin)}},HandMorph.prototype.processTouchStart=function(t){var e=this;MorphicPreferences.isTouchDevice=!0,clearInterval(this.touchHoldTimeout),1===t.touches.length&&(this.touchHoldTimeout=setInterval(function(){e.processMouseDown({button:2}),e.processMouseUp({button:2}),t.preventDefault(),clearInterval(e.touchHoldTimeout)},400),this.processMouseMove(t.touches[0]),this.processMouseDown({button:0}),t.preventDefault())},HandMorph.prototype.processTouchMove=function(t){var e;MorphicPreferences.isTouchDevice=!0,1===t.touches.length&&(e=t.touches[0],this.processMouseMove(e),clearInterval(this.touchHoldTimeout))},HandMorph.prototype.processTouchEnd=function(t){MorphicPreferences.isTouchDevice=!0,clearInterval(this.touchHoldTimeout),nop(t),this.processMouseUp({button:0})},HandMorph.prototype.processMouseUp=function(){var t,e,o,i=this.morphAtPointer();if(this.destroyTemporaries(),0!==this.children.length)this.drop();else{if("left"===this.mouseButton)o="mouseClickLeft";else if(o="mouseClickRight",this.mouseButton&&this.contextMenuEnabled){for(e=(t=i).contextMenu();!e&&t.parent;)e=(t=t.parent).contextMenu();e&&e.popUpAtHand(this.world)}for(;!i[o];)i=i.parent;i[o](this.bounds.origin)}this.mouseButton=null},HandMorph.prototype.processDoubleClick=function(){var t=this.morphAtPointer();if(this.destroyTemporaries(),0!==this.children.length)this.drop();else{for(;t&&!t.mouseDoubleClick;)t=t.parent;t&&t.mouseDoubleClick(this.bounds.origin)}this.mouseButton=null},HandMorph.prototype.processMouseMove=function(t){var e,o,i,r=getDocumentPositionOf(this.world.worldCanvas),n=this,s=new Point(t.pageX-r.x,t.pageY-r.y);this.setPosition(s),e=this.morphAtPointer().allParents(),!this.children.length&&this.mouseButton&&(o=(i=this.morphAtPointer()).rootForGrab(),i.mouseMove&&(i.mouseMove(s,this.mouseButton),"right"===this.mouseButton&&(this.contextMenuEnabled=!1)),"left"===this.mouseButton&&this.morphToGrab&&this.grabPosition.distanceTo(this.bounds.origin)>MorphicPreferences.grabThreshold&&(this.setPosition(this.grabPosition),this.morphToGrab.isDraggable?(o=this.morphToGrab.selectForEdit?this.morphToGrab.selectForEdit():this.morphToGrab,this.grab(o)):this.morphToGrab.isTemplate&&(this.world.stopEditing(),(o=this.morphToGrab.fullCopy()).isTemplate=!1,o.isDraggable=!0,o.reactToTemplateCopy&&o.reactToTemplateCopy(),this.grab(o),this.grabOrigin=this.morphToGrab.situation()),this.setPosition(s))),this.mouseOverList.forEach(function(t){contains(e,t)||(t.mouseLeave&&t.mouseLeave(),t.mouseLeaveDragging&&n.mouseButton&&t.mouseLeaveDragging())}),e.forEach(function(t){contains(n.mouseOverList,t)||(t.mouseEnter&&t.mouseEnter(),t.mouseEnterDragging&&n.mouseButton&&t.mouseEnterDragging()),0<n.children.length&&t instanceof ScrollFrameMorph&&t.enableAutoScrolling&&t.contents.allChildren().some(function(t){return t.wantsDropOf(n.children[0])})&&(t.bounds.insetBy(3*MorphicPreferences.scrollBarSize).containsPoint(n.bounds.origin)||t.startAutoScrolling())}),this.mouseOverList=e},HandMorph.prototype.processMouseScroll=function(t){for(var e=this.morphAtPointer();e&&!e.mouseScroll;)e=e.parent;e&&e.mouseScroll(t.detail/-3||(Object.prototype.hasOwnProperty.call(t,"wheelDeltaY")?t.wheelDeltaY/120:t.wheelDelta/120),t.wheelDeltaX/120||0)},HandMorph.prototype.processDrop=function(t){var e,o,i,r,n,s,h,a,l=t instanceof FileList?t:t.target.files||t.dataTransfer.files,p=t.dataTransfer?t.dataTransfer.getData("URL"):null,c=t.dataTransfer?t.dataTransfer.getData("Text/HTML"):null,u=this.morphAtPointer(),d=new Image;if(0<l.length)for(n=0;n<l.length;n+=1)o=(e=l[n]).name.slice(e.name.lastIndexOf(".")+1).toLowerCase(),(-1===e.type.indexOf("svg")||MorphicPreferences.rasterizeSVGs?0===e.type.indexOf("image")?function(t){for(var e=new Image,o=new FileReader;!u.droppedImage;)u=u.parent;e.onload=function(){(r=newCanvas(new Point(e.width,e.height),!0)).getContext("2d").drawImage(e,0,0),u.droppedImage(r,t.name)},(o=new FileReader).onloadend=function(t){e.src=t.target.result},o.readAsDataURL(t)}:0===e.type.indexOf("audio")?function(e){for(var o=new Audio,t=new FileReader;!u.droppedAudio;)u=u.parent;t.onloadend=function(t){o.src=t.target.result,u.droppedAudio(o,e.name)},t.readAsDataURL(e)}:0===e.type.indexOf("text")||contains(["txt","csv","json"],o)?function(e){for(var t=new FileReader;!u.droppedText;)u=u.parent;t.onloadend=function(t){u.droppedText(t.target.result,e.name,e.type)},t.readAsText(e)}:function(e){for(var t=new FileReader;!u.droppedBinary;)u=u.parent;t.onloadend=function(t){u.droppedBinary(t.target.result,e.name)},t.readAsArrayBuffer(e)}:function(t){for(var e=new Image,o=new FileReader;!u.droppedSVG;)u=u.parent;e.onload=function(){u.droppedSVG(e,t.name)},(o=new FileReader).onloadend=function(t){e.src=t.target.result},o.readAsDataURL(t)})(e);else if(p){if(contains(["gif","png","jpg","jpeg","bmp"],o=p.slice(p.lastIndexOf(".")+1).toLowerCase())){for(;!u.droppedImage;)u=u.parent;(d=new Image).onload=function(){(r=newCanvas(new Point(d.width,d.height),!0)).getContext("2d").drawImage(d,0,0),u.droppedImage(r)},d.src=p}else if("svg"===o&&!MorphicPreferences.rasterizeSVGs){for(;!u.droppedSVG;)u=u.parent;s=p,h=function(t){var e=new Image;e.onload=function(){u.droppedSVG(e,p.slice(p.lastIndexOf("/")+1,p.lastIndexOf(".")))},e.src="data:image/svg+xml;utf8,"+encodeURIComponent(t)},(a=new XMLHttpRequest).open("GET",s),a.onreadystatechange=function(){if(4===a.readyState){if(!a.responseText)throw new Error("unable to retrieve "+s);h(a.responseText)}},a.send()}}else if(c){for(;!u.droppedImage;)u=u.parent;(d=new Image).onload=function(){(r=newCanvas(new Point(d.width,d.height),!0)).getContext("2d").drawImage(d,0,0),u.droppedImage(r)},(i=function(t){var e,o,i="",r=t.indexOf('<img src="');if(-1===r)return null;for(e=r+=10;e<t.length;e+=1){if('"'===(o=t[e]))return i;i=i.concat(o)}return null}(c))&&(d.src=i)}},HandMorph.prototype.destroyTemporaries=function(){var e=this;this.temporaries.forEach(function(t){t.isClickable&&t.bounds.containsPoint(e.position())||(t.destroy(),e.temporaries.splice(e.temporaries.indexOf(t),1))})},WorldMorph.prototype=new FrameMorph,WorldMorph.prototype.constructor=WorldMorph,WorldMorph.uber=FrameMorph.prototype,WorldMorph.prototype.init=function(t,e){for(WorldMorph.uber.init.call(this),this.color=new Color(205,205,205),this.alpha=1,this.bounds=new Rectangle(0,0,t.width,t.height),this.drawNew(),this.isVisible=!0,this.isDraggable=!1,this.currentKey=null,this.worldCanvas=t,this.noticesTransparentClick=!0,this.stamp=Date.now();this.stamp===Date.now();)nop();this.stamp=Date.now(),this.useFillPage=e,void 0===this.useFillPage&&(this.useFillPage=!0),this.isDevMode=!1,this.broken=[],this.animations=[],this.hand=new HandMorph(this),this.keyboardReceiver=null,this.cursor=null,this.lastEditedText=null,this.activeMenu=null,this.activeHandle=null,this.virtualKeyboard=null,this.initEventListeners()},WorldMorph.prototype.brokenFor=function(t){var e=t.fullBounds();return this.broken.filter(function(t){return t.intersects(e)})},WorldMorph.prototype.fullDrawOn=function(t,e){WorldMorph.uber.fullDrawOn.call(this,t,e),this.hand.fullDrawOn(t,e)},WorldMorph.prototype.updateBroken=function(){var e=this;this.condenseDamages(),this.broken.forEach(function(t){t.extent().gt(new Point(0,0))&&e.fullDrawOn(e.worldCanvas,t)}),this.broken=[]},WorldMorph.prototype.stepAnimations=function(){this.animations.forEach(function(t){t.step()}),this.animations=this.animations.filter(function(t){return t.isActive})},WorldMorph.prototype.condenseDamages=function(){for(var t=!0,e=this.broken.length;t;)this.broken=function(t){var o,i=[];return t.forEach(function(e){(o=detect(i,function(t){return t.isNearTo(e,20)}))?o.mergeWith(e):i.push(e)}),i}(this.broken),t=this.broken.length<e,e=this.broken.length},WorldMorph.prototype.doOneCycle=function(){this.stepFrame(),this.stepAnimations(),this.updateBroken()},WorldMorph.prototype.fillPage=function(){var t=window.innerHeight,e=window.innerWidth,o=this;this.worldCanvas.style.position="absolute",this.worldCanvas.style.left="0px",this.worldCanvas.style.right="0px",this.worldCanvas.style.width="100%",this.worldCanvas.style.height="100%",document.documentElement.scrollTop&&(t=document.documentElement.clientHeight),document.documentElement.scrollLeft&&(e=document.documentElement.clientWidth),this.worldCanvas.width!==e&&(this.worldCanvas.width=e,this.setWidth(e)),this.worldCanvas.height!==t&&(this.worldCanvas.height=t,this.setHeight(t)),this.children.forEach(function(t){t.reactToWorldResize&&t.reactToWorldResize(o.bounds.copy())})},WorldMorph.prototype.getGlobalPixelColor=function(t){return this.topMorphAt(t).getPixelColor(t)},WorldMorph.prototype.initVirtualKeyboard=function(){var e=this;this.virtualKeyboard&&(document.body.removeChild(this.virtualKeyboard),this.virtualKeyboard=null),MorphicPreferences.isTouchDevice&&MorphicPreferences.useVirtualKeyboard&&(this.virtualKeyboard=document.createElement("input"),this.virtualKeyboard.type="text",this.virtualKeyboard.style.color="transparent",this.virtualKeyboard.style.backgroundColor="transparent",this.virtualKeyboard.style.border="none",this.virtualKeyboard.style.outline="none",this.virtualKeyboard.style.position="absolute",this.virtualKeyboard.style.top="0px",this.virtualKeyboard.style.left="0px",this.virtualKeyboard.style.width="0px",this.virtualKeyboard.style.height="0px",this.virtualKeyboard.autocapitalize="none",document.body.appendChild(this.virtualKeyboard),this.virtualKeyboard.addEventListener("keydown",function(t){e.currentKey=t.keyCode,e.keyboardReceiver&&e.keyboardReceiver.processKeyDown(t),8===t.keyCode&&t.preventDefault(),9===t.keyCode&&(e.keyboardReceiver&&e.keyboardReceiver.processKeyPress(t),t.preventDefault())},!1),this.virtualKeyboard.addEventListener("keyup",function(t){e.currentKey=null,e.keyboardReceiver&&e.keyboardReceiver.processKeyUp&&e.keyboardReceiver.processKeyUp(t),t.preventDefault()},!1),this.virtualKeyboard.addEventListener("keypress",function(t){e.keyboardReceiver&&e.keyboardReceiver.processKeyPress(t),t.preventDefault()},!1))},WorldMorph.prototype.initEventListeners=function(){var e=this.worldCanvas,o=this;o.useFillPage?o.fillPage():this.changed(),e.addEventListener("mousedown",function(t){t.preventDefault(),e.focus(),o.hand.processMouseDown(t)},!1),e.addEventListener("touchstart",function(t){o.hand.processTouchStart(t)},!1),e.addEventListener("mouseup",function(t){t.preventDefault(),o.hand.processMouseUp(t)},!1),e.addEventListener("dblclick",function(t){t.preventDefault(),o.hand.processDoubleClick(t)},!1),e.addEventListener("touchend",function(t){o.hand.processTouchEnd(t)},!1),e.addEventListener("mousemove",function(t){o.hand.processMouseMove(t)},!1),e.addEventListener("touchmove",function(t){o.hand.processTouchMove(t)},!1),e.addEventListener("contextmenu",function(t){t.preventDefault()},!1),e.addEventListener("keydown",function(t){o.currentKey=t.keyCode,o.keyboardReceiver&&o.keyboardReceiver.processKeyDown(t),8===t.keyCode&&t.preventDefault(),9===t.keyCode&&(o.keyboardReceiver&&o.keyboardReceiver.processKeyPress(t),t.preventDefault()),(t.ctrlKey&&!t.altKey||t.metaKey)&&86!==t.keyCode&&t.preventDefault()},!1),e.addEventListener("keyup",function(t){o.currentKey=null,o.keyboardReceiver&&o.keyboardReceiver.processKeyUp&&o.keyboardReceiver.processKeyUp(t),t.preventDefault()},!1),e.addEventListener("keypress",function(t){o.keyboardReceiver&&o.keyboardReceiver.processKeyPress(t),t.preventDefault()},!1),e.addEventListener("mousewheel",function(t){o.hand.processMouseScroll(t),t.preventDefault()},!1),e.addEventListener("DOMMouseScroll",function(t){o.hand.processMouseScroll(t),t.preventDefault()},!1),document.body.addEventListener("paste",function(t){var e=t.clipboardData.getData("Text");e&&o.cursor&&o.cursor.insert(e)},!1),window.addEventListener("dragover",function(t){t.preventDefault()},!1),window.addEventListener("drop",function(t){o.hand.processDrop(t),t.preventDefault()},!1),window.addEventListener("resize",function(){o.useFillPage&&o.fillPage()},!1),window.onbeforeunload=function(t){var e=t||window.event,o="Are you sure you want to leave?";return e&&(e.returnValue=o),o}},WorldMorph.prototype.mouseDownLeft=nop,WorldMorph.prototype.mouseClickLeft=nop,WorldMorph.prototype.mouseDownRight=nop,WorldMorph.prototype.mouseClickRight=nop,WorldMorph.prototype.wantsDropOf=function(){return this.acceptsDrops},WorldMorph.prototype.droppedImage=function(){return null},WorldMorph.prototype.droppedSVG=function(){return null},WorldMorph.prototype.nextTab=function(t){var e=this.nextEntryField(t);e&&(t.clearSelection(),e.selectAll(),e.edit())},WorldMorph.prototype.previousTab=function(t){var e=this.previousEntryField(t);e&&(t.clearSelection(),e.selectAll(),e.edit())},WorldMorph.prototype.contextMenu=function(){var t=this.isDevMode?new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]):new MenuMorph(this,"Morphic");return this.isDevMode&&(t.addItem("demo...","userCreateMorph","sample morphs"),t.addLine(),t.addItem("hide all...","hideAll"),t.addItem("show all...","showAllHiddens"),t.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible"),t.addItem("inspect...","inspect","open a window on\nall properties"),t.addItem("screenshot...",function(){window.open(this.fullImageClassic().toDataURL())},"open a new window\nwith a picture of this morph"),t.addLine(),t.addItem("restore display","changed","redraw the\nscreen once"),t.addItem("fill page...","fillPage","let the World automatically\nadjust to browser resizing"),useBlurredShadows?t.addItem("sharp shadows...","toggleBlurredShadows","sharp drop shadows\nuse for old browsers"):t.addItem("blurred shadows...","toggleBlurredShadows","blurry shades,\n use for new browsers"),t.addItem("color...",function(){this.pickColor(t.title+localize("\ncolor:"),this.setColor,this,this.color)},"choose the World's\nbackground color"),MorphicPreferences===standardSettings?t.addItem("touch screen settings","togglePreferences","bigger menu fonts\nand sliders"):t.addItem("standard settings","togglePreferences","smaller menu fonts\nand sliders"),t.addLine()),this.isDevMode?t.addItem("user mode...","toggleDevMode","disable developers'\ncontext menus"):t.addItem("development mode...","toggleDevMode"),t.addItem("about morphic.js...","about"),t},WorldMorph.prototype.userCreateMorph=function(){var e,t,o=this;function n(t){t.isDraggable=!0,t.pickUp(o)}(e=new MenuMorph(this,"make a morph")).addItem("rectangle",function(){n(new Morph)}),e.addItem("box",function(){n(new BoxMorph)}),e.addItem("circle box",function(){n(new CircleBoxMorph)}),e.addLine(),e.addItem("slider",function(){n(new SliderMorph)}),e.addItem("dial",function(){(t=new DialMorph).pickUp(this)}),e.addItem("frame",function(){(t=new FrameMorph).setExtent(new Point(350,250)),n(t)}),e.addItem("scroll frame",function(){(t=new ScrollFrameMorph).contents.acceptsDrops=!0,t.contents.adjustBounds(),t.setExtent(new Point(350,250)),n(t)}),e.addItem("handle",function(){n(new HandleMorph)}),e.addLine(),e.addItem("string",function(){(t=new StringMorph("Hello, World!")).isEditable=!0,n(t)}),e.addItem("text",function(){(t=new TextMorph("Ich weiß nicht, was soll es bedeuten, dass ich so traurig bin, ein Märchen aus uralten Zeiten, das kommt mir nicht aus dem Sinn. Die Luft ist kühl und es dunkelt, und ruhig fließt der Rhein; der Gipfel des Berges funkelt im Abendsonnenschein. Die schönste Jungfrau sitzet dort oben wunderbar, ihr gold'nes Geschmeide blitzet, sie kämmt ihr goldenes Haar, sie kämmt es mit goldenem Kamme, und singt ein Lied dabei; das hat eine wundersame, gewalt'ge Melodei. Den Schiffer im kleinen Schiffe, ergreift es mit wildem Weh; er schaut nicht die Felsenriffe, er schaut nur hinauf in die Höh'. Ich glaube, die Wellen verschlingen am Ende Schiffer und Kahn, und das hat mit ihrem Singen, die Loreley getan.")).isEditable=!0,t.maxWidth=300,t.drawNew(),n(t)}),e.addItem("speech bubble",function(){n(t=new SpeechBubbleMorph("Hello, World!"))}),e.addLine(),e.addItem("gray scale palette",function(){n(new GrayPaletteMorph)}),e.addItem("color palette",function(){n(new ColorPaletteMorph)}),e.addItem("color picker",function(){n(new ColorPickerMorph)}),e.addLine(),e.addItem("sensor demo",function(){(t=new MouseSensorMorph).setColor(new Color(230,200,100)),t.edge=35,t.border=15,t.borderColor=new Color(200,100,50),t.alpha=.2,t.setExtent(new Point(100,100)),n(t)}),e.addItem("animation demo",function(){var t,e,o,i,r=new BouncerMorph;r.setPosition(new Point(50,20)),r.setExtent(new Point(300,200)),r.alpha=.9,r.speed=3,(t=new BouncerMorph).setColor(new Color(50,50,50)),t.setPosition(new Point(80,80)),t.setExtent(new Point(80,250)),t.type="horizontal",t.direction="right",t.alpha=.9,t.speed=5,(e=new BouncerMorph).setColor(new Color(20,20,20)),e.setPosition(new Point(90,140)),e.setExtent(new Point(40,30)),e.type="horizontal",e.direction="right",e.speed=3,(o=new BouncerMorph).setColor(new Color(200,20,20)),o.setPosition(new Point(90,140)),o.setExtent(new Point(20,20)),o.type="vertical",o.direction="up",o.speed=8,(i=new BouncerMorph).setColor(new Color(20,200,20)),i.setPosition(new Point(120,140)),i.setExtent(new Point(20,20)),i.type="vertical",i.direction="down",i.speed=4,t.add(o),t.add(e),r.add(i),r.add(t),n(r)}),e.addItem("pen",function(){n(new PenMorph)}),o.customMorphs&&(e.addLine(),o.customMorphs().forEach(function(t){e.addItem(t.toString(),function(){n(t)})})),e.popUpAtHand(this)},WorldMorph.prototype.toggleDevMode=function(){this.isDevMode=!this.isDevMode},WorldMorph.prototype.hideAll=function(){this.children.forEach(function(t){t.hide()})},WorldMorph.prototype.showAllHiddens=function(){this.forAllChildren(function(t){t.isVisible||t.show()})},WorldMorph.prototype.about=function(){var t,e="";for(t in modules)Object.prototype.hasOwnProperty.call(modules,t)&&(e+="\n"+t+" ("+modules[t]+")");""!==e&&(e="\n\nmodules:\n\nmorphic ("+morphicVersion+")"+e),this.inform("morphic.js\n\na lively Web GUI\ninspired by Squeak\n"+morphicVersion+"\n\nwritten by Jens Mönig\njens@moenig.org"+e)},WorldMorph.prototype.edit=function(t){var e=getDocumentPositionOf(this.worldCanvas);if(!t.isEditable)return null;this.cursor&&this.cursor.destroy(),this.cursor=new CursorMorph(t),t.parent.add(this.cursor),this.keyboardReceiver=this.cursor,this.initVirtualKeyboard(),MorphicPreferences.isTouchDevice&&MorphicPreferences.useVirtualKeyboard&&(this.virtualKeyboard.style.top=this.cursor.top()+e.y+"px",this.virtualKeyboard.style.left=this.cursor.left()+e.x+"px",this.virtualKeyboard.focus()),MorphicPreferences.useSliderForInput&&(t.parentThatIsA(MenuMorph)||this.slide(t)),this.lastEditedText!==t&&t.escalateEvent("freshTextEdit",t),this.lastEditedText=t},WorldMorph.prototype.slide=function(e){var t,o,i=parseFloat(e.text);isNaN(i)&&(i=0),t=new MenuMorph,(o=new SliderMorph(i-25,i+25,i,10,"horizontal")).alpha=1,o.color=new Color(225,225,225),o.button.color=t.borderColor,o.button.highlightColor=o.button.color.copy(),o.button.highlightColor.b+=100,o.button.pressColor=o.button.color.copy(),o.button.pressColor.b+=150,o.silentSetHeight(MorphicPreferences.scrollBarSize),o.silentSetWidth(10*MorphicPreferences.menuFontSize),o.drawNew(),o.action=function(t){e.changed(),e.text=Math.round(t).toString(),e.drawNew(),e.changed(),e.escalateEvent("reactToSliderEdit",e)},t.items.push(o),t.popup(this,e.bottomLeft().add(new Point(0,5)))},WorldMorph.prototype.stopEditing=function(){this.cursor&&(this.cursor.target.escalateEvent("reactToEdit",this.cursor.target),this.cursor.target.clearSelection(),this.cursor.destroy(),this.cursor=null),this.keyboardReceiver&&this.keyboardReceiver.stopEditing&&this.keyboardReceiver.stopEditing(),this.keyboardReceiver=null,this.virtualKeyboard&&(this.virtualKeyboard.blur(),document.body.removeChild(this.virtualKeyboard),this.virtualKeyboard=null),this.lastEditedText=null,this.worldCanvas.focus()},WorldMorph.prototype.toggleBlurredShadows=function(){useBlurredShadows=!useBlurredShadows},WorldMorph.prototype.togglePreferences=function(){MorphicPreferences=MorphicPreferences===standardSettings?touchScreenSettings:standardSettings};</script>
        <script>var PushButtonMorph,ToggleButtonMorph,TabMorph,ToggleMorph,ToggleElementMorph,DialogBoxMorph,AlignmentMorph,InputFieldMorph,PianoMenuMorph,PianoKeyMorph;function PushButtonMorph(t,e,o,i,h,n){this.init(t,e,o,i,h,n)}function ToggleButtonMorph(t,e,o,i,h,n,r,s,l,a,p){this.init(t,e,o,i,h,n,r,s,l,a,p)}function TabMorph(t,e,o,i,h,n,r){this.init(t,e,o,i,h,n,r)}function ToggleMorph(t,e,o,i,h,n,r,s,l,a){this.init(t,e,o,i,h,n,r,s,l,a)}function ToggleElementMorph(t,e,o,i,h,n,r,s){this.init(t,e,o,i,h,n,r,s)}function DialogBoxMorph(t,e,o){this.init(t,e,o)}function AlignmentMorph(t,e){this.init(t,e)}function InputFieldMorph(t,e,o,i){this.init(t,e,o,i)}function PianoMenuMorph(t,e,o,i){this.init(t,e,o,i)}function PianoKeyMorph(t,e,o,i,h,n,r,s,l,a,p,d){this.init(t,e,o,i,h,n,r,s,l,a,p,d),this.feedback=d}modules.widgets="2019-April-05",PushButtonMorph.prototype=new TriggerMorph,(PushButtonMorph.prototype.constructor=PushButtonMorph).uber=TriggerMorph.prototype,PushButtonMorph.prototype.fontSize=10,PushButtonMorph.prototype.fontStyle="sans-serif",PushButtonMorph.prototype.labelColor=new Color(0,0,0),PushButtonMorph.prototype.labelShadowColor=new Color(255,255,255),PushButtonMorph.prototype.labelShadowOffset=new Point(1,1),PushButtonMorph.prototype.color=new Color(220,220,220),PushButtonMorph.prototype.pressColor=new Color(115,180,240),PushButtonMorph.prototype.highlightColor=PushButtonMorph.prototype.pressColor.lighter(50),PushButtonMorph.prototype.outlineColor=new Color(30,30,30),PushButtonMorph.prototype.outlineGradient=!1,PushButtonMorph.prototype.contrast=60,PushButtonMorph.prototype.edge=2,PushButtonMorph.prototype.corner=5,PushButtonMorph.prototype.outline=1.00001,PushButtonMorph.prototype.padding=3,PushButtonMorph.prototype.init=function(t,e,o,i,h,n){this.is3D=!1,this.target=t||null,this.action=e||null,this.environment=i||null,this.labelString=o||null,this.label=null,this.labelMinExtent=new Point(0,0),this.hint=h||null,this.template=n||null,this.isDisabled=!1,TriggerMorph.uber.init.call(this),this.color=PushButtonMorph.prototype.color,this.drawNew(),this.fixLayout()},PushButtonMorph.prototype.fixLayout=function(){var t;null!==this.label&&(t=2*this.padding+2*this.outline+2*this.edge,this.setExtent(new Point(Math.max(this.label.width(),this.labelMinExtent.x)+t,Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+t)),this.label.setCenter(this.center()))},PushButtonMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this),this.label&&this.label.setCenter(this.center().add(1))},PushButtonMorph.prototype.mouseClickLeft=function(){this.isDisabled||(PushButtonMorph.uber.mouseClickLeft.call(this),this.label&&this.label.setCenter(this.center()))},PushButtonMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this),this.label&&this.label.setCenter(this.center())},PushButtonMorph.prototype.outlinePath=BoxMorph.prototype.outlinePath,PushButtonMorph.prototype.drawOutline=function(t){var e,o=MorphicPreferences.isFlat&&!this.is3D;if(!this.outline||o)return null;this.outlineGradient?((e=t.createLinearGradient(0,0,0,this.height())).addColorStop(0,this.outlineColor.darker().toString()),e.addColorStop(1,"white")):e=this.outlineColor.toString(),t.fillStyle=e,t.beginPath(),this.outlinePath(t,o?0:this.corner,0),t.closePath(),t.fill()},PushButtonMorph.prototype.drawBackground=function(t,e){var o=MorphicPreferences.isFlat&&!this.is3D;t.fillStyle=e.toString(),t.beginPath(),this.outlinePath(t,o?0:Math.max(this.corner-this.outline,0),this.outline),t.closePath(),t.fill(),t.lineWidth=this.outline},PushButtonMorph.prototype.drawEdges=function(t,e,o,i){var h,n,r,s;MorphicPreferences.isFlat&&!this.is3D||(h=Math.max(this.corner,this.outline+this.edge),n=this.width(),r=this.height(),(s=t.createLinearGradient(0,this.outline,0,this.outline+this.edge)).addColorStop(0,o.toString()),s.addColorStop(1,e.toString()),t.strokeStyle=s,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(h,this.outline+this.edge/2),t.lineTo(n-h,this.outline+this.edge/2),t.stroke(),(s=t.createRadialGradient(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge,0),this.corner,this.corner,Math.max(this.corner-this.outline,0))).addColorStop(0,e.toString()),s.addColorStop(1,o.toString()),t.strokeStyle=s,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(180),radians(270),!1),t.stroke(),(s=t.createLinearGradient(this.outline,0,this.outline+this.edge,0)).addColorStop(0,o.toString()),s.addColorStop(1,e.toString()),t.strokeStyle=s,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(this.outline+this.edge/2,h),t.lineTo(this.outline+this.edge/2,r-h),t.stroke(),(s=t.createLinearGradient(0,r-this.outline,0,r-this.outline-this.edge)).addColorStop(0,i.toString()),s.addColorStop(1,e.toString()),t.strokeStyle=s,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(h,r-this.outline-this.edge/2),t.lineTo(n-h,r-this.outline-this.edge/2),t.stroke(),(s=t.createRadialGradient(n-this.corner,r-this.corner,Math.max(this.corner-this.outline-this.edge,0),n-this.corner,r-this.corner,Math.max(this.corner-this.outline,0))).addColorStop(0,e.toString()),s.addColorStop(1,i.toString()),t.strokeStyle=s,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(n-this.corner,r-this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(0),radians(90),!1),t.stroke(),(s=t.createLinearGradient(n-this.outline,0,n-this.outline-this.edge,0)).addColorStop(0,i.toString()),s.addColorStop(1,e.toString()),t.strokeStyle=s,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(n-this.outline-this.edge/2,h),t.lineTo(n-this.outline-this.edge/2,r-h),t.stroke())},PushButtonMorph.prototype.createBackgrounds=function(){var t,e=this.extent();if(this.template)return this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null;this.normalImage=newCanvas(e),t=this.normalImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.color),this.drawEdges(t,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast)),this.highlightImage=newCanvas(e),t=this.highlightImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.highlightColor),this.drawEdges(t,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast)),this.pressImage=newCanvas(e),t=this.pressImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.pressColor),this.drawEdges(t,this.pressColor,this.pressColor.darker(this.contrast),this.pressColor.lighter(this.contrast)),this.image=this.normalImage},PushButtonMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D;null!==this.label&&this.label.destroy(),this.labelString instanceof SymbolMorph?(this.label=this.labelString.fullCopy(),t&&(this.label.shadowOffset=this.labelShadowOffset,this.label.shadowColor=this.labelShadowColor),this.label.color=this.labelColor,this.label.drawNew()):this.label=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor),this.add(this.label)},PushButtonMorph.prototype.disable=function(){this.isDisabled=!0,this.forAllChildren(function(t){t.alpha=.3}),this.changed()},PushButtonMorph.prototype.enable=function(){this.isDisabled=!1,this.forAllChildren(function(t){t.alpha=1}),this.changed()},ToggleButtonMorph.prototype=new PushButtonMorph,(ToggleButtonMorph.prototype.constructor=ToggleButtonMorph).uber=PushButtonMorph.prototype,ToggleButtonMorph.prototype.contrast=30,ToggleButtonMorph.prototype.init=function(t,e,o,i,h,n,r,s,l,a,p){this.state=!1,this.query=h||function(){return!0},this.minWidth=l||null,this.hasPreview=a||!1,this.isPicture=p||!1,this.trueStateLabel=null,ToggleButtonMorph.uber.init.call(this,e,o,i,n,r,s),t&&(this.color=t[0],this.highlightColor=t[1],this.pressColor=t[2]),this.refresh(),this.drawNew()},ToggleButtonMorph.prototype.mouseEnter=function(){var t=this.hint instanceof Function?this.hint():this.hint;this.state||(this.image=this.highlightImage,this.changed()),t&&this.bubbleHelp(t)},ToggleButtonMorph.prototype.mouseLeave=function(){this.state||(this.image=this.normalImage,this.changed()),this.schedule&&(this.schedule.isActive=!1),this.hint&&this.world().hand.destroyTemporaries()},ToggleButtonMorph.prototype.mouseDownLeft=function(){this.state||(this.image=this.pressImage,this.changed())},ToggleButtonMorph.prototype.mouseClickLeft=function(){this.state||(this.image=this.highlightImage,this.changed()),this.trigger()},ToggleButtonMorph.prototype.trigger=function(){ToggleButtonMorph.uber.trigger.call(this),this.refresh()},ToggleButtonMorph.prototype.refresh=function(){"function"==typeof this.query?this.state=this.query.call(this.target):this.state=this.target[this.query](),this.state?(this.image=this.pressImage,this.trueStateLabel&&(this.label.hide(),this.trueStateLabel.show())):(this.image=this.normalImage,this.trueStateLabel&&(this.label.show(),this.trueStateLabel.hide())),this.changed()},ToggleButtonMorph.prototype.fixLayout=function(){var t,e;null!==this.label&&(t=Math.max(this.label.width(),this.labelMinExtent.x),e=2*this.padding+2*this.outline+2*this.edge,this.setExtent(new Point(this.minWidth?Math.max(this.minWidth,t)+e:t+e,Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+e)),this.label.setCenter(this.center()),this.trueStateLabel&&this.trueStateLabel.setCenter(this.center()),this.minWidth&&this.label.setLeft(this.left()+this.outline+this.edge+this.corner+this.padding))},ToggleButtonMorph.prototype.createBackgrounds=function(){var t,e=this.extent();if(this.template)return this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null;this.normalImage=newCanvas(e),t=this.normalImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.color),this.drawEdges(t,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast)),this.highlightImage=newCanvas(e),t=this.highlightImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.highlightColor),this.drawEdges(t,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast)),this.pressImage=newCanvas(e),t=this.pressImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.pressColor),this.drawEdges(t,this.pressColor,this.pressColor.lighter(40),this.pressColor.darker(40)),this.image=this.normalImage},ToggleButtonMorph.prototype.drawEdges=function(t,e,o,i){var h;if(ToggleButtonMorph.uber.drawEdges.call(this,t,e,o,i),this.hasPreview){if(MorphicPreferences.isFlat&&!this.is3D)return t.fillStyle=this.pressColor.toString(),void t.fillRect(this.outline,this.outline,this.corner,this.height()-2*this.outline);(h=t.createLinearGradient(0,0,this.corner,0)).addColorStop(0,this.pressColor.lighter(40).toString()),h.addColorStop(1,this.pressColor.darker(40).toString()),t.fillStyle=h,t.beginPath(),this.previewPath(t,Math.max(this.corner-this.outline,0),this.outline),t.closePath(),t.fill()}},ToggleButtonMorph.prototype.previewPath=function(t,e,o){var i=e+o,h=this.height();t.arc(i,i,e,radians(-180),radians(-90),!1),t.arc(i,h-i,e,radians(90),radians(180),!1)},ToggleButtonMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D,e=new Point;null!==this.label&&this.label.destroy(),null!==this.trueStateLabel&&this.trueStateLabel.destroy(),this.labelString instanceof Array&&2===this.labelString.length?this.labelString[0]instanceof SymbolMorph?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy(),this.isPicture||(this.label.shadowOffset=t?this.labelShadowOffset:e,this.label.shadowColor=this.labelShadowColor,this.label.color=this.labelColor,this.label.drawNew(),this.trueStateLabel.shadowOffset=t?this.labelShadowOffset:e,this.trueStateLabel.shadowColor=this.labelShadowColor,this.trueStateLabel.color=this.labelColor,this.trueStateLabel.drawNew())):this.labelString[0]instanceof Morph?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy()):(this.label=new StringMorph(localize(this.labelString[0]),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor),this.trueStateLabel=new StringMorph(localize(this.labelString[1]),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor)):this.labelString instanceof SymbolMorph?(this.label=this.labelString.fullCopy(),this.isPicture||(this.label.shadowOffset=t?this.labelShadowOffset:e,this.label.shadowColor=this.labelShadowColor,this.label.color=this.labelColor,this.label.drawNew())):this.labelString instanceof Morph?this.label=this.labelString.fullCopy():this.label=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:e,this.labelShadowColor,this.labelColor),this.add(this.label),this.trueStateLabel&&this.add(this.trueStateLabel)},ToggleButtonMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},ToggleButtonMorph.prototype.show=function(){this.isVisible=!0,this.changed()},TabMorph.prototype=new ToggleButtonMorph,(TabMorph.prototype.constructor=TabMorph).uber=ToggleButtonMorph.prototype,TabMorph.prototype.fixLayout=function(){null!==this.label&&(this.setExtent(new Point(this.label.width()+2*this.padding+3*this.corner+2*this.edge,(this.label instanceof StringMorph?this.label.rawHeight():this.label.height())+2*this.padding+this.edge)),this.label.setCenter(this.center()))},TabMorph.prototype.refresh=function(){this.state&&this.parent&&this.parent.add(this),TabMorph.uber.refresh.call(this)},TabMorph.prototype.drawBackground=function(t,e){var o=this.width(),i=this.height(),h=this.corner;t.fillStyle=e.toString(),t.beginPath(),t.moveTo(0,i),t.bezierCurveTo(h,i,h,0,2*h,0),t.lineTo(o-2*h,0),t.bezierCurveTo(o-h,0,o-h,i,o,i),t.closePath(),t.fill()},TabMorph.prototype.drawOutline=function(){nop()},TabMorph.prototype.drawEdges=function(t,e,o,i){var h,n,r,s,l,a;MorphicPreferences.isFlat&&!this.is3D||(h=this.width(),n=this.height(),r=this.corner,l=(s=this.edge)/2,nop(e),(a=t.createLinearGradient(0,0,h,0)).addColorStop(0,o.toString()),a.addColorStop(1,i.toString()),t.strokeStyle=a,t.lineCap="round",t.lineWidth=s,t.beginPath(),t.moveTo(0,n+l),t.bezierCurveTo(r,n,r,0,2*r,l),t.lineTo(h-2*r,l),t.bezierCurveTo(h-r,0,h-r,n,h,n+l),t.stroke())},ToggleMorph.prototype=new PushButtonMorph,(ToggleMorph.prototype.constructor=ToggleMorph).uber=PushButtonMorph.prototype,ToggleMorph.prototype.init=function(t,e,o,i,h,n,r,s,l,a){this.padding=1,t=t||"checkbox",this.corner="checkbox"===t?0:fontHeight(this.fontSize)/2+this.outline+this.padding,this.state=!1,this.query=h||function(){return!0},this.tick=null,this.captionString=i||null,this.labelAlignment="right",this.element=l||null,this.builder=a||null,this.toggleElement=null,ToggleMorph.uber.init.call(this,e,o,"checkbox"===t?"":"Ï",n,r,s),this.refresh(),this.drawNew()},ToggleMorph.prototype.fixLayout=function(){var t,e=2*this.padding+2*this.outline;null!==this.tick&&(this.silentSetHeight(this.tick.rawHeight()+e),this.silentSetWidth(this.tick.width()+e),this.setExtent(new Point(Math.max(this.width(),this.height()),Math.max(this.width(),this.height()))),this.tick.setCenter(this.center())),this.state?this.tick.show():this.tick.hide(),this.toggleElement&&"right"===this.labelAlignment&&(t=this.top()+(this.height()-this.toggleElement.height())/2,this.toggleElement.setPosition(new Point(this.right()+e,t))),null!==this.label&&(t=this.top()+(this.height()-this.label.height())/2,"right"===this.labelAlignment?this.label.setPosition(new Point(this.toggleElement?this.toggleElement instanceof ToggleElementMorph?this.toggleElement.right():this.toggleElement.right()+e:this.right()+e,t)):this.label.setPosition(new Point(this.left()-this.label.width()-e,t)))},ToggleMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D;null===this.label&&this.captionString&&(this.label=new TextMorph(localize(this.captionString),this.fontSize,this.fontStyle,!0),this.add(this.label)),null===this.tick&&(this.tick=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,t?new Point(1,1):null,new Color(240,240,240)),this.add(this.tick)),null===this.toggleElement&&this.element&&(this.element instanceof Morph?this.toggleElement=new ToggleElementMorph(this.target,this.action,this.element,this.query,this.environment,this.hint,this.builder):this.element instanceof HTMLCanvasElement&&(this.toggleElement=new Morph,this.toggleElement.silentSetExtent(new Point(this.element.width,this.element.height)),this.toggleElement.image=this.element),this.add(this.toggleElement))},ToggleMorph.prototype.trigger=function(){ToggleMorph.uber.trigger.call(this),this.refresh()},ToggleMorph.prototype.refresh=function(){"function"==typeof this.query?this.state=this.query.call(this.target):this.state=this.target[this.query](),this.state?this.tick.show():this.tick.hide(),this.toggleElement&&this.toggleElement.refresh&&this.toggleElement.refresh()},ToggleMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this),this.tick&&this.tick.setCenter(this.center().add(1))},ToggleMorph.prototype.mouseClickLeft=function(){PushButtonMorph.uber.mouseClickLeft.call(this),this.tick&&this.tick.setCenter(this.center())},ToggleMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this),this.tick&&this.tick.setCenter(this.center())},ToggleMorph.prototype.hide=ToggleButtonMorph.prototype.hide,ToggleMorph.prototype.show=ToggleButtonMorph.prototype.show,ToggleElementMorph.prototype=new TriggerMorph,(ToggleElementMorph.prototype.constructor=ToggleElementMorph).uber=TriggerMorph.prototype,ToggleElementMorph.prototype.contrast=50,ToggleElementMorph.prototype.shadowOffset=new Point(2,2),ToggleElementMorph.prototype.shadowAlpha=.6,ToggleElementMorph.prototype.fontSize=10,ToggleElementMorph.prototype.inactiveColor=new Color(180,180,180),ToggleElementMorph.prototype.init=function(t,e,o,i,h,n,r,s){this.target=t||null,this.action=e||null,this.element=o,this.query=i||function(){return!0},this.environment=h||null,this.hint=n||null,this.builder=r||"nop",this.captionString=s||null,this.labelAlignment="right",this.state=!1,TriggerMorph.uber.init.call(this),this.color=o.color,this.createLabel()},ToggleElementMorph.prototype.createBackgrounds=function(){var t=!MorphicPreferences.isFlat||this.is3D;this.color=this.element.color,this.element.removeShadow(),this.element[this.builder](),t&&this.element.addShadow(this.shadowOffset,this.shadowAlpha),this.silentSetExtent(this.element.fullBounds().extent()),this.pressImage=this.element.fullImage(),this.element.removeShadow(),this.element.setColor(this.inactiveColor),this.element[this.builder](this.contrast),t&&this.element.addShadow(this.shadowOffset,0),this.normalImage=this.element.fullImage(),this.element.removeShadow(),this.element.setColor(this.color.lighter(this.contrast)),this.element[this.builder](this.contrast),t&&this.element.addShadow(this.shadowOffset,this.shadowAlpha),this.highlightImage=this.element.fullImage(),this.element.removeShadow(),this.element.setColor(this.color),this.element[this.builder](),this.image=this.normalImage},ToggleElementMorph.prototype.setColor=function(t){this.element.setColor(t),this.createBackgrounds(),this.refresh()},ToggleElementMorph.prototype.createLabel=function(){var t;this.captionString&&(this.label=new StringMorph(this.captionString,this.fontSize,this.fontStyle,!0),this.add(this.label),t=this.top()+(this.height()-this.label.height())/2,"right"===this.labelAlignment?this.label.setPosition(new Point(this.right(),t)):this.label.setPosition(new Point(this.left()-this.label.width(),t)))},ToggleElementMorph.prototype.trigger=ToggleButtonMorph.prototype.trigger,ToggleElementMorph.prototype.refresh=ToggleButtonMorph.prototype.refresh,ToggleElementMorph.prototype.mouseEnter=ToggleButtonMorph.prototype.mouseEnter,ToggleElementMorph.prototype.mouseLeave=ToggleButtonMorph.prototype.mouseLeave,ToggleElementMorph.prototype.mouseDownLeft=ToggleButtonMorph.prototype.mouseDownLeft,ToggleElementMorph.prototype.mouseClickLeft=ToggleButtonMorph.prototype.mouseClickLeft,DialogBoxMorph.prototype=new Morph,(DialogBoxMorph.prototype.constructor=DialogBoxMorph).uber=Morph.prototype,DialogBoxMorph.prototype.fontSize=12,DialogBoxMorph.prototype.titleFontSize=14,DialogBoxMorph.prototype.fontStyle="sans-serif",DialogBoxMorph.prototype.color=PushButtonMorph.prototype.color,DialogBoxMorph.prototype.titleTextColor=new Color(255,255,255),DialogBoxMorph.prototype.titleBarColor=PushButtonMorph.prototype.pressColor,DialogBoxMorph.prototype.contrast=40,DialogBoxMorph.prototype.corner=12,DialogBoxMorph.prototype.padding=14,DialogBoxMorph.prototype.titlePadding=6,DialogBoxMorph.prototype.buttonContrast=50,DialogBoxMorph.prototype.buttonFontSize=12,DialogBoxMorph.prototype.buttonCorner=12,DialogBoxMorph.prototype.buttonEdge=6,DialogBoxMorph.prototype.buttonPadding=0,DialogBoxMorph.prototype.buttonOutline=3,DialogBoxMorph.prototype.buttonOutlineColor=PushButtonMorph.prototype.color,DialogBoxMorph.prototype.buttonOutlineGradient=!0,DialogBoxMorph.prototype.instances={},DialogBoxMorph.prototype.init=function(t,e,o){this.is3D=!1,this.target=t||null,this.action=e||null,this.environment=o||null,this.key=null,this.labelString=null,this.label=null,this.head=null,this.body=null,this.buttons=null,DialogBoxMorph.uber.init.call(this),this.isDraggable=!0,this.color=PushButtonMorph.prototype.color,this.createLabel(),this.createButtons(),this.setExtent(new Point(300,150))},DialogBoxMorph.prototype.inform=function(t,e,o,i){var h=new TextMorph(e,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255));this.key||(this.key="inform"+t+e),this.labelString=t,this.createLabel(),i&&this.setPicture(i),e&&this.addBody(h),this.addButton("ok","OK"),this.drawNew(),this.fixLayout(),this.popUp(o)},DialogBoxMorph.prototype.askYesNo=function(t,e,o,i){var h=new TextMorph(e,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255));this.key||(this.key="decide"+t+e),this.labelString=t,this.createLabel(),i&&this.setPicture(i),this.addBody(h),this.addButton("ok","Yes"),this.addButton("cancel","No"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o)},DialogBoxMorph.prototype.prompt=function(t,e,o,i,h,n,r,s,l,a){var p,d,u=new InputFieldMorph(e,r||!1,h||null,h&&n||!1);u.setWidth(250),r?(i&&(d=new AlignmentMorph("column",this.padding),i.setPosition(d.position()),d.add(i)),isNil(s)||isNil(l)||((p=new SliderMorph(100*s,100*l,100*parseFloat(e),(l-s)/10*100,"horizontal")).alpha=1,p.color=this.color.lighter(50),p.setHeight(.7*u.height()),p.setWidth(u.width()),p.action=function(t){a&&a(t/100),u.setContents(t/100),u.edit()},(d=d||new AlignmentMorph("column",this.padding)).add(p)),d&&(d.fixLayout(),this.setPicture(d),d.fixLayout())):i&&this.setPicture(i),this.reactToChoice=function(t){p&&(p.value=100*t,p.drawNew(),p.changed()),a&&a(t)},u.reactToKeystroke=function(){var t=u.getValue();p&&(t=Math.max(t,s),p.value=100*t,p.drawNew(),p.changed()),a&&a(t)},this.labelString=t,this.createLabel(),this.key||(this.key="prompt"+t+e),this.addBody(u),u.drawNew(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o)},DialogBoxMorph.prototype.promptCode=function(t,e,o,i,h){var n=new ScrollFrameMorph,r=new TextMorph(e||""),s=new AlignmentMorph("column",this.padding),l=i?Math.max(i.width,400):400;this.getInput=function(){return r.text},n.padding=6,n.setWidth(l),n.acceptsDrops=!1,n.contents.acceptsDrops=!1,r.fontName="monospace",r.fontStyle="monospace",r.fontSize=11,r.setPosition(n.topLeft().add(n.padding)),r.enableSelecting(),r.isEditable=!0,n.setHeight(l/4),n.fixLayout=nop,n.edge=InputFieldMorph.prototype.edge,n.fontSize=InputFieldMorph.prototype.fontSize,n.typeInPadding=InputFieldMorph.prototype.typeInPadding,n.contrast=InputFieldMorph.prototype.contrast,n.drawNew=InputFieldMorph.prototype.drawNew,n.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,n.addContents(r),r.drawNew(),i&&this.setPicture(i),this.labelString=t,this.createLabel(),this.key||(this.key="promptCode"+t+e),s.setColor(this.color),s.add(n),h&&s.add(new TextMorph(localize(h),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))),s.fixLayout(),this.addBody(s),n.drawNew(),s.drawNew(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o),r.edit()},DialogBoxMorph.prototype.promptVector=function(t,e,o,i,h,n,r,s){var l=new AlignmentMorph("row",4),a=new InputFieldMorph(e.x.toString(),!0),p=new InputFieldMorph(e.y.toString(),!0),d=new AlignmentMorph("column",2),u=new AlignmentMorph("column",2),g=new AlignmentMorph("column",2),c=new AlignmentMorph("column",this.padding);function f(t){return new TextMorph(localize(t),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))}g.alignment="left",g.setColor(this.color),c.setColor(this.color),d.alignment="left",d.setColor(this.color),u.alignment="left",u.setColor(this.color),d.add(f(i)),d.add(a),u.add(f(h)),u.add(p),l.add(d),l.add(u),g.add(l),s&&c.add(f(s)),c.add(g),l.fixLayout(),d.fixLayout(),u.fixLayout(),g.fixLayout(),c.fixLayout(),this.labelString=t,this.createLabel(),r&&this.setPicture(r),this.addBody(c),l.drawNew(),d.drawNew(),a.drawNew(),u.drawNew(),p.drawNew(),c.fixLayout(),this.addButton("ok","OK"),o instanceof Point&&this.addButton(function(){a.setContents(o.x.toString()),p.setContents(o.y.toString())},"Default"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.edit=function(){a.edit()},this.getInput=function(){return new Point(a.getValue(),p.getValue())},this.key||(this.key="vector"+t),this.popUp(n)},DialogBoxMorph.prototype.promptCredentials=function(t,h,e,o,i,n,r,s,l,a){var p,d,u,g,c=new InputFieldMorph,f=new InputFieldMorph,y=new InputFieldMorph,w=new InputFieldMorph,M=new InputFieldMorph,b=!1,m=new AlignmentMorph("row",4),S=new AlignmentMorph("column",2),C=new AlignmentMorph("column",2),P=new AlignmentMorph("column",2),B=new AlignmentMorph("row",4),x=new AlignmentMorph("column",this.padding),T={},k=(new Date).getFullYear(),v=k-20,L=this;function I(t){return new TextMorph(localize(t),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))}function D(t,e){var o=new PushButtonMorph(L,function(){window.open(e)},"  "+localize(t)+"  ");return o.fontSize=10,o.corner=L.buttonCorner,o.edge=L.buttonEdge,o.outline=L.buttonOutline,o.outlineColor=L.buttonOutlineColor,o.outlineGradient=L.buttonOutlineGradient,o.padding=L.buttonPadding,o.contrast=L.buttonContrast,o.drawNew(),o.fixLayout(),o}for(p=new InputFieldMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},!0);v<k;--k)T[k.toString()+" "]=k;T[v+" "+localize("or before")]="< "+k,d=new InputFieldMorph(null,!1,T,!0),P.alignment="left",P.setColor(this.color),x.setColor(this.color),S.alignment="left",S.setColor(this.color),C.alignment="left",C.setColor(this.color),c.setWidth(200),p.setWidth(100),d.contents().minWidth=80,d.setWidth(80),f.setWidth(200),y.setWidth(200),w.setWidth(200),M.setWidth(200),y.contents().text.toggleIsPassword(),w.contents().text.toggleIsPassword(),M.contents().text.toggleIsPassword(),"login"===h&&(P.add(I("User name:")),P.add(c)),"signup"===h&&(P.add(I("User name:")),P.add(c),S.add(I("Birth date:")),S.add(p),C.add(I("year:")),C.add(d),m.add(S),m.add(C),P.add(m),u=I("foo"),P.add(u),P.add(f),P.add(I("Password:")),P.add(y),P.add(I("Repeat Password:")),P.add(w)),"login"===h&&(P.add(I("Password:")),P.add(y)),"changePassword"===h&&(P.add(I("Old password:")),P.add(M),P.add(I("New password:")),P.add(y),P.add(I("Repeat new password:")),P.add(w)),"resetPassword"!==h&&"resendVerification"!==h||(P.add(I("User name:")),P.add(c)),a&&x.add(I(a)),x.add(P),(e||i)&&x.add(B),e&&B.add(D(o,e)),i&&B.add(D(n,i)),r&&((g=new ToggleMorph("checkbox",this,function(){b=!b},r,function(){return b})).edge=this.buttonEdge/2,g.outline=this.buttonOutline/2,g.outlineColor=this.buttonOutlineColor,g.outlineGradient=this.buttonOutlineGradient,g.contrast=this.buttonContrast,g.drawNew(),g.fixLayout(),x.add(g)),m.fixLayout(),S.fixLayout(),C.fixLayout(),P.fixLayout(),B.fixLayout(),x.fixLayout(),this.labelString=t,this.createLabel(),l&&this.setPicture(l),this.addBody(x),c.drawNew(),m.drawNew(),S.drawNew(),p.drawNew(),C.drawNew(),d.drawNew(),y.drawNew(),w.drawNew(),M.drawNew(),f.drawNew(),x.fixLayout(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.accept=function(){!function(){var t,e,o=f.getValue();function i(t,e){var o=new SpeechBubbleMorph(localize(e));o.isPointingRight=!1,o.drawNew(),o.popUp(s,t.leftCenter().subtract(new Point(o.width()+2,0))),t.edit&&t.edit()}if("login"===h?t=[c,y]:"signup"===h?t=[c,p,d,f,y,w]:"changePassword"===h?t=[M,y,w]:"resetPassword"!==h&&"resendVerification"!==h||(t=[c]),e=detect(t,function(t){return!t.getValue()}))i(e,"please fill out\nthis field");else{if("signup"===h){if(c.getValue().length<4)return void i(c,"User name must be four\ncharacters or longer");if(-1<o.indexOf(" ")||-1===o.indexOf("@")||-1===o.indexOf(".")||o.length<5)return void i(f,"please provide a valid\nemail address")}if("changePassword"===h||"signup"===h){if(y.getValue().length<6)return void i(y,"password must be six\ncharacters or longer");if(y.getValue()!==w.getValue())return void i(w,"passwords do\nnot match")}if("signup"!==h||b)return 1;i(g,"please agree to\nthe TOS")}}()||DialogBoxMorph.prototype.accept.call(L)},this.edit=function(){"changePassword"===h?M.edit():c.edit()},this.getInput=function(){return{username:c.getValue(),email:f.getValue(),oldpassword:M.getValue(),password:y.getValue(),passwordRepeat:w.getValue(),choice:b}},this.reactToChoice=function(){var t,e,o,i;"signup"===h&&(u.changed(),u.text=(e=(new Date).getFullYear()+(new Date).getMonth()/12,o=+d.getValue()||0,(i=p.getValue())instanceof Array&&(i=i[0]),isNaN(o)&&(o=0),t=["January","February","March","April","May","June","July","August","September","October","November","December"].indexOf(i),isNaN(t)&&(t=0),e-(o+t/12)<=13?"E-mail address of parent or guardian:":"E-mail address:"),u.text=localize(u.text),u.drawNew(),u.changed())},this.reactToChoice(),this.key||(this.key="credentials"+t+h),this.popUp(s)},DialogBoxMorph.prototype.accept=function(){this.action&&("function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action):"function"==typeof this.action?this.action.call(this.target,this.getInput()):this.target[this.action](this.getInput())),this.destroy()},DialogBoxMorph.prototype.withKey=function(t){return this.key=t,this},DialogBoxMorph.prototype.popUp=function(t){t&&(this.key&&(this.instances[t.stamp]?this.instances[t.stamp][this.key]&&this.instances[t.stamp][this.key].destroy():this.instances[t.stamp]={},this.instances[t.stamp][this.key]=this),t.add(this),(t.keyboardReceiver=this).setCenter(t.center()),this.edit())},DialogBoxMorph.prototype.destroy=function(){DialogBoxMorph.uber.destroy.call(this),this.key&&delete this.instances[this.key]},DialogBoxMorph.prototype.ok=function(){this.accept()},DialogBoxMorph.prototype.cancel=function(){this.destroy()},DialogBoxMorph.prototype.edit=function(){this.children.forEach(function(t){if(t.edit)return t.edit()})},DialogBoxMorph.prototype.getInput=function(){return this.body instanceof InputFieldMorph?this.body.getValue():null},DialogBoxMorph.prototype.justDropped=function(t){(t.world.keyboardReceiver=this).edit()},DialogBoxMorph.prototype.destroy=function(){var t=this.world();t.keyboardReceiver=null,t.hand.destroyTemporaries(),DialogBoxMorph.uber.destroy.call(this)},DialogBoxMorph.prototype.normalizeSpaces=function(t){for(var e,o="",i=!1,h=0;h<t.length;h+=1)" "===(e=t[h])?i&&(o+=e,i=!1):(o+=e,i=!0);return o.trim()},DialogBoxMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D;this.label&&this.label.destroy(),this.labelString&&(this.label=new StringMorph(localize(this.labelString),this.titleFontSize,this.fontStyle,!0,!1,!1,t?new Point(2,1):null,this.titleBarColor.darker(this.contrast)),this.label.color=this.titleTextColor,this.label.drawNew(),this.add(this.label))},DialogBoxMorph.prototype.createButtons=function(){this.buttons&&this.buttons.destroy(),this.buttons=new AlignmentMorph("row",this.padding),this.add(this.buttons)},DialogBoxMorph.prototype.addButton=function(t,e){var o=new PushButtonMorph(this,t||"ok","  "+localize(e||"OK")+"  ");return o.fontSize=this.buttonFontSize,o.corner=this.buttonCorner,o.edge=this.buttonEdge,o.outline=this.buttonOutline,o.outlineColor=this.buttonOutlineColor,o.outlineGradient=this.buttonOutlineGradient,o.padding=this.buttonPadding,o.contrast=this.buttonContrast,o.drawNew(),o.fixLayout(),this.buttons.add(o),o},DialogBoxMorph.prototype.setPicture=function(t){var e;t instanceof Morph?e=t:((e=new Morph).image=t,e.silentSetWidth(t.width),e.silentSetHeight(t.height)),this.addHead(e)},DialogBoxMorph.prototype.addHead=function(t){this.head&&this.head.destroy(),this.head=t,this.add(this.head)},DialogBoxMorph.prototype.addBody=function(t){this.body&&this.body.destroy(),this.body=t,this.add(this.body)},DialogBoxMorph.prototype.addShadow=function(){nop()},DialogBoxMorph.prototype.removeShadow=function(){nop()},DialogBoxMorph.prototype.fixLayout=function(){var t,e=fontHeight(this.titleFontSize)+2*this.titlePadding;this.head&&(this.head.setPosition(this.position().add(new Point(this.padding,e+this.padding))),this.silentSetWidth(this.head.width()+2*this.padding),this.silentSetHeight(this.head.height()+2*this.padding+e)),this.body&&(this.head?(this.body.setPosition(this.head.bottomLeft().add(new Point(0,this.padding))),this.silentSetWidth(Math.max(this.width(),this.body.width()+2*this.padding)),this.silentSetHeight(this.height()+this.body.height()+this.padding),t=this.width(),this.head.setLeft(this.left()+Math.round((t-this.head.width())/2)),this.body.setLeft(this.left()+Math.round((t-this.body.width())/2))):(this.body.setPosition(this.position().add(new Point(this.padding,e+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+e))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(e-this.label.height())/2)),this.buttons&&0<this.buttons.children.length&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.buttons.width()+2*this.padding)),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},DialogBoxMorph.prototype.shadowImage=function(t,e){var o,i=t||new Point(7,7),h=e||new Color(0,0,0),n=this.extent(),r=this.image,s=newCanvas(n),l=s.getContext("2d");return l.drawImage(r,0,0),l.globalCompositeOperation="destination-out",l.drawImage(r,-i.x,-i.y),(l=(o=newCanvas(n)).getContext("2d")).drawImage(s,0,0),l.globalCompositeOperation="source-atop",l.fillStyle=h.toString(),l.fillRect(0,0,n.x,n.y),o},DialogBoxMorph.prototype.shadowImageBlurred=function(t,e){var o=t||new Point(7,7),i=this.shadowBlur,h=e||new Color(0,0,0),n=this.extent().add(2*i),r=this.image,s=newCanvas(n),l=s.getContext("2d");return l.shadowOffsetX=o.x,l.shadowOffsetY=o.y,l.shadowBlur=i,l.shadowColor=h.toString(),l.drawImage(r,i-o.x,i-o.y),l.shadowOffsetX=0,l.shadowOffsetY=0,l.shadowBlur=0,l.globalCompositeOperation="destination-out",l.drawImage(r,i-o.x,i-o.y),s},DialogBoxMorph.prototype.processKeyPress=function(){nop()},DialogBoxMorph.prototype.processKeyDown=function(t){switch(t.keyCode){case 13:this.ok();break;case 27:this.cancel();break;default:nop()}},DialogBoxMorph.prototype.drawNew=function(){this.fullChanged(),Morph.prototype.trackChanges=!1,DialogBoxMorph.uber.removeShadow.call(this),this.fixLayout();var t,e,o,i,h=this.width(),n=this.height(),r=Math.floor(fontHeight(this.titleFontSize)+2*this.titlePadding),s=this.corner/2,l=MorphicPreferences.isFlat&&!this.is3D;if(this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),l?t.fillStyle=this.titleBarColor.toString():((e=t.createLinearGradient(0,0,0,r)).addColorStop(0,this.titleBarColor.lighter(this.contrast/2).toString()),e.addColorStop(1,this.titleBarColor.darker(this.contrast).toString()),t.fillStyle=e),t.beginPath(),this.outlinePathTitle(t,l?0:this.corner),t.closePath(),t.fill(),t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePathBody(t,l?0:this.corner),t.closePath(),t.fill(),l)return DialogBoxMorph.uber.addShadow.call(this),Morph.prototype.trackChanges=!0,void this.fullChanged();(e=t.createLinearGradient(0,n-this.corner,0,n)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast.toString())),t.lineWidth=this.corner,t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner,n-s),t.lineTo(this.corner+1,n-s),t.stroke(),(e=t.createLinearGradient(0,n-this.corner,0,n)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast.toString())),t.lineWidth=this.corner,t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner,n-s),t.lineTo(h-this.corner,n-s),t.stroke(),(e=t.createLinearGradient(h-this.corner,0,h,0)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast).toString()),t.lineWidth=this.corner,t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.moveTo(h-s,r),t.lineTo(h-s,n-this.corner),t.stroke(),o=h-this.corner,i=n-this.corner,(e=t.createRadialGradient(o,i,0,o,i,this.corner)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast.toString())),t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.arc(o,i,s,radians(90),radians(0),!0),t.stroke(),(e=t.createLinearGradient(0,0,this.corner,0)).addColorStop(0,this.color.lighter(this.contrast).toString()),e.addColorStop(1,this.color.toString()),t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.moveTo(s,r),t.lineTo(s,n-2*this.corner),t.stroke(),(e=t.createLinearGradient(0,0,this.corner,0)).addColorStop(0,this.color.lighter(this.contrast).toString()),e.addColorStop(1,this.color.toString()),t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(s,n-2*this.corner),t.lineTo(s,n-this.corner-s),t.stroke(),DialogBoxMorph.uber.addShadow.call(this),Morph.prototype.trackChanges=!0,this.fullChanged()},DialogBoxMorph.prototype.outlinePathTitle=function(t,e){var o=this.width(),i=Math.ceil(fontHeight(this.titleFontSize))+2*this.titlePadding;t.arc(e,e,e,radians(-180),radians(-90),!1),t.arc(o-e,e,e,radians(-90),radians(-0),!1),t.lineTo(o,i),t.lineTo(0,i)},DialogBoxMorph.prototype.outlinePathBody=function(t,e){var o=this.width(),i=this.height(),h=Math.floor(fontHeight(this.titleFontSize))+2*this.titlePadding;t.moveTo(0,h),t.lineTo(o,h),t.arc(o-e,i-e,e,radians(0),radians(90),!1),t.arc(e,i-e,e,radians(90),radians(180),!1)},AlignmentMorph.prototype=new Morph,(AlignmentMorph.prototype.constructor=AlignmentMorph).uber=Morph.prototype,AlignmentMorph.prototype.init=function(t,e){this.orientation=t||"row",this.alignment="center",this.padding=e||0,this.respectHiddens=!1,AlignmentMorph.uber.init.call(this)},AlignmentMorph.prototype.drawNew=function(){this.image=newCanvas(new Point(1,1)),this.fixLayout()},AlignmentMorph.prototype.fixLayout=function(){var i,h=this,n=null;if(0===this.children.length)return null;this.children.forEach(function(t){var e,o=t.fullBounds();(t.isVisible||h.respectHiddens)&&(i=n?(e=n.fullBounds(),"row"===h.orientation?t.setPosition(e.topRight().add(new Point(h.padding,(e.height()-o.height())/2))):t.setPosition(e.bottomLeft().add(new Point("center"===h.alignment?(e.width()-o.width())/2:0,h.padding))),o=t.fullBounds(),i.merge(o)):o,n=t)}),this.bounds=i},InputFieldMorph.prototype=new Morph,(InputFieldMorph.prototype.constructor=InputFieldMorph).uber=Morph.prototype,InputFieldMorph.prototype.edge=2,InputFieldMorph.prototype.fontSize=12,InputFieldMorph.prototype.typeInPadding=2,InputFieldMorph.prototype.contrast=65,InputFieldMorph.prototype.init=function(t,e,o,i){var h=new StringFieldMorph(t||""),n=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));this.choices=o||null,this.isReadOnly=i||!1,this.isNumeric=e||!1,h.alpha=0,h.fontSize=this.fontSize,h.drawNew(),this.oldContentsExtent=h.extent(),this.isNumeric=e||!1,InputFieldMorph.uber.init.call(this),this.color=new Color(255,255,255),this.add(h),this.add(n),h.isDraggable=!1,this.drawNew()},InputFieldMorph.prototype.contents=function(){return detect(this.children,function(t){return t instanceof StringFieldMorph})},InputFieldMorph.prototype.arrow=function(){return detect(this.children,function(t){return t instanceof ArrowMorph})},InputFieldMorph.prototype.setChoice=function(t){this.setContents(t),this.escalateEvent("reactToChoice",t)},InputFieldMorph.prototype.setContents=function(t){var e=this.contents();if(void 0===(e.text.text=t))return null;null===t?e.text.text="":t.toString&&(e.text.text=t.toString()),e.drawNew(),e.changed()},InputFieldMorph.prototype.edit=function(){var t=this.contents();t.text.edit(),t.text.selectAll()},InputFieldMorph.prototype.setIsNumeric=function(t){var e;this.isNumeric=t,this.contents().isNumeric=t,this.contents().text.isNumeric=t,e=this.getValue(),this.isNumeric&&(e=parseFloat(e),isNaN(e)&&(e=null)),this.setContents(e)},InputFieldMorph.prototype.dropDownMenu=function(){var t,e=this.choices,o=new MenuMorph(this.setChoice,null,this,this.fontSize);if(e instanceof Function?e=e.call(this):isString(e)&&(e=this[e]()),!e)return null;if(o.addItem(" ",null),e instanceof Array)e.forEach(function(t){o.addItem(t[0],t[1])});else for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&("~"===t[0]?o.addLine():o.addItem(t,e[t]));if(!(0<o.items.length))return null;o.popUpAtHand(this.world())},InputFieldMorph.prototype.fixLayout=function(){var t=this.contents(),e=this.arrow();if(!t)return null;t.isNumeric=this.isNumeric,t.isEditable=!this.isReadOnly,this.choices?(e.setSize(this.fontSize),e.show()):(e.setSize(0),e.hide()),this.silentSetHeight(t.height()+2*this.edge+2*this.typeInPadding),this.silentSetWidth(Math.max(t.minWidth+2*this.edge+2*this.typeInPadding,this.width())),t.setWidth(this.width()-this.edge-this.typeInPadding-(this.choices?e.width()+this.typeInPadding:0)),t.silentSetPosition(new Point(this.edge,this.edge).add(this.typeInPadding).add(this.position())),e.silentSetPosition(new Point(this.right()-e.width()-this.edge,t.top()))},InputFieldMorph.prototype.mouseClickLeft=function(t){this.arrow().bounds.containsPoint(t)||this.isReadOnly?this.dropDownMenu():this.escalateEvent("mouseClickLeft",t)},InputFieldMorph.prototype.getValue=function(){var t,e=this.contents();return this.isNumeric&&(t=parseFloat(e.text),!isNaN(t))?t:this.normalizeSpaces(e.string())},InputFieldMorph.prototype.normalizeSpaces=DialogBoxMorph.prototype.normalizeSpaces,InputFieldMorph.prototype.drawNew=function(){var t,e;this.fixLayout(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),e=this.parent?(this.parent.color.eq(new Color(255,255,255))?this.color=this.parent.color.darker(.1*this.contrast):this.color=this.parent.color.lighter(.75*this.contrast),this.parent.color):new Color(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),this.drawRectBorder(t)},InputFieldMorph.prototype.drawRectBorder=function(t){var e,o=.5*this.edge;MorphicPreferences.isFlat&&!this.is3D||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.shadowOffsetY=o,t.shadowBlur=4*this.edge,t.shadowColor=this.cachedClrDark,(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,o),t.lineTo(this.width()-this.edge-o,o),t.stroke(),t.shadowOffsetY=0,(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o,this.edge),t.lineTo(o,this.height()-this.edge-o),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(0,this.height()-this.edge,0,this.height())).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,this.height()-o),t.lineTo(this.width()-this.edge,this.height()-o),t.stroke(),(e=t.createLinearGradient(this.width()-this.edge,0,this.width(),0)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.width()-o,this.edge),t.lineTo(this.width()-o,this.height()-this.edge),t.stroke())},PianoMenuMorph.prototype=new MenuMorph,(PianoMenuMorph.prototype.constructor=PianoMenuMorph).uber=MenuMorph.prototype,PianoMenuMorph.prototype.init=function(t,e,o,i){var h,n;for(n in this.soundType=i,PianoMenuMorph.uber.init.call(this,t,null,e,o),h={"C (48)":48,"D (50)":50,"C# (49)":49,"E (52)":52,"Eb (51)":51,"F (53)":53,"G (55)":55,"F# (54)":54,"A (57)":57,"G# (56)":56,"B (59)":59,"Bb (58)":58,"C (60)":60,"D (62)":62,"C# (61)":61,"E (64)":64,"Eb (63)":63,"F (65)":65,"G (67)":67,"F# (66)":66,"A (69)":69,"G# (68)":68,"B (71)":71,"Bb (70)":70,"C (72)":72})Object.prototype.hasOwnProperty.call(h,n)&&this.addItem(n,h[n]);this.drawNew()},PianoMenuMorph.prototype.drawNew=function(){var e,t,o,i,h,n,r,s,l,a,p,d=this;this.children.forEach(function(t){t.destroy()}),this.children=[],this.isListContents||(this.edge=MorphicPreferences.isFlat?0:5,this.border=MorphicPreferences.isFlat?1:2),this.color=new Color(255,255,255),this.borderColor=new Color(60,60,60),this.silentSetExtent(new Point(0,0)),o=this.left()+1,i=this.top()+1.5*this.fontSize+2,h=new StringMorph("",this.fontSize),this.items.forEach(function(t){n=" "!==t[0][1],r=new BoxMorph(1,1),n?(s=new Color(0,0,0),l=d.fontSize,a=2.5*d.fontSize,p=new Point(o+2-2*d.fontSize,i)):(s=new Color(255,255,255),l=1.5*d.fontSize,a=4*d.fontSize,p=new Point(o+1,i),o+=l-1),r.setColor(s),r.setWidth(l),r.setHeight(a),(e=new PianoKeyMorph(d.target,t[1],[r,t[0]],d.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,d.environment,t[2],t[3],t[4],t[5],t[6],h)).setPosition(p),d.add(e)}),t=this.fullBounds(),h.setPosition(new Point(t.width()/2-this.fontSize,2)),this.add(h),t=this.fullBounds(),this.silentSetExtent(t.extent().add(2)),MenuMorph.uber.drawNew.call(this)},PianoMenuMorph.prototype.select=function(t){this.unselectAllItems(),t.mouseEnter(),this.selection=t,(this.world.keyboardReceiver=this).hasFocus=!0},PianoMenuMorph.prototype.unselectAllItems=function(){this.children.forEach(function(t){t instanceof MenuItemMorph&&t.mouseLeave()}),this.changed()},PianoMenuMorph.prototype.selectKey=function(e){var t;isNil(e)||((t=detect(this.children,function(t){return t.action===e}))?this.select(t):this.selectKey(48))},PianoMenuMorph.prototype.processKeyDown=function(t){switch(t.keyCode){case 13:case 32:return void(this.selection&&this.selection.mouseClickLeft());case 27:return this.destroy();case 37:case 40:case 189:return this.selectDown();case 38:case 39:case 187:case 220:return this.selectUp();default:switch(t.key){case"C":return this.selectKey(48);case"c":return this.selectKey(60);case"D":return this.selectKey(50);case"d":return this.selectKey(62);case"E":return this.selectKey(52);case"e":return this.selectKey(64);case"F":return this.selectKey(53);case"f":return this.selectKey(65);case"G":return this.selectKey(55);case"g":return this.selectKey(67);case"A":return this.selectKey(57);case"a":return this.selectKey(69);case"B":case"H":return this.selectKey(59);case"b":case"h":return this.selectKey(71);default:nop()}}},PianoMenuMorph.prototype.selectUp=function(){var t=48;this.selection&&72<(t=this.selection.action+1)&&(t=48),this.selectKey(t)},PianoMenuMorph.prototype.selectDown=function(){var t=48;this.selection&&(t=this.selection.action-1)<48&&(t=72),this.selectKey(t)},PianoMenuMorph.prototype.destroy=function(){this.children.forEach(function(t){t.note&&t.note.stop()}),PianoMenuMorph.uber.destroy.call(this)},PianoKeyMorph.prototype=new MenuItemMorph,(PianoKeyMorph.prototype.constructor=PianoKeyMorph).uber=MenuItemMorph.prototype,PianoKeyMorph.prototype.init=function(t,e,o,i,h,n,r,s,l,a,p,d){this.note=new Note(e),PianoKeyMorph.uber.init.call(this,t,e,o,i,h,n,r,s,l,a,p,d)},PianoKeyMorph.prototype.createLabel=function(){var t;null!==this.label&&this.label.destroy(),this.label=new Morph,t=this.createIcon(this.labelString[0]),this.label.add(t),this.label.drawNew(),this.silentSetExtent(t.extent()),this.label.bounds=this.position().extent(this.label.extent()),this.label.silentSetExtent(new Point(0,0)),this.add(this.label)},PianoKeyMorph.prototype.mouseEnter=function(){var t=this.parentThatIsA(PianoMenuMorph),e=t?t.soundType:1,o=this;t&&(t.unselectAllItems(),t.selection=this,(t.world.keyboardReceiver=t).hasFocus=!0),this.label.children[0].hide(),this.image=this.highlightImage,this.changed(),this.feedback.text=this.labelString[1],this.feedback.changed(),this.feedback.drawNew(),this.feedback.changed(),this.note.play(e),setTimeout(function(){o.note.stop(!0)},400)},PianoKeyMorph.prototype.mouseLeave=function(){this.note.stop(!0),this.label.children[0].show(),this.image=this.normalImage,this.changed()};</script>
        <script>var SyntaxElementMorph,BlockMorph,CommandBlockMorph,ReporterBlockMorph,ScriptsMorph,ArgMorph,CommandSlotMorph,CSlotMorph,InputSlotMorph,BooleanSlotMorph,ArrowMorph,ColorSlotMorph,HatBlockMorph,BlockHighlightMorph,MultiArgMorph,TemplateSlotMorph,FunctionSlotMorph,ReporterSlotMorph,RingMorph,RingCommandSlotMorph,RingReporterSlotMorph,CommentMorph,ArgLabelMorph,TextSlotMorph,ScriptFocusMorph;function SyntaxElementMorph(){this.init()}function BlockMorph(){this.init()}function CommandBlockMorph(){this.init()}function HatBlockMorph(){this.init()}function ReporterBlockMorph(t){this.init(t)}function RingMorph(){this.init()}function ScriptsMorph(){this.init()}function ArgMorph(t){this.init(t)}function CommandSlotMorph(){this.init()}function RingCommandSlotMorph(){this.init()}function CSlotMorph(){this.init()}function InputSlotMorph(t,e,o,r){this.init(t,e,o,r)}function TemplateSlotMorph(t){this.init(t)}function BooleanSlotMorph(t){this.init(t)}function ArrowMorph(t,e,o,r){this.init(t,e,o,r)}function TextSlotMorph(t,e,o,r){this.init(t,e,o,r)}function ColorSlotMorph(t){this.init(t)}function BlockHighlightMorph(){this.threadCount=0,this.init()}function MultiArgMorph(t,e,o,r,i,n,s,h,a){this.init(t,e,o,r,i,n,s,h,a)}function ArgLabelMorph(t,e){this.init(t,e)}function FunctionSlotMorph(t){this.init(t)}function ReporterSlotMorph(t){this.init(t)}function RingReporterSlotMorph(t){this.init(t)}function CommentMorph(t){this.init(t)}function ScriptFocusMorph(t,e,o){this.init(t,e,o)}modules.blocks="2019-July-09",SyntaxElementMorph.prototype=new Morph,(SyntaxElementMorph.prototype.constructor=SyntaxElementMorph).uber=Morph.prototype,SyntaxElementMorph.prototype.setScale=function(t){var e=Math.min(Math.max(t,1),25);this.scale=e,this.corner=3*e,this.rounding=9*e,this.edge=1.000001*e,this.inset=6*e,this.hatHeight=12*e,this.hatWidth=70*e,this.rfBorder=3*e,this.minWidth=0,this.dent=8*e,this.bottomPadding=3*e,this.cSlotPadding=4*e,this.typeInPadding=e,this.labelPadding=4*e,this.labelFontName="Verdana",this.labelFontStyle="sans-serif",this.fontSize=10*e,this.embossing=new Point(-1*Math.max(e/2,1),-1*Math.max(e/2,1)),this.labelWidth=450*e,this.labelWordWrap=!0,this.dynamicInputLabels=!0,this.feedbackColor=new Color(255,255,255),this.feedbackMinHeight=5,this.minSnapDistance=20,this.reporterDropFeedbackPadding=10*e,this.contrast=65,this.labelContrast=25,this.activeHighlight=new Color(153,255,213),this.errorHighlight=new Color(173,15,0),this.activeBlur=20,this.activeBorder=4,this.rfColor=new Color(120,120,120)},SyntaxElementMorph.prototype.setScale(1),SyntaxElementMorph.prototype.isCachingInputs=!1,SyntaxElementMorph.prototype.init=function(t){this.cachedClr=null,this.cachedClrBright=null,this.cachedClrDark=null,this.cachedNormalColor=null,this.isStatic=!1,SyntaxElementMorph.uber.init.call(this,t),this.defaults=[],this.cachedInputs=null},SyntaxElementMorph.prototype.parts=function(){var e=null;return this.nextBlock&&(e=this.nextBlock()),this.children.filter(function(t){return!(t===e||t instanceof ShadowMorph||t instanceof BlockHighlightMorph)})},SyntaxElementMorph.prototype.inputs=function(){return!isNil(this.cachedInputs)&&this.isCachingInputs||(this.cachedInputs=this.parts().filter(function(t){return t instanceof SyntaxElementMorph})),this.cachedInputs},SyntaxElementMorph.prototype.debugCachedInputs=function(){var t,e;if(isNil(this.cachedInputs)||(t=this.parts().filter(function(t){return t instanceof SyntaxElementMorph})),this.cachedInputs.length!==t.length)throw new Error("cached inputs size do not match: "+this.constructor.name);for(e=0;e<t.length;e+=1)if(this.cachedInputs[e]!==t[e])throw new Error("cached input does not match: "+this.constructor.name+" #"+e+" "+this.cachedInputs[e].constructor.name+" != "+t[e].constructor.name)},SyntaxElementMorph.prototype.allInputs=function(){var e=this;return this.allChildren().slice(0).reverse().filter(function(t){return t instanceof ArgMorph||t instanceof ReporterBlockMorph&&t!==e})},SyntaxElementMorph.prototype.allEmptySlots=function(){var e=[];return this instanceof RingMorph||"reportJSFunction"===this.selector||this.children.forEach(function(t){t.isEmptySlot&&t.isEmptySlot()?e.push(t):t.allEmptySlots&&(e=e.concat(t.allEmptySlots()))}),e},SyntaxElementMorph.prototype.tagExitBlocks=function(e,o){"doReport"===this.selector?this.partOfCustomCommand=o:"doStopThis"===this.selector?this.exitTag=e:this instanceof RingMorph||this.children.forEach(function(t){t.tagExitBlocks&&t.tagExitBlocks(e,o)})},SyntaxElementMorph.prototype.replaceInput=function(e,t){var o=this.parentThatIsA(ScriptsMorph),r=t,i=this.children.indexOf(e),n=0;if(-1===i&&t instanceof MultiArgMorph&&this.children.forEach(function(t){t instanceof ArgLabelMorph&&t.argMorph()===e&&(i=n),n+=1}),-1===i||null===o)return null;e.cachedSlotSpec&&(e.cachedSlotSpec=null),t.cachedSlotSpec&&(t.cachedSlotSpec=null),this.startLayout(),t.parent&&t.parent.removeChild(t),e instanceof MultiArgMorph&&(e.inputs().forEach(function(t){e.replaceInput(t,new InputSlotMorph)}),this.dynamicInputLabels&&(r=new ArgLabelMorph(t))),(r.parent=this).children[i]=r,e instanceof ReporterBlockMorph&&(e instanceof RingMorph&&!(e instanceof RingMorph&&e.contents())||(o.add(e),e.moveBy(r.extent()),e.fixBlockColor())),r instanceof MultiArgMorph||r instanceof ArgLabelMorph||r.constructor===CommandSlotMorph?(r.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):(r.drawNew(),this.fixLayout()),this.cachedInputs=null,this.endLayout()},SyntaxElementMorph.prototype.silentReplaceInput=function(t,e){var o,r=this.children.indexOf(t);-1!==r&&(t.cachedSlotSpec&&(t.cachedSlotSpec=null),e.cachedSlotSpec&&(e.cachedSlotSpec=null),e.parent&&e.parent.removeChild(e),(((o=t instanceof MultiArgMorph&&this.dynamicInputLabels?new ArgLabelMorph(e):e).parent=this).children[r]=o)instanceof MultiArgMorph||o instanceof ArgLabelMorph||o.constructor===CommandSlotMorph?(o.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):(o.drawNew(),this.fixLayout()),this.cachedInputs=null)},SyntaxElementMorph.prototype.revertToDefaultInput=function(t,e){var o,r=this.parts().indexOf(t),i=this.inputs().indexOf(t),n=new InputSlotMorph;-1!==r&&(this instanceof BlockMorph?(n=this.labelPart(this.parseSpec(this.blockSpec)[r]),this.isCustomBlock&&(o=this.isGlobal?this.definition:this.scriptTarget().getMethod(this.blockSpec),n instanceof InputSlotMorph&&n.setChoices.apply(n,o.inputOptionsOfIdx(i)),(n instanceof InputSlotMorph||n instanceof BooleanSlotMorph)&&n.setContents(o.defaultValueOfInputIdx(i)))):this instanceof MultiArgMorph?n=this.labelPart(this.slotSpec):this instanceof ReporterSlotMorph&&(n=this.emptySlot())),e||-1!==i&&(n instanceof MultiArgMorph?(n.setContents(this.defaults),n.defaults=this.defaults):isNil(this.defaults[i])||n.setContents(this.defaults[i])),this.silentReplaceInput(t,n),n instanceof MultiArgMorph?n.refresh():n instanceof RingMorph&&n.fixBlockColor(),this.cachedInputs=null},SyntaxElementMorph.prototype.isLocked=function(){return this.isStatic},SyntaxElementMorph.prototype.topBlock=function(){return this.parent&&this.parent.topBlock?this.parent.topBlock():this},SyntaxElementMorph.prototype.getVarNamesDict=function(){var t,e,o=this.parentThatIsA(BlockMorph),r=[];return o?(t=o.scriptTarget(),o.allParents().forEach(function(t){t instanceof PrototypeHatBlockMorph?(r.push.apply(r,t.variableNames()),r.push.apply(r,t.inputs()[0].inputFragmentNames())):t instanceof BlockMorph&&t.inputs().forEach(function(t){t.allChildren().forEach(function(t){t instanceof TemplateSlotMorph?r.push(t.contents()):t instanceof MultiArgMorph&&t.children.forEach(function(t){t instanceof TemplateSlotMorph&&r.push(t.contents())})})})}),t?(e=t.variables.allNamesDict(),r.forEach(function(t){e[t]=t}),"doSetVar"===o.selector&&(e["~"]=null,e.my={anchor:["anchor"],parent:["parent"],name:["name"],"dangling?":["dangling?"],"draggable?":["draggable?"],"rotation style":["rotation style"],"rotation x":["rotation x"],"rotation y":["rotation y"]},16===this.world().currentKey&&(e.my["~"]=null,e.my["microphone modifier"]=["microphone modifier"])),e):{}):{}},SyntaxElementMorph.prototype.refactorVarInStack=function(e,o,t){var r;this instanceof RingMorph&&contains(this.inputNames(),e)||!t&&this.definesScriptVariable(e)||("reportGetVar"===this.selector&&this.blockSpec===e&&(this.setSpec(o),this.fullChanged(),this.fixLabelColor()),"getVarNamesDict"===this.choices&&this.contents().text===e&&this.setContents(o),this instanceof CustomCommandBlockMorph&&this.definition.body&&isNil(this.definition.declarations.get(e))&&!contains(this.definition.variableNames,e)&&this.definition.body.expression.refactorVarInStack(e,o),this.inputs().forEach(function(t){t.refactorVarInStack(e,o)}),!this.nextBlock||(r=this.nextBlock())&&r.refactorVarInStack(e,o))},SyntaxElementMorph.prototype.definesScriptVariable=function(e){return("doDeclareVariables"===this.selector||this.blockSpec&&this.blockSpec.match("%upvar"))&&detect(this.inputs()[0].allInputs(),function(t){return"reportGetVar"===t.selector&&t.blockSpec===e})},SyntaxElementMorph.prototype.selectForEdit=function(){var t,e=this.parentThatIsA(ScriptsMorph),o=this.parentThatIsA(IDE_Morph),r=o?o.currentSprite:null;return e&&r&&r.inheritsAttribute("scripts")?(this.selectionID=!0,r.shadowAttribute("scripts"),t=detect(r.scripts.allChildren(),function(t){return t.selectionID}),delete this.selectionID,delete t.selectionID,t):this},SyntaxElementMorph.prototype.reactToGrabOf=function(t){var e,o=this.topBlock();t instanceof CommandBlockMorph&&(e=this.parentThatIsA(CommandSlotMorph,ReporterSlotMorph))&&(this.startLayout(),e.fixLayout(),this.endLayout()),o&&(o.allComments().forEach(function(t){t.align(o)}),o.getHighlight()&&o.addHighlight(o.removeHighlight()))},SyntaxElementMorph.prototype.bright=function(){return this.color.lighter(this.contrast).toString()},SyntaxElementMorph.prototype.dark=function(){return this.color.darker(this.contrast).toString()},SyntaxElementMorph.prototype.setColor=function(t,e){t&&(this.color.eq(t)||(this.color=t,e||this.drawNew(),this.children.forEach(function(t){e&&!(t instanceof TemplateSlotMorph)||t instanceof BlockHighlightMorph||(t.drawNew(),t.changed())}),this.changed()))},SyntaxElementMorph.prototype.setLabelColor=function(e,o,r){this.children.forEach(function(t){t instanceof StringMorph&&!t.isProtectedLabel?(t.shadowOffset=r||t.shadowOffset,t.shadowColor=o||t.shadowColor,t.setColor(e)):t instanceof MultiArgMorph||t instanceof ArgLabelMorph||t instanceof SymbolMorph&&!t.isProtectedLabel||t instanceof InputSlotMorph&&t.isReadOnly?t.setLabelColor(e,o,r):t.isLoop&&t.loop().setLabelColor(e,o,r)})},SyntaxElementMorph.prototype.flash=function(){this.cachedNormalColor||(this.cachedNormalColor=this.color,this.setColor(this.activeHighlight))},SyntaxElementMorph.prototype.unflash=function(){var t;this.cachedNormalColor&&(t=this.cachedNormalColor,this.cachedNormalColor=null,this.setColor(t))},SyntaxElementMorph.prototype.fixBlockColor=function(e,o){this.children.forEach(function(t){t instanceof SyntaxElementMorph&&t.fixBlockColor(e,o)})},SyntaxElementMorph.prototype.labelPart=function(t){var e,o;if("%"===t[0]&&1<t.length&&("reportGetVar"!==this.selector||"%turtleOutline"===t&&this.isObjInputFragment())){if(5<t.length&&"%mult"===t.slice(0,5))return(e=new MultiArgMorph(t.slice(5))).addInput(),e;switch(t){case"%imgsource":(e=new InputSlotMorph(null,!1,{"pen trails":["pen trails"],"stage image":["stage image"]},!0)).setContents(["pen trails"]);break;case"%inputs":(e=new MultiArgMorph("%s","with inputs")).isStatic=!1,e.canBeEmpty=!1;break;case"%scriptVars":(e=new MultiArgMorph("%t",null,1,t)).canBeEmpty=!1;break;case"%blockVars":(e=new MultiArgMorph("%t","block variables",0,t)).canBeEmpty=!1;break;case"%parms":(e=new MultiArgMorph("%t","Input Names:",0,t)).canBeEmpty=!1;break;case"%ringparms":e=new MultiArgMorph("%t","input names:",0,t);break;case"%cmdRing":(e=new RingMorph).color=SpriteMorph.prototype.blockColor.other,e.selector="reifyScript",e.setSpec("%rc %ringparms"),e.isDraggable=!0;break;case"%repRing":(e=new RingMorph).color=SpriteMorph.prototype.blockColor.other,e.selector="reifyReporter",e.setSpec("%rr %ringparms"),e.isDraggable=!0,e.isStatic=!0;break;case"%predRing":(e=new RingMorph(!0)).color=SpriteMorph.prototype.blockColor.other,e.selector="reifyPredicate",e.setSpec("%rp %ringparms"),e.isDraggable=!0,e.isStatic=!0;break;case"%words":(e=new MultiArgMorph("%s",null,0)).addInput(),e.addInput(),e.isStatic=!1;break;case"%exp":(e=new MultiArgMorph("%s",null,0)).addInput(),e.isStatic=!0,e.canBeEmpty=!1;break;case"%br":(e=new Morph).setExtent(new Point(0,0)),e.isBlockLabelBreak=!0,e.getSpec=function(){return"%br"};break;case"%inputName":(e=new ReporterBlockMorph).category="variables",e.color=SpriteMorph.prototype.blockColor.variables,e.setSpec(localize("Input name"));break;case"%s":e=new InputSlotMorph;break;case"%anyUE":(e=new InputSlotMorph).isUnevaluated=!0;break;case"%txt":(e=new InputSlotMorph).minWidth=1.7*e.height(),e.fixLayout();break;case"%mlt":(e=new TextSlotMorph).fixLayout();break;case"%code":(e=new TextSlotMorph).contents().fontName="monospace",e.contents().fontStyle="monospace",e.fixLayout();break;case"%obj":e=new ArgMorph("object");break;case"%n":e=new InputSlotMorph(null,!0);break;case"%dir":(e=new InputSlotMorph(null,!0,{"§_dir":null,"(90) right":90,"(-90) left":-90,"(0) up":"0","(180) down":180,random:["random"]})).setContents(90);break;case"%note":e=new InputSlotMorph(null,!0,"pianoKeyboardMenu",!1);break;case"%inst":(e=new InputSlotMorph(null,!0,{"(1) sine":1,"(2) square":2,"(3) sawtooth":3,"(4) triangle":4})).setContents(1);break;case"%audio":e=new InputSlotMorph(null,!1,"audioMenu",!0);break;case"%aa":e=new InputSlotMorph(null,!1,{name:["name"],duration:["duration"],length:["length"],"number of channels":["number of channels"],"sample rate":["sample rate"],samples:["samples"]},!0);break;case"%img":e=new InputSlotMorph(null,!1,{name:["name"],width:["width"],height:["height"],pixels:["pixels"]},!0);break;case"%rate":(e=new InputSlotMorph(null,!0,{"22.05 kHz":22050,"44.1 kHz":44100,"88.2 kHz":88200,"96 kHz":96e3})).setContents(1);break;case"%month":e=new InputSlotMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},!0);break;case"%interaction":(e=new InputSlotMorph(null,!1,{clicked:["clicked"],pressed:["pressed"],dropped:["dropped"],"mouse-entered":["mouse-entered"],"mouse-departed":["mouse-departed"],"scrolled-up":["scrolled-up"],"scrolled-down":["scrolled-down"],stopped:["stopped"]},!0)).isStatic=!0;break;case"%dates":(e=new InputSlotMorph(null,!1,{year:["year"],month:["month"],date:["date"],"day of week":["day of week"],hour:["hour"],minute:["minute"],second:["second"],"time in milliseconds":["time in milliseconds"]},!0)).setContents(["date"]);break;case"%delim":e=new InputSlotMorph(null,!1,{letter:["letter"],word:["word"],line:["line"],tab:["tab"],cr:["cr"],csv:["csv"],json:["json"]},!1);break;case"%ida":(e=new InputSlotMorph(null,!0,{1:1,last:["last"],"~":null,all:["all"]})).setContents(1);break;case"%idx":(e=new InputSlotMorph(null,!0,{1:1,last:["last"],any:["any"]})).setContents(1);break;case"%rel":e=new InputSlotMorph(null,!1,{distance:["distance"],direction:["direction"]},!0);break;case"%loc":e=new InputSlotMorph(null,!1,"locationMenu",!0);break;case"%spr":e=new InputSlotMorph(null,!1,"objectsMenu",!0);break;case"%self":e=new InputSlotMorph(null,!1,"objectsMenuWithSelf",!0);break;case"%col":e=new InputSlotMorph(null,!1,"collidablesMenu",!0);break;case"%dst":e=new InputSlotMorph(null,!1,"distancesMenu",!0);break;case"%pin":e=new InputSlotMorph(null,!1,{0:[0],2:[2],3:[3],4:[4],5:[5],6:[6],7:[7],8:[8],9:[9],10:[10],11:[11],12:[12],13:[13],14:[14],16:[16]},!0);break;case"%onoff":e=new InputSlotMorph(null,!1,{gpio_on:["gpio_on"],gpio_off:["gpio_off"]},!0);break;case"%motor":e=new InputSlotMorph(null,!1,{Left:"Left",Right:"Right"},!0);break;case"%direction":e=new InputSlotMorph(null,!1,{Forward:"Forward",Backward:"Backward"},!0);break;case"%directionboth":e=new InputSlotMorph(null,!1,{Forward:"Forward",Backward:"Backward",Forward_Backward:"Forward_Backward",Backward_Forward:"Backward_Forward"},!0);break;case"%analogPin":e=new InputSlotMorph(null,!1,{0:[0],1:[1],2:[2],3:[3]},!0);break;case"%pwmPin":e=new InputSlotMorph(null,!1,{5:["gpio_pwm_5"],10:["gpio_pwm_10"],16:["gpio_pwm_16"]},!0);break;case"%cln":e=new InputSlotMorph(null,!1,"clonablesMenu",!0);break;case"%get":(e=new InputSlotMorph(null,!1,"gettablesMenu",!0)).isStatic=!0;break;case"%cst":e=new InputSlotMorph(null,!1,"costumesMenu",!0);break;case"%eff":(e=new InputSlotMorph(null,!1,{color:["color"],saturation:["saturation"],brightness:["brightness"],ghost:["ghost"],fisheye:["fisheye"],whirl:["whirl"],pixelate:["pixelate"],mosaic:["mosaic"],negative:["negative"]},!0)).setContents(["ghost"]);break;case"%snd":e=new InputSlotMorph(null,!1,"soundsMenu",!0);break;case"%key":(e=new InputSlotMorph(null,!1,{"any key":["any key"],"up arrow":["up arrow"],"down arrow":["down arrow"],"right arrow":["right arrow"],"left arrow":["left arrow"],space:["space"],"+":["+"],"-":["-"],a:["a"],b:["b"],c:["c"],d:["d"],e:["e"],f:["f"],g:["g"],h:["h"],i:["i"],j:["j"],k:["k"],l:["l"],m:["m"],n:["n"],o:["o"],p:["p"],q:["q"],r:["r"],s:["s"],t:["t"],u:["u"],v:["v"],w:["w"],x:["x"],y:["y"],z:["z"],0:["0"],1:["1"],2:["2"],3:["3"],4:["4"],5:["5"],6:["6"],7:["7"],8:["8"],9:["9"]},!0)).setContents(["space"]);break;case"%keyHat":(e=this.labelPart("%key")).isStatic=!0;break;case"%msg":e=new InputSlotMorph(null,!1,"messagesMenu",!0);break;case"%msgHat":(e=new InputSlotMorph(null,!1,"messagesReceivedMenu",!0)).isStatic=!0;break;case"%att":e=new InputSlotMorph(null,!1,"attributesMenu",!0);break;case"%fun":(e=new InputSlotMorph(null,!1,{abs:["abs"],neg:["neg"],ceiling:["ceiling"],floor:["floor"],sqrt:["sqrt"],sin:["sin"],cos:["cos"],tan:["tan"],asin:["asin"],acos:["acos"],atan:["atan"],ln:["ln"],log:["log"],lg:["lg"],"e^":["e^"],"10^":["10^"],"2^":["2^"]},!0)).setContents(["sqrt"]);break;case"%layer":(e=new InputSlotMorph(null,!1,{front:["front"],back:["back"]},!0)).setContents(["front"]);break;case"%hsva":(e=new InputSlotMorph(null,!1,{hue:["hue"],saturation:["saturation"],brightness:["brightness"],transparency:["transparency"]},!0)).setContents(["hue"]);break;case"%pen":(e=new InputSlotMorph(null,!1,{size:["size"],hue:["hue"],saturation:["saturation"],brightness:["brightness"],transparency:["transparency"]},!0)).setContents(["hue"]);break;case"%asp":(e=new InputSlotMorph(null,!1,{hue:["hue"],saturation:["saturation"],brightness:["brightness"],transparency:["transparency"],"~":null,sprites:["sprites"]},!0)).setContents(["hue"]);break;case"%txtfun":(e=new InputSlotMorph(null,!1,{"encode URI":["encode URI"],"decode URI":["decode URI"],"encode URI component":["encode URI component"],"decode URI component":["decode URI component"],"XML escape":["XML escape"],"XML unescape":["XML unescape"],"hex sha512 hash":["hex sha512 hash"]},!0)).setContents(["encode URI"]);break;case"%stopChoices":(e=new InputSlotMorph(null,!1,{all:["all"],"this script":["this script"],"this block":["this block"],"all but this script":["all but this script"],"other scripts in sprite":["other scripts in sprite"]},!0)).setContents(["all"]),e.isStatic=!0;break;case"%setting":(e=new InputSlotMorph(null,!1,{"turbo mode":["turbo mode"],"flat line ends":["flat line ends"],"video capture":["video capture"],"mirror video":["mirror video"]},!0)).setContents(["turbo mode"]),e.isStatic=!0;break;case"%typ":(e=new InputSlotMorph(null,!1,"typesMenu",!0)).setContents(["number"]);break;case"%mapValue":(e=new InputSlotMorph(null,!1,{String:["String"],Number:["Number"],true:["true"],false:["false"]},!0)).setContents(["String"]),e.isStatic=!0;break;case"%var":(e=new InputSlotMorph(null,!1,"getVarNamesDict",!0)).isStatic=!0;break;case"%shd":e=new InputSlotMorph(null,!1,"shadowedVariablesMenu",!0);break;case"%lst":e=new InputSlotMorph(null,!1,{list1:"list1",list2:"list2",list3:"list3"},!0);break;case"%codeKind":(e=new InputSlotMorph(null,!1,{code:["code"],header:["header"]},!0)).setContents(["code"]);break;case"%l":e=new ArgMorph("list");break;case"%b":e=new BooleanSlotMorph;break;case"%boolUE":(e=new BooleanSlotMorph).isUnevaluated=!0;break;case"%bool":(e=new BooleanSlotMorph(!0)).isStatic=!0;break;case"%cmd":e=new CommandSlotMorph;break;case"%rc":(e=new RingCommandSlotMorph).isStatic=!0;break;case"%rr":(e=new RingReporterSlotMorph).isStatic=!0;break;case"%rp":(e=new RingReporterSlotMorph(!0)).isStatic=!0;break;case"%c":(e=new CSlotMorph).isStatic=!0;break;case"%cs":e=new CSlotMorph;break;case"%ca":(e=new CSlotMorph).isLoop=!0,e.add(this.labelPart("%loopArrow"));break;case"%cl":(e=new CSlotMorph).isStatic=!0,e.isLambda=!0;break;case"%cla":(e=new CSlotMorph).isStatic=!0,e.isLambda=!0,e.isLoop=!0,e.add(this.labelPart("%loopArrow"));break;case"%loop":(e=new CSlotMorph).isStatic=!0,e.isLoop=!0,e.add(this.labelPart("%loopArrow"));break;case"%loopArrow":(e=new SymbolMorph("loop")).size=.7*this.fontSize,e.color=new Color(255,255,255),e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%clr":(e=new ColorSlotMorph).isStatic=!0;break;case"%t":e=new TemplateSlotMorph("a");break;case"%upvar":e=new TemplateSlotMorph("");break;case"%f":e=new FunctionSlotMorph;break;case"%r":e=new ReporterSlotMorph;break;case"%p":e=new ReporterSlotMorph(!0);break;case"%codeListPart":e=new InputSlotMorph(null,!1,{list:["list"],item:["item"],delimiter:["delimiter"]},!0);break;case"%codeListKind":e=new InputSlotMorph(null,!1,{collection:["collection"],variables:["variables"],parameters:["parameters"]},!0);break;case"%turtle":(e=new SymbolMorph("turtle")).size=1.2*this.fontSize,e.color=new Color(255,255,255),e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%turtleOutline":(e=new SymbolMorph("turtleOutline")).size=this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%clockwise":(e=new SymbolMorph("turnRight")).size=1.5*this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!1,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%counterclockwise":(e=new SymbolMorph("turnLeft")).size=1.5*this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!1,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%greenflag":(e=new SymbolMorph("flag")).size=1.5*this.fontSize,e.color=new Color(0,200,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%stop":(e=new SymbolMorph("octagon")).size=1.5*this.fontSize,e.color=new Color(200,0,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%pause":(e=new SymbolMorph("pause")).size=this.fontSize,e.color=new Color(255,220,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%blitz":(e=new SymbolMorph("flash")).size=this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!1,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%vid":(e=new InputSlotMorph(null,!1,{snap:["snap"],motion:["motion"],direction:["direction"]},!0)).setContents(["motion"]);break;case"%on":e=new InputSlotMorph(null,!1,{"this sprite":["this sprite"],stage:["stage"]},!0);break;default:nop()}}else"$"===t[0]&&1<t.length&&"reportGetVar"!==this.selector?(o=t.slice(1).split("-"),contains(SymbolMorph.prototype.names,o[0])?(e=new SymbolMorph(o[0])).size=this.fontSize*(+o[1]||1.2):((e=new StringMorph(o[0])).fontName=this.labelFontName,e.fontStyle=this.labelFontStyle,e.fontSize=this.fontSize*(+o[1]||1)),e.color=new Color(0==+o[2]?0:+o[2]||255,0==+o[3]?0:+o[3]||255,0==+o[4]?0:+o[4]||255),e.isProtectedLabel=2<o.length,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew()):e=new StringMorph(t,this.fontSize,this.labelFontStyle,!0,!1,!1,MorphicPreferences.isFlat?new Point:this.embossing,this.color.darker(this.labelContrast),new Color(255,255,255),this.labelFontName);return e},SyntaxElementMorph.prototype.isObjInputFragment=function(){return"reportGetVar"===this.selector&&"%t"===this.getSlotSpec()&&"%obj"===this.parent.fragment.type},SyntaxElementMorph.prototype.fixLayout=function(t){var e,o,r,i,n,s=this.parts(),h=this,a=0,l=0,p=0,c=this.minWidth,d=[],u=[],f=this.isPrototype?1:Math.floor(fontHeight(this.fontSize)/3),g=this instanceof BlockMorph&&this.hasLocationPin()?this.methodIconExtent().x+f:0,m=!1,M=!1,S=this.extent();if(this instanceof MultiArgMorph&&"%cs"!==this.slotSpec?c+=this.arrows().width():c+=this instanceof ReporterBlockMorph?2*this.rounding+2*this.edge:4*this.corner+2*this.edge+3*this.inset+this.dent,this.nextBlock&&(e=this.nextBlock()),s.forEach(function(t){t instanceof CSlotMorph||"%cs"===t.slotSpec?0<d.length?(u.push(d),u.push([t]),d=[],a=0):u.push([t]):t instanceof BlockHighlightMorph?nop():(t.isVisible&&(a+=t.fullBounds().width()+f),(a>h.labelWidth||t.isBlockLabelBreak)&&0<d.length&&(u.push(d),d=[],a=t.fullBounds().width()+f),d.push(t),t.isBlockLabelBreak&&(a=0))}),0<d.length&&u.push(d),this instanceof CommandBlockMorph?(o=this.top()+this.corner+this.edge,this instanceof HatBlockMorph&&(o+=this.hatHeight)):this instanceof ReporterBlockMorph?o=this.top()+2*this.edge:(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)&&(o=this.top(),"%cs"===this.slotSpec&&0<this.inputs().length&&(o-=this.rounding)),u.forEach(function(t){m=m&&!(M=!0),a=h.left()+g+h.edge+h.labelPadding,h instanceof RingMorph?a=h.left()+f:h.isPredicate?a=h.left()+g+h.rounding:(h instanceof MultiArgMorph||h instanceof ArgLabelMorph)&&(a=h.left()),o+=l,l=0,t.forEach(function(t){t.isLoop&&(m=!0),l=t instanceof CSlotMorph?(a-=h.labelPadding,h.isPredicate&&(a=h.left()+g+h.rounding),t.setColor(h.color),t.setPosition(new Point(a,o)),t.height()):t instanceof MultiArgMorph&&"%cs"===t.slotSpec?(h.isPredicate&&(a+=h.corner),t.setPosition(new Point(a,o)),t.height()):(t.setPosition(new Point(a,o)),t.isBlockLabelBreak||("%c"===t.slotSpec||"%loop"===t.slotSpec?a+=t.width():t.isVisible&&(a+=t.fullBounds().width()+f)),p=Math.max(p,a),Math.max(l,t instanceof StringMorph?t.rawHeight():t.height()))}),M&&(a+=1.5*h.fontSize,p=Math.max(p,a),M=!1),t.forEach(function(t){t.moveBy(new Point(0,Math.floor((l-t.height())/2)))})}),o+=l,this.children.some(function(t){return t instanceof CSlotMorph})&&(n=this.bottomPadding,this instanceof ReporterBlockMorph&&!this.isPredicate&&(n=Math.max(this.bottomPadding,this.rounding-this.bottomPadding)),o+=n),this instanceof CommandBlockMorph?r=o-this.top()+2*this.corner:this instanceof ReporterBlockMorph?r=o-this.top()+2*this.edge:(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)&&(r=o-this.top()),this.isPredicate?c=Math.max(c,p-this.left()+this.rounding):this instanceof MultiArgMorph&&"%cs"!==this.slotSpec||this instanceof ArgLabelMorph?c=Math.max(c,p-this.left()-f):(c=Math.max(c,p-this.left()+this.labelPadding-this.edge),s[s.length-1]instanceof MultiArgMorph&&1===u.length&&(c-=f),this instanceof HatBlockMorph&&(c=Math.max(c,1.5*this.hatWidth))),this.silentSetExtent(new Point(c,r)),s.forEach(function(e){var o=0;(e instanceof CSlotMorph||"%cs"===e.slotSpec)&&(o=h.isPredicate?(e.setWidth(c-g-h.rounding-h.inset-h.corner),h.corner):(e.setWidth(c-h.edge-g),h.corner+h.edge)),"%cs"===e.slotSpec&&e.inputs().forEach(function(t){t.setWidth(e.right()-t.left()-o)})}),t||this.drawNew(),e&&e.setPosition(new Point(this.left(),this.bottom()-this.corner)),this instanceof CommandBlockMorph){if(this.height()!==S.y&&(i=this.parentThatIsA(CommandSlotMorph,ReporterSlotMorph))&&i.fixLayout(),this.width()!==S.x&&(i=this.parentThatIsA(ReporterBlockMorph,CommandSlotMorph,RingCommandSlotMorph,ReporterSlotMorph))&&i.fixLayout(),i)return}else if(this instanceof ReporterBlockMorph&&this.parent&&this.parent.fixLayout)return this.parent.fixLayout();this.fixHighlight()},SyntaxElementMorph.prototype.fixHighlight=function(){var t=this.topBlock();t.getHighlight&&t.getHighlight()&&t.addHighlight(t.removeHighlight())},SyntaxElementMorph.prototype.methodIconExtent=function(){var t=1.2*this.fontSize;return this.hasLocationPin()?new Point(.66*t,t):new Point(0,0)},SyntaxElementMorph.prototype.evaluate=function(){return null},SyntaxElementMorph.prototype.isEmptySlot=function(){return!1},SyntaxElementMorph.prototype.showBubble=function(t,e,o){var r,i,n,s,h=!1,a=this.parentThatIsA(IDE_Morph),l=this,p=this.rightCenter().add(new Point(2,0)),c=this.parentThatIsA(ScrollFrameMorph),d=this.world();if(void 0===t||!d)return null;t instanceof ListWatcherMorph?((s=t).update(!0),s.step=t.update,s.isDraggable=!1,s.expand(this.parentThatIsA(ScrollFrameMorph).extent()),h=!0):t instanceof TableFrameMorph?((s=t).isDraggable=!1,s.expand(this.parentThatIsA(ScrollFrameMorph).extent()),h=!0):t instanceof Morph?isSnapObject(t)?(n=t.thumbnail(new Point(40,40)),(s=new Morph).silentSetWidth(n.width),s.silentSetHeight(n.height),s.image=n,s.version=t.version,s.step=function(){this.version!==t.version&&(n=t.thumbnail(new Point(40,40)),this.image=n,this.version=t.version,this.changed())}):(n=t.fullImage(),(s=new Morph).silentSetWidth(n.width),s.silentSetHeight(n.height),s.image=n):t instanceof Costume?(n=t.thumbnail(new Point(40,40)),(s=new Morph).silentSetWidth(n.width),s.silentSetHeight(n.height),s.image=n):t instanceof Sound?s=new SymbolMorph("notes",30):t instanceof Context?(n=t.image(),(s=new Morph).silentSetWidth(n.width),s.silentSetHeight(n.height),s.image=n):"boolean"==typeof t?s=SpriteMorph.prototype.booleanMorph.call(null,t):isString(t)?(i=500<t.length?t.slice(0,500)+"...":t,s=new TextMorph(i,this.fontSize)):null===t?s=new TextMorph("",this.fontSize):0===t?s=new TextMorph("0",this.fontSize):t.toString&&(s=new TextMorph(t.toString(),this.fontSize)),a&&a.currentSprite!==o&&(o instanceof StageMorph?l=a.corral.stageIcon:o?(o.isTemporary&&(o=detect(o.allExemplars(),function(t){return!t.isTemporary})),l=detect(a.corral.frame.contents.children,function(t){return t.object===o})):o=a,p=l.center()),(r=new SpeechBubbleMorph(s,null,Math.max(this.rounding-2,6),0)).popUp(d,p,h),e&&this.exportPictureWithResult(r),l instanceof SpriteIconMorph?r.keepWithin(a.corral):c&&r.keepWithin(c)},SyntaxElementMorph.prototype.exportPictureWithResult=function(t){var e=this.parentThatIsA(IDE_Morph)||this.parentThatIsA(BlockEditorMorph).target.parentThatIsA(IDE_Morph),o=this.fullImage(),r=t.fullImageClassic(),i=Math.max(0,r.height-o.height),n=newCanvas(new Point(o.width+r.width+2,o.height+i)),s=n.getContext("2d");s.drawImage(o,0,n.height-o.height),s.drawImage(r,o.width+2,0),e.saveCanvasAs(n,(e.projectName||localize("untitled"))+" "+localize("script pic"))},SyntaxElementMorph.prototype.mappedCode=function(t){var e=this.evaluate();return e instanceof BlockMorph?e.mappedCode(t):e},SyntaxElementMorph.prototype.startLayout=function(){this.topBlock().fullChanged(),Morph.prototype.trackChanges=!1},SyntaxElementMorph.prototype.endLayout=function(){Morph.prototype.trackChanges=!0,this.topBlock().fullChanged()},BlockMorph.prototype=new SyntaxElementMorph,(BlockMorph.prototype.constructor=BlockMorph).uber=SyntaxElementMorph.prototype,BlockMorph.prototype.isCachingInputs=!0,BlockMorph.prototype.zebraContrast=40,BlockMorph.prototype.snapSound=null,BlockMorph.prototype.toggleSnapSound=function(){null!==this.snapSound?this.snapSound=null:(BlockMorph.prototype.snapSound=document.createElement("audio"),BlockMorph.prototype.snapSound.src="assets/apps/snap/src/click.wav"),CommentMorph.prototype.snapSound=BlockMorph.prototype.snapSound},BlockMorph.prototype.init=function(t){this.selector=null,this.blockSpec="",this.comment=null,this.instantiationSpec=null,this.category=null,this.isCorpse=!1,BlockMorph.uber.init.call(this,t),this.color=new Color(0,17,173),this.cachedInputs=null},BlockMorph.prototype.scriptTarget=function(){var t,e=this.parentThatIsA(ScriptsMorph);if(e)return e.scriptTarget();if(t=this.parentThatIsA(IDE_Morph))return t.currentSprite;throw new Error("script target cannot be found for orphaned block")},BlockMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+' ("'+this.blockSpec.slice(0,30)+'...")'},BlockMorph.prototype.parseSpec=function(t){var o=[],r="",e=isString(t)?t.split(" "):[];if(0===e.length&&(e=[t]),this.labelWordWrap)return e;return e.forEach(function(t){var e;"%"===(e=t)[0]&&1<e.length?(""!==r&&(o.push(r),r=""),o.push(e)):""!==r?r+=" "+e:r=e}),""!==r&&o.push(r),o},BlockMorph.prototype.setSpec=function(t,e,r){var i,n=this,s=-1;t&&(this.parts().forEach(function(t){t.destroy()}),this.isPrototype&&this.add(this.placeHolder()),this.parseSpec(t).forEach(function(t,e,o){"%"===t[0]&&"%br"!==t&&(s+=1),i=n.labelPart(t),isNil(i)||(n.add(i),i instanceof CommandSlotMorph||i instanceof StringMorph||i.drawNew(),i instanceof RingMorph&&i.fixBlockColor(),(i instanceof MultiArgMorph||i.constructor===CommandSlotMorph||i.constructor===RingCommandSlotMorph)&&i.fixLayout(),n.isPrototype&&n.add(n.placeHolder()),i instanceof InputSlotMorph&&n.isCustomBlock&&i.setChoices.apply(i,(r||n.definition).inputOptionsOfIdx(s)))}),this.blockSpec=t,this.fixLayout(e),this.cachedInputs=null)},BlockMorph.prototype.userSetSpec=function(t){var e=this.topBlock();e.fullChanged(),this.setSpec(t),e.fullChanged()},BlockMorph.prototype.buildSpec=function(){var e=this;this.blockSpec="",this.parts().forEach(function(t){t instanceof StringMorph?e.blockSpec+=t.text:t instanceof ArgMorph||t.isBlockLabelBreak?e.blockSpec+=t.getSpec():e.blockSpec+="[undefined]",e.blockSpec+=" "}),this.blockSpec=this.blockSpec.trim()},BlockMorph.prototype.rebuild=function(e){this.setSpec(this.blockSpec),e&&this.inputs().forEach(function(t){t instanceof ReporterBlockMorph&&(t.setColor(t.color.lighter(e)),t.setSpec(t.blockSpec))})},BlockMorph.prototype.userMenu=function(){var t,e,o,r,n=new MenuMorph(this),i=this.world(),s=this,h=16===i.currentKey,a=this.activeProcess(),l=a&&a.context&&a.context.outerContext?a.context.outerContext.variables.names():[];function p(t,e,o,r,i){n.addItem((o?" ":" ")+localize(t),e,o?r:i)}return n.addItem("help...","showHelp"),h&&(r=this.topBlock())instanceof ReporterBlockMorph&&n.addItem("script pic with result...",function(){r.exportResultPic()},"open a new window\nwith a picture of both\nthis script and its result",new Color(100,0,0)),this.isTemplate?(this.parent instanceof SyntaxElementMorph?"reportGetVar"===this.selector&&(n.addLine(),n.addItem("rename...",function(){s.refactorThisVar(!0)},"rename only\nthis reporter"),n.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable")):("reportGetVar"===this.selector?(o=this.scriptTarget(),this.isInheritedVariable(!1)?p("inherited",function(){o.toggleInheritedVariable(s.blockSpec)},!0,"uncheck to\ndisinherit",null):(this.isInheritedVariable(!0)&&p("inherited",function(){o.toggleInheritedVariable(s.blockSpec)},!1,null,localize("check to inherit\nfrom")+" "+o.exemplar.name),p("transient","toggleTransientVariable",s.isTransientVariable(),"uncheck to save contents\nin the project","check to prevent contents\nfrom being saved"),n.addLine(),n.addItem("rename...",function(){s.refactorThisVar(!0)},"rename only\nthis reporter"),n.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable"))):"evaluateCustomBlock"!==this.selector&&n.addItem("hide","hidePrimitive"),StageMorph.prototype.enableInheritance&&(o=this.scriptTarget(),(e={xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",getCostumeIdx:"costume #",getVolume:"volume",getPan:"balance",reportShown:"shown?",getPenDown:"pen down?"}[this.selector])&&o&&o.exemplar&&(n.addLine(),p("inherited",function(){o.toggleInheritanceForAttribute(e)},o.inheritsAttribute(e),"uncheck to\ndisinherit",localize("check to inherit\nfrom")+" "+o.exemplar.name))),StageMorph.prototype.enableCodeMapping&&(n.addLine(),n.addItem("header mapping...","mapToHeader"),n.addItem("code mapping...","mapToCode"))),n):(n.addLine(),"reportGetVar"===this.selector?n.addItem("rename...",function(){var t=s.fullCopy();t.addShadow(),new DialogBoxMorph(s,s.userSetSpec,s).prompt("Variable name",s.blockSpec,i,t.fullImage(),InputSlotMorph.prototype.getVarNamesDict.call(s))},"rename only\nthis reporter"):SpriteMorph.prototype.blockAlternatives[this.selector]?n.addItem("relabel...",function(){s.relabel(SpriteMorph.prototype.blockAlternatives[s.selector])}):this.isCustomBlock&&this.alternatives&&0<(t=this.alternatives()).length&&n.addItem("relabel...",function(){s.relabel(t)}),contains(["reportMap","reportKeep","reportFindFirst","reportCombine"],this.selector)?(t={reportMap:"reportAtomicMap",reportKeep:"reportAtomicKeep",reportFindFirst:"reportAtomicFindFirst",reportCombine:"reportAtomicCombine"},n.addItem("compile",function(){s.setSelector(t[s.selector]),s.changed()},"experimental!\nmake this reporter fast and uninterruptable\nCAUTION: Errors in the ring\ncan break your Snap! session!")):contains(["reportAtomicMap","reportAtomicKeep","reportAtomicFindFirst","reportAtomicCombine"],this.selector)&&(t={reportAtomicMap:"reportMap",reportAtomicKeep:"reportKeep",reportAtomicFindFirst:"reportFindFirst",reportAtomicCombine:"reportCombine"},n.addItem("uncompile",function(){s.setSelector(t[s.selector]),s.changed()})),n.addItem("duplicate",function(){var t=s.fullCopy(),e=s.parentThatIsA(IDE_Morph),o=s.parentThatIsA(BlockEditorMorph);t.pickUp(i),!e&&o&&(e=o.target.parentThatIsA(IDE_Morph)),e&&(i.hand.grabOrigin={origin:e.palette,position:e.palette.center()})},"make a copy\nand pick it up"),this instanceof CommandBlockMorph&&this.nextBlock()&&n.addItem((a?this.fullCopy():this).thumbnail(.5,60),function(){var t=s.fullCopy(),e=t.nextBlock(),o=s.parentThatIsA(IDE_Morph),r=s.parentThatIsA(BlockEditorMorph);e&&e.destroy(),t.pickUp(i),!o&&r&&(o=r.target.parentThatIsA(IDE_Morph)),o&&(i.hand.grabOrigin={origin:o.palette,position:o.palette.center()})},"only duplicate this block"),n.addItem("delete","userDestroy"),n.addItem("script pic...",function(){var t=s.parentThatIsA(IDE_Morph)||s.parentThatIsA(BlockEditorMorph).target.parentThatIsA(IDE_Morph);t.saveCanvasAs(s.topBlock().scriptPic(),(t.projectName||localize("untitled"))+" "+localize("script pic"))},"open a new window\nwith a picture of this script"),h&&n.addItem("download script",function(){var t=s.parentThatIsA(IDE_Morph),e=s.parentThatIsA(BlockEditorMorph);!t&&e&&(t=e.target.parentThatIsA(IDE_Morph)),t&&t.saveXMLAs(t.serializer.serialize(s),s.selector+" script",!1)},"download this script\nas an XML file",new Color(100,0,0)),a?(l.length&&(n.addLine(),l.forEach(function(t){n.addItem(t+"...",function(){a.doShowVar(t)})})),a.homeContext.variables.names().forEach(function(t){contains(l,t)||n.addItem(t+"...",function(){a.doShowVar(t)})})):this.parent.parentThatIsA(RingMorph)?(n.addLine(),n.addItem("unringify","unringify"),r=this.topBlock(),!(this instanceof ReporterBlockMorph)&&r instanceof HatBlockMorph||n.addItem("ringify","ringify")):this.parent instanceof ReporterSlotMorph||this.parent instanceof CommandSlotMorph||this instanceof HatBlockMorph||this instanceof CommandBlockMorph&&this.topBlock()instanceof HatBlockMorph||(n.addLine(),n.addItem("ringify","ringify"),StageMorph.prototype.enableCodeMapping&&(n.addLine(),n.addItem("header mapping...","mapToHeader"),n.addItem("code mapping...","mapToCode"))),n)},BlockMorph.prototype.developersMenu=function(){var t=BlockMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("delete block","deleteBlock"),t.addItem("spec...",function(){new DialogBoxMorph(this,this.userSetSpec,this).prompt(t.title+"\nspec",this.blockSpec,this.world())}),t},BlockMorph.prototype.hidePrimitive=function(){var t,e=this.parentThatIsA(IDE_Morph);e&&(StageMorph.prototype.hiddenPrimitives[this.selector]=!0,"lists"===(t={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"}[this.selector]||this.category)&&(t="variables"),e.flushBlocksCache(t),e.refreshPalette())},BlockMorph.prototype.isInheritedVariable=function(t){return!!(this.isTemplate&&"reportGetVar"===this.selector&&this.parent instanceof FrameMorph)&&contains(this.scriptTarget().inheritedVariableNames(t),this.blockSpec)},BlockMorph.prototype.isTransientVariable=function(){var t=this.scriptTarget().variables.silentFind(this.blockSpec);return!!t&&t.vars[this.blockSpec].isTransient},BlockMorph.prototype.toggleTransientVariable=function(){var t=this.scriptTarget().variables.silentFind(this.blockSpec);t&&(t.vars[this.blockSpec].isTransient=!t.vars[this.blockSpec].isTransient)},BlockMorph.prototype.deleteBlock=function(){var t,e,o=this.parentThatIsA(ScriptsMorph),r=this.nextBlock?this.nextBlock():null;o&&(r&&o.add(r),this.inputs().forEach(function(t){t instanceof BlockMorph&&o.add(t)})),this instanceof ReporterBlockMorph&&(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)?this.parent.revertToDefaultInput(this):this.parent&&this.parent.fixLayout?t=this.parentThatIsA(ArgMorph):e=!0,this.destroy(),e&&(this.isCorpse=!0),t&&t.fixLayout()},BlockMorph.prototype.ringify=function(){var t,e,o,r=this.selectForEdit();if(r!==this)return this.ringify.call(r);if(t=new RingMorph,o=(e=this.topBlock()).fullBounds().center(),null===this.parent)return null;if(e.fullChanged(),this.parent instanceof SyntaxElementMorph){if(this instanceof ReporterBlockMorph)this.parent.silentReplaceInput(this,t),t.embed(this);else if(e){if(e instanceof HatBlockMorph)return;e.parent.add(t),t.embed(e),t.setCenter(o)}}else this.parent.add(t),t.embed(this),t.setCenter(o);this.fixBlockColor(null,!0),e.fullChanged()},BlockMorph.prototype.unringify=function(){var t,e,o,r,i,n=this.selectForEdit();return n!==this?this.unringify.call(n):(t=this.parent.parentThatIsA(RingMorph),e=this.topBlock(),r=this.parentThatIsA(ScriptsMorph),null===t?null:(i=t.contents(),o=t.center(),e.fullChanged(),t.parent instanceof SyntaxElementMorph?i instanceof ReporterBlockMorph?t.parent.silentReplaceInput(t,i):r&&(r.add(i),i.setFullCenter(o),i.moveBy(20),t.parent.revertToDefaultInput(t)):(t.parent.add(i),i.setFullCenter(o),t.destroy()),this.fixBlockColor(null,!0),void e.fullChanged()))},BlockMorph.prototype.relabel=function(t){var o,r,i,e=this.selectForEdit();if(e!==this)return this.relabel.call(e,t);o=new MenuMorph(this),r=this.inputs(),i=this,t.forEach(function(t){var e=SpriteMorph.prototype.blockForSelector(t);e.restoreInputs(r),e.fixBlockColor(null,!0),e.addShadow(new Point(3,3)),o.addItem(e,function(){i.setSelector(t)})}),o.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0)))},BlockMorph.prototype.setSelector=function(t){var e,o=this.inputs(),r=this.parentThatIsA(ScriptsMorph),i=SpriteMorph.prototype.blocks[t];this.setCategory(i.category),this.selector=t,this.setSpec(localize(i.spec)),e=this.restoreInputs(o),this.fixLabelColor(),r&&e.length&&e.forEach(function(t){t.moveBy(10),r.add(t)})},BlockMorph.prototype.restoreInputs=function(e){var o,r,i=0,t=[],n=this;for(this.inputs().forEach(function(t){(o=e[i])instanceof ReporterBlockMorph?n.silentReplaceInput(t,o.fullCopy()):o&&t instanceof InputSlotMorph?o.contents&&(t.setContents(o.contents().text),o.constant&&(t.constant=o.constant)):o instanceof CSlotMorph&&t instanceof CSlotMorph&&(r=o.nestedBlock())&&t.nestedBlock(r.fullCopy()),i+=1});i<e.length;i+=1)(o=e[i])instanceof ReporterBlockMorph?t.push(o):o instanceof CommandSlotMorph&&(r=o.nestedBlock())&&t.push(r);return this.cachedInputs=null,t},BlockMorph.prototype.showHelp=function(){var t,e,o,r,i,n=this,s=this.parentThatIsA(IDE_Morph),h=new Image,a=this.isCustomBlock?this.isGlobal?this.definition.helpSpec():this.scriptTarget().getMethod(this.blockSpec).helpSpec():this.selector;if(s||(t=this.parentThatIsA(BlockEditorMorph))&&(s=t.target.parentThatIsA(IDE_Morph)),h.onload=function(){e=newCanvas(new Point(h.width,h.height),!0),e.getContext("2d").drawImage(h,0,0),(new DialogBoxMorph).inform("Help",null,n.world(),e)},this.isCustomBlock&&(r=(o=this.isGlobal?this.definition:this.scriptTarget().getMethod(this.blockSpec)).comment))return(i=o.blockInstance()).refreshDefaults(o),i.addShadow(),(r=r.fullCopy()).contents.parse(),e="",r.contents.lines.forEach(function(t){e=e+"\n"+t}),void(new DialogBoxMorph).inform("Help",e.substr(1),n.world(),i.fullImage());h.src=s.resourceURL("help",a+".png")},BlockMorph.prototype.mapToHeader=function(){var t,e,o="reify"===this.selector.substr(0,5)?"reify":this.selector,r=this.codeDefinitionHeader(),i=this;r.addShadow(new Point(3,3)),e=r.fullImageClassic(),t=this.isCustomBlock?"Enter code that corresponds to the block's definition. Use the formal parameter\nnames as shown and <body> to reference the definition body's generated text code.":"Enter code that corresponds to the block's definition. Choose your own\nformal parameter names (ignoring the ones shown).",new DialogBoxMorph(this,function(t){"evaluateCustomBlock"===o?i.definition.codeHeader=t:StageMorph.prototype.codeHeaders[o]=t},this).promptCode("Header mapping","evaluateCustomBlock"===o?this.definition.codeHeader||"":StageMorph.prototype.codeHeaders[o]||"",this.world(),e,t)},BlockMorph.prototype.mapToCode=function(){var t,e="reify"===this.selector.substr(0,5)?"reify":this.selector,o=this.codeMappingHeader(),r=this;o.addShadow(new Point(3,3)),t=o.fullImageClassic(),new DialogBoxMorph(this,function(t){"evaluateCustomBlock"===e?r.definition.codeMapping=t:StageMorph.prototype.codeMappings[e]=t},this).promptCode("Code mapping","evaluateCustomBlock"===e?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[e]||"",this.world(),t,"Enter code that corresponds to the block's operation (usually a single\nfunction invocation). Use <#n> to reference actual arguments as shown.")},BlockMorph.prototype.mapHeader=function(t,e){var o=e||"reify"===this.selector.substr(0,5)?"reify":this.selector;t&&(this.isCustomBlock?this.definition.codeHeader=t:StageMorph.prototype.codeHeaders[o]=t)},BlockMorph.prototype.mapCode=function(t,e){var o=e||"reify"===this.selector.substr(0,5)?"reify":this.selector;t&&(this.isCustomBlock?this.definition.codeMapping=t:StageMorph.prototype.codeMappings[o]=t)},BlockMorph.prototype.mappedCode=function(t){var h,e,o,i,r,n,s="reify"===this.selector.substr(0,5)?"reify":this.selector,a=1,l=this.isCustomBlock?this.definition.spec:s,p=t||{},c=[],d="reportGetVar"===s?this.blockSpec:this.isCustomBlock?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[s]||"";return"reportGetVar"===s||p.hasOwnProperty(l)||(p[l]=null,this.isCustomBlock?(-1!==(e=this.definition.codeHeader||"").indexOf("<body")&&(r="",this.definition.body&&(r=this.definition.body.expression.mappedCode(p)),n=r.split("\n"),(i=e.split("\n")).forEach(function(t,e){var o,r="";0===t.trimLeft().indexOf("<body")&&(o=t.indexOf("<body"),r=t.slice(0,o)),i[e]=t.replace(new RegExp("<body>"),n.join("\n"+r)),i[e]=i[e].replace(new RegExp("<body>","g"),n.join("\n"))}),e=i.join("\n")),p[l]=e):p[l]=StageMorph.prototype.codeHeaders[l]),h=d.split("\n"),this.inputs().forEach(function(t){c.push(t.mappedCode(p).toString())}),c.forEach(function(t){var i=t.split("\n"),n="<#"+a+">",s=new RegExp(n,"g");h.forEach(function(t,e){var o,r="";0===t.trimLeft().indexOf(n)&&(o=t.indexOf(n),r=t.slice(0,o)),h[e]=t.replace(new RegExp(n),i.join("\n"+r)),h[e]=h[e].replace(s,i.join("\n"))}),a+=1}),d=h.join("\n"),this.nextBlock&&this.nextBlock()&&(d+="\n"+this.nextBlock().mappedCode(p)),!t&&(o=[],Object.keys(p).forEach(function(t){p[t]&&o.push(p[t])}),o.length)?o.join("\n\n")+"\n\n"+d:d},BlockMorph.prototype.codeDefinitionHeader=function(){var o=this.isCustomBlock?new PrototypeHatBlockMorph(this.definition):SpriteMorph.prototype.blockForSelector(this.selector),t=new HatBlockMorph,r=1;return this.isCustomBlock?o:(o.inputs().forEach(function(t){var e=new TemplateSlotMorph("#"+r);o.silentReplaceInput(t,e),r+=1}),o.isPrototype=!0,t.setCategory("control"),t.setSpec("%s"),t.silentReplaceInput(t.inputs()[0],o),"control"===this.category&&t.alternateBlockColor(),t)},BlockMorph.prototype.codeMappingHeader=function(){var o=this.isCustomBlock?this.definition.blockInstance():SpriteMorph.prototype.blockForSelector(this.selector),t=new HatBlockMorph,r=1;return o.inputs().forEach(function(t){var e=new TemplateSlotMorph("<#"+r+">");o.silentReplaceInput(t,e),r+=1}),o.isPrototype=!0,t.setCategory("control"),t.setSpec("%s"),t.silentReplaceInput(t.inputs()[0],o),"control"===this.category&&t.alternateBlockColor(),t},BlockMorph.prototype.refactorThisVar=function(e){var o=this.scriptTarget(),r=this.instantiationSpec||this.blockSpec,t=this.fullCopy();t.addShadow(),new DialogBoxMorph(this,function(t){this.parent instanceof SyntaxElementMorph?this.parentThatIsA(BlockEditorMorph)?this.doRefactorBlockParameter(r,t,e):this.parentThatIsA(RingMorph)?this.doRefactorRingParameter(r,t,e):this.doRefactorScriptVar(r,t,e):o.hasSpriteVariable(r)?this.doRefactorSpriteVar(r,t,e):this.doRefactorGlobalVar(r,t,e)},this).prompt("Variable name",r,this.world(),t.fullImage(),InputSlotMorph.prototype.getVarNamesDict.call(this))},BlockMorph.prototype.varExistsError=function(t,e){t.inform("Variable exists","A variable with this name already exists "+(e||"in this context")+".")},BlockMorph.prototype.doRefactorBlockParameter=function(e,o,t){var r=this.parentThatIsA(BlockInputFragmentMorph),i=r.fragment.copy(),n=r.parent,s=this.parentThatIsA(BlockEditorMorph),h=s.body.contents;n.anyChild(function(t){return t.blockSpec===o})?this.varExistsError(s.target.parentThatIsA(IDE_Morph)):(i.labelString=o,r.updateBlockLabel(i),t||h.children.forEach(function(t){t.refactorVarInStack(e,o)}))},BlockMorph.prototype.doRefactorRingParameter=function(t,e,o){var r=this.parentThatIsA(RingMorph),i=r.contents(),n=this.topBlock();contains(r.inputNames(),e)?this.varExistsError(this.parentThatIsA(IDE_Morph)):(n.fullChanged(),this.setSpec(e),o||i&&i.refactorVarInStack(t,e),n.fullChanged())},BlockMorph.prototype.doRefactorScriptVar=function(t,e,o){var r,i=this.parentThatIsA(CommandBlockMorph);if(i.definesScriptVariable(e))return r=this.scriptTarget().parentThatIsA(IDE_Morph),void this.varExistsError(r);this.userSetSpec(e),o||i.refactorVarInStack(t,e,!0)},BlockMorph.prototype.doRefactorSpriteVar=function(e,o,t){var r,i=this.scriptTarget(),n=i.parentThatIsA(IDE_Morph),s=i.findVariableWatcher(e);i.hasSpriteVariable(o)?this.varExistsError(n):isNil(n.globalVariables.vars[o])?(r=i.variables.getVar(e),i.deleteVariable(e),i.addVariable(o,!1),i.variables.setVar(o,r),s&&s.isVisible&&i.toggleVariableWatcher(o,!1).setPosition(s.position()),t||(i.refactorVariableInstances(e,o,!1),i.customBlocks.forEach(function(t){t.body.expression.refactorVarInStack(e,o)})),n.flushBlocksCache("variables"),n.refreshPalette()):this.varExistsError(n,"as a global variable")},BlockMorph.prototype.doRefactorGlobalVar=function(e,o,t){var r,i=this.scriptTarget(),n=i.parentThatIsA(IDE_Morph),s=n?n.stage:null,h=i.findVariableWatcher(e);isNil(n.globalVariables.vars[o])?detect(s.children,function(t){return t instanceof SpriteMorph&&t.hasSpriteVariable(o)})?this.varExistsError(n,"as a sprite local variable"):(r=n.globalVariables.getVar(e),s.deleteVariable(e),s.addVariable(o,!0),n.globalVariables.setVar(o,r),h&&h.isVisible&&i.toggleVariableWatcher(o,!0).setPosition(h.position()),t||(s.refactorVariableInstances(e,o,!0),s.globalBlocks.forEach(function(t){t.body&&t.body.expression.refactorVarInStack(e,o)}),s.forAllChildren(function(t){t instanceof SpriteMorph&&(t.refactorVariableInstances(e,o,!0),t.customBlocks.forEach(function(t){t.body.expression.refactorVarInStack(e,o)}))})),n.flushBlocksCache("variables"),n.refreshPalette()):this.varExistsError(n)},BlockMorph.prototype.eraseHoles=function(r){var t,e,i=this,n=this instanceof RingMorph,o=.5*this.edge,s=[];this.parts().forEach(function(t){t.isHole?s.push(t):t instanceof MultiArgMorph&&s.push.apply(s,t.inputs().filter(function(t){return t.isHole}))}),this.isPredicate&&0<s.length&&(e=this.width()-this.rounding,r.clearRect(e,0,this.width(),this.height()),(t=r.createLinearGradient(e-this.edge,0,this.width(),0)).addColorStop(0,this.color.toString()),t.addColorStop(1,this.dark()),r.lineWidth=this.edge,r.lineJoin="round",r.lineCap="round",r.strokeStyle=t,r.beginPath(),r.moveTo(e-o,this.edge+o),r.lineTo(e-o,this.height()-this.edge-o),r.stroke()),s.forEach(function(t){var e=t.width(),o=Math.floor(t.height())-2;r.clearRect(t.bounds.origin.x-i.bounds.origin.x+1,t.bounds.origin.y-i.bounds.origin.y+1,n?e-2:e+1,o)})},BlockMorph.prototype.hasLocationPin=function(){return this.isCustomBlock&&!this.isGlobal||this.isLocalVarTemplate},BlockMorph.prototype.addHighlight=function(t){var e,o=!this.isVisible;return o&&this.show(),e=this.highlight(t?t.color:this.activeHighlight,this.activeBlur,this.activeBorder),this.addBack(e),this.fullChanged(),o&&this.hide(),e},BlockMorph.prototype.addErrorHighlight=function(){var t,e=!this.isVisible;return e&&this.show(),this.removeHighlight(),t=this.highlight(this.errorHighlight,this.activeBlur,this.activeBorder),this.addBack(t),this.fullChanged(),e&&this.hide(),t},BlockMorph.prototype.removeHighlight=function(){var t=this.getHighlight();return null!==t&&(this.fullChanged(),this.removeChild(t)),t},BlockMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()},BlockMorph.prototype.highlight=function(t,e,o){var r=new BlockHighlightMorph,i=this.fullBounds(),n=useBlurredShadows&&!MorphicPreferences.isFlat?e:o;return r.setExtent(i.extent().add(2*n)),r.color=t,r.image=useBlurredShadows&&!MorphicPreferences.isFlat?this.highlightImageBlurred(t,e):this.highlightImage(t,o),r.setPosition(i.origin.subtract(new Point(n,n))),r},BlockMorph.prototype.highlightImage=function(t,e){var o,r=this.fullBounds().extent(),i=this.fullImage(),n=newCanvas(r.add(2*e)),s=n.getContext("2d");return s.drawImage(i,0,0),s.drawImage(i,e,0),s.drawImage(i,2*e,0),s.drawImage(i,2*e,e),s.drawImage(i,2*e,2*e),s.drawImage(i,e,2*e),s.drawImage(i,0,2*e),s.drawImage(i,0,e),s.globalCompositeOperation="destination-out",s.drawImage(i,e,e),(s=(o=newCanvas(r.add(2*e))).getContext("2d")).drawImage(n,0,0),s.globalCompositeOperation="source-atop",s.fillStyle=t.toString(),s.fillRect(0,0,o.width,o.height),o},BlockMorph.prototype.highlightImageBlurred=function(t,e){var o=this.fullBounds().extent(),r=this.fullImage(),i=newCanvas(o.add(2*e)),n=i.getContext("2d");return n.shadowBlur=e,n.shadowColor=t.toString(),n.drawImage(r,e,e),n.shadowBlur=0,n.globalCompositeOperation="destination-out",n.drawImage(r,e,e),i},BlockMorph.prototype.getHighlight=function(){var t=this.children.slice(0).reverse().filter(function(t){return t instanceof BlockHighlightMorph});return 0!==t.length?t[0]:null},BlockMorph.prototype.outline=function(t,e){var o=new BlockHighlightMorph,r=this.fullBounds(),i=e;return o.setExtent(r.extent().add(2*i)),o.color=t,o.image=this.highlightImage(t,e),o.setPosition(r.origin.subtract(new Point(i,i))),o},BlockMorph.prototype.fixBlockColor=function(t,e){var o,r,i=t;if(this.zebraContrast||e){if(!this.zebraContrast&&e)return this.forceNormalColoring(!0);i||this.parent&&(this.isPrototype?i=null:this instanceof ReporterBlockMorph?i=this.parent.parentThatIsA(BlockMorph):(r=this.parentThatIsA(CommandSlotMorph,ReporterSlotMorph))&&(i=r.parentThatIsA(BlockMorph))),i?i.category===this.category?i.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(SpriteMorph.prototype.blockColor[this.category])&&this.alternateBlockColor():(o=SpriteMorph.prototype.blockColor[this.category],this.color.eq(o)||this.alternateBlockColor()),e&&this.fixChildrensBlockColor(!0)}},BlockMorph.prototype.forceNormalColoring=function(t){var e=SpriteMorph.prototype.blockColor[this.category];this.setColor(e,t),this.setLabelColor(new Color(255,255,255),e.darker(this.labelContrast),new Point(-1,-1)),this.fixChildrensBlockColor(!0)},BlockMorph.prototype.alternateBlockColor=function(){var t=SpriteMorph.prototype.blockColor[this.category];this.color.eq(t)?this.setColor(this.zebraContrast<0?t.darker(Math.abs(this.zebraContrast)):t.lighter(this.zebraContrast),this.hasLabels()):this.setColor(t,this.hasLabels()),this.fixLabelColor(),this.fixChildrensBlockColor(!0)},BlockMorph.prototype.ghost=function(){this.setColor(SpriteMorph.prototype.blockColor[this.category].lighter(35))},BlockMorph.prototype.fixLabelColor=function(){var t;0<this.zebraContrast&&this.category&&(t=SpriteMorph.prototype.blockColor[this.category],this.color.eq(t)?this.setLabelColor(new Color(255,255,255),t.darker(this.labelContrast),MorphicPreferences.isFlat?null:new Point(-1,-1)):this.setLabelColor(new Color(0,0,0),t.lighter(this.zebraContrast).lighter(2*this.labelContrast),MorphicPreferences.isFlat?null:new Point(1,1)))},BlockMorph.prototype.fixChildrensBlockColor=function(e){var o=this;this.children.forEach(function(t){t instanceof CommandBlockMorph?t.fixBlockColor(null,e):t instanceof SyntaxElementMorph&&(t.fixBlockColor(o,e),t instanceof BooleanSlotMorph&&t.drawNew())})},BlockMorph.prototype.setCategory=function(t){this.category=t,this.startLayout(),this.fixBlockColor(),this.endLayout()},BlockMorph.prototype.hasLabels=function(){return this.children.some(function(t){return t instanceof StringMorph})},BlockMorph.prototype.fullCopy=function(){var t=BlockMorph.uber.fullCopy.call(this);return t.removeHighlight(),t.isDraggable=!0,this.instantiationSpec&&t.setSpec(this.instantiationSpec),t.allChildren().filter(function(t){return t instanceof SyntaxElementMorph&&(t.cachedInputs=null,t.isCustomBlock&&t.initializeVariables()),!isNil(t.comment)}).forEach(function(t){var e=t.comment.fullCopy();(t.comment=e).block=t}),t.cachedInputs=null,t},BlockMorph.prototype.reactToTemplateCopy=function(){this.isLocalVarTemplate&&(this.isLocalVarTemplate=null,this.drawNew(),this.fixLayout()),this.forceNormalColoring()},BlockMorph.prototype.hasBlockVars=function(){return this.anyChild(function(t){return t.isCustomBlock&&t.isGlobal&&t.definition.variableNames.length})},BlockMorph.prototype.mouseClickLeft=function(){var t,e=this.topBlock(),o=e.scriptTarget();if(16===this.world().currentKey&&!this.isTemplate)return this.selectForEdit().focus();e instanceof PrototypeHatBlockMorph||o&&(t=o.parentThatIsA(StageMorph))&&t.threads.toggleProcess(e,o)},BlockMorph.prototype.focus=function(){var t,e=this.parentThatIsA(ScriptsMorph),o=this.world();e&&ScriptsMorph.prototype.enableKeyboard&&(e.focus&&e.focus.stopEditing(),o.stopEditing(),t=new ScriptFocusMorph(e,this),(e.focus=t).getFocus(o),this instanceof HatBlockMorph&&t.nextCommand())},BlockMorph.prototype.activeProcess=function(){var t,e=this.topBlock(),o=e.scriptTarget();return!(e instanceof PrototypeHatBlockMorph)&&o&&(t=o.parentThatIsA(StageMorph))?t.threads.findProcess(e,o):null},BlockMorph.prototype.thumbnail=function(t,e){var o,r,i,n,s=this.nextBlock();return s&&(s.isVisible=!1),o=this.fullBounds().extent(),(i=(r=newCanvas(new Point(e?Math.min(o.x*t,e):o.x*t,o.y*t))).getContext("2d")).scale(t,t),i.drawImage(this.fullImage(),0,0),e&&o.x*t>e&&((n=i.createLinearGradient(r.width/t-12,0,r.width/t,0)).addColorStop(0,"transparent"),n.addColorStop(1,"black"),i.globalCompositeOperation="destination-out",i.fillStyle=n,i.fillRect(r.width/t-12,0,r.width/t,r.height/t)),s&&(s.isVisible=!0),r},BlockMorph.prototype.scriptPic=function(){var t=this.fullImage(),e=this.stackFullBounds(),o=newCanvas(e.extent()),r=o.getContext("2d");return this.allComments().forEach(function(t){r.drawImage(t.fullImageClassic(),t.fullBounds().left()-e.left(),t.top()-e.top())}),r.drawImage(t,0,0),o},BlockMorph.prototype.drawMethodIcon=function(t){var e=this.methodIconExtent(),o=e.x,r=e.y,i=o/2,n=this.edge+this.labelPadding,s=this.edge,h=this.color===SpriteMorph.prototype.blockColor[this.category];this.isPredicate&&(n=this.rounding),this instanceof CommandBlockMorph&&(s+=this.corner),t.fillStyle=h?this.cachedClrBright:this.cachedClrDark,t.beginPath(),t.arc(n+i,s+i,i,radians(-210),radians(30),!1),t.lineTo(n+i,s+r),t.closePath(),t.fill(),t.fillStyle=this.cachedClr,t.beginPath(),t.arc(n+i,s+i,.4*i,radians(0),radians(360),!1),t.closePath(),t.fill()},BlockMorph.prototype.rootForGrab=function(){return this},BlockMorph.prototype.wantsDropOf=function(t){return(t instanceof ArgMorph||t instanceof StringMorph||t instanceof TextMorph)&&!this.isTemplate},BlockMorph.prototype.reactToDropOf=function(t){t.isDraggable=!1,t instanceof InputSlotMorph?t.drawNew():t instanceof MultiArgMorph&&t.fixLayout(),this.fixLayout(),this.buildSpec()},BlockMorph.prototype.situation=function(){if(!(this.parent instanceof TemplateSlotMorph)){var t=this.parentThatIsA(ScriptsMorph);if(t)return{origin:t,position:this.position().subtract(t.position())}}return BlockMorph.uber.situation.call(this)},BlockMorph.prototype.prepareToBeGrabbed=function(e){var o=this;this.allInputs().forEach(function(t){delete t.bindingID}),this.allComments().forEach(function(t){t.startFollowing(o,e.world)})},BlockMorph.prototype.justDropped=function(){this.alpha=1,this.allComments().forEach(function(t){t.stopFollowing()})},BlockMorph.prototype.allComments=function(){return this.allChildren().filter(function(t){return!isNil(t.comment)}).map(function(t){return t.comment})},BlockMorph.prototype.destroy=function(t){t?isNil(this.comment)||this.comment.destroy():this.allComments().forEach(function(t){t.destroy()}),BlockMorph.uber.destroy.call(this)},BlockMorph.prototype.stackHeight=function(){var t=this.fullBounds(),e=Math.max(this.allComments().map(function(t){return t.bottom()}))||this.bottom();return Math.max(t.bottom(),e)-t.top()},BlockMorph.prototype.stackFullBounds=function(){var e=this.fullBounds();return this.allComments().forEach(function(t){e.mergeWith(t.bounds)}),e},BlockMorph.prototype.stackWidth=function(){var t=this.fullBounds(),e=Math.max(this.allComments().map(function(t){return t.right()}))||this.right();return Math.max(t.right(),e)-t.left()},BlockMorph.prototype.snap=function(){var t,e,o,r=this.topBlock();r.allComments().forEach(function(t){t.align(r)}),this.getHighlight()&&this!==r&&this.removeHighlight(),r.getHighlight()&&r.addHighlight(r.removeHighlight()),"receiveCondition"===this.selector&&(t=r.scriptTarget())&&(e=t.parentThatIsA(StageMorph))&&(e.enableCustomHatBlocks=!0,e.threads.pauseCustomHatBlocks=!1,(o=e.parentThatIsA(IDE_Morph))&&o.controlBar.stopButton.refresh())},CommandBlockMorph.prototype=new BlockMorph,(CommandBlockMorph.prototype.constructor=CommandBlockMorph).uber=BlockMorph.prototype,CommandBlockMorph.prototype.init=function(t){CommandBlockMorph.uber.init.call(this,t),this.setExtent(new Point(200,100),t),this.partOfCustomCommand=!1,this.exitTag=null},CommandBlockMorph.prototype.blockSequence=function(){var t=this.nextBlock(),e=[this];return t&&(e=e.concat(t.blockSequence())),e},CommandBlockMorph.prototype.bottomBlock=function(){return this.nextBlock()?this.nextBlock().bottomBlock():this},CommandBlockMorph.prototype.nextBlock=function(t){if(!t)return detect(this.children,function(t){return t instanceof CommandBlockMorph&&!t.isPrototype});var e=this.nextBlock(),o=this.parentThatIsA(CommandSlotMorph,ReporterSlotMorph);this.add(t),e&&t.bottomBlock().nextBlock(e),t.setPosition(new Point(this.left(),this.bottom()-this.corner)),o&&o.fixLayout()},CommandBlockMorph.prototype.topAttachPoint=function(){return new Point(this.dentCenter(),this.top())},CommandBlockMorph.prototype.bottomAttachPoint=function(){return new Point(this.dentCenter(),this.bottom())},CommandBlockMorph.prototype.wrapAttachPoint=function(){var t=detect(this.inputs(),function(t){return t instanceof CSlotMorph});return t&&!t.nestedBlock()?new Point(t.left()+2*t.inset+t.corner,t.top()+2*t.corner):null},CommandBlockMorph.prototype.dentLeft=function(){return this.left()+this.corner+this.inset},CommandBlockMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent},CommandBlockMorph.prototype.attachTargets=function(){var t,e=[];return this instanceof HatBlockMorph||(t=this.topAttachPoint(),this.parent instanceof SyntaxElementMorph||e.push({point:t,element:this,loc:"top",type:"block"}),!ScriptsMorph.prototype.enableNestedAutoWrapping&&this.parentThatIsA(CommandSlotMorph)||e.push({point:t,element:this,loc:"wrap",type:"block"})),this.isStop()||e.push({point:this.bottomAttachPoint(),element:this,loc:"bottom",type:"block"}),e},CommandBlockMorph.prototype.allAttachTargets=function(t){var e=this,o=t||this.parent,r=[];return this instanceof HatBlockMorph&&t.rejectsHats||o.children.filter(function(t){return t!==e&&t instanceof SyntaxElementMorph&&!t.isTemplate}).forEach(function(t){t.forAllChildren(function(t){t.attachTargets&&t.attachTargets().forEach(function(t){r.push(t)})})}),r},CommandBlockMorph.prototype.closestAttachTarget=function(t){var o,e,r=t||this.parent,i=this.bottomBlock(),n=null,s=Math.max(2*this.corner+this.dent,this.minSnapDistance),h=[],a=1e3;return this instanceof HatBlockMorph||(h.push({point:this.topAttachPoint(),loc:"top"}),(e=this.wrapAttachPoint())&&h.push({point:e,loc:"wrap"})),i.isStop()||h.push({point:i.bottomAttachPoint(),loc:"bottom"}),this.allAttachTargets(r).forEach(function(e){h.forEach(function(t){("wrap"===t.loc&&"wrap"===e.loc||t.loc!==e.loc&&"wrap"!==t.loc&&"wrap"!==e.loc)&&(o=t.point.distanceTo(e.point))<s&&o<a&&(a=o,n=e)})}),n},CommandBlockMorph.prototype.snap=function(t){var e,o,r,i,n,s=this.closestAttachTarget(),h=this.parentThatIsA(ScriptsMorph);if(h.clearDropInfo(),h.lastDroppedBlock=this,null===s)return this.startLayout(),this.fixBlockColor(),this.endLayout(),CommandBlockMorph.uber.snap.call(this),void(t&&h.recordDrop(t.grabOrigin));h.lastDropTarget=s,this.startLayout(),"bottom"===s.loc?("slot"===s.type?(this.removeHighlight(),h.lastNextBlock=s.element.nestedBlock(),s.element.nestedBlock(this)):(h.lastNextBlock=s.element.nextBlock(),s.element.nextBlock(this)),this.isStop()&&(o=this.nextBlock())&&(h.add(o),o.moveBy(this.extent().floorDivideBy(2)),(n=this.parentThatIsA(CommandSlotMorph,ReporterSlotMorph))&&n.fixLayout())):"top"===s.loc?(s.element.removeHighlight(),r=this.bottomBlock().bottom()-this.bottom(),this.setBottom(s.element.top()+this.corner-r),this.setLeft(s.element.left()),this.bottomBlock().nextBlock(s.element)):"wrap"===s.loc&&(i=detect(this.inputs(),function(t){return t instanceof CSlotMorph}),e=s.element.parent,h.lastWrapParent=e,this.moveBy(s.point.subtract(i.slotAttachPoint())),i.nestedBlock(s.element),e instanceof CommandBlockMorph?e.nextBlock(this):e instanceof CommandSlotMorph?e.nestedBlock(this):e instanceof RingReporterSlotMorph&&(e.add(this),e.fixLayout()),s.element.blockSequence().forEach(function(t){t.fixBlockColor()})),this.fixBlockColor(),this.endLayout(),CommandBlockMorph.uber.snap.call(this),t&&h.recordDrop(t.grabOrigin),this.snapSound&&this.snapSound.play()},CommandBlockMorph.prototype.prepareToBeGrabbed=function(t){var e=this.position();nop(t),this.parent instanceof RingReporterSlotMorph&&(this.parent.revertToDefaultInput(this),this.setPosition(e)),CommandBlockMorph.uber.prepareToBeGrabbed.call(this,t)},CommandBlockMorph.prototype.isStop=function(){var t;return"doStopThis"===this.selector?(t=this.inputs()[0].evaluate())instanceof Array&&t[0].length<12:-1<["doForever","doReport","removeClone"].indexOf(this.selector)},CommandBlockMorph.prototype.userDestroy=function(){var t,e,o,r,i=this.selectForEdit();if(i!==this)return this.userDestroy.call(i);this.nextBlock()?this.userDestroyJustThis():(t=this.parentThatIsA(ScriptsMorph),e=this.parentThatIsA(IDE_Morph),o=this.parentThatIsA(SyntaxElementMorph),r=this.parentThatIsA(CSlotMorph),t&&(t.clearDropInfo(),t.lastDroppedBlock=this,t.recordDrop(this.situation()),t.dropRecord.action="delete"),this.prepareToBeGrabbed(),e?e.removeBlock(this):this.destroy(),r&&r.fixLayout(),o&&o.reactToGrabOf(this))},CommandBlockMorph.prototype.userDestroyJustThis=function(){var t,e,o=this.parentThatIsA(ScriptsMorph),r=this.parentThatIsA(IDE_Morph),i=this.parentThatIsA(CommandSlotMorph,RingReporterSlotMorph),n=this.nextBlock(),s=this.parentThatIsA(SyntaxElementMorph),h=this.parentThatIsA(CSlotMorph,RingReporterSlotMorph);o&&(o.clearDropInfo(),o.lastDroppedBlock=this,o.recordDrop(this.situation()),o.dropRecord.lastNextBlock=n,o.dropRecord.action="delete"),this.topBlock().fullChanged(),this.parent&&(t=this.parent.parentThatIsA(CommandBlockMorph)),t&&t.nextBlock()===this?e=t:i&&i.nestedBlock()===this&&(e=i,this.prepareToBeGrabbed()),r?r.removeBlock(this,!0):this.destroy(!0),n?e instanceof CommandSlotMorph||e instanceof RingReporterSlotMorph?e.nestedBlock(n):e instanceof CommandBlockMorph?e.nextBlock(n):o.add(n):h&&h.fixLayout(),s&&s.reactToGrabOf(this)},CommandBlockMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.drawTop(t),this.drawBody(t),this.drawBottom(t),MorphicPreferences.isFlat?nop():(this.drawTopDentEdge(t,0,0),this.drawBottomDentEdge(t,0,this.height()-this.corner),this.drawLeftEdge(t),this.drawRightEdge(t),this.drawTopLeftEdge(t),this.drawBottomRightEdge(t)),this.hasLocationPin()&&this.drawMethodIcon(t),this.eraseHoles(t)},CommandBlockMorph.prototype.drawBody=function(t){t.fillRect(0,Math.floor(this.corner),this.width(),this.height()-Math.floor(3*this.corner)+1)},CommandBlockMorph.prototype.drawTop=function(t){t.beginPath(),t.arc(this.corner,this.corner,this.corner,radians(-180),radians(-90),!1),this.drawDent(t,0,0),t.arc(this.width()-this.corner,this.corner,this.corner,radians(-90),radians(-0),!1),t.closePath(),t.fill()},CommandBlockMorph.prototype.drawBottom=function(t){var e=this.height()-2*this.corner;t.beginPath(),t.arc(this.corner,e,this.corner,radians(180),radians(90),!0),this.isStop()||this.drawDent(t,0,this.height()-this.corner),t.arc(this.width()-this.corner,e,this.corner,radians(90),radians(0),!0),t.closePath(),t.fill()},CommandBlockMorph.prototype.drawDent=function(t,e,o){var r=e+2*this.corner+this.inset;t.lineTo(e+this.corner+this.inset,o),t.lineTo(r,o+this.corner),t.lineTo(r+this.dent,o+this.corner),t.lineTo(e+3*this.corner+this.inset+this.dent,o),t.lineTo(this.width()-this.corner,o)},CommandBlockMorph.prototype.drawTopDentEdge=function(t,e,o){var r,i,n,s,h=.5*this.edge,a=e+2*this.corner+this.inset;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(r=t.createLinearGradient(0,o,0,o+this.edge)).addColorStop(0,this.cachedClrBright),r.addColorStop(1,this.cachedClr),t.strokeStyle=r,t.beginPath(),t.moveTo(this.corner,o+h),t.lineTo(e+this.corner+this.inset,o+h),t.stroke(),t.strokeStyle=r,t.beginPath(),t.moveTo(e+3*this.corner+this.inset+this.dent+h,o+h),t.lineTo(this.width()-this.corner,o+h),t.stroke(),s=e+this.corner+this.inset,(n=t.createLinearGradient(s-this.edge,o+this.edge,s,o)).addColorStop(0,this.cachedClr),n.addColorStop(1,this.cachedClrBright),t.strokeStyle=n,t.beginPath(),t.moveTo(e+this.corner+this.inset,o+h),t.lineTo(a,o+this.corner+h),t.stroke(),(i=t.createLinearGradient(0,o+this.corner,0,o+this.corner+this.edge)).addColorStop(0,this.cachedClrBright),i.addColorStop(1,this.cachedClr),t.strokeStyle=i,t.beginPath(),t.moveTo(a,o+this.corner+h),t.lineTo(a+this.dent,o+this.corner+h),t.stroke()},CommandBlockMorph.prototype.drawBottomDentEdge=function(t,e,o){var r,i,n,s=.5*this.edge,h=e+2*this.corner+this.inset;if(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(r=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(this.corner,o-s),this.isStop()?t.lineTo(this.width()-this.corner,o-s):t.lineTo(e+this.corner+this.inset-s,o-s),t.stroke(),this.isStop())return null;(i=t.createLinearGradient(0,o+this.corner-this.edge,0,o+this.corner)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(h+s,o+this.corner-s),t.lineTo(h+this.dent,o+this.corner-s),t.stroke(),(n=t.createLinearGradient(e+h+this.dent-this.edge,o+this.corner-this.edge,e+h+this.dent,o+this.corner)).addColorStop(0,this.cachedClr),n.addColorStop(1,this.cachedClrDark),t.strokeStyle=n,t.beginPath(),t.moveTo(e+h+this.dent,o+this.corner-s),t.lineTo(e+3*this.corner+this.inset+this.dent,o-s),t.stroke(),t.strokeStyle=r,t.beginPath(),t.moveTo(e+3*this.corner+this.inset+this.dent,o-s),t.lineTo(this.width()-this.corner,o-s),t.stroke()},CommandBlockMorph.prototype.drawFlatBottomDentEdge=function(t){this.isStop()||(t.fillStyle=this.color.darker(this.contrast/2).toString(),t.beginPath(),this.drawDent(t,0,this.height()-this.corner),t.closePath(),t.fill())},CommandBlockMorph.prototype.drawLeftEdge=function(t){var e=.5*this.edge,o=t.createLinearGradient(0,0,this.edge,0);o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.moveTo(e,this.corner),t.lineTo(e,this.height()-2*this.corner-e),t.stroke()},CommandBlockMorph.prototype.drawRightEdge=function(t){var e=.5*this.edge,o=this.width(),r=t.createLinearGradient(o-this.edge,0,o,0);r.addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=r,t.beginPath(),t.moveTo(o-e,this.corner+e),t.lineTo(o-e,this.height()-2*this.corner),t.stroke()},CommandBlockMorph.prototype.drawTopLeftEdge=function(t){var e=.5*this.edge,o=t.createRadialGradient(this.corner,this.corner,this.corner,this.corner,this.corner,this.corner-this.edge);o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.arc(this.corner,this.corner,this.corner-e,radians(-180),radians(-90),!1),t.stroke()},CommandBlockMorph.prototype.drawBottomRightEdge=function(t){var e=.5*this.edge,o=this.width()-this.corner,r=this.height()-2*this.corner,i=t.createRadialGradient(o,r,this.corner,o,r,this.corner-this.edge);i.addColorStop(0,this.cachedClrDark),i.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=i,t.beginPath(),t.arc(o,r,this.corner-e,radians(90),radians(0),!0),t.stroke()},HatBlockMorph.prototype=new CommandBlockMorph,(HatBlockMorph.prototype.constructor=HatBlockMorph).uber=CommandBlockMorph.prototype,HatBlockMorph.prototype.init=function(){HatBlockMorph.uber.init.call(this,!0),this.setExtent(new Point(300,150))},HatBlockMorph.prototype.blockSequence=function(){var t=HatBlockMorph.uber.blockSequence.call(this);return t.shift(),t},HatBlockMorph.prototype.drawTop=function(t){var e=this.hatWidth,o=this.hatHeight,r=(4*o*o+e*e)/(8*o),i=degrees(4*Math.atan(2*o/e))/2,n=Math.min(1.7*e,this.width()-this.corner);t.beginPath(),t.moveTo(0,o+this.corner),t.arc(e/2,r,r,radians(-i-90),radians(-90),!1),t.bezierCurveTo(e,0,e,o,n,o),t.arc(this.width()-this.corner,o+this.corner,this.corner,radians(-90),radians(-0),!1),t.closePath(),t.fill()},HatBlockMorph.prototype.drawBody=function(t){t.fillRect(0,this.hatHeight+Math.floor(this.corner)-1,this.width(),this.height()-Math.floor(3*this.corner)-this.hatHeight+2)},HatBlockMorph.prototype.drawLeftEdge=function(t){var e=.5*this.edge,o=t.createLinearGradient(0,0,this.edge,0);o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.moveTo(e,this.hatHeight+e),t.lineTo(e,this.height()-2*this.corner-e),t.stroke()},HatBlockMorph.prototype.drawRightEdge=function(t){var e=.5*this.edge,o=this.width(),r=t.createLinearGradient(o-this.edge,0,o,0);r.addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=r,t.beginPath(),t.moveTo(o-e,this.corner+this.hatHeight+e),t.lineTo(o-e,this.height()-2*this.corner),t.stroke()},HatBlockMorph.prototype.drawTopDentEdge=function(){return null},HatBlockMorph.prototype.drawTopLeftEdge=function(t){var e=.5*this.edge,o=this.hatWidth,r=this.hatHeight,i=(4*r*r+o*o)/(8*r),n=degrees(4*Math.atan(2*r/o))/2,s=Math.min(1.7*o,this.width()-this.corner),h=t.createRadialGradient(o/2,i,i-this.edge,o/2,i,i);h.addColorStop(1,this.cachedClrBright),h.addColorStop(0,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=h,t.beginPath(),t.arc(Math.round(o/2),i,i-e,radians(-n-90),radians(-90),!1),t.moveTo(o/2,e),t.bezierCurveTo(o,e,o,r+e,s,r+e),t.lineTo(this.width()-this.corner,r+e),t.stroke()},ReporterBlockMorph.prototype=new BlockMorph,(ReporterBlockMorph.prototype.constructor=ReporterBlockMorph).uber=BlockMorph.prototype,ReporterBlockMorph.prototype.init=function(t,e){ReporterBlockMorph.uber.init.call(this,e),this.isPredicate=t||!1,this.setExtent(new Point(200,80),e),this.cachedSlotSpec=null,this.isLocalVarTemplate=null},ReporterBlockMorph.prototype.snap=function(t){var e,o,r=this.parent;if(this.cachedSlotSpec=null,!(r instanceof ScriptsMorph))return null;r.clearDropInfo(),r.lastDroppedBlock=this,null!==(o=r.closestInput(this,t))&&(r.lastReplacedInput=o,r.lastDropTarget=o.parent,o instanceof MultiArgMorph?(r.lastPreservedBlocks=o.inputs(),r.lastReplacedInput=o.fullCopy()):o instanceof CommandSlotMorph&&(e=(r.lastReplacedInput=o).nestedBlock())&&(e=e.fullCopy(),r.add(e),e.moveBy(e.extent()),e.fixBlockColor(),r.lastPreservedBlocks=[e]),o.parent.replaceInput(o,this),this.snapSound&&this.snapSound.play()),this.startLayout(),this.fixBlockColor(),this.endLayout(),ReporterBlockMorph.uber.snap.call(this),t&&r.recordDrop(t.grabOrigin)},ReporterBlockMorph.prototype.prepareToBeGrabbed=function(t){var e=this.position();nop(t),(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)&&(this.parent.revertToDefaultInput(this),this.setPosition(e)),ReporterBlockMorph.uber.prepareToBeGrabbed.call(this,t),this.alpha=.85,this.cachedSlotSpec=null},ReporterBlockMorph.prototype.blockSequence=function(){return this},ReporterBlockMorph.prototype.isUnevaluated=function(){var t=this.getSlotSpec();return"%anyUE"===t||"%boolUE"===t||"%f"===t},ReporterBlockMorph.prototype.isLocked=function(){return this.isStatic||"%t"===this.getSlotSpec()},ReporterBlockMorph.prototype.getSlotSpec=function(){return this.cachedSlotSpec||(this.cachedSlotSpec=this.determineSlotSpec()),this.cachedSlotSpec},ReporterBlockMorph.prototype.determineSlotSpec=function(){var t;return this.parent instanceof BlockMorph&&-1!==(t=this.parent.parts().filter(function(t){return!(t instanceof BlockHighlightMorph)}).indexOf(this))&&this.parent.blockSpec?this.parseSpec(this.parent.blockSpec)[t]:this.parent instanceof MultiArgMorph?this.parent.slotSpec:this.parent instanceof TemplateSlotMorph?this.parent.getSpec():null},ReporterBlockMorph.prototype.mouseClickLeft=function(t){var e;if(this.parent instanceof BlockInputFragmentMorph)return this.parent.mouseClickLeft();this.parent instanceof TemplateSlotMorph?(e=this.parent.parent&&this.parent.parent.parent&&this.parent.parent.parent instanceof RingMorph?"Input name":"%blockVars"===this.parent.parent.elementSpec?"Block variable name":"Script variable name",new DialogBoxMorph(this,this.userSetSpec,this).prompt(e,this.blockSpec,this.world())):ReporterBlockMorph.uber.mouseClickLeft.call(this,t)},ReporterBlockMorph.prototype.exportResultPic=function(){var t,e=this.topBlock(),o=e.scriptTarget();e===this&&o&&(t=o.parentThatIsA(StageMorph))&&(t.threads.stopProcess(e),t.threads.startProcess(e,o,!1,!0))},ReporterBlockMorph.prototype.userDestroy=function(){var t=this.selectForEdit();if(t!==this)return this.userDestroy.call(t);var e=this.parentThatIsA(ScriptsMorph);e&&(e.clearDropInfo(),e.lastDroppedBlock=this,e.recordDrop(this.situation()),e.dropRecord.action="delete"),this.topBlock().fullChanged(),this.prepareToBeGrabbed(this.world().hand),this.destroy()},ReporterBlockMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.isPredicate?this.drawDiamond(t):this.drawRounded(t),this.hasLocationPin()&&this.drawMethodIcon(t),this.eraseHoles(t)},ReporterBlockMorph.prototype.drawRounded=function(t){var e,o=this.height(),r=Math.min(this.rounding,o/2),i=this.width(),n=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.arc(r,r,r,radians(-180),radians(-90),!1),t.arc(i-r,r,r,radians(-90),radians(-0),!1),t.arc(i-r,o-r,r,radians(0),radians(90),!1),t.arc(r,o-r,r,radians(90),radians(180),!1),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(e=t.createRadialGradient(r,o-r,r-this.edge,r,o-r,r+this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(r,o-r,r-n,radians(90),radians(180),!1),t.stroke(),(e=t.createRadialGradient(i-r,r,r-this.edge,i-r,r,r+this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(i-r,r,r-n,radians(-90),radians(0),!1),t.stroke(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,n),t.lineTo(i-r+n,n),t.stroke(),(e=t.createRadialGradient(r,r,r-this.edge,r,r,r)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(r,r,r-n,radians(180),radians(270),!1),t.stroke(),(e=t.createRadialGradient(i-r,o-r,r-this.edge,i-r,o-r,r)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(i-r,o-r,r-n,radians(0),radians(90),!1),t.stroke(),(e=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,o-n),t.lineTo(i-r+n,o-n),t.stroke(),(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,r),t.lineTo(n,o-r),t.stroke(),(e=t.createLinearGradient(i-this.edge,0,i,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,r+n),t.lineTo(i-n,o-r),t.stroke())},ReporterBlockMorph.prototype.drawDiamond=function(t){var e,o=this.width(),r=this.height(),i=Math.floor(r/2),n=this.rounding,s=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,i),t.lineTo(n,0),t.lineTo(o-n,0),t.lineTo(o,i),t.lineTo(o-n,r),t.lineTo(n,r),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(e=t.createLinearGradient(-n,0,n,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(s,i),t.lineTo(n,r-s),t.closePath(),t.stroke(),(e=t.createLinearGradient(o-n,0,o+n,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o-s,i),t.lineTo(o-n,s),t.closePath(),t.stroke(),(e=t.createLinearGradient(0,0,n,0)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(s,i),t.lineTo(n,s),t.closePath(),t.stroke(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,s),t.lineTo(o-n,s),t.closePath(),t.stroke(),(e=t.createLinearGradient(o-n,0,o,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o-n,r-s),t.lineTo(o-s,i),t.closePath(),t.stroke(),(e=t.createLinearGradient(0,r-this.edge,0,r)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(n+s,r-s),t.lineTo(o-n-s,r-s),t.closePath(),t.stroke())},RingMorph.prototype=new ReporterBlockMorph,(RingMorph.prototype.constructor=RingMorph).uber=ReporterBlockMorph.prototype,RingMorph.prototype.isCachingInputs=!1,RingMorph.prototype.init=function(){RingMorph.uber.init.call(this),this.category="other",this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast,this.setExtent(new Point(200,80))},RingMorph.prototype.rootForGrab=function(){return this.isDraggable?this:BlockMorph.uber.rootForGrab.call(this)},RingMorph.prototype.embed=function(t,e){var o;this.color=SpriteMorph.prototype.blockColor.other,this.isDraggable=!0,t instanceof CommandBlockMorph?(this.isStatic=!1,this.setSpec("%rc %ringparms"),this.selector="reifyScript",(o=this.parts()[0]).nestedBlock(t)):(t.isPredicate?(this.isStatic=!0,this.setSpec("%rp %ringparms"),this.selector="reifyPredicate"):t instanceof BooleanSlotMorph?(this.isStatic=!1,this.setSpec("%rp %ringparms"),this.selector="reifyPredicate"):(this.isStatic=!1,this.setSpec("%rr %ringparms"),this.selector="reifyReporter"),(o=this.parts()[0]).silentReplaceInput(o.contents(),t)),o=this.parts()[1],e&&e.forEach(function(t){o.addInput(t)}),this.fixBlockColor(null,!0)},RingMorph.prototype.vanishForSimilar=function(){var t=this.parts()[0].nestedBlock();return!t||!(this.parent instanceof SyntaxElementMorph)||this.parent instanceof RingReporterSlotMorph||this.parent instanceof RingCommandSlotMorph?null:void(("reportGetVar"===t.selector||"reportJSFunction"===t.selector||"reportAttributeOf"===t.selector||"reportCompiled"===t.selector||t instanceof RingMorph)&&this.parent.silentReplaceInput(this,t))},RingMorph.prototype.contents=function(){return this.parts()[0].nestedBlock()},RingMorph.prototype.inputNames=function(){return this.parts()[1].evaluate()},RingMorph.prototype.dataType=function(){switch(this.selector){case"reifyScript":return"command";case"reifyPredicate":return"predicate";default:return"reporter"}},RingMorph.prototype.fixBlockColor=function(t,e){var o=this.parts()[0];RingMorph.uber.fixBlockColor.call(this,t,e),o.fixLayout()},ScriptsMorph.prototype=new FrameMorph,(ScriptsMorph.prototype.constructor=ScriptsMorph).uber=FrameMorph.prototype,ScriptsMorph.prototype.cleanUpMargin=20,ScriptsMorph.prototype.cleanUpSpacing=15,ScriptsMorph.prototype.isPreferringEmptySlots=!0,ScriptsMorph.prototype.enableKeyboard=!0,ScriptsMorph.prototype.enableNestedAutoWrapping=!0,ScriptsMorph.prototype.init=function(){this.feedbackColor=SyntaxElementMorph.prototype.feedbackColor,this.feedbackMorph=new BoxMorph,this.rejectsHats=!1,this.lastDroppedBlock=null,this.lastReplacedInput=null,this.lastDropTarget=null,this.lastPreservedBlocks=null,this.lastNextBlock=null,this.lastWrapParent=null,this.focus=null,ScriptsMorph.uber.init.call(this),this.setColor(new Color(70,70,70)),this.noticesTransparentClick=!0,this.isAnimating=!1,this.dropRecord=null,this.recordDrop()},ScriptsMorph.prototype.fullCopy=function(){var e,o=new ScriptsMorph,r=this.position();return this.focus&&this.focus.stopEditing(),this.children.forEach(function(t){t.block||(e=t.fullCopy(),o.add(e),e.setPosition(t.position().subtract(r)),e instanceof BlockMorph&&e.allComments().forEach(function(t){t.align(e)}))}),o.adjustBounds(),o},ScriptsMorph.prototype.step=function(){var t,e=this.world(),o=e.hand;return this.feedbackMorph.parent&&(this.feedbackMorph.destroy(),this.feedbackMorph.parent=null),this.focus&&(!e.keyboardReceiver||e.keyboardReceiver instanceof StageMorph)&&this.focus.getFocus(e),0!==o.children.length&&this.bounds.containsPoint(o.bounds.origin)&&((t=o.children[0])instanceof BlockMorph||t instanceof CommentMorph)&&contains(o.morphAtPointer().allParents(),this)?void(t instanceof CommentMorph?this.showCommentDropFeedback(t,o):t instanceof ReporterBlockMorph?this.showReporterDropFeedback(t,o):this.showCommandDropFeedback(t)):null},ScriptsMorph.prototype.showReporterDropFeedback=function(t,e){var o=this.closestInput(t,e);if(null===o)return null;this.feedbackMorph.bounds=o.fullBounds().expandBy(Math.max(2*t.edge,t.reporterDropFeedbackPadding)),this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.add(this.feedbackMorph),o instanceof MultiArgMorph?(this.feedbackMorph.color=SpriteMorph.prototype.blockColor.lists.copy(),this.feedbackMorph.borderColor=SpriteMorph.prototype.blockColor.lists):(this.feedbackMorph.color=this.feedbackColor.copy(),this.feedbackMorph.borderColor=this.feedbackColor),this.feedbackMorph.color.a=.5,this.feedbackMorph.drawNew(),this.feedbackMorph.changed()},ScriptsMorph.prototype.showCommandDropFeedback=function(t){var e,o=t.closestAttachTarget(this);if(!o)return null;"wrap"!==o.loc?(this.add(this.feedbackMorph),this.feedbackMorph.border=0,this.feedbackMorph.edge=0,this.feedbackMorph.alpha=1,this.feedbackMorph.setExtent(new Point(o.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight))),this.feedbackMorph.color=this.feedbackColor,this.feedbackMorph.drawNew(),this.feedbackMorph.changed(),e=o.point.y,"bottom"===o.loc&&("block"===o.type?o.element.nextBlock()&&(e-=SyntaxElementMorph.prototype.corner):"slot"===o.type&&o.element.nestedBlock()&&(e-=SyntaxElementMorph.prototype.corner)),this.feedbackMorph.setPosition(new Point(o.element.left(),e))):this.showCSlotWrapFeedback(t,o.element)},ScriptsMorph.prototype.showCommentDropFeedback=function(t,e){var o=this.closestBlock(t,e);if(!o)return null;this.feedbackMorph.bounds=o.bounds.expandBy(Math.max(2*BlockMorph.prototype.edge,BlockMorph.prototype.reporterDropFeedbackPadding)),this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.add(this.feedbackMorph),this.feedbackMorph.color=t.color.copy(),this.feedbackMorph.color.a=.25,this.feedbackMorph.borderColor=t.titleBar.color,this.feedbackMorph.drawNew(),this.feedbackMorph.changed()},ScriptsMorph.prototype.showCSlotWrapFeedback=function(t,e){var o;this.feedbackMorph.bounds=e.fullBounds().expandBy(BlockMorph.prototype.corner),this.feedbackMorph.edge=SyntaxElementMorph.prototype.corner,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.add(this.feedbackMorph),o=t.color.lighter(40),this.feedbackMorph.color=o.copy(),this.feedbackMorph.color.a=.1,this.feedbackMorph.borderColor=o,this.feedbackMorph.drawNew(),this.feedbackMorph.changed()},ScriptsMorph.prototype.closestInput=function(e,t){var o,r,i=e.fullBoundsNoShadow(),n=this.children.filter(function(t){return t instanceof BlockMorph&&t.fullBounds().intersects(i)}),s=e.allInputs(),h=[];if(n.forEach(function(t){h=h.concat(t.allInputs())}),0===h.length)return null;if(this.isPreferringEmptySlots){if(t&&(o=t.position(),r=detect(h,function(t){return(t instanceof InputSlotMorph||t instanceof ArgMorph&&!(t instanceof CommandSlotMorph)&&!(t instanceof MultiArgMorph)||t instanceof RingMorph&&!t.contents()||t.isEmptySlot())&&!t.isLocked()&&t.bounds.containsPoint(o)&&!contains(s,t)})))return r;if(r=detect(h,function(t){return(t instanceof InputSlotMorph||t instanceof ArgMorph||t instanceof RingMorph&&!t.contents()||t.isEmptySlot())&&!t.isLocked()&&t.bounds.intersects(i)&&!contains(s,t)&&(!((e=t)instanceof MultiArgMorph)||(o?e.arrows().bounds.containsPoint(o):e.arrows().bounds.intersects(i)));var e,o}))return r}return t&&(o=t.position(),r=detect(h,function(t){return t!==e&&!t.isLocked()&&t.bounds.containsPoint(o)&&!(t.parent instanceof PrototypeHatBlockMorph)&&!contains(s,t)}))?r:detect(h,function(t){return t!==e&&!t.isLocked()&&t.fullBounds().intersects(i)&&!(t.parent instanceof PrototypeHatBlockMorph)&&!contains(s,t)})},ScriptsMorph.prototype.closestBlock=function(t,e){var o,r,i=t.bounds,n=this.children.filter(function(t){return t instanceof BlockMorph&&t.fullBounds().intersects(i)}),s=[];return n.forEach(function(t){s=s.concat(t.allChildren().slice(0).reverse().filter(function(t){return t instanceof BlockMorph&&!t.isTemplate}))}),0===s.length?null:e&&(o=e.position(),r=detect(s,function(t){return!t.comment&&!t.isPrototype&&t.bounds.containsPoint(o)}))?r:detect(s,function(t){return!t.comment&&!t.isPrototype&&t.bounds.intersects(i)})},ScriptsMorph.prototype.userMenu=function(){var t,e,o,r,i,n,s,h=new MenuMorph(this),a=this.parentThatIsA(IDE_Morph),l=16===this.world().currentKey,p=this,c=this.scriptTarget(),d=c.parentThatIsA(StageMorph);return a||(t=this.parentThatIsA(BlockEditorMorph))&&(a=t.target.parentThatIsA(IDE_Morph)),this.dropRecord&&(this.dropRecord.lastRecord&&(e=!0,h.addPair([new SymbolMorph("turnBack",MorphicPreferences.menuFontSize),localize("undrop")],"undrop","^Z","undo the last\nblock drop\nin this pane")),this.dropRecord.nextRecord&&(e=!0,h.addPair([new SymbolMorph("turnForward",MorphicPreferences.menuFontSize),localize("redrop")],"redrop","^Y","redo the last undone\nblock drop\nin this pane")),e&&(l&&h.addItem("clear undrop queue",function(){p.dropRecord=null,p.clearDropInfo(),p.recordDrop()},"forget recorded block drops\non this pane",new Color(100,0,0)),h.addLine())),h.addItem("clean up","cleanUp","arrange scripts\nvertically"),h.addItem("add comment","addComment"),h.addItem("scripts pic...","exportScriptsPicture","open a new window\nwith a picture of all scripts"),a&&(h.addLine(),!t&&c.exemplar&&(o="inherited",r=function(){c.toggleInheritanceForAttribute("scripts")},i=c.inheritsAttribute("scripts"),n="uncheck to\ndisinherit",s=localize("check to inherit\nfrom")+" "+c.exemplar.name,h.addItem((i?" ":" ")+localize(o),r,i?n:s)),h.addItem("make a block...",function(){new BlockDialogMorph(null,function(t){""!==t.spec&&(t.isGlobal?d.globalBlocks.push(t):c.customBlocks.push(t),a.flushPaletteCache(),a.refreshPalette(),new BlockEditorMorph(t,c).popUp())},p).prompt("Make a block",null,p.world())})),h},ScriptsMorph.prototype.cleanUp=function(){var t=this.selectForEdit(),o=t.topLeft(),r=t.cleanUpMargin;t.children.sort(function(t,e){return t instanceof PrototypeHatBlockMorph?0:t.top()-e.top()}).forEach(function(e){e instanceof CommentMorph&&e.block||(e.setPosition(o.add(new Point(t.cleanUpMargin,r))),e instanceof BlockMorph&&e.allComments().forEach(function(t){t.align(e,!0)}),r+=e.stackHeight()+t.cleanUpSpacing)}),t.parent&&t.setPosition(t.parent.topLeft()),t.adjustBounds()},ScriptsMorph.prototype.exportScriptsPicture=function(){var t=this.scriptsPicture(),e=this.world().children[0];t&&e.saveCanvasAs(t,(e.projectName||localize("untitled"))+" "+localize("script pic"))},ScriptsMorph.prototype.scriptsPicture=function(){var o,t,r;if(0!==this.children.length)return o=this.children[0].fullBounds(),this.children.forEach(function(t){t.isVisible&&(o=o.merge(t.fullBounds()))}),t=newCanvas(o.extent()),r=t.getContext("2d"),this.children.forEach(function(t){var e=t.fullBounds().origin;t.isVisible&&r.drawImage(t.fullImageClassic(),e.x-o.origin.x,e.y-o.origin.y)}),t},ScriptsMorph.prototype.addComment=function(){var t=this.parentThatIsA(IDE_Morph),e=this.parentThatIsA(BlockEditorMorph),o=this.world();(new CommentMorph).pickUp(o),!t&&e&&(t=e.target.parentThatIsA(IDE_Morph)),t&&(o.hand.grabOrigin={origin:t.palette,position:t.palette.center()})},ScriptsMorph.prototype.undrop=function(){var t=this;this.isAnimating||this.dropRecord&&this.dropRecord.lastRecord&&(this.dropRecord.situation||(this.dropRecord.situation=this.dropRecord.lastDroppedBlock.situation()),this.isAnimating=!0,this.dropRecord.lastDroppedBlock.slideBackTo(this.dropRecord.lastOrigin,null,this.recoverLastDrop(),function(){t.updateToolbar(),t.isAnimating=!1}),this.dropRecord=this.dropRecord.lastRecord)},ScriptsMorph.prototype.redrop=function(){var t=this;this.isAnimating||this.dropRecord&&this.dropRecord.nextRecord&&(this.dropRecord=this.dropRecord.nextRecord,"delete"===this.dropRecord.action?(this.recoverLastDrop(!0),this.dropRecord.lastDroppedBlock.destroy(),this.updateToolbar()):(this.isAnimating=!0,this.dropRecord.lastDroppedBlock.slideBackTo(this.dropRecord.situation,null,this.recoverLastDrop(!0),function(){t.updateToolbar(),t.isAnimating=!1})))},ScriptsMorph.prototype.recoverLastDrop=function(t){var e,o,r,i,n=this.dropRecord;if(!n||!n.lastDroppedBlock)throw new Error("nothing to undrop");if(r=(e=n.lastDroppedBlock).parent,e instanceof CommandBlockMorph)n.lastNextBlock&&("delete"!==n.action||t)&&this.add(n.lastNextBlock),n.lastDropTarget&&("bottom"===n.lastDropTarget.loc?"slot"===n.lastDropTarget.type?n.lastNextBlock&&n.lastDropTarget.element.nestedBlock(n.lastNextBlock):n.lastNextBlock&&n.lastDropTarget.element.nextBlock(n.lastNextBlock):"top"===n.lastDropTarget.loc?this.add(n.lastDropTarget.element):"wrap"===n.lastDropTarget.loc&&(i=detect(n.lastDroppedBlock.inputs(),function(t){return t instanceof CSlotMorph}),n.lastWrapParent instanceof CommandBlockMorph?t?o=function(){i.nestedBlock(n.lastDropTarget.element)}:n.lastWrapParent.nextBlock(n.lastDropTarget.element):n.lastWrapParent instanceof CommandSlotMorph?t?o=function(){i.nestedBlock(n.lastDropTarget.element)}:n.lastWrapParent.nestedBlock(n.lastDropTarget.element):this.add(n.lastDropTarget.element),n.lastDropTarget.element.blockSequence().forEach(function(t){t.fixBlockColor()}),i.fixLayout()));else if(e instanceof ReporterBlockMorph)n.lastDropTarget&&(n.lastDropTarget.replaceInput(n.lastDroppedBlock,n.lastReplacedInput),n.lastDropTarget.fixBlockColor(null,!0),n.lastPreservedBlocks&&n.lastPreservedBlocks.forEach(function(t){t.destroy()}));else{if(!(e instanceof CommentMorph))throw new Error("unsupported action for "+e);t&&n.lastDropTarget&&(o=function(){(n.lastDropTarget.element.comment=e).block=n.lastDropTarget.element,e.align()})}return this.clearDropInfo(),e.prepareToBeGrabbed(this.world().hand),e instanceof CommentMorph&&e.removeShadow(),this.add(e),r.reactToGrabOf(e),e instanceof ReporterBlockMorph&&r instanceof BlockMorph&&r.changed(),"delete"===n.action&&(t&&n.lastNextBlock&&(r instanceof CommandBlockMorph?r.nextBlock(n.lastNextBlock):r instanceof CommandSlotMorph&&r.nestedBlock(n.lastNextBlock)),t||e.moveBy(new Point(-100,-20))),o},ScriptsMorph.prototype.clearDropInfo=function(){this.lastDroppedBlock=null,this.lastReplacedInput=null,this.lastDropTarget=null,this.lastPreservedBlocks=null,this.lastNextBlock=null,this.lastWrapParent=null},ScriptsMorph.prototype.recordDrop=function(t){var e={lastDroppedBlock:this.lastDroppedBlock,lastReplacedInput:this.lastReplacedInput,lastDropTarget:this.lastDropTarget,lastPreservedBlocks:this.lastPreservedBlocks,lastNextBlock:this.lastNextBlock,lastWrapParent:this.lastWrapParent,lastOrigin:t,action:null,situation:null,lastRecord:this.dropRecord,nextRecord:null};this.dropRecord&&(this.dropRecord.nextRecord=e),this.dropRecord=e,this.updateToolbar()},ScriptsMorph.prototype.addToolbar=function(){var t=new AlignmentMorph,e=this,o=new Color(140,140,140);return t.respectHiddens=!0,t.undoButton=new PushButtonMorph(this,"undrop",new SymbolMorph("turnBack",12)),t.undoButton.alpha=.2,t.undoButton.padding=2,t.undoButton.labelShadowColor=o,t.undoButton.drawNew(),t.undoButton.fixLayout(),t.add(t.undoButton),t.redoButton=new PushButtonMorph(this,"redrop",new SymbolMorph("turnForward",12)),t.redoButton.alpha=.2,t.redoButton.padding=2,t.redoButton.labelShadowColor=o,t.redoButton.drawNew(),t.redoButton.fixLayout(),t.add(t.redoButton),t.keyboardButton=new ToggleButtonMorph(null,this,"toggleKeyboardEntry",[new SymbolMorph("keyboard",12),new SymbolMorph("keyboardFilled",12)],function(){return!isNil(e.focus)}),t.keyboardButton.alpha=.2,t.keyboardButton.padding=2,t.keyboardButton.hint="use the keyboard\nto enter blocks",t.keyboardButton.labelShadowColor=o,t.keyboardButton.drawNew(),t.keyboardButton.fixLayout(),t.add(t.keyboardButton),t},ScriptsMorph.prototype.updateToolbar=function(){var t=this.parentThatIsA(ScrollFrameMorph);t&&(t.toolBar||(t.toolBar=this.addToolbar(),t.add(t.toolBar)),this.enableKeyboard?(t.toolBar.keyboardButton.show(),t.toolBar.keyboardButton.refresh()):t.toolBar.keyboardButton.hide(),this.dropRecord&&(this.dropRecord.lastRecord?t.toolBar.undoButton.isVisible||t.toolBar.undoButton.show():t.toolBar.undoButton.isVisible&&t.toolBar.undoButton.hide(),this.dropRecord.nextRecord?t.toolBar.redoButton.isVisible||(t.toolBar.redoButton.show(),t.toolBar.undoButton.mouseLeave()):t.toolBar.redoButton.isVisible&&t.toolBar.redoButton.hide()),detect(t.toolBar.children,function(t){return t.isVisible})&&(t.toolBar.fixLayout(),t.adjustToolBar()))},ScriptsMorph.prototype.sortedElements=function(){var t=this.children.filter(function(t){return!(t instanceof CommentMorph)||!t.block});return t.sort(function(t,e){return t instanceof PrototypeHatBlockMorph?0:t.top()-e.top()}),t},ScriptsMorph.prototype.fixMultiArgs=function(){var t=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.forAllChildren(function(t){t instanceof MultiArgMorph&&t.fixLayout()}),Morph.prototype.trackChanges=t},ScriptsMorph.prototype.wantsDropOf=function(t){return t instanceof HatBlockMorph?!this.rejectsHats:t instanceof SyntaxElementMorph||t instanceof CommentMorph},ScriptsMorph.prototype.reactToDropOf=function(t,e){(t instanceof BlockMorph||t instanceof CommentMorph)&&t.snap(e),this.adjustBounds()},ScriptsMorph.prototype.mouseClickLeft=function(t){if(16===this.world().currentKey)return this.edit(t);this.focus&&this.focus.stopEditing()},ScriptsMorph.prototype.selectForEdit=function(){var t=this.parentThatIsA(IDE_Morph),e=t?t.currentSprite:null;return e&&e.inheritsAttribute("scripts")?(this.feedbackMorph.destroy(),e.shadowAttribute("scripts"),e.scripts):this},ScriptsMorph.prototype.edit=function(t){var e,o=this.world();this.focus&&this.focus.stopEditing(),o.stopEditing(),ScriptsMorph.prototype.enableKeyboard&&((e=this.selectForEdit()).focus=new ScriptFocusMorph(e,e,t),e.focus.getFocus(o))},ScriptsMorph.prototype.toggleKeyboardEntry=function(){var t,e,o=this.world();this.focus?this.focus.stopEditing():(o.stopEditing(),ScriptsMorph.prototype.enableKeyboard&&((t=this.selectForEdit()).focus=new ScriptFocusMorph(t,t,t.position()),t.focus.getFocus(o),(e=t.focus.sortedScripts()).length?(t.focus.element=e[0],t.focus.element instanceof HatBlockMorph&&t.focus.nextCommand()):t.focus.moveBy(new Point(50,50)),t.focus.fixLayout()))},ScriptsMorph.prototype.scriptTarget=function(){var t=this.parentThatIsA(IDE_Morph);if(t)return t.currentSprite;if(t=this.parentThatIsA(BlockEditorMorph))return t.target;throw new Error("script target bannot be found for orphaned scripts")},ArgMorph.prototype=new SyntaxElementMorph,(ArgMorph.prototype.constructor=ArgMorph).uber=SyntaxElementMorph.prototype,ArgMorph.prototype.init=function(t,e){this.type=t||null,this.isHole=!1,ArgMorph.uber.init.call(this,e),this.color=new Color(0,17,173),this.setExtent(new Point(50,50),e)},ArgMorph.prototype.executeOnSliderEdit=!1,ArgMorph.prototype.reactToSliderEdit=function(){var t,e,o,r;if(this.executeOnSliderEdit&&(t=this.parentThatIsA(BlockMorph))){if(o=(e=t.topBlock()).scriptTarget(),e instanceof PrototypeHatBlockMorph)return;o&&((r=o.parentThatIsA(StageMorph))&&(r.isThreadSafe||Process.prototype.enableSingleStepping)?r.threads.startProcess(e,o,r.isThreadSafe):e.mouseClickLeft())}},ArgMorph.prototype.justDropped=function(){this instanceof CommandSlotMorph||(this.drawNew(),this.changed())},ArgMorph.prototype.getSpec=function(){return"%s"},ArgMorph.prototype.drawNew=function(){"list"===this.type?(this.image=this.listIcon(),this.silentSetExtent(new Point(this.image.width,this.image.height))):"object"===this.type?(this.image=this.objectIcon(),this.silentSetExtent(new Point(this.image.width,this.image.height))):ArgMorph.uber.drawNew.call(this)},ArgMorph.prototype.listIcon=function(){var t,e,o,r,i=new Morph,n=new CellMorph,s=new CellMorph;return i.color=new Color(255,255,255),s.setPosition(n.bottomLeft().add(new Point(0,this.fontSize/3))),n.add(s),n.setPosition(i.position().add(this.fontSize)),i.add(n),i.bounds.corner=s.bounds.corner.add(this.fontSize),i.drawNew(),t=i.fullImage(),r=(this.fontSize+this.edge)/t.height,(o=(e=newCanvas(new Point(Math.ceil(t.width*r)+1,Math.ceil(t.height*r)+1))).getContext("2d")).fillStyle="black",o.fillRect(0,0,e.width,e.height),o.scale(r,r),o.drawImage(t,1/r,1/r),e},ArgMorph.prototype.objectIcon=function(){return this.labelPart("%turtle").image},ArgMorph.prototype.isEmptySlot=function(){return null!==this.type},CommandSlotMorph.prototype=new ArgMorph,(CommandSlotMorph.prototype.constructor=CommandSlotMorph).uber=ArgMorph.prototype,CommandSlotMorph.prototype.init=function(t){CommandSlotMorph.uber.init.call(this,null,!0),this.color=new Color(0,17,173),this.setExtent(new Point(230,4*this.corner+this.cSlotPadding),t)},CommandSlotMorph.prototype.getSpec=function(){return"%cmd"},CommandSlotMorph.prototype.topBlock=function(){return this.parent.topBlock?this.parent.topBlock():this.nestedBlock()},CommandSlotMorph.prototype.nestedBlock=function(t){if(!t)return detect(this.children,function(t){return t instanceof CommandBlockMorph});var e=this.nestedBlock();this.add(t),e&&t.bottomBlock().nextBlock(e),this.fixLayout()},CommandSlotMorph.prototype.slotAttachPoint=function(){return new Point(this.dentCenter(),this.top()+2*this.corner)},CommandSlotMorph.prototype.dentLeft=function(){return this.left()+this.corner+2*this.inset},CommandSlotMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent},CommandSlotMorph.prototype.attachTargets=function(){var t=[];return t.push({point:this.slotAttachPoint(),element:this,loc:"bottom",type:"slot"}),t},CommandSlotMorph.prototype.fixLayout=function(){var t=this.nestedBlock();this.parent&&(this.color.eq(this.parent.color)||this.setColor(this.parent.color)),t?(t.setPosition(new Point(this.left()+this.edge+this.rfBorder,this.top()+this.edge+this.rfBorder)),this.setWidth(t.fullBounds().width()+2*(this.edge+this.rfBorder)),this.setHeight(t.fullBounds().height()+this.edge+2*this.rfBorder-(this.corner-this.edge))):(this.setHeight(4*this.corner),this.setWidth(4*this.corner+this.inset+this.dent)),this.parent.fixLayout&&this.parent.fixLayout()},CommandSlotMorph.prototype.evaluate=function(){return this.nestedBlock()},CommandSlotMorph.prototype.isEmptySlot=function(){return!this.isStatic&&null===this.nestedBlock()},CommandSlotMorph.prototype.attach=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose new parent:"),o=this;t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){t.add(o),o.isDraggable=!1,t.fixLayout&&t.fixLayout()})}),0<t.length&&e.popUpAtHand(this.world())},CommandSlotMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,t.fillRect(0,0,this.width(),this.height()),t.fillStyle=this.rfColor.toString(),this.drawFlat(t),MorphicPreferences.isFlat||this.drawEdges(t)},CommandSlotMorph.prototype.drawFlat=function(t){var e=null!==this.nestedBlock(),o=e?this.inset:this.inset/2,r=e?this.dent:this.dent/2,i=2*this.corner+o,n=this.edge,s=e?this.rfBorder:0,h=this.height()-this.corner-n;t.beginPath(),t.arc(this.corner+n,this.corner+n,this.corner,radians(-180),radians(-90),!1),t.lineTo(this.corner+o+n+2*s,n),t.lineTo(i+n+2*s,this.corner+n),t.lineTo(i+n+2*s+(r-2*s),this.corner+n),t.lineTo(i+n+2*s+(r-2*s)+this.corner,n),t.lineTo(this.width()-this.corner-n,n),t.arc(this.width()-this.corner-n,this.corner+n,this.corner,radians(-90),radians(-0),!1),t.arc(this.width()-this.corner-n,h,this.corner,radians(0),radians(90),!1),t.arc(this.corner+n,h,this.corner,radians(90),radians(180),!1),t.closePath(),t.fill()},CommandSlotMorph.prototype.drawEdges=function(t){var e,o,r,i,n=null!==this.nestedBlock(),s=n?this.inset:this.inset/2,h=n?this.dent:this.dent/2,a=2*this.corner+s,l=this.edge,p=n?this.rfBorder:0,c=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(e=t.createLinearGradient(0,this.height(),0,this.height()-this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner+l,this.height()-c),t.lineTo(this.width()-this.corner-l,this.height()-c),t.stroke(),(e=t.createRadialGradient(this.width()-(this.corner+l),this.height()-(this.corner+l),this.corner,this.width()-(this.corner+l),this.height()-(this.corner+l),this.corner+l)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.arc(this.width()-(this.corner+l),this.height()-(this.corner+l),this.corner+c,radians(0),radians(90),!1),t.stroke(),(e=t.createLinearGradient(this.width(),0,this.width()-this.edge,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(this.width()-c,this.height()-this.corner-this.edge),t.lineTo(this.width()-c,l+this.corner),t.stroke(),t.shadowOffsetY=c,t.shadowBlur=this.edge,t.shadowColor=this.rfColor.darker(80).toString(),(e=t.createLinearGradient(0,0,l,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(c,l+this.corner),t.lineTo(c,this.height()-l-this.corner),t.stroke(),(e=t.createRadialGradient(this.corner+l,this.corner+l,this.corner,this.corner+l,this.corner+l,this.corner+l)).addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.arc(this.corner+l,this.corner+l,this.corner+c,radians(-180),radians(-90),!1),t.stroke(),(o=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.strokeStyle=o,t.beginPath(),t.moveTo(this.corner+l,c),t.lineTo(this.corner+s+l+2*p-c,c),t.stroke(),(r=t.createLinearGradient(0,this.corner,0,this.corner+l)).addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(a+l+2*p+c,this.corner+c),t.lineTo(a+l+2*p+(h-2*p),this.corner+c),t.stroke(),(i=t.createLinearGradient(a+l+2*p+(h-2*p)-c,this.corner,a+l+2*p+(h-2*p)+.7*c,this.corner+c+.7*c)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(a+l+2*p+(h-2*p),this.corner+c),t.lineTo(a+l+2*p+(h-2*p)+this.corner,c),t.stroke(),t.strokeStyle=o,t.beginPath(),t.moveTo(a+l+2*p+(h-2*p)+this.corner,c),t.lineTo(this.width()-this.corner-l,c),t.stroke()},RingCommandSlotMorph.prototype=new CommandSlotMorph,(RingCommandSlotMorph.prototype.constructor=RingCommandSlotMorph).uber=CommandSlotMorph.prototype,RingCommandSlotMorph.prototype.rfBorder=0,RingCommandSlotMorph.prototype.edge=RingMorph.prototype.edge,RingCommandSlotMorph.prototype.init=function(t){RingCommandSlotMorph.uber.init.call(this,t),this.isHole=!0,this.noticesTransparentClick=!0,this.color=new Color(0,17,173),this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast},RingCommandSlotMorph.prototype.getSpec=function(){return"%rc"},RingCommandSlotMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.drawFlat(t),MorphicPreferences.isFlat||this.drawEdges(t)},RingCommandSlotMorph.prototype.drawFlat=function(t){var e=null!==this.nestedBlock(),o=e?this.inset:this.inset/2,r=e?this.dent:this.dent/2,i=2*this.corner+o,n=this.edge,s=this.width(),h=this.height(),a=e?this.rfBorder:0,l=h-this.corner-n;t.beginPath(),t.moveTo(0,h/2),t.lineTo(n,h/2),t.arc(this.corner+n,this.corner+n,this.corner,radians(-180),radians(-90),!1),t.lineTo(this.corner+o+n+2*a,n),t.lineTo(i+n+2*a,this.corner+n),t.lineTo(i+n+2*a+(r-2*a),this.corner+n),t.lineTo(i+n+2*a+(r-2*a)+this.corner,n),t.lineTo(this.width()-this.corner-n,n),t.arc(s-this.corner-n,this.corner+n,this.corner,radians(-90),radians(-0),!1),t.lineTo(s-this.edge,h/2),t.lineTo(s,h/2),t.lineTo(s,0),t.lineTo(0,0),t.closePath(),t.fill(),t.beginPath(),t.moveTo(s,h/2),t.lineTo(s-n,h/2),t.arc(this.width()-this.corner-n,l,this.corner,radians(0),radians(90),!1),t.arc(this.corner+n,l,this.corner,radians(90),radians(180),!1),t.lineTo(n,h/2),t.lineTo(0,h/2),t.lineTo(0,h),t.lineTo(s,h),t.closePath(),t.fill()},CSlotMorph.prototype=new CommandSlotMorph,(CSlotMorph.prototype.constructor=CSlotMorph).uber=CommandSlotMorph.prototype,CSlotMorph.prototype.init=function(t){CommandSlotMorph.uber.init.call(this,null,!0),this.isHole=!0,this.isLambda=!1,this.isLoop=!1,this.color=new Color(0,17,173),this.setExtent(new Point(230,4*this.corner+this.cSlotPadding),t)},CSlotMorph.prototype.getSpec=function(){return this.isLoop?"%loop":"%c"},CSlotMorph.prototype.mappedCode=function(t){var i=(StageMorph.prototype.codeMappings.reify||"<#1>").split("\n"),e=this.nestedBlock(),n=(e?e.mappedCode(t):"").toString().split("\n"),s=new RegExp("<#1>","g");return i.forEach(function(t,e){var o,r="";0===t.trimLeft().indexOf("<#1>")&&(o=t.indexOf("<#1>"),r=t.slice(0,o)),i[e]=t.replace(new RegExp("<#1>"),n.join("\n"+r)),i[e]=i[e].replace(s,n.join("\n"))}),i.join("\n")},CSlotMorph.prototype.fixLayout=function(){var t=this.nestedBlock();t?(t.setPosition(new Point(this.left()+this.inset,this.top()+this.corner)),this.setHeight(t.fullBounds().height()+this.corner),this.setWidth(t.fullBounds().width()+2*this.cSlotPadding)):(this.setHeight(4*this.corner+this.cSlotPadding),this.setWidth(4*this.corner+2*this.inset+this.dent+2*this.cSlotPadding)),this.parent.fixLayout&&this.parent.fixLayout()},CSlotMorph.prototype.fixLoopLayout=function(){var t;this.isLoop&&(t=this.loop())&&(t.setRight(this.right()-this.corner),t.setBottom(this.bottom()+this.cSlotPadding+this.edge))},CSlotMorph.prototype.loop=function(){return this.isLoop?detect(this.children,function(t){return t instanceof SymbolMorph}):null},CSlotMorph.prototype.drawNew=function(){var t;this.fixLoopLayout(),this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.drawFlat(t),MorphicPreferences.isFlat||(this.drawTopRightEdge(t),this.drawTopEdge(t,this.inset,this.corner),this.drawTopLeftEdge(t),this.drawBottomEdge(t),this.drawRightEdge(t))},CSlotMorph.prototype.drawFlat=function(t){t.beginPath(),t.moveTo(0,0),t.lineTo(this.width(),0),t.arc(this.width()-this.corner,0,this.corner,radians(90),radians(0),!0),t.lineTo(this.width()-this.corner,this.corner),t.lineTo(2*this.inset+3*this.corner+this.dent,this.corner),t.lineTo(2*this.inset+2*this.corner+this.dent,2*this.corner),t.lineTo(2*this.inset+2*this.corner,2*this.corner),t.lineTo(2*this.inset+this.corner,this.corner),t.lineTo(this.inset+this.corner,this.corner),t.arc(this.inset+this.corner,2*this.corner,this.corner,radians(270),radians(180),!0),t.lineTo(this.inset,this.height()-2*this.corner),t.arc(this.inset+this.corner,this.height()-2*this.corner,this.corner,radians(180),radians(90),!0),t.lineTo(this.width()-this.corner,this.height()-this.corner),t.arc(this.width()-this.corner,this.height(),this.corner,radians(-90),radians(-0),!1),t.lineTo(0,this.height()),t.closePath(),t.fill()},CSlotMorph.prototype.drawTopRightEdge=function(t){var e=.5*this.edge,o=this.width()-this.corner,r=t.createRadialGradient(o,0,this.corner,o,0,this.corner-this.edge);r.addColorStop(0,this.cachedClrDark),r.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=r,t.beginPath(),t.arc(o,0,this.corner-e,radians(90),radians(0),!0),t.stroke()},CSlotMorph.prototype.drawTopEdge=function(t,e,o){var r,i,n,s=.5*this.edge,h=e+2*this.corner+this.inset;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(r=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(e+this.corner,o-s),t.lineTo(e+this.corner+this.inset-s,o-s),t.stroke(),(i=t.createLinearGradient(0,o+this.corner-this.edge,0,o+this.corner)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(h+s,o+this.corner-s),t.lineTo(h+this.dent,o+this.corner-s),t.stroke(),(n=t.createLinearGradient(e+this.inset+2*this.corner+this.dent-s,o+this.corner-s-s,e+this.inset+2*this.corner+this.dent+.7*s,o+this.corner-s+.7*s)).addColorStop(0,this.cachedClr),n.addColorStop(1,this.cachedClrDark),t.strokeStyle=n,t.beginPath(),t.moveTo(e+this.inset+2*this.corner+this.dent,o+this.corner-s),t.lineTo(e+3*this.corner+this.inset+this.dent,o-s),t.stroke(),t.strokeStyle=r,t.beginPath(),t.moveTo(e+3*this.corner+this.inset+this.dent,o-s),t.lineTo(this.width()-this.corner,o-s),t.stroke()},CSlotMorph.prototype.drawTopLeftEdge=function(t){var e=.5*this.edge,o=t.createRadialGradient(this.corner+this.inset,2*this.corner,this.corner,this.corner+this.inset,2*this.corner,this.corner+this.edge);o.addColorStop(0,this.cachedClrDark),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.arc(this.corner+this.inset,2*this.corner,this.corner+e,radians(-180),radians(-90),!1),t.stroke()},CSlotMorph.prototype.drawRightEdge=function(t){var e=.5*this.edge,o=this.inset,r=t.createLinearGradient(o-this.edge,0,o,0);r.addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=r,t.beginPath(),t.moveTo(o-e,2*this.corner),t.lineTo(o-e,this.height()-2*this.corner),t.stroke()},CSlotMorph.prototype.drawBottomEdge=function(t){var e,o,r=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(o=t.createRadialGradient(this.corner+this.inset,this.height()-2*this.corner,this.corner,this.corner+this.inset,this.height()-2*this.corner,this.corner+this.edge)).addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.arc(this.corner+this.inset,this.height()-2*this.corner,this.corner+r,radians(180),radians(90),!0),t.stroke(),(e=t.createLinearGradient(0,this.height()-this.corner,0,this.height()-this.corner+this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.inset+this.corner,this.height()-this.corner+r),t.lineTo(this.width()-this.corner,this.height()-this.corner+r),t.stroke()},InputSlotMorph.prototype=new ArgMorph,(InputSlotMorph.prototype.constructor=InputSlotMorph).uber=ArgMorph.prototype,InputSlotMorph.prototype.init=function(t,e,o,r){var i=new StringMorph(""),n=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));i.fontSize=this.fontSize,i.isShowingBlanks=!0,i.drawNew(),this.selectedBlock=null,this.isUnevaluated=!1,this.choices=o||null,this.oldContentsExtent=i.extent(),this.isNumeric=e||!1,this.isReadOnly=r||!1,this.minWidth=0,this.constant=null,InputSlotMorph.uber.init.call(this,null,!0),this.color=new Color(255,255,255),this.add(i),this.add(n),i.isEditable=!0,i.isDraggable=!1,i.enableSelecting(),this.setContents(t)},InputSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%n":"%s"},InputSlotMorph.prototype.contents=function(){return detect(this.children,function(t){return t instanceof StringMorph})},InputSlotMorph.prototype.arrow=function(){return detect(this.children,function(t){return t instanceof ArrowMorph})},InputSlotMorph.prototype.setContents=function(t){var e=this.contents(),o=t,r=o instanceof Array;if(this.selectedBlock&&(this.selectedBlock=null),r)o=localize(o[0]),e.isItalic=!this.isReadOnly;else if(o instanceof BlockMorph)this.selectedBlock=o,o="";else if(e.isItalic=!1,!isNil(this.choices)&&this.choices[o]instanceof Array)return this.setContents(this.choices[o]);e.text=o,isNil(o)?e.text="":o.toString&&(e.text=o.toString()),e.drawNew(),this.constant=r?t:null,this.isReadOnly&&this.parent instanceof BlockMorph&&this.parent.fixLabelColor()},InputSlotMorph.prototype.userSetContents=function(t){this.selectForEdit().setContents(t)},InputSlotMorph.prototype.dropDownMenu=function(t){var e=this.menuFromDict(this.choices,null,t);e&&0<e.items.length&&(t?(e.popup(this.world(),this.bottomLeft()),e.getFocus()):e.popUpAtHand(this.world()))},InputSlotMorph.prototype.menuFromDict=function(t,e,o){var r,i,n=this,s=new MenuMorph(this.userSetContents,null,this,this.fontSize);function h(t){n.setContents(t),n.reactToSliderEdit()}if(t instanceof Function)t=t.call(this);else if(isString(t)&&!(t=this[t](o)))return;for(r in e||s.addItem(" ",null),t)Object.prototype.hasOwnProperty.call(t,r)&&("~"===r[0]?s.addLine():0===r.indexOf("§_def")?s.addItem(t[r],t[r]):0===r.indexOf("§_dir")?((i=new DialMorph).rootForGrab=function(){return this},i.target=this,i.action=h,i.fillColor=this.parent.color,i.setRadius(3*this.fontSize),i.setValue(+this.evaluate(),!1,!0),s.addLine(),s.items.push(i),s.addLine()):t[r]instanceof Object&&!(t[r]instanceof Array)&&"function"!=typeof t[r]?s.addMenu(r,this.menuFromDict(t[r],!0)):s.addItem(r,t[r]));return s},InputSlotMorph.prototype.messagesMenu=function(){var e={},t=this.parentThatIsA(BlockMorph).scriptTarget().parentThatIsA(StageMorph),o=this,r=[];return t.children.concat(t).forEach(function(t){isSnapObject(t)&&(r=r.concat(t.allMessageNames()))}),r.forEach(function(t){e[t]=t}),0<r.length&&(e["~"]=null),e["new..."]=function(){new DialogBoxMorph(o,o.setContents,o).prompt("Message name",null,o.world())},e},InputSlotMorph.prototype.messagesReceivedMenu=function(){var e={"any message":["any message"]},t=this.parentThatIsA(BlockMorph).scriptTarget().parentThatIsA(StageMorph),o=this,r=[];return t.children.concat(t).forEach(function(t){isSnapObject(t)&&(r=r.concat(t.allMessageNames()))}),r.forEach(function(t){e[t]=t}),e["~"]=null,e["new..."]=function(){new DialogBoxMorph(o,o.setContents,o).prompt("Message name",null,o.world())},e},InputSlotMorph.prototype.collidablesMenu=function(){var e={"mouse-pointer":["mouse-pointer"],edge:["edge"],"pen trails":["pen trails"]},o=this.parentThatIsA(BlockMorph).scriptTarget(),t=o.parentThatIsA(StageMorph),r=[];return t.children.forEach(function(t){t instanceof SpriteMorph&&!t.isTemporary&&t.name!==o.name&&(r=r.concat(t.name))}),0<r.length&&(e["~"]=null,r.forEach(function(t){e[t]=t})),e},InputSlotMorph.prototype.locationMenu=function(){var e={"mouse-pointer":["mouse-pointer"],myself:["myself"]},o=this.parentThatIsA(BlockMorph).scriptTarget(),t=o.parentThatIsA(StageMorph),r=[];return t.children.forEach(function(t){t instanceof SpriteMorph&&!t.isTemporary&&t.name!==o.name&&(r=r.concat(t.name))}),0<r.length&&(e["~"]=null,r.forEach(function(t){e[t]=t})),e},InputSlotMorph.prototype.distancesMenu=function(){var t=this.parentThatIsA(BlockMorph),e={},o=this.parentThatIsA(BlockMorph).scriptTarget(),r=o.parentThatIsA(StageMorph),i=[];return t&&"reportRelationTo"!==t.selector&&(e["random position"]=["random position"]),e["mouse-pointer"]=["mouse-pointer"],e.center=["center"],r.children.forEach(function(t){t instanceof SpriteMorph&&!t.isTemporary&&t.name!==o.name&&(i=i.concat(t.name))}),0<i.length&&(e["~"]=null,i.forEach(function(t){e[t]=t})),e},InputSlotMorph.prototype.clonablesMenu=function(){var e={},t=this.parentThatIsA(BlockMorph).scriptTarget(),o=t.parentThatIsA(StageMorph),r=[];return t instanceof SpriteMorph&&(e.myself=["myself"]),o.children.forEach(function(t){t instanceof SpriteMorph&&!t.isTemporary&&(r=r.concat(t.name))}),0<r.length&&(e["~"]=null,r.forEach(function(t){e[t]=t})),e},InputSlotMorph.prototype.objectsMenuWithSelf=function(){return this.objectsMenu(!0)},InputSlotMorph.prototype.objectsMenu=function(t){var e=this.parentThatIsA(BlockMorph).scriptTarget().parentThatIsA(StageMorph),o={},r=[];return t&&(o.myself=["myself"]),o[e.name]=e.name,e.children.forEach(function(t){t instanceof SpriteMorph&&!t.isTemporary&&r.push(t.name)}),0<r.length&&(o["~"]=null,r.forEach(function(t){o[t]=t})),o},InputSlotMorph.prototype.typesMenu=function(){var t={number:["number"],text:["text"],Boolean:["Boolean"],list:["list"]};return SpriteMorph.prototype.enableFirstClass&&(t.sprite=["sprite"]),t.costume=["costume"],t.sound=["sound"],t.command=["command"],t.reporter=["reporter"],t.predicate=["predicate"],t},InputSlotMorph.prototype.gettablesMenu=function(){var t={},e=SpriteMorph.prototype.enableNesting,o=StageMorph.prototype.enableInheritance;return t.neighbors=["neighbors"],t.self=["self"],t["other sprites"]=["other sprites"],t.clones=["clones"],t["other clones"]=["other clones"],e&&(t.parts=["parts"],t.anchor=["anchor"]),t.stage=["stage"],o&&(t.children=["children"],t.parent=["parent"],t["temporary?"]=["temporary?"]),t.name=["name"],t.costume=["costume"],t.costumes=["costumes"],t.sounds=["sounds"],t["dangling?"]=["dangling?"],t["draggable?"]=["draggable?"],t.width=["width"],t.height=["height"],t["rotation style"]=["rotation style"],t["rotation x"]=["rotation x"],t["rotation y"]=["rotation y"],t["center x"]=["center x"],t["center y"]=["center y"],t},InputSlotMorph.prototype.attributesMenu=function(){var t=this.parentThatIsA(BlockMorph),e=t.inputs()[1].evaluate(),o=t.scriptTarget().parentThatIsA(StageMorph),r={},i=[],n=e===o.name?o:detect(o.children,function(t){return t.name===e});return n&&(r=n instanceof SpriteMorph?{"x position":["x position"],"y position":["y position"],direction:["direction"],"costume #":["costume #"],"costume name":["costume name"],size:["size"],width:["width"],height:["height"],volume:["volume"],balance:["balance"]}:{"costume #":["costume #"],"costume name":["costume name"],volume:["volume"],balance:["balance"],width:["width"],height:["height"]},0<(i=n.variables.names()).length&&(r["~"]=null,i.forEach(function(t){r[t]=t})),n.allBlocks(!0).forEach(function(t,e){r["§_def"+e]=t.blockInstance(!0)})),r},InputSlotMorph.prototype.costumesMenu=function(){var t=this.parentThatIsA(BlockMorph).scriptTarget(),e=[],o=t instanceof SpriteMorph?{Turtle:["Turtle"]}:{Empty:["Empty"]};return o.current=["current"],t.costumes.asArray().forEach(function(t){e=e.concat(t.name)}),0<e.length&&(o["~"]=null,e.forEach(function(t){o[t]=t})),o},InputSlotMorph.prototype.soundsMenu=function(){var t=this.parentThatIsA(BlockMorph).scriptTarget(),e=[],o={};return t.sounds.asArray().forEach(function(t){e=e.concat(t.name)}),0<e.length&&e.forEach(function(t){o[t]=t}),o},InputSlotMorph.prototype.shadowedVariablesMenu=function(){var t,e=this.parentThatIsA(BlockMorph),o={};return e&&(t=e.scriptTarget(),this.parentThatIsA(RingMorph)||"receiveOnClone"===this.topBlock().selector?(t.variables.names().forEach(function(t){o[t]=t}),t.attributes.forEach(function(t){o[t]=[t]})):t&&t.exemplar&&(t.inheritedVariableNames(!0).forEach(function(t){o[t]=t}),t.shadowedAttributes().forEach(function(t){o[t]=[t]}))),o},InputSlotMorph.prototype.pianoKeyboardMenu=function(){var t,e,o=this.parentThatIsA(BlockMorph);o&&(e=o.scriptTarget().instrument),(t=new PianoMenuMorph(this.setContents,this,this.fontSize,e)).popup(this.world(),new Point(this.right()-t.width()/2,this.bottom())),t.selectKey(+this.evaluate())},InputSlotMorph.prototype.directionDialMenu=function(){return{"§_dir":null}},InputSlotMorph.prototype.audioMenu=function(){var t={volume:["volume"],note:["note"],frequency:["frequency"],samples:["samples"],"sample rate":["sample rate"],spectrum:["spectrum"],resolution:["resolution"]};return 16===this.world().currentKey&&(t["~"]=null,t.modifier=["modifier"],t.output=["output"]),t},InputSlotMorph.prototype.setChoices=function(t,e){var o=this.contents();this.choices=t,this.isReadOnly=e||!1,this.parent instanceof BlockMorph&&(this.parent.fixLabelColor(),e||(o.shadowOffset=new Point,o.shadowColor=null,o.setColor(new Color(0,0,0)))),this.fixLayout()},InputSlotMorph.prototype.fixLayout=function(){var t,e,o,r=this.contents(),i=this.arrow();r.isNumeric=this.isNumeric,r.isEditable=!this.isReadOnly,this.isReadOnly?(r.disableSelecting(),r.color=new Color(254,254,254)):(r.enableSelecting(),r.color=new Color(0,0,0)),this.choices?(i.setSize(this.fontSize),i.show()):i.hide(),o=i.isVisible?i.width():0,t=this.selectedBlock?(e=this.selectedBlock.height()+2*this.edge,this.selectedBlock.width()+o+2*this.edge+2*this.typeInPadding):(e=r.height()+2*this.edge,this.isNumeric?r.width()+Math.floor(.5*o)+e+2*this.typeInPadding:Math.max(r.width()+o+2*this.edge+2*this.typeInPadding,r.rawHeight?r.rawHeight()+o:fontHeight(r.fontSize)/1.3+o,this.minWidth)),this.setExtent(new Point(t,e)),this.isNumeric?r.setPosition(new Point(Math.floor(e/2),this.edge).add(new Point(this.typeInPadding,0)).add(this.position())):r.setPosition(new Point(this.edge,this.edge).add(new Point(this.typeInPadding,0)).add(this.position())),i.isVisible&&i.setPosition(new Point(this.right()-o-this.edge,r.top())),this.parent&&this.parent.fixLayout&&(this.world()?(this.startLayout(),this.parent.fixLayout(),this.endLayout()):this.parent.fixLayout())},InputSlotMorph.prototype.mouseDownLeft=function(t){var e;this.isReadOnly||this.arrow().bounds.containsPoint(t)?this.escalateEvent("mouseDownLeft",t):((e=this.world())&&e.stopEditing(),this.selectForEdit().contents().edit())},InputSlotMorph.prototype.mouseClickLeft=function(t){this.arrow().bounds.containsPoint(t)||this.isReadOnly?this.dropDownMenu():this.contents().edit()},InputSlotMorph.prototype.reactToKeystroke=function(){var t;this.constant&&(t=this.contents(),this.constant=null,t.isItalic=!1,t.drawNew())},InputSlotMorph.prototype.reactToEdit=function(){this.contents().clearSelection()},InputSlotMorph.prototype.freshTextEdit=function(t){this.onNextStep=function(){t.selectAll()}},InputSlotMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return StageMorph.prototype.enableCodeMapping?(this.isNumeric?t.addItem("code number mapping...","mapNumberToCode"):t.addItem("code string mapping...","mapStringToCode"),t):this.parent.userMenu()},InputSlotMorph.prototype.mapStringToCode=function(){new DialogBoxMorph(this,function(t){StageMorph.prototype.codeMappings.string=t},this).promptCode("Code mapping - String <#1>",StageMorph.prototype.codeMappings.string||"",this.world())},InputSlotMorph.prototype.mapNumberToCode=function(){new DialogBoxMorph(this,function(t){StageMorph.prototype.codeMappings.number=t},this).promptCode("Code mapping - Number <#1>",StageMorph.prototype.codeMappings.number||"",this.world())},InputSlotMorph.prototype.mappedCode=function(){var t=this.parentThatIsA(BlockMorph),e=this.evaluate();return this.isNumeric?(StageMorph.prototype.codeMappings.number||"<#1>").replace(/<#1>/g,e):!isNaN(parseFloat(e))||!isString(e)||t&&contains(["doSetVar","doChangeVar","doShowVar","doHideVar"],t.selector)?e:(StageMorph.prototype.codeMappings.string||"<#1>").replace(/<#1>/g,e)},InputSlotMorph.prototype.evaluate=function(){var t,e;return this.selectedBlock?this.selectedBlock:this.constant?this.constant:(e=this.contents(),this.isNumeric&&(t=parseFloat(e.text||"0"),!isNaN(t))?t:e.text)},InputSlotMorph.prototype.isEmptySlot=function(){return""===this.contents().text&&!this.selectedBlock},InputSlotMorph.prototype.flash=function(){this.cachedNormalColor||(this.cachedNormalColor=this.color,this.color=this.activeHighlight,this.drawNew(),this.changed())},InputSlotMorph.prototype.unflash=function(){var t;this.cachedNormalColor&&(t=this.cachedNormalColor,this.cachedNormalColor=null,this.color=t,this.drawNew(),this.changed())},InputSlotMorph.prototype.drawNew=function(){var t,e,o;this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),e=this.cachedNormalColor?this.color:this.parent?this.parent.color:new Color(120,120,120),t.fillStyle=this.color.toString(),this.isReadOnly&&!this.cachedNormalColor&&(t.fillStyle=e.darker().toString()),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),this.isNumeric?(o=(this.height()-2*this.edge)/2,t.beginPath(),t.arc(o+this.edge,o+this.edge,o,radians(90),radians(-90),!1),t.arc(this.width()-o-this.edge,o+this.edge,o,radians(-90),radians(90),!1),t.closePath(),t.fill(),MorphicPreferences.isFlat||this.drawRoundBorder(t)):(t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),MorphicPreferences.isFlat||this.drawRectBorder(t)),this.selectedBlock&&t.drawImage(this.selectedBlock.fullImageClassic(),this.edge+this.typeInPadding,this.edge)},InputSlotMorph.prototype.drawRectBorder=function(t){var e,o=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.shadowOffsetY=o,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,o),t.lineTo(this.width()-this.edge-o,o),t.stroke(),t.shadowOffsetY=0,(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o,this.edge),t.lineTo(o,this.height()-this.edge-o),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(0,this.height()-this.edge,0,this.height())).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,this.height()-o),t.lineTo(this.width()-this.edge,this.height()-o),t.stroke(),(e=t.createLinearGradient(this.width()-this.edge,0,this.width(),0)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.width()-o,this.edge),t.lineTo(this.width()-o,this.height()-this.edge),t.stroke()},InputSlotMorph.prototype.drawRoundBorder=function(t){var e,o,r,i=.5*this.edge,n=(this.height()-2*this.edge)/2;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(e=n+this.edge)<(o=this.width()-n-this.edge)&&(t.shadowOffsetX=i,t.shadowOffsetY=i,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(r=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(e,i),t.lineTo(o,i),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0),(r=t.createLinearGradient(0,this.height()-this.edge,0,this.height())).addColorStop(0,this.cachedClrBright),r.addColorStop(1,this.cachedClr),t.strokeStyle=r,t.beginPath(),t.moveTo(n+this.edge,this.height()-i),t.lineTo(this.width()-n-this.edge,this.height()-i),t.stroke(),n=this.height()/2,t.shadowOffsetX=i,t.shadowOffsetY=i,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(r=t.createRadialGradient(n,n,n-this.edge,n,n,n)).addColorStop(1,this.cachedClr),r.addColorStop(0,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.arc(n,n,n-i,radians(180),radians(270),!1),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(r=t.createRadialGradient(this.width()-n,n,n-this.edge,this.width()-n,n,n)).addColorStop(1,this.cachedClr),r.addColorStop(0,this.cachedClrBright),t.strokeStyle=r,t.beginPath(),t.arc(this.width()-n,n,n-i,radians(0),radians(90),!1),t.stroke()},TemplateSlotMorph.prototype=new ArgMorph,(TemplateSlotMorph.prototype.constructor=TemplateSlotMorph).uber=ArgMorph.prototype,TemplateSlotMorph.prototype.init=function(t){var e=new ReporterBlockMorph;this.labelString=t||"",e.isDraggable=!1,e.isTemplate=!0,void 0!==modules.objects?(e.color=SpriteMorph.prototype.blockColor.variables,e.category="variables"):(e.color=new Color(243,118,29),e.category=null),e.setSpec(this.labelString),e.selector="reportGetVar",TemplateSlotMorph.uber.init.call(this),this.add(e),this.fixLayout(),this.isDraggable=!1,this.isStatic=!0},TemplateSlotMorph.prototype.getSpec=function(){return"%t"},TemplateSlotMorph.prototype.template=function(){return this.children[0]},TemplateSlotMorph.prototype.contents=function(){return this.template().blockSpec},TemplateSlotMorph.prototype.setContents=function(t){var e=this.template();e.setSpec(t),e.fixBlockColor(),e.fixLabelColor()},TemplateSlotMorph.prototype.evaluate=function(){return this.contents()},TemplateSlotMorph.prototype.fixLayout=function(){var t=this.template();this.setExtent(t.extent().add(2*this.edge+2)),t.setPosition(this.position().add(this.edge+1)),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},TemplateSlotMorph.prototype.wantsDropOf=function(t){return"reportGetVar"===t.selector},TemplateSlotMorph.prototype.reactToDropOf=function(t){"reportGetVar"===t.selector&&t.destroy()},TemplateSlotMorph.prototype.drawNew=function(){var t;this.parent instanceof Morph&&(this.color=this.parent.color.copy()),this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.drawRounded(t)},TemplateSlotMorph.prototype.drawRounded=ReporterBlockMorph.prototype.drawRounded,TemplateSlotMorph.prototype.flash=function(){this.template().flash()},TemplateSlotMorph.prototype.unflash=function(){this.template().unflash()},BooleanSlotMorph.prototype=new ArgMorph,(BooleanSlotMorph.prototype.constructor=BooleanSlotMorph).uber=ArgMorph.prototype,BooleanSlotMorph.prototype.isTernary=!1,BooleanSlotMorph.prototype.init=function(t){this.value="boolean"==typeof t?t:null,this.isUnevaluated=!1,BooleanSlotMorph.uber.init.call(this)},BooleanSlotMorph.prototype.getSpec=function(){return this.isUnevaluated?"%boolUE":"%b"},BooleanSlotMorph.prototype.evaluate=function(){return this.value},BooleanSlotMorph.prototype.isEmptySlot=function(){return null===this.value},BooleanSlotMorph.prototype.isBinary=function(){return!this.isTernary&&isNil(this.parentThatIsA(RingMorph))&&!isNil(this.parentThatIsA(ScriptsMorph))},BooleanSlotMorph.prototype.setContents=function(t,e){this.value="boolean"==typeof t?t:null,e||(this.drawNew(),this.changed())},BooleanSlotMorph.prototype.toggleValue=function(){var t,e=this.selectForEdit();if(e!==this)return this.toggleValue.call(e);if(t=this.parentThatIsA(IDE_Morph),this.isStatic||this.isBinary())this.setContents(!this.value,!0);else switch(this.value){case!0:this.value=!1;break;case!1:this.value=null;break;default:this.value=!0}if(t&&!t.isAnimating)return this.drawNew(),void this.changed();this.drawNew(3),this.changed(),this.nextSteps([function(){this.drawNew(2),this.changed()},function(){this.drawNew(1),this.changed()},function(){this.drawNew(),this.changed()}])},BooleanSlotMorph.prototype.mouseClickLeft=function(){this.toggleValue(),isNil(this.value)||this.reactToSliderEdit()},BooleanSlotMorph.prototype.mouseEnter=function(){if(!this.isStatic){if(!1===this.value&&!this.isBinary()){var t=this.value;return this.value=null,this.drawNew(3),this.changed(),void(this.value=t)}this.drawNew(1),this.changed()}},BooleanSlotMorph.prototype.mouseLeave=function(){this.isStatic||(this.drawNew(),this.changed())},BooleanSlotMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return StageMorph.prototype.enableCodeMapping?(!0===this.evaluate()?t.addItem("code true mapping...","mapTrueToCode"):t.addItem("code false mapping...","mapFalseToCode"),t):this.parent.userMenu()},BooleanSlotMorph.prototype.mapTrueToCode=function(){new DialogBoxMorph(this,function(t){StageMorph.prototype.codeMappings.true=t},this).promptCode("Code mapping - true",StageMorph.prototype.codeMappings.true||"true",this.world())},BooleanSlotMorph.prototype.mapFalseToCode=function(){new DialogBoxMorph(this,function(t){StageMorph.prototype.codeMappings.false=t},this).promptCode("Code mapping - false",StageMorph.prototype.codeMappings.false||"false",this.world())},BooleanSlotMorph.prototype.mappedCode=function(){return!0===this.evaluate()?StageMorph.prototype.codeMappings.boolTrue||"true":StageMorph.prototype.codeMappings.boolFalse||"false"},BooleanSlotMorph.prototype.drawNew=function(t){var e,o,r=this.isStatic?this.textLabel():null;r?(o=r.height+3*this.edge,this.silentSetExtent(new Point(r.width+1.5*o+2*this.edge,o))):this.silentSetExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge)),this.cachedNormalColor||(this.color=this.parent?this.parent.color:new Color(200,200,200)),this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),e=this.image.getContext("2d"),this.drawDiamond(e,t),this.drawLabel(e,r),this.drawKnob(e,t)},BooleanSlotMorph.prototype.drawDiamond=function(t,e){var o,r=this.width(),i=this.height(),n=i/2,s=r/2,h=this.edge/2;if(this.cachedNormalColor)t.fillStyle=this.color.toString();else switch(this.value){case!0:t.fillStyle="rgb(0, 200, 0)";break;case!1:t.fillStyle="rgb(200, 0, 0)";break;default:t.fillStyle=this.color.darker(25).toString()}e&&!this.isEmptySlot()?(t.fillStyle="rgb(0, 200, 0)",t.beginPath(),t.moveTo(0,n),t.lineTo(n,0),t.lineTo(s,0),t.lineTo(s,i),t.lineTo(n,i),t.closePath(),t.fill(),t.fillStyle="rgb(200, 0, 0)",t.beginPath(),t.moveTo(s,0),t.lineTo(r-n,0),t.lineTo(r,n),t.lineTo(r-n,i),t.lineTo(s,i)):(t.beginPath(),t.moveTo(0,n),t.lineTo(n,0),t.lineTo(r-n,0),t.lineTo(r,n),t.lineTo(r-n,i),t.lineTo(n,i)),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.shadowOffsetX=h,t.shadowBlur=h,t.shadowColor="black",(o=t.createLinearGradient(0,n,.6*this.edge,n+.6*this.edge)).addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(h,n),t.lineTo(n,h),t.closePath(),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=h,t.shadowBlur=this.edge,(o=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(n,h),t.lineTo(r-n,h),t.closePath(),t.stroke(),t.shadowOffsetY=0,t.shadowBlur=0,(o=t.createLinearGradient(r-n-.6*this.edge,i-.6*this.edge,r-n,i)).addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(r-n,i-h),t.lineTo(r-h,n),t.closePath(),t.stroke(),(o=t.createLinearGradient(0,i-this.edge,0,i)).addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(n,i-h),t.lineTo(r-n-h,i-h),t.closePath(),t.stroke())},BooleanSlotMorph.prototype.drawLabel=function(t,e){var o,r=this.width(),i=this.height()/2-this.edge,n=i/2,s=this.edge/2,h=this.height()/2;if(!this.isEmptySlot()){if(e)return h=(this.height()-e.height)/2,o=this.value?this.height()/2:this.width()-this.height()/2-e.width,MorphicPreferences.isFlat||(t.shadowOffsetX=-s,t.shadowOffsetY=-s,t.shadowBlur=s,t.shadowColor=this.value?"rgb(0, 100, 0)":"rgb(100, 0, 0)"),void t.drawImage(e,o,h);o=i+2*this.edge+s,MorphicPreferences.isFlat||(t.shadowOffsetX=-s,t.shadowOffsetY=-s,t.shadowBlur=s,t.shadowColor="rgb(0, 100, 0)"),t.strokeStyle="white",t.lineWidth=this.edge+s,t.lineCap="round",t.lineJoin="miter",t.beginPath(),t.moveTo(o-n,h),t.lineTo(o,h+n),t.lineTo(o+n,n+this.edge),t.stroke(),o=r-h-2*this.edge,MorphicPreferences.isFlat||(t.shadowOffsetX=-s,t.shadowOffsetY=-s,t.shadowBlur=s,t.shadowColor="rgb(100, 0, 0)"),t.strokeStyle="white",t.lineWidth=this.edge,t.lineCap="butt",t.beginPath(),t.moveTo(o-n,h-n),t.lineTo(o+n,h+n),t.moveTo(o-n,h+n),t.lineTo(o+n,h-n),t.stroke()}},BooleanSlotMorph.prototype.drawKnob=function(t,e){var o,r,i=this.width(),n=this.height()/2,s=this.edge/2,h=(this.width()-this.height())/4*(e||0),a=n,l=PushButtonMorph.prototype.outline/2,p=PushButtonMorph.prototype.outlineColor,c=PushButtonMorph.prototype.color,d=PushButtonMorph.prototype.contrast,u=c.lighter(d),f=c.darker(d);switch(this.value){case!1:r=n+h,MorphicPreferences.isFlat||(t.shadowOffsetX=s,t.shadowOffsetY=0,t.shadowBlur=s,t.shadowColor="black");break;case!0:r=i-n-h,MorphicPreferences.isFlat||(t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0);break;default:if(!e)return;r=n,MorphicPreferences.isFlat||(t.shadowOffsetX=s,t.shadowOffsetY=0,t.shadowBlur=s,t.shadowColor="black"),t.globalAlpha=.2*((e||0)+1)}t.fillStyle=c.toString(),t.beginPath(),t.arc(r,a,n,radians(0),radians(360)),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.shadowOffsetX=0,t.shadowBlur=0,t.shadowColor="black",t.lineWidth=l,t.strokeStyle=p.toString(),t.beginPath(),t.arc(r,a,n-l/2,radians(0),radians(360)),t.stroke(),(o=t.createRadialGradient(r,a,n-l-this.edge,r,a,n-l)).addColorStop(1,u.toString()),o.addColorStop(0,c.toString()),t.strokeStyle=o,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(r,a,n-l-this.edge/2,radians(180),radians(270),!1),t.stroke(),(o=t.createRadialGradient(r,a,n-l-this.edge,r,a,n-l)).addColorStop(1,f.toString()),o.addColorStop(0,c.toString()),t.strokeStyle=o,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(r,a,n-l-this.edge/2,radians(0),radians(90),!1),t.stroke())},BooleanSlotMorph.prototype.textLabel=function(){if(this.isEmptySlot())return null;var t=new StringMorph(localize("true"),this.fontSize,null,!0,null,null,null,null,new Color(255,255,255)).image,e=new StringMorph(localize("false"),this.fontSize,null,!0,null,null,null,null,new Color(255,255,255)).image,o=newCanvas(new Point(Math.max(t.width,e.width),Math.max(t.height,e.height))),r=this.value?t:e,i=(o.width-r.width)/2,n=(o.height-r.height)/2;return o.getContext("2d").drawImage(r,i,n),o},ArrowMorph.prototype=new Morph,(ArrowMorph.prototype.constructor=ArrowMorph).uber=Morph.prototype,ArrowMorph.prototype.init=function(t,e,o,r){this.direction=t||"down",this.size=e||(0===e?0:50),this.padding=o||0,ArrowMorph.uber.init.call(this,!0),this.color=r||new Color(0,0,0),this.setExtent(new Point(this.size,this.size))},ArrowMorph.prototype.setSize=function(t){var e=Math.max(t,1);this.size=t,this.setExtent(new Point(e,e))},ArrowMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var t=this.image.getContext("2d"),e=this.padding,o=this.height(),r=Math.floor(o/2),i=this.width(),n=Math.floor(i/2);t.fillStyle=this.color.toString(),t.beginPath(),"down"===this.direction?(t.moveTo(e,r),t.lineTo(i-e,r),t.lineTo(n,o-e)):"up"===this.direction?(t.moveTo(e,r),t.lineTo(i-e,r),t.lineTo(n,e)):("left"===this.direction?(t.moveTo(e,r),t.lineTo(n,e)):(t.moveTo(n,e),t.lineTo(i-e,r)),t.lineTo(n,o-e)),t.closePath(),t.fill()},TextSlotMorph.prototype=new InputSlotMorph,(TextSlotMorph.prototype.constructor=TextSlotMorph).uber=InputSlotMorph.prototype,TextSlotMorph.prototype.init=function(t,e,o,r){var i=new TextMorph(""),n=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));i.fontSize=this.fontSize,i.drawNew(),this.isUnevaluated=!1,this.choices=o||null,this.oldContentsExtent=i.extent(),this.isNumeric=e||!1,this.isReadOnly=r||!1,this.minWidth=0,this.constant=null,InputSlotMorph.uber.init.call(this,null,null,null,null,!0),this.color=new Color(255,255,255),this.add(i),this.add(n),i.isEditable=!0,i.isDraggable=!1,i.enableSelecting(),this.setContents(t)},TextSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%mln":"%mlt"},TextSlotMorph.prototype.contents=function(){return detect(this.children,function(t){return t instanceof TextMorph})},TextSlotMorph.prototype.layoutChanged=function(){this.fixLayout()},ColorSlotMorph.prototype=new ArgMorph,(ColorSlotMorph.prototype.constructor=ColorSlotMorph).uber=ArgMorph.prototype,ColorSlotMorph.prototype.init=function(t){ColorSlotMorph.uber.init.call(this,null,!0),this.setColor(t||new Color(145,26,68))},ColorSlotMorph.prototype.getSpec=function(){return"%clr"},ColorSlotMorph.prototype.getUserColor=function(){var o=this,r=this.world(),i=r.hand,n=getDocumentPositionOf(r.worldCanvas),t=i.processMouseMove,e=i.processMouseDown,s=i.processMouseUp,h=new ColorPaletteMorph(null,new Point(16*this.fontSize,10*this.fontSize));r.add(h),h.setPosition(this.bottomLeft().add(new Point(0,this.edge))),i.processMouseMove=function(t){var e=r.getGlobalPixelColor(i.position());i.setPosition(new Point(t.pageX-n.x,t.pageY-n.y)),e.a&&o.setColor(e)},i.processMouseDown=nop,i.processMouseUp=function(){h.destroy(),i.processMouseMove=t,i.processMouseDown=e,i.processMouseUp=s}},ColorSlotMorph.prototype.mouseClickLeft=function(){this.selectForEdit().getUserColor()},ColorSlotMorph.prototype.evaluate=function(){return this.color},ColorSlotMorph.prototype.drawNew=function(){var t,e,o=this.fontSize+2*this.edge+2*this.typeInPadding;this.silentSetExtent(new Point(o,o)),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),e=this.parent?this.parent.color:new Color(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),MorphicPreferences.isFlat||this.drawRectBorder(t)},ColorSlotMorph.prototype.drawRectBorder=InputSlotMorph.prototype.drawRectBorder,BlockHighlightMorph.prototype=new Morph,(BlockHighlightMorph.prototype.constructor=BlockHighlightMorph).uber=Morph.prototype,BlockHighlightMorph.prototype.readout=function(){return this.children.length?this.children[0]:null},BlockHighlightMorph.prototype.updateReadout=function(){var t=this.readout(),e=useBlurredShadows&&!MorphicPreferences.isFlat?.4*SyntaxElementMorph.prototype.activeBlur:-2*SyntaxElementMorph.prototype.activeBorder;this.threadCount<2?t&&t.destroy():(t?(t.contents=this.threadCount.toString(),t.fullChanged(),t.drawNew(),t.fullChanged()):(t=new SpeechBubbleMorph(this.threadCount.toString(),this.color,null,null,this.color.darker(),null,1),this.add(t)),t.setPosition(this.position().add(e)))},MultiArgMorph.prototype=new ArgMorph,(MultiArgMorph.prototype.constructor=MultiArgMorph).uber=ArgMorph.prototype,MultiArgMorph.prototype.init=function(t,e,o,r,i,n,s,h,a){var l,p,c,d,u=new FrameMorph;for(this.slotSpec=t||"%s",this.labelText=localize(e||""),this.minInputs=o||0,this.elementSpec=r||null,this.labelColor=n||null,this.shadowColor=s||null,this.shadowOffset=h||null,this.canBeEmpty=!0,MultiArgMorph.uber.init.call(this,null,!0),this.alpha=!1===a?1:0,u.alpha=!1===a?1:0,u.noticesTransparentClick=!0,this.noticesTransparentclick=!0,!this.labelText&&"%cs"!==this.slotSpec||(l=this.labelPart(this.labelText),this.add(l),l.hide()),p=new ArrowMorph("left",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),i),c=new ArrowMorph("right",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),i),u.add(p),u.add(c),u.drawNew(),u.acceptsDrops=!1,this.add(u),d=0;d<this.minInputs;d+=1)this.addInput()},MultiArgMorph.prototype.label=function(){return this.labelText?this.children[0]:null},MultiArgMorph.prototype.arrows=function(){return this.children[this.children.length-1]},MultiArgMorph.prototype.getSpec=function(){return"%mult"+this.slotSpec},MultiArgMorph.prototype.setContents=function(t){for(var e=this.inputs(),o=0;o<t.length;o+=1)null!==t[o]&&e[o]&&e[o].setContents(t[o])},MultiArgMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},MultiArgMorph.prototype.show=function(){this.isVisible=!0,this.changed()},MultiArgMorph.prototype.setLabelColor=function(t,e,o){this.textColor=t,this.shadowColor=e,this.shadowOffset=o,MultiArgMorph.uber.setLabelColor.call(this,t,e,o)},MultiArgMorph.prototype.fixLayout=function(){var t,e,o;"%t"===this.slotSpec&&(this.isStatic=!0),this.parent&&(t=this.label(),this.color=this.parent.color,this.arrows().color=this.color,t&&(e=this.shadowColor||this.parent.color.darker(this.labelContrast),o=this.shadowOffset||(t?t.shadowOffset:null),t.shadowColor.eq(e)||(t.shadowColor=e,t.shadowOffset=o,t.drawNew()))),this.fixArrowsLayout(),MultiArgMorph.uber.fixLayout.call(this),this.parent&&this.parent.fixLayout()},MultiArgMorph.prototype.fixArrowsLayout=function(){var t=this.label(),e=this.arrows(),o=e.children[0],r=e.children[1],i=new Point(r.width()/2,r.height());this.inputs().length<this.minInputs+1?(t&&t.hide(),o.hide(),r.setPosition(e.position().subtract(new Point(i.x,0))),e.setExtent(i)):(t&&t.show(),o.show(),r.setPosition(o.topCenter()),e.bounds.corner=r.bottomRight().copy()),e.drawNew()},MultiArgMorph.prototype.refresh=function(){this.inputs().forEach(function(t){t.drawNew()})},MultiArgMorph.prototype.drawNew=function(){MultiArgMorph.uber.drawNew.call(this),this.refresh()},MultiArgMorph.prototype.addInput=function(t){var e,o,r=this.labelPart(this.slotSpec),i=this.children.length-1;if(t)r.setContents(t);else if("%scriptVars"===this.elementSpec||"%blockVars"===this.elementSpec){for(o="",e=i;0<e;)o=String.fromCharCode(97+(e-1)%26)+o,e=Math.floor((e-1)/26);r.setContents(o)}else contains(["%parms","%ringparms"],this.elementSpec)&&r.setContents("#"+i);(r.parent=this).children.splice(i,0,r),r.drawNew(),this.fixLayout()},MultiArgMorph.prototype.removeInput=function(){var t,e;1<this.children.length&&(t=this.children[this.children.length-2],this.removeChild(t),!(t instanceof BlockMorph)||t instanceof RingMorph&&!t.contents()||(e=this.parentThatIsA(ScriptsMorph))&&e.add(t)),this.fixLayout()},MultiArgMorph.prototype.mouseClickLeft=function(t){if(this.parentThatIsA(ScriptsMorph)){var e,o=this.selectForEdit(),r=o.arrows(),i=r.children[0],n=r.children[1],s=16===o.world().currentKey?3:1;if(o.startLayout(),n.bounds.containsPoint(t))for(e=0;e<s;e+=1)n.isVisible&&o.addInput();else if(i.bounds.containsPoint(t))for(e=0;e<s;e+=1)i.isVisible&&o.removeInput();else o.escalateEvent("mouseClickLeft",t);o.endLayout()}else this.escalateEvent("mouseClickLeft",t)},MultiArgMorph.prototype.userMenu=function(){var t=new MenuMorph(this),e=this.parentThatIsA(BlockMorph),o="",r=this;return StageMorph.prototype.enableCodeMapping?(e&&(e instanceof RingMorph?o="parms_":"doDeclareVariables"===e.selector&&(o="tempvars_")),t.addItem("code list mapping...",function(){r.mapCodeList(o)}),t.addItem("code item mapping...",function(){r.mapCodeItem(o)}),t.addItem("code delimiter mapping...",function(){r.mapCodeDelimiter(o)}),t):this.parent.userMenu()},MultiArgMorph.prototype.mapCodeDelimiter=function(t){this.mapToCode(t+"delim","list item delimiter")},MultiArgMorph.prototype.mapCodeList=function(t){this.mapToCode(t+"list","list contents <#1>")},MultiArgMorph.prototype.mapCodeItem=function(t){this.mapToCode(t+"item","list item <#1>")},MultiArgMorph.prototype.mapToCode=function(e,t){new DialogBoxMorph(this,function(t){StageMorph.prototype.codeMappings[e]=t},this).promptCode("Code mapping - "+t,StageMorph.prototype.codeMappings[e]||"",this.world())},MultiArgMorph.prototype.mappedCode=function(e){var t,o,r,i=this.parentThatIsA(BlockMorph),n="",s="",h=0,a=[];return i&&(i instanceof RingMorph?n="parms_":"doDeclareVariables"===i.selector&&(n="tempvars_")),t=StageMorph.prototype.codeMappings[n+"list"]||"<#1>",o=StageMorph.prototype.codeMappings[n+"item"]||"<#1>",r=StageMorph.prototype.codeMappings[n+"delim"]||" ",this.inputs().forEach(function(t){a.push(o.replace(/<#1>/g,t.mappedCode(e)))}),a.forEach(function(t){h&&(s+=r),s+=t,h+=1}),t=t.replace(/<#1>/g,s)},MultiArgMorph.prototype.evaluate=function(){var e=[];return this.inputs().forEach(function(t){e.push(t.evaluate())}),e},MultiArgMorph.prototype.isEmptySlot=function(){return!!this.canBeEmpty&&0===this.inputs().length},ArgLabelMorph.prototype=new ArgMorph,(ArgLabelMorph.prototype.constructor=ArgLabelMorph).uber=ArgMorph.prototype,ArgLabelMorph.prototype.init=function(t,e){var o;this.labelText=localize(e||"input list:"),ArgLabelMorph.uber.init.call(this,null,!0),this.isStatic=!0,this.alpha=0,this.noticesTransparentclick=!0,o=this.labelPart(this.labelText),this.add(o),this.add(t)},ArgLabelMorph.prototype.label=function(){return this.children[0]},ArgLabelMorph.prototype.argMorph=function(){return this.children[1]},ArgLabelMorph.prototype.fixLayout=function(){var t,e,o=this.label();this.parent&&(this.color=this.parent.color,t=(e=o.shadowOffset||new Point).x<0?this.parent.color.darker(this.labelContrast):this.parent.color.lighter(this.labelContrast),""!==this.labelText&&(o.shadowColor.eq(t)||(o.shadowColor=t,o.shadowOffset=e,o.drawNew()))),ArgLabelMorph.uber.fixLayout.call(this),this.parent&&this.parent.fixLayout()},ArgLabelMorph.prototype.refresh=function(){this.inputs().forEach(function(t){t.drawNew()})},ArgLabelMorph.prototype.drawNew=function(){ArgLabelMorph.uber.drawNew.call(this),this.refresh()},ArgLabelMorph.prototype.setLabelColor=function(t,e,o){var r;""!==this.labelText&&((r=this.label()).color=t,r.shadowColor=e,r.shadowOffset=o,r.drawNew())},ArgLabelMorph.prototype.reactToGrabOf=function(){this.parent instanceof SyntaxElementMorph&&this.parent.revertToDefaultInput(this)},ArgLabelMorph.prototype.evaluate=function(){return this.argMorph().evaluate()},ArgLabelMorph.prototype.isEmptySlot=function(){return!1},FunctionSlotMorph.prototype=new ArgMorph,(FunctionSlotMorph.prototype.constructor=FunctionSlotMorph).uber=ArgMorph.prototype,FunctionSlotMorph.prototype.init=function(t,e){FunctionSlotMorph.uber.init.call(this,null,!0),this.isPredicate=t||!1,this.color=this.rfColor,this.setExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge),e)},FunctionSlotMorph.prototype.getSpec=function(){return"%f"},FunctionSlotMorph.prototype.drawNew=function(){var t,e;this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),e=this.parent?this.parent.color:new Color(120,120,120),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),this.isPredicate?this.drawDiamond(t):this.drawRounded(t)},FunctionSlotMorph.prototype.drawRounded=function(t){var e,o=this.height(),r=Math.min(this.rounding,o/2),i=this.width(),n=this.edge/2;t.fillStyle=this.color.toString(),t.beginPath(),t.arc(r,r,r,radians(-180),radians(-90),!1),t.arc(i-r,r,r,radians(-90),radians(-0),!1),t.arc(i-r,o-r,r,radians(0),radians(90),!1),t.arc(r,o-r,r,radians(90),radians(180),!1),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(r,o-r,r-n,radians(90),radians(180),!1),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(i-r,r,r-n,radians(-90),radians(0),!1),t.stroke(),t.shadowOffsetX=n,t.shadowOffsetY=n,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,n),t.lineTo(i-r+n,n),t.stroke(),(e=t.createRadialGradient(r,r,r-this.edge,r,r,r)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(r,r,r-n,radians(180),radians(270),!1),t.stroke(),(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,r),t.lineTo(n,o-r),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createRadialGradient(i-r,o-r,r-this.edge,i-r,o-r,r)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(i-r,o-r,r-n,radians(0),radians(90),!1),t.stroke(),(e=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,o-n),t.lineTo(i-r+n,o-n),t.stroke(),(e=t.createLinearGradient(i-this.edge,0,i,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,r+n),t.lineTo(i-n,o-r),t.stroke())},FunctionSlotMorph.prototype.drawDiamond=function(t){var e,o=this.width(),r=this.height(),i=Math.floor(r/2),n=Math.min(this.rounding,i),s=this.edge/2;t.fillStyle=this.color.toString(),t.beginPath(),t.moveTo(0,i),t.lineTo(n,0),t.lineTo(o-n,0),t.lineTo(o,i),t.lineTo(o-n,r),t.lineTo(n,r),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(s,i),t.lineTo(n,r-s),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(o-s,i),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=s,t.shadowOffsetY=s,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(e=t.createLinearGradient(0,0,n,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(s,i),t.lineTo(n,s),t.stroke(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,s),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(o-n,0,o,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(o-n,r-s),t.lineTo(o-s,i),t.stroke(),(e=t.createLinearGradient(0,r-this.edge,0,r)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(n+s,r-s),t.lineTo(o-n-s,r-s),t.stroke())},ReporterSlotMorph.prototype=new FunctionSlotMorph,(ReporterSlotMorph.prototype.constructor=ReporterSlotMorph).uber=FunctionSlotMorph.prototype,ReporterSlotMorph.prototype.init=function(t){ReporterSlotMorph.uber.init.call(this,t,!0),this.add(this.emptySlot()),this.fixLayout()},ReporterSlotMorph.prototype.emptySlot=function(){var t=new ArgMorph,e=2*this.rfBorder+2*this.edge;return t.color=this.rfColor,t.alpha=0,t.setExtent(new Point(2*(this.fontSize+2*this.edge)-e,this.fontSize+2*this.edge-e)),t},ReporterSlotMorph.prototype.getSpec=function(){return"%r"},ReporterSlotMorph.prototype.contents=function(){return this.children[0]},ReporterSlotMorph.prototype.nestedBlock=function(){var t=this.contents();return t instanceof ReporterBlockMorph?t:null},ReporterSlotMorph.prototype.evaluate=function(){return this.nestedBlock()},ReporterSlotMorph.prototype.isEmptySlot=function(){return null===this.nestedBlock()},ReporterSlotMorph.prototype.fixLayout=function(){var t=this.contents();this.setExtent(t.extent().add(2*this.edge+2*this.rfBorder)),t.setCenter(this.center()),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},RingReporterSlotMorph.prototype=new ReporterSlotMorph,(RingReporterSlotMorph.prototype.constructor=RingReporterSlotMorph).uber=ReporterSlotMorph.prototype,RingReporterSlotMorph.prototype.rfBorder=RingCommandSlotMorph.prototype.rfBorder,RingReporterSlotMorph.prototype.edge=RingCommandSlotMorph.prototype.edge,RingReporterSlotMorph.prototype.enableCommandDrops=!0,RingReporterSlotMorph.prototype.init=function(t){RingReporterSlotMorph.uber.init.call(this,t,!0),this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast,this.isHole=!0},RingReporterSlotMorph.prototype.getSpec=function(){return"%rr"},RingReporterSlotMorph.prototype.replaceInput=function(t,e){RingReporterSlotMorph.uber.replaceInput.call(this,t,e),this.parent instanceof RingMorph&&this.parent.vanishForSimilar()},RingReporterSlotMorph.prototype.slotAttachPoint=CommandSlotMorph.prototype.slotAttachPoint,RingReporterSlotMorph.prototype.dentLeft=CommandSlotMorph.prototype.dentLeft,RingReporterSlotMorph.prototype.dentCenter=CommandSlotMorph.prototype.dentCenter,RingReporterSlotMorph.prototype.attachTargets=function(){return!RingReporterSlotMorph.prototype.enableCommandDrops||this.contents()instanceof ReporterBlockMorph?[]:CommandSlotMorph.prototype.attachTargets.call(this)},RingReporterSlotMorph.prototype.nestedBlock=function(t){if(!t)return detect(this.children,function(t){return t instanceof BlockMorph});var e=this.nestedBlock();this.silentReplaceInput(this.children[0],t),e&&t.bottomBlock().nextBlock(e),this.fixLayout()},RingReporterSlotMorph.prototype.fixLayout=function(){this.contents()instanceof CommandBlockMorph?CommandSlotMorph.prototype.fixLayout.call(this):RingReporterSlotMorph.uber.fixLayout.call(this)},RingReporterSlotMorph.prototype.drawRounded=function(t){var e,o=this.height(),r=Math.min(this.rounding,o/2),i=this.width(),n=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,o/2),t.arc(r,r,r,radians(-180),radians(-90),!1),t.arc(i-r,r,r,radians(-90),radians(-0),!1),t.lineTo(i,o/2),t.lineTo(i,0),t.lineTo(0,0),t.closePath(),t.fill(),t.beginPath(),t.moveTo(i,o/2),t.arc(i-r,o-r,r,radians(0),radians(90),!1),t.arc(r,o-r,r,radians(90),radians(180),!1),t.lineTo(0,o/2),t.lineTo(0,o),t.lineTo(i,o),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(r,o-r,r-n,radians(90),radians(180),!1),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(i-r,r,r-n,radians(-90),radians(0),!1),t.stroke(),t.shadowOffsetX=n,t.shadowOffsetY=n,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,n),t.lineTo(i-r+n,n),t.stroke(),(e=t.createRadialGradient(r,r,r-this.edge,r,r,r)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(r,r,r-n,radians(180),radians(270),!1),t.stroke(),(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,r),t.lineTo(n,o-r),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createRadialGradient(i-r,o-r,r-this.edge,i-r,o-r,r)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(i-r,o-r,r-n,radians(0),radians(90),!1),t.stroke(),(e=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,o-n),t.lineTo(i-r+n,o-n),t.stroke(),(e=t.createLinearGradient(i-this.edge,0,i,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,r+n),t.lineTo(i-n,o-r),t.stroke())},RingReporterSlotMorph.prototype.drawDiamond=function(t){var e,o=this.width(),r=this.height(),i=Math.floor(r/2),n=Math.min(this.rounding,i),s=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,0),t.lineTo(0,i),t.lineTo(n,0),t.lineTo(o-n,0),t.lineTo(o,i),t.lineTo(o,0),t.closePath(),t.fill(),t.moveTo(o,i),t.lineTo(o-n,r),t.lineTo(n,r),t.lineTo(0,i),t.lineTo(0,r),t.lineTo(o,r),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(s,i),t.lineTo(n,r-s),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(o-s,i),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=s,t.shadowOffsetY=s,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(e=t.createLinearGradient(0,0,n,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(s,i),t.lineTo(n,s),t.stroke(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,s),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(o-n,0,o,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(o-n,r-s),t.lineTo(o-s,i),t.stroke(),(e=t.createLinearGradient(0,r-this.edge,0,r)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(n+s,r-s),t.lineTo(o-n-s,r-s),t.stroke())},CommentMorph.prototype=new BoxMorph,(CommentMorph.prototype.constructor=CommentMorph).uber=BoxMorph.prototype,CommentMorph.prototype.refreshScale=function(){CommentMorph.prototype.fontSize=SyntaxElementMorph.prototype.fontSize,CommentMorph.prototype.padding=5*SyntaxElementMorph.prototype.scale,CommentMorph.prototype.rounding=8*SyntaxElementMorph.prototype.scale},CommentMorph.prototype.refreshScale(),CommentMorph.prototype.init=function(t){var e=this,o=SyntaxElementMorph.prototype.scale;this.block=null,this.stickyOffset=null,this.isCollapsed=!1,this.titleBar=new BoxMorph(this.rounding,1.000001*o,new Color(255,255,180)),this.titleBar.color=new Color(255,255,180),this.titleBar.setHeight(fontHeight(this.fontSize)+this.padding),this.title=null,this.arrow=new ArrowMorph("down",this.fontSize),this.arrow.noticesTransparentClick=!0,this.arrow.mouseClickLeft=function(){e.toggleExpand()},this.contents=new TextMorph(t||localize("add comment here..."),this.fontSize),this.contents.isEditable=!0,this.contents.enableSelecting(),this.contents.maxWidth=90*o,this.contents.drawNew(),this.handle=new HandleMorph(this.contents,80,2*this.fontSize,-2,-2),this.handle.setExtent(new Point(11*o,11*o)),this.anchor=null,CommentMorph.uber.init.call(this,this.rounding,1.000001*o,new Color(255,255,180)),this.color=new Color(255,255,220),this.isDraggable=!0,this.add(this.titleBar),this.add(this.arrow),this.add(this.contents),this.add(this.handle),this.fixLayout()},CommentMorph.prototype.fullCopy=function(){var t=new CommentMorph(this.contents.text);return t.isCollapsed=this.isCollapsed,t.setTextWidth(this.textWidth()),this.selectionID&&(t.selectionID=!0),t},CommentMorph.prototype.setTextWidth=function(t){this.contents.maxWidth=t,this.contents.drawNew(),this.fixLayout()},CommentMorph.prototype.textWidth=function(){return this.contents.maxWidth},CommentMorph.prototype.text=function(){return this.contents.text},CommentMorph.prototype.toggleExpand=function(){this.isCollapsed=!this.isCollapsed,this.fixLayout(),this.align()},CommentMorph.prototype.layoutChanged=function(){this.fixLayout(),this.align()},CommentMorph.prototype.fixLayout=function(){var t,e=this.contents.width()+2*this.padding,o=this,r=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.title&&(this.title.destroy(),this.title=null),this.isCollapsed?(this.contents.hide(),this.title=new FrameMorph,this.title.alpha=0,this.title.acceptsDrops=!1,(t=new StringMorph(this.contents.text,this.fontSize,null,!0)).rootForGrab=function(){return o},this.title.add(t),this.title.setHeight(t.height()),this.title.setWidth(e-this.arrow.width()-2*this.padding-this.rounding),this.add(this.title)):this.contents.show(),this.titleBar.setWidth(e),this.contents.setLeft(this.titleBar.left()+this.padding),this.contents.setTop(this.titleBar.bottom()+this.padding),this.arrow.direction=this.isCollapsed?"right":"down",this.arrow.drawNew(),this.arrow.setCenter(this.titleBar.center()),this.arrow.setLeft(this.titleBar.left()+this.padding),this.title&&this.title.setPosition(this.arrow.topRight().add(new Point(this.padding,0))),Morph.prototype.trackChanges=r,this.changed(),this.silentSetHeight(this.titleBar.height()+(this.isCollapsed?0:this.padding+this.contents.height()+this.padding)),this.silentSetWidth(this.titleBar.width()),this.drawNew(),this.handle.drawNew(),this.changed()},CommentMorph.prototype.userMenu=function(){var t=new MenuMorph(this),i=this;return t.addItem("duplicate",function(){var t=i.fullCopy(),e=i.parentThatIsA(IDE_Morph),o=i.parentThatIsA(BlockEditorMorph),r=i.world();t.pickUp(r),!e&&o&&(e=o.target.parentThatIsA(IDE_Morph)),e&&(r.hand.grabOrigin={origin:e.palette,position:e.palette.center()})},"make a copy\nand pick it up"),t.addItem("delete","userDestroy"),t.addItem("comment pic...",function(){var t=i.parentThatIsA(IDE_Morph);t.saveCanvasAs(i.fullImageClassic(),(t.projectName||localize("untitled"))+" "+localize("comment pic"))},"open a new window\nwith a picture of this comment"),t},CommentMorph.prototype.userDestroy=function(){this.selectForEdit().destroy()},CommentMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},CommentMorph.prototype.show=function(){this.isVisible=!0,this.changed()},CommentMorph.prototype.prepareToBeGrabbed=function(t){this.block&&(this.block.comment=null,this.block=null),this.anchor&&(this.anchor.destroy(),this.anchor=null,this.removeShadow(),this.addShadow())},CommentMorph.prototype.selectForEdit=SyntaxElementMorph.prototype.selectForEdit,CommentMorph.prototype.snap=function(t){var e,o=this.parent;if(!(o instanceof ScriptsMorph))return null;o.clearDropInfo(),null!==(e=o.closestBlock(this,t))&&((e.comment=this).block=e,this.snapSound&&this.snapSound.play(),o.lastDropTarget={element:e}),this.align(),o.lastDroppedBlock=this,t&&o.recordDrop(t.grabOrigin)},CommentMorph.prototype.align=function(t,e){var o,r,i,n,s,h;this.block&&(h=(o=t||this.block.topBlock()).parentThatIsA(ScriptsMorph),this.setTop(this.block.top()+this.block.corner),i=this.top(),n=this.bottom(),r=o.allChildren().filter(function(t){return t instanceof BlockMorph&&t.bottom()>i&&t.top()<n}),s=Math.max.apply(null,r.map(function(t){return t.right()})),this.setLeft(s+5),!e&&h&&h.addBack(this),this.anchor||(this.anchor=new Morph,this.anchor.color=this.titleBar.color),this.anchor.silentSetPosition(new Point(this.block.right(),this.top()+this.edge)),this.anchor.bounds.corner=new Point(this.left(),this.top()+this.edge+1),this.anchor.drawNew(),this.addBack(this.anchor),this.anchor.changed())},CommentMorph.prototype.startFollowing=function(t,e){this.align(t),e.add(this),this.addShadow(),this.stickyOffset=this.position().subtract(this.block.position()),this.step=function(){this.block?this.setPosition(this.block.position().add(this.stickyOffset)):this.stopFollowing()}},CommentMorph.prototype.stopFollowing=function(){this.removeShadow(),delete this.step},CommentMorph.prototype.destroy=function(){this.block&&(this.block.comment=null),CommentMorph.uber.destroy.call(this)},CommentMorph.prototype.stackHeight=function(){return this.height()},ScriptFocusMorph.prototype=new BoxMorph,(ScriptFocusMorph.prototype.constructor=ScriptFocusMorph).uber=BoxMorph.prototype,ScriptFocusMorph.prototype.init=function(t,e,o){this.editor=t,this.element=e,this.atEnd=!1,ScriptFocusMorph.uber.init.call(this),this.element instanceof ScriptsMorph&&this.setPosition(o)},ScriptFocusMorph.prototype.getFocus=function(t){(t=t||this.world())&&t.keyboardReceiver!==this&&t.stopEditing(),(t.keyboardReceiver=this).fixLayout(),this.editor.updateToolbar()},ScriptFocusMorph.prototype.fixLayout=function(){this.changed(),this.element instanceof CommandBlockMorph||this.element instanceof CommandSlotMorph||this.element instanceof ScriptsMorph?this.manifestStatement():this.manifestExpression(),this.editor.add(this),this.scrollIntoView(),this.changed()},ScriptFocusMorph.prototype.manifestStatement=function(){var t=this.element instanceof ScriptsMorph,e=this.element.top();this.border=0,this.edge=0,this.alpha=1,this.color=this.editor.feedbackColor,this.setExtent(new Point(t?SyntaxElementMorph.prototype.hatWidth:this.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight))),this.element instanceof CommandSlotMorph?e+=SyntaxElementMorph.prototype.corner:this.atEnd&&(e=this.element.bottom()),t||this.setPosition(new Point(this.element.left(),e)),this.fps=2,this.show(),this.step=function(){this.toggleVisibility()}},ScriptFocusMorph.prototype.manifestExpression=function(){this.edge=SyntaxElementMorph.prototype.rounding,this.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.color=this.editor.feedbackColor.copy(),this.color.a=.5,this.borderColor=this.editor.feedbackColor,this.bounds=this.element.fullBounds().expandBy(Math.max(2*SyntaxElementMorph.prototype.edge,SyntaxElementMorph.prototype.reporterDropFeedbackPadding)),this.drawNew(),delete this.fps,delete this.step,this.show()},ScriptFocusMorph.prototype.trigger=function(){var t=this.element;t instanceof MultiArgMorph?t.arrows().children[1].isVisible&&(t.addInput(),this.fixLayout()):t.parent instanceof TemplateSlotMorph?t.mouseClickLeft():t instanceof BooleanSlotMorph?t.toggleValue():t instanceof InputSlotMorph&&(t.isReadOnly?t.choices&&(t.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):(delete this.fps,delete this.step,this.hide(),this.world().onNextStep=function(){t.contents().edit(),t.contents().selectAll()}))},ScriptFocusMorph.prototype.menu=function(){var t=this.element;t instanceof InputSlotMorph&&t.choices?(t.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):this.insertVariableGetter()},ScriptFocusMorph.prototype.deleteLastElement=function(){var t=this.element;t.parent instanceof ScriptsMorph?(this.atEnd||t instanceof ReporterBlockMorph)&&(t.destroy(),this.element=this.editor,this.atEnd=!1):t instanceof MultiArgMorph?t.arrows().children[0].isVisible&&t.removeInput():t instanceof BooleanSlotMorph?t.isStatic||t.setContents(null):t instanceof ReporterBlockMorph?t.isTemplate||(this.lastElement(),t.prepareToBeGrabbed(),t.destroy()):t instanceof CommandBlockMorph&&(this.atEnd?(this.element=t.parent,t.userDestroy()):t.parent instanceof CommandBlockMorph&&t.parent.userDestroy()),this.editor.adjustBounds(),this.fixLayout()},ScriptFocusMorph.prototype.insertBlock=function(t){var e=this;this.world().add(t),t.glideTo(this.position(),null,null,function(){e.fillInBlock(t)})},ScriptFocusMorph.prototype.fillInBlock=function(t){var e,o,r,i;t.isTemplate=!1,t.isDraggable=!0,t.snapSound&&t.snapSound.play(),this.element instanceof ScriptsMorph?(this.editor.add(t),(this.element=t)instanceof CommandBlockMorph?(t.setLeft(this.left()),t.isStop()?t.setTop(this.top()):(t.setBottom(this.top()),this.atEnd=!0)):(t.setCenter(this.center()),t.setLeft(this.left()))):this.element instanceof CommandBlockMorph?this.atEnd?(this.element.nextBlock(t),this.element=t,this.fixLayout()):(e=this.element.parent)instanceof ScriptsMorph?(t.setLeft(this.element.left()),t.setBottom(this.element.top()+this.element.corner),this.editor.add(t),t.nextBlock(this.element),this.fixLayout()):e instanceof CommandSlotMorph?e.nestedBlock(t):e instanceof RingReporterSlotMorph?(t.nextBlock(e.nestedBlock()),e.add(t),e.fixLayout()):e instanceof CommandBlockMorph&&e.nextBlock(t):this.element instanceof CommandSlotMorph?(this.element.nestedBlock(t),this.element=t,this.atEnd=!0):((e=this.element.parent)instanceof ScriptsMorph?(this.editor.add(t),t.setPosition(this.element.position()),this.element.destroy()):e.replaceInput(this.element,t),this.element=t),t.fixBlockColor(),this.editor.adjustBounds(),this.fixLayout(),"receiveCondition"===t.selector&&(i=this.editor.scriptTarget())&&(o=i.parentThatIsA(StageMorph))&&(o.enableCustomHatBlocks=!0,o.threads.pauseCustomHatBlocks=!1,(r=o.parentThatIsA(IDE_Morph))&&r.controlBar.stopButton.refresh()),t.inputs&&t.inputs().length&&(this.element=t,this.atEnd=!1,this.nextElement())},ScriptFocusMorph.prototype.insertVariableGetter=function(){var t,e=this.blockTypes(),o=this,r=new MenuMorph;e&&contains(e,"reporter")&&(t=InputSlotMorph.prototype.getVarNamesDict.call(this.element),Object.keys(t).forEach(function(t){var e=SpriteMorph.prototype.variableBlock(t);e.addShadow(new Point(3,3)),r.addItem(e,function(){e.removeShadow(),o.insertBlock(e)})}),0<r.items.length&&(r.popup(this.world(),this.element.bottomLeft()),r.getFocus()))},ScriptFocusMorph.prototype.stopEditing=function(){this.editor.focus=null,this.editor.updateToolbar(),this.world().keyboardReceiver=null,this.destroy()},ScriptFocusMorph.prototype.lastElement=function(){var t,e=this.items();e.length?(this.atEnd?(this.element=e[e.length-1],this.atEnd=!1):((t=e.indexOf(this.element)-1)<0&&(t=e.length-1),this.element=e[t]),this.element instanceof CommandSlotMorph&&this.element.nestedBlock()?this.lastElement():this.element instanceof HatBlockMorph&&(1<e.length?this.lastElement():this.atEnd=!0),this.fixLayout()):this.shiftScript(new Point(-50,0))},ScriptFocusMorph.prototype.nextElement=function(){var t,e,o=this.items();o.length?((t=o.indexOf(this.element)+1)>=o.length&&(t=0),this.atEnd=!1,this.element=o[t],this.element instanceof CommandSlotMorph?(e=this.element.nestedBlock())&&(this.element=e):this.element instanceof HatBlockMorph&&(1===o.length?this.atEnd=!0:this.nextElement()),this.fixLayout()):this.shiftScript(new Point(50,0))},ScriptFocusMorph.prototype.lastCommand=function(){var t,e=this.element.parentThatIsA(CommandBlockMorph);e?(this.element instanceof CommandBlockMorph?this.atEnd?this.atEnd=!1:(t=e.parent.parentThatIsA(CommandBlockMorph))?this.element=t:(t=e.topBlock().bottomBlock())&&(this.element=t,this.atEnd=!0):(this.element=e,this.atEnd=!1),this.element instanceof HatBlockMorph&&!this.atEnd&&this.lastCommand(),this.fixLayout()):this.element instanceof ScriptsMorph&&this.shiftScript(new Point(0,-50))},ScriptFocusMorph.prototype.nextCommand=function(){var t,e,o,r=this.element;if(r instanceof ScriptsMorph)this.shiftScript(new Point(0,50));else{for(;!(r instanceof CommandBlockMorph);)if((r=r.parent)instanceof ScriptsMorph)return;this.atEnd?(o=r.parentThatIsA(CommandSlotMorph))?(this.element=o.parentThatIsA(CommandBlockMorph),this.atEnd=!1,this.nextCommand()):(t=r.topBlock().parentThatIsA(CommandBlockMorph))&&(this.element=t,this.atEnd=!1,this.element instanceof HatBlockMorph&&this.nextCommand()):(e=r.nextBlock())?this.element=e:(this.element=r,this.atEnd=!0),this.fixLayout()}},ScriptFocusMorph.prototype.nextScript=function(){var t,e=this.sortedScripts();if(!(e.length<1)){if(this.element instanceof ScriptsMorph&&(this.element=e[0]),(t=e.indexOf(this.element.topBlock())+1)>=e.length&&(t=0),this.element=e[t],this.element.scrollIntoView(),this.atEnd=!1,this.element instanceof HatBlockMorph)return this.nextElement();this.fixLayout()}},ScriptFocusMorph.prototype.lastScript=function(){var t,e=this.sortedScripts();if(!(e.length<1)){if(this.element instanceof ScriptsMorph&&(this.element=e[0]),(t=e.indexOf(this.element.topBlock())-1)<0&&(t=e.length-1),this.element=e[t],this.element.scrollIntoView(),this.atEnd=!1,this.element instanceof HatBlockMorph)return this.nextElement();this.fixLayout()}},ScriptFocusMorph.prototype.shiftScript=function(t){var e;this.element instanceof ScriptsMorph?this.moveBy(t):!(e=this.element.topBlock())||e instanceof PrototypeHatBlockMorph||e.moveBy(t),this.editor.adjustBounds(),this.fixLayout()},ScriptFocusMorph.prototype.newScript=function(){var t=this.position();this.element instanceof ScriptsMorph||(t=this.element.topBlock().fullBounds().bottomLeft().add(new Point(0,50))),this.setPosition(t),this.element=this.editor,this.editor.adjustBounds(),this.fixLayout()},ScriptFocusMorph.prototype.runScript=function(){this.element instanceof ScriptsMorph||this.element.topBlock().mouseClickLeft()},ScriptFocusMorph.prototype.items=function(){return this.element instanceof ScriptsMorph?[]:this.element.topBlock().allChildren().filter(function(t){return t instanceof SyntaxElementMorph&&!(t instanceof TemplateSlotMorph)&&(!t.isStatic||t.choices||t instanceof BooleanSlotMorph||t instanceof RingMorph||t instanceof MultiArgMorph||t instanceof CommandSlotMorph)})},ScriptFocusMorph.prototype.sortedScripts=function(){var t=this.editor.children.filter(function(t){return t instanceof BlockMorph});return t.sort(function(t,e){return t instanceof PrototypeHatBlockMorph?0:t.top()-e.top()}),t},ScriptFocusMorph.prototype.undrop=function(){this.editor.undrop()},ScriptFocusMorph.prototype.redrop=function(){this.editor.redrop()},ScriptFocusMorph.prototype.blockTypes=function(){return this.element.isTemplate?null:this.element instanceof ScriptsMorph?["hat","command","reporter","predicate","ring"]:this.element instanceof HatBlockMorph||this.element instanceof CommandSlotMorph?["command"]:this.element instanceof CommandBlockMorph?this.atEnd&&this.element.isStop()?null:this.element.parent instanceof ScriptsMorph?["hat","command"]:["command"]:this.element instanceof ReporterBlockMorph?"%n"===this.element.getSlotSpec()?["reporter"]:["reporter","predicate","ring"]:"%n"===this.element.getSpec()?["reporter"]:this.element.isStatic?null:["reporter","predicate","ring"]},ScriptFocusMorph.prototype.processKeyDown=function(t){this.processKeyEvent(t,this.reactToKeyEvent)},ScriptFocusMorph.prototype.processKeyUp=function(t){nop(t)},ScriptFocusMorph.prototype.processKeyPress=function(t){nop(t)},ScriptFocusMorph.prototype.processKeyEvent=function(t,e){var o;switch(this.world().hand.destroyTemporaries(),t.keyCode){case 8:o="backspace";break;case 9:o="tab";break;case 13:o="enter";break;case 16:case 17:case 18:return;case 27:o="esc";break;case 32:o="space";break;case 37:o="left arrow";break;case 39:o="right arrow";break;case 38:o="up arrow";break;case 40:o="down arrow";break;default:o=String.fromCharCode(t.keyCode||t.charCode)}o=(t.ctrlKey||t.metaKey?"ctrl ":"")+(t.shiftKey?"shift ":"")+o,e.call(this,o)},ScriptFocusMorph.prototype.reactToKeyEvent=function(t){var e,o;switch(t.toLowerCase()){case"esc":return this.stopEditing();case"enter":return this.trigger();case"shift enter":return this.newScript();case"ctrl shift enter":return this.runScript();case"space":return this.menu();case"left arrow":return this.lastElement();case"shift left arrow":return this.shiftScript(new Point(-50,0));case"right arrow":return this.nextElement();case"shift right arrow":return this.shiftScript(new Point(50,0));case"up arrow":return this.lastCommand();case"shift up arrow":return this.shiftScript(new Point(0,-50));case"down arrow":return this.nextCommand();case"shift down arrow":return this.shiftScript(new Point(0,50));case"tab":return this.nextScript();case"shift tab":return this.lastScript();case"backspace":return this.deleteLastElement();case"ctrl z":return this.undrop();case"ctrl y":case"ctrl shift z":return this.redrop();case"ctrl [":return;default:e=this.blockTypes(),this.element instanceof ScriptsMorph||!e||!contains(e,"reporter")||(o=Object.keys(this.element.getVarNamesDict())),e&&(delete this.fps,delete this.step,this.show(),this.editor.scriptTarget().searchBlocks(t,e,o,this))}};</script>
        <script>var ThreadManager,Process,Context,Variable,VariableFrame,JSCompiler;function snapEquals(t,e){if(t instanceof List||e instanceof List)return t instanceof List&&e instanceof List&&t.equalTo(e);for(var o=+t,r=+e,n=[!0,!1,""],i=9;i<=13;i+=1)n.push(String.fromCharCode(i));return n.push(String.fromCharCode(160)),(isNaN(o)||isNaN(r)||[t,e].some(function(t){return contains(n,t)||isString(t)&&-1<t.indexOf(" ")}))&&(o=t,r=e),isString(o)&&isString(r)?o.toLowerCase()===r.toLowerCase():o===r}function invoke(t,e,o,r,n,i,s,a){var c=new Process,p=r?Date.now()+r:null;if(t instanceof Context)o&&(t=c.reportContextFor(o)),c.initializeFor(t,e||new List);else{if(!(t instanceof BlockMorph)){if(t.evaluate)return t.evaluate();if(t instanceof Function)return t.apply(o,e.asArray().concat(s));throw new Error("expecting a block or ring but getting "+t)}if(c.topBlock=t,!o)throw new Error("expecting a receiver but getting "+o);c.homeContext=new Context,(c.homeContext.receiver=o).variables&&(c.homeContext.variables.parentFrame=o.variables),c.context=new Context(null,t.blockSequence(),c.homeContext)}for(i&&(c.isCatchingErrors=!1);c.isRunning();){if(p&&Date.now()>p)throw new Error(localize(n||"a synchronous Snap! script has timed out"));c.runStep(p)}return a?c.homeContext:c.homeContext.inputs[0]}function ThreadManager(){this.processes=[],this.wantsToPause=!1}function Process(t,e,o,r){this.topBlock=t||null,this.receiver=e,this.instrument=e?e.instrument:null,this.readyToYield=!1,this.readyToTerminate=!1,this.isDead=!1,this.isClicked=!1,this.isShowingResult=!1,this.errorFlag=!1,this.context=null,this.homeContext=new Context(null,null,null,e),this.lastYield=Date.now(),this.isFirstStep=!0,this.isAtomic=!1,this.prompter=null,this.httpRequest=null,this.isPaused=!1,this.pauseOffset=null,this.frameCount=0,this.exportResult=!1,this.onComplete=o||null,this.procedureCount=0,this.flashingContext=null,this.isInterrupted=!1,this.canBroadcast=!0,t&&(this.homeContext.variables.parentFrame=this.homeContext.receiver.variables,this.context=new Context(null,t.blockSequence(),this.homeContext),r&&this.pushContext("doYield"))}function Context(t,e,o,r){this.outerContext=o||null,this.parentContext=t||null,this.expression=e||null,this.receiver=r||null,this.origin=r||null,this.variables=new VariableFrame,this.outerContext&&(this.variables.parentFrame=this.outerContext.variables,this.receiver=this.outerContext.receiver),this.inputs=[],this.pc=0,this.isContinuation=!1,this.startTime=null,this.activeSends=null,this.activeAudio=null,this.activeNote=null,this.isCustomBlock=!1,this.isCustomCommand=null,this.emptySlots=0,this.tag=null,this.isFlashing=!1,this.accumulator=null}function Variable(t,e){this.value=t,this.isTransient=e||!1}function VariableFrame(t,e){this.vars={},this.parentFrame=t||null,this.owner=e||null}function JSCompiler(t){this.process=t,this.source=null,this.gensyms=null,this.implicitParams=null,this.paramCount=null}modules.threads="2019-July-15",ThreadManager.prototype.pauseCustomHatBlocks=!1,ThreadManager.prototype.toggleProcess=function(t,e){var o=this.findProcess(t,e);if(!o)return this.startProcess(t,e,null,null,null,!0);o.stop()},ThreadManager.prototype.startProcess=function(t,e,o,r,n,i,s,a,c){var p,h,u=t.topBlock(),l=this.findProcess(u,e);if(l){if(o)return l;l.stop(),l.canBroadcast=!0,this.removeTerminatedProcesses()}return(h=new Process(u,e,n,i)).exportResult=r,h.isClicked=i||!1,h.isAtomic=a||!1,c instanceof VariableFrame&&Object.keys(c.vars).forEach(function(t){h.context.outerContext.variables.vars[t]=c.vars[t]}),(p=u.getHighlight())?(p.threadCount=this.processesForBlock(u).length+1,p.updateReadout()):u.addHighlight(),this.processes.push(h),s&&h.runStep(),h},ThreadManager.prototype.stopAll=function(e){this.processes.forEach(function(t){t!==e&&t.stop()})},ThreadManager.prototype.stopAllForReceiver=function(e,o){this.processes.forEach(function(t){t.homeContext.receiver===e&&t!==o&&(t.stop(),e.isTemporary&&(t.isDead=!0))})},ThreadManager.prototype.stopAllForBlock=function(t){this.processesForBlock(t,!0).forEach(function(t){t.stop()})},ThreadManager.prototype.stopProcess=function(t,e){var o=this.findProcess(t,e);o&&o.stop()},ThreadManager.prototype.pauseAll=function(t){this.processes.forEach(function(t){t.pause()}),t&&t.pauseAllActiveSounds()},ThreadManager.prototype.isPaused=function(){return null!==detect(this.processes,function(t){return t.isPaused})},ThreadManager.prototype.resumeAll=function(t){this.processes.forEach(function(t){t.resume()}),t&&t.resumeAllActiveSounds()},ThreadManager.prototype.step=function(){var e;Process.prototype.enableSingleStepping&&(this.processes.forEach(function(t){t.isInterrupted?(t.runStep(),e=!0):t.lastYield=Date.now()}),this.wantsToPause=.5<Process.prototype.flashTime,e)?this.wantsToPause&&this.pauseAll():(this.processes.forEach(function(t){t.homeContext.receiver.isPickedUp()||t.isDead||t.runStep()}),this.removeTerminatedProcesses())},ThreadManager.prototype.removeTerminatedProcesses=function(){var r,n=[],i=this;this.processes.forEach(function(t){var e,o;!t.isRunning()&&!t.errorFlag||t.isDead?(t.topBlock instanceof BlockMorph&&(t.unflash(),(r=i.processesForBlock(t.topBlock).length)?((o=t.topBlock.getHighlight()||t.topBlock.addHighlight()).threadCount=r,o.updateReadout()):t.topBlock.removeHighlight()),t.prompter&&(t.prompter.destroy(),t.homeContext.receiver.stopTalking&&t.homeContext.receiver.stopTalking()),(t.topBlock instanceof ReporterBlockMorph||t.isShowingResult)&&(e=t.homeContext.inputs[0],t.onComplete instanceof Function?t.onComplete(e):e instanceof List?t.topBlock.showBubble(e.isTable()?new TableFrameMorph(new TableMorph(e,10)):new ListWatcherMorph(e),t.exportResult,t.receiver):t.topBlock.showBubble(e,t.exportResult,t.receiver))):n.push(t)}),this.processes=n},ThreadManager.prototype.findProcess=function(t,e){var o=t.topBlock();return detect(this.processes,function(t){return t.topBlock===o&&t.receiver===e})},ThreadManager.prototype.processesForBlock=function(t,e){var o=e?t:t.topBlock();return this.processes.filter(function(t){return t.topBlock===o&&t.isRunning()&&!t.isDead})},ThreadManager.prototype.doWhen=function(e,t,o){if(!this.pauseCustomHatBlocks&&e&&!this.findProcess(e,t)){var r,n,i=e.inputs()[0];if(e.removeHighlight()&&(r=e.world())&&r.hand.destroyTemporaries(),!o){try{n=invoke(i,null,t,50,"the predicate takes\ntoo long for a\ncustom hat block",!0,null,!0)}catch(t){e.addErrorHighlight(),e.showBubble(t.name+"\n"+t.message)}(!0===n||n&&n.inputs&&!0===n.inputs[0])&&this.startProcess(e,t,null,null,null,null,!0,null,n.variables)}}},ThreadManager.prototype.toggleSingleStepping=function(){Process.prototype.enableSingleStepping=!Process.prototype.enableSingleStepping,Process.prototype.enableSingleStepping||this.processes.forEach(function(t){t.isPaused||t.unflash()})},Process.prototype={},(Process.prototype.constructor=Process).prototype.timeout=500,Process.prototype.isCatchingErrors=!0,Process.prototype.enableLiveCoding=!1,Process.prototype.enableSingleStepping=!1,Process.prototype.enableCompiling=!1,Process.prototype.flashTime=0,Process.prototype.isRunning=function(){return null!==this.context&&!this.readyToTerminate},Process.prototype.runStep=function(t){if(this.isPaused)return this.pauseStep();for(this.readyToYield=!1,this.isInterrupted=!1;!this.readyToYield&&!this.isInterrupted&&this.context&&Date.now()-this.lastYield<this.timeout;){if(this.isPaused)return this.pauseStep();if(t&&Date.now()>t)return void(this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp());this.evaluateContext()}if(this.lastYield=Date.now(),this.isFirstStep=!1,this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp&&(this.homeContext.receiver.endWarp(),this.homeContext.receiver.startWarp()),this.readyToTerminate){for(;this.context;)this.popContext();this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp()}},Process.prototype.stop=function(){this.readyToYield=!0,this.readyToTerminate=!0,this.errorFlag=!1,this.context&&this.context.stopMusic(),this.canBroadcast=!1},Process.prototype.pause=function(){this.readyToTerminate||(this.isPaused=!0,this.flashPausedContext(),this.context&&this.context.startTime&&(this.pauseOffset=Date.now()-this.context.startTime))},Process.prototype.resume=function(){this.enableSingleStepping||this.unflash(),this.isPaused=!1,this.pauseOffset=null},Process.prototype.pauseStep=function(){this.lastYield=Date.now(),this.context&&this.context.startTime&&(this.context.startTime=this.lastYield-this.pauseOffset)},Process.prototype.evaluateContext=function(){var t=this.context.expression;return this.frameCount+=1,"exit"===this.context.tag&&this.expectReport(),t instanceof Array?this.evaluateSequence(t):t instanceof MultiArgMorph?this.evaluateMultiSlot(t,t.inputs().length):t instanceof ArgLabelMorph?this.evaluateArgLabel(t):t instanceof ArgMorph||t.bindingID?this.evaluateInput(t):t instanceof BlockMorph?this.evaluateBlock(t,t.inputs().length):isString(t)?this[t].apply(this,this.context.inputs):void this.popContext()},Process.prototype.evaluateBlock=function(e,t){var o,r,n=e.selector;if("reportOr"===n||"reportAnd"===n||"reportIfElse"===n||"doReport"===n)return this[n](e);if(o=this.context.receiver||this.receiver,t>(r=this.context.inputs).length)this.evaluateNextInput(e);else{if(this.flashContext())return;if(this[n]&&(o=this),this.isCatchingErrors)try{this.returnValueToParentContext(o[n].apply(o,r)),this.popContext()}catch(t){this.handleError(t,e)}else this.returnValueToParentContext(o[n].apply(o,r)),this.popContext()}},Process.prototype.reportOr=function(t){var e=this.context.inputs;if(e.length<1)this.evaluateNextInput(t);else if(e[0]){if(this.flashContext())return;this.returnValueToParentContext(!0),this.popContext()}else if(e.length<2)this.evaluateNextInput(t);else{if(this.flashContext())return;this.returnValueToParentContext(!0===e[1]),this.popContext()}},Process.prototype.reportAnd=function(t){var e=this.context.inputs;if(e.length<1)this.evaluateNextInput(t);else if(e[0])if(e.length<2)this.evaluateNextInput(t);else{if(this.flashContext())return;this.returnValueToParentContext(!0===e[1]),this.popContext()}else{if(this.flashContext())return;this.returnValueToParentContext(!1),this.popContext()}},Process.prototype.doReport=function(t){var e=this.context.outerContext;if(!this.flashContext()){if(this.isClicked&&t.topBlock()===this.topBlock&&(this.isShowingResult=!0),t.partOfCustomCommand)this.doStopCustomBlock(),this.popContext();else{for(;this.context&&"exit"!==this.context.tag;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.context&&("expectReport"===this.context.expression?this.popContext():this.context.tag=null)}this.pushContext(t.inputs()[0],e),this.context.isCustomCommand=t.partOfCustomCommand}},Process.prototype.evaluateMultiSlot=function(e,t){var o,r=this.context.inputs;if(e.bindingID){if(this.isCatchingErrors)try{o=this.context.variables.getVar(e.bindingID)}catch(t){this.handleError(t,e)}else o=this.context.variables.getVar(e.bindingID);this.returnValueToParentContext(o),this.popContext()}else t>r.length?this.evaluateNextInput(e):(this.returnValueToParentContext(new List(r)),this.popContext())},Process.prototype.evaluateArgLabel=function(t){var e=this.context.inputs;e.length<1?this.evaluateNextInput(t):(this.returnValueToParentContext(e[0]),this.popContext())},Process.prototype.evaluateInput=function(e){var t;if(!this.flashContext()){if(e.bindingID)if(this.isCatchingErrors)try{t=this.context.variables.getVar(e.bindingID)}catch(t){this.handleError(t,e)}else t=this.context.variables.getVar(e.bindingID);else(t=e.evaluate())&&(e.constructor===CommandSlotMorph||e.constructor===ReporterSlotMorph||e instanceof CSlotMorph&&(!e.isStatic||e.isLambda))&&(t=this.reify(t,new List));this.returnValueToParentContext(t),this.popContext()}},Process.prototype.evaluateSequence=function(t){var e=this.context.pc,o=this.context.outerContext,r=this.context.isCustomBlock;e===t.length-1?(this.context=new Context(this.context.parentContext,t[e],this.context.outerContext,this.context.receiver),this.context.isCustomBlock=r):e>=t.length?this.popContext():(this.context.pc+=1,this.pushContext(t[e],o))},Process.prototype.evaluateNextInput=function(t){var e=this.context.inputs.length,o=t.inputs()[e],r=this.context.expression.selector,n=this.context.outerContext;o.isUnevaluated&&(!0===o.isUnevaluated||o.isUnevaluated())?"reify"===r||"reportScript"===r?this.context.addInput(o):this.context.addInput(this.reify(o,new List)):this.pushContext(o,n)},Process.prototype.doYield=function(){this.popContext(),this.isAtomic||(this.readyToYield=!0)},Process.prototype.expectReport=function(){this.handleError(new Error("reporter didn't report"))},Process.prototype.handleError=function(t,e){var o=e;this.stop(),this.errorFlag=!0,this.topBlock.addErrorHighlight(),(isNil(o)||isNil(o.world()))&&(o=this.topBlock),o.showBubble((o===e?"":"Inside: ")+t.name+"\n"+t.message,this.exportResult,this.receiver)},Process.prototype.errorObsolete=function(){throw new Error("a custom block definition is missing")},Process.prototype.reify=function(t,e,o){var r=new Context(null,null,this.context?this.context.outerContext:null),n=0;return t?(r.expression=this.enableLiveCoding||this.enableSingleStepping?t:t.fullCopy(),r.expression.show(),o||e.length()||(r.expression.allEmptySlots().forEach(function(t){n+=1,t instanceof MultiArgMorph?t.bindingID=Symbol.for("arguments"):t.bindingID=n}),r.emptySlots=n)):r.expression=this.enableLiveCoding||this.enableSingleStepping?[this.context.expression]:[this.context.expression.fullCopy()],r.inputs=e.asArray(),r.receiver=this.context?this.context.receiver:this.receiver,r.origin=r.receiver,r},Process.prototype.reportScript=function(t,e){return this.reify(e,t)},Process.prototype.reifyScript=function(t,e){return this.reify(t,e)},Process.prototype.reifyReporter=function(t,e){return this.reify(t,e)},Process.prototype.reifyPredicate=function(t,e){return this.reify(t,e)},Process.prototype.reportJSFunction=function(t,e){return Function.apply(null,t.asArray().concat([e]))},Process.prototype.doRun=function(t,e){return this.evaluate(t,e,!0)},Process.prototype.evaluate=function(t,e,o){if(!t)return null;if(t instanceof Function)return t.apply(this.blockReceiver(),e.asArray().concat([this]));if(t.isContinuation)return this.runContinuation(t,e);if(!(t instanceof Context))throw new Error("expecting a ring but getting "+t);var r,n,i,s,a=new Context(null,null,t.outerContext),c=this.context.parentContext,p=e.asArray();if(a.receiver||(a.receiver=t.receiver),(n=new Context(this.context.parentContext,t.expression,a,t.receiver)).isCustomCommand=o,this.context.parentContext=n,t.expression instanceof ReporterBlockMorph&&(this.readyToYield=Date.now()-this.lastYield>this.timeout),a.variables.addVar(Symbol.for("arguments"),e),0<p.length){for(i=0;i<t.inputs.length;i+=1)s=0,isNil(p[i])||(s=p[i]),a.variables.addVar(t.inputs[i],s);if(0===t.inputs.length)if(1===p.length)for(i=1;i<=t.emptySlots;i+=1)a.variables.addVar(i,p[0]);else if(p.length===t.emptySlots)for(i=1;i<=p.length;i+=1)a.variables.addVar(i,p[i-1]);else if(1!==t.emptySlots)throw new Error(localize("expecting")+" "+t.emptySlots+" "+localize("input(s), but getting")+" "+p.length)}n.expression instanceof CommandBlockMorph&&(n.expression=n.expression.blockSequence(),o||(c?c.tag="exit":((r=new Context(n.parentContext,"expectReport",a,a.receiver)).tag="exit",n.parentContext=r)))},Process.prototype.fork=function(t,e){var o,r;this.readyToTerminate||(o=new Process,r=this.homeContext.receiver.parentThatIsA(StageMorph),o.instrument=this.instrument,o.receiver=this.receiver,o.initializeFor(t,e),r.threads.processes.push(o))},Process.prototype.initializeFor=function(t,e){if(t.isContinuation)throw new Error("continuations cannot be forked");if(!(t instanceof Context))throw new Error("expecting a ring but getting "+t);var o,r,n=new Context(null,null,t.outerContext),i=new Context(null,t.expression,n),s=e.asArray();if(this.context=t.receiver,n.variables.addVar(Symbol.for("arguments"),e),0<s.length){for(o=0;o<t.inputs.length;o+=1)r=0,isNil(s[o])||(r=s[o]),n.variables.addVar(t.inputs[o],r);if(0===t.inputs.length)if(1===s.length)for(o=1;o<=t.emptySlots;o+=1)n.variables.addVar(o,s[0]);else if(s.length===t.emptySlots)for(o=1;o<=s.length;o+=1)n.variables.addVar(o,s[o-1]);else if(1!==t.emptySlots)throw new Error(localize("expecting")+" "+t.emptySlots+" "+localize("input(s), but getting")+" "+s.length)}i.expression instanceof CommandBlockMorph&&(i.expression=i.expression.blockSequence()),this.homeContext=new Context,this.homeContext.receiver=t.outerContext.receiver,this.topBlock=t.expression,this.context=i},Process.prototype.doStopBlock=function(){var t=this.context.expression.exitTag;if(isNil(t))return this.doStopCustomBlock();for(;this.context&&(isNil(this.context.tag)||this.context.tag>t);)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.pushContext()},Process.prototype.doStopCustomBlock=function(){for(;this.context&&!this.context.isCustomBlock;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext()},Process.prototype.doCallCC=function(t,e){this.evaluate(t,new List([this.context.continuation()]),!e)},Process.prototype.reportCallCC=function(t){this.doCallCC(t,!0)},Process.prototype.runContinuation=function(t,e){var o=e.asArray();if("expectReport"===t.expression&&o.length)return this.stop(),void(this.homeContext.inputs[0]=o[0]);this.context.parentContext=t.copyForContinuationCall(),1===o.length&&this.context.parentContext.outerContext.variables.addVar(1,o[0])},Process.prototype.evaluateCustomBlock=function(){var t,e,o,r,n,i=this.context.parentContext,s=this.context.expression,a=s.isGlobal?s.definition:this.blockReceiver().getMethod(s.semanticSpec),c=a.body,p=a.declarations,h=new List(this.context.inputs).asArray();if(!c)return null;if(this.procedureCount+=1,(n=new Context).receiver=this.context.receiver,n.variables.parentFrame=s.variables,a.variableNames.length?s.variables.parentFrame=n.receiver?n.receiver.variables:null:n.variables.parentFrame=n.receiver?n.receiver.variables:null,(t=new Context(this.context.parentContext,c.expression,n,n.receiver)).isCustomBlock=!0,this.context.parentContext=t,0<h.length)for(o=0;o<c.inputs.length;o+=1)r=0,isNil(h[o])||(r=h[o]),n.variables.addVar(c.inputs[o],r),"%upvar"===p.get(c.inputs[o])[0]&&(this.context.outerContext.variables.vars[r]=n.variables.vars[c.inputs[o]]);"command"!==a.type?(i?i.tag="exit":((e=new Context(t.parentContext,"expectReport",n,n.receiver)).tag="exit",t.parentContext=e),this.readyToYield=Date.now()-this.lastYield>this.timeout):(t.expression.tagExitBlocks(this.procedureCount,!0),i&&!i.tag&&(i.tag=this.procedureCount),!this.isAtomic&&a.isDirectlyRecursive()&&(this.readyToYield=!0)),t.expression=t.expression.blockSequence()},Process.prototype.doDeclareVariables=function(t){var e=this.context.outerContext.variables;t.asArray().forEach(function(t){e.addVar(t)})},Process.prototype.doSetVar=function(t,e){var o=this.context.variables,r=t;if(r instanceof Context)return"reportGetVar"===r.expression.selector?void r.variables.setVar(r.expression.blockSpec,e,this.blockReceiver()):void this.doSet(r,e);r instanceof Array?this.doSet(r,e):o.setVar(r,e,this.blockReceiver())},Process.prototype.doChangeVar=function(t,e){var o=this.context.variables,r=t;r instanceof Context&&"reportGetVar"===r.expression.selector?r.variables.changeVar(r.expression.blockSpec,e,this.blockReceiver()):o.changeVar(r,e,this.blockReceiver())},Process.prototype.reportGetVar=function(){return this.context.variables.getVar(this.context.expression.blockSpec)},Process.prototype.doShowVar=function(t){var e,o,r,n,i,s=this.context.variables,a=t;if(a instanceof Context){if("reportGetVar"!==a.expression.selector)return void this.doChangePrimitiveVisibility(a.expression,!1);a=a.expression.blockSpec}if(this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))){if(!(r=s.silentFind(a)))return;if(null!==(o=detect(e.children,function(t){return t instanceof WatcherMorph&&t.target===r&&t.getter===a})))return o.show(),void o.fixLayout();n=contains(this.homeContext.receiver.globalVariables().names(),t)||r.owner?a:a+" "+localize("(temporary)"),(o=new WatcherMorph(n,SpriteMorph.prototype.blockColor.variables,r,a)).setPosition(e.position().add(10)),0<(i=e.watchers(o.left())).length&&o.setTop(i[i.length-1].bottom()),e.add(o),o.fixLayout()}},Process.prototype.doHideVar=function(t){var e,o,r,n=this.context.variables,i=t;if(i instanceof Context){if("reportGetVar"!==i.expression.selector)return void this.doChangePrimitiveVisibility(i.expression,!0);i=i.expression.blockSpec}i?this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))&&(r=n.find(i),null!==(o=detect(e.children,function(t){return t instanceof WatcherMorph&&t.target===r&&t.getter===i}))&&(o.isTemporary()?o.destroy():o.hide())):this.doRemoveTemporaries()},Process.prototype.doRemoveTemporaries=function(){var t;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))&&t.watchers().forEach(function(t){t.isTemporary()&&t.destroy()})},Process.prototype.doChangePrimitiveVisibility=function(t,e){var o,r=this.homeContext.receiver.parentThatIsA(IDE_Morph);r&&"evaluateCustomBlock"!==t.selector&&(e?StageMorph.prototype.hiddenPrimitives[t.selector]=!0:delete StageMorph.prototype.hiddenPrimitives[t.selector],"lists"===(o={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"}[this.selector]||this.category)&&(o="variables"),r.flushBlocksCache(o),r.refreshPalette())},Process.prototype.doDeleteAttr=function(t){var e=t,o=this.blockReceiver();if(e instanceof Context){if("reportGetVar"!==e.expression.selector)return e={xPosition:"x position",yPosition:"y position",direction:"direction",getCostumeIdx:"costume #",size:"size"}[e.expression.selector],void(isNil(e)||o.inheritAttribute(e));e=e.expression.blockSpec}if(e instanceof Array)return o.inheritAttribute(this.inputOption(e));contains(o.inheritedVariableNames(!0),e)&&o.deleteVariable(e)},Process.prototype.doTellTo=function(t,e,o){this.doRun(this.reportAttributeOf(e,t),o)},Process.prototype.reportAskFor=function(t,e,o){this.evaluate(this.reportAttributeOf(e,t),o)},Process.prototype.reportNewList=function(t){return t},Process.prototype.reportCONS=function(t,e){return this.assertType(e,"list"),(new List).cons(t,e)},Process.prototype.reportCDR=function(t){return this.assertType(t,"list"),t.cdr()},Process.prototype.doAddToList=function(t,e){this.assertType(e,"list"),e.type&&this.assertType(t,e.type),e.add(t)},Process.prototype.doDeleteFromList=function(t,e){var o=t;if(this.assertType(e,"list"),"all"===this.inputOption(t))return e.clear();if(""===t)return null;if("last"===this.inputOption(t))o=e.length();else if(isNaN(+this.inputOption(t)))return null;e.remove(o)},Process.prototype.doInsertInList=function(t,e,o){var r=e;if(this.assertType(o,"list"),o.type&&this.assertType(t,o.type),""===e)return null;"any"===this.inputOption(e)&&(r=this.reportRandom(1,o.length()+1)),"last"===this.inputOption(e)&&(r=o.length()+1),o.add(t,r)},Process.prototype.doReplaceInList=function(t,e,o){var r=t;if(this.assertType(e,"list"),e.type&&this.assertType(o,e.type),""===t)return null;"any"===this.inputOption(t)&&(r=this.reportRandom(1,e.length())),"last"===this.inputOption(t)&&(r=e.length()),e.put(o,r)},Process.prototype.reportListItem=function(t,e){var o=t;return this.assertType(e,"list"),""===t?"":("any"===this.inputOption(t)&&(o=this.reportRandom(1,e.length())),"last"===this.inputOption(t)&&(o=e.length()),e.at(o))},Process.prototype.reportListLength=function(t){return this.assertType(t,"list"),t.length()},Process.prototype.reportListContainsItem=function(t,e){return this.assertType(t,"list"),t.contains(e)},Process.prototype.reportListIsEmpty=function(t){return this.assertType(t,"list"),t.isEmpty()},Process.prototype.doShowTable=function(t){this.assertType(t,"list"),new TableDialogMorph(t).popUp(this.blockReceiver().world())},Process.prototype.reportNumbers=function(t,e){var o;if(this.assertType(+t,"number"),this.assertType(+e,"number"),null===this.context.accumulator&&(this.context.accumulator={target:new List,end:null,idx:+t},this.context.accumulator.target.isLinked=!0,this.context.accumulator.end=this.context.accumulator.target),(o=this.context.accumulator).idx>+e)return o.end.rest=new List,void this.returnValueToParentContext(o.target.cdr());o.end.rest=o.target.cons(o.idx),o.end=o.end.rest,o.idx+=1,this.pushContext()},Process.prototype.doIf=function(){var t=this.context.inputs,e=this.context.outerContext,o=this.context.isCustomBlock;this.popContext(),t[0]&&t[1]&&(this.pushContext(t[1].blockSequence(),e),this.context.isCustomBlock=o),this.pushContext()},Process.prototype.doIfElse=function(){var t=this.context.inputs,e=this.context.outerContext,o=this.context.isCustomBlock;this.popContext(),t[0]?t[1]&&this.pushContext(t[1].blockSequence(),e):t[2]?this.pushContext(t[2].blockSequence(),e):this.pushContext("doYield"),this.context&&(this.context.isCustomBlock=o),this.pushContext()},Process.prototype.reportIfElse=function(t){var e=this.context.inputs;if(e.length<1)this.evaluateNextInput(t);else if(1<e.length){if(this.flashContext())return;this.returnValueToParentContext(e.pop()),this.popContext()}else e[0]||e.push(null),this.evaluateNextInput(t)},Process.prototype.doStop=function(){this.stop()},Process.prototype.doStopAll=function(){var t,e;this.homeContext.receiver&&((t=this.homeContext.receiver.parentThatIsA(StageMorph))&&(t.stopAllActiveSounds(),t.threads.resumeAll(t),t.keysPressed={},t.runStopScripts(),t.threads.stopAll(),t.projectionSource&&t.stopProjection(),t.children.forEach(function(t){t.stopTalking&&t.stopTalking()}),t.removeAllClones()),(e=t.parentThatIsA(IDE_Morph))&&(e.controlBar.pauseButton.refresh(),e.nextSteps([nop,function(){t.stopAllActiveSounds()}])))},Process.prototype.doStopThis=function(t){switch(this.inputOption(t)){case"all":this.doStopAll();break;case"this script":this.doStop();break;case"this block":this.doStopBlock();break;default:this.doStopOthers(t)}},Process.prototype.doStopOthers=function(t){var e;if(this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph)))switch(this.inputOption(t)){case"all but this script":e.threads.stopAll(this);break;case"other scripts in sprite":e.threads.stopAllForReceiver(this.homeContext.receiver,this);break;default:nop()}},Process.prototype.doWarp=function(t){var e,o=this.context.outerContext,r=this.context.isCustomBlock;this.popContext(),t&&(this.homeContext.receiver&&(this.homeContext.receiver.startWarp&&this.homeContext.receiver.startWarp(),(e=this.homeContext.receiver.parentThatIsA(StageMorph))&&(e.fps=0)),this.pushContext("doYield"),this.context.isCustomBlock=r,this.isAtomic||this.pushContext("doStopWarping"),this.pushContext(t.blockSequence(),o),this.isAtomic=!0),this.pushContext()},Process.prototype.doStopWarping=function(){var t;this.popContext(),this.isAtomic=!1,this.homeContext.receiver&&(this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp(),(t=this.homeContext.receiver.parentThatIsA(StageMorph))&&(t.fps=t.frameRate))},Process.prototype.reportIsFastTracking=function(){var t;return!(!this.homeContext.receiver||!(t=this.homeContext.receiver.parentThatIsA(IDE_Morph)))&&t.stage.isFastTracked},Process.prototype.doSetGlobalFlag=function(t,e){var o=this.homeContext.receiver.parentThatIsA(StageMorph);switch(t=this.inputOption(t),this.assertType(e,"Boolean"),t){case"turbo mode":this.doSetFastTracking(e);break;case"flat line ends":SpriteMorph.prototype.useFlatLineEnds=e;break;case"video capture":e?o.startVideo():o.stopProjection();break;case"mirror video":o.mirrorVideo=e}},Process.prototype.reportGlobalFlag=function(t){var e=this.homeContext.receiver.parentThatIsA(StageMorph);switch(t=this.inputOption(t)){case"turbo mode":return this.reportIsFastTracking();case"flat line ends":return SpriteMorph.prototype.useFlatLineEnds;case"video capture":return!isNil(e.projectionSource);case"mirror video":return e.mirrorVideo;default:return""}},Process.prototype.doSetFastTracking=function(t){var e;this.reportIsA(t,"Boolean")&&this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(IDE_Morph))&&(t?e.startFastTracking():e.stopFastTracking())},Process.prototype.doPauseAll=function(){var t,e;this.homeContext.receiver&&((t=this.homeContext.receiver.parentThatIsA(StageMorph))&&t.threads.pauseAll(t),(e=t.parentThatIsA(IDE_Morph))&&e.controlBar.pauseButton.refresh())},Process.prototype.doForever=function(t){this.context.inputs=[],this.pushContext("doYield"),t&&this.pushContext(t.blockSequence()),this.pushContext()},Process.prototype.doRepeat=function(t,e){var o=this.context.expression,r=this.context.outerContext,n=this.context.isCustomBlock;if(t<1)return null;this.popContext(),this.pushContext(o,r),this.context.isCustomBlock=n,this.context.addInput(t-1),this.pushContext("doYield"),e&&this.pushContext(e.blockSequence()),this.pushContext()},Process.prototype.doUntil=function(t,e){if(t)return this.popContext(),this.pushContext("doYield"),null;this.context.inputs=[],this.pushContext("doYield"),e&&this.pushContext(e.blockSequence()),this.pushContext()},Process.prototype.doWaitUntil=function(t){if(t)return this.popContext(),this.pushContext("doYield"),null;this.context.inputs=[],this.pushContext("doYield"),this.pushContext()},Process.prototype.doForEach=function(t,e,o){var r;this.assertType(e,"list"),null===this.context.accumulator&&(this.context.accumulator={source:e,remaining:e.length(),idx:0}),0!==this.context.accumulator.remaining&&(--this.context.accumulator.remaining,this.context.accumulator.source.isLinked?(r=this.context.accumulator.source.at(1),this.context.accumulator.source=this.context.accumulator.source.cdr()):(this.context.accumulator.idx+=1,r=e.at(this.context.accumulator.idx)),this.pushContext("doYield"),this.pushContext(),this.context.outerContext.variables.addVar(t),this.context.outerContext.variables.setVar(t,r),this.evaluate(o,new List([r]),!0))},Process.prototype.doFor=function(t,e,o,r){var n;null===this.context.accumulator&&(this.context.accumulator={idx:Math.floor(e),test:e<o?function(){return this.idx>o}:function(){return this.idx<o},step:e<o?1:-1,parms:new List}),n=this.context.accumulator,this.context.outerContext.variables.addVar(t),this.context.outerContext.variables.setVar(t,n.idx),n.test()||(n.idx+=n.step,this.pushContext("doYield"),this.pushContext(),this.evaluate(r,n.parms,!0))},Process.prototype.reportMap=function(t,e){var o,r,n;if(this.assertType(e,"list"),e.isLinked){if(null===this.context.accumulator?(this.context.accumulator={source:e,idx:1,target:new List,end:null,remaining:e.length()},this.context.accumulator.target.isLinked=!0,this.context.accumulator.end=this.context.accumulator.target):2<this.context.inputs.length&&(this.context.accumulator.end.rest=e.cons(this.context.inputs.pop()),this.context.accumulator.end=this.context.accumulator.end.rest,this.context.accumulator.idx+=1,--this.context.accumulator.remaining),0===this.context.accumulator.remaining)return this.context.accumulator.end.rest=e.cons(this.context.inputs[2]).cdr(),void this.returnValueToParentContext(this.context.accumulator.target.cdr());r=this.context.accumulator.idx,o=this.context.accumulator.source.at(1),this.context.accumulator.source=this.context.accumulator.source.cdr()}else{if(null===this.context.accumulator?this.context.accumulator=[]:2<this.context.inputs.length&&this.context.accumulator.push(this.context.inputs.pop()),this.context.accumulator.length===e.length())return void this.returnValueToParentContext(new List(this.context.accumulator));r=this.context.accumulator.length+1,o=e.at(r)}this.pushContext(),n=[o],1<t.inputs.length&&n.push(r),2<t.inputs.length&&n.push(e),this.evaluate(t,new List(n))},Process.prototype.reportKeep=function(t,e){var o,r,n;if(this.assertType(e,"list"),e.isLinked){if(null===this.context.accumulator?(this.context.accumulator={source:e,idx:1,target:new List,end:null,remaining:e.length()},this.context.accumulator.target.isLinked=!0,this.context.accumulator.end=this.context.accumulator.target):2<this.context.inputs.length&&(!0===this.context.inputs.pop()&&(this.context.accumulator.end.rest=e.cons(this.context.accumulator.source.at(1)),this.context.accumulator.end=this.context.accumulator.end.rest),--this.context.accumulator.remaining,this.context.accumulator.idx+=1,this.context.accumulator.source=this.context.accumulator.source.cdr()),0===this.context.accumulator.remaining)return this.context.accumulator.end.rest=new List,void this.returnValueToParentContext(this.context.accumulator.target.cdr());r=this.context.accumulator.idx,o=this.context.accumulator.source.at(1)}else{if(null===this.context.accumulator?this.context.accumulator={idx:0,target:[]}:2<this.context.inputs.length&&!0===this.context.inputs.pop()&&this.context.accumulator.target.push(e.at(this.context.accumulator.idx)),this.context.accumulator.idx===e.length())return void this.returnValueToParentContext(new List(this.context.accumulator.target));this.context.accumulator.idx+=1,r=this.context.accumulator.idx,o=e.at(r)}this.pushContext(),n=[o],1<t.inputs.length&&n.push(r),2<t.inputs.length&&n.push(e),this.evaluate(t,new List(n))},Process.prototype.reportFindFirst=function(t,e){var o,r,n;if(this.assertType(e,"list"),e.isLinked){if(null===this.context.accumulator)this.context.accumulator={source:e,idx:1,remaining:e.length()};else if(2<this.context.inputs.length){if(!0===this.context.inputs.pop())return void this.returnValueToParentContext(this.context.accumulator.source.at(1));--this.context.accumulator.remaining,this.context.accumulator.idx+=1,this.context.accumulator.source=this.context.accumulator.source.cdr()}if(0===this.context.accumulator.remaining)return void this.returnValueToParentContext(!1);r=this.context.accumulator.idx,o=this.context.accumulator.source.at(1)}else{if(null===this.context.accumulator)this.context.accumulator={idx:0,current:null};else if(2<this.context.inputs.length&&!0===this.context.inputs.pop())return void this.returnValueToParentContext(this.context.accumulator.current);if(this.context.accumulator.idx===e.length())return void this.returnValueToParentContext(!1);this.context.accumulator.idx+=1,r=this.context.accumulator.idx,o=e.at(r),this.context.accumulator.current=o}this.pushContext(),n=[o],1<t.inputs.length&&n.push(r),2<t.inputs.length&&n.push(e),this.evaluate(t,new List(n))},Process.prototype.reportCombine=function(t,e){var o,r,n,i;if(this.assertType(t,"list"),t.length()<2)this.returnValueToParentContext(t.length()?t.at(1):0);else{if(t.isLinked){if(null===this.context.accumulator?this.context.accumulator={source:t.cdr(),idx:1,target:t.at(1),remaining:t.length()-1}:2<this.context.inputs.length&&(this.context.accumulator.target=this.context.inputs.pop(),--this.context.accumulator.remaining,this.context.accumulator.idx+=1,this.context.accumulator.source=this.context.accumulator.source.cdr()),0===this.context.accumulator.remaining)return void this.returnValueToParentContext(this.context.accumulator.target);o=this.context.accumulator.source.at(1)}else{if(null===this.context.accumulator?this.context.accumulator={idx:1,target:t.at(1)}:2<this.context.inputs.length&&(this.context.accumulator.target=this.context.inputs.pop()),this.context.accumulator.idx===t.length())return void this.returnValueToParentContext(this.context.accumulator.target);this.context.accumulator.idx+=1,o=t.at(this.context.accumulator.idx)}n=this.context.accumulator.idx,r=this.context.accumulator.target,this.pushContext(),i=[r,o],2<e.inputs.length&&i.push(n),3<e.inputs.length&&i.push(t),this.evaluate(e,new List(i))}},Process.prototype.doWait=function(t){if(this.context.startTime||(this.context.startTime=Date.now()),Date.now()-this.context.startTime>=1e3*t)return this.isAtomic||0!==t||(this.readyToYield=!0),null;this.pushContext("doYield"),this.pushContext()},Process.prototype.doGlide=function(t,e,o){if(this.context.startTime||(this.context.startTime=Date.now(),this.context.startValue=new Point(this.blockReceiver().xPosition(),this.blockReceiver().yPosition())),Date.now()-this.context.startTime>=1e3*t)return this.blockReceiver().gotoXY(e,o),null;this.blockReceiver().glide(1e3*t,e,o,Date.now()-this.context.startTime,this.context.startValue),this.pushContext("doYield"),this.pushContext()},Process.prototype.doSayFor=function(t,e){if(this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().bubble(t)),Date.now()-this.context.startTime>=1e3*e)return this.blockReceiver().stopTalking(),null;this.pushContext("doYield"),this.pushContext()},Process.prototype.doThinkFor=function(t,e){if(this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().doThink(t)),Date.now()-this.context.startTime>=1e3*e)return this.blockReceiver().stopTalking(),null;this.pushContext("doYield"),this.pushContext()},Process.prototype.blockReceiver=function(){return this.context?this.context.receiver||this.homeContext.receiver:this.homeContext.receiver||this.receiver},Process.prototype.playSound=function(t){return t instanceof List?this.doPlaySoundAtRate(t,44100):this.blockReceiver().doPlaySound(t)},Process.prototype.doPlaySoundUntilDone=function(t){if(null===this.context.activeAudio&&(this.context.activeAudio=this.playSound(t)),null===t||this.context.activeAudio.ended||this.context.activeAudio.terminated)return null;this.pushContext("doYield"),this.pushContext()},Process.prototype.doStopAllSounds=function(){var t=this.homeContext.receiver.parentThatIsA(StageMorph);t&&(t.threads.processes.forEach(function(t){t.context&&(t.context.stopMusic(),t.context.activeAudio&&t.popContext())}),t.stopAllActiveSounds())},Process.prototype.doPlaySoundAtRate=function(e,t){var o,r,n,i,s,a,c;if(e instanceof List)r=e;else{if(!(o=e instanceof Sound?e:"number"==typeof e?this.blockReceiver().sounds.at(e):detect(this.blockReceiver().sounds.asArray(),function(t){return t.name===e.toString()})).audioBuffer)return void this.decodeSound(o);r=this.reportGetSoundAttribute("samples",o)}return n=(c=this.blockReceiver()).audioContext(),i=c.getGainNode(),s=c.getPannerNode(),a=this.encodeSound(r,t),c.setVolume(c.volume),a.connect(i),s?(i.connect(s),s.connect(n.destination),c.setPan(c.pan)):i.connect(n.destination),a.pause=a.stop,a.ended=!1,a.onended=function(){this.ended=!0},a.start(),c.parentThatIsA(StageMorph).activeSounds.push(a),a},Process.prototype.reportGetSoundAttribute=function(t,e){var r=e instanceof Sound?e:"number"==typeof e?this.blockReceiver().sounds.at(e):e instanceof List?this.encodeSound(e):detect(this.blockReceiver().sounds.asArray(),function(t){return t.name===e.toString()}),o=this.inputOption(t);if("name"===o)return r.name;if(r.audioBuffer)switch(o){case"samples":return r.cachedSamples||(r.cachedSamples=function(){var t,e,o=r.audioBuffer;if(1<o.numberOfChannels){for(t=new List,e=0;e<o.numberOfChannels;e+=1)t.add(new List(o.getChannelData(e)));return t}return new List(o.getChannelData(0))}()),r.cachedSamples;case"sample rate":return r.audioBuffer.sampleRate;case"duration":return r.audioBuffer.duration;case"length":return r.audioBuffer.length;case"number of channels":return r.audioBuffer.numberOfChannels;default:return 0}else this.decodeSound(r)},Process.prototype.decodeSound=function(e,t){var o,r,n,i,s,a,c,p=this;if(e.audioBuffer)return(t||nop)(e);if(!e.isDecoding){for(o=e.audio.src.split(",")[1],n=(r=window.atob(o)).length,i=new Uint8Array(n),s=0;s<n;s+=1)i[s]=r.charCodeAt(s);a=i.buffer,c=Note.prototype.getAudioContext(),e.isDecoding=!0,c.decodeAudioData(a,function(t){e.audioBuffer=t,e.isDecoding=!1},function(t){e.isDecoding=!1,p.handleError(t)})}this.pushContext("doYield"),this.pushContext()},Process.prototype.encodeSound=function(t,e){var r,o,n=this.blockReceiver().audioContext(),i=t.at(1)instanceof List?t.length():1,s=1===i?t.length():t.at(1).length(),a=n.createBuffer(i,s,+e||44100);if(a.copyToChannel||(a.copyToChannel=function(t,e){var o=this.getChannelData(e);for(r=0;r<t.length;r+=1)o[r]=t[r]}),1===i)a.copyToChannel(Float32Array.from(t.asArray()),0,0);else for(r=0;r<i;r+=1)a.copyToChannel(Float32Array.from(t.at(r+1).asArray()),r,0);return(o=n.createBufferSource()).buffer=a,o.audioBuffer=o.buffer,o},Process.prototype.reportAudio=function(t){var e=this.blockReceiver().parentThatIsA(StageMorph),o=this.inputOption(t);if("resolution"===o)return e.microphone.binSize();if("modifier"===o)return e.microphone.modifier;if(e.microphone.isOn())switch(o){case"volume":return 100*e.microphone.volume;case"frequency":return e.microphone.pitch;case"note":return e.microphone.note;case"samples":return new List(e.microphone.signals);case"sample rate":return e.microphone.audioContext.sampleRate;case"output":return new List(e.microphone.output);case"spectrum":return new List(e.microphone.frequencies);default:return null}this.pushContext("doYield"),this.pushContext()},Process.prototype.setMicrophoneModifier=function(t){var e=this.blockReceiver().parentThatIsA(StageMorph);if(!t||contains(["sprite","stage","list","costume","sound","number","text","Boolean"],this.reportTypeOf(t)))return e.microphone.modifier=null,void e.microphone.stop();e.microphone.modifier=t,e.microphone.compiledModifier=this.reportCompiled(t,1),e.microphone.compilerProcess=this},Process.prototype.doAsk=function(t){var e=this.homeContext.receiver.parentThatIsA(StageMorph),o=this.blockReceiver(),r=o instanceof StageMorph,n=o instanceof SpriteMorph&&!o.isVisible;if(e.keysPressed={},this.prompter){if(this.prompter.isDone)return e.lastAnswer=this.prompter.inputField.getValue(),this.prompter.destroy(),this.prompter=null,r||o.stopTalking(),null}else detect(e.children,function(t){return t instanceof StagePrompterMorph})||(r||n||o.bubble(t,!1,!0),this.prompter=new StagePrompterMorph(r||n?t:null),e.scale<1?this.prompter.setWidth(e.width()-10):this.prompter.setWidth(e.dimensions.x-20),this.prompter.fixLayout(),this.prompter.setCenter(e.center()),this.prompter.setBottom(e.bottom()-this.prompter.border),e.add(this.prompter),this.prompter.inputField.edit(),e.changed());this.pushContext("doYield"),this.pushContext()},Process.prototype.reportLastAnswer=function(){return this.homeContext.receiver.parentThatIsA(StageMorph).lastAnswer},Process.prototype.reportURL=function(t){var e;if(this.httpRequest){if(4===this.httpRequest.readyState)return e=this.httpRequest.responseText,this.httpRequest=null,e}else if((t.indexOf("//")<0||8<t.indexOf("//"))&&(t="file:"===location.protocol?"https://"+t:location.protocol+"//"+t),this.httpRequest=new XMLHttpRequest,this.httpRequest.open("GET",t,!0),this.httpRequest.send(null),this.context.isCustomCommand)return this.httpRequest=null;this.pushContext("doYield"),this.pushContext()},Process.prototype.doBroadcast=function(t){var e,o,r,n=this.homeContext.receiver.parentThatIsA(StageMorph),i=t,s=this,a=[];if(!this.canBroadcast)return[];if(t instanceof List&&2===t.length())if(e=this.blockReceiver(),i=t.at(1),o=t.at(2),isSnapObject(o))r=[o];else if(isString(o))r=o===n.name?[n]:[this.getOtherObject(o,e,n)];else{if(!(o instanceof List))return;r=o.itemsArray().map(function(t){return s.getOtherObject(t,e,n)})}else r=n.children.concat(n);return""!==i&&(n.lastMessage=t,r.forEach(function(e){isSnapObject(e)&&e.allHatBlocksFor(i).forEach(function(t){a.push(n.threads.startProcess(t,e,n.isThreadSafe))})})),a},Process.prototype.doBroadcastAndWait=function(t){if(this.context.activeSends||(this.context.activeSends=this.doBroadcast(t),this.context.activeSends.forEach(function(t){t.runStep()})),this.context.activeSends=this.context.activeSends.filter(function(t){return t.isRunning()}),0===this.context.activeSends.length)return null;this.pushContext("doYield"),this.pushContext()},Process.prototype.getLastMessage=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))?t.getLastMessage():""},Process.prototype.reportIsA=function(t,e){return this.reportTypeOf(t)===this.inputOption(e)},Process.prototype.assertType=function(t,e){var o=this.reportTypeOf(t);if(o===e)return!0;if(e instanceof Array&&contains(e,o))return!0;throw new Error("expecting "+e+" but getting "+o)},Process.prototype.assertAlive=function(t){if(t&&t.isCorpse)throw new Error("cannot operate on a deleted sprite")},Process.prototype.reportTypeOf=function(t){var e;return null==t?"nothing":!0===t||!1===t?"Boolean":t instanceof List?"list":parseFloat(t)===+t?"number":isString(t)?"text":t instanceof SpriteMorph?"sprite":t instanceof StageMorph?"stage":t instanceof Costume?"costume":t instanceof Sound?"sound":t instanceof Context?t.expression instanceof RingMorph?t.expression.dataType():t.expression instanceof ReporterBlockMorph?t.expression.isPredicate?"predicate":"reporter":t.expression instanceof Array?(e=t.expression[t.pc||0]).isPredicate?"predicate":e instanceof RingMorph?e.dataType():!(e instanceof ReporterBlockMorph)&&e instanceof CommandBlockMorph?"command":"reporter":t.expression instanceof CommandBlockMorph?"command":"reporter":"undefined"},Process.prototype.reportSum=function(t,e){return+t+ +e},Process.prototype.reportDifference=function(t,e){return t-e},Process.prototype.reportProduct=function(t,e){return t*e},Process.prototype.reportQuotient=function(t,e){return t/e},Process.prototype.reportPower=function(t,e){return Math.pow(+t,+e)},Process.prototype.reportModulus=function(t,e){var o=+e;return(+t%o+o)%o},Process.prototype.reportRandom=function(t,e){var o=+t,r=+e;return o%1!=0||r%1!=0?Math.random()*(r-o)+o:Math.floor(Math.random()*(r-o+1))+o},Process.prototype.reportLessThan=function(t,e){var o=+t,r=+e;return(isNaN(o)||isNaN(r))&&(o=t,r=e),o<r},Process.prototype.reportNot=function(t){return!t},Process.prototype.reportGreaterThan=function(t,e){var o=+t,r=+e;return(isNaN(o)||isNaN(r))&&(o=t,r=e),r<o},Process.prototype.reportEquals=function(t,e){return snapEquals(t,e)},Process.prototype.reportIsIdentical=function(t,e){var o="idTag";if(this.isImmutable(t)||this.isImmutable(e))return snapEquals(t,e);function r(){Object.prototype.hasOwnProperty.call(t,o)&&delete t[o],Object.prototype.hasOwnProperty.call(e,o)&&delete e[o]}return r(),t[o]=Date.now(),e[o]===t[o]?(r(),!0):(r(),!1)},Process.prototype.isImmutable=function(t){var e=this.reportTypeOf(t);return"nothing"===e||"Boolean"===e||"text"===e||"number"===e||"undefined"===e},Process.prototype.reportBoolean=function(t){return t},Process.prototype.reportRound=function(t){return Math.round(+t)},Process.prototype.reportMonadic=function(t,e){var o=+e,r=0;switch(this.inputOption(t)){case"abs":r=Math.abs(o);break;case"neg":r=-1*e;break;case"ceiling":r=Math.ceil(o);break;case"floor":r=Math.floor(o);break;case"sqrt":r=Math.sqrt(o);break;case"sin":r=Math.sin(radians(o));break;case"cos":r=Math.cos(radians(o));break;case"tan":r=Math.tan(radians(o));break;case"asin":r=degrees(Math.asin(o));break;case"acos":r=degrees(Math.acos(o));break;case"atan":r=degrees(Math.atan(o));break;case"ln":r=Math.log(o);break;case"log":r=Math.log10(o);break;case"lg":r=Math.log2(o);break;case"e^":r=Math.exp(o);break;case"10^":r=Math.pow(10,o);break;case"2^":r=Math.pow(2,o);break;default:nop()}return r},Process.prototype.reportTextFunction=function(t,e){var o=(isNil(e)?"":e).toString(),r="";switch(this.inputOption(t)){case"encode URI":r=encodeURI(o);break;case"decode URI":r=decodeURI(o);break;case"encode URI component":r=encodeURIComponent(o);break;case"decode URI component":r=decodeURIComponent(o);break;case"XML escape":r=(new XML_Element).escape(o);break;case"XML unescape":r=(new XML_Element).unescape(o);break;case"hex sha512 hash":r=hex_sha512(o);break;default:nop()}return r},Process.prototype.reportJoin=function(t,e){var o=(isNil(t)?"":t).toString(),r=(isNil(e)?"":e).toString();return o.concat(r)},Process.prototype.reportJoinWords=function(t){return t instanceof List?t.asText():(t||"").toString()},Process.prototype.reportLetter=function(t,e){var o;return e instanceof List?"":(o=isNil(e)?"":e.toString(),"any"===this.inputOption(t)&&(t=this.reportRandom(1,o.length)),"last"===this.inputOption(t)&&(t=o.length),o[+(t||0)-1]||"")},Process.prototype.reportStringSize=function(t){return t instanceof List?t.length():isNil(t)?0:t.toString().length},Process.prototype.reportUnicode=function(t){var e=isNil(t)?"\0":t.toString();return e.codePointAt?e.codePointAt(0)||0:e.charCodeAt(0)||0},Process.prototype.reportUnicodeAsLetter=function(t){var e=+(t||0);return String.fromCodePoint?String.fromCodePoint(e):String.fromCharCode(e)},Process.prototype.reportTextSplit=function(t,e){var o,r,n=["text","number"],i=this.reportTypeOf(t),s=this.reportTypeOf(this.inputOption(e));if(!contains(n,i))throw new Error("expecting text instead of a "+i);if(!contains(n,s))throw new Error("expecting a text delimiter instead of a "+s);switch(o=isNil(t)?"":t.toString(),this.inputOption(e)){case"line":r=/\r\n|[\n\v\f\r\x85\u2028\u2029]/;break;case"tab":r="\t";break;case"cr":r="\r";break;case"word":case"whitespace":o=o.trim(),r=/\s+/;break;case"letter":r="";break;case"csv":return this.parseCSV(t);case"json":return this.parseJSON(t);default:r=isNil(e)?"":e.toString()}return new List(o.split(r))},Process.prototype.parseCSV=function(t){return this.rawParseCSV(t,this.guessDelimiterCSV(t))},Process.prototype.guessDelimiterCSV=function(t){for(var e=[",",";","|","\t"],o=e.length,r=t.split("\n")[0],n=0;n<o;n+=1)if(1<this.rawParseCSV(r,e[n]).length())return e[n];return e[0]},Process.prototype.rawParseCSV=function(t,e){var o,r,n="",i=[""],s=[i],a=0,c=0,p=!0,h=t.length;for(e=e||",",o=0;o<h;o+=1)'"'===(r=t[o])?(p&&r===n&&(i[a]+=r),p=!p):r===e&&p?(r="",i[a+=1]=r):"\r"===r&&p?(s[c+=1]=[""],i=s[c],a=0):"\n"===r&&p?"\r"!==n&&(s[c+=1]=[""],i=s[c],a=0):i[a]+=r,n=r;return 1===s[s.length-1].length&&""===s[s.length-1][0]&&s.pop(),1===(s=new List(s.map(function(t){return new List(t)}))).length()?s.at(1):s},Process.prototype.parseJSON=function(t){return function e(o){return o instanceof Array?new List(o.map(e)):o instanceof Object?new List(Object.keys(o).map(function(t){return new List([t,e(o[t])])})):o}(JSON.parse(t))},Process.prototype.alert=function(t){this.homeContext.receiver&&this.homeContext.receiver.world().isDevMode&&alert("Snap! "+t.asArray())},Process.prototype.log=function(t){this.homeContext.receiver&&this.homeContext.receiver.world().isDevMode&&console.log("Snap! "+t.asArray())},Process.prototype.getOtherObject=function(e,t,o){if(isSnapObject(e))return e;if("myself"===this.inputOption(e))return t;var r=isNil(o)?t.parentThatIsA(StageMorph):o,n=null;return r&&(n=(n=detect(r.children,function(t){return t.name===e}))||detect(r.world().hand.children,function(t){return t instanceof SpriteMorph&&t.name===e})),n},Process.prototype.getObjectsNamed=function(e,t,o){var r=isNil(o)?t.parentThatIsA(StageMorph):o,n=[];function i(t){return t instanceof SpriteMorph&&t.isTemporary?t.cloneOriginName===e:t.name===e}return r&&((n=r.children.filter(i)).length||(n=r.world().hand.children.filter(i))),n},Process.prototype.setHeading=function(t){var e=this.blockReceiver();e&&("random"===this.inputOption(t)&&(t=this.reportRandom(1,36e3)/100),e.setHeading(t))},Process.prototype.doFaceTowards=function(t){var e,o=this.blockReceiver();if(o)if("center"===this.inputOption(t))o.faceToXY(0,0);else if("mouse-pointer"===this.inputOption(t))o.faceToXY(this.reportMouseX(),this.reportMouseY());else if("random position"===this.inputOption(t))o.setHeading(this.reportRandom(1,36e3)/100);else{if(t instanceof List)return void o.faceToXY(t.at(1),t.at(2));(e=this.getOtherObject(t,this.homeContext.receiver))&&o.faceToXY(e.xPosition(),e.yPosition())}},Process.prototype.doGotoObject=function(t){var e,o,r=this.blockReceiver();if(r)if("center"===this.inputOption(t))r.gotoXY(0,0);else if("mouse-pointer"===this.inputOption(t))r.gotoXY(this.reportMouseX(),this.reportMouseY());else if("random position"===this.inputOption(t))(o=r.parentThatIsA(StageMorph))&&r.setCenter(new Point(this.reportRandom(o.left(),o.right()),this.reportRandom(o.top(),o.bottom())));else{if(t instanceof List)return void r.gotoXY(t.at(1),t.at(2));(e=this.getOtherObject(t,this.homeContext.receiver))&&r.gotoXY(e.xPosition(),e.yPosition())}},Process.prototype.goToLayer=function(t){var e=this.inputOption(t),o=this.blockReceiver();o instanceof SpriteMorph&&("front"===e?o.comeToFront():"back"===e&&o.goToBack())},Process.prototype.setHSVA=function(t,e){this.blockReceiver().setColorComponentHSVA(["hue","saturation","brightness","transparency"].indexOf(this.inputOption(t)),+e)},Process.prototype.changeHSVA=function(t,e){this.blockReceiver().changeColorComponentHSVA(["hue","saturation","brightness","transparency"].indexOf(this.inputOption(t)),+e)},Process.prototype.setPenHSVA=Process.prototype.setHSVA,Process.prototype.changePenHSVA=Process.prototype.changeHSVA,Process.prototype.setBackgroundHSVA=Process.prototype.setHSVA,Process.prototype.changeBackgroundHSVA=Process.prototype.changeHSVA,Process.prototype.createClone=function(t){var e,o=this.blockReceiver();t&&!this.readyToTerminate&&o&&("myself"===this.inputOption(t)?o.createClone(!this.isFirstStep):(e=this.getOtherObject(t,o))&&e.createClone(!this.isFirstStep))},Process.prototype.newClone=function(t){var e,o=this.blockReceiver();if(t&&o){if("myself"===this.inputOption(t))return o.newClone(!this.isFirstStep);if(e=this.getOtherObject(t,o))return e.newClone(!this.isFirstStep)}},Process.prototype.reportTouchingObject=function(t){var e=this.blockReceiver();return!!e&&this.objectTouchingObject(e,t)},Process.prototype.objectTouchingObject=function(e,o){var t,r,n,i=this;if("mouse-pointer"===this.inputOption(o)){if(n=e.world().hand.position(),e.bounds.containsPoint(n)&&!e.isTransparentAt(n))return!0}else if(t=e.parentThatIsA(StageMorph)){if("edge"===this.inputOption(o)&&(r=e.bounds,!e.costume&&e.penBounds&&(r=e.penBounds.translateBy(e.position())),!t.bounds.containsRectangle(r)))return!0;if("pen trails"===this.inputOption(o)&&e.isTouching(t.penTrailsMorph()))return!0;if(isSnapObject(o))return o.isVisible&&e.isTouching(o);if((o instanceof List?o.itemsArray():this.getObjectsNamed(o,e,t)).some(function(t){return t.isVisible&&e.isTouching(t)}))return!0}return e.parts.some(function(t){return i.objectTouchingObject(t,o)})},Process.prototype.reportTouchingColor=function(e,o){var r,t=this.blockReceiver();return!(!t||!(r=t.parentThatIsA(StageMorph)))&&(!!t.isTouching(r.colorFiltered(e,t,o))||t.parts.some(function(t){return t.isTouching(r.colorFiltered(e,t,o))}))},Process.prototype.reportFuzzyTouchingColor=Process.prototype.reportTouchingColor,Process.prototype.reportColorIsTouchingColor=function(e,o,r){var n,t=this.blockReceiver();return!(!t||!(n=t.parentThatIsA(StageMorph)))&&(!!t.colorFiltered(e,r).isTouching(n.colorFiltered(o,t,r))||t.parts.some(function(t){return t.colorFiltered(e,r).isTouching(n.colorFiltered(o,t,r))}))},Process.prototype.reportFuzzyColorIsTouchingColor=Process.prototype.reportColorIsTouchingColor,Process.prototype.reportAspect=function(t,e){var o,r,n,i=this.inputOption(t),s=this.inputOption(e),a=["hue","saturation","brightness","transparency"].indexOf(i),c=this.blockReceiver(),p=c.parentThatIsA(StageMorph),h=c.world();if("myself"===s){if("sprites"===i)return r=c instanceof StageMorph?c.center():c.rotationCenter(),this.spritesAtPoint(r,p);n=this.colorAtSprite(c)}else if("mouse-pointer"===s){if("sprites"===i)return this.spritesAtPoint(h.hand.position(),p);n=h.getGlobalPixelColor(h.hand.position())}else if(s instanceof List){if(r=new Point(s.at(1)*p.scale+p.center().x,p.center().y-s.at(2)*p.scale),"sprites"===i)return this.spritesAtPoint(r,p);n=h.getGlobalPixelColor(r)}else{if(!s)return;if(!(o=this.getOtherObject(s,c,p)))return;if("sprites"===i)return r=o instanceof SpriteMorph?o.rotationCenter():o.center(),this.spritesAtPoint(r,p);n=this.colorAtSprite(o)}if(!(a<0||3<a))return 3===a?100*(1-n.a):100*n.hsv()[a]},Process.prototype.colorAtSprite=function(t){var e,o,r=t instanceof SpriteMorph?t.rotationCenter():t.center(),n=t.parentThatIsA(StageMorph);if(!n)return new Color;for(o=n.children.length;0<o;--o)if((e=n.children[o-1])!==t&&e.isVisible&&e.bounds.containsPoint(r)&&!e.isTransparentAt(r))return e.getPixelColor(r);return n.bounds.containsPoint(r)?n.getPixelColor(r):new Color},Process.prototype.colorBelowSprite=function(t){var e,o,r=t instanceof SpriteMorph?t.rotationCenter():t.center(),n=t.parentThatIsA(StageMorph),i=n,s=!1;if(!n)return new Color;for(o=0;o<n.children.length;o+=1)s||((e=n.children[o])===t?s=!0:e.isVisible&&e.bounds.containsPoint(r)&&!e.isTransparentAt(r)&&(i=e));return i.bounds.containsPoint(r)?i.getPixelColor(r):new Color},Process.prototype.spritesAtPoint=function(e,t){return new List(t.children.filter(function(t){return t instanceof SpriteMorph&&t.isVisible&&t.bounds.containsPoint(e)&&!t.isTransparentAt(e)}))},Process.prototype.reportRelationTo=function(t,e){var o=this.inputOption(t);return"distance"===o?this.reportDistanceTo(e):"direction"===o?this.reportDirectionTo(e):0},Process.prototype.reportDistanceTo=function(t){var e,o,r,n,i=this.blockReceiver();if(i){if(n=r=i.rotationCenter(),"mouse-pointer"===this.inputOption(t))n=i.world().hand.position();else{if("center"===this.inputOption(t))return new Point(i.xPosition(),i.yPosition()).distanceTo(new Point(0,0));if(t instanceof List)return new Point(i.xPosition(),i.yPosition()).distanceTo(new Point(t.at(1),t.at(2)))}return o=i.parentThatIsA(StageMorph),(e=this.getOtherObject(t,i,o))&&(n=e.rotationCenter()),r.distanceTo(n)/o.scale}return 0},Process.prototype.reportDirectionTo=function(t){var e,o=this.blockReceiver();return o?"mouse-pointer"===this.inputOption(t)?o.angleToXY(this.reportMouseX(),this.reportMouseY()):"center"===this.inputOption(t)?o.angleToXY(0,0):t instanceof List?o.angleToXY(t.at(1),t.at(2)):(e=this.getOtherObject(t,this.homeContext.receiver))?o.angleToXY(e.xPosition(),e.yPosition()):o.direction():0},Process.prototype.reportAttributeOf=function(t,e){var o,r,n=this.blockReceiver();if(n&&(this.assertAlive(n),o=(r=n.parentThatIsA(StageMorph)).name===e?r:this.getOtherObject(e,n,r))){if(this.assertAlive(o),t instanceof BlockMorph)return this.reportContextFor(this.reify(o.getMethod(t.semanticSpec).blockInstance(),new List),o);if(t instanceof Context)return this.reportContextFor(t,o);if(isString(t))return o.variables.getVar(t);switch(this.inputOption(t)){case"x position":return o.xPosition?o.xPosition():"";case"y position":return o.yPosition?o.yPosition():"";case"direction":return o.direction?o.direction():"";case"costume #":return o.getCostumeIdx();case"costume name":return o.costume?o.costume.name:o instanceof SpriteMorph?localize("Turtle"):localize("Empty");case"size":return o.getScale?o.getScale():"";case"volume":return o.getVolume();case"balance":return o.getPan();case"width":return o instanceof StageMorph?o.dimensions.x:(this.assertType(o,"sprite"),o.width()/r.scale);case"height":return o instanceof StageMorph?o.dimensions.y:(this.assertType(o,"sprite"),o.height()/r.scale)}}return""},Process.prototype.reportGet=function(t){var e,o,r,n=this.blockReceiver();if(n)switch(this.inputOption(t)){case"self":return n;case"other sprites":return o=n.parentThatIsA(StageMorph),new List(o.children.filter(function(t){return t instanceof SpriteMorph&&t!==n}));case"parts":return new List(n.parts||[]);case"anchor":return n.anchor||"";case"parent":return n.exemplar||"";case"children":return new List(n.specimens?n.specimens():[]);case"temporary?":return n.isTemporary||!1;case"clones":return o=n.parentThatIsA(StageMorph),r=n.name||n.cloneOriginName,new List(o.children.filter(function(t){return t.isTemporary&&t!==n&&t.cloneOriginName===r}));case"other clones":return n.isTemporary?this.reportGet(["clones"]):new List;case"neighbors":return o=n.parentThatIsA(StageMorph),e=n.bounds.expandBy(new Point(n.width(),n.height())),new List(o.children.filter(function(t){return t instanceof SpriteMorph&&t!==n&&t.bounds.intersects(e)}));case"dangling?":return!n.rotatesWithAnchor;case"draggable?":return n.isDraggable;case"rotation style":return n.rotationStyle||0;case"rotation x":return n.xPosition();case"rotation y":return n.yPosition();case"center x":return n.xCenter();case"center y":return n.yCenter();case"name":return n.name;case"stage":return n.parentThatIsA(StageMorph);case"costume":return n.costume;case"costumes":return n.reportCostumes();case"sounds":return n.sounds;case"width":return n instanceof StageMorph?n.dimensions.x:(o=n.parentThatIsA(StageMorph))?n.width()/o.scale:0;case"height":return n instanceof StageMorph?n.dimensions.y:(o=n.parentThatIsA(StageMorph))?n.height()/o.scale:0}return""},Process.prototype.reportObject=function(t){var e,o,r=this.blockReceiver();if(r)return this.assertAlive(r),(e=(o=r.parentThatIsA(StageMorph)).name===t?o:this.getOtherObject(t,r,o))&&this.assertAlive(e),e},Process.prototype.doSet=function(t,e){var o,r,n=this.blockReceiver();if(this.assertAlive(n),!(t instanceof Context||t instanceof Array)||t instanceof Context&&"reportGet"!==t.expression.selector)throw new Error(localize("unsupported attribute"));switch((o=t instanceof Context?t.expression.inputs()[0].evaluate():t)instanceof Array&&(o=o[0]),o){case"anchor":if(this.assertType(n,"sprite"),e instanceof SpriteMorph){if(!n.enableNesting||contains(n.allParts(),e))throw new Error(localize("unable to nest\n(disabled or circular?)"));e.attachPart(n)}else n.detachFromAnchor();break;case"parent":this.assertType(n,"sprite"),e=e instanceof SpriteMorph?e:null,n.setExemplar(e);break;case"temporary?":this.assertType(n,"sprite"),this.assertType(e,"Boolean"),n.world().isDevMode&&(e?n.release():n.perpetuate());break;case"name":this.assertType(n,["sprite","stage"]),this.assertType(e,["text","number"]),(r=n.parentThatIsA(IDE_Morph))&&(n.setName(r.newSpriteName(e.toString(),n)),r.spriteBar.nameField.setContents(r.currentSprite.name.toString()));break;case"dangling?":this.assertType(n,"sprite"),this.assertType(e,"Boolean"),n.rotatesWithAnchor=!e,n.version=Date.now();break;case"draggable?":this.assertType(n,"sprite"),this.assertType(e,"Boolean"),n.isDraggable=e,(r=n.parentThatIsA(IDE_Morph))&&r.spriteBar.children.forEach(function(t){t.refresh&&t.refresh()}),n.version=Date.now();break;case"rotation style":if(this.assertType(n,"sprite"),this.assertType(+e,"number"),!contains([0,1,2],+e))return;n.rotationStyle=+e,n.changed(),n.drawNew(),n.changed(),(r=n.parentThatIsA(IDE_Morph))&&r.spriteBar.children.forEach(function(t){t.refresh&&t.refresh()}),n.version=Date.now();break;case"rotation x":this.assertType(n,"sprite"),this.assertType(e,"number"),n.setRotationX(e);break;case"rotation y":this.assertType(n,"sprite"),this.assertType(e,"number"),n.setRotationY(e);break;case"microphone modifier":this.setMicrophoneModifier(e);break;default:throw new Error('"'+localize(o)+'" '+localize("is read-only"))}},Process.prototype.reportContextFor=function(t,e){var o=copy(t);return o.receiver=e,o.outerContext&&(o.outerContext=copy(o.outerContext),o.outerContext.variables=copy(o.outerContext.variables),o.outerContext.receiver=e,o.outerContext.variables.parentFrame?(o.outerContext.variables.parentFrame=copy(o.outerContext.variables.parentFrame),o.outerContext.variables.parentFrame.parentFrame=e.variables):o.outerContext.variables.parentFrame=e.variables),o},Process.prototype.reportMouseX=function(){var t,e;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))&&(e=t.world())?(e.hand.position().x-t.center().x)/t.scale:0},Process.prototype.reportMouseY=function(){var t,e;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))&&(e=t.world())?(t.center().y-e.hand.position().y)/t.scale:0},Process.prototype.reportMouseDown=function(){var t;return!(!this.homeContext.receiver||!(t=this.homeContext.receiver.world()))&&"left"===t.hand.mouseButton},Process.prototype.reportKeyPressed=function(t){var e;return!(!this.homeContext.receiver||!(e=this.homeContext.receiver.parentThatIsA(StageMorph)))&&("any key"===this.inputOption(t)?0<Object.keys(e.keysPressed).length:void 0!==e.keysPressed[t])},Process.prototype.doResetTimer=function(){var t;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))&&t.resetTimer()},Process.prototype.reportTimer=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))?t.getTimer():0},Process.prototype.reportDate=function(t){var e,o=this.inputOption(t),r={year:"getFullYear",month:"getMonth",date:"getDate","day of week":"getDay",hour:"getHours",minute:"getMinutes",second:"getSeconds","time in milliseconds":"getTime"};return r[o]?(e=(new Date)[r[o]](),"month"!==o&&"day of week"!==o||(e+=1),e):""},Process.prototype.doSetVideoTransparency=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))&&(e.projectionTransparency=Math.max(0,Math.min(100,t)))},Process.prototype.reportVideo=function(t,e){var o=this.blockReceiver(),r=o.parentThatIsA(StageMorph),n=this.getOtherObject(e,o,r);if(!r.projectionSource||!r.projectionSource.stream)return this.context.accumulator||(this.context.accumulator=!0,r.startVideo()),this.pushContext("doYield"),void this.pushContext();switch(this.inputOption(t)){case"motion":return n instanceof SpriteMorph?(r.videoMotion.getLocalMotion(n),n.motionAmount):(r.videoMotion.getStageMotion(),r.videoMotion.motionAmount);case"direction":return n instanceof SpriteMorph?(r.videoMotion.getLocalMotion(n),n.motionDirection):(r.videoMotion.getStageMotion(),r.videoMotion.motionDirection);case"snap":return n instanceof SpriteMorph?n.projectionSnap():r.projectionSnap()}return-1},Process.prototype.doMapCodeOrHeader=function(t,e,o){if("code"===this.inputOption(e))return this.doMapCode(t,o);if("header"===this.inputOption(e))return this.doMapHeader(t,o);throw new Error(" '"+e+"'\nis not a valid option")},Process.prototype.doMapHeader=function(t,e){if(t instanceof Context&&t.expression instanceof SyntaxElementMorph)return t.expression.mapHeader(e||"")},Process.prototype.doMapCode=function(t,e){if(t instanceof Context&&t.expression instanceof SyntaxElementMorph)return t.expression.mapCode(e||"")},Process.prototype.doMapValueCode=function(t,e){var o=this.inputOption(t);switch(o){case"String":StageMorph.prototype.codeMappings.string=e||"<#1>";break;case"Number":StageMorph.prototype.codeMappings.number=e||"<#1>";break;case"true":StageMorph.prototype.codeMappings.boolTrue=e||"true";break;case"false":StageMorph.prototype.codeMappings.boolFalse=e||"true";break;default:throw new Error(localize("unsupported data type")+" "+o)}},Process.prototype.doMapListCode=function(t,e,o){var r="",n="delim";"parameters"===this.inputOption(e)?r="parms_":"variables"===this.inputOption(e)&&(r="tempvars_"),"list"===this.inputOption(t)?n="list":"item"===this.inputOption(t)&&(n="item"),StageMorph.prototype.codeMappings[r+n]=o||""},Process.prototype.reportMappedCode=function(t){return t instanceof Context&&t.expression instanceof SyntaxElementMorph?t.expression.mappedCode():""},Process.prototype.doRest=function(t){var e=this.reportTempo();this.doWait(60/e*t)},Process.prototype.reportTempo=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))?t.getTempo():0},Process.prototype.doChangeTempo=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))&&e.changeTempo(t)},Process.prototype.doSetTempo=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))&&e.setTempo(t)},Process.prototype.doPlayNote=function(t,e){var o=this.reportTempo();this.doPlayNoteForSecs(parseFloat(t||"0"),60/o*parseFloat(e||"0"))},Process.prototype.doPlayNoteForSecs=function(t,e){var o=this.blockReceiver();if(this.context.startTime||(o.setVolume(o.getVolume()),o.setPan(o.getPan()),this.context.startTime=Date.now(),this.context.activeNote=new Note(t),this.context.activeNote.play(this.instrument,o.getGainNode(),o.getPannerNode())),Date.now()-this.context.startTime>=1e3*e)return this.context.activeNote&&(this.context.activeNote.stop(),this.context.activeNote=null),null;this.pushContext("doYield"),this.pushContext()},Process.prototype.doPlayFrequency=function(t,e){this.doPlayFrequencyForSecs(parseFloat(t||"0"),parseFloat(e||"0"))},Process.prototype.doPlayFrequencyForSecs=function(t,e){if(this.context.startTime||(this.context.startTime=Date.now(),this.context.activeNote=new Note,this.context.activeNote.frequency=t,this.context.activeNote.play(this.instrument)),Date.now()-this.context.startTime>=1e3*e)return this.context.activeNote&&(this.context.activeNote.stop(),this.context.activeNote=null),null;this.pushContext("doYield"),this.pushContext()},Process.prototype.doSetInstrument=function(t){this.instrument=+t,this.receiver.instrument=+t,this.receiver.freqPlayer&&this.receiver.freqPlayer.setInstrument(+t)},Process.prototype.reportGetImageAttribute=function(t,e){var o=this.costumeNamed(e)||new Costume;switch(this.inputOption(t)){case"name":return o.name;case"width":return o.width();case"height":return o.height();case"pixels":return o.rasterized().pixels();default:return o}},Process.prototype.reportNewCostumeStretched=function(t,e,o){var r;return t instanceof List?this.reportNewCostume(t,e,o):(r=this.costumeNamed(t))?r.stretched(Math.round(r.width()*e/100),Math.round(r.height()*o/100)):new Costume},Process.prototype.costumeNamed=function(e){return e instanceof Costume?e:"number"==typeof e?this.blockReceiver().costumes.at(e):"current"===this.inputOption(e)?this.blockReceiver().costume:detect(this.blockReceiver().costumes.asArray(),function(t){return t.name===e.toString()})},Process.prototype.reportNewCostume=function(t,e,o){e=Math.abs(Math.floor(+e)),o=Math.abs(Math.floor(+o));for(var r,n,i=newCanvas(new Point(e,o),!0),s=i.getContext("2d"),a=t.asArray(),c=s.createImageData(e,o),p=0;p<a.length;p+=1)for(n=a[p].asArray(),r=0;r<4;r+=1)c.data[4*p+r]=n[r];return s.putImageData(c,0,0),new Costume(i,this.blockReceiver().newCostumeName(localize("snap")))},Process.prototype.inputOption=function(t){return t instanceof Array?t[0]:t},Process.prototype.pushContext=function(t,e){this.context=new Context(this.context,t,e||(this.context?this.context.outerContext:null),this.context?this.context.receiver:this.homeContext.receiver)},Process.prototype.popContext=function(){this.context&&this.context.stopMusic(),this.context=this.context?this.context.parentContext:null},Process.prototype.returnValueToParentContext=function(t){void 0!==t&&(this.context&&this.context.parentContext||this.homeContext).addInput(t)},Process.prototype.reportStackSize=function(){return this.context?this.context.stackSize():0},Process.prototype.reportFrameCount=function(){return this.frameCount},Process.prototype.flashContext=function(){var t=this.context.expression;return!(!(this.enableSingleStepping&&!this.isAtomic&&t instanceof SyntaxElementMorph)||t instanceof CommandSlotMorph||this.context.isFlashing||!t.world()||t instanceof ColorSlotMorph)&&(this.unflash(),t.flash(),this.context.isFlashing=!0,this.flashingContext=this.context,0<this.flashTime&&this.flashTime<=.5?(this.pushContext("doIdle"),this.context.addInput(this.flashTime)):this.pushContext("doInterrupt"),!0)},Process.prototype.flashPausedContext=function(){var t=this.context?this.context.lastFlashable():null;t&&(this.unflash(),t.expression.flash(),t.isFlashing=!0,this.flashingContext=t)},Process.prototype.doInterrupt=function(){this.popContext(),this.isAtomic||(this.isInterrupted=!0)},Process.prototype.doIdle=function(t){this.context.startTime||(this.context.startTime=Date.now()),Date.now()-this.context.startTime<1e3*t?this.pushContext("doInterrupt"):this.popContext()},Process.prototype.unflash=function(){this.flashingContext&&(this.flashingContext.expression.unflash(),this.flashingContext.isFlashing=!1,this.flashingContext=null)},Process.prototype.reportCompiled=function(t,e){return new JSCompiler(this).compileFunction(t,e)},Process.prototype.capture=function(t){var e=new Process(this.topBlock,this.receiver),o=new Context(t.parentContext,t.expression,t.outerContext,t.receiver);return o.variables=t.variables.fullCopy(),o.variables.root().parentFrame=e.variables,e.context=o,e},Process.prototype.getVarNamed=function(t){var e,o=this.homeContext.variables.silentFind(t)||this.context.variables.silentFind(t);if(o)return 0===(e=o.vars[t].value)?0:!1!==e&&(""===e?"":e||0);throw new Error(localize("a variable of name '")+t+localize("'\ndoes not exist in this context"))},Process.prototype.setVarNamed=function(t,e){var o=this.homeContext.variables.silentFind(t)||this.context.variables.silentFind(t);if(isNil(o))throw new Error(localize("a variable of name '")+t+localize("'\ndoes not exist in this context"));o.vars[t].value=e},Process.prototype.incrementVarNamed=function(t,e){this.setVarNamed(t,this.getVarNamed(t)+ +e)},Process.prototype.reportAtomicMap=function(e,t){this.assertType(t,"list");var o,r,n,i=[],s=t.asArray(),a=s.length,c=e.inputs.length;try{r=this.reportCompiled(e,1)}catch(t){console.log(t.message),r=e}for(n=0;n<a;n+=1)o=[s[n]],1<c&&o.push(n+1),2<c&&o.push(t),i.push(invoke(r,new List(o),null,null,null,null,this.capture(e)));return new List(i)},Process.prototype.reportAtomicKeep=function(e,t){this.assertType(t,"list");var o,r,n,i=[],s=t.asArray(),a=s.length,c=e.inputs.length;try{r=this.reportCompiled(e,1)}catch(t){console.log(t.message),r=e}for(n=0;n<a;n+=1)o=[s[n]],1<c&&o.push(n+1),2<c&&o.push(t),invoke(r,new List(o),null,null,null,null,this.capture(e))&&i.push(s[n]);return new List(i)},Process.prototype.reportAtomicFindFirst=function(e,t){this.assertType(t,"list");var o,r,n,i=t.asArray(),s=i.length,a=e.inputs.length;try{r=this.reportCompiled(e,1)}catch(t){console.log(t.message),r=e}for(n=0;n<s;n+=1)if(o=[i[n]],1<a&&o.push(n+1),2<a&&o.push(t),invoke(r,new List(o),null,null,null,null,this.capture(e)))return i[n];return!1},Process.prototype.reportAtomicCombine=function(t,e){this.assertType(t,"list");var o,r,n,i="",s=t.asArray(),a=s.length,c=e.inputs.length;if(0===a)return i;i=s[0];try{r=this.reportCompiled(e,2)}catch(t){console.log(t.message),r=e}for(n=1;n<a;n+=1)o=[i,s[n]],2<c&&o.push(n+1),3<c&&o.push(t),i=invoke(r,new List(o),null,null,null,null,this.capture(e));return i},Process.prototype.reportAtomicSort=function(t,o){this.assertType(t,"list");var r,n=this;try{r=this.reportCompiled(o,2)}catch(t){console.log(t.message),r=o}return new List(t.asArray().slice().sort(function(t,e){return invoke(r,new List([t,e]),null,null,null,null,n.capture(o))?-1:1}))},Process.prototype.reportAtomicGroup=function(t,e){this.assertType(t,"list");var o,r,n,i=[],s=new Map,a=t.asArray(),c=a.length;try{r=this.reportCompiled(e,1)}catch(t){console.log(t.message),r=e}for(n=0;n<c;n+=1)o=invoke(r,new List([a[n]]),null,null,null,null,this.capture(e)),s.has(o)?s.get(o).push(a[n]):s.set(o,[a[n]]);return s.forEach(function(t,e){i.push(new List([e,t.length,new List(t)]))}),new List(i)},Context.prototype.toString=function(){var t=this.expression;return t instanceof Array&&0<t.length&&(t="["+t[0]+"]"),"Context >> "+t+" "+this.variables},Context.prototype.image=function(){var t,e,o=new RingMorph;return this.expression instanceof Morph?(t=this.expression.fullCopy(),this.isContinuation&&(e=detect(t.allInputs(),function(t){return 1===t.bindingID}))&&t.revertToDefaultInput(e,!0),o.embed(t,this.inputs),o.fullImage()):this.expression instanceof Array?(t=this.expression[this.pc].fullCopy())instanceof RingMorph&&!t.contents()?t.fullImage():(o.embed(t,this.isContinuation?[]:this.inputs),o.fullImage()):(o.color=SpriteMorph.prototype.blockColor.other,o.setSpec("%rc %ringparms"),this.isContinuation||this.inputs.forEach(function(t){o.parts()[1].addInput(t)}),o.fullImage())},Context.prototype.continuation=function(){var t;if(this.expression instanceof Array)t=this;else{if(!this.parentContext)return(t=new Context(null,"expectReport")).isContinuation=!0,t;t=this.parentContext}return(t=t.copyForContinuation()).tag=null,t.isContinuation=!0,t},Context.prototype.copyForContinuation=function(){var t=copy(this),e=t;if(!(this.expression instanceof Array||isString(this.expression)))for(e.prepareContinuationForBinding();e.parentContext;)e.parentContext=copy(e.parentContext),(e=e.parentContext).inputs=[];return t},Context.prototype.copyForContinuationCall=function(){var t=copy(this),e=t;if(!(this.expression instanceof Array||isString(this.expression)))for(this.expression=this.expression.fullCopy(),this.inputs=[];e.parentContext;)e.parentContext=copy(e.parentContext),(e=e.parentContext).inputs=[];return t},Context.prototype.prepareContinuationForBinding=function(){var t,e=this.inputs.length;this.expression=this.expression.fullCopy(),(t=this.expression.inputs()[e])&&(this.inputs=[],t.bindingID=1,this.emptySlots=1)},Context.prototype.addInput=function(t){this.inputs.push(t)},Context.prototype.stopMusic=function(){this.activeNote&&(this.activeNote.stop(),this.activeNote=null)},Context.prototype.lastFlashable=function(){return this.expression instanceof SyntaxElementMorph&&!(this.expression instanceof CommandSlotMorph)?this:this.parentContext?this.parentContext.lastFlashable():null},Context.prototype.stackSize=function(){return this.parentContext?1+this.parentContext.stackSize():1},Variable.prototype.toString=function(){return"a "+(this.isTransient?"transient ":"")+"Variable ["+this.value+"]"},Variable.prototype.copy=function(){return new Variable(this.value,this.isTransient)},VariableFrame.prototype.toString=function(){return"a VariableFrame {"+this.names()+"}"},VariableFrame.prototype.copy=function(){var e=new VariableFrame(this.parentFrame),o=this;return this.names().forEach(function(t){e.addVar(t,o.getVar(t))}),e},VariableFrame.prototype.fullCopy=function(){var t=this.parentFrame?new VariableFrame(this.parentFrame.fullCopy()):new VariableFrame;return t.vars=copy(this.vars),t},VariableFrame.prototype.root=function(){return this.parentFrame?this.parentFrame.root():this},VariableFrame.prototype.find=function(t){var e=this.silentFind(t);if(e)return e;throw new Error(localize("a variable of name '")+t+localize("'\ndoes not exist in this context"))},VariableFrame.prototype.silentFind=function(t){return void 0!==this.vars[t]?this:this.parentFrame?this.parentFrame.silentFind(t):null},VariableFrame.prototype.setVar=function(t,e,o){var r=this.find(t);r&&(o instanceof SpriteMorph&&r.owner instanceof SpriteMorph&&o!==r.owner?o.shadowVar(t,e):r.vars[t].value=e)},VariableFrame.prototype.changeVar=function(t,e,o){var r,n,i=this.find(t);i&&(r=parseFloat(i.vars[t].value),n=isNaN(r)?e:r+parseFloat(e),o instanceof SpriteMorph&&i.owner instanceof SpriteMorph&&o!==i.owner?o.shadowVar(t,n):i.vars[t].value=n)},VariableFrame.prototype.getVar=function(t){var e,o=this.silentFind(t);if(o)return 0===(e=o.vars[t].value)?0:!1!==e&&(""===e?"":e||0);if("number"==typeof t)return"";throw new Error(localize("a variable of name '")+t+localize("'\ndoes not exist in this context"))},VariableFrame.prototype.addVar=function(t,e){this.vars[t]=new Variable(0===e?0:!1!==e&&(""===e?"":e||0))},VariableFrame.prototype.deleteVar=function(t){var e=this.find(t);e&&delete e.vars[t]},VariableFrame.prototype.names=function(){var t,e=[];for(t in this.vars)Object.prototype.hasOwnProperty.call(this.vars,t)&&e.push(t);return e},VariableFrame.prototype.allNamesDict=function(t){var e={},o=this;for(;o&&o!==t;)!function(t,e){var o;for(o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=o)}(o.vars,e),o=o.parentFrame;return e},VariableFrame.prototype.allNames=function(t){var e,o=[],r=this.allNamesDict(t);for(e in r)Object.prototype.hasOwnProperty.call(r,e)&&o.push(e);return o},JSCompiler.prototype.toString=function(){return"a JSCompiler"},JSCompiler.prototype.compileFunction=function(t,e){var o,r,n=t.expression,i=t.inputs,s=[],a=this;if(this.source=t,this.implicitParams=e||1,o=!isNil(detect(n.allChildren(),function(t){return t.isEmptySlot&&t.isEmptySlot()})),this.gensyms={},this.paramCount=0,i.length){if(o)throw new Error("compiling does not yet support\nmixing explicit formal parameters\nwith empty input slots");i.forEach(function(t,e){var o="p"+e;s.push(o),a.gensyms[t]=o})}else if(o)if(1<this.implicitParams)for(r=0;r<this.implicitParams;r+=1)s.push("p"+r);else s=["p0"];return n instanceof CommandBlockMorph?Function.apply(null,s.concat([this.compileSequence(n)])):Function.apply(null,s.concat(["return "+this.compileExpression(n)]))},JSCompiler.prototype.compileExpression=function(t){var e,o,r,n=t.selector,i=t.inputs();switch(n){case"reportOr":return this.compileInfix("||",i);case"reportAnd":return this.compileInfix("&&",i);case"reportIfElse":return"("+this.compileInput(i[0])+" ? "+this.compileInput(i[1])+" : "+this.compileInput(i[2])+")";case"evaluateCustomBlock":throw new Error("compiling does not yet support\ncustom blocks");case"doSetVar":return"arguments[arguments.length - 1].setVarNamed("+this.compileInput(i[0])+","+this.compileInput(i[1])+")";case"doChangeVar":return"arguments[arguments.length - 1].incrementVarNamed("+this.compileInput(i[0])+","+this.compileInput(i[1])+")";case"doReport":return"return "+this.compileInput(i[0]);case"doIf":return"if ("+this.compileInput(i[0])+") {\n"+this.compileSequence(i[1].evaluate())+"}";case"doIfElse":return"if ("+this.compileInput(i[0])+") {\n"+this.compileSequence(i[1].evaluate())+"} else {\n"+this.compileSequence(i[2].evaluate())+"}";default:return o=(e=this.process[n]?this.process:this.source.receiver||this.process.receiver).constructor.name+".prototype",r=this.compileInputs(i),isSnapObject(e)?o+"."+n+".apply("+o+", ["+r+"])":"arguments[arguments.length - 1]."+n+".apply(arguments[arguments.length - 1], ["+r+"])"}},JSCompiler.prototype.compileSequence=function(t){var e="",o=this;return t.blockSequence().forEach(function(t){e+=o.compileExpression(t),e+=";\n"}),e},JSCompiler.prototype.compileInfix=function(t,e){return"("+this.compileInput(e[0])+" "+t+" "+this.compileInput(e[1])+")"},JSCompiler.prototype.compileInputs=function(t){var e="",o=this;return t.forEach(function(t){e.length&&(e+=", "),e+=o.compileInput(t)}),e},JSCompiler.prototype.compileInput=function(t){var e,o;if(t.isEmptySlot&&t.isEmptySlot()){if(1<this.implicitParams){if(this.paramCount<this.implicitParams)return this.paramCount+=1,"p"+(this.paramCount-1);throw new Error(localize("expecting")+" "+this.implicitParams+" "+localize("input(s), but getting")+" "+this.paramCount)}return"p0"}if(t instanceof MultiArgMorph)return"new List(["+this.compileInputs(t.inputs())+"])";if(t instanceof ArgLabelMorph)return this.compileInput(t.argMorph());if(!(t instanceof ArgMorph)){if(t instanceof BlockMorph)return"reportGetVar"===t.selector?contains(this.source.inputs,t.blockSpec)?this.gensyms[t.blockSpec]:'arguments[arguments.length - 1].getVarNamed("'+t.blockSpec+'")':this.compileExpression(t);throw new Error("compiling does not yet support\ninput slots of type\n"+t.constructor.name)}switch(e=t.evaluate(),o=this.process.reportTypeOf(e)){case"number":case"Boolean":return""+e;case"text":return'"'+e+'"';case"list":return"new List(["+this.compileInputs(e)+"])";default:if(e instanceof Array)return'"'+e[0]+'"';throw new Error("compiling does not yet support\ninputs of type\n"+o)}};</script>
        <script>var SpriteMorph,StageMorph,SpriteBubbleMorph,Costume,SVG_Costume,CostumeEditorMorph,Sound,Microphone,CellMorph,WatcherMorph,StagePrompterMorph,Note,SpriteHighlightMorph;function isSnapObject(t){return t instanceof SpriteMorph||t instanceof StageMorph}function SpriteMorph(t){this.init(t)}function SpriteHighlightMorph(){this.init()}function StageMorph(t){this.init(t)}function SpriteBubbleMorph(t,e,o,r){this.init(t,e,o,r)}function Costume(t,e,o){this.contents=t?normalizeCanvas(t,!0):newCanvas(null,!0),this.shrinkToFit(this.maxExtent()),this.name=e||null,this.rotationCenter=o||this.center(),this.version=Date.now(),this.loaded=null}function SVG_Costume(t,e,o){this.contents=t,this.shapes=[],this.shrinkToFit(this.maxExtent()),this.name=e||null,this.rotationCenter=o||this.center(),this.version=Date.now(),this.loaded=null}function CostumeEditorMorph(t){this.init(t)}function Sound(t,e){this.audio=t,this.name=e||"Sound",this.cachedSamples=null,this.audioBuffer=null,this.isDecoding=!1}function Note(t){this.pitch=0===t?0:t||69,this.frequency=null,this.setupContext(),this.oscillator=null,this.fader=null,this.ended=!1}function Microphone(){this.audioContext=null,this.sourceStream=null,this.processor=null,this.analyser=null,this.resolution=2,this.GOOD_ENOUGH_CORRELATION=.96,this.modifier=null,this.compiledModifier=null,this.compilerProcess=null,this.correlations=[],this.wrapper=new List([0]),this.outChannels=[],this.volume=0,this.signals=[],this.output=[],this.frequencies=[],this.pitch=-1,this.isStarted=!1,this.isReady=!1,this.isAutoStop="file:"!==location.protocol,this.lastTime=Date.now()}function CellMorph(t,e,o,r){this.init(t,e,o,r)}function WatcherMorph(t,e,o,r,i){this.init(t,e,o,r,i)}function StagePrompterMorph(t){this.init(t)}modules.objects="2019-July-15",SpriteMorph.prototype=new PenMorph,(SpriteMorph.prototype.constructor=SpriteMorph).uber=PenMorph.prototype,SpriteMorph.prototype.attributes=["x position","y position","direction","size","costumes","costume #","volume","balance","sounds","shown?","pen down?","scripts"],SpriteMorph.prototype.categories=["motion","control","looks","sensing","sound","operators","pen","variables","lists","other"],SpriteMorph.prototype.blockColor={motion:new Color(74,108,212),looks:new Color(143,86,227),sound:new Color(207,74,217),pen:new Color(0,161,120),control:new Color(230,168,34),sensing:new Color(4,148,220),operators:new Color(98,194,19),variables:new Color(243,118,29),lists:new Color(217,77,17),other:new Color(150,150,150)},SpriteMorph.prototype.paletteColor=new Color(55,55,55),SpriteMorph.prototype.paletteTextColor=new Color(230,230,230),SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30),SpriteMorph.prototype.isCachingPrimitives=!0,SpriteMorph.prototype.enableNesting=!0,SpriteMorph.prototype.enableFirstClass=!0,SpriteMorph.prototype.useFlatLineEnds=!1,SpriteMorph.prototype.highlightColor=new Color(250,200,130),SpriteMorph.prototype.highlightBorder=8,SpriteMorph.prototype.bubbleColor=new Color(255,255,255),SpriteMorph.prototype.bubbleFontSize=14,SpriteMorph.prototype.bubbleFontIsBold=!0,SpriteMorph.prototype.bubbleCorner=10,SpriteMorph.prototype.bubbleBorder=3,SpriteMorph.prototype.bubbleBorderColor=new Color(190,190,190),SpriteMorph.prototype.bubbleMaxTextWidth=130,SpriteMorph.prototype.initBlocks=function(){SpriteMorph.prototype.blocks={forward:{only:SpriteMorph,type:"command",category:"motion",spec:"move %n steps",defaults:[10]},turn:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %clockwise %n degrees",defaults:[15]},turnLeft:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %counterclockwise %n degrees",defaults:[15]},setHeading:{only:SpriteMorph,type:"command",category:"motion",spec:"point in direction %dir"},doFaceTowards:{only:SpriteMorph,type:"command",category:"motion",spec:"point towards %dst"},gotoXY:{only:SpriteMorph,type:"command",category:"motion",spec:"go to x: %n y: %n",defaults:[0,0]},doGotoObject:{only:SpriteMorph,type:"command",category:"motion",spec:"go to %dst"},doGlide:{only:SpriteMorph,type:"command",category:"motion",spec:"glide %n secs to x: %n y: %n",defaults:[1,0,0]},changeXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change x by %n",defaults:[10]},setXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"set x to %n",defaults:[0]},changeYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change y by %n",defaults:[10]},setYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"set y to %n",defaults:[0]},bounceOffEdge:{only:SpriteMorph,type:"command",category:"motion",spec:"if on edge, bounce"},xPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"x position"},yPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"y position"},direction:{only:SpriteMorph,type:"reporter",category:"motion",spec:"direction"},doSwitchToCostume:{type:"command",category:"looks",spec:"switch to costume %cst"},doWearNextCostume:{type:"command",category:"looks",spec:"next costume"},getCostumeIdx:{type:"reporter",category:"looks",spec:"costume #"},reportGetImageAttribute:{type:"reporter",category:"looks",spec:"%img of costume %cst",defaults:[["width"]]},reportNewCostumeStretched:{type:"reporter",category:"looks",spec:"stretch %cst x: %n y: %n %",defaults:["",100,50]},doSayFor:{only:SpriteMorph,type:"command",category:"looks",spec:"say %s for %n secs",defaults:[localize("Hello!"),2]},bubble:{only:SpriteMorph,type:"command",category:"looks",spec:"say %s",defaults:[localize("Hello!")]},doThinkFor:{only:SpriteMorph,type:"command",category:"looks",spec:"think %s for %n secs",defaults:[localize("Hmm..."),2]},doThink:{only:SpriteMorph,type:"command",category:"looks",spec:"think %s",defaults:[localize("Hmm...")]},changeEffect:{type:"command",category:"looks",spec:"change %eff effect by %n",defaults:[null,25]},setEffect:{type:"command",category:"looks",spec:"set %eff effect to %n",defaults:[null,0]},getEffect:{type:"reporter",category:"looks",spec:"%eff effect"},clearEffects:{type:"command",category:"looks",spec:"clear graphic effects"},changeScale:{only:SpriteMorph,type:"command",category:"looks",spec:"change size by %n",defaults:[10]},setScale:{only:SpriteMorph,type:"command",category:"looks",spec:"set size to %n %",defaults:[100]},getScale:{only:SpriteMorph,type:"reporter",category:"looks",spec:"size"},show:{type:"command",category:"looks",spec:"show"},hide:{type:"command",category:"looks",spec:"hide"},reportShown:{type:"predicate",category:"looks",spec:"shown?"},goToLayer:{only:SpriteMorph,type:"command",category:"looks",spec:"go to %layer layer",defaults:[["front"]]},goBack:{only:SpriteMorph,type:"command",category:"looks",spec:"go back %n layers",defaults:[1]},doScreenshot:{type:"command",category:"looks",spec:"save %imgsource as costume named %s",defaults:[["pen trails"],localize("screenshot")]},reportCostumes:{dev:!0,type:"reporter",category:"looks",spec:"wardrobe"},alert:{dev:!0,type:"command",category:"looks",spec:"alert %mult%s"},log:{dev:!0,type:"command",category:"looks",spec:"console log %mult%s"},playSound:{type:"command",category:"sound",spec:"play sound %snd"},doPlaySoundUntilDone:{type:"command",category:"sound",spec:"play sound %snd until done"},doPlaySoundAtRate:{type:"command",category:"sound",spec:"play sound %snd at %rate Hz",defaults:["",44100]},doStopAllSounds:{type:"command",category:"sound",spec:"stop all sounds"},reportGetSoundAttribute:{type:"reporter",category:"sound",spec:"%aa of sound %snd",defaults:[["duration"]]},doRest:{type:"command",category:"sound",spec:"rest for %n beats",defaults:[.2]},doPlayNote:{type:"command",category:"sound",spec:"play note %note for %n beats",defaults:[60,.5]},doPlayFrequency:{dev:!0,type:"command",category:"sound",spec:"play %n Hz for %n secs",defaults:[440,2]},doSetInstrument:{type:"command",category:"sound",spec:"set instrument to %inst",defaults:[1]},doChangeTempo:{type:"command",category:"sound",spec:"change tempo by %n",defaults:[20]},doSetTempo:{type:"command",category:"sound",spec:"set tempo to %n bpm",defaults:[60]},getTempo:{type:"reporter",category:"sound",spec:"tempo"},changeVolume:{type:"command",category:"sound",spec:"change volume by %n",defaults:[10]},setVolume:{type:"command",category:"sound",spec:"set volume to %n %",defaults:[100]},getVolume:{type:"reporter",category:"sound",spec:"volume"},changePan:{type:"command",category:"sound",spec:"change balance by %n",defaults:[10]},setPan:{type:"command",category:"sound",spec:"set balance to %n",defaults:[0]},getPan:{type:"reporter",category:"sound",spec:"balance"},playFreq:{type:"command",category:"sound",spec:"play frequency %n Hz",defaults:[440]},stopFreq:{type:"command",category:"sound",spec:"stop frequency"},reportSounds:{dev:!0,type:"reporter",category:"sound",spec:"jukebox"},clear:{type:"command",category:"pen",spec:"clear"},down:{only:SpriteMorph,type:"command",category:"pen",spec:"pen down"},up:{only:SpriteMorph,type:"command",category:"pen",spec:"pen up"},getPenDown:{only:SpriteMorph,type:"predicate",category:"pen",spec:"pen down?"},setColor:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen color to %clr"},setPenHSVA:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen %hsva to %n",defaults:[["hue"],50]},changePenHSVA:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen %hsva by %n",defaults:[["hue"],10]},getPenAttribute:{type:"reporter",category:"pen",spec:"pen %pen",defaults:[["hue"]]},setBackgroundColor:{only:StageMorph,type:"command",category:"pen",spec:"set background color to %clr"},setBackgroundHSVA:{only:StageMorph,type:"command",category:"pen",spec:"set background %hsva to %n",defaults:[["hue"],50]},changeBackgroundHSVA:{only:StageMorph,type:"command",category:"pen",spec:"change background %hsva by %n",defaults:[["hue"],10]},changeSize:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen size by %n",defaults:[1]},setSize:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen size to %n",defaults:[1]},doStamp:{only:SpriteMorph,type:"command",category:"pen",spec:"stamp"},floodFill:{only:SpriteMorph,type:"command",category:"pen",spec:"fill"},write:{only:SpriteMorph,type:"command",category:"pen",spec:"write %s size %n",defaults:[localize("Hello!"),12]},reportPenTrailsAsCostume:{type:"reporter",category:"pen",spec:"pen trails"},receiveGo:{type:"hat",category:"control",spec:"when %greenflag clicked"},receiveKey:{type:"hat",category:"control",spec:"when %keyHat key pressed"},receiveInteraction:{type:"hat",category:"control",spec:"when I am %interaction",defaults:["clicked"]},receiveMessage:{type:"hat",category:"control",spec:"when I receive %msgHat"},receiveCondition:{type:"hat",category:"control",spec:"when %b"},doBroadcast:{type:"command",category:"control",spec:"broadcast %msg"},doBroadcastAndWait:{type:"command",category:"control",spec:"broadcast %msg and wait"},getLastMessage:{type:"reporter",category:"control",spec:"message"},doWait:{type:"command",category:"control",spec:"wait %n secs",defaults:[1]},doWaitUntil:{type:"command",category:"control",spec:"wait until %b"},doForever:{type:"command",category:"control",spec:"forever %loop"},doRepeat:{type:"command",category:"control",spec:"repeat %n %loop",defaults:[10]},doUntil:{type:"command",category:"control",spec:"repeat until %b %loop"},doFor:{type:"command",category:"control",spec:"for %upvar = %n to %n %cla",defaults:["i",1,10]},doIf:{type:"command",category:"control",spec:"if %b %c"},doIfElse:{type:"command",category:"control",spec:"if %b %c else %c"},reportIfElse:{type:"reporter",category:"control",spec:"if %b then %s else %s"},doStopThis:{type:"command",category:"control",spec:"stop %stopChoices"},doRun:{type:"command",category:"control",spec:"run %cmdRing %inputs"},fork:{type:"command",category:"control",spec:"launch %cmdRing %inputs"},evaluate:{type:"reporter",category:"control",spec:"call %repRing %inputs"},doReport:{type:"command",category:"control",spec:"report %s"},doCallCC:{type:"command",category:"control",spec:"run %cmdRing w/continuation"},reportCallCC:{type:"reporter",category:"control",spec:"call %cmdRing w/continuation"},doWarp:{type:"command",category:"other",spec:"warp %c"},doTellTo:{type:"command",category:"control",spec:"tell %spr to %cmdRing %inputs"},reportAskFor:{type:"reporter",category:"control",spec:"ask %spr for %repRing %inputs"},receiveOnClone:{type:"hat",category:"control",spec:"when I start as a clone"},createClone:{type:"command",category:"control",spec:"create a clone of %cln"},newClone:{type:"reporter",category:"control",spec:"a new clone of %cln",defaults:[["myself"]]},removeClone:{type:"command",category:"control",spec:"delete this clone"},doPauseAll:{type:"command",category:"control",spec:"pause all %pause"},reportTouchingObject:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %col ?"},reportTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %clr ?"},reportColorIsTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"color %clr is touching %clr ?"},colorFiltered:{dev:!0,type:"reporter",category:"sensing",spec:"filter %clr tolerance %n %",defaults:[null,15]},reportFuzzyTouchingColor:{dev:!0,only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %clr tolerance %n ?",defaults:[null,15]},reportFuzzyColorIsTouchingColor:{dev:!0,only:SpriteMorph,type:"predicate",category:"sensing",spec:"color %clr is touching %clr tolerance %n ?",defaults:[null,null,15]},reportAspect:{type:"reporter",category:"sensing",spec:"%asp at %loc",defaults:[["hue"]]},reportStackSize:{dev:!0,type:"reporter",category:"sensing",spec:"stack size"},reportFrameCount:{dev:!0,type:"reporter",category:"sensing",spec:"frames"},reportThreadCount:{dev:!0,type:"reporter",category:"sensing",spec:"processes"},doAsk:{type:"command",category:"sensing",spec:"ask %s and wait",defaults:[localize("what's your name?")]},reportLastAnswer:{dev:!0,type:"reporter",category:"sensing",spec:"answer"},getLastAnswer:{type:"reporter",category:"sensing",spec:"answer"},reportMouseX:{type:"reporter",category:"sensing",spec:"mouse x"},reportMouseY:{type:"reporter",category:"sensing",spec:"mouse y"},reportMouseDown:{type:"predicate",category:"sensing",spec:"mouse down?"},reportKeyPressed:{type:"predicate",category:"sensing",spec:"key %key pressed?"},reportRelationTo:{only:SpriteMorph,type:"reporter",category:"sensing",spec:"%rel to %dst",defaults:[["distance"]]},doResetTimer:{type:"command",category:"sensing",spec:"reset timer"},reportTimer:{dev:!0,type:"reporter",category:"sensing",spec:"timer"},getTimer:{type:"reporter",category:"sensing",spec:"timer"},reportAttributeOf:{type:"reporter",category:"sensing",spec:"%att of %spr",defaults:[["costume #"]]},reportObject:{type:"reporter",category:"sensing",spec:"object %self",defaults:[["myself"]]},reportURL:{type:"reporter",category:"sensing",spec:"url %s",defaults:["snap.berkeley.edu"]},doSetGlobalFlag:{type:"command",category:"sensing",spec:"set %setting to %b",defaults:[["video capture"]]},reportGlobalFlag:{type:"predicate",category:"sensing",spec:"is %setting on?",defaults:[["turbo mode"]]},reportDate:{type:"reporter",category:"sensing",spec:"current %dates"},reportGet:{type:"reporter",category:"sensing",spec:"my %get",defaults:[["neighbors"]]},reportAudio:{type:"reporter",category:"sensing",spec:"microphone %audio",defaults:[["volume"]]},reifyScript:{type:"ring",category:"other",spec:"%rc %ringparms",alias:"command ring lambda"},reifyReporter:{type:"ring",category:"other",spec:"%rr %ringparms",alias:"reporter ring lambda"},reifyPredicate:{type:"ring",category:"other",spec:"%rp %ringparms",alias:"predicate ring lambda"},reportSum:{type:"reporter",category:"operators",spec:"%n + %n"},reportDifference:{type:"reporter",category:"operators",spec:"%n  %n",alias:"-"},reportProduct:{type:"reporter",category:"operators",spec:"%n × %n",alias:"*"},reportQuotient:{type:"reporter",category:"operators",spec:"%n / %n"},reportRound:{type:"reporter",category:"operators",spec:"round %n"},reportMonadic:{type:"reporter",category:"operators",spec:"%fun of %n",defaults:[null,10]},reportPower:{type:"reporter",category:"operators",spec:"%n ^ %n"},reportModulus:{type:"reporter",category:"operators",spec:"%n mod %n"},reportRandom:{type:"reporter",category:"operators",spec:"pick random %n to %n",defaults:[1,10]},reportLessThan:{type:"predicate",category:"operators",spec:"%s < %s"},reportEquals:{type:"predicate",category:"operators",spec:"%s = %s"},reportGreaterThan:{type:"predicate",category:"operators",spec:"%s > %s"},reportAnd:{type:"predicate",category:"operators",spec:"%b and %b"},reportOr:{type:"predicate",category:"operators",spec:"%b or %b"},reportNot:{type:"predicate",category:"operators",spec:"not %b"},reportBoolean:{type:"predicate",category:"operators",spec:"%bool",alias:"true boolean"},reportFalse:{type:"predicate",category:"operators",spec:"%bool",defaults:[!1],alias:"false boolean"},reportJoinWords:{type:"reporter",category:"operators",spec:"join %words",defaults:[localize("hello")+" ",localize("world")]},reportLetter:{type:"reporter",category:"operators",spec:"letter %idx of %s",defaults:[1,localize("world")]},reportStringSize:{type:"reporter",category:"operators",spec:"length of %s",defaults:[localize("world")]},reportUnicode:{type:"reporter",category:"operators",spec:"unicode of %s",defaults:["a"]},reportUnicodeAsLetter:{type:"reporter",category:"operators",spec:"unicode %n as letter",defaults:[65]},reportIsA:{type:"predicate",category:"operators",spec:"is %s a %typ ?",defaults:[5]},reportIsIdentical:{type:"predicate",category:"operators",spec:"is %s identical to %s ?"},reportTextSplit:{type:"reporter",category:"operators",spec:"split %s by %delim",defaults:[localize("hello")+" "+localize("world")," "]},reportJSFunction:{type:"reporter",category:"operators",spec:"JavaScript function ( %mult%s ) { %code }"},reportTypeOf:{dev:!0,type:"reporter",category:"operators",spec:"type of %s",defaults:[5]},reportTextFunction:{dev:!0,type:"reporter",category:"operators",spec:"%txtfun of %s",defaults:[null,"Abelson & Sussman"]},reportCompiled:{type:"reporter",category:"operators",spec:"compile %repRing for %n args",defaults:[null,0]},doSetVar:{type:"command",category:"variables",spec:"set %var to %s",defaults:[null,0]},doChangeVar:{type:"command",category:"variables",spec:"change %var by %n",defaults:[null,1]},doShowVar:{type:"command",category:"variables",spec:"show variable %var"},doHideVar:{type:"command",category:"variables",spec:"hide variable %var"},doDeclareVariables:{type:"command",category:"other",spec:"script variables %scriptVars"},doDeleteAttr:{type:"command",category:"variables",spec:"inherit %shd"},reportNewList:{type:"reporter",category:"lists",spec:"list %exp"},reportCONS:{type:"reporter",category:"lists",spec:"%s in front of %l"},reportListItem:{type:"reporter",category:"lists",spec:"item %idx of %l",defaults:[1]},reportCDR:{type:"reporter",category:"lists",spec:"all but first of %l"},reportListLength:{type:"reporter",category:"lists",spec:"length of %l"},reportListContainsItem:{type:"predicate",category:"lists",spec:"%l contains %s",defaults:[null,localize("thing")]},reportListIsEmpty:{type:"predicate",category:"lists",spec:"is %l empty?"},doAddToList:{type:"command",category:"lists",spec:"add %s to %l",defaults:[localize("thing")]},doDeleteFromList:{type:"command",category:"lists",spec:"delete %ida of %l",defaults:[1]},doInsertInList:{type:"command",category:"lists",spec:"insert %s at %idx of %l",defaults:[localize("thing"),1]},doReplaceInList:{type:"command",category:"lists",spec:"replace item %idx of %l with %s",defaults:[1,null,localize("thing")]},reportNumbers:{type:"reporter",category:"lists",spec:"numbers from %n to %n",defaults:[1,10]},reportMap:{type:"reporter",category:"lists",spec:"map %repRing over %l"},reportAtomicMap:{dev:!0,type:"reporter",category:"lists",spec:"%blitz map %repRing over %l"},reportKeep:{type:"reporter",category:"lists",spec:"keep items %predRing from %l"},reportAtomicKeep:{dev:!0,type:"reporter",category:"lists",spec:"%blitz keep items %predRing from %l"},reportFindFirst:{type:"reporter",category:"lists",spec:"find first item %predRing in %l"},reportAtomicFindFirst:{dev:!0,type:"reporter",category:"lists",spec:"%blitz find first item %predRing in %l"},reportCombine:{type:"reporter",category:"lists",spec:"combine %l using %repRing"},reportAtomicCombine:{dev:!0,type:"reporter",category:"lists",spec:"%blitz combine %l using %repRing"},doForEach:{type:"command",category:"lists",spec:"for each %upvar in %l %cla",defaults:[localize("item")]},doShowTable:{dev:!0,type:"command",category:"lists",spec:"show table %l"},doMapCodeOrHeader:{type:"command",category:"other",spec:"map %cmdRing to %codeKind %code"},doMapValueCode:{type:"command",category:"other",spec:"map %mapValue to code %code",defaults:[["String"],"<#1>"]},doMapListCode:{type:"command",category:"other",spec:"map %codeListPart of %codeListKind to code %code"},reportMappedCode:{type:"reporter",category:"other",spec:"code of %cmdRing"},doSetVideoTransparency:{type:"command",category:"sensing",spec:"set video transparency to %n",defaults:[50]},reportVideo:{type:"reporter",category:"sensing",spec:"video %vid on %self",defaults:[["motion"],["myself"]]},evebrainMotorDriver:{only:Process,type:"command",category:"eBrain",spec:"%motor Motor %direction %s Steps ",defaults:["Left","Forward",100]},evebrainMotorDriverBoth:{only:Process,type:"command",category:"eBrain",spec:"Both Motors %directionboth %s Steps ",defaults:["Forward",100]},evebrainPlayNote:{only:Process,type:"command",category:"eBrain",spec:"Buzzer note %s for duration %s seconds (5)",defaults:[1,1]},evebrainGpio:{only:Process,type:"command",category:"eBrain",spec:"Pin Number %pin %onoff",defaults:[16,"gpio_on"]},evebrainGpio_read:{only:Process,type:"reporter",category:"eBrain",spec:"Analog 0 Read"},evebrainGpio_readAnalog:{only:Process,type:"reporter",category:"eBrain",spec:"External Analog %analogPin Read (SDA0 SCL2)",defaults:[1]},evebrainTemperature:{only:Process,type:"reporter",category:"eBrain",spec:"Temperature Read (16)"},evebrainHumidity:{only:Process,type:"reporter",category:"eBrain",spec:"Humidity Read (16)"},evebrainDigital_read:{only:Process,type:"reporter",category:"eBrain",spec:"Digital %pin Read",defaults:[4]},evebrainDistance_read:{only:Process,type:"reporter",category:"eBrain",spec:"Distance Sensor (Trig5 Echo4)"},evebrainGpio_pwm:{only:Process,type:"command",category:"eBrain",spec:"PWM Pin %pwmPin Level %n",defaults:["gpio_pwm_5",255]},evebrainServo:{only:Process,type:"command",category:"eBrain",spec:"Set Servo to %n degrees (10)",defaults:[90]},evebrainStop:{only:Process,type:"command",category:"eBrain",spec:"Stop"},mirobotForward:{only:Process,type:"command",category:"Robot",spec:"Move forward by %n mm",defaults:[100]},mirobotBack:{only:Process,type:"command",category:"Robot",spec:"Move back by %n mm",defaults:[100]},mirobotLeft:{only:Process,type:"command",category:"Robot",spec:"Turn %counterclockwise by %n degrees",defaults:[90]},mirobotRight:{only:Process,type:"command",category:"Robot",spec:"Turn %clockwise by %n degrees",defaults:[90]},mirobotStop:{only:Process,type:"command",category:"Robot",spec:"Stop"}}},SpriteMorph.prototype.initBlocks(),SpriteMorph.prototype.initBlockMigrations=function(){SpriteMorph.prototype.blockMigrations={doStopAll:{selector:"doStopThis",inputs:[["all"]]},doStop:{selector:"doStopThis",inputs:[["this script"]]},doStopBlock:{selector:"doStopThis",inputs:[["this block"]]},doStopOthers:{selector:"doStopThis",inputs:[["all"]],offset:0},receiveClick:{selector:"receiveInteraction",inputs:[["clicked"]]},reportTrue:{selector:"reportBoolean",inputs:[!0]},reportFalse:{selector:"reportBoolean",inputs:[!1]},reportCostumes:{selector:"reportGet",inputs:[["costumes"]]},reportSounds:{selector:"reportGet",inputs:[["sounds"]]},doMapStringCode:{selector:"doMapValueCode",inputs:[["String"],"<#1>"],offset:1},reportDistanceTo:{selector:"reportRelationTo",inputs:[["distance"]],offset:1},comeToFront:{selector:"goToLayer",inputs:[["front"]]},setHue:{selector:"setPenHSVA",inputs:[["hue"]],offset:1},setBrightness:{selector:"setPenHSVA",inputs:[["brightness"]],offset:1},changeHue:{selector:"changePenHSVA",inputs:[["hue"]],offset:1},changeBrightness:{selector:"changePenHSVA",inputs:[["brightness"]],offset:1},reportIsFastTracking:{selector:"reportGlobalFlag",inputs:[["turbo mode"]],offset:1},doSetFastTracking:{selector:"doSetGlobalFlag",inputs:[["turbo mode"]],offset:1}}},SpriteMorph.prototype.initBlockMigrations(),SpriteMorph.prototype.blockAlternatives={turn:["turnLeft"],turnLeft:["turn"],changeXPosition:["changeYPosition","setXPosition","setYPosition"],setXPosition:["setYPosition","changeXPosition","changeYPosition"],changeYPosition:["changeXPosition","setYPosition","setXPosition"],setYPosition:["setXPosition","changeYPosition","changeXPosition"],xPosition:["yPosition"],yPosition:["xPosition"],doSayFor:["doThinkFor","bubble","doThink","doAsk"],doThinkFor:["doSayFor","doThink","bubble","doAsk"],bubble:["doThink","doAsk","doSayFor","doThinkFor"],doThink:["bubble","doAsk","doSayFor","doThinkFor"],show:["hide"],hide:["show"],changeEffect:["setEffect"],setEffect:["changeEffect"],changeScale:["setScale"],setScale:["changeScale"],playSound:["doPlaySoundUntilDone","doPlaySoundAtRate"],doPlaySoundUntilDone:["playSound","doPlaySoundAtRate"],doPlaySoundAtRate:["playSound","doPlaySoundUntilDone"],doChangeTempo:["doSetTempo"],doSetTempo:["doChangeTempo"],setVolume:["changeVolume"],changeVolume:["setVolume"],setPan:["changePan"],changePan:["setPan"],getVolume:["getTempo","getPan"],getTempo:["getVolume","getPan"],getPan:["getVolume","getTempo"],clear:["down","up","doStamp"],down:["up","clear","doStamp"],up:["down","clear","doStamp"],doStamp:["clear","down","up"],setPenHSVA:["changePenHSVA"],changePenHSVA:["setPenHSVA"],setBackgroundHSVA:["changeBackgroundHSVA"],changeBackgroundHSVA:["setBackgroundHSVA"],changeSize:["setSize"],setSize:["changeSize"],doBroadcast:["doBroadcastAndWait"],doBroadcastAndWait:["doBroadcast"],doIf:["doIfElse","doUntil"],doIfElse:["doIf","doUntil"],doRepeat:["doUntil"],doUntil:["doRepeat","doIf"],doAsk:["bubble","doThink","doSayFor","doThinkFor"],getLastAnswer:["getTimer"],getTimer:["getLastAnswer"],reportMouseX:["reportMouseY"],reportMouseY:["reportMouseX"],reportSum:["reportDifference","reportProduct","reportQuotient","reportPower","reportModulus"],reportDifference:["reportSum","reportProduct","reportQuotient","reportPower","reportModulus"],reportProduct:["reportDifference","reportSum","reportQuotient","reportPower","reportModulus"],reportQuotient:["reportDifference","reportProduct","reportSum","reportPower","reportModulus"],reportPower:["reportDifference","reportProduct","reportSum","reportQuotient","reportModulus"],reportModulus:["reportDifference","reportProduct","reportSum","reportQuotient","reportPower"],reportLessThan:["reportEquals","reportGreaterThan"],reportEquals:["reportLessThan","reportGreaterThan"],reportGreaterThan:["reportEquals","reportLessThan"],reportAnd:["reportOr"],reportOr:["reportAnd"],doSetVar:["doChangeVar"],doChangeVar:["doSetVar"],doShowVar:["doHideVar"],doHideVar:["doShowVar"],reportMap:["reportKeep","reportFindFirst"],reportKeep:["reportFindFirst","reportMap"],reportFindFirst:["reportKeep","reportMap"]},SpriteMorph.prototype.init=function(t){this.name=localize("Sprite"),this.variables=new VariableFrame(t||null,this),this.scripts=new ScriptsMorph,this.customBlocks=[],this.costumes=new List,this.costumes.type="costume",this.costume=null,this.sounds=new List,this.sounds.type="sound",this.normalExtent=new Point(60,60),this.scale=1,this.rotationStyle=1,this.instrument=null,this.version=Date.now(),this.isTemporary=!1,this.isCorpse=!1,this.cloneOriginName="",this.volume=100,this.gainNode=null,this.pan=0,this.pannerNode=null,this.freqPlayer=null,this.cachedHSV=[0,0,0],this.inheritedMethodsCache=[],this.parts=[],this.anchor=null,this.nestingScale=1,this.rotatesWithAnchor=!0,this.layers=null,this.blocksCache={},this.paletteCache={},this.rotationOffset=new Point,this.idx=0,this.wasWarped=!1,this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0},this.exemplar=null,this.instances=[],this.cachedPropagation=!1,this.inheritedAttributes=[],this.imageData={},this.motionAmount=0,this.motionDirection=0,this.frameNumber=0,SpriteMorph.uber.init.call(this),this.cachedHSV=this.color.hsv(),this.isDraggable=!0,this.isDown=!1,this.heading=90,this.changed(),this.drawNew(),this.changed()},SpriteMorph.prototype.fullCopy=function(o){var e,t,r=SpriteMorph.uber.fullCopy.call(this),i=this,s=[];for(t in r.instances=[],r.stopTalking(),r.color=this.color.copy(),r.gainNode=null,r.pannerNode=null,r.freqPlayer=null,r.blocksCache={},r.paletteCache={},r.imageData={},r.cachedHSV=r.color.hsv(),s=[],this.inheritedAttributes.forEach(function(t){s.push(t)}),r.inheritedAttributes=s,o?(r.exemplar=this,r.customBlocks=[],r.variables=new VariableFrame(null,r),r.variables.parentFrame=this.variables,r.inheritedVariableNames().forEach(function(t){r.shadowVar(t,r.variables.getVar(t))}),this.addSpecimen(r),this.cachedPropagation=!1,["scripts","costumes","sounds"].forEach(function(t){contains(r.inheritedAttributes,t)||r.inheritedAttributes.push(t)})):(r.variables=this.variables.copy(),(r.variables.owner=r).scripts=this.scripts.fullCopy(),r.customBlocks=[],this.customBlocks.forEach(function(t){e=t.copyAndBindTo(r),r.customBlocks.push(e),r.allBlockInstances(t).forEach(function(t){t.definition=e})}),s=[],this.costumes.asArray().forEach(function(t){var e=o?t:t.copy();s.push(e),t===i.costume&&(r.costume=e)}),r.costumes=new List(s),s=[],this.sounds.asArray().forEach(function(t){var e=o?t:t.copy();s.push(e)}),r.sounds=new List(s),s=[]),r.nestingScale=1,r.rotatesWithAnchor=!0,r.anchor=null,r.parts=[],this.parts.forEach(function(t){var e=t.fullCopy(o);e.nestingScale=t.nestingScale,e.rotatesWithAnchor=t.rotatesWithAnchor,r.attachPart(e)}),r.graphicsValues={},this.graphicsValues)this.graphicsValues.hasOwnProperty(t)&&(r.graphicsValues[t]=this.graphicsValues[t]);return r},SpriteMorph.prototype.appearIn=function(e){this.isTemporary||(this.name=e.newSpriteName(this.name),e.corral.addSprite(this),e.sprites.add(this)),e.stage.add(this),this.parts.forEach(function(t){t.appearIn(e)})},SpriteMorph.prototype.setName=function(t){this.name=t||this.name,this.version=Date.now()},SpriteMorph.prototype.drawNew=function(){var t,e,o,r,i,s,n,a,p,h,c,l,u,d,g=this,y=[];if(this.isWarped)this.wantsRedraw=!0;else{if(t=this.center(),r=this.costume&&"function"==typeof this.costume.loaded,n=this.parent instanceof StageMorph?this.parent.scale:1,e=this.rotationStyle?this.heading:90,2===this.rotationStyle&&(e=90,(180<this.heading&&this.heading<360||this.heading<0&&-180<this.heading)&&(o=!0)),this.costume&&!r)y=(s=o?this.costume.flipped():this.costume).bounds().corners().map(function(t){return t.rotateBy(radians(e-90),g.costume.center())}),p=y[0],c=y[0],y.forEach(function(t){p=p.min(t),c=c.max(t)}),l=p.corner(c).extent().multiplyBy(this.scale*n),h=new Point(0,0).rotateBy(radians(-(e-90)),s.center()).subtract(p),this.image=newCanvas(l,!0),this.silentSetExtent(l),(u=this.image.getContext("2d")).scale(this.scale*n,this.scale*n),u.translate(h.x,h.y),u.rotate(radians(e-90)),u.drawImage(s.contents,0,0),this.image=this.applyGraphicsEffects(this.image),this.setCenter(t,!0),this.rotationOffset=h.translateBy(s.rotationCenter).rotateBy(radians(-(e-90)),h).scaleBy(this.scale*n);else if(e=o?-90:e,a=Math.min(Math.max(this.normalExtent.x*this.scale*n,5),1e3),this.silentSetExtent(new Point(a,a)),this.image=newCanvas(this.extent(),!0),this.setCenter(t,!0),SpriteMorph.uber.drawNew.call(this,e),this.rotationOffset=this.extent().divideBy(2),this.image=this.applyGraphicsEffects(this.image),r)return i=this.costume,d=setInterval(function(){g.wearCostume(i),clearInterval(d)},100),g.wearCostume(null);this.version=Date.now()}},SpriteMorph.prototype.endWarp=function(){var t,e;this.isWarped=!1,this.wantsRedraw&&(t=this.xPosition(),e=this.yPosition(),this.drawNew(),this.silentGotoXY(t,e,!0),this.wantsRedraw=!1),this.parent.changed()},SpriteMorph.prototype.rotationCenter=function(){return this.position().add(this.rotationOffset)},SpriteMorph.prototype.colorFiltered=function(t,e){var o,r,i,s,n=new Morph,a=this.extent(),p=normalizeCanvas(this.image,!0).getContext("2d").getImageData(0,0,a.x,a.y);for(n.image=newCanvas(a,!0),n.bounds=this.bounds.copy(),s=(o=n.image.getContext("2d")).createImageData(a.x,a.y),i=0;i<a.x*a.y*4;i+=4)r=new Color(p.data[i],p.data[i+1],p.data[i+2]),(e&&r.isCloseTo(t,!1,e)||r.eq(t))&&(s.data[i]=p.data[i],s.data[i+1]=p.data[i+1],s.data[i+2]=p.data[i+2],s.data[i+3]=255);return o.putImageData(s,0,0),n},SpriteMorph.prototype.getImageData=function(){var t,e,o,r,i;return this.version!==this.imageData.version&&(t=this.parentThatIsA(StageMorph),e=this.extent(),o={x:Math.floor(e.x/t.scale),y:Math.floor(e.y/t.scale)},(r=newCanvas(o,!0)).getContext("2d").drawImage(this.image,0,0,Math.floor(e.x),Math.floor(e.y),0,0,o.x,o.y),i=r.getContext("2d").getImageData(0,0,o.x,o.y).data,this.imageData={version:this.version,pixels:new Uint32Array(i.buffer.slice(0))}),this.imageData.pixels},SpriteMorph.prototype.projectionSnap=function(){var t,e,o,r=this.parentThatIsA(StageMorph),i=this.center().subtract(r.position()).divideBy(r.scale),s=this.costume||this.image;return s instanceof Costume&&(s=s.contents),t=new Point(Math.floor(i.x-s.width/2),Math.floor(i.y-s.height/2)),(o=(e=newCanvas(new Point(s.width,s.height),!0)).getContext("2d")).drawImage(s,0,0),o.globalCompositeOperation="source-in",o.drawImage(r.projectionLayer(),-t.x,-t.y),new Costume(e,this.newCostumeName(localize("snap")))},SpriteMorph.prototype.blockForSelector=function(t,e){var o,r,i,s,n=this.blockMigrations[t],a=this.blocks[n?n.selector:t];if(!a)return null;if((o="command"===a.type?new CommandBlockMorph:"hat"===a.type?new HatBlockMorph:"ring"===a.type?new RingMorph:new ReporterBlockMorph("predicate"===a.type)).color=this.blockColor[a.category],o.category=a.category,o.selector=n?n.selector:t,contains(["reifyReporter","reifyPredicate"],o.selector)&&(o.isStatic=!0),o.setSpec(localize(a.spec)),e&&a.defaults||n&&n.inputs)if(r=n?n.inputs:a.defaults,o.defaults=r,(i=o.inputs())[0]instanceof MultiArgMorph)i[0].setContents(r),i[0].defaults=r;else for(s=0;s<r.length;s+=1)null!==r[s]&&i[s].setContents(r[s]);return o},SpriteMorph.prototype.variableBlock=function(t,e){var o=new ReporterBlockMorph(!1);return o.selector="reportGetVar",o.color=this.blockColor.variables,o.category="variables",o.isLocalVarTemplate=e,o.setSpec(t),o.isDraggable=!0,o},SpriteMorph.prototype.blockTemplates=function(t){var e,o,r,i=[],s=this,n=t||"motion",a=this.inheritedVariableNames();function p(t,e){if(StageMorph.prototype.hiddenPrimitives[t])return null;var o=SpriteMorph.prototype.blockForSelector(t,!0);return o.isTemplate=!0,e&&o.ghost(),o}function h(t,e){var o=SpriteMorph.prototype.variableBlock(t,e);return o.isDraggable=!1,o.isTemplate=!0,contains(a,t)&&o.ghost(),o}function c(t){if(StageMorph.prototype.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blocks[t];return new ToggleMorph("checkbox",this,function(){s.toggleWatcher(t,localize(e.spec),s.blockColor[e.category])},null,function(){return s.showingWatcher(t)},null)}function l(t){return new ToggleMorph("checkbox",this,function(){s.toggleVariableWatcher(t)},null,function(){return s.showingVariableWatcher(t)},null)}function u(){var t=new MenuMorph(this);return t.addItem("help...","showHelp"),t}function d(t){var e;t&&(s.isVariableNameInUse(t[0],t[1])?s.inform("that name is already in use"):(e=s.parentThatIsA(IDE_Morph),s.addVariable(t[0],t[1]),s.showingVariableWatcher(t[0])||s.toggleVariableWatcher(t[0],t[1]),e.flushBlocksCache("variables"),e.refreshPalette()))}return"motion"===n?(i.push(p("forward")),i.push(p("turn")),i.push(p("turnLeft")),i.push("-"),i.push(p("setHeading")),i.push(p("doFaceTowards")),i.push("-"),i.push(p("gotoXY")),i.push(p("doGotoObject")),i.push(p("doGlide")),i.push("-"),i.push(p("changeXPosition")),i.push(p("setXPosition")),i.push(p("changeYPosition")),i.push(p("setYPosition")),i.push("-"),i.push(p("bounceOffEdge")),i.push("-"),i.push(c("xPosition")),i.push(p("xPosition",this.inheritsAttribute("x position"))),i.push(c("yPosition")),i.push(p("yPosition",this.inheritsAttribute("y position"))),i.push(c("direction")),i.push(p("direction",this.inheritsAttribute("direction"))),i.push("="),i.push(this.makeBlockButton(n))):"looks"===n?(i.push(p("doSwitchToCostume")),i.push(p("doWearNextCostume")),i.push(c("getCostumeIdx")),i.push(p("getCostumeIdx",this.inheritsAttribute("costume #"))),i.push("-"),i.push(p("doSayFor")),i.push(p("bubble")),i.push(p("doThinkFor")),i.push(p("doThink")),i.push("-"),i.push(p("reportGetImageAttribute")),i.push(p("reportNewCostumeStretched")),i.push("-"),i.push(p("changeEffect")),i.push(p("setEffect")),i.push(p("clearEffects")),i.push(p("getEffect")),i.push("-"),i.push(p("changeScale")),i.push(p("setScale")),i.push(c("getScale")),i.push(p("getScale",this.inheritsAttribute("size"))),i.push("-"),i.push(p("show")),i.push(p("hide")),i.push(c("reportShown")),i.push(p("reportShown",this.inheritsAttribute("shown?"))),i.push("-"),i.push(p("goToLayer")),i.push(p("goBack")),this.world().isDevMode&&(i.push("-"),(r=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,r.setColor(this.paletteTextColor),i.push(r),i.push("-"),i.push(p("log")),i.push(p("alert")),i.push("-"),i.push(p("doScreenshot"))),i.push("="),i.push(this.makeBlockButton(n))):"sound"===n?(i.push(p("playSound")),i.push(p("doPlaySoundUntilDone")),i.push(p("doStopAllSounds")),i.push("-"),i.push(p("doPlaySoundAtRate")),i.push(p("reportGetSoundAttribute")),i.push("-"),i.push(p("doRest")),i.push(p("doPlayNote")),i.push(p("doSetInstrument")),i.push("-"),i.push(p("doChangeTempo")),i.push(p("doSetTempo")),i.push(c("getTempo")),i.push(p("getTempo")),i.push("-"),i.push(p("changeVolume")),i.push(p("setVolume")),i.push(c("getVolume")),i.push(p("getVolume",this.inheritsAttribute("volume"))),i.push("-"),i.push(p("changePan")),i.push(p("setPan")),i.push(c("getPan")),i.push(p("getPan",this.inheritsAttribute("balance"))),i.push("-"),i.push(p("playFreq")),i.push(p("stopFreq")),this.world().isDevMode&&(i.push("-"),(r=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,r.setColor(this.paletteTextColor),i.push(r),i.push("-"),i.push(p("doPlayFrequency"))),i.push("="),i.push(this.makeBlockButton(n))):"pen"===n?(i.push(p("clear")),i.push("-"),i.push(p("down")),i.push(p("up")),i.push(c("getPenDown")),i.push(p("getPenDown",this.inheritsAttribute("pen down?"))),i.push("-"),i.push(p("setColor")),i.push(p("changePenHSVA")),i.push(p("setPenHSVA")),i.push(p("getPenAttribute")),i.push("-"),i.push(p("changeSize")),i.push(p("setSize")),i.push("-"),i.push(p("doStamp")),i.push(p("floodFill")),i.push(p("write")),i.push("-"),i.push(p("reportPenTrailsAsCostume")),i.push("="),i.push(this.makeBlockButton(n))):"control"===n?(i.push(p("receiveGo")),i.push(p("receiveKey")),i.push(p("receiveInteraction")),i.push(p("receiveCondition")),i.push(p("receiveMessage")),i.push("-"),i.push(p("doBroadcast")),i.push(p("doBroadcastAndWait")),i.push(c("getLastMessage")),i.push(p("getLastMessage")),i.push("-"),i.push(p("doWarp")),i.push("-"),i.push(p("doWait")),i.push(p("doWaitUntil")),i.push("-"),i.push(p("doForever")),i.push(p("doRepeat")),i.push(p("doUntil")),i.push(p("doFor")),i.push("-"),i.push(p("doIf")),i.push(p("doIfElse")),i.push(p("reportIfElse")),i.push("-"),i.push(p("doReport")),i.push(p("doStopThis")),i.push("-"),i.push(p("doRun")),i.push(p("fork")),i.push(p("evaluate")),i.push("-"),i.push(p("doTellTo")),i.push(p("reportAskFor")),i.push("-"),i.push(p("doCallCC")),i.push(p("reportCallCC")),i.push("-"),i.push(p("receiveOnClone")),i.push(p("createClone")),i.push(p("newClone")),i.push(p("removeClone")),i.push("-"),i.push(p("doPauseAll")),i.push("="),i.push(this.makeBlockButton(n))):"sensing"===n?(i.push(p("reportTouchingObject")),i.push(p("reportTouchingColor")),i.push(p("reportColorIsTouchingColor")),i.push("-"),i.push(p("doAsk")),i.push(c("getLastAnswer")),i.push(p("getLastAnswer")),i.push("-"),i.push(c("reportMouseX")),i.push(p("reportMouseX")),i.push(c("reportMouseY")),i.push(p("reportMouseY")),i.push(p("reportMouseDown")),i.push("-"),i.push(p("reportKeyPressed")),i.push("-"),i.push(p("reportRelationTo")),i.push(p("reportAspect")),i.push("-"),i.push(p("doResetTimer")),i.push(c("getTimer")),i.push(p("getTimer")),i.push("-"),i.push(p("reportAttributeOf")),SpriteMorph.prototype.enableFirstClass&&i.push(p("reportGet")),i.push(p("reportObject")),i.push("-"),i.push(p("reportURL")),i.push(p("reportAudio")),i.push(p("reportVideo")),i.push(p("doSetVideoTransparency")),i.push("-"),i.push(p("reportGlobalFlag")),i.push(p("doSetGlobalFlag")),i.push("-"),i.push(p("reportDate")),this.world().isDevMode&&(i.push("-"),(r=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,r.setColor(this.paletteTextColor),i.push(r),i.push("-"),i.push(c("reportThreadCount")),i.push(p("reportThreadCount")),i.push(p("colorFiltered")),i.push(p("reportFuzzyTouchingColor")),i.push(p("reportFuzzyColorIsTouchingColor")),i.push(p("reportStackSize")),i.push(p("reportFrameCount"))),i.push("="),i.push(this.makeBlockButton(n))):"operators"===n?(i.push(p("reifyScript")),i.push(p("reifyReporter")),i.push(p("reifyPredicate")),i.push("#"),i.push("-"),i.push(p("reportSum")),i.push(p("reportDifference")),i.push(p("reportProduct")),i.push(p("reportQuotient")),i.push(p("reportPower")),i.push("-"),i.push(p("reportModulus")),i.push(p("reportRound")),i.push(p("reportMonadic")),i.push(p("reportRandom")),i.push("-"),i.push(p("reportLessThan")),i.push(p("reportEquals")),i.push(p("reportGreaterThan")),i.push("-"),i.push(p("reportAnd")),i.push(p("reportOr")),i.push(p("reportNot")),i.push(p("reportBoolean")),i.push("-"),i.push(p("reportJoinWords")),i.push(p("reportTextSplit")),i.push(p("reportLetter")),i.push(p("reportStringSize")),i.push("-"),i.push(p("reportUnicode")),i.push(p("reportUnicodeAsLetter")),i.push("-"),i.push(p("reportIsA")),i.push(p("reportIsIdentical")),i.push("-"),i.push(p("reportJSFunction")),Process.prototype.enableCompiling&&i.push(p("reportCompiled")),this.world().isDevMode&&(i.push("-"),(r=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,r.setColor(this.paletteTextColor),i.push(r),i.push("-"),i.push(p("reportTypeOf")),i.push(p("reportTextFunction"))),i.push("="),i.push(this.makeBlockButton(n))):"variables"===n?((o=new PushButtonMorph(null,function(){new VariableDialogMorph(null,d,s).prompt("Variable name",null,s.world())},"Make a variable")).userMenu=u,o.selector="addVariable",o.showHelp=BlockMorph.prototype.showHelp,i.push(o),0<this.deletableVariableNames().length&&((o=new PushButtonMorph(null,function(){var e=new MenuMorph(s.deleteVariable,null,s);s.deletableVariableNames().forEach(function(t){e.addItem(t,t)}),e.popUpAtHand(s.world())},"Delete a variable")).userMenu=u,o.selector="deleteVariable",o.showHelp=BlockMorph.prototype.showHelp,i.push(o)),i.push("-"),0<(e=this.reachableGlobalVariableNames(!0)).length&&(e.forEach(function(t){i.push(l(t)),i.push(h(t))}),i.push("-")),0<(e=this.allLocalVariableNames(!0)).length&&(e.forEach(function(t){i.push(l(t)),i.push(h(t,!0))}),i.push("-")),i.push(p("doSetVar")),i.push(p("doChangeVar")),i.push(p("doShowVar")),i.push(p("doHideVar")),i.push(p("doDeclareVariables")),StageMorph.prototype.enableInheritance&&(i.push("-"),i.push(p("doDeleteAttr"))),i.push("="),i.push(p("reportNewList")),i.push(p("reportNumbers")),i.push("-"),i.push(p("reportCONS")),i.push(p("reportListItem")),i.push(p("reportCDR")),i.push("-"),i.push(p("reportListLength")),i.push(p("reportListContainsItem")),i.push(p("reportListIsEmpty")),i.push("-"),i.push(p("reportMap")),i.push(p("reportKeep")),i.push(p("reportFindFirst")),i.push(p("reportCombine")),i.push("-"),i.push(p("doForEach")),i.push("-"),i.push(p("doAddToList")),i.push(p("doDeleteFromList")),i.push(p("doInsertInList")),i.push(p("doReplaceInList")),this.world().isDevMode&&(i.push("-"),(r=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,r.setColor(this.paletteTextColor),i.push(r),i.push("-"),i.push(p("doShowTable"))),i.push("="),StageMorph.prototype.enableCodeMapping&&(i.push(p("doMapCodeOrHeader")),i.push(p("doMapValueCode")),i.push(p("doMapListCode")),i.push("-"),i.push(p("reportMappedCode")),i.push("=")),i.push(this.makeBlockButton())):"eBrain"===n?(i.push(p("evebrainGpio")),i.push(p("evebrainDigital_read")),i.push("-"),i.push("-"),i.push(p("evebrainMotorDriver")),i.push(p("evebrainMotorDriverBoth")),i.push("-"),i.push("-"),i.push(p("evebrainGpio_pwm")),i.push(p("evebrainGpio_read")),i.push("-"),i.push("-"),i.push("-"),i.push("-"),i.push(p("evebrainDistance_read")),i.push(p("evebrainPlayNote")),i.push(p("evebrainServo")),i.push(p("evebrainTemperature")),i.push(p("evebrainHumidity")),i.push(p("evebrainGpio_readAnalog"))):"Robot"===n&&(i.push(p("mirobotForward")),i.push(p("mirobotBack")),i.push(p("mirobotLeft")),i.push(p("mirobotRight")),i.push(p("mirobotStop"))),i},SpriteMorph.prototype.makeBlockButton=function(t){var e=new PushButtonMorph(this,"makeBlock","Make a block");return e.userMenu=function(){var t=new MenuMorph(this);return t.addItem("help...","showHelp"),t},e.selector="addCustomBlock",e.showHelp=BlockMorph.prototype.showHelp,e},SpriteMorph.prototype.makeBlock=function(){var e=this.parentThatIsA(IDE_Morph),o=this.parentThatIsA(StageMorph),t=e.currentCategory,r=SpriteMorph.prototype.blockColor[t],i=this,s=new BlockDialogMorph(null,function(t){""!==t.spec&&(t.isGlobal?o.globalBlocks.push(t):i.customBlocks.push(t),e.flushPaletteCache(),e.refreshPalette(),new BlockEditorMorph(t,i).popUp())},i);"variables"!==t&&(s.category=t,s.categories.children.forEach(function(t){t.refresh()}),s.types.children.forEach(function(t){t.setColor(r),t.refresh()})),s.prompt("Make a block",null,i.world())},SpriteMorph.prototype.palette=function(t){return this.paletteCache[t]||(this.paletteCache[t]=this.freshPalette(t)),this.paletteCache[t]},SpriteMorph.prototype.freshPalette=function(s){var t,e,o,n=new ScrollFrameMorph(null,null,this.sliderColor),r=SyntaxElementMorph.prototype.fontSize,i=0,a=5,p=0,h=!1,c=this,l=this.parentThatIsA(StageMorph),u=Morph.prototype.trackChanges,d=new Color(140,140,140);return Morph.prototype.trackChanges=!1,n.owner=this,n.padding=r/2,n.color=this.paletteColor,n.growth=new Point(0,MorphicPreferences.scrollBarSize),n.toolBar=new AlignmentMorph("column"),(e=new PushButtonMorph(this,"searchBlocks",new SymbolMorph("magnifierOutline",16))).alpha=.2,e.padding=1,e.hint=localize("find blocks")+"...",e.labelShadowColor=d,e.drawNew(),e.fixLayout(),n.toolBar.add(e),(o=new PushButtonMorph(this,"makeBlock",new SymbolMorph("cross",16))).alpha=.2,o.padding=1,o.hint=localize("Make a block")+"...",o.labelShadowColor=d,o.drawNew(),o.fixLayout(),n.toolBar.add(o),n.toolBar.fixLayout(),n.add(n.toolBar),n.userMenu=function(){var e,t,o=new MenuMorph,r=this.parentThatIsA(IDE_Morph),i={operators:["reifyScript","reifyReporter","reifyPredicate"],control:["doWarp"],variables:["doDeclareVariables","reportNewList","reportNumbers","reportCONS","reportListItem","reportCDR","reportListLength","reportListContainsItem","reportListIsEmpty","doForEach","reportMap","reportKeep","reportFindFirst","reportCombine","doAddToList","doDeleteFromList","doInsertInList","doReplaceInList"]};return o.addPair([new SymbolMorph("magnifyingGlass",MorphicPreferences.menuFontSize),localize("find blocks")+"..."],function(){c.searchBlocks()},"^F"),n.contents.children.some(function(t){return contains(Object.keys(SpriteMorph.prototype.blocks),t.selector)})&&o.addItem("hide primitives",function(){var e=SpriteMorph.prototype.blocks;Object.keys(e).forEach(function(t){e[t].category===s&&(StageMorph.prototype.hiddenPrimitives[t]=!0)}),(i[s]||[]).forEach(function(t){StageMorph.prototype.hiddenPrimitives[t]=!0}),r.flushBlocksCache(s),r.refreshPalette()}),e=SpriteMorph.prototype.blocks,t=StageMorph.prototype.hiddenPrimitives,Object.keys(t).some(function(t){return!isNil(e[t])&&(e[t].category===s||contains(i[s]||[],t))})&&o.addItem("show primitives",function(){var t=StageMorph.prototype.hiddenPrimitives,e=SpriteMorph.prototype.blocks;Object.keys(t).forEach(function(t){e[t]&&e[t].category===s&&delete StageMorph.prototype.hiddenPrimitives[t]}),(i[s]||[]).forEach(function(t){delete StageMorph.prototype.hiddenPrimitives[t]}),r.flushBlocksCache(s),r.refreshPalette()}),o},(t=this.blocksCache[s])||(t=this.blockTemplates(s),this.isCachingPrimitives&&(this.blocksCache[s]=t)),t.forEach(function(t){if(null!==t)if("-"===t){if(h)return;a+=.8*r,h=!0}else if("="===t){if(h)return;a+=1.6*r,h=!0}else"#"===t?(i=0,a=p):(h=!1,0===i&&(a+=.3*r),t.setPosition(new Point(i,a)),n.addContents(t),t instanceof ToggleMorph||t instanceof RingMorph?(i=t.right()+r/2,p=t.bottom()):(i=0,a+=t.height()))}),l&&(a+=1.6*r,l.globalBlocks.forEach(function(t){var e;(t.category===s||"variables"===s&&contains(["lists","other"],t.category))&&(e=t.templateInstance(),a+=.3*r,e.setPosition(new Point(i,a)),n.addContents(e),i=0,a+=e.height())})),a+=1.6*r,this.customBlocks.forEach(function(t){var e;(t.category===s||"variables"===s&&contains(["lists","other"],t.category))&&(e=t.templateInstance(),a+=.3*r,e.setPosition(new Point(i,a)),n.addContents(e),i=0,a+=e.height())}),this.exemplar&&this.inheritedBlocks(!0).forEach(function(t){var e;(t.category===s||"variables"===s&&contains(["lists","other"],t.category))&&(e=t.templateInstance(),a+=.3*r,e.setPosition(new Point(i,a)),n.addContents(e),e.ghost(),i=0,a+=e.height())}),n.scrollX(n.padding),n.scrollY(n.padding),Morph.prototype.trackChanges=u,n},SpriteMorph.prototype.blocksMatching=function(t,s,n,e){var a,o,p=[],h=this,c=t.toLowerCase(),r=this.parentThatIsA(StageMorph);function l(t){return BlockMorph.prototype.parseSpec(t).filter(function(t){return 0!==t.indexOf("%")}).join(" ")}function u(t,e){var o,r=" "+t,i=r.indexOf(e);return-1===i?-1:(o=" "===r.charAt(i-1),s&&!o?-1:(o?"1":"2")+function(t,e,o){for(var r=String(t);r.length<e;)r=o+r;return r}(i,4,"0"))}return n&&n.length||(n=["hat","command","reporter","predicate","ring"]),(e=e||[]).forEach(function(t){var e=u(l(t.toLowerCase()),c);-1!==e&&p.push([h.variableBlock(t),e+"1"])}),[this.customBlocks,r.globalBlocks].forEach(function(t){t.forEach(function(t){var e;!contains(n,t.type)||-1!==(e=u(l(t.localizedSpec().toLowerCase()),c))&&p.push([t.templateInstance(),e+"2"])})}),a=SpriteMorph.prototype.blocks,Object.keys(a).forEach(function(t){var e,o,r,i;!StageMorph.prototype.hiddenPrimitives[t]&&contains(n,a[t].type)&&(e=a[t],-1===(o=u(l(localize(e.alias||e.spec).toLowerCase()),c))||e.dev||e.only&&e.only!==h.constructor||p.push([(r=t,(i=SpriteMorph.prototype.blockForSelector(r,!0)).isTemplate=!0,i),o+"3"]))}),contains(n,"reporter")&&(o=this.reporterize(t))&&p.push([o,""]),p.sort(function(t,e){return t[1]<e[1]?-1:1}),p.map(function(t){return t[0]})},SpriteMorph.prototype.searchBlocks=function(t,r,i,s){var n,e,a=this,p=SyntaxElementMorph.prototype.fontSize,o=this.parentThatIsA(IDE_Morph),h="",c=new InputFieldMorph(t||""),l=o.createPalette("forSearch"),u=[];function d(){e&&e.destroy(),n&&s&&(e=n.outline(MorphicPreferences.isFlat?new Color(150,200,255):new Color(255,255,255),2),l.contents.add(e),e.scrollIntoView())}function g(t){var e=Morph.prototype.trackChanges,o=l.contents.left()+5,r=c.bottom()+p;n=null,(u=t).length&&s&&(n=t[0]),Morph.prototype.trackChanges=!1,l.contents.children=[l.contents.children[0]],t.forEach(function(t){t.setPosition(new Point(o,r)),l.addContents(t),r+=t.height(),r+=.3*p}),Morph.prototype.trackChanges=e,d(),l.changed()}l.owner=this,l.color=a.paletteColor,l.contents.color=a.paletteColor,l.addContents(c),c.drawNew(),c.setWidth(o.logo.width()-30),c.contrast=90,c.setPosition(l.contents.topLeft().add(new Point(10,10))),c.drawNew(),l.accept=function(){var t;s?(c.cancel(),n&&s.insertBlock(n)):0<(t=c.getValue()).length&&g(a.blocksMatching(t))},l.reactToKeystroke=function(t){var e,o;switch(t?t.keyCode:0){case 38:if(!s||!n)return;return(o=u.indexOf(n)-1)<0&&(o=u.length-1),n=u[o],void d();case 40:if(!s||!n)return;return(o=u.indexOf(n)+1)>=u.length&&(o=0),n=u[o],void d();default:(e=c.getValue())!==h&&(h=e,g(a.blocksMatching(e,e.length<2,r,i)))}},c.cancel=function(){o.refreshPalette(),o.palette.adjustScrollBars()},o.fixLayout("refreshPalette"),c.edit(),t&&l.reactToKeystroke()},SpriteMorph.prototype.reporterize=function(t){var e;if(100<t.length)return null;try{return(e=function t(o,e,r){var i,s=["",""],n=0;function a(t){return t instanceof Array||isNaN(+t)?t:+t}function p(){for(var t=1,e="";n<o.length;){switch(i=o[n],n+=1,i){case"(":t+=1;break;case")":if(!--t)return e}e+=i}}for(;n<o.length;)switch(i=o[n],n+=1,i){case" ":break;case"(":s[e?1:0].length?s[e?1:0]=[s[e?1:0],t(p())]:s[e?1:0]=t(p());break;case"-":case"+":case"*":case"/":case"%":case"=":case"<":case">":case"&":case"|":if(e||s[0].length)if(e){if(s[1].length)return t(o.slice(n),i,[e,r,a(s[1])]);s[1]=i}else e=i,r=a(s[0]);else s[0]=i;break;default:s[e?1:0]+=i}return e?[e,r,a(s[1])]:a(s[0])}(t))instanceof Array?function t(e){var o,r,i,s,n,a=1,p={},h={"+":"reportSum","-":"reportDifference","*":"reportProduct","/":"reportQuotient","%":"reportModulus","^":"reportPower","=":"reportEquals","<":"reportLessThan",">":"reportGreaterThan","&":"reportAnd","|":"reportOr",round:"reportRound",not:"reportNot"},c=["abs","ceiling","floor","sqrt","sin","cos","tan","asin","acos","atan","ln","log","round","not"],l={ceil:"ceiling","!":"not"};for(c.concat(["true","false"]).forEach(function(t){p[localize(t).toLowerCase()]=t}),r=l[e[0]]||p[e[0].toLowerCase()]||e[0],contains(c,r)?(i=h[r])?n=(o=SpriteMorph.prototype.blockForSelector(i)).inputs():((n=(o=SpriteMorph.prototype.blockForSelector("reportMonadic")).inputs())[0].setContents([r]),a=0):n=(o=SpriteMorph.prototype.blockForSelector(h[r])).inputs(),s=1;s<e.length;s+=1)e[s]instanceof Array?o.silentReplaceInput(n[s-a],t(e[s])):isString(e[s])?contains(["true","false"],p[e[s]]||e[s])?o.silentReplaceInput(n[s-a],SpriteMorph.prototype.blockForSelector("true"===(p[e[s]]||e[s])?"reportTrue":"reportFalse")):"_"!==e[s]&&o.silentReplaceInput(n[s-a],SpriteMorph.prototype.variableBlock(e[s])):n[s-a].setContents(e[s]);return o.isDraggable=!0,o.fixLayout(),o.fixBlockColor(null,!0),o}(e):null}catch(t){return null}},SpriteMorph.prototype.addVariable=function(t,e){var o=this.parentThatIsA(IDE_Morph);e?(this.globalVariables().addVar(t),o&&o.flushBlocksCache("variables")):(this.variables.addVar(t),this.blocksCache.variables=null)},SpriteMorph.prototype.deleteVariable=function(t){var e=this.parentThatIsA(IDE_Morph);contains(this.inheritedVariableNames(!0),t)||this.deleteVariableWatcher(t),this.variables.deleteVar(t),e&&(e.flushBlocksCache("variables"),e.refreshPalette())},SpriteMorph.prototype.addCostume=function(t){t.name||(t.name="costume"+(this.costumes.length()+1)),this.shadowAttribute("costumes"),this.costumes.add(t)},SpriteMorph.prototype.wearCostume=function(e,t){var o=this.xPosition?this.xPosition():null,r=this.yPosition?this.yPosition():null,i=isNil(e)?null:this.costumes.asArray().indexOf(e),s=this.isWarped;s&&this.endWarp(),this.changed(),this.costume=e,this.drawNew(),this.changed(),s&&this.startWarp(),null!==o&&this.silentGotoXY(o,r,!0),this.positionTalkBubble&&this.positionTalkBubble(),this.version=Date.now(),t||this.shadowAttribute("costume #"),this.specimens().forEach(function(t){t.cachedPropagation&&t.inheritsAttribute("costume #")&&(null===i?t.wearCostume(null,!0):-1===i?t.wearCostume(e,!0):t.doSwitchToCostume(i+1,!0))})},SpriteMorph.prototype.getCostumeIdx=function(){return this.inheritsAttribute("costume #")?this.exemplar.getCostumeIdx():this.costumes.asArray().indexOf(this.costume)+1},SpriteMorph.prototype.doWearNextCostume=function(){var t,e=this.costumes.asArray();1<e.length&&-1<(t=e.indexOf(this.costume))&&((t+=1)>e.length-1&&(t=0),this.wearCostume(e[t]))},SpriteMorph.prototype.doWearPreviousCostume=function(){var t,e=this.costumes.asArray();1<e.length&&-1<(t=e.indexOf(this.costume))&&(--t<0&&(t=e.length-1),this.wearCostume(e[t]))},SpriteMorph.prototype.doSwitchToCostume=function(e,t){if(e instanceof Costume)this.wearCostume(e,t);else if(!(e instanceof Array&&"current"===e[0])){var o,r,i=this.costumes.asArray();if(contains([localize("Turtle"),localize("Empty")],e instanceof Array?e[0]:null))r=null;else{if(-1===e)return void this.doWearPreviousCostume();null===(r=detect(i,function(t){return t.name===e}))&&(r=0!==(o=parseFloat(e))&&i[o-1]||null)}this.wearCostume(r,t)}},SpriteMorph.prototype.reportCostumes=function(){return this.costumes},SpriteMorph.prototype.addSound=function(t,e){this.shadowAttribute("sounds"),this.sounds.add(new Sound(t,e))},SpriteMorph.prototype.doPlaySound=function(e){var t,o=this.parentThatIsA(StageMorph),r=e instanceof Sound?e:"number"==typeof e?this.sounds.at(e):detect(this.sounds.asArray(),function(t){return t.name===e.toString()}),i=this.audioContext(),s=this.getGainNode(),n=this.getPannerNode();if(r)return(t=document.createElement("audio")).src=r.audio.src,i.createMediaElementSource(t).connect(s),n?(s.connect(n),n.connect(i.destination),this.setPan(this.getPan())):s.connect(i.destination),this.setVolume(this.getVolume()),t.play(),o&&(o.activeSounds.push(t),o.activeSounds=o.activeSounds.filter(function(t){return!t.ended&&!t.terminated})),t},SpriteMorph.prototype.reportSounds=function(){return this.sounds},SpriteMorph.prototype.setVolume=function(e,t){this.volume=Math.max(Math.min(+e||0,100),0),this.getGainNode().gain.setValueAtTime(1/Math.pow(10,Math.log2(100/this.volume)),this.audioContext().currentTime),this instanceof StageMorph||(t||this.shadowAttribute("volume"),this.instances.forEach(function(t){t.cachedPropagation&&t.inheritsAttribute("volume")&&t.setVolume(e,!0)}))},SpriteMorph.prototype.changeVolume=function(t){this.setVolume(this.getVolume()+(+t||0))},SpriteMorph.prototype.getVolume=function(){return this.inheritsAttribute("volume")?this.exemplar.getVolume():this.volume},SpriteMorph.prototype.getGainNode=function(){return this.gainNode||(this.gainNode=this.audioContext().createGain()),this.gainNode},SpriteMorph.prototype.audioContext=function(){return Note.prototype.getAudioContext()},SpriteMorph.prototype.setPan=function(e,t){var o=this.getPannerNode();o&&(this.pan=Math.max(Math.min(+e||0,100),-100),o.pan.setValueAtTime(this.pan/100,this.audioContext().currentTime),this instanceof StageMorph||(t||this.shadowAttribute("balance"),this.instances.forEach(function(t){t.cachedPropagation&&t.inheritsAttribute("balance")&&t.setPan(e,!0)})))},SpriteMorph.prototype.changePan=function(t){this.setPan(this.getPan()+(+t||0))},SpriteMorph.prototype.getPan=function(){return this.inheritsAttribute("balance")?this.exemplar.getPan():this.pan},SpriteMorph.prototype.getPannerNode=function(){return this.pannerNode||this.audioContext().createStereoPanner&&(this.pannerNode=this.audioContext().createStereoPanner()),this.pannerNode},SpriteMorph.prototype.playFreq=function(t){var e,o=this.audioContext(),r=this.getGainNode(),i=this.getPannerNode(),s=this.parentThatIsA(StageMorph);this.freqPlayer||(this.freqPlayer=new Note),(e=this.freqPlayer).fader=o.createGain(),e.oscillator?e.oscillator.frequency.value=t:(e.oscillator=o.createOscillator(),e.oscillator.start||(e.oscillator.start=e.oscillator.noteOn),e.oscillator.stop||(e.oscillator.stop=e.oscillator.noteOff),e.setInstrument(this.instrument),e.oscillator.frequency.value=t,this.setVolume(this.getVolume()),e.oscillator.connect(e.fader),e.fader.connect(r),i?(r.connect(i),i.connect(o.destination),this.setPan(this.pan)):r.connect(o.destination),e.ended=!1,s&&(s.activeSounds.push(e),s.activeSounds=s.activeSounds.filter(function(t){return!t.ended&&!t.terminated})),e.fader.gain.setValueCurveAtTime(e.fadeIn,o.currentTime,e.fadeTime),e.oscillator.start(0))},SpriteMorph.prototype.stopFreq=function(){this.freqPlayer&&this.freqPlayer.stop()},SpriteMorph.prototype.userMenu=function(){var e,t,o=this.parentThatIsA(IDE_Morph),r=new MenuMorph(this);return o&&o.isAppMode||(this.isTemporary||(r.addItem("duplicate","duplicate"),StageMorph.prototype.enableInheritance&&(r.addItem("clone","instantiate"),r.addLine())),r.addItem("delete","remove"),r.addItem("move","moveCenter"),r.addItem("rotate","setRotation"),this.costume&&r.addItem("pivot","moveRotationCenter","edit the costume's\nrotation center"),this.isTemporary?StageMorph.prototype.enableInheritance&&r.addItem("edit","perpetuateAndEdit","make permanent and\nshow in the sprite corral"):r.addItem("edit","edit"),r.addLine(),this.anchor?r.addItem(localize("detach from")+" "+this.anchor.name,"detachFromAnchor"):(e=this.allParts(),(t=this.parent.children.filter(function(t){return t instanceof SpriteMorph&&!contains(e,t)})).length&&r.addMenu("stick to",this.anchorsMenu(t))),this.parts.length&&r.addItem("detach all parts","detachAllParts"),r.addItem("export...","exportSprite")),r},SpriteMorph.prototype.anchorsMenu=function(t){var e=new MenuMorph(this.attachTo,null,this);return t.forEach(function(t){e.addItem([t.thumbnail(new Point(24,24)),t.name],t)}),e},SpriteMorph.prototype.exportSprite=function(){var t;this.isTemporary||(t=this.parentThatIsA(IDE_Morph))&&t.exportSprite(this)},SpriteMorph.prototype.edit=function(){var t=this.parentThatIsA(IDE_Morph);t&&!t.isAppMode&&t.selectSprite(this)},SpriteMorph.prototype.showOnStage=function(){var t=this.parentThatIsA(StageMorph);t&&(this.keepWithin(t),t.add(this)),this.show()},SpriteMorph.prototype.duplicate=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.duplicateSprite(this)},SpriteMorph.prototype.instantiate=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.instantiateSprite(this)},SpriteMorph.prototype.remove=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.removeSprite(this)},SpriteMorph.prototype.createClone=function(t){var e,o=this.parentThatIsA(StageMorph);return o&&o.cloneCount<=5e3&&(e=this.fullCopy(!0)).clonify(o,t),e},SpriteMorph.prototype.newClone=function(t){var e=this.createClone(t);if(isNil(e))throw new Error("exceeding maximum number of clones");return e},SpriteMorph.prototype.clonify=function(e,o){var r=this;this.parts.forEach(function(t){t.clonify(e)}),e.cloneCount+=1,this.cloneOriginName=this.isTemporary?this.cloneOriginName:this.name,this.isTemporary=!0,this.name="",e.add(this),this.allHatBlocksFor("__clone__init__").forEach(function(t){e.threads.startProcess(t,r,e.isThreadSafe,null,null,null,o)}),this.endWarp()},SpriteMorph.prototype.initClone=function(t){var e=this.parentThatIsA(StageMorph),o=this;e&&(t.forEach(function(t){e.threads.startProcess(t,o,e.isThreadSafe)}),this.endWarp())},SpriteMorph.prototype.removeClone=function(){var e=this.exemplar,o=this;this.isTemporary&&(this.parent.threads.stopAllForReceiver(this),this.parts.slice().forEach(function(t){o.detachPart(t),t.removeClone()}),this.corpsify(),this.instances.forEach(function(t){t.isTemporary&&t.setExemplar(e)}),this.destroy(),--this.parent.cloneCount)},SpriteMorph.prototype.perpetuate=function(){var t=this.parentThatIsA(StageMorph),e=this.parentThatIsA(IDE_Morph);this.exemplar&&this.exemplar.perpetuate(),this.isTemporary&&t&&e&&(this.isTemporary=!1,this.name=e.newSpriteName(this.cloneOriginName),this.cloneOriginName="",--t.cloneCount,e.corral.addSprite(this),e.sprites.add(this),this.parts.forEach(function(t){t.perpetuate()}))},SpriteMorph.prototype.perpetuateAndEdit=function(){var t=this.parentThatIsA(IDE_Morph);t&&(this.perpetuate(),t.selectSprite(this))},SpriteMorph.prototype.release=function(){var t,e=this.parentThatIsA(StageMorph),o=this.parentThatIsA(IDE_Morph);!this.isTemporary&&this.exemplar&&e&&o&&(this.parts.forEach(function(t){t.release()}),this.instances.forEach(function(t){t.release()}),this.isTemporary=!0,this.name="",this.cloneOriginName=this.exemplar.name,e.cloneCount+=1,t=o.sprites.asArray().indexOf(this)+1,e.watchers().forEach(function(t){t.object()===this&&t.destroy()}),0<t&&o.sprites.remove(t),o.createCorral(),o.fixLayout(),o.currentSprite===this&&(o.currentSprite=detect(e.children,function(t){return t instanceof SpriteMorph&&!t.isTemporary})||this.stage),o.selectSprite(o.currentSprite))},SpriteMorph.prototype.corpsify=function(){this.isCorpse=!0,this.version=Date.now()},SpriteMorph.prototype.show=function(){this.setVisibility(!0)},SpriteMorph.prototype.hide=function(){this.setVisibility(!1)},SpriteMorph.prototype.setVisibility=function(e,t){e?SpriteMorph.uber.show.call(this):SpriteMorph.uber.hide.call(this),this.parts.forEach(function(t){t.setVisibility(e)}),t||this.shadowAttribute("shown?"),this.instances.forEach(function(t){t.cachedPropagation&&t.inheritsAttribute("shown?")&&t.setVisibility(e,!0)})},SpriteMorph.prototype.reportShown=function(){return this.inheritsAttribute("shown?")?this.exemplar.reportShown():this.isVisible},SpriteMorph.prototype.setColorComponentHSVA=function(t,e){var o=this.xPosition(),r=this.yPosition(),i=+e;(t=+t)<0||3<t||(0==t?(i<0||100<i)&&(i=(i<0?100:0)+i%100):i=Math.min(100,Math.max(0,i)),3===t?this.color.a=1-i/100:(this.cachedHSV[t]=i/100,this.color.set_hsv.apply(this.color,this.cachedHSV)),this.costume||(this.drawNew(),this.changed()),this.gotoXY(o,r))},SpriteMorph.prototype.getColorComponentHSLA=function(t){return 3===(t=+t)?100*(1-this.color.a):100*(this.cachedHSV[t]||0)},SpriteMorph.prototype.changeColorComponentHSVA=function(t,e){this.setColorComponentHSVA(t,this.getColorComponentHSLA(t)+(+e||0))},SpriteMorph.prototype.setColor=function(t){var e=this.xPosition(),o=this.yPosition();this.color.eq(t,!0)||(this.color=t.copy(),this.costume||(this.drawNew(),this.silentGotoXY(e,o)),this.cachedHSV=this.color.hsv())},SpriteMorph.prototype.setBackgroundColor=SpriteMorph.prototype.setColor,SpriteMorph.prototype.getPenAttribute=function(t){var e=t instanceof Array?t[0]:t.toString();return"size"===e?this.size||0:this.getColorComponentHSLA(["hue","saturation","brightness","transparency"].indexOf(e))},SpriteMorph.prototype.comeToFront=function(){this.parent&&(this.parent.add(this),this.changed())},SpriteMorph.prototype.goToBack=function(){this.parent&&(this.parent.addBack(this),this.changed())},SpriteMorph.prototype.goBack=function(t){var e,o,r=+t;if(!this.parent)return null;e=this.parent.children.indexOf(this),this.parent.removeChild(this),o=Math.max(e-r,0),this.parent.children.splice(o,null,this),this.parent.changed()},SpriteMorph.prototype.overlappingImage=function(t){var e=this.bounds.intersect(t.bounds),o=newCanvas(e.extent(),!0),r=o.getContext("2d");return!(e.width()<1||e.height()<1)&&this.image.width&&this.image.height&&t.image.width&&t.image.height?(r.drawImage(this.image,this.left()-e.left(),this.top()-e.top()),r.globalCompositeOperation="source-in",r.drawImage(t.image,t.left()-e.left(),t.top()-e.top()),o):newCanvas(new Point(1,1),!0)},SpriteMorph.prototype.doStamp=function(){var t=this.parent,e=t.penTrails().getContext("2d"),o=this.isWarped,r=e.globalAlpha;this.image.width<1||this.image.height<1||(o&&this.endWarp(),e.save(),e.scale(1/t.scale,1/t.scale),e.globalAlpha=this.alpha,e.drawImage(this.image,this.left()-t.left(),this.top()-t.top()),e.globalAlpha=r,e.restore(),this.changed(),o&&this.startWarp(),t.cachedPenTrailsMorph=null)},SpriteMorph.prototype.clear=function(){this.parent.clearPenTrails()},SpriteMorph.prototype.write=function(t,e){if("string"!=typeof t&&"number"!=typeof t)throw new Error("LABEL can only draw text or numbers, not a "+typeof t);var o,r,i=this.parentThatIsA(StageMorph),s=i.penTrails().getContext("2d"),n=radians(this.direction()-90),a=new Point(this.rotationCenter().x-i.left(),this.rotationCenter().y-i.top());s.save(),s.font=e+"px monospace",s.textAlign="left",s.textBaseline="alphabetic",s.fillStyle=this.color.toString(),o=s.measureText(t).width,a=a.multiplyBy(1/i.scale),s.translate(a.x,a.y),s.rotate(n),s.fillText(t,0,0),s.translate(-a.x,-a.y),s.restore(),r=(r=new Point(o*Math.sin(radians(this.direction())),o*Math.cos(radians(this.direction())))).add(new Point(this.xPosition(),this.yPosition())),this.gotoXY(r.x,r.y,!1),this.changed(),i.changed()},SpriteMorph.prototype.setSize=function(t){isNaN(t)||(this.size=Math.min(Math.max(+t,1e-4),1e3))},SpriteMorph.prototype.changeSize=function(t){this.setSize(this.size+(+t||0))},SpriteMorph.prototype.down=function(){this.setPenDown(!0)},SpriteMorph.prototype.up=function(){this.setPenDown(!1)},SpriteMorph.prototype.setPenDown=function(e,t){e?SpriteMorph.uber.down.call(this):SpriteMorph.uber.up.call(this),t||this.shadowAttribute("pen down?"),this.instances.forEach(function(t){t.cachedPropagation&&t.inheritsAttribute("pen down?")&&t.setPenDown(e,!0)})},SpriteMorph.prototype.getPenDown=function(){return this.inheritsAttribute("pen down?")?this.exemplar.getPenDown():this.isDown},SpriteMorph.prototype.getScale=function(){return this.inheritsAttribute("size")?this.exemplar.getScale():100*this.scale},SpriteMorph.prototype.setScale=function(e,t){var o,r,i=this.xPosition(),s=this.yPosition(),n=this.isWarped;n&&this.endWarp(),r=(o=(+e||0)/100)/this.nestingScale,this.nestingScale=o,this.scale=Math.max(o,.01),this.changed(),this.drawNew(),this.changed(),n&&this.startWarp(),this.silentGotoXY(i,s,!0),this.positionTalkBubble(),this.parts.forEach(function(t){var e=t.xPosition()-i,o=t.yPosition()-s;t.setScale(100*t.scale*r),t.silentGotoXY(i+e*r,s+o*r)}),t||this.shadowAttribute("size"),this.instances.forEach(function(t){t.cachedPropagation&&t.inheritsAttribute("size")&&t.setScale(e,!0)})},SpriteMorph.prototype.changeScale=function(t){this.setScale(this.getScale()+(+t||0))},SpriteMorph.prototype.graphicsChanged=function(){var e=this;return Object.keys(this.graphicsValues).some(function(t){return e.graphicsValues[t]<0||0<e.graphicsValues[t]})},SpriteMorph.prototype.applyGraphicsEffects=function(t){var k,e;if(this.graphicsChanged()){if(!t.width||!t.height)return t;e=(k=t.getContext("2d")).getImageData(0,0,t.width,t.height),this.graphicsValues.fisheye&&(e=function(t,e){var o,r,i,s,n,a,p,h,c,l=t.width,u=t.height,d=t.data,g=k.createImageData(l,u),y=g.data,f=l/2,m=u/2;for(e=Math.max(0,(e+100)/100),r=0;r<u;r++)for(o=0;o<l;o++)i=(o-f)/f,s=(r-m)/m,c=4*(((n=Math.pow(Math.sqrt(i*i+s*s),e))<=1?(a=Math.atan2(s,i),p=Math.floor(f+n*Math.cos(a)*f),Math.floor(m+n*Math.sin(a)*m)):(p=o,r))*l+p),y[h=4*(r*l+o)]=d[c],y[1+h]=d[1+c],y[2+h]=d[2+c],y[3+h]=d[3+c];return g}(e,this.graphicsValues.fisheye)),this.graphicsValues.whirl&&(e=function(t,e){for(var o,r,i,s,n,a,p,h,c,l,u,d,g=t.width,y=t.height,f=t.data,m=k.createImageData(g,y),M=m.data,S=g/2,b=y/2,w=Math.min(S,b),v=g<y?(r=y/g,1):(r=1,g/y),C=-radians(e),x=w*w,P=0;P<y;P++)for(o=0;o<g;o++)l=4*(((n=(i=r*(o-S))*i+(s=v*(P-b))*s)<x?(p=(a=1-Math.sqrt(n)/w)*a*C,u=Math.sin(p),d=Math.cos(p),h=Math.floor((d*i-u*s)/r+S),Math.floor((u*i+d*s)/v+b)):(h=o,P))*g+h),M[c=4*(P*g+o)]=f[l],M[1+c]=f[1+l],M[2+c]=f[2+l],M[3+c]=f[3+l];return m}(e,this.graphicsValues.whirl)),this.graphicsValues.pixelate&&(e=function(t,e){var o,r,i,s,n,a=t.width,p=t.height,h=t.data,c=k.createImageData(a,p),l=c.data;for(e=Math.floor(Math.abs(e/10)+1),r=0;r<p;r++)for(o=0;o<a;o++)i=Math.floor(o/e)*e,n=4*(Math.floor(r/e)*e*a+i),l[s=4*(r*a+o)]=h[n],l[1+s]=h[1+n],l[2+s]=h[2+n],l[3+s]=h[3+n];return c}(e,this.graphicsValues.pixelate)),this.graphicsValues.mosaic&&(e=function(t,e){var o,r,i,s=t.data,n=k.createImageData(t.width,t.height),a=n.data;for(e=Math.round((Math.abs(e)+10)/10),e=Math.max(0,Math.min(e,Math.min(t.width,t.height))),o=0,r=s.length;o<r;o+=4)i=o*e%r,a[o]=s[i],a[o+1]=s[1+i],a[o+2]=s[2+i],a[o+3]=s[3+i];return n}(e,this.graphicsValues.mosaic)),this.graphicsValues.duplicate&&(e=function(t,e){for(var o=t.data,r=0;r<o.length;r+=4)o[r]=o[r*e],o[r+1]=o[r*e+1],o[r+2]=o[r*e+2],o[r+3]=o[r*e+3];return t}(e,this.graphicsValues.duplicate)),(this.graphicsValues.color||this.graphicsValues.saturation||this.graphicsValues.brightness)&&(e=function(t,e,o,r){for(var i,s,n,a,p,h,c,l,u,d,g,y,f,m,M,S,b,w=t.data,v=0,C=w.length;v<C;v+=4)i=w[v],s=w[v+1],n=w[v+2],0==(h=(a=Math.max(i,s,n))-(p=Math.min(i,s,n)))?c=l=0:(a===i?c=60*(s-n)/h:a===s?c=120+60*(n-i)/h:a===n&&(c=240+60*(i-s)/h),l=(a-p)/a),c<0&&(c+=360),u=a/255,c=(c+360*e/200)%360,l=Math.max(0,Math.min(l+o/100,1)),y=(u=Math.max(0,Math.min(u+r/100,1)))*(1-l),f=u*(1-l*(g=c/60-(d=Math.floor(c/60)))),m=u*(1-l*(1-g)),0===d||6===d?(M=u,S=m,b=y):1===d?(M=f,S=u,b=y):2===d?(M=y,S=u,b=m):3===d?(M=y,S=f,b=u):4===d?(M=m,S=y,b=u):5===d&&(M=u,S=y,b=f),w[v]=255*M,w[v+1]=255*S,w[v+2]=255*b;return t}(e,this.graphicsValues.color,this.graphicsValues.saturation,this.graphicsValues.brightness)),this.graphicsValues.negative&&(e=function(t,e){for(var o,r,i,s=t.data,n=0,a=s.length;n<a;n+=4)o=255-s[n],r=255-s[n+1],i=255-s[n+2],s[n]<o?s[n]+=e:s[n]>o&&(s[n]-=e),s[n+1]<r?s[n+1]+=e:s[n+1]>r&&(s[n+1]-=e),s[n+2]<i?s[n+2]+=e:s[n+2]>i&&(s[n+2]-=e);return t}(e,this.graphicsValues.negative)),this.graphicsValues.comic&&(e=function(t,e){for(var o=t.data,r=0,i=o.length;r<i;r+=4)o[r]+=127*Math.sin(r*e)+128,o[r+1]+=127*Math.sin(r*e)+128,o[r+2]+=127*Math.sin(r*e)+128;return t}(e,this.graphicsValues.comic)),this.graphicsValues.confetti&&(e=function(t,e){for(var o=t.data,r=0,i=o.length;r<i;r+=1)o[r]=127*Math.sin(e*o[r])+o[r];return t}(e,this.graphicsValues.confetti)),k.putImageData(e,0,0)}return t},SpriteMorph.prototype.setEffect=function(t,e){var o=t instanceof Array?t[0]:t.toString();if(!contains(["color","saturation","brightness","ghost","fisheye","whirl","pixelate","mosaic","negative","duplicate","comic","confetti"],o))throw new Error(localize("unsupported graphic effect")+":\n"+o);"ghost"===o?this.alpha=1-Math.min(Math.max(+e||0,0),100)/100:this.graphicsValues[o]=+e,this.drawNew(),this.changed()},SpriteMorph.prototype.getEffect=function(t){var e=t instanceof Array?t[0]:t.toString();return"ghost"===e?this.getGhostEffect():this.graphicsValues[e]||0},SpriteMorph.prototype.getGhostEffect=function(){return 100*(1-this.alpha)},SpriteMorph.prototype.changeEffect=function(t,e){var o=t instanceof Array?t[0]:t.toString();"ghost"===o?this.setEffect(t,this.getGhostEffect()+(+e||0)):this.setEffect(t,+this.graphicsValues[o]+ +e)},SpriteMorph.prototype.clearEffects=function(){var t;for(t in this.graphicsValues)this.graphicsValues.hasOwnProperty(t)&&this.setEffect([t],0);this.setEffect(["ghost"],0)},SpriteMorph.prototype.stopTalking=function(){var t=this.talkBubble();t&&t.destroy()},SpriteMorph.prototype.doThink=function(t){this.bubble(t,!0)},SpriteMorph.prototype.bubble=function(t,e,o){var r,i=this.parentThatIsA(StageMorph);this.stopTalking(),""===t||isNil(t)||(r=new SpriteBubbleMorph(t,i,e,o),this.add(r),this.positionTalkBubble())},SpriteMorph.prototype.talkBubble=function(){return detect(this.children,function(t){return t instanceof SpeechBubbleMorph})},SpriteMorph.prototype.positionTalkBubble=function(){var t=this.parentThatIsA(StageMorph),e=t?t.scale:1,o=this.talkBubble(),r=this.center().y;if(!o)return null;for(o.show(),o.isPointingRight||(o.isPointingRight=!0,o.drawNew(),o.changed()),o.setLeft(this.right()),o.setBottom(this.top());!this.isTouching(o)&&o.bottom()<r;)o.silentMoveBy(new Point(-1,1).scaleBy(e));if(!t)return null;o.right()>t.right()&&(o.isPointingRight=!1,o.drawNew(),o.setRight(this.center().x)),o.keepWithin(t),o.changed()},SpriteMorph.prototype.prepareToBeGrabbed=function(t){this.removeShadow(),this.recordLayers(),this.shadowAttribute("x position"),this.shadowAttribute("y position"),!this.bounds.containsPoint(t.position())&&this.isCorrectingOutsideDrag()&&this.setCenter(t.position()),this.addShadow()},SpriteMorph.prototype.isCorrectingOutsideDrag=function(){return!this.parts.length},SpriteMorph.prototype.justDropped=function(){var t=this.parentThatIsA(StageMorph),e=this;t&&(t.enableCustomHatBlocks=!0),this.exemplar&&this.inheritedAttributes.forEach(function(t){contains(["direction","size","costume #"],t)&&e.refreshInheritedAttribute(t)}),this.restoreLayers(),this.positionTalkBubble(),this.receiveUserInteraction("dropped")},SpriteMorph.prototype.drawLine=function(t,e){var o=this.parent.bounds.origin,r=this.parent.scale,i=this.parent.penTrails().getContext("2d"),s=t.subtract(o).divideBy(r),n=e.subtract(o).divideBy(r),a=s.multiplyBy(r).add(o),p=n.multiplyBy(r).add(o),h=a.rectangle(p).expandBy(Math.max(this.size*r/2,1)).intersect(this.parent.visibleBounds()).spread();this.isDown&&(i.lineWidth=this.size,i.strokeStyle=this.color.toString(),this.useFlatLineEnds?(i.lineCap="butt",i.lineJoin="miter"):(i.lineCap="round",i.lineJoin="round"),i.beginPath(),i.moveTo(s.x,s.y),i.lineTo(n.x,n.y),i.stroke(),!1===this.isWarped&&this.world().broken.push(h),this.parent.cachedPenTrailsMorph=null)},SpriteMorph.prototype.floodFill=function(){if(this.parent.bounds.containsPoint(this.rotationCenter())){this.parent.cachedPenTrailsMorph=null,1<this.color.a&&(this.color.a=this.color.a/255);var t,e,o=normalizeCanvas(this.parent.penTrails()),r=o.width,i=o.height,s=o.getContext("2d"),n=s.getImageData(0,0,r,i),a=n.data,p=[Math.round(i/2-this.yPosition())*r+Math.round(this.xPosition()+r/2)],h=c(p[0]);if(h[0]!==Math.round(this.color.r)||h[1]!==Math.round(this.color.g)||h[2]!==Math.round(this.color.b)||h[3]!==Math.round(255*this.color.a)){for(;0<p.length;)t=p.pop(),(e=c(t))[0]===h[0]&&e[1]===h[1]&&e[2]===h[2]&&e[3]===h[3]&&(1<t%r&&(p.push(t+1),p.push(t-1)),0<t&&t<i*r&&(p.push(t+r),p.push(t-r))),a[4*t]=Math.round(this.color.r),a[4*t+1]=Math.round(this.color.g),a[4*t+2]=Math.round(this.color.b),a[4*t+3]=Math.round(255*this.color.a);s.putImageData(n,0,0),this.parent.changed()}}function c(t){var e=4*t;return[a[e],a[1+e],a[2+e],a[3+e]]}},SpriteMorph.prototype.reportPenTrailsAsCostume=function(){var t=new Costume(this.parentThatIsA(StageMorph).trailsCanvas,this.newCostumeName(localize("Costume")));return t.shrinkWrap(),t},SpriteMorph.prototype.moveBy=function(r,t){var e=this.isDown&&!t&&this.parent?this.rotationCenter():null;SpriteMorph.uber.moveBy.call(this,r),e&&this.drawLine(e,this.rotationCenter()),t||(this.parts.forEach(function(t){t.moveBy(r)}),this.instances.forEach(function(t){var e,o;t.cachedPropagation&&(e=t.inheritsAttribute("x position"),o=t.inheritsAttribute("y position"),e&&o?t.moveBy(r):e?t.moveBy(new Point(r.x,0)):o&&t.moveBy(new Point(0,r.y)))}))},SpriteMorph.prototype.silentMoveBy=function(r,t){SpriteMorph.uber.silentMoveBy.call(this,r),!t&&this.parent instanceof HandMorph&&(this.parts.forEach(function(t){t.moveBy(r)}),this.instances.forEach(function(t){var e,o;t.cachedPropagation&&(e=t.inheritsAttribute("x position"),o=t.inheritsAttribute("y position"),e&&o?t.moveBy(r):e?t.moveBy(new Point(r.x,0)):o&&t.moveBy(new Point(0,r.y)))}))},SpriteMorph.prototype.rootForGrab=function(){return this.anchor?this.anchor.rootForGrab():SpriteMorph.uber.rootForGrab.call(this)},SpriteMorph.prototype.setCenter=function(t,e){var o=t.subtract(this.center());this.moveBy(o,e)},SpriteMorph.prototype.nestingBounds=function(){var e=this.bounds;return!this.costume&&this.penBounds&&(e=this.penBounds.translateBy(this.position())),this.parts.forEach(function(t){t.isVisible&&(e=e.merge(t.nestingBounds()))}),e},SpriteMorph.prototype.setPosition=function(t,e){var o=t.subtract(this.topLeft());0===o.x&&0===o.y||this.moveBy(o,e)},SpriteMorph.prototype.forward=function(t){var e,o=t*this.parent.scale||0;if(0===o&&this.isDown)return this.isDown=!1,this.forward(-.05),this.isDown=!0,this.forward(.1),this.isDown=!1,this.forward(-.05),void(this.isDown=!0);e=0<=o?this.position().distanceAngle(o,this.heading):this.position().distanceAngle(Math.abs(o),this.heading-180),this.shadowAttribute("x position"),this.shadowAttribute("y position"),this.setPosition(e),this.positionTalkBubble()},SpriteMorph.prototype.setHeading=function(e,t){var o=this.xPosition(),r=this.yPosition(),i=isFinite(e)?+e:0,s=i-this.heading;this.rotationStyle?(this.changed(),SpriteMorph.uber.setHeading.call(this,i),this.silentGotoXY(o,r,!0),this.positionTalkBubble()):this.heading=(+e%360+360)%360,this.parts.forEach(function(t){var e=new Point(t.xPosition(),t.yPosition()).rotateBy(radians(s),new Point(o,r));t.rotatesWithAnchor&&t.turn(s),t.gotoXY(e.x,e.y)}),t||this.shadowAttribute("direction"),this.instances.forEach(function(t){t.cachedPropagation&&t.inheritsAttribute("direction")&&t.setHeading(e,!0)})},SpriteMorph.prototype.faceToXY=function(t,e){this.setHeading(this.angleToXY(t,e))},SpriteMorph.prototype.angleToXY=function(t,e){var o=(t-this.xPosition())*this.parent.scale,r=(e-this.yPosition())*this.parent.scale;return(Math.abs(o)<.001?r<0?90:270:Math.round((0<=o?0:180)-57.2957795131*Math.atan(r/o)))+90},SpriteMorph.prototype.turn=function(t){this.setHeading(this.heading+(+t||0))},SpriteMorph.prototype.turnLeft=function(t){this.setHeading(this.heading-(+t||0))},SpriteMorph.prototype.xPosition=function(){if(this.inheritsAttribute("x position"))return this.exemplar.xPosition();var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(this.rotationCenter().x-t.center().x)/t.scale:this.rotationCenter().x},SpriteMorph.prototype.yPosition=function(){if(this.inheritsAttribute("y position"))return this.exemplar.yPosition();var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(t.center().y-this.rotationCenter().y)/t.scale:this.rotationCenter().y},SpriteMorph.prototype.direction=function(){return this.inheritsAttribute("direction")?this.exemplar.direction():this.heading},SpriteMorph.prototype.penSize=function(){return this.size},SpriteMorph.prototype.gotoXY=function(t,e,o,r){var i,s,n,a=this.parentThatIsA(StageMorph);a&&(r||(this.shadowAttribute("x position"),this.shadowAttribute("y position")),t=isFinite(+t)?+t:0,e=isFinite(+e)?+e:0,i=a.center().x+t*a.scale,s=a.center().y-e*a.scale,n=this.costume?new Point(i,s).subtract(this.rotationOffset):new Point(i,s).subtract(this.extent().divideBy(2)),this.setPosition(n,o),this.positionTalkBubble())},SpriteMorph.prototype.silentGotoXY=function(t,e,o){var r=this.isDown;this.isDown=!1,this.gotoXY(t,e,o,!0),this.isDown=r},SpriteMorph.prototype.setXPosition=function(t){this.shadowAttribute("x position"),this.gotoXY(+t||0,this.yPosition(),!1,!0)},SpriteMorph.prototype.changeXPosition=function(t){this.setXPosition(this.xPosition()+(+t||0))},SpriteMorph.prototype.setYPosition=function(t){this.shadowAttribute("y position"),this.gotoXY(this.xPosition(),+t||0,!1,!0)},SpriteMorph.prototype.changeYPosition=function(t){this.setYPosition(this.yPosition()+(+t||0))},SpriteMorph.prototype.glide=function(t,e,o,r,i){var s=new Point(e,o),n=Math.max(Math.min(r/t,1),0),a=i.add(s.subtract(i).multiplyBy(n));this.gotoXY(a.x,a.y)},SpriteMorph.prototype.bounceOffEdge=function(){var t,e,o=this.parentThatIsA(StageMorph),r=this.nestingBounds();return!o||o.bounds.containsRectangle(r)?null:(t=Math.cos(radians(this.heading-90)),e=-Math.sin(radians(this.heading-90)),r.left()<o.left()&&(t=Math.abs(t)),r.right()>o.right()&&(t=-Math.abs(t)),r.top()<o.top()&&(e=-Math.abs(e)),r.bottom()>o.bottom()&&(e=Math.abs(e)),this.shadowAttribute("x position"),this.shadowAttribute("y position"),this.shadowAttribute("direction"),this.setHeading(degrees(Math.atan2(-e,t))+90),this.setPosition(this.position().add(r.amountToTranslateWithin(o.bounds))),void this.positionTalkBubble())},SpriteMorph.prototype.setRotationX=function(t){this.setRotationCenter(new Point(t,this.yPosition()))},SpriteMorph.prototype.setRotationY=function(t){this.setRotationCenter(new Point(this.xPosition(),t))},SpriteMorph.prototype.setRotationCenter=function(t){var e,o;if(!this.costume)throw new Error("setting the rotation center requires a costume");e=t.subtract(new Point(this.xPosition(),this.yPosition())).divideBy(this.scale).rotateBy(radians(90-this.heading)),o=this.costume.rotationCenter.add(new Point(e.x,-e.y)),this.costume.rotationCenter=o,this.drawNew()},SpriteMorph.prototype.moveRotationCenter=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"movePivot")},SpriteMorph.prototype.setPivot=function(t){var e,o=this.parentThatIsA(StageMorph);o&&(e=o.center(),this.setRotationCenter(new Point((t.x-e.x)/o.scale,(e.y-t.y)/o.scale)))},SpriteMorph.prototype.xCenter=function(){var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(this.center().x-t.center().x)/t.scale:this.center().x},SpriteMorph.prototype.yCenter=function(){var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(t.center().y-this.center().y)/t.scale:this.center().y},SpriteMorph.prototype.allMessageNames=function(){var o=[],e=this.scripts.children.slice();return this.customBlocks.forEach(function(t){t.body&&e.push(t.body.expression),t.scripts.forEach(function(t){e.push(t)})}),this.globalBlocks&&this.globalBlocks.forEach(function(t){t.body&&e.push(t.body.expression),t.scripts.forEach(function(t){e.push(t)})}),e.forEach(function(t){t.allChildren().forEach(function(t){var e;t instanceof InputSlotMorph&&t.choices&&contains(["messagesMenu","messagesReceivedMenu"],t.choices)&&(e=t.evaluate(),isString(e)&&""!==e&&(contains(o,e)||o.push(e)))})}),o},SpriteMorph.prototype.allHatBlocksFor=function(o){return"number"==typeof o&&(o=o.toString()),this.scripts.children.filter(function(t){var e;if(t.selector){if("receiveMessage"===t.selector)return(e=t.inputs()[0].evaluate())===o||e instanceof Array&&"__shout__go__"!==o&&"__clone__init__"!==o;if("receiveGo"===t.selector)return"__shout__go__"===o;if("receiveOnClone"===t.selector)return"__clone__init__"===o}return!1})},SpriteMorph.prototype.allHatBlocksForKey=function(o){return this.scripts.children.filter(function(t){if(t.selector&&"receiveKey"===t.selector){var e=t.inputs()[0].evaluate()[0];return e===o||"any key"===e}return!1})},SpriteMorph.prototype.allHatBlocksForInteraction=function(e){return this.scripts.children.filter(function(t){return!(!t.selector||"receiveInteraction"!==t.selector)&&t.inputs()[0].evaluate()[0]===e})},SpriteMorph.prototype.allGenericHatBlocks=function(){return this.scripts.children.filter(function(t){return!!t.selector&&"receiveCondition"===t.selector})},SpriteMorph.prototype.mouseClickLeft=function(){return this.receiveUserInteraction("clicked")},SpriteMorph.prototype.mouseEnter=function(){return this.receiveUserInteraction("mouse-entered")},SpriteMorph.prototype.mouseDownLeft=function(){return this.receiveUserInteraction("pressed")},SpriteMorph.prototype.mouseScroll=function(t){return this.receiveUserInteraction("scrolled-"+(0<t?"up":"down"))},SpriteMorph.prototype.receiveUserInteraction=function(e,o,r){var i=this.parentThatIsA(StageMorph),s=[],n=this;if(i)return this.allHatBlocksForInteraction(e).forEach(function(t){s.push(i.threads.startProcess(t,n,r||i.isThreadSafe,null,null,null,o,"stopped"===e))}),s},SpriteMorph.prototype.mouseDoubleClick=function(){this.isTemporary||this.edit()},SpriteMorph.prototype.getTimer=function(){var t=this.parentThatIsA(StageMorph);return t?t.getTimer():0},SpriteMorph.prototype.getTempo=function(){var t=this.parentThatIsA(StageMorph);return t?t.getTempo():0},SpriteMorph.prototype.getLastMessage=function(){var t=this.parentThatIsA(StageMorph);return t?t.getLastMessage():""},SpriteMorph.prototype.getLastAnswer=function(){return this.parentThatIsA(StageMorph).lastAnswer},SpriteMorph.prototype.reportMouseX=function(){var t=this.parentThatIsA(StageMorph);return t?t.reportMouseX():0},SpriteMorph.prototype.reportMouseY=function(){var t=this.parentThatIsA(StageMorph);return t?t.reportMouseY():0},SpriteMorph.prototype.reportThreadCount=function(){var t=this.parentThatIsA(StageMorph);return t?t.threads.processes.length:0},SpriteMorph.prototype.refactorVariableInstances=function(e,o,t){t&&this.hasSpriteVariable(e)||this.scripts.children.forEach(function(t){t instanceof BlockMorph&&t.refactorVarInStack(e,o)})},SpriteMorph.prototype.findVariableWatcher=function(e){var t=this.parentThatIsA(StageMorph),o=this.globalVariables(),r=this;return null===t?null:detect(t.children,function(t){return t instanceof WatcherMorph&&(t.target===r.variables||t.target===o)&&t.getter===e})},SpriteMorph.prototype.toggleVariableWatcher=function(t,e){var o,r,i=this.parentThatIsA(StageMorph),s=this.globalVariables();return null===i?null:null===(o=this.findVariableWatcher(t))?(isNil(e)&&(e=contains(s.names(),t)),(o=new WatcherMorph(t,this.blockColor.variables,e?s:this.variables,t)).setPosition(i.position().add(10)),0<(r=i.watchers(o.left())).length&&o.setTop(r[r.length-1].bottom()),i.add(o),o.fixLayout(),o.keepWithin(i),o):void(o.isVisible?o.hide():(o.show(),o.fixLayout(),o.keepWithin(i)))},SpriteMorph.prototype.showingVariableWatcher=function(t){var e;return null!==this.parentThatIsA(StageMorph)&&(!!(e=this.findVariableWatcher(t))&&e.isVisible)},SpriteMorph.prototype.deleteVariableWatcher=function(t){var e;if(null===this.parentThatIsA(StageMorph))return null;null!==(e=this.findVariableWatcher(t))&&e.destroy()},SpriteMorph.prototype.toggleWatcher=function(t,e,o){var r,i,s=this.parentThatIsA(StageMorph);s&&((r=this.watcherFor(s,t))?r.isVisible?r.hide():(r.show(),r.fixLayout(),r.keepWithin(s)):((r=new WatcherMorph(e,o,WatcherMorph.prototype.isGlobal(t)?s:this,t)).setPosition(s.position().add(10)),0<(i=s.watchers(r.left())).length&&r.setTop(i[i.length-1].bottom()),s.add(r),r.fixLayout(),r.keepWithin(s)))},SpriteMorph.prototype.showingWatcher=function(t){var e,o=this.parentThatIsA(StageMorph);return null!==o&&(!!(e=this.watcherFor(o,t))&&e.isVisible)},SpriteMorph.prototype.watcherFor=function(e,o){var r=this;return detect(e.children,function(t){return t instanceof WatcherMorph&&t.getter===o&&t.target===(t.isGlobal(o)?e:r)})},SpriteMorph.prototype.deleteAllBlockInstances=function(t){var e;(t.isGlobal?this.allBlockInstances(t):this.allIndependentInvocationsOf(t.blockSpec())).forEach(function(t){t.deleteBlock()}),t.isGlobal?(e=this.parentThatIsA(StageMorph))&&(e.globalBlocks.forEach(function(t){t.purgeCorpses()}),e.children.concat(e).forEach(function(t){t.isSnapObject&&t.customBlocks.forEach(function(t){t.purgeCorpses()})})):this.allSpecimens().concat(this).forEach(function(t){t.customBlocks.forEach(function(t){t.purgeCorpses()})})},SpriteMorph.prototype.allBlockInstances=function(e){var t,o,r,i=[];return e.isGlobal?((o=(t=this.parentThatIsA(StageMorph)).children.filter(function(t){return t instanceof SpriteMorph})).push(t),o.forEach(function(t){i=i.concat(t.allLocalBlockInstances(e))}),r=[],t.globalBlocks.forEach(function(t){t.scripts.forEach(function(t){t.allChildren().forEach(function(t){t.isCustomBlock&&t.definition===e&&r.push(t)})}),t.body&&t.body.expression.allChildren().forEach(function(t){t.isCustomBlock&&t.definition===e&&r.push(t)})}),i.concat(r)):this.allLocalBlockInstances(e)},SpriteMorph.prototype.allIndependentInvocationsOf=function(e){var o;return this.exemplar&&this.exemplar.getMethod(e)?[]:(o=this.allInvocationsOf(e),this.instances.forEach(function(t){t.addAllInvocationsOf(e,o)}),o)},SpriteMorph.prototype.allDependentInvocationsOf=function(e){var o=this.allInvocationsOf(e);return this.instances.forEach(function(t){t.addAllInvocationsOf(e,o)}),o},SpriteMorph.prototype.allInvocationsOf=function(e){var t,o=this.scripts.allChildren().filter(function(t){return t.isCustomBlock&&!t.isGlobal&&t.blockSpec===e}),r=[];return this.customBlocks.forEach(function(t){t.scripts.forEach(function(t){t.allChildren().forEach(function(t){t.isCustomBlock&&!t.isGlobal&&t.blockSpec===e&&r.push(t)})}),t.body&&t.body.expression.allChildren().forEach(function(t){t.isCustomBlock&&!t.isGlobal&&t.blockSpec===e&&r.push(t)})}),t=this.allEditorBlockInstances(null,e),o.concat(r).concat(t)},SpriteMorph.prototype.addAllInvocationsOf=function(e,o){this.getLocalMethod(e)||(this.allInvocationsOf(e).forEach(function(t){o.push(t)}),this.instances.forEach(function(t){t.addAllInvocationsOf(e,o)}))},SpriteMorph.prototype.allLocalBlockInstances=function(e){var t,o,r,i=this.scripts.allChildren().filter(function(t){return t.isCustomBlock&&t.definition===e}),s=[];return this.customBlocks.forEach(function(t){t.body&&t.body.expression.allChildren().forEach(function(t){t.isCustomBlock&&t.definition===e&&s.push(t)})}),t=this.allEditorBlockInstances(e),o=this.paletteBlockInstance(e),r=i.concat(s).concat(t),o&&r.push(o),r},SpriteMorph.prototype.allEditorBlockInstances=function(e,o){var r=[];return this.world()?(this.world().children.forEach(function(t){t instanceof BlockEditorMorph&&t.body.contents.allChildren().forEach(function(t){e?t.isPrototype||t instanceof PrototypeHatBlockMorph||t.definition!==e||r.push(t):!t.isCustomBlock||t.isGlobal||t.isPrototype||t instanceof PrototypeHatBlockMorph||t.blockSpec!==o||r.push(t)})}),r):[]},SpriteMorph.prototype.paletteBlockInstance=function(e){var t=this.parentThatIsA(IDE_Morph);return t?detect(t.palette.contents.children,function(t){return t.isCustomBlock&&t.definition===e}):null},SpriteMorph.prototype.usesBlockInstance=function(e,o,t,r){var i;return!!detect(this.scripts.allChildren(),function(t){return t.isCustomBlock&&t.definition===e})||(!!(e.isGlobal&&!t&&(i=[],this.parentThatIsA(StageMorph).globalBlocks.forEach(function(t){o&&e===t||r&&contains(r,t)||t.body&&t.body.expression.allChildren().forEach(function(t){t.isCustomBlock&&t.definition===e&&i.push(t)})}),0<i.length))||(i=[],this.customBlocks.forEach(function(t){t.body&&t.body.expression.allChildren().forEach(function(t){t.isCustomBlock&&t.definition===e&&i.push(t)})}),0<i.length))},SpriteMorph.prototype.doubleDefinitionsFor=function(t){var e,o,r,i=t.blockSpec();if(t.isGlobal){if(!(r=this.parentThatIsA(StageMorph)))return[];e=r.globalBlocks}else e=this.customBlocks;return-1===(o=e.indexOf(t))?[]:e.filter(function(t,e){return t.blockSpec()===i&&e!==o})},SpriteMorph.prototype.replaceDoubleDefinitionsFor=function(e){var t,o,r=this.doubleDefinitionsFor(e),i=this;r.forEach(function(t){i.allBlockInstances(t).forEach(function(t){t.definition=e,t.refresh()})}),e.isGlobal?(t=this.parentThatIsA(StageMorph)).globalBlocks=t.globalBlocks.filter(function(t){return!contains(r,t)}):this.customBlocks=this.customBlocks.filter(function(t){return!contains(r,t)}),(o=this.parentThatIsA(IDE_Morph))&&(o.flushPaletteCache(),o.refreshPalette())},SpriteMorph.prototype.chooseExemplar=function(){var t=this.parentThatIsA(StageMorph),e=this,o=t.children.filter(function(t){return t instanceof SpriteMorph&&!t.isTemporary&&!contains(t.allExemplars(),e)}),r=new MenuMorph(function(t){e.setExemplar(t)},localize("current parent")+":\n"+(this.exemplar?this.exemplar.name:localize("none")));o.forEach(function(t){r.addItem(t.name,t)}),r.addLine(),r.addItem(localize("none"),null),r.popUpAtHand(this.world())},SpriteMorph.prototype.setExemplar=function(t){var e;this.emancipate(),(this.exemplar=t)?(this.variables.parentFrame=t.variables,t.addSpecimen(this)):this.variables.parentFrame=this.globalVariables(),this.isTemporary?this.cloneOriginName=t.cloneOriginName||t.name:(e=this.parentThatIsA(IDE_Morph))&&(e.flushBlocksCache(),e.refreshPalette())},SpriteMorph.prototype.prune=function(){this.instances.forEach(function(t){t.shadowAllAttributes(),t.shadowAllMethods(),t.shadowAllVars(),t.exemplar=null}),this.instances=[]},SpriteMorph.prototype.emancipate=function(){this.exemplar&&(this.isTemporary||(this.shadowAllAttributes(),this.shadowAllMethods(),this.shadowAllVars()),this.exemplar.removeSpecimen(this),this.exemplar=null)},SpriteMorph.prototype.allExemplars=function(){for(var t=[],e=this;!isNil(e);)t.push(e),e=e.exemplar;return t},SpriteMorph.prototype.specimens=function(){return this.instances},SpriteMorph.prototype.allSpecimens=function(){var e=this.instances.slice();return this.instances.forEach(function(t){e.push.apply(e,t.allSpecimens())}),e},SpriteMorph.prototype.addSpecimen=function(t){this.instances.push(t)},SpriteMorph.prototype.removeSpecimen=function(t){var e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1)},SpriteMorph.prototype.inheritsAttribute=function(t){return!isNil(this.exemplar)&&contains(this.inheritedAttributes,t)},SpriteMorph.prototype.updatePropagationCache=function(){var e=this;this.cachedPropagation=!isNil(this.exemplar)&&detect(["x position","y position","direction","size","costume #","volume","balance","shown?","pen down?"],function(t){return contains(e.inheritedAttributes,t)})},SpriteMorph.prototype.shadowedAttributes=function(){var e=this.inheritedAttributes;return this.attributes.filter(function(t){return!contains(e,t)})},SpriteMorph.prototype.shadowAllAttributes=function(){var e=this;this.attributes.forEach(function(t){e.shadowAttribute(t)})},SpriteMorph.prototype.shadowAttribute=function(e){var t,o,r,i,s=this;this.inheritsAttribute(e)&&(t=this.parentThatIsA(IDE_Morph),this.inheritedAttributes=this.inheritedAttributes.filter(function(t){return t!==e}),"costumes"===e?(o=new List,this.costumes.asArray().forEach(function(t){var e=t.copy();o.add(e),t===s.costume&&s.wearCostume(e)}),this.costumes=o,this.instances.forEach(function(t){t.inheritsAttribute("costumes")&&t.refreshInheritedAttribute("costumes")})):"sounds"===e?(r=new List,this.sounds.asArray().forEach(function(t){r.add(t.copy())}),this.sounds=r,this.instances.forEach(function(t){t.inheritsAttribute("sounds")&&t.refreshInheritedAttribute("sounds")})):"scripts"===e?(t.stage.threads.stopAllForReceiver(this),i=this.scripts.position(),this.scripts=this.exemplar.scripts.fullCopy(),t&&contains(t.currentSprite.allExemplars(),this)&&(t.createSpriteEditor(),t.fixLayout("selectSprite"),this.scripts.fixMultiArgs(),this.scripts.setPosition(i),t.spriteEditor.adjustScrollBars()),this.instances.forEach(function(t){t.inheritsAttribute("scripts")&&t.refreshInheritedAttribute("scripts")})):(this.updatePropagationCache(),t&&!this.isTemporary&&(t.flushBlocksCache(),t.refreshPalette())))},SpriteMorph.prototype.inheritAttribute=function(t){var e=this.parentThatIsA(IDE_Morph);this.exemplar&&contains(this.attributes,t)&&(this.inheritsAttribute(t)||(this.inheritedAttributes.push(t),this.refreshInheritedAttribute(t),e&&(e.flushBlocksCache(),e.refreshPalette())))},SpriteMorph.prototype.refreshInheritedAttribute=function(t){var e,o;switch(t){case"x position":case"y position":this.cachedPropagation=!0,this.gotoXY(this.xPosition(),this.yPosition(),!1,!0);break;case"direction":this.cachedPropagation=!0,this.setHeading(this.direction(),!0);break;case"size":this.cachedPropagation=!0,this.setScale(this.getScale(),!0);break;case"costume #":this.cachedPropagation=!0,this.doSwitchToCostume(this.getCostumeIdx(),!0);break;case"volume":this.cachedPropagation=!0,this.setVolume(this.getVolume(),!0);break;case"shown?":this.cachedPropagation=!0,this.setVisibility(this.reportShown(),!0);break;case"pen down?":this.cachedPropagation=!0,this.setPenDown(this.getPenDown(),!0);break;case"balance":this.cachedPropagation=!0,this.setPan(this.getPan(),!0);break;case"costumes":o=this.getCostumeIdx(),this.costumes=this.exemplar.costumes,this.doSwitchToCostume(o,!0),this.instances.forEach(function(t){t.inheritsAttribute("costumes")&&t.refreshInheritedAttribute("costumes")});break;case"sounds":this.sounds=this.exemplar.sounds,this.instances.forEach(function(t){t.inheritsAttribute("sounds")&&t.refreshInheritedAttribute("sounds")});break;case"scripts":this.scripts=this.exemplar.scripts,(e=this.parentThatIsA(IDE_Morph))&&(e.stage.threads.stopAllForReceiver(this),contains(e.currentSprite.allExemplars(),this)&&(e.createSpriteEditor(),e.fixLayout("selectSprite"))),this.instances.forEach(function(t){t.inheritsAttribute("scripts")&&t.refreshInheritedAttribute("scripts")});break;default:nop()}},SpriteMorph.prototype.toggleInheritanceForAttribute=function(t){this.inheritsAttribute(t)?this.shadowAttribute(t):this.inheritAttribute(t)},SpriteMorph.prototype.isVariableNameInUse=function(t,e){return e?contains(this.variables.allNames(),t):!!contains(this.variables.names(),t)||contains(this.globalVariables().names(),t)},SpriteMorph.prototype.globalVariables=function(){for(var t=this.variables.parentFrame;t.owner;)t=t.parentFrame;return t},SpriteMorph.prototype.shadowAllVars=function(){var e=this;this.inheritedVariableNames().forEach(function(t){e.shadowVar(t,e.variables.getVar(t))})},SpriteMorph.prototype.shadowVar=function(t,e){var o;this.variables.addVar(t,e),this.isTemporary||(o=this.parentThatIsA(IDE_Morph))&&(o.flushBlocksCache("variables"),o.refreshPalette())},SpriteMorph.prototype.toggleInheritedVariable=function(t){contains(this.inheritedVariableNames(!0),t)?this.deleteVariable(t):contains(this.inheritedVariableNames(),t)&&this.shadowVar(t,this.variables.getVar(t))},SpriteMorph.prototype.inheritedVariableNames=function(e){var t=[],o=this.variables.names(),r=this.variables.parentFrame;function i(t){return e?contains(o,t):!contains(o,t)}for(;r.owner instanceof SpriteMorph;)t.push.apply(t,r.names().filter(i)),r=r.parentFrame;return t},SpriteMorph.prototype.deletableVariableNames=function(){var e=this.variables.names(),o=this.inheritedVariableNames();return e.concat(this.globalVariables().names().filter(function(t){return!contains(e,t)&&!contains(o,t)}))},SpriteMorph.prototype.hasSpriteVariable=function(t){return contains(this.variables.names(),t)},SpriteMorph.prototype.allLocalVariableNames=function(t){var e,o=this.globalVariables(),r=o.names();return e=this.variables.allNames(o).filter(function(t){return!contains(r,t)}),t&&e.sort(function(t,e){return t.toLowerCase()<e.toLowerCase()?-1:1}),e},SpriteMorph.prototype.reachableGlobalVariableNames=function(t){var e,o=this.allLocalVariableNames();return e=this.globalVariables().names().filter(function(t){return!contains(o,t)}),t&&e.sort(function(t,e){return t.toLowerCase()<e.toLowerCase()?-1:1}),e},SpriteMorph.prototype.getMethod=function(t){return this.allBlocks()[t]},SpriteMorph.prototype.getLocalMethod=function(t){return this.ownBlocks()[t]},SpriteMorph.prototype.ownBlocks=function(){var e={};return this.customBlocks.forEach(function(t){e[t.blockSpec()]=t}),e},SpriteMorph.prototype.allBlocks=function(t){var e={};return this.allExemplars().reverse().forEach(function(t){t.customBlocks.forEach(function(t){e[t.blockSpec()]=t})}),t?Object.keys(e).map(function(t){return e[t]}):e},SpriteMorph.prototype.inheritedBlocks=function(t){var o={},r=Object.keys(this.ownBlocks()),e=this.allExemplars().reverse();return e.pop(),e.forEach(function(t){t.customBlocks.forEach(function(t){var e=t.blockSpec();contains(r,e)||(o[e]=t)})}),t?Object.keys(o).map(function(t){return o[t]}):o},SpriteMorph.prototype.shadowAllMethods=function(){var t,e=this;this.inheritedMethods().forEach(function(t){e.customBlocks.push(t)}),this.isTemporary||(t=this.parentThatIsA(IDE_Morph))&&(t.flushPaletteCache(),t.refreshPalette())},SpriteMorph.prototype.inheritedMethods=function(){var e=this;return this.inheritedBlocks(!0).map(function(t){return t.copyAndBindTo(e,!0)})},SpriteMorph.prototype.thumbnail=function(i){var t=this.image,e=Math.min(i.x/t.width,i.y/t.height),o=(i.x-t.width*e)/2,r=(i.y-t.height*e)/2,s=newCanvas(i),n=s.getContext("2d");function a(t,e,o){var r=Math.min(i.x,i.y)/10;n.strokeStyle=t,n.globalAlpha=e,n.compositeOperation="lighter",n.lineWidth=o||1,n.moveTo(r,r),n.lineTo(s.width-r,s.height-r),n.moveTo(r,s.height-r),n.lineTo(s.width-r,r),n.stroke()}return n.save(),this.isCorpse&&(n.globalAlpha=.3),t.width&&t.height&&(n.scale(e,e),n.drawImage(t,Math.floor(o/e),Math.floor(r/e))),this.isCorpse&&(n.restore(),a("white",.8,6),a("black",.8,1)),s},SpriteMorph.prototype.fullThumbnail=function(t){var e=this.thumbnail(t),o=e.getContext("2d"),r=t.divideBy(3),i=0;for(o.restore(),this.anchor&&o.drawImage(this.anchor.thumbnail(r),0,0),i=0;i<3;i+=1)this.parts[i]&&o.drawImage(this.parts[i].thumbnail(r),i*r.x,t.y-r.y);return e},SpriteMorph.prototype.booleanMorph=function(t){var e=new BooleanSlotMorph(t);return e.isStatic=!0,e.drawNew(),e},SpriteMorph.prototype.attachTo=function(t){t.attachPart(this)},SpriteMorph.prototype.attachPart=function(t){var e=Date.now();t.anchor&&t.anchor.detachPart(t),this.parts.push(t),this.version=e,(t.anchor=this).allParts().forEach(function(t){t.nestingScale=t.scale}),t.version=e},SpriteMorph.prototype.detachPart=function(t){var e,o=this.parts.indexOf(t);-1!==o&&(e=Date.now(),this.parts.splice(o,1),this.version=e,t.anchor=null,t.version=e)},SpriteMorph.prototype.detachAllParts=function(){var e=Date.now();this.parts.forEach(function(t){t.anchor=null,t.version=e}),this.parts=[],this.version=e},SpriteMorph.prototype.detachFromAnchor=function(){this.anchor&&this.anchor.detachPart(this)},SpriteMorph.prototype.allParts=function(){var e=[this];return this.parts.forEach(function(t){e=e.concat(t.allParts())}),e},SpriteMorph.prototype.allAnchors=function(){var t=[this];return null!==this.anchor&&(t=t.concat(this.anchor.allAnchors())),t},SpriteMorph.prototype.recordLayers=function(){var o=this.parentThatIsA(StageMorph);o?(this.layers=this.allParts(),this.layers.forEach(function(t){var e=t.talkBubble();e&&e.hide()}),this.layers.sort(function(t,e){return o.children.indexOf(t)<o.children.indexOf(e)?-1:1})):this.layerCache=null},SpriteMorph.prototype.restoreLayers=function(){this.layers&&1<this.layers.length&&this.layers.forEach(function(t){t.comeToFront(),t.positionTalkBubble()}),this.layers=null},SpriteMorph.prototype.destroy=function(){this.anchor&&this.anchor.detachPart(this),this.emancipate(),this.isTemporary||this.prune(),SpriteMorph.uber.destroy.call(this)},SpriteMorph.prototype.flash=function(){var t=this.world(),e=this;this.addHighlight(),t.animations.push(new Animation(nop,nop,0,800,nop,function(){e.removeHighlight()}))},SpriteMorph.prototype.addHighlight=function(t){var e,o=!this.isVisible;return o&&this.show(),e=this.highlight(t?t.color:this.highlightColor,this.highlightBorder),this.addBack(e),this.fullChanged(),o&&this.hide(),e},SpriteMorph.prototype.removeHighlight=function(){var t=this.getHighlight();return null!==t&&(this.fullChanged(),this.removeChild(t)),t},SpriteMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()},SpriteMorph.prototype.highlight=function(t,e){var o,r=new SpriteHighlightMorph,i=this.bounds,s=e;return r.setExtent(i.extent().add(2*s)),r.color=t,r.image=this.highlightImage(t,e),(o=r.image.getContext("2d")).drawImage(this.highlightImage(new Color(255,255,255),4),e-4,e-4),o.drawImage(this.highlightImage(new Color(50,50,50),2),e-2,e-2),o.drawImage(this.highlightImage(new Color(255,255,255),1),e-1,e-1),r.setPosition(i.origin.subtract(new Point(s,s))),r},SpriteMorph.prototype.highlightImage=function(t,e){var o,r=this.extent(),i=this.image,s=newCanvas(r.add(2*e)),n=s.getContext("2d");return n.drawImage(i,0,0),n.drawImage(i,e,0),n.drawImage(i,2*e,0),n.drawImage(i,2*e,e),n.drawImage(i,2*e,2*e),n.drawImage(i,e,2*e),n.drawImage(i,0,2*e),n.drawImage(i,0,e),n.globalCompositeOperation="destination-out",n.drawImage(i,e,e),(n=(o=newCanvas(r.add(2*e))).getContext("2d")).drawImage(s,0,0),n.globalCompositeOperation="source-atop",n.fillStyle=t.toString(),n.fillRect(0,0,o.width,o.height),o},SpriteMorph.prototype.getHighlight=function(){var t=this.children.slice(0).reverse().filter(function(t){return t instanceof SpriteHighlightMorph});return 0!==t.length?t[0]:null},SpriteMorph.prototype.mouseEnterDragging=function(){var t;this.enableNesting&&(t=this.world().hand.children[0],this.wantsDropOf(t)&&this.addHighlight())},SpriteMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed"),this.enableNesting&&this.removeHighlight()},SpriteMorph.prototype.wantsDropOf=function(t){return this.enableNesting&&t instanceof SpriteIconMorph&&!contains(t.object.allParts(),this)},SpriteMorph.prototype.reactToDropOf=function(t,e){this.removeHighlight(),this.attachPart(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin)},SpriteMorph.prototype.newCostumeName=function(t,e){for(var o=t.indexOf("("),r=o<0?t:t.substring(0,o),i=1,s=r,n=this.costumes.asArray().filter(function(t){return t!==e}).map(function(t){return t.name});contains(n,s);)s=r+"("+(i+=1)+")";return s},SpriteMorph.prototype.doScreenshot=function(t,e){var o,r,i=this.parentThatIsA(StageMorph);e=this.newCostumeName(e),void 0!==t[0]&&("pen trails"===t[0]?(o=i.trailsCanvas,r=new Costume(o,e).copy()):"stage image"===t[0]&&(o=i.fullImageClassic(),r=new Costume(o,e)),this.addCostume(r))},SpriteHighlightMorph.prototype=new Morph,(SpriteHighlightMorph.prototype.constructor=SpriteHighlightMorph).uber=Morph.prototype,StageMorph.prototype=new FrameMorph,(StageMorph.prototype.constructor=StageMorph).uber=FrameMorph.prototype,StageMorph.prototype.dimensions=new Point(480,360),StageMorph.prototype.frameRate=0,StageMorph.prototype.isCachingPrimitives=SpriteMorph.prototype.isCachingPrimitives,StageMorph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!0,StageMorph.prototype.enableSublistIDs=!1,StageMorph.prototype.init=function(t){this.name=localize("Stage"),this.instrument=null,this.threads=new ThreadManager,this.variables=new VariableFrame(t||null,this),this.scripts=new ScriptsMorph,this.customBlocks=[],this.globalBlocks=[],this.costumes=new List,this.costume=null,this.sounds=new List,this.version=Date.now(),this.isFastTracked=!1,this.enableCustomHatBlocks=!0,this.cloneCount=0,this.timerStart=Date.now(),this.tempo=60,this.lastMessage="",this.volume=100,this.gainNode=null,this.pan=0,this.pannerNode=null,this.freqPlayer=null,this.watcherUpdateFrequency=2,this.lastWatcherUpdate=Date.now(),this.scale=1,this.cachedHSV=[0,0,0],this.keysPressed={},this.blocksCache={},this.paletteCache={},this.lastAnswer="",this.activeSounds=[],this.trailsCanvas=null,this.isThreadSafe=!1,this.microphone=new Microphone,this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0},this.cachedPenTrailsMorph=null,this.remixID=null,this.projectionSource=null,this.getProjectionImage=null,this.stopProjectionSource=null,this.continuousProjection=!1,this.projectionCanvas=null,this.projectionTransparency=50,this.mirrorVideo=!0,this.videoMotion=null,this.worldMap=new WorldMap,StageMorph.uber.init.call(this),this.cachedHSV=this.color.hsv(),this.acceptsDrops=!1,this.setColor(new Color(255,255,255)),this.fps=this.frameRate},StageMorph.prototype.setScale=function(e){var o,r,i=e/this.scale,s=this.position(),t=Morph.prototype.trackChanges,n=this;1!=i&&(this.cachedPenTrailsMorph=null,Morph.prototype.trackChanges=!1,this.scale=e,this.setExtent(this.dimensions.multiplyBy(e)),this.children.forEach(function(t){o=t.position().subtract(s),t.drawNew(),t.setPosition(o.multiplyBy(i).add(s),!0),t instanceof SpriteMorph?(r=t.talkBubble())&&(r.setScale(e),t.positionTalkBubble()):t instanceof StagePrompterMorph&&(n.scale<1?t.setWidth(n.width()-10):t.setWidth(n.dimensions.x-20),t.fixLayout(),t.setCenter(n.center()),t.setBottom(n.bottom()))}),Morph.prototype.trackChanges=t,this.changed())},StageMorph.prototype.drawNew=function(){var t;StageMorph.uber.drawNew.call(this),this.costume&&((t=this.image.getContext("2d")).scale(this.scale,this.scale),t.drawImage(this.costume.contents,(this.width()/this.scale-this.costume.width())/2,(this.height()/this.scale-this.costume.height())/2),this.image=this.applyGraphicsEffects(this.image)),this.version=Date.now()},StageMorph.prototype.drawOn=function(t,e){var o,r,i,s,n,a,p,h,c,l;if(!this.isVisible)return null;if((o=(e||this.bounds).intersect(this.bounds)).extent().gt(new Point(0,0))){if(r=this.position().neg(),i=o.copy().translateBy(r),(s=t.getContext("2d")).globalAlpha=this.alpha,p=i.left(),h=i.top(),n=Math.min(i.width(),this.image.width-p),a=Math.min(i.height(),this.image.height-h),n<1||a<1)return null;s.drawImage(this.image,p,h,n,a,o.left(),o.top(),n,a),this.projectionSource&&(c=n/this.scale,l=a/this.scale,s.save(),s.scale(this.scale,this.scale),s.globalAlpha=1-this.projectionTransparency/100,s.drawImage(this.projectionLayer(),p/this.scale,h/this.scale,c,l,o.left()/this.scale,o.top()/this.scale,c,l),s.restore(),this.version=Date.now()),c=n/this.scale,l=a/this.scale,s.save(),s.scale(this.scale,this.scale);try{s.drawImage(this.penTrails(),p/this.scale,h/this.scale,c,l,o.left()/this.scale,o.top()/this.scale,c,l)}catch(t){s.restore(),s.drawImage(this.penTrails(),0,0,this.dimensions.x,this.dimensions.y,this.left(),this.top(),this.dimensions.x*this.scale,this.dimensions.y*this.scale)}s.restore()}},StageMorph.prototype.clearPenTrails=function(){this.cachedPenTrailsMorph=null,this.trailsCanvas=newCanvas(this.dimensions),this.changed()},StageMorph.prototype.penTrails=function(){return this.trailsCanvas||(this.trailsCanvas=newCanvas(this.dimensions)),this.trailsCanvas},StageMorph.prototype.penTrailsMorph=function(){var t,e;return this.cachedPenTrailsMorph?this.cachedPenTrailsMorph:(t=new Morph,e=this.penTrails(),t.bounds=this.bounds.copy(),this.image.width===e.width?(t.image=e,t):(t.image=newCanvas(this.extent()),t.image.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,this.image.width,this.image.height),this.cachedPenTrailsMorph=t))},StageMorph.prototype.projectionLayer=function(){return this.projectionCanvas||(this.projectionCanvas=newCanvas(this.dimensions,!0)),this.projectionCanvas},StageMorph.prototype.clearProjectionLayer=function(){this.projectionCanvas=null,this.changed()},StageMorph.prototype.colorFiltered=function(t,e,o){var r,i,s,n,a=new Morph,p=this.extent(),h=this.thumbnail(p,e),c=normalizeCanvas(h,!0).getContext("2d").getImageData(0,0,p.x,p.y);for(a.bounds=this.bounds.copy(),a.image=newCanvas(p,!0),n=(r=a.image.getContext("2d")).createImageData(p.x,p.y),s=0;s<p.x*p.y*4;s+=4)i=new Color(c.data[s],c.data[s+1],c.data[s+2]),(o&&i.isCloseTo(t,!1,o)||i.eq(t))&&(n.data[s]=c.data[s],n.data[s+1]=c.data[s+1],n.data[s+2]=c.data[s+2],n.data[s+3]=255);return r.putImageData(n,0,0),a},StageMorph.prototype.startVideo=function(){var e=this;function o(){var t=new DialogBoxMorph;t.inform(localize("Camera not supported"),localize('Please make sure your web browser is up to date\nand your camera is properly configured. \n\nSome browsers also require you to access Snap!\nthrough HTTPS to use the camera.\n\nPlease replace the "http://" part of the address\nin your browser by "https://" and try again.'),this.world),t.fixLayout(),t.drawNew(),e.projectionSource&&(e.projectionSource.remove(),e.projectionSource=null)}this.projectionSource||(this.projectionSource=document.createElement("video"),this.projectionSource.width=this.dimensions.x,this.projectionSource.height=this.dimensions.y,this.projectionSource.hidden=!0,document.body.appendChild(this.projectionSource),this.videoMotion||(this.videoMotion=new VideoMotion(this.dimensions.x,this.dimensions.y)),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then(function(t){e.getProjectionImage=e.getVideoImage,e.stopProjectionSource=e.stopVideo,e.continuousProjection=!0,e.projectionSource.srcObject=t,e.projectionSource.play().catch(o),e.projectionSource.stream=t}).catch(o))},StageMorph.prototype.getVideoImage=function(){return this.projectionSource},StageMorph.prototype.stopVideo=function(){this.projectionSource&&this.projectionSource.stream&&this.projectionSource.stream.getTracks().forEach(function(t){t.stop()}),this.videoMotion=null},StageMorph.prototype.stopProjection=function(){this.projectionSource&&(this.stopProjectionSource(),this.projectionSource.remove(),this.projectionSource=null,this.continuousProjection=!1),this.clearProjectionLayer()},StageMorph.prototype.projectionSnap=function(){var t=newCanvas(this.dimensions,!0);return t.getContext("2d").drawImage(this.projectionLayer(),0,0),new Costume(t,this.newCostumeName(localize("snap")))},StageMorph.prototype.getPixelColor=function(t){var e,o;if(this.trailsCanvas)return e=t.subtract(this.bounds.origin),0===(o=this.penTrailsMorph().image.getContext("2d").getImageData(e.x,e.y,1,1)).data[3]?this.projectionCanvas?(e=e.divideBy(this.scale),o=this.projectionCanvas.getContext("2d").getImageData(e.x,e.y,1,1),new Color(o.data[0],o.data[1],o.data[2],o.data[3]/255)):StageMorph.uber.getPixelColor.call(this,t):new Color(o.data[0],o.data[1],o.data[2],o.data[3]/255)},StageMorph.prototype.watchers=function(e){return this.children.filter(function(t){return t instanceof WatcherMorph&&(e?t.left()===e:t.isVisible)})},StageMorph.prototype.resetTimer=function(){this.timerStart=Date.now()},StageMorph.prototype.getTimer=function(){return Math.floor((Date.now()-this.timerStart)/100)/10},StageMorph.prototype.setTempo=function(t){this.tempo=Math.max(20,+t||0)},StageMorph.prototype.changeTempo=function(t){this.setTempo(this.getTempo()+(+t||0))},StageMorph.prototype.getTempo=function(){return+this.tempo},StageMorph.prototype.getLastMessage=function(){return this.lastMessage||""},StageMorph.prototype.reportMouseX=function(){var t=this.world();return t?(t.hand.position().x-this.center().x)/this.scale:0},StageMorph.prototype.reportMouseY=function(){var t=this.world();return t?(this.center().y-t.hand.position().y)/this.scale:0},StageMorph.prototype.wantsDropOf=function(t){return t instanceof SpriteMorph||t instanceof WatcherMorph||t instanceof ListWatcherMorph||t instanceof SpriteIconMorph},StageMorph.prototype.reactToDropOf=function(t,e){t instanceof SpriteIconMorph&&(t.object.anchor&&t.object.anchor.detachPart(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin))},StageMorph.prototype.step=function(){var t,e,o=this.world();if(null===o.keyboardReceiver&&(o.keyboardReceiver=this),null===o.currentKey&&(this.keyPressed=null),this.enableCustomHatBlocks&&this.stepGenericConditions(),this.isFastTracked&&this.threads.processes.length){for(this.children.forEach(function(t){t instanceof SpriteMorph&&(t.wasWarped=t.isWarped,t.isWarped||t.startWarp())});Date.now()-this.lastTime<17;)this.threads.step();this.children.forEach(function(t){t instanceof SpriteMorph&&(t.wasWarped||t.endWarp())}),this.changed()}else this.threads.step(),this.threads.wantsToPause&&(e=this.parentThatIsA(IDE_Morph))&&e.controlBar.pauseButton.refresh();t=Date.now()-this.lastWatcherUpdate,1e3/this.watcherUpdateFrequency-t<1&&(this.watchers().forEach(function(t){t.update()}),this.lastWatcherUpdate=Date.now()),this.continuousProjection&&this.projectionSource&&this.updateProjection()},StageMorph.prototype.updateProjection=function(){var t=this.projectionLayer().getContext("2d");t.save(),this.mirrorVideo&&(t.translate(this.dimensions.x,0),t.scale(-1,1)),t.drawImage(this.getProjectionImage(),0,0,this.projectionSource.width,this.projectionSource.height),this.videoMotion&&this.videoMotion.addFrame(t.getImageData(0,0,this.projectionSource.width,this.projectionSource.height).data),t.restore(),this.changed()},StageMorph.prototype.stepGenericConditions=function(o){var t,r=0,i=this;this.children.concat(this).forEach(function(e){isSnapObject(e)&&e.allGenericHatBlocks().forEach(function(t){r+=1,i.threads.doWhen(t,e,o)})}),r||(this.enableCustomHatBlocks=!1,(t=this.parentThatIsA(IDE_Morph))&&t.controlBar.stopButton.refresh())},StageMorph.prototype.developersMenu=function(){var t=this,e=StageMorph.uber.developersMenu.call(this);return e.addItem("stop",function(){t.threads.stopAll()},"terminate all running threads"),e},StageMorph.prototype.processKeyDown=function(t){this.processKeyEvent(t,this.fireKeyEvent)},StageMorph.prototype.processKeyUp=function(t){this.processKeyEvent(t,this.removePressedKey)},StageMorph.prototype.processKeyEvent=function(t,e){var o;switch(t.keyCode){case 13:o="enter",t.ctrlKey||t.metaKey?o="ctrl enter":t.shiftKey&&(o="shift enter");break;case 27:o="esc";break;case 32:o="space";break;case 37:o="left arrow";break;case 39:o="right arrow";break;case 38:o="up arrow";break;case 40:o="down arrow";break;default:o=t.key||String.fromCharCode(t.keyCode||t.charCode),(t.ctrlKey||t.metaKey)&&(o="ctrl "+(t.shiftKey?"shift ":"")+o)}e.call(this,o)},StageMorph.prototype.fireKeyEvent=function(t){var o=t.toLowerCase(),r=[],e=this.parentThatIsA(IDE_Morph),i=this;if(this.keysPressed[o]=!0,"ctrl enter"===o&&!e.isAppMode)return this.fireGreenFlagEvent();if("shift enter"===o)return this.editScripts();if("ctrl f"!==o)if("ctrl z"!==o)if("ctrl shift z"!==o&&"ctrl y"!==o)if("ctrl n"!==o)if("ctrl o"!==o){if("ctrl s"!==o)return"ctrl shift s"===o?e.isAppMode?void 0:e.saveProjectsBrowser():"esc"!==o||e.isAppMode?(this.children.concat(this).forEach(function(e){isSnapObject(e)&&e.allHatBlocksForKey(o).forEach(function(t){r.push(i.threads.startProcess(t,e,!0))})}),r):this.fireStopAllEvent();e.isAppMode||e.save()}else e.isAppMode||e.openProjectsBrowser();else e.isAppMode||e.createNewProject();else e.isAppMode||e.currentSprite.scripts.redrop();else e.isAppMode||e.currentSprite.scripts.undrop();else e.isAppMode||e.currentSprite.searchBlocks()},StageMorph.prototype.removePressedKey=function(t){delete this.keysPressed[t.toLowerCase()]},StageMorph.prototype.processKeyPress=function(t){nop(t)},StageMorph.prototype.inspectKeyEvent=CursorMorph.prototype.inspectKeyEvent,StageMorph.prototype.fireGreenFlagEvent=function(){var o=[],t=this.parentThatIsA(IDE_Morph),r=this;return this.removeAllClones(),this.children.concat(this).forEach(function(e){isSnapObject(e)&&e.allHatBlocksFor("__shout__go__").forEach(function(t){o.push(r.threads.startProcess(t,e,r.isThreadSafe))})}),t&&t.controlBar.pauseButton.refresh(),o},StageMorph.prototype.fireStopAllEvent=function(){var t=this.parentThatIsA(IDE_Morph),e=this;this.threads.resumeAll(this.stage),this.runStopScripts(),this.keysPressed={},this.threads.stopAll(),this.stopAllActiveSounds(),this.children.forEach(function(t){t.stopTalking&&t.stopTalking()}),this.removeAllClones(),t&&t.nextSteps([nop,function(){e.stopAllActiveSounds()},function(){e.stopProjection()},function(){t.controlBar.pauseButton.refresh()}])},StageMorph.prototype.runStopScripts=function(){this.receiveUserInteraction("stopped",!0,!0),this.children.forEach(function(t){t instanceof SpriteMorph&&t.receiveUserInteraction("stopped",!0,!0)})},StageMorph.prototype.removeAllClones=function(){var e=this;this.children.filter(function(t){return t instanceof SpriteMorph&&t.isTemporary}).forEach(function(t){e.threads.stopAllForReceiver(t),t.detachFromAnchor(),t.corpsify(),t.destroy()}),this.cloneCount=0},StageMorph.prototype.editScripts=function(){var t,e;!this.parentThatIsA(IDE_Morph).isAppMode&&ScriptsMorph.prototype.enableKeyboard&&((t=this.parentThatIsA(IDE_Morph).currentSprite.scripts.selectForEdit()).edit(t.position()),(e=t.focus.sortedScripts()).length?(t.focus.element=e[0],t.focus.element instanceof HatBlockMorph&&t.focus.nextCommand()):t.focus.moveBy(new Point(50,50)),t.focus.fixLayout())},StageMorph.prototype.blockTemplates=function(t){var e,o,r,i=[],s=this,n=t||"motion";function a(t){if(s.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}function p(t,e){var o=SpriteMorph.prototype.variableBlock(t,e);return o.isDraggable=!1,o.isTemplate=!0,o}function h(t){if(s.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blocks[t];return new ToggleMorph("checkbox",this,function(){s.toggleWatcher(t,localize(e.spec),s.blockColor[e.category])},null,function(){return s.showingWatcher(t)},null)}function c(t){return new ToggleMorph("checkbox",this,function(){s.toggleVariableWatcher(t)},null,function(){return s.showingVariableWatcher(t)},null)}function l(t){t&&(s.isVariableNameInUse(t[0])?s.inform("that name is already in use"):(s.addVariable(t[0],t[1]),s.toggleVariableWatcher(t[0],t[1]),s.blocksCache[n]=null,s.paletteCache[n]=null,s.parentThatIsA(IDE_Morph).refreshPalette()))}return"motion"===n?((r=new TextMorph(localize("Stage selected:\nno motion primitives"))).fontSize=9,r.setColor(this.paletteTextColor),i.push(r),i.push("="),i.push(this.makeBlockButton(n))):"looks"===n?(i.push(a("doSwitchToCostume")),i.push(a("doWearNextCostume")),i.push(h("getCostumeIdx")),i.push(a("getCostumeIdx")),i.push("-"),i.push(a("reportGetImageAttribute")),i.push(a("reportNewCostumeStretched")),i.push("-"),i.push(a("changeEffect")),i.push(a("setEffect")),i.push(a("clearEffects")),i.push(a("getEffect")),i.push("-"),i.push(a("show")),i.push(a("hide")),i.push(h("reportShown")),i.push(a("reportShown")),this.world().isDevMode&&(i.push("-"),(r=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,r.setColor(this.paletteTextColor),i.push(r),i.push("-"),i.push(a("log")),i.push(a("alert")),i.push("-"),i.push(a("doScreenshot"))),i.push("="),i.push(this.makeBlockButton(n))):"sound"===n?(i.push(a("playSound")),i.push(a("doPlaySoundUntilDone")),i.push(a("doStopAllSounds")),i.push("-"),i.push(a("doPlaySoundAtRate")),i.push(a("reportGetSoundAttribute")),i.push("-"),i.push(a("doRest")),i.push(a("doPlayNote")),i.push(a("doSetInstrument")),i.push("-"),i.push(a("doChangeTempo")),i.push(a("doSetTempo")),i.push(h("getTempo")),i.push(a("getTempo")),i.push("-"),i.push(a("changeVolume")),i.push(a("setVolume")),i.push(h("getVolume")),i.push(a("getVolume")),i.push("-"),i.push(a("changePan")),i.push(a("setPan")),i.push(h("getPan")),i.push(a("getPan")),i.push("-"),i.push(a("playFreq")),i.push(a("stopFreq")),this.world().isDevMode&&(i.push("-"),(r=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,r.setColor(this.paletteTextColor),i.push(r),i.push("-"),i.push(a("doPlayFrequency"))),i.push("="),i.push(this.makeBlockButton(n))):"pen"===n?(i.push(a("clear")),i.push("-"),i.push(a("setBackgroundColor")),i.push(a("changeBackgroundHSVA")),i.push(a("setBackgroundHSVA")),i.push("-"),i.push(a("reportPenTrailsAsCostume")),i.push("="),i.push(this.makeBlockButton(n))):"control"===n?(i.push(a("receiveGo")),i.push(a("receiveKey")),i.push(a("receiveInteraction")),i.push(a("receiveCondition")),i.push(a("receiveMessage")),i.push("-"),i.push(a("doBroadcast")),i.push(a("doBroadcastAndWait")),i.push(h("getLastMessage")),i.push(a("getLastMessage")),i.push("-"),i.push(a("doWarp")),i.push("-"),i.push(a("doWait")),i.push(a("doWaitUntil")),i.push("-"),i.push(a("doForever")),i.push(a("doRepeat")),i.push(a("doUntil")),i.push(a("doFor")),i.push("-"),i.push(a("doIf")),i.push(a("doIfElse")),i.push(a("reportIfElse")),i.push("-"),i.push(a("doReport")),i.push(a("doStopThis")),i.push("-"),i.push(a("doRun")),i.push(a("fork")),i.push(a("evaluate")),i.push("-"),i.push(a("doTellTo")),i.push(a("reportAskFor")),i.push("-"),i.push(a("doCallCC")),i.push(a("reportCallCC")),i.push("-"),i.push(a("createClone")),i.push(a("newClone")),i.push("-"),i.push(a("doPauseAll")),i.push("="),i.push(this.makeBlockButton(n))):"sensing"===n?(i.push(a("doAsk")),i.push(h("getLastAnswer")),i.push(a("getLastAnswer")),i.push("-"),i.push(h("reportMouseX")),i.push(a("reportMouseX")),i.push(h("reportMouseY")),i.push(a("reportMouseY")),i.push(a("reportMouseDown")),i.push("-"),i.push(a("reportKeyPressed")),i.push("-"),i.push(a("reportAspect")),i.push("-"),i.push(a("doResetTimer")),i.push(h("getTimer")),i.push(a("getTimer")),i.push("-"),i.push(a("reportAttributeOf")),SpriteMorph.prototype.enableFirstClass&&i.push(a("reportGet")),i.push(a("reportObject")),i.push("-"),i.push(a("reportURL")),i.push(a("reportAudio")),i.push(a("reportVideo")),i.push(a("doSetVideoTransparency")),i.push("-"),i.push(a("reportGlobalFlag")),i.push(a("doSetGlobalFlag")),i.push("-"),i.push(a("reportDate")),this.world().isDevMode&&(i.push("-"),(r=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,r.setColor(this.paletteTextColor),i.push(r),i.push("-"),i.push(h("reportThreadCount")),i.push(a("reportThreadCount")),i.push(a("colorFiltered")),i.push(a("reportStackSize")),i.push(a("reportFrameCount"))),i.push("="),i.push(this.makeBlockButton(n))):"operators"===n?(i.push(a("reifyScript")),i.push(a("reifyReporter")),i.push(a("reifyPredicate")),i.push("#"),i.push("-"),i.push(a("reportSum")),i.push(a("reportDifference")),i.push(a("reportProduct")),i.push(a("reportQuotient")),i.push(a("reportPower")),i.push("-"),i.push(a("reportModulus")),i.push(a("reportRound")),i.push(a("reportMonadic")),i.push(a("reportRandom")),i.push("-"),i.push(a("reportLessThan")),i.push(a("reportEquals")),i.push(a("reportGreaterThan")),i.push("-"),i.push(a("reportAnd")),i.push(a("reportOr")),i.push(a("reportNot")),i.push(a("reportBoolean")),i.push("-"),i.push(a("reportJoinWords")),i.push(a("reportTextSplit")),i.push(a("reportLetter")),i.push(a("reportStringSize")),i.push("-"),i.push(a("reportUnicode")),i.push(a("reportUnicodeAsLetter")),i.push("-"),i.push(a("reportIsA")),i.push(a("reportIsIdentical")),i.push("-"),i.push(a("reportJSFunction")),Process.prototype.enableCompiling&&i.push(a("reportCompiled")),this.world().isDevMode&&(i.push("-"),(r=new TextMorph("development mode \ndebugging primitives:")).fontSize=9,r.setColor(this.paletteTextColor),i.push(r),i.push("-"),i.push(a("reportTypeOf")),i.push(a("reportTextFunction"))),i.push("="),i.push(this.makeBlockButton(n))):"variables"===n?(o=new PushButtonMorph(null,function(){new VariableDialogMorph(null,l,s).prompt("Variable name",null,s.world())},"Make a variable"),i.push(o),0<this.variables.allNames().length&&(o=new PushButtonMorph(null,function(){var e=new MenuMorph(s.deleteVariable,null,s);s.variables.allNames().forEach(function(t){e.addItem(t,t)}),e.popUpAtHand(s.world())},"Delete a variable"),i.push(o)),i.push("-"),0<(e=this.reachableGlobalVariableNames(!0)).length&&(e.forEach(function(t){i.push(c(t)),i.push(p(t))}),i.push("-")),0<(e=this.allLocalVariableNames(!0)).length&&(e.forEach(function(t){i.push(c(t)),i.push(p(t,!0))}),i.push("-")),i.push(a("doSetVar")),i.push(a("doChangeVar")),i.push(a("doShowVar")),i.push(a("doHideVar")),i.push(a("doDeclareVariables")),i.push("="),i.push(a("reportNewList")),i.push(a("reportNumbers")),i.push("-"),i.push(a("reportCONS")),i.push(a("reportListItem")),i.push(a("reportCDR")),i.push("-"),i.push(a("reportListLength")),i.push(a("reportListContainsItem")),i.push(a("reportListIsEmpty")),i.push("-"),i.push(a("reportMap")),i.push(a("reportKeep")),i.push(a("reportFindFirst")),i.push(a("reportCombine")),i.push("-"),i.push(a("doForEach")),i.push("-"),i.push(a("doAddToList")),i.push(a("doDeleteFromList")),i.push(a("doInsertInList")),i.push(a("doReplaceInList")),this.world().isDevMode&&(i.push("-"),(r=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,r.setColor(this.paletteTextColor),i.push(r),i.push("-"),i.push(a("doShowTable"))),i.push("="),StageMorph.prototype.enableCodeMapping&&(i.push(a("doMapCodeOrHeader")),i.push(a("doMapValueCode")),i.push(a("doMapListCode")),i.push("-"),i.push(a("reportMappedCode")),i.push("=")),i.push(this.makeBlockButton())):"eBrain"===n?(i.push(a("evebrainGpio")),i.push(a("evebrainDigital_read")),i.push("-"),i.push("-"),i.push(a("evebrainMotorDriver")),i.push(a("evebrainMotorDriverBoth")),i.push("-"),i.push("-"),i.push(a("evebrainGpio_pwm")),i.push(a("evebrainGpio_read")),i.push("-"),i.push("-"),i.push("-"),i.push("-"),i.push(a("evebrainDistance_read")),i.push(a("evebrainPlayNote")),i.push(a("evebrainServo")),i.push(a("evebrainTemperature")),i.push(a("evebrainHumidity")),i.push(a("evebrainGpio_readAnalog"))):"Robot"===n&&(i.push(a("mirobotForward")),i.push(a("mirobotBack")),i.push(a("mirobotLeft")),i.push(a("mirobotRight")),i.push(a("mirobotStop"))),i},StageMorph.prototype.clear=function(){this.clearPenTrails()},StageMorph.prototype.userMenu=function(){var e=this.parentThatIsA(IDE_Morph),t=new MenuMorph(this),o=this;return e&&e.isAppMode||(t.addItem("edit","edit"),t.addItem("show all","showAll"),t.addItem("pic...",function(){e.saveCanvasAs(o.fullImageClassic(),o.name)},"open a new window\nwith a picture of the stage"),t.addLine(),t.addItem("pen trails",function(){var t=e.currentSprite.reportPenTrailsAsCostume().copy();e.currentSprite.addCostume(t),e.currentSprite.wearCostume(t),e.hasChangedMedia=!0,e.spriteBar.tabBar.tabTo("costumes")},e.currentSprite instanceof SpriteMorph?"turn all pen trails and stamps\ninto a new costume for the\ncurrently selected sprite":"turn all pen trails and stamps\ninto a new background for the stage")),t},StageMorph.prototype.showAll=function(){var e=this;this.children.forEach(function(t){t instanceof SpriteMorph?t.anchor||(t.show(),t.keepWithin(e)):(t.show(),t.keepWithin(e),t.fixLayout&&t.fixLayout())})},StageMorph.prototype.edit=SpriteMorph.prototype.edit,StageMorph.prototype.thumbnail=function(t,e){var o,r,i=this,s=this.image,n=Math.min(t.x/s.width,t.y/s.height),a=newCanvas(t),p=a.getContext("2d");return p.scale(n,n),p.drawImage(s,0,0),p.drawImage(this.penTrails(),0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale),this.projectionSource&&(p.save(),p.globalAlpha=1-this.projectionTransparency/100,p.drawImage(this.projectionLayer(),0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale),p.restore()),this.children.forEach(function(t){t.isVisible&&t!==e&&(o=t.fullBounds(),(r=t.fullImage()).width&&r.height&&p.drawImage(t.fullImage(),o.origin.x-i.bounds.origin.x,o.origin.y-i.bounds.origin.y))}),a},StageMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},StageMorph.prototype.show=function(){this.isVisible=!0,this.changed()},StageMorph.prototype.reportShown=SpriteMorph.prototype.reportShown,StageMorph.prototype.createClone=nop,StageMorph.prototype.newClone=nop,StageMorph.prototype.setColorComponentHSVA=function(t,e){var o=+e;(t=+t)<0||3<t||(0==t?(o<0||100<o)&&(o=(o<0?100:0)+o%100):o=Math.min(100,Math.max(0,o)),3===t?this.color.a=1-o/100:(this.cachedHSV[t]=o/100,this.color.set_hsv.apply(this.color,this.cachedHSV)),this.drawNew(),this.changed())},StageMorph.prototype.getColorComponentHSLA=SpriteMorph.prototype.getColorComponentHSLA,StageMorph.prototype.changeColorComponentHSVA=SpriteMorph.prototype.changeColorComponentHSVA,StageMorph.prototype.setColor=function(t){this.color.eq(t,!0)||(this.color=t.copy(),this.drawNew(),this.changed(),this.cachedHSV=this.color.hsv())},StageMorph.prototype.setBackgroundColor=StageMorph.prototype.setColor,StageMorph.prototype.getPenAttribute=SpriteMorph.prototype.getPenAttribute,StageMorph.prototype.categories=SpriteMorph.prototype.categories,StageMorph.prototype.blockColor=SpriteMorph.prototype.blockColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,StageMorph.prototype.setName=SpriteMorph.prototype.setName,StageMorph.prototype.makeBlockButton=SpriteMorph.prototype.makeBlockButton,StageMorph.prototype.makeBlock=SpriteMorph.prototype.makeBlock,StageMorph.prototype.palette=SpriteMorph.prototype.palette,StageMorph.prototype.freshPalette=SpriteMorph.prototype.freshPalette,StageMorph.prototype.blocksMatching=SpriteMorph.prototype.blocksMatching,StageMorph.prototype.searchBlocks=SpriteMorph.prototype.searchBlocks,StageMorph.prototype.reporterize=SpriteMorph.prototype.reporterize,StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher,StageMorph.prototype.addVariable=SpriteMorph.prototype.addVariable,StageMorph.prototype.deleteVariable=SpriteMorph.prototype.deleteVariable,StageMorph.prototype.doScreenshot=SpriteMorph.prototype.doScreenshot,StageMorph.prototype.newCostumeName=SpriteMorph.prototype.newCostumeName,StageMorph.prototype.blockForSelector=SpriteMorph.prototype.blockForSelector,StageMorph.prototype.findVariableWatcher=SpriteMorph.prototype.findVariableWatcher,StageMorph.prototype.toggleVariableWatcher=SpriteMorph.prototype.toggleVariableWatcher,StageMorph.prototype.showingVariableWatcher=SpriteMorph.prototype.showingVariableWatcher,StageMorph.prototype.deleteVariableWatcher=SpriteMorph.prototype.deleteVariableWatcher,StageMorph.prototype.addCostume=SpriteMorph.prototype.addCostume,StageMorph.prototype.wearCostume=SpriteMorph.prototype.wearCostume,StageMorph.prototype.getCostumeIdx=SpriteMorph.prototype.getCostumeIdx,StageMorph.prototype.doWearNextCostume=SpriteMorph.prototype.doWearNextCostume,StageMorph.prototype.doWearPreviousCostume=SpriteMorph.prototype.doWearPreviousCostume,StageMorph.prototype.doSwitchToCostume=SpriteMorph.prototype.doSwitchToCostume,StageMorph.prototype.reportCostumes=SpriteMorph.prototype.reportCostumes,StageMorph.prototype.graphicsChanged=SpriteMorph.prototype.graphicsChanged,StageMorph.prototype.applyGraphicsEffects=SpriteMorph.prototype.applyGraphicsEffects,StageMorph.prototype.setEffect=SpriteMorph.prototype.setEffect,StageMorph.prototype.getEffect=SpriteMorph.prototype.getEffect,StageMorph.prototype.getGhostEffect=SpriteMorph.prototype.getGhostEffect,StageMorph.prototype.changeEffect=SpriteMorph.prototype.changeEffect,StageMorph.prototype.clearEffects=SpriteMorph.prototype.clearEffects,StageMorph.prototype.addSound=SpriteMorph.prototype.addSound,StageMorph.prototype.doPlaySound=SpriteMorph.prototype.doPlaySound,StageMorph.prototype.stopAllActiveSounds=function(){this.activeSounds.forEach(function(t){t.pause()}),this.activeSounds=[],this.microphone.modifier&&this.microphone.isReady&&this.microphone.stop()},StageMorph.prototype.pauseAllActiveSounds=function(){this.activeSounds.forEach(function(t){t.pause()})},StageMorph.prototype.resumeAllActiveSounds=function(){this.activeSounds.forEach(function(t){t.play()})},StageMorph.prototype.reportSounds=SpriteMorph.prototype.reportSounds,StageMorph.prototype.setVolume=SpriteMorph.prototype.setVolume,StageMorph.prototype.changeVolume=SpriteMorph.prototype.changeVolume,StageMorph.prototype.getVolume=SpriteMorph.prototype.getVolume,StageMorph.prototype.getGainNode=SpriteMorph.prototype.getGainNode,StageMorph.prototype.audioContext=SpriteMorph.prototype.audioContext,StageMorph.prototype.setPan=SpriteMorph.prototype.setPan,StageMorph.prototype.changePan=SpriteMorph.prototype.changePan,StageMorph.prototype.getPan=SpriteMorph.prototype.getPan,StageMorph.prototype.getPannerNode=SpriteMorph.prototype.getPannerNode,StageMorph.prototype.playFreq=SpriteMorph.prototype.playFreq,StageMorph.prototype.stopFreq=SpriteMorph.prototype.stopFreq,StageMorph.prototype.toggleWatcher=SpriteMorph.prototype.toggleWatcher,StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher,StageMorph.prototype.watcherFor=SpriteMorph.prototype.watcherFor,StageMorph.prototype.getLastAnswer=SpriteMorph.prototype.getLastAnswer,StageMorph.prototype.reportThreadCount=SpriteMorph.prototype.reportThreadCount,StageMorph.prototype.allMessageNames=SpriteMorph.prototype.allMessageNames,StageMorph.prototype.allHatBlocksFor=SpriteMorph.prototype.allHatBlocksFor,StageMorph.prototype.allHatBlocksForKey=SpriteMorph.prototype.allHatBlocksForKey,StageMorph.prototype.allHatBlocksForInteraction=SpriteMorph.prototype.allHatBlocksForInteraction,StageMorph.prototype.allGenericHatBlocks=SpriteMorph.prototype.allGenericHatBlocks,StageMorph.prototype.mouseClickLeft=SpriteMorph.prototype.mouseClickLeft,StageMorph.prototype.mouseEnter=SpriteMorph.prototype.mouseEnter,StageMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed")},StageMorph.prototype.mouseDownLeft=SpriteMorph.prototype.mouseDownLeft,StageMorph.prototype.mouseScroll=SpriteMorph.prototype.mouseScroll,StageMorph.prototype.receiveUserInteraction=SpriteMorph.prototype.receiveUserInteraction,StageMorph.prototype.deleteAllBlockInstances=SpriteMorph.prototype.deleteAllBlockInstances,StageMorph.prototype.allBlockInstances=SpriteMorph.prototype.allBlockInstances,StageMorph.prototype.allLocalBlockInstances=SpriteMorph.prototype.allLocalBlockInstances,StageMorph.prototype.allEditorBlockInstances=SpriteMorph.prototype.allEditorBlockInstances,StageMorph.prototype.paletteBlockInstance=SpriteMorph.prototype.paletteBlockInstance,StageMorph.prototype.usesBlockInstance=SpriteMorph.prototype.usesBlockInstance,StageMorph.prototype.doubleDefinitionsFor=SpriteMorph.prototype.doubleDefinitionsFor,StageMorph.prototype.replaceDoubleDefinitionsFor=SpriteMorph.prototype.replaceDoubleDefinitionsFor,StageMorph.prototype.allInvocationsOf=SpriteMorph.prototype.allInvocationsOf,StageMorph.prototype.allIndependentInvocationsOf=SpriteMorph.prototype.allInvocationsOf,StageMorph.prototype.allDependentInvocationsOf=SpriteMorph.prototype.allInvocationsOf,StageMorph.prototype.specimens=function(){return[]},StageMorph.prototype.allSpecimens=function(){return[]},StageMorph.prototype.shadowAttribute=nop,StageMorph.prototype.inheritsAttribute=function(){return!1},StageMorph.prototype.isVariableNameInUse=SpriteMorph.prototype.isVariableNameInUse,StageMorph.prototype.globalVariables=SpriteMorph.prototype.globalVariables,StageMorph.prototype.inheritedVariableNames=function(){return[]},StageMorph.prototype.allLocalVariableNames=SpriteMorph.prototype.allLocalVariableNames,StageMorph.prototype.reachableGlobalVariableNames=SpriteMorph.prototype.reachableGlobalVariableNames,StageMorph.prototype.getMethod=SpriteMorph.prototype.getMethod,StageMorph.prototype.getLocalMethod=SpriteMorph.prototype.getLocalMethod,StageMorph.prototype.ownBlocks=SpriteMorph.prototype.ownBlocks,StageMorph.prototype.allBlocks=function(t){var e=this.ownBlocks();return t?Object.keys(e).map(function(t){return e[t]}):e},StageMorph.prototype.inheritedBlocks=function(){return[]},StageMorph.prototype.hasSpriteVariable=SpriteMorph.prototype.hasSpriteVariable,StageMorph.prototype.refactorVariableInstances=SpriteMorph.prototype.refactorVariableInstances,StageMorph.prototype.reportPenTrailsAsCostume=function(){return new Costume(this.trailsCanvas,this.newCostumeName(localize("Background")))},SpriteBubbleMorph.prototype=new SpeechBubbleMorph,(SpriteBubbleMorph.prototype.constructor=SpriteBubbleMorph).uber=SpeechBubbleMorph.prototype,SpriteBubbleMorph.prototype.init=function(t,e,o,r){var i=SpriteMorph.prototype;this.stage=e,this.scale=e?e.scale:1,this.data=t,this.isQuestion=r,SpriteBubbleMorph.uber.init.call(this,this.dataAsMorph(t),i.bubbleColor,null,null,r?i.blockColor.sensing:i.bubbleBorderColor,null,o)},SpriteBubbleMorph.prototype.dataAsMorph=function(t,e){var o,r,i,s,n,a=SpriteMorph.prototype;return t instanceof Morph?isSnapObject(t)?(i=t.thumbnail(new Point(40,40)),(o=new Morph).silentSetWidth(i.width),o.silentSetHeight(i.height),o.image=i,o.version=t.version,o.step=function(){this.version!==t.version&&(i=t.thumbnail(new Point(40,40)),this.image=i,this.version=t.version,this.changed())}):o=t:isString(t)?(r=!0,o=new TextMorph(t,a.bubbleFontSize*this.scale,null,a.bubbleFontIsBold,!1,"center")):"boolean"==typeof t?(i=a.booleanMorph(t).fullImage(),(o=new Morph).silentSetWidth(i.width),o.silentSetHeight(i.height),o.image=i):t instanceof Costume?(i=t.thumbnail(new Point(40,40)),(o=new Morph).silentSetWidth(i.width),o.silentSetHeight(i.height),o.image=i):t instanceof Sound?o=new SymbolMorph("notes",30):t instanceof HTMLCanvasElement?((o=new Morph).silentSetWidth(t.width),o.silentSetHeight(t.height),o.image=t):t instanceof List?((e&&this.contentsMorph?this.contentsMorph instanceof ListWatcherMorph:t.isTable())?o=new TableFrameMorph(new TableMorph(t,10)):((o=new ListWatcherMorph(t)).update(!0),o.step=o.update),this.stage&&o.expand(this.stage.extent().translateBy(-2*(this.edge+this.border+this.padding))),o.isDraggable=!1):t instanceof Context?(i=t.image(),(o=new Morph).silentSetWidth(i.width),o.silentSetHeight(i.height),o.image=i):o=new TextMorph(t.toString(),a.bubbleFontSize*this.scale,null,a.bubbleFontIsBold,!1,"center"),o instanceof TextMorph?(n=Math.max(o.width(),2*a.bubbleCorner*this.scale),r&&(n=Math.min(n,a.bubbleMaxTextWidth*this.scale)),o.setWidth(n)):t instanceof List||((s=newCanvas(o.extent().multiplyBy(this.scale))).getContext("2d").drawImage(o.image,0,0,s.width,s.height),o.image=s,o.bounds=o.bounds.scaleBy(this.scale)),o},SpriteBubbleMorph.prototype.setScale=function(t){this.scale=t,this.changed(),this.drawNew(),this.changed()},SpriteBubbleMorph.prototype.drawNew=function(t){var e=SpriteMorph.prototype;this.edge=e.bubbleCorner*this.scale,this.border=e.bubbleBorder*this.scale,this.padding=e.bubbleCorner/2*this.scale,this.contentsMorph&&this.contentsMorph.destroy(),this.contentsMorph=this.dataAsMorph(this.data,t),this.add(this.contentsMorph),this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))},SpriteBubbleMorph.prototype.fixLayout=function(){var t=SpriteMorph.prototype;this.changed(),this.edge=t.bubbleCorner*this.scale,this.border=t.bubbleBorder*this.scale,this.padding=t.bubbleCorner/2*this.scale,this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1))),this.changed()},Costume.prototype.maxExtent=function(){return StageMorph.prototype.dimensions},Costume.prototype.toString=function(){return"a Costume("+this.name+")"},Costume.prototype.extent=function(){return new Point(this.contents.width,this.contents.height)},Costume.prototype.center=function(){return this.extent().divideBy(2)},Costume.prototype.width=function(){return this.contents.width},Costume.prototype.height=function(){return this.contents.height},Costume.prototype.bounds=function(){return new Rectangle(0,0,this.width(),this.height())},Costume.prototype.shrinkWrap=function(){var t=this.boundingBox(),e=t.extent(),o=newCanvas(e,!0);o.getContext("2d").drawImage(this.contents,t.origin.x,t.origin.y,e.x,e.y,0,0,e.x,e.y),this.rotationCenter=this.rotationCenter.subtract(t.origin),this.contents=o,this.version=Date.now()},Costume.prototype.canvasBoundingBox=function(t){var e,o,r=t.width,i=t.height,s=t.getContext("2d").getImageData(0,0,r,i);function n(t,e){return s.data[e*r*4+4*t+3]}return new Rectangle(function(){for(o=0;o<=r;o+=1)for(e=0;e<=i;e+=1)if(n(o,e))return o;return 0}(),function(){for(e=0;e<=i;e+=1)for(o=0;o<=r;o+=1)if(n(o,e))return e;return 0}(),function(){for(o=r;0<=o;--o)for(e=i;0<=e;--e)if(n(o,e))return Math.min(o+1,r);return r}(),function(){for(e=i;0<=e;--e)for(o=r;0<=o;--o)if(n(o,e))return Math.min(e+1,i);return i}())},Costume.prototype.boundingBox=function(){return this.canvasBoundingBox(this.contents)},Costume.prototype.copy=function(){var t,e=newCanvas(this.extent(),!0);return e.getContext("2d").drawImage(this.contents,0,0),(t=new Costume(e,this.name?copy(this.name):null)).rotationCenter=this.rotationCenter.copy(),t},Costume.prototype.flipped=function(){var t=newCanvas(this.extent(),!0),e=t.getContext("2d");return e.translate(this.width(),0),e.scale(-1,1),e.drawImage(this.contents,0,0),new Costume(t,this.name,new Point(this.width()-this.rotationCenter.x,this.rotationCenter.y))},Costume.prototype.stretched=function(t,e){t=(Math.sign(t)||1)*Math.max(1,Math.abs(t)),e=(Math.sign(e)||1)*Math.max(1,Math.abs(e));var o=newCanvas(new Point(Math.abs(t),Math.abs(e)),!0),r=o.getContext("2d"),i=t/this.width(),s=e/this.height(),n=this.rotationCenter.multiplyBy(new Point(i,s));return i<0&&(n.x=o.width-Math.abs(n.x)),s<0&&(n.y=o.height-Math.abs(n.y)),r.translate(Math.abs(Math.min(t,0)),Math.abs(Math.min(e,0))),r.scale(i,s),r.drawImage(this.contents,0,0),new Costume(o,this.name,n)},Costume.prototype.edit=function(o,r,t,e,i){var s=this,n=new PaintEditorMorph;n.oncancel=e||nop,n.openIn(o,t?newCanvas(StageMorph.prototype.dimensions,!0):this.contents,t?null:this.rotationCenter,function(t,e){s.contents=t,s.rotationCenter=e,s.version=Date.now(),o.changed(),r&&(r.currentSprite instanceof SpriteMorph&&s.shrinkWrap(),r.currentSprite.wearCostume(s,!0),r.hasChangedMedia=!0),(i||nop)()},r)},Costume.prototype.editRotationPointOnly=function(t){var e=new CostumeEditorMorph(this),o=new DialogBoxMorph(this,function(){e.accept()}),r=new TextMorph(localize("click or drag crosshairs to move the rotation center"),o.fontSize,o.fontStyle,!0,!1,"center",null,null,new Point(1,1),new Color(255,255,255));o.labelString="Costume Editor",o.createLabel(),o.setPicture(e),o.addBody(r),o.addButton("ok","Ok"),o.addButton("cancel","Cancel"),o.fixLayout(),o.drawNew(),o.fixLayout(),o.popUp(t)},Costume.prototype.shrinkToFit=function(t){(t.x<this.width()||t.y<this.height())&&(this.contents=this.thumbnail(t))},Costume.prototype.thumbnail=function(t){var e=this.contents,o=Math.min(t.x/e.width,t.y/e.height),r=(t.x-e.width*o)/2,i=(t.y-e.height*o)/2,s=newCanvas(t),n=s.getContext("2d");return e&&e.width+e.height!==0&&(n.scale(o,o),n.drawImage(e,Math.floor(r/o),Math.floor(i/o))),s},Costume.prototype.rasterized=function(){return this},Costume.prototype.pixels=function(){var t,e,o=[];if(!this.contents.width||!this.contents.height)return o;for(t=this.contents.getContext("2d").getImageData(0,0,this.contents.width,this.contents.height),e=0;e<t.data.length;e+=4)o.push(new List([t.data[e],t.data[e+1],t.data[e+2],t.data[e+3]]));return new List(o)},Costume.prototype.isTainted=function(){try{this.contents.getContext("2d").getImageData(0,0,this.contents.width,this.contents.height)}catch(t){return!0}return!1},SVG_Costume.prototype=new Costume,(SVG_Costume.prototype.constructor=SVG_Costume).uber=Costume.prototype,SVG_Costume.prototype.toString=function(){return"an SVG_Costume("+this.name+")"},SVG_Costume.prototype.copy=function(){var t,e=new Image;return e.src=this.contents.src,(t=new SVG_Costume(e,this.name?copy(this.name):null)).rotationCenter=this.rotationCenter.copy(),t.shapes=this.shapes.map(function(t){return t.copy()}),t},SVG_Costume.prototype.shrinkToFit=function(t){nop(t)},SVG_Costume.prototype.parseShapes=function(){var t=new XML_Element,e=this.contents.src.replace(/^data:image\/.*?, */,"");-1<this.contents.src.indexOf("base64")&&(e=atob(e)),t.parseString(e),0===this.shapes.length&&t.attributes.snap&&(this.shapes=t.children.map(function(t){return window[t.attributes.prototype].fromSVG(t)}))},SVG_Costume.prototype.edit=function(r,i,s,t,n){var a=this,e=new VectorPaintEditorMorph;e.oncancel=t||nop,e.openIn(r,s?newCanvas(StageMorph.prototype.dimensions):this.contents,s?new Point(240,180):a.rotationCenter,function(t,e,o){a.contents=t,a.rotationCenter=e,a.shapes=o,a.version=Date.now(),r.changed(),i&&(s&&i.currentSprite.addCostume(a),i.currentSprite.wearCostume(a),i.hasChangedMedia=!0),(n||nop)()},i,this.shapes||[])},SVG_Costume.prototype.rasterized=function(){var t=newCanvas(this.extent(),!0);return t.getContext("2d").drawImage(this.contents,0,0),new Costume(t,this.name,this.rotationCenter.copy())},CostumeEditorMorph.prototype=new Morph,(CostumeEditorMorph.prototype.constructor=CostumeEditorMorph).uber=Morph.prototype,CostumeEditorMorph.prototype.size=Costume.prototype.maxExtent(),CostumeEditorMorph.prototype.init=function(t){this.costume=t||new Costume,this.rotationCenter=this.costume.rotationCenter.copy(),this.margin=new Point(0,0),CostumeEditorMorph.uber.init.call(this),this.noticesTransparentClick=!0},CostumeEditorMorph.prototype.accept=function(){this.costume.rotationCenter=this.rotationCenter.copy(),this.costume.version=Date.now()},CostumeEditorMorph.prototype.drawNew=function(){var t,e;this.margin=this.size.subtract(this.costume.extent()).divideBy(2),t=this.rotationCenter.add(this.margin),this.silentSetExtent(this.size),this.image=newCanvas(this.extent()),this.cachedTexture||(this.cachedTexture=this.createTexture()),this.drawCachedTexture(),(e=this.image.getContext("2d")).drawImage(this.costume.contents,this.margin.x,this.margin.y),e.globalAlpha=.5,e.fillStyle="white",e.beginPath(),e.arc(t.x,t.y,20,radians(0),radians(360),!1),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.arc(t.x,t.y,10,radians(0),radians(360),!1),e.stroke(),e.beginPath(),e.moveTo(0,t.y),e.lineTo(this.costume.width()+2*this.margin.x,t.y),e.stroke(),e.beginPath(),e.moveTo(t.x,0),e.lineTo(t.x,this.costume.height()+2*this.margin.y),e.stroke()},CostumeEditorMorph.prototype.createTexture=function(){var t=newCanvas(new Point(10,10)),e=t.getContext("2d"),o=new Color(230,230,230);return e.fillStyle="white",e.fillRect(0,0,10,10),e.fillStyle=o.toString(),e.fillRect(0,0,5,5),e.fillRect(5,5,5,5),t},CostumeEditorMorph.prototype.mouseDownLeft=function(t){this.rotationCenter=t.subtract(this.position().add(this.margin)),this.drawNew(),this.changed()},CostumeEditorMorph.prototype.mouseMove=CostumeEditorMorph.prototype.mouseDownLeft,Sound.prototype.play=function(){var t=document.createElement("audio");return t.src=this.audio.src,t.play(),t},Sound.prototype.copy=function(){var t=document.createElement("audio");return t.src=this.audio.src,new Sound(t,this.name?copy(this.name):null)},Sound.prototype.toDataURL=function(){return this.audio.src},Note.prototype.audioContext=null,Note.prototype.fadeIn=new Float32Array(2),Note.prototype.fadeIn[0]=[0],Note.prototype.fadeIn[1]=[1],Note.prototype.fadeOut=new Float32Array(2),Note.prototype.fadeOut[0]=[1],Note.prototype.fadeOut[1]=[0],Note.prototype.fadeTime=.005,Note.prototype.setupContext=function(){if(!this.audioContext){var t,e=((t=window.AudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext||window.webkitAudioContext).prototype.createGain||(t.prototype.createGain=t.prototype.createGainNode),t);if(!e)throw new Error("Web Audio API is not supported\nin this browser");Note.prototype.audioContext=new e}},Note.prototype.getAudioContext=function(){return this.audioContext||this.setupContext(),this.audioContext},Note.prototype.play=function(t,e,o){e=e||this.audioContext.createGain(),this.fader=this.audioContext.createGain(),this.oscillator=this.audioContext.createOscillator(),this.oscillator.start||(this.oscillator.start=this.oscillator.noteOn),this.oscillator.stop||(this.oscillator.stop=this.oscillator.noteOff),this.setInstrument(t),this.oscillator.frequency.value=isNil(this.frequency)?440*Math.pow(2,(this.pitch-69)/12):this.frequency,this.oscillator.connect(this.fader),this.fader.connect(e),o?(e.connect(o),o.connect(this.audioContext.destination)):e.connect(this.audioContext.destination),this.ended=!1,this.fader.gain.setValueCurveAtTime(this.fadeIn,this.audioContext.currentTime,this.fadeTime),this.oscillator.start(0)},Note.prototype.setInstrument=function(t){this.oscillator&&(this.oscillator.type=["sine","square","sawtooth","triangle"][(t||1)-1])},Note.prototype.stop=function(t){var e=!t;if(t&&this.oscillator)this.oscillator.stop(0);else{if(this.fader)try{this.fader.gain.setValueCurveAtTime(this.fadeOut,this.audioContext.currentTime,this.fadeTime)}catch(t){e=!1}this.oscillator&&(this.oscillator.stop(e?this.audioContext.currentTime+this.fadeTime:0),this.oscillator=null),this.ended=!0}},Note.prototype.pause=function(){this.stop()},Microphone.prototype.isOn=function(){return this.isReady?(this.lastTime=Date.now(),!0):(this.start(),!1)},Microphone.prototype.binSizes=[256,512,1024,2048,4096],Microphone.prototype.binSize=function(){return this.binSizes[this.resolution-1]},Microphone.prototype.setResolution=function(t){contains([1,2,3,4],t)&&(this.isReady&&this.stop(),this.resolution=t)},Microphone.prototype.start=function(){var e=this;this.isStarted||(this.isStarted=!0,this.isReady=!1,this.audioContext=Note.prototype.getAudioContext(),navigator.mediaDevices.getUserMedia({audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"},optional:[]}}).then(function(t){e.setupNodes(t)}).catch(nop))},Microphone.prototype.stop=function(){this.processor.onaudioprocess=null,this.sourceStream.getTracks().forEach(function(t){t.stop()}),this.processor.disconnect(),this.analyser.disconnect(),this.processor=null,this.analyser=null,this.audioContext=null,this.isReady=!1,this.isStarted=!1},Microphone.prototype.setupNodes=function(t){this.sourceStream=t,this.createProcessor(),this.createAnalyser(),this.analyser.connect(this.processor),this.processor.connect(this.audioContext.destination),this.audioContext.createMediaStreamSource(t).connect(this.analyser),this.lastTime=Date.now()},Microphone.prototype.createAnalyser=function(){var t;this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.binSizes[this.resolution],t=this.analyser.frequencyBinCount,this.frequencies=new Uint8Array(t),this.correlations=new Array(Math.floor(t/2))},Microphone.prototype.createProcessor=function(){var e=this;this.processor=this.audioContext.createScriptProcessor(this.binSizes[this.resolution-1]),this.processor.onaudioprocess=function(t){e.stepAudio(t)},this.processor.clipping=!1,this.processor.lastClip=0,this.processor.clipLevel=.98,this.processor.averaging=.95,this.processor.clipLag=750},Microphone.prototype.stepAudio=function(t){var e,o;if(this.isAutoStop&&5e3<Date.now()-this.lastTime&&!this.modifier)this.stop();else{if(this.signals=t.inputBuffer.getChannelData(0),this.modifier){for(e=t.outputBuffer.numberOfChannels,this.outChannels.length!==e&&(this.outChannels=new Array(e)),o=0;o<e;o+=1)this.outChannels[o]=t.outputBuffer.getChannelData(o);this.output=this.outChannels[0]}else this.output=t.outputBuffer.getChannelData(0);this.analyser.getByteFrequencyData(this.frequencies),this.pitch=this.detectPitchAndVolume(this.signals,this.audioContext.sampleRate),0<this.pitch&&(this.note=Math.round(Math.log(this.pitch/440)/Math.log(2)*12)+69),this.isReady=!0,this.isStarted=!1}},Microphone.prototype.detectPitchAndVolume=function(t,e){for(var o,r,i,s,n,a,p=t.length,h=Math.floor(p/2),c=-1,l=0,u=0,d=!1,g=this.correlations,y=this.outChannels.length,f=0;f<p;f+=1)if(n=t[f],Math.abs(n)>=this.processor.clipLevel&&(this.processor.clipping=!0,this.processor.lastClip=window.performance.now()),u+=n*n,this.modifier)for(this.wrapper.contents[0]=n,a=invoke(this.compiledModifier,this.wrapper,null,null,null,null,this.compilerProcess),s=0;s<y;s+=1)this.outChannels[s][f]=a;if(u=Math.sqrt(u/p),this.volume=Math.max(u,this.volume*this.processor.averaging),u<.01)return this.pitch;for(i=r=1;i<h;i+=1){for(f=o=0;f<h;f+=1)o+=Math.abs(t[f]-t[f+i]);if(o=1-o/h,(g[i]=o)>this.GOOD_ENOUGH_CORRELATION&&r<o)d=!0,l<o&&(l=o,c=i);else if(d)return e/(c+8*((g[c+1]-g[c-1])/g[c]));r=o}return.01<l?e/c:this.pitch},CellMorph.prototype=new BoxMorph,(CellMorph.prototype.constructor=CellMorph).uber=BoxMorph.prototype,CellMorph.prototype.init=function(t,e,o,r){this.contents=0===t?0:!1!==t&&(t||""),this.isEditable=!isNil(o),this.idx=o||null,this.parentCell=r||null,CellMorph.uber.init.call(this,SyntaxElementMorph.prototype.corner,1.000001,new Color(255,255,255)),this.color=e||new Color(255,140,0),this.isBig=!1,this.version=null,this.drawNew()},CellMorph.prototype.big=function(){this.isBig=!0,this.changed(),this.drawNew(),this.changed()},CellMorph.prototype.normal=function(){this.isBig=!1,this.changed(),this.drawNew(),this.changed()},CellMorph.prototype.isCircular=function(t){return!!this.parentCell&&(t instanceof List?this.contents===t||this.parentCell.isCircular(t):this.parentCell.isCircular(this.contents))},CellMorph.prototype.fixLayout=function(){var t;this.changed(),this.drawNew(),this.changed(),this.parent&&this.parent.fixLayout?this.parent.fixLayout():(t=this.parentThatIsA(ListWatcherMorph))&&t.fixLayout()},CellMorph.prototype.update=function(){(isSnapObject(this.contents)||this.contents instanceof Costume)&&this.version!==this.contents.version&&(this.drawNew(),this.version=this.contents.version)},CellMorph.prototype.drawNew=function(t,e){var o,r,i,s=SyntaxElementMorph.prototype.fontSize,n=this.contentsMorph instanceof ListWatcherMorph&&this.contentsMorph.list===this.contents,a=this.contentsMorph instanceof TableFrameMorph&&this.contentsMorph.tableMorph.table===this.contents;if(this.isBig&&(s*=1.5),(t||this.contentsMorph&&!n&&!a)&&(this.contentsMorph.destroy(),this.version=null),!t&&(n||a)||(this.contents instanceof Morph?isSnapObject(this.contents)?(i=this.contents.thumbnail(new Point(40,40)),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(i.width),this.contentsMorph.silentSetHeight(i.height),this.contentsMorph.image=i,this.version=this.contents.version):this.contentsMorph=this.contents:isString(this.contents)?(r=500<this.contents.length?this.contents.slice(0,500)+"...":this.contents,this.contentsMorph=new TextMorph(r,s,null,!0,!1,"left"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(new Color(255,255,255))):"boolean"==typeof this.contents?(i=SpriteMorph.prototype.booleanMorph.call(null,this.contents).fullImage(),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(i.width),this.contentsMorph.silentSetHeight(i.height),this.contentsMorph.image=i):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):this.contents instanceof Context?(i=this.contents.image(),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(i.width),this.contentsMorph.silentSetHeight(i.height),this.contentsMorph.image=i):this.contents instanceof Costume?(i=this.contents.thumbnail(new Point(40,40)),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(i.width),this.contentsMorph.silentSetHeight(i.height),this.contentsMorph.image=i):this.contents instanceof Sound?this.contentsMorph=new SymbolMorph("notes",30):this.contents instanceof List?("table"===e||!t&&this.contents.isTable()?(this.contentsMorph=new TableFrameMorph(new TableMorph(this.contents,10)),this.contentsMorph.expand(new Point(200,150))):this.isCircular()?(this.contentsMorph=new TextMorph("(...)",s,null,!1,!0,"center"),this.contentsMorph.setColor(new Color(255,255,255))):this.contentsMorph=new ListWatcherMorph(this.contents,this),this.contentsMorph.isDraggable=!1):(this.contentsMorph=new TextMorph(isNil(this.contents)?"":this.contents.toString(),s,null,!0,!1,"center"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(new Color(255,255,255))),this.add(this.contentsMorph)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border),this.silentSetWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:3.5*SyntaxElementMorph.prototype.fontSize)),this.image=newCanvas(this.extent()),o=this.image.getContext("2d"),0===this.edge&&0===this.border)return BoxMorph.uber.drawNew.call(this),null;o.fillStyle=this.color.toString(),o.beginPath(),this.outlinePath(o,Math.max(this.edge-this.border,0),this.border),o.closePath(),o.fill(),0<this.border&&!MorphicPreferences.isFlat&&(o.lineWidth=this.border,o.strokeStyle=this.borderColor.toString(),o.beginPath(),this.outlinePath(o,this.edge,this.border/2),o.closePath(),o.stroke(),o.shadowOffsetX=this.border,o.shadowOffsetY=this.border,o.shadowBlur=this.border,o.shadowColor=this.color.darker(80).toString(),this.drawShadow(o,this.edge,this.border/2)),!t&&(n||a)||this.contentsMorph.setCenter(this.center())},CellMorph.prototype.drawShadow=function(t,e,o){var r=e+o,i=this.width(),s=this.height();t.beginPath(),t.moveTo(0,s-r),t.lineTo(0,r),t.stroke(),t.beginPath(),t.arc(r,r,e,radians(-180),radians(-90),!1),t.stroke(),t.beginPath(),t.moveTo(r,0),t.lineTo(i-r,0),t.stroke()},CellMorph.prototype.layoutChanged=function(){SyntaxElementMorph.prototype.fontSize;var t,e=this.parentThatIsA(ListWatcherMorph);if(this.isBig&&0,this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border),this.silentSetWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:2*this.height())),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),0===this.edge&&0===this.border)return BoxMorph.uber.drawNew.call(this),null;t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),0<this.border&&!MorphicPreferences.isFlat&&(t.lineWidth=this.border,t.strokeStyle=this.borderColor.toString(),t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke(),t.shadowOffsetX=this.border,t.shadowOffsetY=this.border,t.shadowBlur=this.border,t.shadowColor=this.color.darker(80).toString(),this.drawShadow(t,this.edge,this.border/2)),this.contentsMorph.setCenter(this.center()),e&&e.fixLayout()},CellMorph.prototype.reactToEdit=function(t){var e;isNil(this.idx)||(e=this.parentThatIsA(ListWatcherMorph))&&e.list.put(t.text,this.idx)},CellMorph.prototype.mouseClickLeft=function(t){this.isEditable&&this.contentsMorph instanceof TextMorph?this.contentsMorph.selectAllAndEdit():this.escalateEvent("mouseClickLeft",t)},CellMorph.prototype.mouseDoubleClick=function(t){List.prototype.enableTables&&this.currentValue instanceof List?new TableDialogMorph(this.contents).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},WatcherMorph.prototype=new BoxMorph,(WatcherMorph.prototype.constructor=WatcherMorph).uber=BoxMorph.prototype,WatcherMorph.prototype.init=function(t,e,o,r,i){this.labelText=t||"",this.version=null,this.objName="",this.isGhosted=!1,WatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1.000001,new Color(120,120,120)),this.color=new Color(220,220,220),this.readoutColor=e,this.style="normal",this.target=o||null,this.getter=r||null,this.currentValue=null,this.labelMorph=null,this.sliderMorph=null,this.cellMorph=null,this.isDraggable=!0,this.fixLayout(),this.update(),i&&this.hide()},WatcherMorph.prototype.isTemporary=function(){var t=this.parentThatIsA(StageMorph);return this.target instanceof VariableFrame&&((!t||this.target!==t.variables.parentFrame)&&null===this.target.owner)},WatcherMorph.prototype.object=function(){return this.target instanceof VariableFrame?this.target.owner:this.target},WatcherMorph.prototype.isGlobal=function(t){return contains(["getLastAnswer","getLastMessage","getTempo","getTimer","reportMouseX","reportMouseY","reportThreadCount"],t)},WatcherMorph.prototype.setSliderMin=function(t,e){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1,e),this.sliderMorph.setStart(t,e),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,e))},WatcherMorph.prototype.setSliderMax=function(t,e){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1,e),this.sliderMorph.setStop(t,e),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,e))},WatcherMorph.prototype.update=function(){var t,e,o,r=!1;if(this.target&&this.getter){if(this.updateLabel(),this.target instanceof VariableFrame)if(void 0===(t=this.target.vars[this.getter]?this.target.vars[this.getter].value:void 0)&&this.target.owner){if(e=this.target.owner,!contains(e.inheritedVariableNames(),this.getter))return void this.destroy();t=this.target.getVar(this.getter),this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables.lighter(35))}else this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables);else t=this.target[this.getter](),r=!!(o={xPosition:"x position",yPosition:"y position",direction:"direction",getCostumeIdx:"costume #",getScale:"size",getVolume:"volume",getPan:"balance",reportShown:"shown?",getPenDown:"pen down?"}[this.getter])&&this.target.inheritsAttribute(o);""===t||isNil(t)||"boolean"==typeof t||isNaN(+t)||(t=Math.round(1e9*t)/1e9),(t!==this.currentValue||r!==this.isGhosted||t.version&&t.version!==this.version)&&(this.changed(),this.cellMorph.contents=t,this.isGhosted=r,isSnapObject(this.target)&&(r?this.cellMorph.setColor(this.readoutColor.lighter(35)):this.cellMorph.setColor(this.readoutColor)),this.cellMorph.drawNew(),isNaN(t)||(this.sliderMorph.value=t,this.sliderMorph.drawNew()),this.fixLayout(),this.currentValue&&this.currentValue.version?this.version=this.currentValue.version:this.version=Date.now(),this.currentValue=t)}this.cellMorph.contentsMorph instanceof ListWatcherMorph?this.cellMorph.contentsMorph.update():isSnapObject(this.cellMorph.contents)&&this.cellMorph.update()},WatcherMorph.prototype.updateLabel=function(){var t=this.object();t&&!this.isGlobal(this.getter)&&t.version!==this.version&&(this.objName=t.name?t.name+" ":" ",this.labelMorph&&(this.labelMorph.destroy(),this.labelMorph=null,this.fixLayout()))},WatcherMorph.prototype.fixLayout=function(){var t,e=SyntaxElementMorph.prototype.fontSize,o=this;if(this.changed(),null===this.labelMorph&&(this.labelMorph=new StringMorph(this.objName+this.labelText,e,null,!0,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),this.add(this.labelMorph)),null===this.cellMorph&&(this.cellMorph=new CellMorph("",this.readoutColor),this.add(this.cellMorph)),null===this.sliderMorph&&(this.sliderMorph=new SliderMorph(0,100,0,20,"horizontal"),this.sliderMorph.alpha=1,this.sliderMorph.button.color=this.color.darker(),this.sliderMorph.color=this.color.lighter(60),this.sliderMorph.button.highlightColor=this.color.darker(),this.sliderMorph.button.highlightColor.b+=50,this.sliderMorph.button.pressColor=this.color.darker(),this.sliderMorph.button.pressColor.b+=100,this.sliderMorph.setHeight(e),this.sliderMorph.action=function(t){o.target.setVar(o.getter,Math.round(t),o.target.owner)},this.add(this.sliderMorph)),(t=this.cellMorph.contents instanceof List)&&(this.style="normal"),"large"===this.style)return this.labelMorph.hide(),this.sliderMorph.hide(),this.cellMorph.big(),this.cellMorph.setPosition(this.position()),void this.setExtent(this.cellMorph.extent().subtract(1));this.labelMorph.show(),this.sliderMorph.show(),this.cellMorph.normal(),this.labelMorph.setPosition(this.position().add(new Point(this.edge,this.border+SyntaxElementMorph.prototype.typeInPadding))),t?this.cellMorph.setPosition(this.labelMorph.bottomLeft().add(new Point(0,SyntaxElementMorph.prototype.typeInPadding))):(this.cellMorph.setPosition(this.labelMorph.topRight().add(new Point(e/3,0))),this.labelMorph.setTop(this.cellMorph.top()+(this.cellMorph.height()-this.labelMorph.height())/2)),"slider"===this.style?(this.sliderMorph.silentSetPosition(new Point(this.labelMorph.left(),this.cellMorph.bottom()+SyntaxElementMorph.prototype.typeInPadding)),this.sliderMorph.setWidth(this.cellMorph.right()-this.labelMorph.left()),this.silentSetHeight(this.cellMorph.height()+this.sliderMorph.height()+2*this.border+3*SyntaxElementMorph.prototype.typeInPadding)):(this.sliderMorph.hide(),this.bounds.corner.y=this.cellMorph.bottom()+this.border+SyntaxElementMorph.prototype.typeInPadding),this.bounds.corner.x=Math.max(this.cellMorph.right(),this.labelMorph.right())+this.edge+SyntaxElementMorph.prototype.typeInPadding,this.drawNew(),this.changed()},WatcherMorph.prototype.mouseDoubleClick=function(t){List.prototype.enableTables&&this.currentValue instanceof List?new TableDialogMorph(this.currentValue).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},WatcherMorph.prototype.rootForGrab=function(){var t=this.parentThatIsA(IDE_Morph);return t&&t.isAppMode?t:this},WatcherMorph.prototype.userMenu=function(){var t,e=this,o=this.parentThatIsA(IDE_Morph),r=16===this.world().currentKey,s=new MenuMorph(this);if(!o||!o.isAppMode)return s.addItem(("normal"===this.style?"Ï":"Ë")+" "+localize("normal"),"styleNormal"),s.addItem(("large"===this.style?"Ï":"Ë")+" "+localize("large"),"styleLarge"),this.target instanceof VariableFrame&&(s.addItem(("slider"===this.style?"Ï":"Ë")+" "+localize("slider"),"styleSlider"),s.addLine(),s.addItem("slider min...","userSetSliderMin"),s.addItem("slider max...","userSetSliderMax"),s.addLine(),s.addItem("import...","importData"),s.addItem("raw data...",function(){e.importData(!0)},"import without attempting to\nparse or format data"),r&&(this.currentValue instanceof List&&this.currentValue.canBeCSV()&&s.addItem("export as CSV...",function(){e.parentThatIsA(IDE_Morph).saveFileAs(e.currentValue.asCSV(),"text/csv;charset=utf-8",e.getter)},null,new Color(100,0,0)),this.currentValue instanceof List&&this.currentValue.canBeJSON()&&s.addItem("export as JSON...",function(){e.parentThatIsA(IDE_Morph).saveFileAs(e.currentValue.asJSON(!0),"text/json;charset=utf-8",e.getter)},null,new Color(100,0,0))),isString(this.currentValue)||!isNaN(+this.currentValue)?(r&&s.addItem("parse","parseTxt","try to convert\nraw data into a list",new Color(100,0,0)),s.addItem("export...",function(){e.parentThatIsA(IDE_Morph).saveFileAs(e.currentValue.toString(),"text/plain;charset=utf-8",e.getter)})):this.currentValue instanceof List&&this.currentValue.canBeCSV()?s.addItem("export...",function(){e.parentThatIsA(IDE_Morph).saveFileAs(e.currentValue.asCSV(),"text/csv;charset=utf-8",e.getter)}):this.currentValue instanceof List&&this.currentValue.canBeJSON()?s.addItem("export...",function(){e.parentThatIsA(IDE_Morph).saveFileAs(e.currentValue.asJSON(!0),"text/json;charset=utf-8",e.getter)}):this.currentValue instanceof Context&&(t=this.currentValue.outerContext.variables.names()).length&&(s.addLine(),t.forEach(function(t){var o,r,i;o=t,r=e.parentThatIsA(StageMorph),i=e.currentValue.outerContext.variables,s.addItem(o+"...",function(){var t,e=detect(r.children,function(t){return t instanceof WatcherMorph&&t.target===i&&t.getter===o});if(null!==e)return e.show(),void e.fixLayout();(e=new WatcherMorph(o+" "+localize("(temporary)"),SpriteMorph.prototype.blockColor.variables,i,o)).setPosition(r.position().add(10)),0<(t=r.watchers(e.left())).length&&e.setTop(t[t.length-1].bottom()),r.add(e),e.fixLayout()})}))),s},WatcherMorph.prototype.importData=function(n){var a=document.createElement("input"),p=this.parentThatIsA(IDE_Morph),h=this;p.filePicker&&(document.body.removeChild(p.filePicker),p.filePicker=null),a.type="file",a.style.color="transparent",a.style.backgroundColor="transparent",a.style.border="none",a.style.outline="none",a.style.position="absolute",a.style.top="0px",a.style.left="0px",a.style.width="0px",a.style.height="0px",a.style.display="none",a.addEventListener("change",function(){function e(t,e){return-1!==t.type.indexOf(e)||s===e}var o,t,r,i,s;document.body.removeChild(a),p.filePicker=null,0<a.files.length&&(o=a.files[a.files.length-1],i=new FileReader,s=o.name.split(".").pop().toLowerCase(),i.onloadend=function(t){!n&&e(o,"csv")?h.target.setVar(h.getter,Process.prototype.parseCSV(t.target.result)):!n&&e(o,"json")?h.target.setVar(h.getter,Process.prototype.parseJSON(t.target.result)):h.target.setVar(h.getter,t.target.result)},n||(-1!==o.type.indexOf("text")||contains(["txt","csv","xml","json","tsv"],s))?i.readAsText(o):(t=o.type,r=function(){i.readAsText(o)},p.confirm(localize('Snap! can only import "text" files.\nYou selected a file of type "'+t+'".')+"\n\n"+localize("Open anyway?"),"Unable to import",r)))},!1),document.body.appendChild(a),(p.filePicker=a).click()},WatcherMorph.prototype.parseTxt=function(){var t=this.target.vars[this.getter].value;this.target.setVar(this.getter,0===t.indexOf("[")?Process.prototype.parseJSON(t):Process.prototype.parseCSV(t))},WatcherMorph.prototype.setStyle=function(t){this.style=t,this.fixLayout()},WatcherMorph.prototype.styleNormal=function(){this.setStyle("normal")},WatcherMorph.prototype.styleLarge=function(){this.setStyle("large")},WatcherMorph.prototype.styleSlider=function(){this.setStyle("slider")},WatcherMorph.prototype.userSetSliderMin=function(){new DialogBoxMorph(this,this.setSliderMin,this).prompt("Slider minimum value",this.sliderMorph.start.toString(),this.world(),null,null,null,!0)},WatcherMorph.prototype.userSetSliderMax=function(){new DialogBoxMorph(this,this.setSliderMax,this).prompt("Slider maximum value",this.sliderMorph.stop.toString(),this.world(),null,null,null,!0)},WatcherMorph.prototype.drawNew=function(){var t,e;this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),MorphicPreferences.isFlat||0===this.edge&&0===this.border?BoxMorph.uber.drawNew.call(this):((e=t.createLinearGradient(0,0,0,this.height())).addColorStop(0,this.color.lighter().toString()),e.addColorStop(1,this.color.darker().toString()),t.fillStyle=e,t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),0<this.border&&((e=t.createLinearGradient(0,0,0,this.height())).addColorStop(0,this.borderColor.lighter().toString()),e.addColorStop(1,this.borderColor.darker().toString()),t.lineWidth=this.border,t.strokeStyle=e,t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke()))},StagePrompterMorph.prototype=new BoxMorph,(StagePrompterMorph.prototype.constructor=StagePrompterMorph).uber=BoxMorph.prototype,StagePrompterMorph.prototype.init=function(t){var e=this;this.isDone=!1,this.label=t?new StringMorph(t,SpriteMorph.prototype.bubbleFontSize,null,SpriteMorph.prototype.bubbleFontIsBold,!1,"left"):null,this.inputField=new InputFieldMorph,this.button=new PushButtonMorph(null,function(){e.accept()},""),StagePrompterMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,SpriteMorph.prototype.bubbleBorder,SpriteMorph.prototype.blockColor.sensing),this.color=new Color(255,255,255),this.label&&this.add(this.label),this.add(this.inputField),this.add(this.button),this.setWidth(StageMorph.prototype.dimensions.x-20),this.fixLayout()},StagePrompterMorph.prototype.fixLayout=function(){var t=0;this.label&&(this.label.setPosition(new Point(this.left()+this.edge,this.top()+this.edge)),t=this.label.bottom()-this.top()),this.inputField.setPosition(new Point(this.left()+this.edge,this.top()+t+this.edge)),this.inputField.setWidth(this.width()-2*this.edge-this.button.width()-this.border),this.button.setCenter(this.inputField.center()),this.button.setLeft(this.inputField.right()+this.border),this.setHeight(this.inputField.bottom()-this.top()+this.edge)},StagePrompterMorph.prototype.mouseClickLeft=function(){this.inputField.edit()},StagePrompterMorph.prototype.accept=function(){this.isDone=!0};</script>
        <script>var IDE_Morph,ProjectDialogMorph,LibraryImportDialogMorph,SpriteIconMorph,CostumeIconMorph,TurtleIconMorph,WardrobeMorph,SoundIconMorph,JukeboxMorph,StageHandleMorph,PaletteHandleMorph,CamSnapshotDialogMorph;function IDE_Morph(t){this.init(t)}function ProjectDialogMorph(t,e){this.init(t,e)}function ProjectRecoveryDialogMorph(t,e,o){this.init(t,e,o)}function LibraryImportDialogMorph(t,e){this.init(t,e)}function SpriteIconMorph(t,e){this.init(t,e)}function CostumeIconMorph(t,e){this.init(t,e)}function TurtleIconMorph(t,e){this.init(t,e)}function WardrobeMorph(t,e){this.init(t,e)}function SoundIconMorph(t,e){this.init(t,e)}function JukeboxMorph(t,e){this.init(t,e)}function StageHandleMorph(t){this.init(t)}function PaletteHandleMorph(t){this.init(t)}function CamSnapshotDialogMorph(t,e,o,i){this.init(t,e,o,i)}function SoundRecorderDialogMorph(t){this.init(t)}modules.gui="2019-July-17",IDE_Morph.prototype=new Morph,(IDE_Morph.prototype.constructor=IDE_Morph).uber=Morph.prototype,IDE_Morph.prototype.setDefaultDesign=function(){MorphicPreferences.isFlat=!1,SpriteMorph.prototype.paletteColor=new Color(55,55,55),SpriteMorph.prototype.paletteTextColor=new Color(230,230,230),StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30),IDE_Morph.prototype.buttonContrast=30,IDE_Morph.prototype.backgroundColor=new Color(40,40,40),IDE_Morph.prototype.frameColor=SpriteMorph.prototype.paletteColor,IDE_Morph.prototype.groupColor=SpriteMorph.prototype.paletteColor.lighter(8),IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,IDE_Morph.prototype.buttonLabelColor=new Color(255,255,255),IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.groupColor.darker(40),IDE_Morph.prototype.groupColor.darker(60),IDE_Morph.prototype.groupColor],IDE_Morph.prototype.rotationStyleColors=IDE_Morph.prototype.tabColors,IDE_Morph.prototype.appModeColor=new Color,IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture(),IDE_Morph.prototype.padding=5,SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor},IDE_Morph.prototype.setFlatDarkDesign=function(){MorphicPreferences.isFlat=!0,SpriteMorph.prototype.paletteColor=new Color(55,55,55),SpriteMorph.prototype.paletteTextColor=new Color(230,230,230),StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30),IDE_Morph.prototype.buttonContrast=30,IDE_Morph.prototype.backgroundColor=new Color(40,40,40),IDE_Morph.prototype.frameColor=SpriteMorph.prototype.paletteColor,IDE_Morph.prototype.groupColor=SpriteMorph.prototype.paletteColor.lighter(8),IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,IDE_Morph.prototype.buttonLabelColor=new Color(255,255,255),IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.groupColor.darker(40),IDE_Morph.prototype.groupColor.darker(60),IDE_Morph.prototype.groupColor],IDE_Morph.prototype.rotationStyleColors=IDE_Morph.prototype.tabColors,IDE_Morph.prototype.appModeColor=new Color,IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture(),IDE_Morph.prototype.padding=5,SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor},IDE_Morph.prototype.setFlatDesign=function(){MorphicPreferences.isFlat=!0,SpriteMorph.prototype.paletteColor=new Color(225,225,228),SpriteMorph.prototype.paletteTextColor=new Color(70,70,70),StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor,IDE_Morph.prototype.buttonContrast=30,IDE_Morph.prototype.backgroundColor=new Color(200,200,200),IDE_Morph.prototype.frameColor=new Color(255,255,255),IDE_Morph.prototype.groupColor=new Color(236,236,240),IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,IDE_Morph.prototype.buttonLabelColor=new Color(10,10,10),IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.groupColor.lighter(60),IDE_Morph.prototype.groupColor.darker(10),IDE_Morph.prototype.groupColor],IDE_Morph.prototype.rotationStyleColors=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.groupColor.lighter(60),IDE_Morph.prototype.groupColor.darker(10)],IDE_Morph.prototype.appModeColor=IDE_Morph.prototype.frameColor,IDE_Morph.prototype.scriptsPaneTexture=null,IDE_Morph.prototype.padding=1,SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor},IDE_Morph.prototype.scriptsTexture=function(){var t=newCanvas(new Point(100,100));t.getContext("2d");return t},IDE_Morph.prototype.setFlatDesign(),IDE_Morph.prototype.init=function(t){MorphicPreferences.globalFontFamily="Helvetica, Arial",this.userLanguage=null,this.projectsInURLs=!1,this.applySavedSettings(),this.cloud=new Cloud,this.cloudMsg=null,this.source=null,this.serializer=new SnapSerializer,this.globalVariables=new VariableFrame,this.currentSprite=new SpriteMorph(this.globalVariables),this.sprites=new List([this.currentSprite]),this.currentCategory="motion",this.currentTab="scripts",this.projectName="",this.projectNotes="",this.logoURL=this.resourceURL("src","snap_logo_sm.png"),this.logo=null,this.controlBar=null,this.categories=null,this.palette=null,this.paletteHandle=null,this.spriteBar=null,this.spriteEditor=null,this.stage=null,this.stageHandle=null,this.corralBar=null,this.corral=null,this.embedPlayButton=null,this.embedOverlay=null,this.isEmbedMode=!1,this.isAutoFill=void 0===t||t,this.isAppMode=!1,this.isSmallStage=!1,this.filePicker=null,this.hasChangedMedia=!1,this.isAnimating=!0,this.paletteWidth=250,this.stageRatio=1,this.wasSingleStepping=!1,this.loadNewProject=!1,this.shield=null,this.savingPreferences=!0,IDE_Morph.uber.init.call(this),this.color=this.backgroundColor},IDE_Morph.prototype.openIn=function(i){var e,r=this,s=null;function t(t){(sessionStorage.username=t)&&(r.source="cloud",r.cloud.verified||(new DialogBoxMorph).inform("Unverified account",'Your account is still unverified.\nPlease use the verification link that\nwas sent to your email address when you\nsigned up.\n\nIf you cannot find that email, please\ncheck your spam folder. If you still\ncannot find it, please use the "Resend\nVerification Email..." option in the cloud\nmenu.',i,r.cloudIcon(null,new Color(0,180,0))))}function n(t){try{var e=new XMLHttpRequest;if(e.open("GET",t,!1),e.send(),200===e.status)return e.responseText;throw new Error("unable to retrieve "+t)}catch(t){return r.showMessage("unable to retrieve project"),""}}function a(t){t.embedMode&&r.setEmbedMode(),t.editMode?r.toggleAppMode(!1):r.toggleAppMode(!0),t.noRun||r.runScripts(),t.hideControls&&(r.controlBar.hide(),window.onbeforeunload=nop),t.noExitWarning&&(window.onbeforeunload=nop),t.lang&&r.setLanguage(t.lang,null,!0),r.isEmbedMode||i.worldCanvas.focus()}function o(){var o,t;"#open:"===location.hash.substr(0,6)?(("%"===(e=location.hash.substr(6)).charAt(0)||-1<e.search(/\%(?:[0-9a-f]{2})/i))&&(e=decodeURIComponent(e)),contains(["project","blocks","sprites","snapdata"].map(function(t){return e.substr(0,8).indexOf(t)}),1)?this.droppedText(e):(0<(t=e.indexOf("&"))&&((o=r.cloud.parseDict(e.substr(t))).editMode=!0,e=e.slice(0,t),a(o)),this.droppedText(n(e)))):"#run:"===location.hash.substr(0,5)?(0<(t=(e=location.hash.substr(5)).indexOf("&"))&&(e=e.slice(0,t)),("%"===e.charAt(0)||-1<e.search(/\%(?:[0-9a-f]{2})/i))&&(e=decodeURIComponent(e)),"<project>"===e.substr(0,8)?this.rawOpenProjectString(e):this.rawOpenProjectString(n(e)),a(r.cloud.parseDict(location.hash.substr(5)))):"#present:"===location.hash.substr(0,9)?(this.shield=new Morph,this.shield.color=this.color,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),r.showMessage("Fetching project\nfrom the cloud..."),(o=r.cloud.parseDict(location.hash.substr(9))).Username=o.Username.toLowerCase(),r.cloud.getPublicProject(o.ProjectName,o.Username,function(t){var e;r.nextSteps([function(){e=r.showMessage("Opening project...")},function(){nop()},function(){0===t.indexOf("<snapdata")?r.rawOpenCloudDataString(t):0===t.indexOf("<project")&&r.rawOpenProjectString(t),r.hasChangedMedia=!0},function(){r.shield.destroy(),r.shield=null,e.destroy(),a(o)}])},this.cloudError())):"#cloud:"===location.hash.substr(0,7)?(this.shield=new Morph,this.shield.alpha=0,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),r.showMessage("Fetching project\nfrom the cloud..."),o=r.cloud.parseDict(location.hash.substr(7)),r.cloud.getPublicProject(o.ProjectName,o.Username,function(t){var e;r.nextSteps([function(){e=r.showMessage("Opening project...")},function(){nop()},function(){0===t.indexOf("<snapdata")?r.rawOpenCloudDataString(t):0===t.indexOf("<project")&&r.rawOpenProjectString(t),r.hasChangedMedia=!0},function(){r.shield.destroy(),r.shield=null,e.destroy(),r.toggleAppMode(!1)}])},this.cloudError())):"#dl:"===location.hash.substr(0,4)?(r.showMessage("Fetching project\nfrom the cloud..."),(o=r.cloud.parseDict(location.hash.substr(4))).Username=o.Username.toLowerCase(),r.cloud.getPublicProject(o.ProjectName,o.Username,function(t){r.saveXMLAs(t,o.ProjectName),r.showMessage("Saved project\n"+o.ProjectName,2)},this.cloudError())):"#lang:"===location.hash.substr(0,6)?(s=location.hash.substr(6),this.setLanguage(s,null,!0),this.loadNewProject=!0):"#signup"===location.hash.substr(0,7)&&this.createCloudAccount(),this.loadNewProject=!1}"file:"!==location.protocol&&(sessionStorage.username?this.cloud.checkCredentials(t):this.cloud.initSession(t)),this.buildPanes(),i.add(this),i.userMenu=this.userMenu,this.cloud.message=function(t){var e,o=new MenuMorph(null,t);o.popUpCenteredInWorld(i),e=setInterval(function(){o.destroy(),clearInterval(e)},2e3)},i.reactToDropOf=function(t){t instanceof DialogBoxMorph||t instanceof MenuMorph||(i.hand.grabOrigin?t.slideBackTo(i.hand.grabOrigin):i.hand.grab(t))},this.reactToWorldResize(i.bounds),this.userLanguage?(this.loadNewProject=!0,this.setLanguage(this.userLanguage,o)):o.call(this)},IDE_Morph.prototype.buildPanes=function(){this.createLogo(),this.createControlBar(),this.createCategories(),this.createPalette(),this.createStage(),this.createSpriteBar(),this.createSpriteEditor(),this.createCorralBar(),this.createCorral()},IDE_Morph.prototype.createLogo=function(){var o=this;this.logo&&this.logo.destroy(),this.logo=new Morph,this.logo.texture=this.logoURL,this.logo.drawNew=function(){this.image=newCanvas(this.extent());var t=this.image.getContext("2d"),e=t.createLinearGradient(0,0,this.width(),0);e.addColorStop(0,"black"),e.addColorStop(.5,o.frameColor.toString()),t.fillStyle=MorphicPreferences.isFlat?o.frameColor.toString():e,t.fillRect(0,0,this.width(),this.height()),this.texture&&this.drawTexture(this.texture)},this.logo.drawCachedTexture=function(){this.image.getContext("2d").drawImage(this.cachedTexture,5,Math.round((this.height()-this.cachedTexture.height)/2)),this.changed()},this.logo.mouseClickLeft=function(){o.snapMenu()},this.logo.color=new Color,this.logo.setExtent(new Point(200,28)),this.add(this.logo)},IDE_Morph.prototype.createControlBar=function(){var t,e,o,i,r,s,n,a,h,p,l,c,d=[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)],u=this;this.controlBar&&this.controlBar.destroy(),this.controlBar=new Morph,this.controlBar.color=this.frameColor,this.controlBar.setHeight(this.logo.height()),this.controlBar.mouseClickLeft=function(){this.world().fillPage()},this.add(this.controlBar),(t=new ToggleButtonMorph(null,u,"toggleStageSize",[new SymbolMorph("smallStage",14),new SymbolMorph("normalStage",14)],function(){return u.isSmallStage})).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),a=t,this.controlBar.add(a),this.controlBar.stageSizeButton=t,(t=new ToggleButtonMorph(null,u,"toggleAppMode",[new SymbolMorph("fullScreen",14),new SymbolMorph("normalScreen",14)],function(){return u.isAppMode})).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),h=t,this.controlBar.add(h),this.controlBar.appModeButton=h,(t=new ToggleButtonMorph(null,u,"toggleSingleStepping",[new SymbolMorph("footprints",16),new SymbolMorph("footprints",16)],function(){return Process.prototype.enableSingleStepping})).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=new Color(153,255,213),t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.hint="Visible stepping",t.fixLayout(),t.refresh(),p=t,this.controlBar.add(p),this.controlBar.steppingButton=p,(t=new ToggleButtonMorph(null,this,"stopAllScripts",[new SymbolMorph("octagon",14),new SymbolMorph("square",14)],function(){return!u.stage||u.stage.enableCustomHatBlocks&&u.stage.threads.pauseCustomHatBlocks})).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=new Color(200,0,0),t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),o=t,this.controlBar.add(o),this.controlBar.stopButton=o,(t=new ToggleButtonMorph(null,this,"togglePauseResume",[new SymbolMorph("pause",12),new SymbolMorph("pointRight",14)],function(){return u.isPaused()})).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=new Color(255,220,0),t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),i=t,this.controlBar.add(i),this.controlBar.pauseButton=i,(t=new PushButtonMorph(this,"pressStart",new SymbolMorph("flag",14))).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=new Color(0,200,0),t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),r=t,this.controlBar.add(r),this.controlBar.startButton=r,(e=new SliderMorph(61,1,100*Process.prototype.flashTime+1,6,"horizontal")).action=function(t){Process.prototype.flashTime=(t-1)/100,u.controlBar.refreshResumeSymbol()},e.color=new Color(153,255,213),e.alpha=.3,e.setExtent(new Point(50,14)),this.controlBar.add(e),this.controlBar.steppingSlider=e,(t=new PushButtonMorph(this,"projectMenu",new SymbolMorph("file",14))).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),s=t,this.controlBar.add(s),this.controlBar.projectButton=s,(t=new PushButtonMorph(this,"settingsMenu",new SymbolMorph("gears",14))).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),n=t,this.controlBar.add(n),this.controlBar.settingsButton=n,(t=new PushButtonMorph(this,"cloudMenu",new SymbolMorph("cloud",11))).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),l=t,this.controlBar.add(l),this.controlBar.cloudButton=l,this.controlBar.fixLayout=function(){c=this.right()-5,[o,i,r].forEach(function(t){t.setCenter(u.controlBar.center()),t.setRight(c),c-=t.width(),c-=5}),c=Math.min(r.left()-(15+2*a.width()),u.right()-StageMorph.prototype.dimensions.x*(u.isSmallStage?u.stageRatio:1)),[a,h].forEach(function(t){c+=5,t.setCenter(u.controlBar.center()),t.setLeft(c),c+=t.width()}),e.setCenter(u.controlBar.center()),e.setRight(a.left()-5),p.setCenter(u.controlBar.center()),p.setRight(e.left()-5),n.setCenter(u.controlBar.center()),n.setLeft(this.left()),l.setCenter(u.controlBar.center()),l.setRight(n.left()-5),s.setCenter(u.controlBar.center()),s.setRight(l.left()-5),this.refreshSlider(),this.updateLabel()},this.controlBar.refreshSlider=function(){Process.prototype.enableSingleStepping&&!u.isAppMode?(e.drawNew(),e.show()):e.hide(),this.refreshResumeSymbol()},this.controlBar.refreshResumeSymbol=function(){var t=Process.prototype.enableSingleStepping&&.5<Process.prototype.flashTime?(u.stage.threads.pauseAll(u.stage),[new SymbolMorph("pause",12),new SymbolMorph("stepForward",14)]):[new SymbolMorph("pause",12),new SymbolMorph("pointRight",14)];i.labelString=t,i.createLabel(),i.fixLayout(),i.refresh()},this.controlBar.updateLabel=function(){var t=u.world().isDevMode?" - "+localize("development mode"):"";this.label&&this.label.destroy(),u.isAppMode||(this.label=new StringMorph((u.projectName||localize("untitled"))+t,16,"sans-serif",!0,!1,!1,MorphicPreferences.isFlat?null:new Point(2,1),u.frameColor.darker(u.buttonContrast)),this.label.color=u.buttonLabelColor,this.label.drawNew(),this.add(this.label),this.label.setCenter(this.center()),this.label.setLeft(this.settingsButton.right()+5))}},IDE_Morph.prototype.createCategories=function(){var e,o,i,r,t,s,n,a,h,p=this;this.categories&&this.categories.destroy(),this.categories=new Morph,this.categories.color=this.groupColor,this.categories.silentSetWidth(this.paletteWidth),SpriteMorph.prototype.categories.forEach(function(t){var e,o,i;contains(["lists","other"],t)||(e=t,o=[SpriteMorph.prototype.blockColor[e],SpriteMorph.prototype.blockColor[e].lighter(55),SpriteMorph.prototype.blockColor[e].darker(32)],(i=new ToggleButtonMorph(o,p,function(){p.currentCategory=e,p.categories.children.forEach(function(t){t.refresh()}),p.refreshPalette(!0)},e[0].toUpperCase().concat(e.slice(1)),function(){return p.currentCategory===e},null,null,null,75,!0)).fontSize=12,i.corner=8,i.padding=0,i.labelShadowOffset=new Point(-1,-1),i.labelShadowColor=new Color(0,0,0),i.labelColor=new Color(248,248,255),i.fixLayout(),i.refresh(),p.categories.add(i))}),i=p.categories.children[0].width(),r=p.categories.children[0].height(),t=Math.ceil(p.categories.children.length/2),s=(197-2*i)/3,n=p.categories.left(),a=p.categories.top(),h=0,p.categories.children.forEach(function(t){h+=1,e=Math.ceil(h/2),o=2-h%2,t.setPosition(new Point(n+(o*s+(o-1)*i),a+(2*e+(e-1)*r+3)))}),p.categories.setHeight(2*(t+1)+t*r+6),this.add(this.categories)},IDE_Morph.prototype.createPalette=function(t){var o=this;return this.palette&&this.palette.destroy(),this.palette=t?new ScrollFrameMorph(null,null,this.currentSprite.sliderColor):this.currentSprite.palette(this.currentCategory),this.palette.isDraggable=!1,this.palette.acceptsDrops=!0,this.palette.enableAutoScrolling=!1,this.palette.contents.acceptsDrops=!1,this.palette.reactToDropOf=function(t,e){t instanceof DialogBoxMorph?o.world().add(t):t instanceof SpriteMorph?o.removeSprite(t):t instanceof SpriteIconMorph?(t.destroy(),o.removeSprite(t.object)):(t instanceof CostumeIconMorph?o.currentSprite.wearCostume(null):t instanceof BlockMorph&&(o.stage.threads.stopAllForBlock(t),e&&e.grabOrigin.origin instanceof ScriptsMorph&&(e.grabOrigin.origin.clearDropInfo(),e.grabOrigin.origin.lastDroppedBlock=t,e.grabOrigin.origin.recordDrop(e.grabOrigin))),t.perish())},this.palette.contents.reactToDropOf=function(t){t instanceof BlockMorph&&t.destroy()},this.palette.setWidth(this.logo.width()),this.add(this.palette),this.palette},IDE_Morph.prototype.createPaletteHandle=function(){this.paletteHandle&&this.paletteHandle.destroy(),this.paletteHandle=new PaletteHandleMorph(this.categories),this.add(this.paletteHandle)},IDE_Morph.prototype.createStage=function(){this.stage&&this.stage.destroy(),StageMorph.prototype.frameRate=0,this.stage=new StageMorph(this.globalVariables),this.stage.setExtent(this.stage.dimensions),this.currentSprite instanceof SpriteMorph&&(this.currentSprite.setPosition(this.stage.center().subtract(this.currentSprite.extent().divideBy(2))),this.stage.add(this.currentSprite)),this.add(this.stage)},IDE_Morph.prototype.createStageHandle=function(){this.stageHandle&&this.stageHandle.destroy(),this.stageHandle=new StageHandleMorph(this.stage),this.add(this.stageHandle)},IDE_Morph.prototype.createSpriteBar=function(){var e,t,o,i,r=[],s=new Point(45,45),n=this.tabColors,a=new AlignmentMorph("row",-30),h=["","»",""],p=["don't rotate","can rotate","only face left/right"],l=this;function c(t){var e=l.rotationStyleColors,o=new ToggleButtonMorph(e,l,function(){l.currentSprite instanceof SpriteMorph&&(l.currentSprite.rotationStyle=t,l.currentSprite.changed(),l.currentSprite.drawNew(),l.currentSprite.changed()),r.forEach(function(t){t.refresh()})},h[t],function(){return l.currentSprite instanceof SpriteMorph&&l.currentSprite.rotationStyle===t},null,localize(p[t]));return o.corner=8,o.labelMinExtent=new Point(11,11),o.padding=0,o.labelShadowOffset=new Point(-1,-1),o.labelShadowColor=e[1],o.labelColor=l.buttonLabelColor,o.fixLayout(),o.refresh(),r.push(o),o.setPosition(l.spriteBar.position().add(2)),o.setTop(o.top()+(r.length-1)*(o.height()+2)),l.spriteBar.add(o),l.currentSprite instanceof StageMorph&&o.hide(),o}this.spriteBar&&this.spriteBar.destroy(),this.spriteBar=new Morph,this.spriteBar.color=this.frameColor,this.add(this.spriteBar),c(1),c(2),c(0),this.rotationStyleButtons=r,(o=new Morph).setExtent(s),o.image=this.currentSprite.thumbnail(s),o.setPosition(r[0].topRight().add(new Point(5,3))),this.spriteBar.add(o),o.fps=3,o.step=function(){o.version!==l.currentSprite.version&&(o.image=l.currentSprite.thumbnail(s),o.changed(),o.version=l.currentSprite.version)},(e=new InputFieldMorph(this.currentSprite.name)).setWidth(100),e.contrast=90,e.setPosition(o.topRight().add(new Point(10,3))),this.spriteBar.add(e),(this.spriteBar.nameField=e).drawNew(),e.accept=function(){var t=e.getValue();l.currentSprite.setName(l.newSpriteName(t,l.currentSprite)),e.setContents(l.currentSprite.name)},this.spriteBar.reactToEdit=e.accept,(t=new ToggleMorph("checkbox",null,function(){l.currentSprite.isDraggable=!l.currentSprite.isDraggable},localize("draggable"),function(){return l.currentSprite.isDraggable})).label.isBold=!1,t.label.setColor(this.buttonLabelColor),t.color=n[2],t.highlightColor=n[0],t.pressColor=n[1],t.tick.shadowOffset=MorphicPreferences.isFlat?new Point:new Point(-1,-1),t.tick.shadowColor=new Color,t.tick.color=this.buttonLabelColor,t.tick.isBold=!1,t.tick.drawNew(),t.setPosition(e.bottomLeft().add(2)),t.drawNew(),this.spriteBar.add(t),this.currentSprite instanceof StageMorph&&t.hide(),a.tabTo=function(t){var e;l.currentTab=t,this.children.forEach(function(t){t.refresh(),t.state&&(e=t)}),e.refresh(),l.createSpriteEditor(),l.fixLayout("tabEditor")},(i=new TabMorph(n,null,function(){a.tabTo("scripts")},localize("Scripts"),function(){return"scripts"===l.currentTab})).padding=3,i.corner=15,i.edge=1,i.labelShadowOffset=new Point(-1,-1),i.labelShadowColor=n[1],i.labelColor=this.buttonLabelColor,i.drawNew(),i.fixLayout(),a.add(i),(i=new TabMorph(n,null,function(){a.tabTo("costumes")},localize(this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds"),function(){return"costumes"===l.currentTab})).padding=3,i.corner=15,i.edge=1,i.labelShadowOffset=new Point(-1,-1),i.labelShadowColor=n[1],i.labelColor=this.buttonLabelColor,i.drawNew(),i.fixLayout(),a.add(i),(i=new TabMorph(n,null,function(){a.tabTo("sounds")},localize("Sounds"),function(){return"sounds"===l.currentTab})).padding=3,i.corner=15,i.edge=1,i.labelShadowOffset=new Point(-1,-1),i.labelShadowColor=n[1],i.labelColor=this.buttonLabelColor,i.drawNew(),i.fixLayout(),a.add(i),a.fixLayout(),a.children.forEach(function(t){t.refresh()}),this.spriteBar.tabBar=a,this.spriteBar.add(this.spriteBar.tabBar),this.spriteBar.fixLayout=function(){this.tabBar.setLeft(this.left()),this.tabBar.setBottom(this.bottom())}},IDE_Morph.prototype.createSpriteEditor=function(){var t=this.currentSprite.scripts,e=this;this.spriteEditor&&this.spriteEditor.destroy(),"scripts"===this.currentTab?(t.isDraggable=!1,t.color=this.groupColor,t.cachedTexture=this.scriptsPaneTexture,this.spriteEditor=new ScrollFrameMorph(t,null,this.sliderColor),this.spriteEditor.padding=10,this.spriteEditor.growth=50,this.spriteEditor.isDraggable=!1,this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!0,t.scrollFrame=this.spriteEditor,t.updateToolbar(),this.add(this.spriteEditor),this.spriteEditor.scrollX(this.spriteEditor.padding),this.spriteEditor.scrollY(this.spriteEditor.padding)):"costumes"===this.currentTab?(this.spriteEditor=new WardrobeMorph(this.currentSprite,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!1):"sounds"===this.currentTab?(this.spriteEditor=new JukeboxMorph(this.currentSprite,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptDrops=!1,this.spriteEditor.contents.acceptsDrops=!1):(this.spriteEditor=new Morph,this.spriteEditor.color=this.groupColor,this.spriteEditor.acceptsDrops=!0,this.spriteEditor.reactToDropOf=function(t){t instanceof DialogBoxMorph?e.world().add(t):t instanceof SpriteMorph?e.removeSprite(t):t.destroy()},this.add(this.spriteEditor))},IDE_Morph.prototype.createCorralBar=function(){var t,e,o,i=[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)];this.corralBar&&this.corralBar.destroy(),this.corralBar=new Morph,this.corralBar.color=this.frameColor,this.corralBar.setHeight(this.logo.height()),this.add(this.corralBar),(t=new PushButtonMorph(this,"addNewSprite",new SymbolMorph("turtle",14))).corner=12,t.color=i[0],t.highlightColor=i[1],t.pressColor=i[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=i[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.hint="add a new Turtle sprite",t.fixLayout(),t.setCenter(this.corralBar.center()),t.setLeft(this.corralBar.left()+5),this.corralBar.add(t),(e=new PushButtonMorph(this,"paintNewSprite",new SymbolMorph("brush",15))).corner=12,e.color=i[0],e.highlightColor=i[1],e.pressColor=i[2],e.labelMinExtent=new Point(36,18),e.padding=0,e.labelShadowOffset=new Point(-1,-1),e.labelShadowColor=i[1],e.labelColor=this.buttonLabelColor,e.contrast=this.buttonContrast,e.drawNew(),e.hint="paint a new sprite",e.fixLayout(),e.setCenter(this.corralBar.center()),e.setLeft(this.corralBar.left()+5+t.width()+5),this.corralBar.add(e),CamSnapshotDialogMorph.prototype.enableCamera&&((o=new PushButtonMorph(this,"newCamSprite",new SymbolMorph("camera",15))).corner=12,o.color=i[0],o.highlightColor=i[1],o.pressColor=i[2],o.labelMinExtent=new Point(36,18),o.padding=0,o.labelShadowOffset=new Point(-1,-1),o.labelShadowColor=i[1],o.labelColor=this.buttonLabelColor,o.contrast=this.buttonContrast,o.drawNew(),o.hint="take a camera snapshot and\nimport it as a new sprite",o.fixLayout(),o.setCenter(this.corralBar.center()),o.setLeft(this.corralBar.left()+5+t.width()+5+e.width()+5),this.corralBar.add(o),document.addEventListener("cameraDisabled",function(t){o.disable(),o.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage}))},IDE_Morph.prototype.createCorral=function(){var e,o,i=this;this.createStageHandle(),this.createPaletteHandle(),this.corral&&this.corral.destroy(),this.corral=new Morph,this.corral.color=this.groupColor,this.add(this.corral),this.corral.stageIcon=new SpriteIconMorph(this.stage),this.corral.stageIcon.isDraggable=!1,this.corral.add(this.corral.stageIcon),(e=new ScrollFrameMorph(null,null,this.sliderColor)).acceptsDrops=!1,e.contents.acceptsDrops=!1,e.contents.wantsDropOf=function(t){return t instanceof SpriteIconMorph},e.contents.reactToDropOf=function(t){i.corral.reactToDropOf(t)},e.alpha=0,this.sprites.asArray().forEach(function(t){t.isTemporary||(o=new SpriteIconMorph(t,o),e.contents.add(o))}),this.corral.frame=e,this.corral.add(e),this.corral.fixLayout=function(){this.stageIcon.setCenter(this.center()),this.stageIcon.setLeft(this.left()+5),this.frame.setLeft(this.stageIcon.right()+5),this.frame.setExtent(new Point(this.right()-this.frame.left(),this.height())),this.arrangeIcons(),this.refresh()},this.corral.arrangeIcons=function(){var o=this.frame.left(),i=this.frame.top(),r=this.frame.right(),s=this.frame.left();this.frame.contents.children.forEach(function(t){var e=t.width();r<o+e&&(o=s,i+=t.height()),t.setPosition(new Point(o,i)),o+=e}),this.frame.contents.adjustBounds()},this.corral.addSprite=function(t){this.frame.contents.add(new SpriteIconMorph(t)),this.fixLayout()},this.corral.refresh=function(){this.stageIcon.refresh(),this.frame.contents.children.forEach(function(t){t.refresh()})},this.corral.wantsDropOf=function(t){return t instanceof SpriteIconMorph},this.corral.reactToDropOf=function(t){var e=1,o=t.position();t.destroy(),this.frame.contents.children.forEach(function(t){(o.gt(t.position())||o.y>t.bottom())&&(e+=1)}),i.sprites.add(t.object,e),i.createCorral(),i.fixLayout()}},IDE_Morph.prototype.fixLayout=function(t){var e,o,i=this.padding;Morph.prototype.trackChanges=!1,"refreshPalette"!==t&&(this.controlBar.setPosition(this.logo.topRight()),this.controlBar.setWidth(this.right()-this.controlBar.left()),this.controlBar.fixLayout(),this.categories.setLeft(this.logo.left()),this.categories.setTop(this.logo.bottom()),this.categories.setWidth(this.paletteWidth)),this.palette.setLeft(this.logo.left()),this.palette.setTop(this.categories.bottom()),this.palette.setHeight(this.bottom()-this.palette.top()),this.palette.setWidth(this.paletteWidth),"refreshPalette"!==t&&(this.isEmbedMode?(this.stage.setScale(Math.floor(100*Math.min(this.width()/this.stage.dimensions.x,this.height()/this.stage.dimensions.y))/100),(e=this.embedPlayButton.flag).size=Math.floor(Math.min(this.width(),this.height()))/5,e.setWidth(e.size),e.setHeight(e.size),this.embedPlayButton.size=1.6*e.size,this.embedPlayButton.setWidth(this.embedPlayButton.size),this.embedPlayButton.setHeight(this.embedPlayButton.size),this.embedOverlay&&this.embedOverlay.setExtent(this.extent()),this.stage.setCenter(this.center()),this.embedPlayButton.setCenter(this.stage.center()),e.setCenter(this.embedPlayButton.center()),e.setLeft(e.left()+.1*e.size)):this.isAppMode?(this.stage.setScale(Math.floor(10*Math.min((this.width()-2*i)/this.stage.dimensions.x,(this.height()-2*this.controlBar.height()-2*i)/this.stage.dimensions.y))/10),this.stage.setCenter(this.center())):(this.stage.setScale(this.isSmallStage?this.stageRatio:1),this.stage.setTop(this.logo.bottom()+i),this.stage.setRight(this.right()),o=Math.max(200,this.width()-this.stage.width()-this.spriteBar.tabBar.width()-2*this.padding),this.paletteWidth>o&&(this.paletteWidth=o,this.fixLayout()),this.stageHandle.fixLayout(),this.paletteHandle.fixLayout()),this.spriteBar.setLeft(this.paletteWidth+i),this.spriteBar.setTop(this.logo.bottom()+i),this.spriteBar.setExtent(new Point(Math.max(0,this.stage.left()-i-this.spriteBar.left()),this.categories.bottom()-this.spriteBar.top()-i)),this.spriteBar.fixLayout(),this.spriteEditor.isVisible&&(this.spriteEditor.setPosition(this.spriteBar.bottomLeft()),this.spriteEditor.setExtent(new Point(this.spriteBar.width(),this.bottom()-this.spriteEditor.top()))),this.corralBar.setLeft(this.stage.left()),this.corralBar.setTop(this.stage.bottom()+i),this.corralBar.setWidth(this.stage.width()),contains(["selectSprite","tabEditor"],t)||(this.corral.setPosition(this.corralBar.bottomLeft()),this.corral.setWidth(this.stage.width()),this.corral.setHeight(this.bottom()-this.corral.top()),this.corral.fixLayout())),Morph.prototype.trackChanges=!0,this.changed()},IDE_Morph.prototype.setProjectName=function(t){this.projectName=t.replace(/['"]/g,""),this.hasChangedMedia=!0,this.controlBar.updateLabel()},IDE_Morph.prototype.setExtent=function(t){var e=new Point(430,110),o=this.isAppMode?this.isEmbedMode?new Point(100,100):StageMorph.prototype.dimensions.add(this.controlBar.height()+10):1<this.stageRatio?e.add(StageMorph.prototype.dimensions):e.add(StageMorph.prototype.dimensions.multiplyBy(this.stageRatio)),i=t.max(o),r=i.x-(200+this.spriteBar.tabBar.width()+2*this.padding),s=3*SpriteIconMorph.prototype.thumbSize.x,n=i.y-3.5*SpriteIconMorph.prototype.thumbSize.y,a=s/this.stage.dimensions.x,h=Math.min(r/this.stage.dimensions.x,n/this.stage.dimensions.y);this.stageRatio=Math.min(h,Math.max(a,this.stageRatio)),IDE_Morph.uber.setExtent.call(this,i),this.fixLayout()},IDE_Morph.prototype.reactToWorldResize=function(t){this.isAutoFill&&(this.setPosition(t.origin),this.setExtent(t.extent())),this.filePicker&&(document.body.removeChild(this.filePicker),this.filePicker=null)},IDE_Morph.prototype.droppedImage=function(t,e){var o=new Costume(t,this.currentSprite.newCostumeName(e?e.split(".")[0]:""));o.isTainted()?this.inform("Unable to import this image","The picture you wish to import has been\ntainted by a restrictive cross-origin policy\nmaking it unusable for costumes in Snap!. \n\nTry downloading this picture first to your\ncomputer, and import it from there."):(this.currentSprite.addCostume(o),this.currentSprite.wearCostume(o),this.spriteBar.tabBar.tabTo("costumes"),this.hasChangedMedia=!0)},IDE_Morph.prototype.droppedSVG=function(t,e){var o=new SVG_Costume(t,e.split(".")[0]);this.currentSprite.addCostume(o),this.currentSprite.wearCostume(o),this.spriteBar.tabBar.tabTo("costumes"),this.hasChangedMedia=!0},IDE_Morph.prototype.droppedAudio=function(o,i){var r=this;0!==o.src.indexOf("data:audio")?this.getURL(o.src,function(t){var e=new window.FileReader;e.readAsDataURL(t),e.onloadend=function(){var t="data:audio/ogg;base64,"+(t=e.result).split(",")[1];o.src=t,r.droppedAudio(o,i)}},"blob"):(this.currentSprite.addSound(o,i.split(".")[0]),this.spriteBar.tabBar.tabTo("sounds"),this.hasChangedMedia=!0)},IDE_Morph.prototype.droppedText=function(t,e,o){var i=e?e.split(".")[0]:"",r=e?e.slice(e.lastIndexOf(".")+1).toLowerCase():"";return 0===t.indexOf("<project")?(location.hash="",this.openProjectString(t)):0===t.indexOf("<snapdata")?(location.hash="",this.openCloudDataString(t)):0===t.indexOf("<blocks")?this.openBlocksString(t,i,!0):0===t.indexOf("<sprites")?this.openSpritesString(t):0===t.indexOf("<media")?this.openMediaString(t):0===t.indexOf("<script")?this.openScriptString(t):-1!==o.indexOf("csv")||"csv"===r?this.openDataString(t,i,"csv"):-1!==o.indexOf("json")||"json"===r?this.openDataString(t,i,"json"):void this.openDataString(t,i,"text")},IDE_Morph.prototype.droppedBinary=function(t,e){var o=document.getElementById("ypr"),r=this;function i(t,e){var o=new sb.Reader,i=e.split(".")[0];o.onload=function(t){r.droppedText((new sb.XMLWriter).write(i,t))},o.readYPR(new Uint8Array(t))}"ypr"===e.substring(e.length-3).toLowerCase()&&(o?i(t,e):((o=document.createElement("script")).id="ypr",o.onload=function(){i(t,e)},document.head.appendChild(o),o.src=this.resourceURL("src","ypr.js")))},IDE_Morph.prototype.refreshPalette=function(t){var e=this.palette.contents.top();this.createPalette(),this.isAppMode?this.palette.hide():(this.fixLayout("refreshPalette"),t||this.palette.contents.setTop(e))},IDE_Morph.prototype.pressStart=function(){16===this.world().currentKey?this.toggleFastTracking():(this.stage.threads.pauseCustomHatBlocks=!1,this.controlBar.stopButton.refresh(),this.runScripts())},IDE_Morph.prototype.toggleFastTracking=function(){this.stage.isFastTracked?this.stopFastTracking():this.startFastTracking()},IDE_Morph.prototype.toggleVariableFrameRate=function(){StageMorph.prototype.frameRate?(StageMorph.prototype.frameRate=0,this.stage.fps=0):(StageMorph.prototype.frameRate=30,this.stage.fps=30)},IDE_Morph.prototype.toggleSingleStepping=function(){this.stage.threads.toggleSingleStepping(),this.controlBar.steppingButton.refresh(),this.controlBar.refreshSlider()},IDE_Morph.prototype.toggleCameraSupport=function(){CamSnapshotDialogMorph.prototype.enableCamera=!CamSnapshotDialogMorph.prototype.enableCamera,this.spriteBar.tabBar.tabTo(this.currentTab),this.createCorralBar(),this.fixLayout()},IDE_Morph.prototype.startFastTracking=function(){this.stage.isFastTracked=!0,this.stage.fps=0,this.controlBar.startButton.labelString=new SymbolMorph("flash",14),this.controlBar.startButton.drawNew(),this.controlBar.startButton.fixLayout()},IDE_Morph.prototype.stopFastTracking=function(){this.stage.isFastTracked=!1,this.stage.fps=this.stage.frameRate,this.controlBar.startButton.labelString=new SymbolMorph("flag",14),this.controlBar.startButton.drawNew(),this.controlBar.startButton.fixLayout()},IDE_Morph.prototype.runScripts=function(){this.stage.fireGreenFlagEvent()},IDE_Morph.prototype.togglePauseResume=function(){this.stage.threads.isPaused()?this.stage.threads.resumeAll(this.stage):this.stage.threads.pauseAll(this.stage),this.controlBar.pauseButton.refresh()},IDE_Morph.prototype.isPaused=function(){return!!this.stage&&this.stage.threads.isPaused()},IDE_Morph.prototype.stopAllScripts=function(){this.stage.enableCustomHatBlocks?this.stage.threads.pauseCustomHatBlocks=!this.stage.threads.pauseCustomHatBlocks:this.stage.threads.pauseCustomHatBlocks=!1,this.controlBar.stopButton.refresh(),this.stage.fireStopAllEvent()},IDE_Morph.prototype.selectSprite=function(t){this.currentSprite&&this.currentSprite.scripts.focus&&this.currentSprite.scripts.focus.stopEditing(),this.currentSprite=t,this.createPalette(),this.createSpriteBar(),this.createSpriteEditor(),this.corral.refresh(),this.fixLayout("selectSprite"),this.currentSprite.scripts.fixMultiArgs()},IDE_Morph.prototype.toggleRetina=function(){(isRetinaEnabled()?disableRetinaSupport:enableRetinaSupport)(),this.world().fillPage(),IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture(),this.stage.clearPenTrails(),this.drawNew(),this.refreshIDE()},IDE_Morph.prototype.defaultDesign=function(){this.setFlatDarkDesign(),this.refreshIDE(),this.removeSetting("design")},IDE_Morph.prototype.flatDesign=function(){this.setFlatDesign(),this.refreshIDE(),this.saveSetting("design","flat")},IDE_Morph.prototype.refreshIDE=function(){var t;if(Process.prototype.isCatchingErrors)try{t=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else t=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.buildPanes(),this.fixLayout(),this.loadNewProject?this.newProject():this.openProjectString(t)},IDE_Morph.prototype.applySavedSettings=function(){var t=this.getSetting("design"),e=this.getSetting("zoom"),o=this.getSetting("language"),i=this.getSetting("click"),r=this.getSetting("longform"),s=this.getSetting("longurls"),n=this.getSetting("plainprototype"),a=this.getSetting("keyboard"),h=this.getSetting("tables"),p=this.getSetting("tableLines"),l=this.getSetting("autowrapping");"flat"===t&&this.setFlatDesign(),e&&(SyntaxElementMorph.prototype.setScale(Math.min(e,12)),CommentMorph.prototype.refreshScale(),SpriteMorph.prototype.initBlocks()),this.userLanguage=o&&"en"!==o?o:null,i&&!BlockMorph.prototype.snapSound&&BlockMorph.prototype.toggleSnapSound(),r&&(InputSlotDialogMorph.prototype.isLaunchingExpanded=!0),this.projectsInURLs=!!s,ScriptsMorph.prototype.enableKeyboard="false"!==a,List.prototype.enableTables="false"!==h,TableMorph.prototype.highContrast=!!p,ScriptsMorph.prototype.enableNestedAutoWrapping="false"!==l,n&&(BlockLabelPlaceHolderMorph.prototype.plainLabel=!0)},IDE_Morph.prototype.saveSetting=function(t,e){this.savingPreferences&&this.hasLocalStorage()&&(localStorage["-snap-setting-"+t]=e)},IDE_Morph.prototype.getSetting=function(t){return this.hasLocalStorage()?localStorage["-snap-setting-"+t]:null},IDE_Morph.prototype.removeSetting=function(t){this.hasLocalStorage()&&delete localStorage["-snap-setting-"+t]},IDE_Morph.prototype.hasLocalStorage=function(){try{return!isNil(localStorage)}catch(t){return!1}},IDE_Morph.prototype.addNewSprite=function(){var t=new SpriteMorph(this.globalVariables),e=Process.prototype.reportRandom;t.name=this.newSpriteName(t.name),t.setCenter(this.stage.center()),this.stage.add(t),t.setColorComponentHSVA(0,e.call(this,0,100)),t.setColorComponentHSVA(1,100),t.setColorComponentHSVA(2,e.call(this,50,100)),t.setXPosition(e.call(this,-220,220)),t.setYPosition(e.call(this,-160,160)),16===this.world().currentKey&&t.turn(e.call(this,1,360)),this.sprites.add(t),this.corral.addSprite(t),this.selectSprite(t)},IDE_Morph.prototype.paintNewSprite=function(){var t=new SpriteMorph(this.globalVariables),e=new Costume,o=this;t.name=this.newSpriteName(t.name),t.setCenter(this.stage.center()),this.stage.add(t),this.sprites.add(t),this.corral.addSprite(t),this.selectSprite(t),e.edit(this.world(),this,!0,function(){o.removeSprite(t)},function(){t.addCostume(e),t.wearCostume(e)})},IDE_Morph.prototype.newCamSprite=function(){var e=new SpriteMorph(this.globalVariables),t=this;e.name=this.newSpriteName(e.name),e.setCenter(this.stage.center()),this.stage.add(e),this.sprites.add(e),this.corral.addSprite(e),this.selectSprite(e),new CamSnapshotDialogMorph(this,e,function(){t.removeSprite(e)},function(t){e.addCostume(t),e.wearCostume(t),this.close()}).popUp(this.world())},IDE_Morph.prototype.recordNewSound=function(){var e=this,t=new SoundRecorderDialogMorph(function(t){t&&(e.currentSprite.addSound(t,e.newSoundName("recording")),e.spriteBar.tabBar.tabTo("sounds"),e.hasChangedMedia=!0)});t.key="microphone",t.popUp(this.world())},IDE_Morph.prototype.duplicateSprite=function(t){var e=t.fullCopy();e.isDown=!1,e.setPosition(this.world().hand.position()),e.appearIn(this),e.keepWithin(this.stage),e.isDown=t.isDown,this.selectSprite(e)},IDE_Morph.prototype.instantiateSprite=function(t){var e=t.fullCopy(!0),o=e.allHatBlocksFor("__clone__init__");e.isDown=!1,e.appearIn(this),o.length?e.initClone(o):(e.setPosition(this.world().hand.position()),e.keepWithin(this.stage)),e.isDown=t.isDown,this.selectSprite(e)},IDE_Morph.prototype.removeSprite=function(e){var t,o=this;e.parts.slice().forEach(function(t){o.removeSprite(t)}),t=this.sprites.asArray().indexOf(e)+1,this.stage.threads.stopAllForReceiver(e),e.corpsify(),e.destroy(),this.stage.watchers().forEach(function(t){t.object()===e&&t.destroy()}),0<t&&this.sprites.remove(t),this.createCorral(),this.fixLayout(),this.currentSprite=detect(this.stage.children,function(t){return t instanceof SpriteMorph&&!t.isTemporary})||this.stage,this.selectSprite(this.currentSprite)},IDE_Morph.prototype.newSoundName=function(t){var e=this.currentSprite.sounds.at(this.currentSprite.sounds.length());return this.newName(t||e.name,this.currentSprite.sounds.asArray().map(function(t){return t.name}))},IDE_Morph.prototype.newSpriteName=function(t,e){var o=this.sprites.asArray().concat(this.stage).filter(function(t){return t!==e}).map(function(t){return t.name});return this.newName(t,o)},IDE_Morph.prototype.newName=function(t,e){for(var o=t.indexOf("("),i=o<0?t:t.substring(0,o),r=1,s=i;contains(e,s);)s=i+"("+(r+=1)+")";return s},IDE_Morph.prototype.removeBlock=function(t,e){this.stage.threads.stopAllForBlock(t),t.destroy(e)},IDE_Morph.prototype.userMenu=function(){return new MenuMorph(this)},IDE_Morph.prototype.snapMenu=function(){var e=this,t=this.world(),o=new MenuMorph(this);o.addItem("About...","aboutSnap"),o.addLine(),o.addItem("Reference manual",function(){var t=e.resourceURL("help","SnapManual.pdf");window.open(t,"SnapReferenceManual")}),o.addItem("Snap! website",function(){window.open("http://snap.berkeley.edu/","SnapWebsite")}),o.addItem("Download source",function(){window.open("https://github.com/jmoenig/Snap/releases/latest","SnapSource")}),t.isDevMode?(o.addLine(),o.addItem("Switch back to user mode","switchToUserMode","disable deep-Morphic\ncontext menus\nand show user-friendly ones",new Color(0,100,0))):16===t.currentKey&&(o.addLine(),o.addItem("Switch to dev mode","switchToDevMode","enable Morphic\ncontext menus\nand inspectors,\nnot user-friendly!",new Color(100,0,0))),o.popup(t,this.logo.bottomLeft())},IDE_Morph.prototype.cloudMenu=function(){var t,o=this,e=this.world(),i=this.controlBar.cloudButton.bottomLeft(),r=16===e.currentKey;"file:"!==location.protocol||r?(t=new MenuMorph(this),r&&(t.addItem("url...","setCloudURL",null,new Color(100,0,0)),t.addLine()),this.cloud.username?(t.addItem(localize("Logout")+" "+this.cloud.username,"logout"),t.addItem("Change Password...","changeCloudPassword")):(t.addItem("Login...","initializeCloud"),t.addItem("Signup...","createCloudAccount"),t.addItem("Reset Password...","resetCloudPassword"),t.addItem("Resend Verification Email...","resendVerification")),r&&(t.addLine(),t.addItem("export project media only...",function(){o.projectName?o.exportProjectMedia(o.projectName):o.prompt("Export Project As...",function(t){o.exportProjectMedia(t)},null,"exportProject")},null,this.hasChangedMedia?new Color(100,0,0):new Color(0,100,0)),t.addItem("export project without media...",function(){o.projectName?o.exportProjectNoMedia(o.projectName):o.prompt("Export Project As...",function(t){o.exportProjectNoMedia(t)},null,"exportProject")},null,new Color(100,0,0)),t.addItem("export project as cloud data...",function(){o.projectName?o.exportProjectAsCloudData(o.projectName):o.prompt("Export Project As...",function(t){o.exportProjectAsCloudData(t)},null,"exportProject")},null,new Color(100,0,0)),t.addLine(),t.addItem("open shared project from cloud...",function(){o.prompt("Author name&",function(e){o.prompt("Project name...",function(t){o.showMessage("Fetching project\nfrom the cloud..."),o.cloud.getPublicProject(t,e.toLowerCase(),function(t){var e;Process.prototype.isCatchingErrors||window.open("data:text/xml,"+t),o.nextSteps([function(){e=o.showMessage("Opening project...")},function(){nop()},function(){o.rawOpenCloudDataString(t)},function(){e.destroy()}])},o.cloudError())},null,"project")},null,"project")},null,new Color(100,0,0))),t.popup(e,i)):this.showMessage("cloud unavailable without a web server.")},IDE_Morph.prototype.settingsMenu=function(){var n,t=this.stage,e=this.world(),o=this,i=this.controlBar.settingsButton.bottomLeft(),a=16===e.currentKey;function r(t,e,o,i,r,s){s&&!a||n.addItem((o?" ":" ")+localize(t),e,o?i:r,s?new Color(100,0,0):null)}(n=new MenuMorph(this)).addPair([new SymbolMorph("globe",MorphicPreferences.menuFontSize),localize("Language...")],"languageMenu"),n.addItem("Zoom blocks...","userSetBlocksScale"),n.addItem("Stage size...","userSetStageSize"),a&&n.addItem("Dragging threshold...","userSetDragThreshold","specify the distance the hand has to move\nbefore it picks up an object",new Color(100,0,0)),n.addItem("Microphone resolution...","microphoneMenu"),n.addLine(),isRetinaSupported()&&r("Retina display support","toggleRetina",isRetinaEnabled(),"uncheck for lower resolution,\nsaves computing resources","check for higher resolution,\nuses more computing resources"),r("Input sliders","toggleInputSliders",MorphicPreferences.useSliderForInput,"uncheck to disable\ninput sliders for\nentry fields","check to enable\ninput sliders for\nentry fields"),MorphicPreferences.useSliderForInput&&r("Execute on slider change","toggleSliderExecute",ArgMorph.prototype.executeOnSliderEdit,"uncheck to suppress\nrunning scripts\nwhen moving the slider","check to run\nthe edited script\nwhen moving the slider"),r("Turbo mode","toggleFastTracking",this.stage.isFastTracked,"uncheck to run scripts\nat normal speed","check to prioritize\nscript execution"),r("Visible stepping","toggleSingleStepping",Process.prototype.enableSingleStepping,"uncheck to turn off\nvisible stepping","check to turn on\n visible stepping (slow)",!1),r("Ternary Boolean slots",function(){BooleanSlotMorph.prototype.isTernary=!BooleanSlotMorph.prototype.isTernary},BooleanSlotMorph.prototype.isTernary,"uncheck to limit\nBoolean slots to true / false","check to allow\nempty Boolean slots",!0),r("Camera support","toggleCameraSupport",CamSnapshotDialogMorph.prototype.enableCamera,"uncheck to disable\ncamera support","check to enable\ncamera support",!0),n.addLine(),r("Blurred shadows","toggleBlurredShadows",useBlurredShadows,"uncheck to use solid drop\nshadows and highlights","check to use blurred drop\nshadows and highlights",!0),r("Zebra coloring","toggleZebraColoring",BlockMorph.prototype.zebraContrast,"uncheck to disable alternating\ncolors for nested block","check to enable alternating\ncolors for nested blocks",!0),r("Dynamic input labels","toggleDynamicInputLabels",SyntaxElementMorph.prototype.dynamicInputLabels,"uncheck to disable dynamic\nlabels for variadic inputs","check to enable dynamic\nlabels for variadic inputs",!0),r("Prefer empty slot drops","togglePreferEmptySlotDrops",ScriptsMorph.prototype.isPreferringEmptySlots,"uncheck to allow dropped\nreporters to kick out others","settings menu prefer empty slots hint",!0),r("Long form input dialog","toggleLongFormInputDialog",InputSlotDialogMorph.prototype.isLaunchingExpanded,"uncheck to use the input\ndialog in short form","check to always show slot\ntypes in the input dialog"),r("Plain prototype labels","togglePlainPrototypeLabels",BlockLabelPlaceHolderMorph.prototype.plainLabel,"uncheck to always show (+) symbols\nin block prototype labels","check to hide (+) symbols\nin block prototype labels"),r("Virtual keyboard","toggleVirtualKeyboard",MorphicPreferences.useVirtualKeyboard,"uncheck to disable\nvirtual keyboard support\nfor mobile devices","check to enable\nvirtual keyboard support\nfor mobile devices",!0),r("Clicking sound",function(){BlockMorph.prototype.toggleSnapSound(),BlockMorph.prototype.snapSound?o.saveSetting("click",!0):o.removeSetting("click")},BlockMorph.prototype.snapSound,"uncheck to turn\nblock clicking\nsound off","check to turn\nblock clicking\nsound on"),r("Animations",function(){o.isAnimating=!o.isAnimating},o.isAnimating,"uncheck to disable\nIDE animations","check to enable\nIDE animations",!0),r("Cache Inputs",function(){BlockMorph.prototype.isCachingInputs=!BlockMorph.prototype.isCachingInputs},BlockMorph.prototype.isCachingInputs,"uncheck to stop caching\ninputs (for debugging the evaluator)","check to cache inputs\nboosts recursion",!0),r("Rasterize SVGs",function(){MorphicPreferences.rasterizeSVGs=!MorphicPreferences.rasterizeSVGs},MorphicPreferences.rasterizeSVGs,"uncheck for smooth\nscaling of vector costumes","check to rasterize\nSVGs on import",!0),r("Flat design",function(){return MorphicPreferences.isFlat?o.defaultDesign():void o.flatDesign()},MorphicPreferences.isFlat,"uncheck for default\nGUI design","check for alternative\nGUI design",!1),r("Nested auto-wrapping",function(){ScriptsMorph.prototype.enableNestedAutoWrapping=!ScriptsMorph.prototype.enableNestedAutoWrapping,ScriptsMorph.prototype.enableNestedAutoWrapping?o.removeSetting("autowrapping"):o.saveSetting("autowrapping",!1)},ScriptsMorph.prototype.enableNestedAutoWrapping,"uncheck to confine auto-wrapping\nto top-level block stacks","check to enable auto-wrapping\ninside nested block stacks",!0),r("Project URLs",function(){o.projectsInURLs=!o.projectsInURLs,o.projectsInURLs?o.saveSetting("longurls",!0):o.removeSetting("longurls")},o.projectsInURLs,"uncheck to disable\nproject data in URLs","check to enable\nproject data in URLs",!0),r("Sprite Nesting",function(){SpriteMorph.prototype.enableNesting=!SpriteMorph.prototype.enableNesting},SpriteMorph.prototype.enableNesting,"uncheck to disable\nsprite composition","check to enable\nsprite composition",!0),r("First-Class Sprites",function(){SpriteMorph.prototype.enableFirstClass=!SpriteMorph.prototype.enableFirstClass,o.currentSprite.blocksCache.sensing=null,o.currentSprite.paletteCache.sensing=null,o.refreshPalette()},SpriteMorph.prototype.enableFirstClass,"uncheck to disable support\nfor first-class sprites","check to enable support\n for first-class sprite",!0),r("Keyboard Editing",function(){ScriptsMorph.prototype.enableKeyboard=!ScriptsMorph.prototype.enableKeyboard,o.currentSprite.scripts.updateToolbar(),ScriptsMorph.prototype.enableKeyboard?o.removeSetting("keyboard"):o.saveSetting("keyboard",!1)},ScriptsMorph.prototype.enableKeyboard,"uncheck to disable\nkeyboard editing support","check to enable\nkeyboard editing support",!0),r("Table support",function(){List.prototype.enableTables=!List.prototype.enableTables,List.prototype.enableTables?o.removeSetting("tables"):o.saveSetting("tables",!1)},List.prototype.enableTables,"uncheck to disable\nmulti-column list views","check for multi-column\nlist view support",!0),List.prototype.enableTables&&r("Table lines",function(){TableMorph.prototype.highContrast=!TableMorph.prototype.highContrast,TableMorph.prototype.highContrast?o.saveSetting("tableLines",!0):o.removeSetting("tableLines")},TableMorph.prototype.highContrast,"uncheck for less contrast\nmulti-column list views","check for higher contrast\ntable views",!0),r("Live coding support",function(){Process.prototype.enableLiveCoding=!Process.prototype.enableLiveCoding},Process.prototype.enableLiveCoding,"EXPERIMENTAL! uncheck to disable live\ncustom control structures","EXPERIMENTAL! check to enable\n live custom control structures",!0),r("JIT compiler support",function(){Process.prototype.enableCompiling=!Process.prototype.enableCompiling,o.currentSprite.blocksCache.operators=null,o.currentSprite.paletteCache.operators=null,o.refreshPalette()},Process.prototype.enableCompiling,"EXPERIMENTAL! uncheck to disable live\nsupport for compiling","EXPERIMENTAL! check to enable\nsupport for compiling",!0),n.addLine(),r("Thread safe scripts",function(){t.isThreadSafe=!t.isThreadSafe},this.stage.isThreadSafe,"uncheck to allow\nscript reentrance","check to disallow\nscript reentrance"),r("Prefer smooth animations","toggleVariableFrameRate",StageMorph.prototype.frameRate,"uncheck for greater speed\nat variable frame rates","check for smooth, predictable\nanimations across computers",!0),r("Flat line ends",function(){SpriteMorph.prototype.useFlatLineEnds=!SpriteMorph.prototype.useFlatLineEnds},SpriteMorph.prototype.useFlatLineEnds,"uncheck for round ends of lines","check for flat ends of lines"),r("Codification support",function(){StageMorph.prototype.enableCodeMapping=!StageMorph.prototype.enableCodeMapping,o.currentSprite.blocksCache.variables=null,o.currentSprite.paletteCache.variables=null,o.refreshPalette()},StageMorph.prototype.enableCodeMapping,"uncheck to disable\nblock to text mapping features","check for block\nto text mapping features",!1),r("Inheritance support",function(){StageMorph.prototype.enableInheritance=!StageMorph.prototype.enableInheritance,o.currentSprite.blocksCache.variables=null,o.currentSprite.paletteCache.variables=null,o.refreshPalette()},StageMorph.prototype.enableInheritance,"uncheck to disable\nsprite inheritance features","check for sprite\ninheritance features",!0),r("Persist linked sublist IDs",function(){StageMorph.prototype.enableSublistIDs=!StageMorph.prototype.enableSublistIDs},StageMorph.prototype.enableSublistIDs,"uncheck to disable\nsaving linked sublist identities","check to enable\nsaving linked sublist identities",!0),r("Enable command drops in all rings",function(){RingReporterSlotMorph.prototype.enableCommandDrops=!RingReporterSlotMorph.prototype.enableCommandDrops},RingReporterSlotMorph.prototype.enableCommandDrops,"uncheck to disable\ndropping commands in reporter rings","check to enable\ndropping commands in all rings",!0),n.popup(e,i)},IDE_Morph.prototype.projectMenu=function(){var o=this,t=this.world(),e=this.controlBar.projectButton.bottomLeft(),i=this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds",r=16===t.currentKey,s=new MenuMorph(this);s.addItem("Project notes...","editProjectNotes"),s.addLine(),s.addPair("New","createNewProject","^N"),s.addPair("Open...","openProjectsBrowser","^O"),s.addPair("Save","save","^S"),s.addItem("Save As...","saveProjectsBrowser"),s.addLine(),s.addItem("Import...","importLocalFile","file menu import hint"),r&&s.addItem(localize("Export project...")+" "+localize("(in a new window)"),function(){o.projectName?o.exportProject(o.projectName,r):o.prompt("Export Project As...",function(t){o.exportProject(t,!1)},null,"exportProject")},"show project data as XML\nin a new browser window",new Color(100,0,0)),s.addItem(r?"Export project as plain text...":"Export project...",function(){o.projectName?o.exportProject(o.projectName,r):o.prompt("Export Project As...",function(t){o.exportProject(t,r)},null,"exportProject")},"save project data as XML\nto your downloads folder",r?new Color(100,0,0):null),this.stage.globalBlocks.length&&(s.addItem("Export blocks...",function(){o.exportGlobalBlocks()},"show global custom block definitions as XML\nin a new browser window"),s.addItem("Unused blocks...",function(){o.removeUnusedBlocks()},"find unused global custom blocks\nand remove their definitions")),s.addItem("Export summary...",function(){o.exportProjectSummary()},"open a new browser browser window\n with a summary of this project"),r&&(s.addItem("Export summary with drop-shadows...",function(){o.exportProjectSummary(!0)},"open a new browser browser window\nwith a summary of this project\nwith drop-shadows on all pictures.\nnot supported by all browsers",new Color(100,0,0)),s.addItem("Export all scripts as pic...",function(){o.exportScriptsPicture()},"show a picture of all scripts\nand block definitions",new Color(100,0,0))),s.addLine(),s.addItem("Libraries...",function(){"file:"!==location.protocol?o.getURL(o.resourceURL("libraries","LIBRARIES"),function(t){var e=o.parseResourceFile(t);new LibraryImportDialogMorph(o,e).popUp()}):o.importLocalFile()},"Select categories of additional blocks to add to this project."),s.addItem(localize(i)+"...",function(){"file:"!==location.protocol?o.importMedia(i):o.importLocalFile()},"Select a costume from the media library"),s.addItem(localize("Sounds")+"...",function(){"file:"!==location.protocol?o.importMedia("Sounds"):o.importLocalFile()},"Select a sound from the media library"),s.popup(t,e)},IDE_Morph.prototype.resourceURL=function(){return Array.prototype.slice.call(arguments,0).join("/")},IDE_Morph.prototype.getMediaList=function(t,o){var e,i=this.resourceURL(t,t.toUpperCase()),r=o instanceof Function,s=this;function n(t,e){return t.name.toLowerCase()<e.name.toLowerCase()?-1:1}if(!r)return(e=this.parseResourceFile(this.getURL(i))).sort(n),e;this.getURL(i,function(t){var e=s.parseResourceFile(t);e.sort(n),o.call(this,e)})},IDE_Morph.prototype.parseResourceFile=function(t){var e,o=[];return t.split("\n").map(function(t){return t.trim()}).filter(function(t){return 0<t.length}).forEach(function(t){(e=t.split("\t").map(function(t){return t.trim()})).length<2||o.push({fileName:e[0],name:e[1],description:2<e.length?e[2]:""})}),o},IDE_Morph.prototype.importLocalFile=function(){var t=document.createElement("input"),e=this,o=this.world();this.filePicker&&(document.body.removeChild(this.filePicker),this.filePicker=null),t.type="file",t.style.color="transparent",t.style.backgroundColor="transparent",t.style.border="none",t.style.outline="none",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="0px",t.style.height="0px",t.style.display="none",t.addEventListener("change",function(){document.body.removeChild(t),e.filePicker=null,o.hand.processDrop(t.files)},!1),document.body.appendChild(t),(this.filePicker=t).click()},IDE_Morph.prototype.importMedia=function(e){var o=this,i=this.showMessage("Opening "+e+"...");this.getMediaList(e,function(t){i.destroy(),o.popupMediaImportDialog(e,t)})},IDE_Morph.prototype.popupMediaImportDialog=function(p,t){var l=(new DialogBoxMorph).withKey("import"+p),c=new ScrollFrameMorph,d=null,u=new SymbolMorph("turtle",60),g=this,e=this.world();c.acceptsDrops=!1,c.contents.acceptsDrops=!1,c.color=g.groupColor,c.fixLayout=nop,l.labelString=p,l.createLabel(),l.addBody(c),l.addButton("ok","Import"),l.addButton("cancel","Cancel"),l.ok=function(){d&&(d.object instanceof Sound?g.droppedAudio(d.object.copy().audio,d.labelString):d.object instanceof SVG_Costume?g.droppedSVG(d.object.contents,d.labelString):g.droppedImage(d.object.contents,d.labelString))},l.fixLayout=function(){var e,o,t=fontHeight(this.titleFontSize)+2*this.titlePadding,i=0,r=0;this.buttons.fixLayout(),this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height())),e=this.body.position(),o=this.body.width(),c.contents.children.forEach(function(t){t.setPosition(e.add(new Point(i,r))),(i+=t.width())+t.width()>o&&(i=0,r+=t.height())}),c.contents.adjustBounds(),this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)},t.forEach(function(e){var t,o,i,r=g.resourceURL(p,e.fileName),s=new Image,n=r.slice(r.lastIndexOf(".")+1).toLowerCase(),a="svg"===n&&!MorphicPreferences.rasterizeSVGs,h=contains(["wav","mp3"],n);h?o=i=new SoundIconMorph(new Sound(new Audio,e.name),o):t=i=new CostumeIconMorph(new Costume(u.image,e.name),t),i.isDraggable=!1,i.userMenu=nop,i.action=function(){var t;d!==i&&(t=d,d=i,t&&t.refresh())},i.doubleClickAction=l.ok,i.query=function(){return i===d},c.addContents(i),h?(i.object.audio.onloadeddata=function(){i.createThumbnail(),i.fixLayout(),i.refresh()},i.object.audio.src=r,i.object.audio.load()):a?(s.onload=function(){i.object=new SVG_Costume(s,e.name),i.refresh()},g.getURL(r,function(t){s.src="data:image/svg+xml;base64,"+window.btoa(t)})):(s.onload=function(){var t=newCanvas(new Point(s.width,s.height),!0);t.getContext("2d").drawImage(s,0,0),i.object=new Costume(t,e.name),i.refresh()},s.src=r)}),l.popUp(e),l.setExtent(new Point(400,300)),l.setCenter(e.center()),l.drawNew(),new HandleMorph(l,300,280,l.corner,l.corner)},IDE_Morph.prototype.aboutSnap=function(){var t,e,o,i,r,s,n,a,h,p="",l=this.world(),c="Robot In A Can Snap! 5.0.5\n\nCopyright ¸ 2019 Robot In A Can \n Jens Mönig and Brian Harvey\ninfo@robotinacan.com, jens@moenig.org, bh@cs.berkeley.edu\n\nSnap! is developed by the University of California, Berkeley\n          with support from the National Science Foundation (NSF), MioSoft,          \nthe Communications Design Group (CDG) at SAP Labs, and the\nHuman Advancement Research Community (HARC) at YC Research.\nThe design of Snap! is influenced and inspired by Scratch,\nfrom the Lifelong Kindergarten group at the MIT Media Lab\n\nfor more information see http://snap.berkeley.edu\nand http://scratch.mit.edu",d=localize("License")+"\n\nRobot In A Can Snap! is free software: you can redistribute it and/or modify\nit under the terms of the GNU Affero General Public License as\npublished by the Free Software Foundation, either version 3 of\nthe License, or (at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\nGNU Affero General Public License for more details.\n\nYou should have received a copy of the\nGNU Affero General Public License along with this program.\nIf not, see http://www.gnu.org/licenses/\n\nWant to use Snap! but scared by the open-source license?\nGet in touch with us, we'll make it work.",u=localize("Contributors")+'\n\nRobot In A Can Inc. \n\nNathan Dinsmore: Saving/Loading, Snap-Logo Design, \ncountless bugfixes and optimizations\nKartik Chandra: Paint Editor\nMichael Ball: Time/Date UI, Library Import Dialog,\ncountless bugfixes and optimizations\nBartosz Leper: Retina Display Support\nBernat Romagosa: Countless contributions\nJosep Ferràndiz: Video Motion Detection\nJoan Guillén: Countless contributions\nCarles Paredes: Initial Vector Paint Editor\n"Ava" Yuan Yuan, Dylan Servilla: Graphic Effects\nKyle Hotchkiss: Block search design\nBrian Broll: Many bugfixes and optimizations\nIan Reynolds: UI Design, Event Bindings, Sound primitives\nIvan Motyashov: Initial Squeak Porting\nLucas Karahadian: Piano Keyboard Design\nDavide Della Casa: Morphic Optimizations\nAchal Dave: Web Audio\nJoe Otto: Morphic Testing and Debugging';for(o in modules)Object.prototype.hasOwnProperty.call(modules,o)&&(p+="\n"+o+" ("+modules[o]+")");""!==p&&(p=localize("current module versions:")+" \n\nmorphic ("+morphicVersion+")"+p),e=localize("Translations")+"\n"+SnapTranslator.credits(),(t=new DialogBoxMorph).inform("About Snap",c,l),i=t.buttons.children[0],h=t.addButton(function(){t.body.text=e,t.body.drawNew(),i.show(),r.show(),s.hide(),n.hide(),a.hide(),h.hide(),t.fixLayout(),t.drawNew(),t.setCenter(l.center())},"Translators..."),(r=t.addButton(function(){t.body.text=c,t.body.drawNew(),i.show(),r.hide(),s.show(),n.show(),a.show(),h.hide(),t.fixLayout(),t.drawNew(),t.setCenter(l.center())},"Back...")).hide(),a=t.addButton(function(){t.body.text=d,t.body.drawNew(),i.show(),r.show(),s.hide(),n.hide(),a.hide(),h.hide(),t.fixLayout(),t.drawNew(),t.setCenter(l.center())},"License..."),s=t.addButton(function(){t.body.text=p,t.body.drawNew(),i.show(),r.show(),s.hide(),n.hide(),a.hide(),h.hide(),t.fixLayout(),t.drawNew(),t.setCenter(l.center())},"Modules..."),n=t.addButton(function(){t.body.text=u,t.body.drawNew(),i.show(),r.show(),h.show(),s.hide(),n.hide(),a.hide(),t.fixLayout(),t.drawNew(),t.setCenter(l.center())},"Credits..."),h.hide(),t.fixLayout(),t.drawNew()},IDE_Morph.prototype.editProjectNotes=function(){var t=(new DialogBoxMorph).withKey("projectNotes"),e=new ScrollFrameMorph,o=new TextMorph(this.projectNotes||""),i=this,r=this.world();e.padding=6,e.setWidth(250),e.acceptsDrops=!1,e.contents.acceptsDrops=!1,o.setWidth(250-2*e.padding),o.setPosition(e.topLeft().add(e.padding)),o.enableSelecting(),o.isEditable=!0,e.setHeight(250),e.fixLayout=nop,e.edge=InputFieldMorph.prototype.edge,e.fontSize=InputFieldMorph.prototype.fontSize,e.typeInPadding=InputFieldMorph.prototype.typeInPadding,e.contrast=InputFieldMorph.prototype.contrast,e.drawNew=InputFieldMorph.prototype.drawNew,e.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,e.addContents(o),o.drawNew(),t.getInput=function(){return o.text},t.target=i,t.action=function(t){i.projectNotes=t},t.justDropped=function(){o.edit()},t.labelString="Project Notes",t.createLabel(),t.addBody(e),e.drawNew(),t.addButton("ok","OK"),t.addButton("cancel","Cancel"),t.fixLayout(),t.drawNew(),t.popUp(r),t.setCenter(r.center()),o.edit()},IDE_Morph.prototype.newProject=function(){this.source=this.cloud.username?"cloud":null,this.stage&&this.stage.destroy(),"#lang:"!==location.hash.substr(0,6)&&(location.hash=""),this.globalVariables=new VariableFrame,this.currentSprite=new SpriteMorph(this.globalVariables),this.sprites=new List([this.currentSprite]),StageMorph.prototype.dimensions=new Point(480,360),StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!0,StageMorph.prototype.enableSublistIDs=!1,SpriteMorph.prototype.useFlatLineEnds=!1,Process.prototype.enableLiveCoding=!1,this.setProjectName(""),this.projectNotes="",this.createStage(),this.add(this.stage),this.createCorral(),this.selectSprite(this.stage.children[0]),this.fixLayout()},IDE_Morph.prototype.save=function(){var e=this;"file:"!==location.protocol?("examples"!==this.source&&"local"!==this.source||(this.source=null),this.projectName?"disk"===this.source?this.exportProject(this.projectName):"cloud"===this.source?this.saveProjectToCloud(this.projectName):this.saveProjectsBrowser():this.saveProjectsBrowser()):this.projectName?this.exportProject(e.projectName,!1):this.prompt("Export Project As...",function(t){e.exportProject(t,!1)},null,"exportProject")},IDE_Morph.prototype.exportProject=function(t,e){var o,i;if(t){this.setProjectName(t),0;try{o=this.showMessage("Exporting"),i=this.serializer.serialize(this.stage),this.setURL("#open:plain,"+encodeURIComponent(i)),this.saveXMLAs(i,t),o.destroy(),this.showMessage("Exported!",1)}catch(t){if(!Process.prototype.isCatchingErrors)throw t;this.showMessage("Export failed: "+t)}}},IDE_Morph.prototype.exportGlobalBlocks=function(){0<this.stage.globalBlocks.length?new BlockExportDialogMorph(this.serializer,this.stage.globalBlocks).popUp(this.world()):this.inform("Export blocks","this project doesn't have any\ncustom global blocks yet")},IDE_Morph.prototype.removeUnusedBlocks=function(){var t,e=this.sprites.asArray().concat([this.stage]),o=this.stage.globalBlocks,i=[],r=!1;for(;!r;)(t=o.filter(function(o){return!contains(i,o)&&e.every(function(t,e){return!t.usesBlockInstance(o,!0,e,i)})})).length?i=i.concat(t):r=!0;0<i.length?new BlockRemovalDialogMorph(i,this.stage).popUp(this.world()):this.inform("Remove unused blocks","there are currently no unused\nglobal custom blocks in this project")},IDE_Morph.prototype.exportSprite=function(t){var e=this.serializer.serialize(t.allParts()),e='<sprites app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+e+"</sprites>";this.saveXMLAs(e,t.name)},IDE_Morph.prototype.exportScriptsPicture=function(){var t,e,o=[],i=0,r=0,s=0;this.sprites.asArray().forEach(function(t){o.push(t.image),o.push(t.scripts.scriptsPicture()),t.customBlocks.forEach(function(t){o.push(t.scriptsPicture())})}),o.push(this.stage.image),o.push(this.stage.scripts.scriptsPicture()),this.stage.customBlocks.forEach(function(t){o.push(t.scriptsPicture())}),this.stage.globalBlocks.forEach(function(t){o.push(t.scriptsPicture())}),(o=o.filter(function(t){return!isNil(t)})).forEach(function(t){i=Math.max(i,t.width),r+=t.height,r+=20}),r-=20,t=newCanvas(new Point(i,r)),e=t.getContext("2d"),o.forEach(function(t){e.drawImage(t,0,s),s+=20,s+=t.height}),this.saveCanvasAs(t,this.projectName||localize("Untitled"))},IDE_Morph.prototype.exportProjectSummary=function(t){var e,o,s,i,n,r,a=this.stage;function h(t,e,o){return e=e||s,new XML_Element(t,o,e)}function p(t,e,o){return e=e||"p",o=o||s,new XML_Element(e,t,o)}function l(t,e,o){e=e||s;var i=o?null:h("p",e),r=h("img",i||e);return r.attributes.src=t.toDataURL(),r}function c(r){var s,t=r.names().sort(),n=!0;t.length&&(p(localize("Variables"),"h3"),t.forEach(function(t){var e,o,i;n&&(s=h("ul"),n=!1),i=h("li",s),(o=(e=new WatcherMorph(t,SpriteMorph.prototype.blockColor.variables,r,t)).cellMorph.contentsMorph)instanceof ListWatcherMorph&&o.expand(),l(e.fullImageClassic(),i).attributes.class="script"}))}function d(t){t.length&&(p(localize("Blocks"),"h3"),SpriteMorph.prototype.categories.forEach(function(o){var i,r=!0;t.forEach(function(t){var e;t.category===o&&(r&&(p(localize(o[0].toUpperCase().concat(o.slice(1))),"h4"),i=h("ul"),r=!1),e=h("li",i),l(t.templateInstance().scriptPic(),e).attributes.class="script",t.sortedElements().forEach(function(t){l(t instanceof BlockMorph?t.scriptPic():t.fullImageClassic(),e).attributes.class="script"}))})}))}i=this.projectName||localize("untitled"),(e=new XML_Element("html")).attributes.lang=SnapTranslator.language,o=h("head",e),h("meta",o).attributes.charset="UTF-8",h("style",o,t?"img {vertical-align: top;filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-webkit-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-ms-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}":"img {vertical-align: top;}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}.sprite {border: 1px solid lightgray;}"),p(i,"title",o),s=h("body",e),p(i,"h1"),0===location.hash.indexOf("#present:")?(p(location.toString(),"a",s).attributes.href=location.toString(),l(a.thumbnail(a.dimensions)).attributes.class="sprite",p(this.serializer.app,"h4")):(p(this.serializer.app,"h4"),l(a.thumbnail(a.dimensions)).attributes.class="sprite"),Process.prototype.reportTextSplit(this.projectNotes,"line").asArray().forEach(function(t){p(t)}),p(localize("Contents"),"h4"),n=h("ul"),this.sprites.asArray().concat([a]).forEach(function(t){var o,e=h("li",n),i=t.scripts.sortedElements(),r=t.costumes.length();h("hr"),l(t.thumbnail(new Point(40,40)),e,!0).attributes.class="toc",p(t.name,"a",e).attributes.href="#"+t.name,p(t.name,"h2").attributes.id=t.name,l(t.thumbnail(t.extent().divideBy(a.scale))).attributes.class="sprite",t instanceof SpriteMorph&&(t.exemplar&&(l(t.exemplar.thumbnail(new Point(40,40)),p(localize("Kind of")+" "+t.exemplar.name),!0).attributes.class="toc"),t.anchor&&(l(t.anchor.thumbnail(new Point(40,40)),p(localize("Part of")+" "+t.anchor.name),!0).attributes.class="toc"),t.parts.length&&(p(localize("Parts"),"h3"),o=h("ul"),t.parts.forEach(function(t){var e=h("li",o,t.name);l(t.thumbnail(new Point(40,40)),e,!0).attributes.class="toc"}))),(1<r||t.getCostumeIdx()!==r)&&(p(localize("Costumes"),"h3"),o=h("ol"),t.costumes.asArray().forEach(function(t){var e=h("li",o,t.name);l(t.thumbnail(new Point(40,40)),e,!0).attributes.class="toc"})),t.sounds.length()&&(p(localize("Sounds"),"h3"),o=h("ol"),t.sounds.asArray().forEach(function(t){p(t.name,"li",o)})),c(t.variables),i.length&&(p(localize("Scripts"),"h3"),i.forEach(function(t){l(t instanceof BlockMorph?t.scriptPic():t.fullImageClassic()).attributes.class="script"})),d(t.customBlocks)}),r=a.globalVariables(),(Object.keys(r.vars).length||a.globalBlocks.length)&&(h("hr"),p(localize("For all Sprites"),"a",h("li",n)).attributes.href="#global",p(localize("For all Sprites"),"h2").attributes.id="global",c(r),d(a.globalBlocks)),this.saveFileAs("<!DOCTYPE html>"+e.toString(),"text/html;charset=utf-8",i)},IDE_Morph.prototype.openProjectString=function(t){var e,o=this;this.nextSteps([function(){e=o.showMessage("Opening project...")},function(){nop()},function(){o.rawOpenProjectString(t)},function(){e.destroy()}])},IDE_Morph.prototype.rawOpenProjectString=function(t){if(this.toggleAppMode(!1),this.spriteBar.tabBar.tabTo("scripts"),StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!0,StageMorph.prototype.enableSublistIDs=!1,Process.prototype.enableLiveCoding=!1,Process.prototype.isCatchingErrors)try{this.serializer.openProject(this.serializer.load(t,this),this)}catch(t){this.showMessage("Load failed: "+t)}else this.serializer.openProject(this.serializer.load(t,this),this);this.stopFastTracking()},IDE_Morph.prototype.openCloudDataString=function(t){var e,o=this,i=Math.round(t.length/1024);this.nextSteps([function(){e=o.showMessage("Opening project\n"+i+" KB...")},function(){nop()},function(){o.rawOpenCloudDataString(t)},function(){e.destroy()}])},IDE_Morph.prototype.rawOpenCloudDataString=function(t){var e;if(StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!0,StageMorph.prototype.enableSublistIDs=!1,Process.prototype.enableLiveCoding=!1,Process.prototype.isCatchingErrors)try{e=this.serializer.parse(t),this.serializer.loadMediaModel(e.childNamed("media")),this.serializer.openProject(this.serializer.loadProjectModel(e.childNamed("project"),this,e.attributes.remixID),this)}catch(t){this.showMessage("Load failed: "+t)}else e=this.serializer.parse(t),this.serializer.loadMediaModel(e.childNamed("media")),this.serializer.openProject(this.serializer.loadProjectModel(e.childNamed("project"),this,e.attributes.remixID),this);this.stopFastTracking()},IDE_Morph.prototype.openBlocksString=function(t,e,o){var i,r=this;this.nextSteps([function(){i=r.showMessage("Opening blocks...")},function(){nop()},function(){r.rawOpenBlocksString(t,e,o)},function(){i.destroy()}])},IDE_Morph.prototype.rawOpenBlocksString=function(t,e,o){var i,r=this;if(Process.prototype.isCatchingErrors)try{i=this.serializer.loadBlocks(t,r.stage)}catch(t){this.showMessage("Load failed: "+t)}else i=this.serializer.loadBlocks(t,r.stage);o?(i.forEach(function(t){t.receiver=r.stage,r.stage.globalBlocks.push(t),r.stage.replaceDoubleDefinitionsFor(t)}),this.flushPaletteCache(),this.refreshPalette(),this.showMessage("Imported Blocks Module"+(e?": "+e:"")+".",2)):new BlockImportDialogMorph(i,this.stage,e).popUp()},IDE_Morph.prototype.openSpritesString=function(t){var e,o=this;this.nextSteps([function(){e=o.showMessage("Opening sprite...")},function(){nop()},function(){o.rawOpenSpritesString(t)},function(){e.destroy()}])},IDE_Morph.prototype.rawOpenSpritesString=function(t){if(Process.prototype.isCatchingErrors)try{this.serializer.loadSprites(t,this)}catch(t){this.showMessage("Load failed: "+t)}else this.serializer.loadSprites(t,this)},IDE_Morph.prototype.openMediaString=function(t){if(Process.prototype.isCatchingErrors)try{this.serializer.loadMedia(t)}catch(t){this.showMessage("Load failed: "+t)}else this.serializer.loadMedia(t);this.showMessage("Imported Media Module.",2)},IDE_Morph.prototype.openScriptString=function(t){var e,o=this;this.nextSteps([function(){e=o.showMessage("Opening script...")},function(){nop()},function(){o.rawOpenScriptString(t)},function(){e.destroy()}])},IDE_Morph.prototype.rawOpenScriptString=function(t){var e,o,i=this.currentSprite.scripts;if(Process.prototype.isCatchingErrors)try{e=this.serializer.parse(t,this.currentSprite),o=this.serializer.loadScript(e,this.currentSprite)}catch(t){this.showMessage("Load failed: "+t)}else e=this.serializer.loadScript(t,this.currentSprite),o=this.serializer.loadScript(e,this.currentSprite);o.setPosition(this.world().hand.position()),i.add(o),i.adjustBounds(),i.lastDroppedBlock=o,i.recordDrop({origin:this.palette,position:this.palette.center()}),this.showMessage("Imported Script.",2)},IDE_Morph.prototype.openDataString=function(t,e,o){var i,r=this;this.nextSteps([function(){i=r.showMessage("Opening data...")},function(){nop()},function(){r.rawOpenDataString(t,e,o)},function(){i.destroy()}])},IDE_Morph.prototype.rawOpenDataString=function(t,e,o){var i,r,s,n=this.currentSprite.globalVariables();switch(o){case"csv":i=Process.prototype.parseCSV(t);break;case"json":i=Process.prototype.parseJSON(t);break;default:i=t}r=function(t){for(var e=n.names(),o=t.indexOf("("),i=o<0?t:t.substring(0,o),r=1,s=i;contains(e,s);)s=i+"("+(r+=1)+")";return s}(e||"data"),n.addVar(r),n.setVar(r,i),this.currentSprite.toggleVariableWatcher(r,!0),this.flushBlocksCache("variables"),this.currentCategory="variables",this.categories.children.forEach(function(t){t.refresh()}),this.refreshPalette(!0),i instanceof List&&((s=new TableDialogMorph(i)).labelString=localize(s.labelString)+": "+r,s.createLabel(),s.popUp(this.world()))},IDE_Morph.prototype.openProject=function(t){var e;t&&(this.showMessage("opening project\n"+t),this.setProjectName(t),e=localStorage["-snap-project-"+t],this.openProjectString(e),this.setURL("#open:"+e))},IDE_Morph.prototype.setURL=function(t){location.hash=this.projectsInURLs?t:""},IDE_Morph.prototype.saveFileAs=function(t,e,o){var i,r,s=!1,n=this.world();i="."+("plain"===(i=e.split("/")[1].split(";")[0])?"txt":i);try{s=!!new Blob}catch(t){}s?(t instanceof Blob||(t=function(t,e){var o,i=t,r=t.split(","),s=0===t.indexOf("data:");if(s&&-1<r[0].indexOf("base64"))for(t=atob(r[1]),i=new Uint8Array(t.length),o=t.length;o--;)i[o]=t.charCodeAt(o);else if(s)for(t=t.replace(/^data:image\/.*?, */,""),i=new Uint8Array(t.length),o=t.length;o--;)i[o]=t.charCodeAt(o);return new Blob([i],{type:e})}(t,e)),saveAs(t,o+i,!1)):((r=new DialogBoxMorph).inform(localize("Could not export")+" "+o,"unable to export text",n),r.fixLayout(),r.drawNew())},IDE_Morph.prototype.saveCanvasAs=function(t,e){this.saveFileAs(t.toDataURL(),"image/png",e)},IDE_Morph.prototype.saveAudioAs=function(t,e){this.saveFileAs(t.src,"audio/wav",e)},IDE_Morph.prototype.saveXMLAs=function(t,e){this.saveFileAs(t,"text/xml;chartset=utf-8",e)},IDE_Morph.prototype.switchToUserMode=function(){var e=this.world();e.isDevMode=!1,Process.prototype.isCatchingErrors=!0,this.controlBar.updateLabel(),this.isAutoFill=!0,this.isDraggable=!1,this.reactToWorldResize(e.bounds.copy()),this.siblings().forEach(function(t){t instanceof DialogBoxMorph?e.add(t):t.destroy()}),this.flushBlocksCache(),this.refreshPalette(),e.reactToDropOf=function(t){t instanceof DialogBoxMorph||t instanceof MenuMorph||(e.hand.grabOrigin?t.slideBackTo(e.hand.grabOrigin):e.hand.grab(t))},this.showMessage("entering user mode",1)},IDE_Morph.prototype.switchToDevMode=function(){var t=this.world();t.isDevMode=!0,Process.prototype.isCatchingErrors=!1,this.controlBar.updateLabel(),this.isAutoFill=!1,this.isDraggable=!0,this.setExtent(t.extent().subtract(100)),this.setPosition(t.position().add(20)),this.flushBlocksCache(),this.refreshPalette(),delete t.reactToDropOf,this.showMessage("entering development mode.\n\nerror catching is turned off,\nuse the browser's web console\nto see error messages.")},IDE_Morph.prototype.flushBlocksCache=function(e){e?(this.stage.blocksCache[e]=null,this.stage.children.forEach(function(t){t instanceof SpriteMorph&&(t.blocksCache[e]=null)})):(this.stage.blocksCache={},this.stage.children.forEach(function(t){t instanceof SpriteMorph&&(t.blocksCache={})})),this.flushPaletteCache(e)},IDE_Morph.prototype.flushPaletteCache=function(e){e?(this.stage.paletteCache[e]=null,this.stage.children.forEach(function(t){t instanceof SpriteMorph&&(t.paletteCache[e]=null)})):(this.stage.paletteCache={},this.stage.children.forEach(function(t){t instanceof SpriteMorph&&(t.paletteCache={})}))},IDE_Morph.prototype.toggleZebraColoring=function(){var e=[];BlockMorph.prototype.zebraContrast?BlockMorph.prototype.zebraContrast=0:BlockMorph.prototype.zebraContrast=40,this.stage.children.concat(this.stage).forEach(function(t){isSnapObject(t)&&(e=e.concat(t.scripts.children.filter(function(t){return t instanceof BlockMorph})))}),e.forEach(function(t){t.fixBlockColor(null,!0)})},IDE_Morph.prototype.toggleDynamicInputLabels=function(){var t;if(SyntaxElementMorph.prototype.dynamicInputLabels=!SyntaxElementMorph.prototype.dynamicInputLabels,Process.prototype.isCatchingErrors)try{t=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else t=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.openProjectString(t)},IDE_Morph.prototype.toggleBlurredShadows=function(){window.useBlurredShadows=!useBlurredShadows},IDE_Morph.prototype.toggleLongFormInputDialog=function(){InputSlotDialogMorph.prototype.isLaunchingExpanded=!InputSlotDialogMorph.prototype.isLaunchingExpanded,InputSlotDialogMorph.prototype.isLaunchingExpanded?this.saveSetting("longform",!0):this.removeSetting("longform")},IDE_Morph.prototype.togglePlainPrototypeLabels=function(){BlockLabelPlaceHolderMorph.prototype.plainLabel=!BlockLabelPlaceHolderMorph.prototype.plainLabel,BlockLabelPlaceHolderMorph.prototype.plainLabel?this.saveSetting("plainprototype",!0):this.removeSetting("plainprototype")},IDE_Morph.prototype.togglePreferEmptySlotDrops=function(){ScriptsMorph.prototype.isPreferringEmptySlots=!ScriptsMorph.prototype.isPreferringEmptySlots},IDE_Morph.prototype.toggleVirtualKeyboard=function(){MorphicPreferences.useVirtualKeyboard=!MorphicPreferences.useVirtualKeyboard},IDE_Morph.prototype.toggleInputSliders=function(){MorphicPreferences.useSliderForInput=!MorphicPreferences.useSliderForInput},IDE_Morph.prototype.toggleSliderExecute=function(){ArgMorph.prototype.executeOnSliderEdit=!ArgMorph.prototype.executeOnSliderEdit},IDE_Morph.prototype.setEmbedMode=function(){var t=this;this.isEmbedMode=!0,this.appModeColor=new Color(243,238,235),this.embedOverlay=new Morph,this.embedOverlay.color=new Color(128,128,128),this.embedOverlay.alpha=.5,this.embedPlayButton=new SymbolMorph("circleSolid"),this.embedPlayButton.color=new Color(64,128,64),this.embedPlayButton.alpha=.75,this.embedPlayButton.flag=new SymbolMorph("flag"),this.embedPlayButton.flag.color=new Color(128,255,128),this.embedPlayButton.flag.alpha=.75,this.embedPlayButton.add(this.embedPlayButton.flag),this.embedPlayButton.mouseClickLeft=function(){t.runScripts(),t.embedOverlay.destroy(),this.destroy()},this.controlBar.hide(),this.add(this.embedOverlay),this.add(this.embedPlayButton),this.fixLayout()},IDE_Morph.prototype.toggleAppMode=function(t){var e=this.world(),o=[this.logo,this.controlBar.cloudButton,this.controlBar.projectButton,this.controlBar.settingsButton,this.controlBar.steppingButton,this.controlBar.stageSizeButton,this.paletteHandle,this.stageHandle,this.corral,this.corralBar,this.spriteEditor,this.spriteBar,this.palette,this.categories];this.isAppMode=isNil(t)?!this.isAppMode:t,Morph.prototype.trackChanges=!1,this.isAppMode?(this.wasSingleStepping=Process.prototype.enableSingleStepping,this.wasSingleStepping&&this.toggleSingleStepping(),this.setColor(this.appModeColor),this.controlBar.setColor(this.color),this.controlBar.appModeButton.refresh(),o.forEach(function(t){t.hide()}),e.children.forEach(function(t){t instanceof DialogBoxMorph&&t.hide()}),e.keyboardReceiver instanceof ScriptFocusMorph&&e.keyboardReceiver.stopEditing()):(this.wasSingleStepping&&!Process.prototype.enableSingleStepping&&this.toggleSingleStepping(),this.setColor(this.backgroundColor),this.controlBar.setColor(this.frameColor),o.forEach(function(t){t.show()}),this.stage.setScale(1),e.children.forEach(function(t){t instanceof DialogBoxMorph&&t.show()}),e.allChildren().filter(function(t){return t instanceof ScrollFrameMorph}).forEach(function(t){t.adjustScrollBars()}),this.currentSprite===this.stage&&this.spriteBar.children.forEach(function(t){t instanceof PushButtonMorph&&t.hide()}),this.currentSprite.scripts.updateToolbar()),this.setExtent(this.world().extent())},IDE_Morph.prototype.toggleStageSize=function(t,e){var o=this,i=e||.5,r=this.isAnimating?100:0,s=this.world(),n=16===s.currentKey,a=18===s.currentKey;function h(){o.isSmallStage=isNil(t)?!o.isSmallStage:t}function p(t){o.isSmallStage=!0,s.animations.push(new Animation(function(t){o.stageRatio=t,o.setExtent(s.extent())},function(){return o.stageRatio},t-o.stageRatio,r,null,function(){o.isSmallStage=1!==t,o.controlBar.stageSizeButton.refresh()}))}n?(i=3*SpriteIconMorph.prototype.thumbSize.x/this.stage.dimensions.x,this.isSmallStage&&i!==this.stageRatio||h()):a?(i=this.width()/2/this.stage.dimensions.x,this.isSmallStage&&i!==this.stageRatio||h()):h(),this.isSmallStage?p(i):p(1)},IDE_Morph.prototype.setPaletteWidth=function(t){var e=this.isAnimating?100:0,o=this.world(),i=this;o.animations.push(new Animation(function(t){i.paletteWidth=t,i.setExtent(o.extent())},function(){return i.paletteWidth},t-i.paletteWidth,e))},IDE_Morph.prototype.createNewProject=function(){var t=this;this.confirm("Replace the current project with a new one?","New Project",function(){t.newProject()})},IDE_Morph.prototype.openProjectsBrowser=function(){"file:"!==location.protocol?new ProjectDialogMorph(this,"open").popUp():this.importLocalFile()},IDE_Morph.prototype.saveProjectsBrowser=function(){var e=this;"file:"!==location.protocol?("examples"===this.source&&(this.source=null),new ProjectDialogMorph(this,"save").popUp()):this.prompt("Export Project As...",function(t){e.exportProject(t,!1)},null,"exportProject")},IDE_Morph.prototype.microphoneMenu=function(){var o=new MenuMorph(this),t=this.world(),e=this.controlBar.settingsButton.bottomLeft(),i=this.stage.microphone;i.isReady&&(o.addItem(" "+localize("Microphone"),function(){i.stop()}),o.addLine()),["low","normal","high","max"].forEach(function(t,e){o.addItem((i.resolution===e+1?" ":"    ")+localize(t),function(){i.setResolution(e+1)})}),o.popup(t,e)},IDE_Morph.prototype.languageMenu=function(){var e=new MenuMorph(this),t=this.world(),o=this.controlBar.settingsButton.bottomLeft(),i=this;SnapTranslator.languages().forEach(function(t){e.addItem((SnapTranslator.language===t?" ":"    ")+SnapTranslator.languageName(t),function(){i.loadNewProject=!1,i.setLanguage(t)})}),e.popup(t,o)},IDE_Morph.prototype.setLanguage=function(t,e,o){var i=document.getElementById("language"),r=this.resourceURL("app/assets/apps/snap/locale","lang-"+t+".js"),s=this;if(SnapTranslator.unload(),i&&document.head.removeChild(i),"en"===t)return this.reflectLanguage("en",e,o);(i=document.createElement("script")).id="language",i.onload=function(){s.reflectLanguage(t,e,o)},document.head.appendChild(i),i.src=r},IDE_Morph.prototype.reflectLanguage=function(t,e,o){var i,r=location.hash;if(SnapTranslator.language=t,!this.loadNewProject)if(Process.prototype.isCatchingErrors)try{i=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else i=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.fixLayout(),this.loadNewProject?(this.newProject(),location.hash=r):this.openProjectString(i),o||this.saveSetting("language",t),e&&e.call(this)},IDE_Morph.prototype.userSetBlocksScale=function(){var t,e,o,i,r=this,s=new CommandBlockMorph;s.color=SpriteMorph.prototype.blockColor.motion,s.setSpec(localize("build")),(t=new CommandBlockMorph).color=SpriteMorph.prototype.blockColor.sound,t.setSpec(localize("your own")),s.nextBlock(t),(t=new CommandBlockMorph).color=SpriteMorph.prototype.blockColor.operators,t.setSpec(localize("blocks")),s.bottomBlock().nextBlock(t),(o=new FrameMorph).acceptsDrops=!1,o.color=IDE_Morph.prototype.groupColor,o.cachedTexture=this.scriptsPaneTexture,o.setExtent(new Point(250,180)),s.setPosition(o.position().add(10)),o.add(s),(e=new Morph).alpha=0,e.setExtent(o.extent()),e.setPosition(o.position()),o.add(e),i=function(e){s.blockSequence().forEach(function(t){t.setScale(e),t.drawNew(),t.setSpec(t.blockSpec)}),s.changed()},new DialogBoxMorph(null,function(t){r.setBlocksScale(Math.min(t,12))}).withKey("zoomBlocks").prompt("Zoom blocks",SyntaxElementMorph.prototype.scale.toString(),this.world(),o,{"normal (1x)":1,"demo (1.2x)":1.2,"presentation (1.4x)":1.4,"big (2x)":2,"huge (4x)":4,"giant (8x)":8,"monstrous (10x)":10},!1,!0,1,5,i)},IDE_Morph.prototype.setBlocksScale=function(t){var e;if(Process.prototype.isCatchingErrors)try{e=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else e=this.serializer.serialize(this.stage);SyntaxElementMorph.prototype.setScale(t),CommentMorph.prototype.refreshScale(),SpriteMorph.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.fixLayout(),this.openProjectString(e),this.saveSetting("zoom",t)},IDE_Morph.prototype.userSetStageSize=function(){new DialogBoxMorph(this,this.setStageExtent,this).promptVector("Stage size",StageMorph.prototype.dimensions,new Point(480,360),"Stage width","Stage height",this.world(),null,null)},IDE_Morph.prototype.setStageExtent=function(t){var e=this,o=this.world(),i=t.max(new Point(240,180));this.stageRatio=1,this.isSmallStage=!1,this.controlBar.stageSizeButton.refresh(),this.stage.stopVideo(),this.setExtent(o.extent()),this.isAnimating?e.step=function(){var t=i.subtract(StageMorph.prototype.dimensions).divideBy(2);t.abs().lt(new Point(5,5))?(StageMorph.prototype.dimensions=i,delete e.step):StageMorph.prototype.dimensions=StageMorph.prototype.dimensions.add(t),e.stage.setExtent(StageMorph.prototype.dimensions),e.stage.clearPenTrails(),e.fixLayout(),this.setExtent(o.extent())}:(StageMorph.prototype.dimensions=i,this.stage.setExtent(StageMorph.prototype.dimensions),this.stage.clearPenTrails(),this.fixLayout(),this.setExtent(o.extent()))},IDE_Morph.prototype.userSetDragThreshold=function(){new DialogBoxMorph(this,function(t){MorphicPreferences.grabThreshold=Math.min(Math.max(+t,0),200)},this).prompt("Dragging threshold",MorphicPreferences.grabThreshold.toString(),this.world(),null,null,null,!0)},IDE_Morph.prototype.initializeCloud=function(){var i=this,r=this.world();new DialogBoxMorph(null,function(t){i.cloud.login(t.username.toLowerCase(),t.password,t.choice,function(t,e,o){sessionStorage.username=t,i.source="cloud",isNil(o.days_left)?i.showMessage(o.message,2):(new DialogBoxMorph).inform("Unverified account: "+o.days_left+" days left",'You are now logged in, and your account\nis enabled for three days.\nPlease use the verification link that\nwas sent to your email address when you\nsigned up.\n\nIf you cannot find that email, please\ncheck your spam folder. If you still\ncannot find it, please use the "Resend\nVerification Email..." option in the cloud\nmenu.\n\nYou have '+o.days_left+" days left.",r,i.cloudIcon(null,new Color(0,180,0)))},i.cloudError())}).withKey("cloudlogin").promptCredentials("Sign in","login",null,null,null,null,"stay signed in on this computer\nuntil logging out",r,i.cloudIcon(),i.cloudMsg)},IDE_Morph.prototype.createCloudAccount=function(){var o=this,i=this.world();new DialogBoxMorph(null,function(t){o.cloud.signup(t.username,t.password,t.passwordRepeat,t.email,function(t,e){(new DialogBoxMorph).inform(e,t+".\n\nYou can now log in.",i,o.cloudIcon(null,new Color(0,180,0)))},o.cloudError())}).withKey("cloudsignup").promptCredentials("Sign up","signup","http://snap.berkeley.edu/tos.html","Terms of Service...","http://snap.berkeley.edu/privacy.html","Privacy...","I have read and agree\nto the Terms of Service",i,o.cloudIcon(),o.cloudMsg)},IDE_Morph.prototype.resetCloudPassword=function(){var o=this,i=this.world();new DialogBoxMorph(null,function(t){o.cloud.resetPassword(t.username,function(t,e){(new DialogBoxMorph).inform(e,t+"\n\nAn e-mail with a link to\nreset your password\nhas been sent to the address provided",i,o.cloudIcon(null,new Color(0,180,0)))},o.cloudError())}).withKey("cloudresetpassword").promptCredentials("Reset password","resetPassword",null,null,null,null,null,i,o.cloudIcon(),o.cloudMsg)},IDE_Morph.prototype.resendVerification=function(){var o=this,i=this.world();new DialogBoxMorph(null,function(t){o.cloud.resendVerification(t.username,function(t,e){(new DialogBoxMorph).inform(e,t,i,o.cloudIcon(null,new Color(0,180,0)))},o.cloudError())}).withKey("cloudresendverification").promptCredentials("Resend verification email","resendVerification",null,null,null,null,null,i,o.cloudIcon(),o.cloudMsg)},IDE_Morph.prototype.changeCloudPassword=function(){var e=this,t=this.world();new DialogBoxMorph(null,function(t){e.cloud.changePassword(t.oldpassword,t.password,t.passwordRepeat,function(){e.showMessage("password has been changed.",2)},e.cloudError())}).withKey("cloudpassword").promptCredentials("Change Password","changePassword",null,null,null,null,null,t,e.cloudIcon(),e.cloudMsg)},IDE_Morph.prototype.logout=function(){var t=this;this.cloud.logout(function(){delete sessionStorage.username,t.showMessage("disconnected.",2)},function(){delete sessionStorage.username,t.showMessage("disconnected.",2)})},IDE_Morph.prototype.buildProjectRequest=function(){var t,e=this.serializer.serialize(this.stage),o=normalizeCanvas(this.stage.thumbnail(SnapSerializer.prototype.thumbnailSize)).toDataURL();return this.serializer.isCollectingMedia=!0,t={notes:this.projectNotes,xml:e,media:this.hasChangedMedia?this.serializer.mediaXML(this.projectName):null,thumbnail:o,remixID:this.stage.remixID},this.serializer.isCollectingMedia=!1,this.serializer.flushMedia(),t},IDE_Morph.prototype.verifyProject=function(t){var e=JSON.stringify(t);if(e.length>Cloud.MAX_FILE_SIZE)return(new DialogBoxMorph).inform("Snap!Cloud - Cannot Save Project","The media inside this project exceeds 10 MB.\nPlease reduce the size of costumes or sounds.\n",this.world(),this.cloudIcon(null,new Color(180,0,0))),!1;try{this.serializer.parse(t.xml)}catch(t){return this.showMessage("Serialization of program data failed:\n"+t),!1}if(null!==t.media)try{this.serializer.parse(t.media)}catch(t){return this.showMessage("Serialization of media failed:\n"+t),!1}return this.serializer.isCollectingMedia=!1,this.serializer.flushMedia(),e.length},IDE_Morph.prototype.saveProjectToCloud=function(t){var e,o,i=this;t&&this.setProjectName(t),this.showMessage("Saving project\nto the cloud..."),e=this.buildProjectRequest(),(o=this.verifyProject(e))&&(this.showMessage("Uploading "+Math.round(o/1024)+" KB..."),this.cloud.saveProject(this.projectName,e,function(){i.showMessage("saved.",2)},this.cloudError()))},IDE_Morph.prototype.exportProjectMedia=function(t){var e,o;if(this.serializer.isCollectingMedia=!0,t){this.setProjectName(t);try{e=this.showMessage("Exporting"),o=this.serializer.mediaXML(t),this.saveXMLAs(o,this.projectName+" media"),e.destroy(),this.showMessage("Exported!",1)}catch(t){if(!Process.prototype.isCatchingErrors)throw t;this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+t)}}this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.exportProjectNoMedia=function(t){var e,o;if(this.serializer.isCollectingMedia=!0,t)if(this.setProjectName(t),Process.prototype.isCatchingErrors)try{e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1)}catch(t){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+t)}else e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.exportProjectAsCloudData=function(t){var e,o;if(this.serializer.isCollectingMedia=!0,t)if(this.setProjectName(t),Process.prototype.isCatchingErrors)try{e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),this.serializer.mediaXML(t),this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1)}catch(t){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+t)}else e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),this.serializer.mediaXML(t),this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.cloudAcknowledge=function(){var o=this;return function(t,e){nop(t),(new DialogBoxMorph).inform("Cloud Connection","Successfully connected to:\nhttp://"+e,o.world(),o.cloudIcon(null,new Color(0,180,0)))}},IDE_Morph.prototype.cloudResponse=function(){var i=this;return function(t,e){var o=t;50<o.length&&(o=o.substring(0,50)+"..."),(new DialogBoxMorph).inform("Snap!Cloud","http://"+e+":\n\nresponds:\n"+o,i.world(),i.cloudIcon(null,new Color(0,180,0)))}},IDE_Morph.prototype.cloudError=function(){var i=this;return function(t,e){var o=t;i.shield&&(i.shield.destroy(),i.shield=null),(new DialogBoxMorph).inform("Snap!Cloud",(e?e+"\n":"")+o,i.world(),i.cloudIcon(null,new Color(180,0,0)))}},IDE_Morph.prototype.cloudIcon=function(t,e){var o=e||DialogBoxMorph.prototype.titleBarColor,i=MorphicPreferences.isFlat,r=new SymbolMorph(i?"cloud":"cloudGradient",t||50,o,i?null:new Point(-1,-1),o.darker(50));return i||r.addShadow(new Point(1,1),1,o.lighter(95)),r},IDE_Morph.prototype.setCloudURL=function(){var e=this;new DialogBoxMorph(null,function(t){e.cloud.url=t}).withKey("cloudURL").prompt("Cloud URL",this.cloud.url,this.world(),null,this.cloud.knownDomains)},IDE_Morph.prototype.getURL=function(t,e,o){var i,r=new XMLHttpRequest,s=e instanceof Function,n=this;s&&(r.responseType=o||"text"),i=s&&"text"!==r.responseType?"response":"responseText";try{if(r.open("GET",t,s),s&&(r.onreadystatechange=function(){if(4===r.readyState){if(!r[i])throw new Error("unable to retrieve "+t);e.call(n,r[i])}}),r.send(),!s){if(200===r.status)return r[i];throw new Error("unable to retrieve "+t)}}catch(t){if(n.showMessage(t.toString()),!s)return r[i];e.call(this)}},IDE_Morph.prototype.showMessage=function(t,e){var o,i=new MenuMorph(null,t);return i.popUpCenteredInWorld(this.world()),e&&(o=setInterval(function(){i.destroy(),clearInterval(o)},1e3*e)),i},IDE_Morph.prototype.inform=function(t,e){(new DialogBoxMorph).inform(t,localize(e),this.world())},IDE_Morph.prototype.confirm=function(t,e,o){new DialogBoxMorph(null,o).askYesNo(e,localize(t),this.world())},IDE_Morph.prototype.prompt=function(t,e,o,i){new DialogBoxMorph(null,e).withKey(i).prompt(t,"",this.world(),null,o)},ProjectDialogMorph.prototype=new DialogBoxMorph,(ProjectDialogMorph.prototype.constructor=ProjectDialogMorph).uber=DialogBoxMorph.prototype,ProjectDialogMorph.prototype.init=function(t,e){var o=this;this.ide=t,this.task=e||"open",this.source=t.source,this.projectList=[],this.handle=null,this.srcBar=null,this.nameField=null,this.filterField=null,this.magnifyingGlass=null,this.listField=null,this.preview=null,this.notesText=null,this.notesField=null,this.deleteButton=null,this.shareButton=null,this.unshareButton=null,this.publishButton=null,this.unpublishButton=null,this.recoverButton=null,ProjectDialogMorph.uber.init.call(this,this,null,null),this.labelString="save"===this.task?"Save Project":"Open Project",this.createLabel(),this.key="project"+e,"open"===e&&"disk"===this.source?(this.source=null,this.buildContents(),this.projectList=[],this.listField.hide(),this.source="disk"):(this.buildContents(),this.onNextStep=function(){o.setSource(o.source)})},ProjectDialogMorph.prototype.buildContents=function(){var t,e;this.addBody(new Morph),this.body.color=this.color,this.srcBar=new AlignmentMorph("column",this.padding/2),this.ide.cloudMsg&&((e=new TextMorph(this.ide.cloudMsg,10,null,!1,null,null,null,null,new Point(1,1),new Color(255,255,255))).refresh=nop,this.srcBar.add(e)),this.addSourceButton("cloud",localize("Cloud"),"cloud"),"open"===this.task&&(this.buildFilterField(),this.addSourceButton("examples",localize("Examples"),"poster"),!this.hasLocalProjects()&&16!==this.ide.world().currentKey||this.addSourceButton("local",localize("Browser"),"globe")),this.addSourceButton("disk",localize("Computer"),"storage"),this.srcBar.fixLayout(),this.body.add(this.srcBar),"save"===this.task&&(this.nameField=new InputFieldMorph(this.ide.projectName),this.body.add(this.nameField)),this.listField=new ListMorph([]),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.body.add(this.listField),this.preview=new Morph,this.preview.fixLayout=nop,this.preview.edge=InputFieldMorph.prototype.edge,this.preview.fontSize=InputFieldMorph.prototype.fontSize,this.preview.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.preview.contrast=InputFieldMorph.prototype.contrast,this.preview.drawNew=function(){InputFieldMorph.prototype.drawNew.call(this),this.texture&&this.drawTexture(this.texture)},this.preview.drawCachedTexture=function(){this.image.getContext("2d").drawImage(this.cachedTexture,this.edge,this.edge),this.changed()},this.preview.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.preview.setExtent(this.ide.serializer.thumbnailSize.add(2*this.preview.edge)),this.body.add(this.preview),this.preview.drawNew(),"save"===this.task&&(t=this.ide.stage.thumbnail(SnapSerializer.prototype.thumbnailSize),this.preview.texture=null,this.preview.cachedTexture=t,this.preview.drawCachedTexture()),this.notesField=new ScrollFrameMorph,this.notesField.fixLayout=nop,this.notesField.edge=InputFieldMorph.prototype.edge,this.notesField.fontSize=InputFieldMorph.prototype.fontSize,this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.notesField.contrast=InputFieldMorph.prototype.contrast,this.notesField.drawNew=InputFieldMorph.prototype.drawNew,this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.notesField.acceptsDrops=!1,this.notesField.contents.acceptsDrops=!1,"open"===this.task?this.notesText=new TextMorph(""):(this.notesText=new TextMorph(this.ide.projectNotes),this.notesText.isEditable=!0,this.notesText.enableSelecting()),this.notesField.isTextLineWrapping=!0,this.notesField.padding=3,this.notesField.setContents(this.notesText),this.notesField.setWidth(this.preview.width()),this.body.add(this.notesField),"open"===this.task?(this.addButton("openProject","Open"),this.action="openProject",this.recoverButton=this.addButton("recoveryDialog","Recover",!0),this.recoverButton.hide()):(this.addButton("saveProject","Save"),this.action="saveProject"),this.shareButton=this.addButton("shareProject","Share",!0),this.unshareButton=this.addButton("unshareProject","Unshare",!0),this.shareButton.hide(),this.unshareButton.hide(),this.publishButton=this.addButton("publishProject","Publish",!0),this.unpublishButton=this.addButton("unpublishProject","Unpublish",!0),this.publishButton.hide(),this.unpublishButton.hide(),this.deleteButton=this.addButton("deleteProject","Delete"),this.addButton("cancel","Cancel"),e?this.setExtent(new Point(500,360).add(e.extent())):this.setExtent(new Point(500,360)),this.fixLayout()},ProjectDialogMorph.prototype.popUp=function(t){var e=t||this.ide.world();e&&(ProjectDialogMorph.uber.popUp.call(this,e),this.handle=new HandleMorph(this,350,330,this.corner,this.corner))},ProjectDialogMorph.prototype.createButtons=function(){this.buttons&&this.buttons.destroy(),this.buttons=new AlignmentMorph("column",this.padding/3),this.buttons.bottomRow=new AlignmentMorph("row",this.padding),this.buttons.topRow=new AlignmentMorph("row",this.padding),this.buttons.add(this.buttons.topRow),this.buttons.add(this.buttons.bottomRow),this.add(this.buttons),this.buttons.topRow.hide=function(){this.isVisible=!1,this.changed()},this.buttons.topRow.show=function(){this.isVisible=!0,this.changed()},this.buttons.fixLayout=function(){this.topRow.children.some(function(t){return t.isVisible})?(this.topRow.show(),this.topRow.fixLayout()):this.topRow.hide(),this.bottomRow.fixLayout(),AlignmentMorph.prototype.fixLayout.call(this)}},ProjectDialogMorph.prototype.addButton=function(t,e,o){var i=new PushButtonMorph(this,t||"ok","  "+localize(e||"OK")+"  ");return i.fontSize=this.buttonFontSize,i.corner=this.buttonCorner,i.edge=this.buttonEdge,i.outline=this.buttonOutline,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.padding=this.buttonPadding,i.contrast=this.buttonContrast,i.drawNew(),i.fixLayout(),o?this.buttons.topRow.add(i):this.buttons.bottomRow.add(i),i},ProjectDialogMorph.prototype.addSourceButton=function(t,e,o){var i,r=this,s=new StringMorph(e,10,null,!0,null,null,new Point(1,1),new Color(255,255,255)),n=new StringMorph(e,10,null,!0,null,null,new Point(-1,-1),this.titleBarColor.darker(50),new Color(255,255,255)),a=new Morph,h=new Morph;s.add(new SymbolMorph(o,24,this.titleBarColor.darker(20),new Point(1,1),this.titleBarColor.darker(50))),s.children[0].setCenter(s.center()),s.children[0].setBottom(s.top()-this.padding/2),a.image=s.fullImage(),a.bounds=s.fullBounds(),n.add(new SymbolMorph(o,24,new Color(255,255,255),new Point(-1,-1),this.titleBarColor.darker(50))),n.children[0].setCenter(n.center()),n.children[0].setBottom(n.top()-this.padding/2),h.image=n.fullImage(),h.bounds=n.fullBounds(),(i=new ToggleButtonMorph(null,r,function(){r.setSource(t)},[a,h],function(){return r.source===t})).corner=this.buttonCorner,i.edge=this.buttonEdge,i.outline=this.buttonOutline,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.labelMinExtent=new Point(60,0),i.padding=this.buttonPadding,i.contrast=this.buttonContrast,i.pressColor=this.titleBarColor.darker(20),i.drawNew(),i.fixLayout(),i.refresh(),this.srcBar.add(i)},ProjectDialogMorph.prototype.fixListFieldItemColors=function(){var e=this;this.listField.contents.children[0].alpha=0,this.listField.contents.children[0].children.forEach(function(t){t.pressColor=e.titleBarColor.darker(20),t.color=new Color(0,0,0,0),t.noticesTransparentClick=!0})},ProjectDialogMorph.prototype.buildFilterField=function(){var e=this;this.filterField=new InputFieldMorph(""),this.magnifyingGlass=new SymbolMorph("magnifyingGlass",this.filterField.height(),this.titleBarColor.darker(50)),this.body.add(this.magnifyingGlass),this.body.add(this.filterField),this.filterField.reactToKeystroke=function(t){var i=this.getValue();e.listField.elements=e.projectList.filter(function(t){var e=t.projectname||t.name,o=t.notes||"";return-1<e.toLowerCase().indexOf(i.toLowerCase())||-1<o.toLowerCase().indexOf(i.toLowerCase())}),0===e.listField.elements.length&&e.listField.elements.push("(no matches)"),e.clearDetails(),e.listField.buildListContents(),e.fixListFieldItemColors(),e.listField.adjustScrollBars(),e.listField.scrollY(e.listField.top()),e.fixLayout()}},ProjectDialogMorph.prototype.setSource=function(t){var o,i=this;switch(this.source=t,this.srcBar.children.forEach(function(t){t.refresh()}),this.source){case"cloud":return o=i.ide.showMessage("Updating\nproject list..."),this.projectList=[],void i.ide.cloud.getProjectList(function(t){"cloud"===i.source&&i.installCloudProjectList(t.projects),o.destroy()},function(t,e){o.destroy(),i.ide.cloudError().call(null,t,e)});case"examples":this.projectList=this.getExamplesProjectList();break;case"local":this.projectList=this.getLocalProjectList();break;case"disk":if("save"!==this.task)return this.destroy(),void this.ide.importLocalFile();this.projectList=[]}this.listField.destroy(),this.listField=new ListMorph(this.projectList,0<this.projectList.length?function(t){return t.name||t}:null,null,function(){i.ok()}),"disk"===this.source&&this.listField.hide(),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,"local"===this.source?this.listField.action=function(t){var e,o;void 0!==t&&(i.nameField&&i.nameField.setContents(t.name||""),"open"===i.task&&(e=localStorage["-snap-project-"+t.name])&&(o=i.ide.serializer.parse(e),i.notesText.text=o.childNamed("notes").contents||"",i.notesText.drawNew(),i.notesField.contents.adjustBounds(),i.preview.texture=o.childNamed("thumbnail").contents||null,i.preview.cachedTexture=null,i.preview.drawNew()),i.edit())}:this.listField.action=function(t){var e,o;void 0!==t&&(i.nameField&&i.nameField.setContents(t.name||""),e=i.ide.getURL(i.ide.resourceURL("Examples",t.fileName)),o=i.ide.serializer.parse(e),i.notesText.text=o.childNamed("notes").contents||"",i.notesText.drawNew(),i.notesField.contents.adjustBounds(),i.preview.texture=o.childNamed("thumbnail").contents||null,i.preview.cachedTexture=null,i.preview.drawNew(),i.edit())},this.body.add(this.listField),this.shareButton.hide(),this.unshareButton.hide(),"open"===this.task&&this.recoverButton.hide(),this.publishButton.hide(),this.unpublishButton.hide(),"local"===this.source?this.deleteButton.show():this.deleteButton.hide(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails()},ProjectDialogMorph.prototype.hasLocalProjects=function(){return Object.keys(localStorage).some(function(t){return 0===t.indexOf("-snap-project-")})},ProjectDialogMorph.prototype.getLocalProjectList=function(){var t,e,o=[];for(t in localStorage)Object.prototype.hasOwnProperty.call(localStorage,t)&&"-snap-project-"===t.substr(0,14)&&(e={name:t.substr(14),thumb:null,notes:null},o.push(e));return o.sort(function(t,e){return t.name.toLowerCase()<e.name.toLowerCase()?-1:1}),o},ProjectDialogMorph.prototype.getExamplesProjectList=function(){return this.ide.getMediaList("Examples")},ProjectDialogMorph.prototype.installCloudProjectList=function(t){var e=this;this.projectList=t[0]?t:[],this.projectList.sort(function(t,e){return t.projectname.toLowerCase()<e.projectname.toLowerCase()?-1:1}),this.listField.destroy(),this.listField=new ListMorph(this.projectList,0<this.projectList.length?function(t){return t.projectname||t}:null,[["bold",function(t){return t.ispublic}],["italic",function(t){return t.ispublished}]],function(){e.ok()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.listField.action=function(t){void 0!==t&&(e.nameField&&e.nameField.setContents(t.projectname||""),"open"===e.task&&(e.notesText.text=t.notes||"",e.notesText.drawNew(),e.notesField.contents.adjustBounds(),e.preview.texture="",e.preview.drawNew(),e.ide.cloud.getThumbnail(null,t.projectname,function(t){e.preview.texture=t,e.preview.cachedTexture=null,e.preview.drawNew()}),new SpeechBubbleMorph(new TextMorph(localize("last changed")+"\n"+t.lastupdated,null,null,null,null,"center")).popUp(e.world(),e.preview.rightCenter().add(new Point(2,0)))),t.ispublic?(e.shareButton.hide(),e.unshareButton.show(),t.ispublished?(e.publishButton.hide(),e.unpublishButton.show()):(e.publishButton.show(),e.unpublishButton.hide())):(e.unshareButton.hide(),e.shareButton.show(),e.publishButton.hide(),e.unpublishButton.hide()),e.buttons.fixLayout(),e.fixLayout(),e.edit())},this.body.add(this.listField),"open"===this.task&&this.recoverButton.show(),this.shareButton.show(),this.unshareButton.hide(),this.deleteButton.show(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails()},ProjectDialogMorph.prototype.clearDetails=function(){this.notesText.text="",this.notesText.drawNew(),this.notesField.contents.adjustBounds(),this.preview.texture=null,this.preview.cachedTexture=null,this.preview.drawNew()},ProjectDialogMorph.prototype.recoveryDialog=function(){var t=this.listField.selected;t&&(new ProjectRecoveryDialogMorph(this.ide,t.projectname,this).popUp(),this.hide())},ProjectDialogMorph.prototype.openProject=function(){var t,e=this.listField.selected;e&&(this.ide.source=this.source,"cloud"===this.source?this.openCloudProject(e):("examples"===this.source?(t=this.ide.getURL(this.ide.resourceURL("Examples",e.fileName)),this.ide.openProjectString(t)):(this.ide.source=null,this.ide.openProject(e.name)),this.destroy()))},ProjectDialogMorph.prototype.openCloudProject=function(t,e){var o=this;o.ide.nextSteps([function(){o.ide.showMessage("Fetching project\nfrom the cloud...")},function(){o.rawOpenCloudProject(t,e)}])},ProjectDialogMorph.prototype.rawOpenCloudProject=function(e,t){var o=this;this.ide.cloud.getProject(e.projectname,t,function(t){o.ide.source="cloud",o.ide.nextSteps([function(){o.ide.openCloudDataString(t)}]),location.hash="",e.ispublic&&(location.hash="#present:Username="+encodeURIComponent(o.ide.cloud.username)+"&ProjectName="+encodeURIComponent(e.projectname))},o.ide.cloudError()),this.destroy()},ProjectDialogMorph.prototype.saveProject=function(){var e=this.nameField.contents().text.text,t=this.notesText.text,o=this;this.ide.projectNotes=t||this.ide.projectNotes,e&&("cloud"===this.source?detect(this.projectList,function(t){return t.projectname===e})?this.ide.confirm(localize("Are you sure you want to replace")+'\n"'+e+'"?',"Replace Project",function(){o.ide.setProjectName(e),o.saveCloudProject()}):(this.ide.setProjectName(e),o.saveCloudProject()):"disk"===this.source&&(this.ide.exportProject(e,!1),this.ide.source="disk",this.destroy()))},ProjectDialogMorph.prototype.saveCloudProject=function(){this.ide.source="cloud",this.ide.saveProjectToCloud(),this.destroy()},ProjectDialogMorph.prototype.deleteProject=function(){var t,e,o,i=this;"cloud"===this.source?(t=this.listField.selected)&&this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+t.projectname+'"?',"Delete Project",function(){i.ide.cloud.deleteProject(t.projectname,null,function(){i.ide.hasChangedMedia=!0,e=i.projectList.indexOf(t),i.projectList.splice(e,1),i.installCloudProjectList(i.projectList)},i.ide.cloudError())}):this.listField.selected&&(o=this.listField.selected.name,this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+o+'"?',"Delete Project",function(){delete localStorage["-snap-project-"+o],i.setSource(i.source)}))},ProjectDialogMorph.prototype.shareProject=function(){var o=this,i=this.ide,r=this.listField.selected,s=this.listField.active;r&&this.ide.confirm(localize("Are you sure you want to share")+'\n"'+r.projectname+'"?',"Share Project",function(){i.showMessage("sharing\nproject..."),i.cloud.shareProject(r.projectname,null,function(){var t,e;r.ispublic=!0,o.unshareButton.show(),o.shareButton.hide(),o.publishButton.show(),o.unpublishButton.hide(),s.label.isBold=!0,s.label.drawNew(),s.label.changed(),o.buttons.fixLayout(),o.drawNew(),o.ide.showMessage("shared.",2),r.projectname===i.projectName&&(t=i.cloud.username,e="Username="+encodeURIComponent(t.toLowerCase())+"&ProjectName="+encodeURIComponent(r.projectname),location.hash="present:"+e)},o.ide.cloudError())})},ProjectDialogMorph.prototype.unshareProject=function(){var t=this,e=this.ide,o=this.listField.selected,i=this.listField.active;o&&this.ide.confirm(localize("Are you sure you want to unshare")+'\n"'+o.projectname+'"?',"Unshare Project",function(){e.showMessage("unsharing\nproject..."),e.cloud.unshareProject(o.projectname,null,function(){o.ispublic=!1,t.shareButton.show(),t.unshareButton.hide(),t.publishButton.hide(),t.unpublishButton.hide(),i.label.isBold=!1,i.label.isItalic=!1,i.label.drawNew(),i.label.changed(),t.buttons.fixLayout(),t.drawNew(),t.ide.showMessage("unshared.",2),o.projectname===e.projectName&&(location.hash="")},t.ide.cloudError())})},ProjectDialogMorph.prototype.publishProject=function(){var o=this,i=this.ide,r=this.listField.selected,s=this.listField.active;r&&this.ide.confirm(localize("Are you sure you want to publish")+'\n"'+r.projectname+'"?',"Publish Project",function(){i.showMessage("publishing\nproject..."),i.cloud.publishProject(r.projectname,null,function(){var t,e;r.ispublished=!0,o.unshareButton.show(),o.shareButton.hide(),o.publishButton.hide(),o.unpublishButton.show(),s.label.isItalic=!0,s.label.drawNew(),s.label.changed(),o.buttons.fixLayout(),o.drawNew(),o.ide.showMessage("published.",2),r.projectname===i.projectName&&(t=i.cloud.username,e="Username="+encodeURIComponent(t.toLowerCase())+"&ProjectName="+encodeURIComponent(r.projectname),location.hash="present:"+e)},o.ide.cloudError())})},ProjectDialogMorph.prototype.unpublishProject=function(){var t=this,e=this.listField.selected,o=this.listField.active;e&&this.ide.confirm(localize("Are you sure you want to unpublish")+'\n"'+e.projectname+'"?',"Unpublish Project",function(){t.ide.showMessage("unpublishing\nproject..."),t.ide.cloud.unpublishProject(e.projectname,null,function(){e.ispublished=!1,t.unshareButton.show(),t.shareButton.hide(),t.publishButton.show(),t.unpublishButton.hide(),o.label.isItalic=!1,o.label.drawNew(),o.label.changed(),t.buttons.fixLayout(),t.drawNew(),t.ide.showMessage("unpublished.",2)},t.ide.cloudError())})},ProjectDialogMorph.prototype.edit=function(){this.nameField?this.nameField.edit():this.filterField&&this.filterField.edit()},ProjectDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding,e=this.padding/2,o=this.nameField||this.filterField,i=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.buttons&&0<this.buttons.children.length&&this.buttons.fixLayout(),this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height())),this.srcBar.setPosition(this.body.position()),o.setWidth(this.body.width()-this.srcBar.width()-6*this.padding),o.setLeft(this.srcBar.right()+3*this.padding),o.setTop(this.srcBar.top()),o.drawNew(),this.listField.setLeft(this.srcBar.right()+this.padding),this.listField.setWidth(this.body.width()-this.srcBar.width()-this.preview.width()-this.padding-e),this.listField.contents.children[0].adjustWidths(),this.listField.setTop(o.bottom()+this.padding),this.listField.setHeight(this.body.height()-o.height()-this.padding),this.magnifyingGlass&&(this.magnifyingGlass.setTop(o.top()),this.magnifyingGlass.setLeft(this.listField.left())),this.preview.setRight(this.body.right()),this.preview.setTop(o.bottom()+this.padding),this.notesField.setTop(this.preview.bottom()+e),this.notesField.setLeft(this.preview.left()),this.notesField.setHeight(this.body.bottom()-this.preview.bottom()-e)),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&0<this.buttons.children.length&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),Morph.prototype.trackChanges=i,this.changed()},ProjectRecoveryDialogMorph.prototype=new DialogBoxMorph,(ProjectRecoveryDialogMorph.prototype.constructor=ProjectRecoveryDialogMorph).uber=DialogBoxMorph.prototype,ProjectRecoveryDialogMorph.prototype.init=function(t,e,o){ProjectRecoveryDialogMorph.uber.init.call(this,this,null,null),this.ide=t,this.browser=o,this.key="recoverProject",this.projectName=e,this.versions=null,this.handle=null,this.listField=null,this.preview=null,this.notesText=null,this.notesField=null,this.labelString="Recover project",this.createLabel(),this.buildContents()},ProjectRecoveryDialogMorph.prototype.buildContents=function(){this.addBody(new Morph),this.body.color=this.color,this.buildListField(),this.preview=new Morph,this.preview.fixLayout=nop,this.preview.edge=InputFieldMorph.prototype.edge,this.preview.fontSize=InputFieldMorph.prototype.fontSize,this.preview.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.preview.contrast=InputFieldMorph.prototype.contrast,this.preview.drawNew=function(){InputFieldMorph.prototype.drawNew.call(this),this.texture&&this.drawTexture(this.texture)},this.preview.drawCachedTexture=function(){this.image.getContext("2d").drawImage(this.cachedTexture,this.edge,this.edge),this.changed()},this.preview.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.preview.setExtent(this.ide.serializer.thumbnailSize.add(2*this.preview.edge)),this.body.add(this.preview),this.preview.drawNew(),this.notesField=new ScrollFrameMorph,this.notesField.fixLayout=nop,this.notesField.edge=InputFieldMorph.prototype.edge,this.notesField.fontSize=InputFieldMorph.prototype.fontSize,this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.notesField.contrast=InputFieldMorph.prototype.contrast,this.notesField.drawNew=InputFieldMorph.prototype.drawNew,this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.notesField.acceptsDrops=!1,this.notesField.contents.acceptsDrops=!1,this.notesText=new TextMorph(""),this.notesField.isTextLineWrapping=!0,this.notesField.padding=3,this.notesField.setContents(this.notesText),this.notesField.setWidth(this.preview.width()),this.body.add(this.notesField),this.addButton("recoverProject","Recover",!0),this.addButton("cancel","Cancel"),this.setExtent(new Point(360,300)),this.fixLayout()},ProjectRecoveryDialogMorph.prototype.buildListField=function(){var r=this;this.listField=new ListMorph([]),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.listField.action=function(e){var t;void 0!==e&&(t=detect(r.versions,function(t){return t.lastupdated===e}),r.notesText.text=t.notes||"",r.notesText.drawNew(),r.notesField.contents.adjustBounds(),r.preview.texture=t.thumbnail,r.preview.cachedTexture=null,r.preview.drawNew())},this.ide.cloud.getProjectVersionMetadata(this.projectName,function(t){var o=new Date,i=new Date;i.setDate(o.getDate()-1),r.versions=t,r.versions.forEach(function(t){var e=new Date((new Date).getTime()-1e3*t.lastupdated);e.toDateString()===o.toDateString()?t.lastupdated=localize("Today, ")+e.toLocaleTimeString():e.toDateString()===i.toDateString()?t.lastupdated=localize("Yesterday, ")+e.toLocaleTimeString():t.lastupdated=e.toLocaleString()}),r.listField.elements=r.versions.map(function(t){return t.lastupdated}),r.clearDetails(),r.listField.buildListContents(),r.fixListFieldItemColors(),r.listField.adjustScrollBars(),r.listField.scrollY(r.listField.top()),r.fixLayout()},this.ide.cloudError()),this.body.add(this.listField)},ProjectRecoveryDialogMorph.prototype.cancel=function(){var e=this;this.browser.show(),this.browser.listField.select(detect(this.browser.projectList,function(t){return t.projectname===e.projectName})),ProjectRecoveryDialogMorph.uber.cancel.call(this)},ProjectRecoveryDialogMorph.prototype.recoverProject=function(){var e=this.listField.selected,t=detect(this.versions,function(t){return t.lastupdated===e});this.browser.openCloudProject({projectname:this.projectName},t.delta),this.destroy()},ProjectRecoveryDialogMorph.prototype.popUp=function(){var t=this.ide.world();t&&(ProjectRecoveryDialogMorph.uber.popUp.call(this,t),this.handle=new HandleMorph(this,300,300,this.corner,this.corner))},ProjectRecoveryDialogMorph.prototype.fixListFieldItemColors=ProjectDialogMorph.prototype.fixListFieldItemColors,ProjectRecoveryDialogMorph.prototype.clearDetails=ProjectDialogMorph.prototype.clearDetails,ProjectRecoveryDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding,e=this.padding/2,o=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height())),this.listField.setWidth(this.body.width()-this.preview.width()-this.padding),this.listField.contents.children[0].adjustWidths(),this.listField.setPosition(this.body.position()),this.listField.setHeight(this.body.height()),this.preview.setRight(this.body.right()),this.preview.setTop(this.listField.top()),this.notesField.setTop(this.preview.bottom()+e),this.notesField.setLeft(this.preview.left()),this.notesField.setHeight(this.body.bottom()-this.preview.bottom()-e)),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&(this.buttons.fixLayout(),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),Morph.prototype.trackChanges=o,this.changed()},LibraryImportDialogMorph.prototype=new DialogBoxMorph,(LibraryImportDialogMorph.prototype.constructor=LibraryImportDialogMorph).uber=DialogBoxMorph.prototype,LibraryImportDialogMorph.prototype.init=function(t,e){LibraryImportDialogMorph.uber.init.call(this,this,null,null),this.ide=t,this.key="importLibrary",this.librariesData=e,this.libraryCache={},this.handle=null,this.listField=null,this.palette=null,this.notesText=null,this.notesField=null,this.labelString="Import library",this.createLabel(),this.buildContents()},LibraryImportDialogMorph.prototype.buildContents=function(){this.addBody(new Morph),this.body.color=this.color,this.initializePalette(),this.initializeLibraryDescription(),this.installLibrariesList(),this.addButton("importLibrary","Import"),this.addButton("cancel","Cancel"),this.setExtent(new Point(460,455)),this.fixLayout()},LibraryImportDialogMorph.prototype.initializePalette=function(){this.palette&&this.palette.destroy(),this.palette=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor),this.palette.color=SpriteMorph.prototype.paletteColor,this.palette.padding=4,this.palette.isDraggable=!1,this.palette.acceptsDrops=!1,this.palette.contents.acceptsDrops=!1,this.body.add(this.palette)},LibraryImportDialogMorph.prototype.initializeLibraryDescription=function(){this.notesField&&this.notesField.destroy(),this.notesField=new ScrollFrameMorph,this.notesField.fixLayout=nop,this.notesField.edge=InputFieldMorph.prototype.edge,this.notesField.fontSize=InputFieldMorph.prototype.fontSize,this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.notesField.contrast=InputFieldMorph.prototype.contrast,this.notesField.drawNew=InputFieldMorph.prototype.drawNew,this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.notesField.acceptsDrops=!1,this.notesField.contents.acceptsDrops=!1,this.notesText=new TextMorph(""),this.notesField.isTextLineWrapping=!0,this.notesField.padding=3,this.notesField.setContents(this.notesText),this.notesField.setHeight(100),this.body.add(this.notesField)},LibraryImportDialogMorph.prototype.installLibrariesList=function(){var o=this;this.listField&&this.listField.destroy(),this.listField=new ListMorph(this.librariesData,function(t){return t.name},null,function(){o.importLibrary()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.listField.action=function(e){isNil(e)||(o.notesText.text=localize(e.description||""),o.notesText.drawNew(),o.notesField.contents.adjustBounds(),o.hasCached(e.fileName)?o.displayBlocks(e.fileName):(o.showMessage(localize("Loading")+"\n"+localize(e.name)),o.ide.getURL(o.ide.resourceURL("libraries",e.fileName),function(t){o.cacheLibrary(e.fileName,o.ide.serializer.loadBlocks(t)),o.displayBlocks(e.fileName)})))},this.listField.setWidth(200),this.body.add(this.listField),this.fixLayout()},LibraryImportDialogMorph.prototype.popUp=function(){var t=this.ide.world();t&&(LibraryImportDialogMorph.uber.popUp.call(this,t),this.handle=new HandleMorph(this,300,300,this.corner,this.corner))},LibraryImportDialogMorph.prototype.fixListFieldItemColors=ProjectDialogMorph.prototype.fixListFieldItemColors,LibraryImportDialogMorph.prototype.clearDetails=ProjectDialogMorph.prototype.clearDetails,LibraryImportDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding,e=this.padding/2,o=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height())),this.listField.setExtent(new Point(200,this.body.height())),this.notesField.setExtent(new Point(this.body.width()-this.listField.width()-e,100)),this.palette.setExtent(new Point(this.notesField.width(),this.body.height()-this.notesField.height()-e)),this.listField.contents.children[0].adjustWidths(),this.listField.setPosition(this.body.position()),this.palette.setPosition(this.listField.topRight().add(new Point(e,0))),this.notesField.setPosition(this.palette.bottomLeft().add(new Point(0,e)))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&(this.buttons.fixLayout(),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),Morph.prototype.trackChanges=o,this.changed()},LibraryImportDialogMorph.prototype.hasCached=function(t){return this.libraryCache.hasOwnProperty(t)},LibraryImportDialogMorph.prototype.cacheLibrary=function(t,e){this.libraryCache[t]=e},LibraryImportDialogMorph.prototype.cachedLibrary=function(t){return this.libraryCache[t]},LibraryImportDialogMorph.prototype.importLibrary=function(){var e=this.ide,t=this.listField.selected.fileName,o=this.listField.selected.name;this.hasCached(t)?(this.cachedLibrary(t).forEach(function(t){t.receiver=e.stage,e.stage.globalBlocks.push(t),e.stage.replaceDoubleDefinitionsFor(t)}),e.showMessage(localize("Imported")+" "+localize(o),2)):(e.showMessage(localize("Loading")+" "+localize(o)),e.getURL(e.resourceURL("libraries",t),function(t){e.droppedText(t,o)})),this.destroy()},LibraryImportDialogMorph.prototype.displayBlocks=function(t){var o,i,r,s,n,a=this,h=this.cachedLibrary(t);h.length&&(this.initializePalette(),o=this.palette.left()+4,i=this.palette.top(),SpriteMorph.prototype.categories.forEach(function(e){h.forEach(function(t){t.category===e&&(e!==s&&(i+=4),s=e,r=t.templateInstance().fullImage(),(n=new Morph).setExtent(new Point(r.width,r.height)),n.image=r,n.setPosition(new Point(o,i)),a.palette.addContents(n),i+=n.fullBounds().height()+4)})}),this.palette.scrollX(4),this.palette.scrollY(4),this.fixLayout())},LibraryImportDialogMorph.prototype.showMessage=function(t){var e=new MenuMorph(null,t);this.initializePalette(),this.fixLayout(),e.popUpCenteredInWorld(this.palette.contents)},SpriteIconMorph.prototype=new ToggleButtonMorph,(SpriteIconMorph.prototype.constructor=SpriteIconMorph).uber=ToggleButtonMorph.prototype,SpriteIconMorph.prototype.thumbSize=new Point(40,40),SpriteIconMorph.prototype.labelShadowOffset=null,SpriteIconMorph.prototype.labelShadowColor=null,SpriteIconMorph.prototype.labelColor=new Color(255,255,255),SpriteIconMorph.prototype.fontSize=9,SpriteIconMorph.prototype.init=function(t,e){var o,i,r,s,n=this;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),i=function(){var t=n.parentThatIsA(IDE_Morph);t&&t.selectSprite(n.object)},r=function(){var t=n.parentThatIsA(IDE_Morph);return!!t&&t.currentSprite===n.object},s=function(){return t.exemplar?localize("parent")+":\n"+t.exemplar.name:null},this.object=t||new SpriteMorph,this.version=this.object.version,this.thumbnail=null,this.rotationButton=null,SpriteIconMorph.uber.init.call(this,o,null,i,this.object.name,r,null,s,e),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},SpriteIconMorph.prototype.createThumbnail=function(){this.thumbnail&&this.thumbnail.destroy(),this.thumbnail=new Morph,this.thumbnail.setExtent(this.thumbSize),this.object instanceof SpriteMorph?(this.thumbnail.image=this.object.fullThumbnail(this.thumbSize),this.createRotationButton()):this.thumbnail.image=this.object.thumbnail(this.thumbSize),this.add(this.thumbnail)},SpriteIconMorph.prototype.createLabel=function(){var t;this.label&&this.label.destroy(),t=new StringMorph(this.object.name,this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor),this.label=new FrameMorph,this.label.acceptsDrops=!1,this.label.alpha=0,this.label.setExtent(t.extent()),t.setPosition(this.label.position()),this.label.add(t),this.add(this.label)},SpriteIconMorph.prototype.createRotationButton=function(){var t,e=this;this.rotationButton&&(this.rotationButton.destroy(),this.roationButton=null),this.object.anchor&&((t=new ToggleButtonMorph(null,null,function(){e.object.rotatesWithAnchor=!e.object.rotatesWithAnchor},["","»"],function(){return e.object.rotatesWithAnchor})).corner=8,t.labelMinExtent=new Point(11,11),t.padding=0,t.pressColor=t.color,t.drawNew(),t.fixLayout(),t.refresh(),t.changed(),this.rotationButton=t,this.add(this.rotationButton))},SpriteIconMorph.prototype.step=function(){this.version!==this.object.version&&(this.createThumbnail(),this.createLabel(),this.fixLayout(),this.version=this.object.version,this.refresh())},SpriteIconMorph.prototype.fixLayout=function(){if(!this.thumbnail||!this.label)return null;this.setWidth(this.thumbnail.width()+2*this.outline+2*this.edge+2*this.padding),this.setHeight(this.thumbnail.height()+2*this.outline+2*this.edge+3*this.padding+this.label.height()),this.thumbnail.setCenter(this.center()),this.thumbnail.setTop(this.top()+this.outline+this.edge+this.padding),this.rotationButton&&(this.rotationButton.setTop(this.top()),this.rotationButton.setRight(this.right())),this.label.setWidth(Math.min(this.label.children[0].width(),this.thumbnail.width())),this.label.setCenter(this.center()),this.label.setTop(this.thumbnail.bottom()+this.padding)},SpriteIconMorph.prototype.userMenu=function(){var t=new MenuMorph(this),e=this;return this.object instanceof StageMorph?(t.addItem("pic...",function(){e.parentThatIsA(IDE_Morph).saveCanvasAs(e.object.fullImageClassic(),this.object.name)},"open a new window\nwith a picture of the stage"),t):this.object instanceof SpriteMorph?(t.addItem("show","showSpriteOnStage"),t.addLine(),t.addItem("duplicate","duplicateSprite"),StageMorph.prototype.enableInheritance&&t.addItem("clone","instantiateSprite"),t.addItem("delete","removeSprite"),t.addLine(),StageMorph.prototype.enableInheritance&&(t.addItem("parent...","chooseExemplar"),this.object.exemplar&&t.addItem("release","releaseSprite","make temporary and\nhide in the sprite corral")),this.object.anchor&&t.addItem(localize("detach from")+" "+this.object.anchor.name,function(){e.object.detachFromAnchor()}),this.object.parts.length&&t.addItem("detach all parts",function(){e.object.detachAllParts()}),t.addItem("export...","exportSprite"),t):null},SpriteIconMorph.prototype.duplicateSprite=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.duplicateSprite(this.object)},SpriteIconMorph.prototype.instantiateSprite=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.instantiateSprite(this.object)},SpriteIconMorph.prototype.removeSprite=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.removeSprite(this.object)},SpriteIconMorph.prototype.exportSprite=function(){this.object.exportSprite()},SpriteIconMorph.prototype.chooseExemplar=function(){this.object.chooseExemplar()},SpriteIconMorph.prototype.releaseSprite=function(){this.object.release()},SpriteIconMorph.prototype.showSpriteOnStage=function(){this.object.showOnStage()},SpriteIconMorph.prototype.mouseDoubleClick=function(){this.object instanceof SpriteMorph&&this.object.flash()},SpriteIconMorph.prototype.createBackgrounds=function(){var t,e=this.extent();if(this.template)return this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null;this.normalImage=newCanvas(e),t=this.normalImage.getContext("2d"),this.drawBackground(t,this.color),this.highlightImage=newCanvas(e),t=this.highlightImage.getContext("2d"),this.drawBackground(t,this.highlightColor),this.pressImage=newCanvas(e),t=this.pressImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.pressColor),this.drawEdges(t,this.pressColor,this.pressColor.lighter(this.contrast),this.pressColor.darker(this.contrast)),this.image=this.normalImage},SpriteIconMorph.prototype.prepareToBeGrabbed=function(){var t,e=this.parentThatIsA(IDE_Morph);this.mouseClickLeft(),this.alpha=.85,e&&(t=e.sprites.asArray().indexOf(this.object),e.sprites.remove(t+1),e.createCorral(),e.fixLayout())},SpriteIconMorph.prototype.justDropped=function(){this.alpha=1},SpriteIconMorph.prototype.wantsDropOf=function(t){return t instanceof BlockMorph||t instanceof CostumeIconMorph||t instanceof SoundIconMorph},SpriteIconMorph.prototype.reactToDropOf=function(t,e){t instanceof BlockMorph?this.copyStack(t):t instanceof CostumeIconMorph?this.copyCostume(t.object):t instanceof SoundIconMorph&&this.copySound(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin)},SpriteIconMorph.prototype.copyStack=function(t){var e=this.object,o=t.fullCopy(),i=Math.max(e.scripts.children.map(function(t){return t.fullBounds().bottom()}).concat([e.scripts.top()]));o.setPosition(new Point(e.scripts.left()+20,i+20)),e.scripts.add(o),o.allComments().forEach(function(t){t.align(o)}),e.scripts.adjustBounds(),o.allChildren().forEach(function(t){!t.isCustomBlock||t.isGlobal||e.getMethod(t.blockSpec)||t.deleteBlock()})},SpriteIconMorph.prototype.copyCostume=function(t){var e=t.copy();e.name=this.object.newCostumeName(e.name),this.object.addCostume(e),this.object.wearCostume(e)},SpriteIconMorph.prototype.copySound=function(t){var e=t.copy();this.object.addSound(e.audio,e.name)},CostumeIconMorph.prototype=new ToggleButtonMorph,(CostumeIconMorph.prototype.constructor=CostumeIconMorph).uber=ToggleButtonMorph.prototype,CostumeIconMorph.prototype.thumbSize=new Point(80,60),CostumeIconMorph.prototype.labelShadowOffset=null,CostumeIconMorph.prototype.labelShadowColor=null,CostumeIconMorph.prototype.labelColor=new Color(255,255,255),CostumeIconMorph.prototype.fontSize=9,CostumeIconMorph.prototype.init=function(t,e){var o,i,r,s=this;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),i=function(){var t=s.parentThatIsA(IDE_Morph),e=s.parentThatIsA(WardrobeMorph);t&&t.currentSprite.wearCostume(s.object),e&&e.updateSelection()},r=function(){var t=s.parentThatIsA(IDE_Morph);return!!t&&t.currentSprite.costume===s.object},this.object=t||new Costume,this.version=this.object.version,this.thumbnail=null,CostumeIconMorph.uber.init.call(this,o,null,i,this.object.name,r,null,null,e),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},CostumeIconMorph.prototype.createThumbnail=function(){var t;SpriteIconMorph.prototype.createThumbnail.call(this),this.object instanceof SVG_Costume&&((t=new StringMorph("svg",.8*this.fontSize,this.fontStyle,!1,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor)).setBottom(this.thumbnail.bottom()),this.thumbnail.add(t))},CostumeIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,CostumeIconMorph.prototype.step=SpriteIconMorph.prototype.step,CostumeIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,CostumeIconMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return this.object instanceof Costume?(t.addItem("edit","editCostume"),16===this.world().currentKey&&t.addItem("edit rotation point only...","editRotationPointOnly",null,new Color(100,0,0)),t.addItem("rename","renameCostume"),t.addLine(),t.addItem("duplicate","duplicateCostume"),t.addItem("delete","removeCostume"),t.addLine(),t.addItem("export","exportCostume"),t):null},CostumeIconMorph.prototype.editCostume=function(){if(this.disinherit(),this.object instanceof SVG_Costume&&0===this.object.shapes.length)try{this.object.parseShapes()}catch(t){return void this.editRotationPointOnly()}this.object.edit(this.world(),this.parentThatIsA(IDE_Morph),!1)},CostumeIconMorph.prototype.editRotationPointOnly=function(){var t=this.parentThatIsA(IDE_Morph);this.object.editRotationPointOnly(this.world()),t.hasChangedMedia=!0},CostumeIconMorph.prototype.renameCostume=function(){this.disinherit();var e=this.object,o=this.parentThatIsA(WardrobeMorph),i=this.parentThatIsA(IDE_Morph);new DialogBoxMorph(null,function(t){t&&t!==e.name&&(e.name=o.sprite.newCostumeName(t,e),e.version=Date.now(),i.hasChangedMedia=!0)}).prompt(this.currentSprite instanceof SpriteMorph?"rename costume":"rename background",e.name,this.world())},CostumeIconMorph.prototype.duplicateCostume=function(){var t=this.parentThatIsA(WardrobeMorph),e=this.parentThatIsA(IDE_Morph),o=this.object.copy();o.name=t.sprite.newCostumeName(o.name),t.sprite.addCostume(o),t.updateList(),e&&e.currentSprite.wearCostume(o)},CostumeIconMorph.prototype.removeCostume=function(){var t=this.parentThatIsA(WardrobeMorph),e=this.parent.children.indexOf(this),o=CamSnapshotDialogMorph.prototype.enableCamera?3:2,i=this.parentThatIsA(IDE_Morph);t.removeCostumeAt(e-o),i.currentSprite.costume===this.object&&i.currentSprite.wearCostume(null)},CostumeIconMorph.prototype.exportCostume=function(){var t=this.parentThatIsA(IDE_Morph);this.object instanceof SVG_Costume?t.saveFileAs(this.object.contents.src,"text/svg",this.object.name):t.saveCanvasAs(this.object.contents,this.object.name)},CostumeIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,CostumeIconMorph.prototype.disinherit=function(){var t=this.parentThatIsA(WardrobeMorph),e=this.parent.children.indexOf(this);t.sprite.inheritsAttribute("costumes")&&(t.sprite.shadowAttribute("costumes"),this.object=t.sprite.costumes.at(e-3))},CostumeIconMorph.prototype.prepareToBeGrabbed=function(){this.disinherit(),this.mouseClickLeft(),this.removeCostume()},TurtleIconMorph.prototype=new ToggleButtonMorph,(TurtleIconMorph.prototype.constructor=TurtleIconMorph).uber=ToggleButtonMorph.prototype,TurtleIconMorph.prototype.thumbSize=new Point(80,60),TurtleIconMorph.prototype.labelShadowOffset=null,TurtleIconMorph.prototype.labelShadowColor=null,TurtleIconMorph.prototype.labelColor=new Color(255,255,255),TurtleIconMorph.prototype.fontSize=9,TurtleIconMorph.prototype.init=function(t,e){var o,i,r,s=this;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),i=function(){var t=s.parentThatIsA(IDE_Morph),e=s.parentThatIsA(WardrobeMorph);t&&t.currentSprite.wearCostume(null),e&&e.updateSelection()},r=function(){var t=s.parentThatIsA(IDE_Morph);return!!t&&null===t.currentSprite.costume},this.object=t,this.version=this.object.version,this.thumbnail=null,TurtleIconMorph.uber.init.call(this,o,null,i,"default",r,null,null,e),this.isDraggable=!1,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout()},TurtleIconMorph.prototype.createThumbnail=function(){var t=MorphicPreferences.isFlat;this.thumbnail&&this.thumbnail.destroy(),this.object instanceof SpriteMorph?this.thumbnail=new SymbolMorph("turtle",this.thumbSize.y,this.labelColor,t?null:new Point(-1,-1),new Color(0,0,0)):this.thumbnail=new SymbolMorph("stage",this.thumbSize.y,this.labelColor,t?null:new Point(-1,-1),new Color(0,0,0)),this.add(this.thumbnail)},TurtleIconMorph.prototype.createLabel=function(){var t;this.label&&this.label.destroy(),t=new StringMorph(localize(this.object instanceof SpriteMorph?"Turtle":"Empty"),this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor),this.label=new FrameMorph,this.label.acceptsDrops=!1,this.label.alpha=0,this.label.setExtent(t.extent()),t.setPosition(this.label.position()),this.label.add(t),this.add(this.label)},TurtleIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,TurtleIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,TurtleIconMorph.prototype.userMenu=function(){var t=this,e=new MenuMorph(this,"pen");return this.object instanceof StageMorph?null:(e.addItem(("tip"===this.object.penPoint?"Ï":"Ë")+" "+localize("tip"),function(){t.object.penPoint="tip",t.object.changed(),t.object.drawNew(),t.object.changed()}),e.addItem(("middle"===this.object.penPoint?"Ï":"Ë")+" "+localize("middle"),function(){t.object.penPoint="middle",t.object.changed(),t.object.drawNew(),t.object.changed()}),e)},WardrobeMorph.prototype=new ScrollFrameMorph,(WardrobeMorph.prototype.constructor=WardrobeMorph).uber=ScrollFrameMorph.prototype,WardrobeMorph.prototype.init=function(t,e){this.sprite=t||new SpriteMorph,this.costumesVersion=null,this.spriteVersion=null,WardrobeMorph.uber.init.call(this,null,null,e),this.fps=2,this.updateList()},WardrobeMorph.prototype.updateList=function(){var e,o,t,i,r,s=this,n=this.left()+5,a=this.top()+5,h=Morph.prototype.trackChanges,p=this.contents.position();this.changed(),h=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.contents.destroy(),this.contents=new FrameMorph(this),this.contents.acceptsDrops=!1,this.contents.reactToDropOf=function(t){s.reactToDropOf(t)},this.addBack(this.contents),(e=new TurtleIconMorph(this.sprite)).setPosition(new Point(n,a)),s.addContents(e),a=e.bottom()+4,(i=new PushButtonMorph(this,"paintNew",new SymbolMorph("brush",15))).padding=0,i.corner=12,i.color=IDE_Morph.prototype.groupColor,i.highlightColor=IDE_Morph.prototype.frameColor.darker(50),i.pressColor=i.highlightColor,i.labelMinExtent=new Point(36,18),i.labelShadowOffset=new Point(-1,-1),i.labelShadowColor=i.highlightColor,i.labelColor=TurtleIconMorph.prototype.labelColor,i.contrast=this.buttonContrast,i.drawNew(),i.hint="Paint a new costume",i.setPosition(new Point(n,a)),i.fixLayout(),i.setCenter(e.center()),i.setLeft(e.right()+16),this.addContents(i),CamSnapshotDialogMorph.prototype.enableCamera&&((r=new PushButtonMorph(this,"newFromCam",new SymbolMorph("camera",15))).padding=0,r.corner=12,r.color=IDE_Morph.prototype.groupColor,r.highlightColor=IDE_Morph.prototype.frameColor.darker(50),r.pressColor=i.highlightColor,r.labelMinExtent=new Point(36,18),r.labelShadowOffset=new Point(-1,-1),r.labelShadowColor=i.highlightColor,r.labelColor=TurtleIconMorph.prototype.labelColor,r.contrast=this.buttonContrast,r.drawNew(),r.hint="Import a new costume from your webcam",r.setPosition(new Point(n,a)),r.fixLayout(),r.setCenter(i.center()),r.setLeft(i.right()+5),this.addContents(r),CamSnapshotDialogMorph.prototype.enabled||(r.disable(),r.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage),document.addEventListener("cameraDisabled",function(){r.disable(),r.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage})),(t=new TextMorph(localize("costumes tab help"))).fontSize=9,t.setColor(SpriteMorph.prototype.paletteTextColor),t.setPosition(new Point(n,a)),this.addContents(t),a=t.bottom()+4,this.sprite.costumes.asArray().forEach(function(t){o=e=new CostumeIconMorph(t,o),e.setPosition(new Point(n,a)),s.addContents(e),a=e.bottom()+4}),this.costumesVersion=this.sprite.costumes.lastChanged,this.contents.setPosition(p),this.adjustScrollBars(),Morph.prototype.trackChanges=h,this.changed(),this.updateSelection()},WardrobeMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(t){t.refresh&&t.refresh()}),this.spriteVersion=this.sprite.version},WardrobeMorph.prototype.step=function(){this.costumesVersion!==this.sprite.costumes.lastChanged&&this.updateList(),this.spriteVersion!==this.sprite.version&&this.updateSelection()},WardrobeMorph.prototype.removeCostumeAt=function(t){this.sprite.shadowAttribute("costumes"),this.sprite.costumes.remove(t),this.updateList()},WardrobeMorph.prototype.paintNew=function(){var t=new Costume(newCanvas(null,!0),this.sprite.newCostumeName(localize("Untitled"))),e=this.parentThatIsA(IDE_Morph),o=this;t.edit(this.world(),e,!0,null,function(){o.sprite.shadowAttribute("costumes"),o.sprite.addCostume(t),o.updateList(),e&&e.currentSprite.wearCostume(t)})},WardrobeMorph.prototype.newFromCam=function(){var t=this.parentThatIsA(IDE_Morph),e=this,o=this.sprite,i=new CamSnapshotDialogMorph(t,o,nop,function(t){o.addCostume(t),o.wearCostume(t),e.updateList()});i.key="camera",i.popUp(this.world())},WardrobeMorph.prototype.wantsDropOf=function(t){return t instanceof CostumeIconMorph},WardrobeMorph.prototype.reactToDropOf=function(t){var e=0,o=t.object,i=t.top();t.destroy(),this.contents.children.forEach(function(t){t instanceof CostumeIconMorph&&t.top()<i-4&&(e+=1)}),this.sprite.shadowAttribute("costumes"),this.sprite.costumes.add(o,e+1),this.updateList(),t.mouseClickLeft()},SoundIconMorph.prototype=new ToggleButtonMorph,(SoundIconMorph.prototype.constructor=SoundIconMorph).uber=ToggleButtonMorph.prototype,SoundIconMorph.prototype.thumbSize=new Point(80,60),SoundIconMorph.prototype.labelShadowOffset=null,SoundIconMorph.prototype.labelShadowColor=null,SoundIconMorph.prototype.labelColor=new Color(255,255,255),SoundIconMorph.prototype.fontSize=9,SoundIconMorph.prototype.init=function(t,e){var o,i,r;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),i=function(){nop()},r=function(){return!1},this.object=t,this.version=this.object.version,this.thumbnail=null,SoundIconMorph.uber.init.call(this,o,null,i,this.object.name,r,null,null,e),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},SoundIconMorph.prototype.createThumbnail=function(){var t;this.thumbnail&&this.thumbnail.destroy(),this.thumbnail=new Morph,this.thumbnail.setExtent(this.thumbSize),this.add(this.thumbnail),t=new StringMorph(this.createInfo(),"16","",!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,new Color(200,200,200)),this.thumbnail.add(t),t.setCenter(new Point(40,15)),this.button=new PushButtonMorph(this,"toggleAudioPlaying",this.object.previewAudio?"Stop":"Play"),this.button.drawNew(),this.button.hint="Play sound",this.button.fixLayout(),this.thumbnail.add(this.button),this.button.setCenter(new Point(40,40))},SoundIconMorph.prototype.createInfo=function(){var t=Math.round(this.object.audio.duration||0),e=t%60;return Math.floor(t/60).toString()+":"+(e<10?"0":"")+e.toString()},SoundIconMorph.prototype.toggleAudioPlaying=function(){var t=this;this.object.previewAudio?(this.button.labelString="Play",this.button.hint="Play sound",this.object.previewAudio.pause(),this.object.previewAudio.terminated=!0,this.object.previewAudio=null):(this.button.labelString="Stop",this.button.hint="Stop sound",this.object.previewAudio=this.object.play(),this.object.previewAudio.addEventListener("ended",function(){t.audioHasEnded()},!1)),this.button.createLabel()},SoundIconMorph.prototype.audioHasEnded=function(){this.button.trigger(),this.button.mouseLeave()},SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,SoundIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,SoundIconMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return this.object instanceof Sound?(t.addItem("rename","renameSound"),t.addItem("delete","removeSound"),t.addLine(),t.addItem("export","exportSound"),t):null},SoundIconMorph.prototype.renameSound=function(){var e=this.object,o=this.parentThatIsA(IDE_Morph),i=this;this.disinherit(),new DialogBoxMorph(null,function(t){t&&t!==e.name&&(e.name=t,e.version=Date.now(),i.createLabel(),i.fixLayout(),o.hasChangedMedia=!0)}).prompt("rename sound",e.name,this.world())},SoundIconMorph.prototype.removeSound=function(){var t=this.parentThatIsA(JukeboxMorph),e=this.parent.children.indexOf(this)-1;t.removeSound(e)},SoundIconMorph.prototype.exportSound=function(){this.parentThatIsA(IDE_Morph).saveAudioAs(this.object.audio,this.object.name)},SoundIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,SoundIconMorph.prototype.disinherit=function(){var t=this.parentThatIsA(JukeboxMorph),e=this.parent.children.indexOf(this);t.sprite.inheritsAttribute("sounds")&&(t.sprite.shadowAttribute("sounds"),this.object=t.sprite.sounds.at(e-1))},SoundIconMorph.prototype.prepareToBeGrabbed=function(){this.disinherit(),this.removeSound()},JukeboxMorph.prototype=new ScrollFrameMorph,(JukeboxMorph.prototype.constructor=JukeboxMorph).uber=ScrollFrameMorph.prototype,JukeboxMorph.prototype.init=function(t,e){this.sprite=t||new SpriteMorph,this.soundsVersion=null,this.spriteVersion=null,JukeboxMorph.uber.init.call(this,null,null,e),this.acceptsDrops=!1,this.fps=2,this.updateList()},JukeboxMorph.prototype.updateList=function(){var e,o,t,i,r=this,s=this.left()+5,n=this.top()+5,a=Morph.prototype.trackChanges,h=this.sprite.parentThatIsA(IDE_Morph);this.changed(),a=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.contents.destroy(),this.contents=new FrameMorph(this),this.contents.acceptsDrops=!1,this.contents.reactToDropOf=function(t){r.reactToDropOf(t)},this.addBack(this.contents),(t=new TextMorph(localize("import a sound from your computer\nby dragging it into here"))).fontSize=9,t.setColor(SpriteMorph.prototype.paletteTextColor),t.setPosition(new Point(s,n)),this.addContents(t),(i=new PushButtonMorph(h,"recordNewSound",new SymbolMorph("circleSolid",15))).padding=0,i.corner=12,i.color=IDE_Morph.prototype.groupColor,i.highlightColor=IDE_Morph.prototype.frameColor.darker(50),i.pressColor=i.highlightColor,i.labelMinExtent=new Point(36,18),i.labelShadowOffset=new Point(-1,-1),i.labelShadowColor=i.highlightColor,i.labelColor=TurtleIconMorph.prototype.labelColor,i.contrast=this.buttonContrast,i.drawNew(),i.hint="Record a new sound",i.fixLayout(),i.label.setColor(new Color(255,20,20)),i.setPosition(t.bottomLeft().add(new Point(0,8))),this.addContents(i),n=i.bottom()+4,this.sprite.sounds.asArray().forEach(function(t){o=e=new SoundIconMorph(t,o),e.setPosition(new Point(s,n)),r.addContents(e),n=e.bottom()+4}),this.soundsVersion=this.sprite.sounds.lastChanged,Morph.prototype.trackChanges=a,this.changed(),this.updateSelection()},JukeboxMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(t){t.refresh&&t.refresh()}),this.spriteVersion=this.sprite.version},JukeboxMorph.prototype.step=function(){this.soundsVersion!==this.sprite.sounds.lastChanged&&this.updateList(),this.spriteVersion!==this.sprite.version&&this.updateSelection()},JukeboxMorph.prototype.removeSound=function(t){this.sprite.sounds.remove(t),this.updateList()},JukeboxMorph.prototype.wantsDropOf=function(t){return t instanceof SoundIconMorph},JukeboxMorph.prototype.reactToDropOf=function(t){var e=0,o=t.object,i=t.top();t.destroy(),this.contents.children.forEach(function(t){t instanceof SoundIconMorph&&t.top()<i-4&&(e+=1)}),this.sprite.shadowAttribute("sounds"),this.sprite.sounds.add(o,e+1),this.updateList()},StageHandleMorph.prototype=new Morph,(StageHandleMorph.prototype.constructor=StageHandleMorph).uber=Morph.prototype,StageHandleMorph.prototype.init=function(t){this.target=t||null,HandleMorph.uber.init.call(this),this.color=MorphicPreferences.isFlat?IDE_Morph.prototype.groupColor:new Color(190,190,190),this.isDraggable=!1,this.noticesTransparentClick=!0,this.setExtent(new Point(12,50))},StageHandleMorph.prototype.drawNew=function(){this.normalImage=newCanvas(this.extent()),this.highlightImage=newCanvas(this.extent()),this.drawOnCanvas(this.normalImage,this.color),this.drawOnCanvas(this.highlightImage,MorphicPreferences.isFlat?new Color(245,245,255):new Color(100,100,255),this.color),this.image=this.normalImage,this.fixLayout()},StageHandleMorph.prototype.drawOnCanvas=function(t,e,o){var i,r,s,n=t.getContext("2d"),a=t.height/8,h=t.width/6,p=h/2;for(n.lineWidth=h,n.lineCap="round",r=t.height/2,n.strokeStyle=e.toString(),i=t.width/12,s=0;s<3;s+=1)0<s&&(n.beginPath(),n.moveTo(i,r-(a-p)),n.lineTo(i,a-p+r),n.stroke()),i+=2*h,a*=2;if(o)for(n.strokeStyle=o.toString(),i=t.width/12+h,a=t.height/8,s=0;s<3;s+=1)0<s&&(n.beginPath(),n.moveTo(i,r-(a-p)),n.lineTo(i,a-p+r),n.stroke()),i+=2*h,a*=2},StageHandleMorph.prototype.fixLayout=function(){var t;this.target&&(t=this.target.parentThatIsA(IDE_Morph),this.setTop(this.target.top()+10),this.setRight(this.target.left()),t&&t.add(this))},StageHandleMorph.prototype.step=null,StageHandleMorph.prototype.mouseDownLeft=function(t){var o=this.world(),i=this.right()-t.x,r=this,s=this.target.parentThatIsA(IDE_Morph);if(!this.target)return null;s.isSmallStage=!0,s.controlBar.stageSizeButton.refresh(),this.step=function(){var t,e;o.hand.mouseButton?(t=o.hand.bounds.origin.x+i,e=r.target.right()-t,s.stageRatio=e/r.target.dimensions.x,s.setExtent(o.extent())):(this.step=null,s.isSmallStage=1!==s.stageRatio,s.controlBar.stageSizeButton.refresh())}},StageHandleMorph.prototype.mouseEnter=function(){this.image=this.highlightImage,this.changed()},StageHandleMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed()},StageHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).toggleStageSize(!0,1)},PaletteHandleMorph.prototype=new Morph,(PaletteHandleMorph.prototype.constructor=PaletteHandleMorph).uber=Morph.prototype,PaletteHandleMorph.prototype.init=function(t){this.target=t||null,HandleMorph.uber.init.call(this),this.color=MorphicPreferences.isFlat?new Color(255,255,255):new Color(190,190,190),this.isDraggable=!1,this.noticesTransparentClick=!0,this.setExtent(new Point(12,50))},PaletteHandleMorph.prototype.drawNew=StageHandleMorph.prototype.drawNew,PaletteHandleMorph.prototype.drawOnCanvas=StageHandleMorph.prototype.drawOnCanvas,PaletteHandleMorph.prototype.fixLayout=function(){var t;this.target&&(t=this.target.parentThatIsA(IDE_Morph),this.setTop(this.target.top()+10),this.setRight(this.target.right()),t&&t.add(this))},PaletteHandleMorph.prototype.step=null,PaletteHandleMorph.prototype.mouseDownLeft=function(t){var e=this.world(),o=this.right()-t.x,i=this.target.parentThatIsA(IDE_Morph);if(!this.target)return null;this.step=function(){var t;e.hand.mouseButton?(t=e.hand.bounds.origin.x+o,i.paletteWidth=Math.min(Math.max(200,t),i.stageHandle.left()-i.spriteBar.tabBar.width()),i.setExtent(e.extent())):this.step=null}},PaletteHandleMorph.prototype.mouseEnter=StageHandleMorph.prototype.mouseEnter,PaletteHandleMorph.prototype.mouseLeave=StageHandleMorph.prototype.mouseLeave,PaletteHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).setPaletteWidth(200)},CamSnapshotDialogMorph.prototype=new DialogBoxMorph,(CamSnapshotDialogMorph.prototype.constructor=CamSnapshotDialogMorph).uber=DialogBoxMorph.prototype,CamSnapshotDialogMorph.prototype.enableCamera=!0,CamSnapshotDialogMorph.prototype.enabled=!0,CamSnapshotDialogMorph.prototype.notSupportedMessage='Please make sure your web browser is up to date\nand your camera is properly configured. \n\nSome browsers also require you to access Snap!\nthrough HTTPS to use the camera.\n\nPlase replace the "http://" part of the address\nin your browser by "https://" and try again.',CamSnapshotDialogMorph.prototype.init=function(t,e,o,i){this.ide=t,this.sprite=e,this.padding=10,this.oncancel=o,this.accept=i,this.videoElement=null,this.videoView=new Morph,CamSnapshotDialogMorph.uber.init.call(this),this.labelString="Camera",this.createLabel(),this.buildContents()},CamSnapshotDialogMorph.prototype.buildContents=function(){var h=this,p=this.sprite.parentThatIsA(StageMorph);function e(){h.disable(),h.ide.inform("Camera not supported",CamSnapshotDialogMorph.prototype.notSupportedMessage),h.videoElement&&h.videoElement.remove(),h.cancel()}this.videoElement=document.createElement("video"),this.videoElement.hidden=!0,this.videoElement.width=p.dimensions.x,this.videoElement.height=p.dimensions.y,document.body.appendChild(this.videoElement),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then(function(t){h.videoElement.srcObject=t,h.videoElement.play().catch(e),h.videoElement.stream=t}).catch(e),this.videoView.setExtent(p.dimensions),this.videoView.image=newCanvas(p.dimensions),this.videoView.drawOn=function(t){var e,o,i=t.getContext("2d"),r=h.videoElement.videoWidth,s=h.videoElement.videoHeight,n=p.dimensions.x,a=p.dimensions.y;r&&(i.save(),i.translate(n,0),i.scale(-1,1),o=s/a<r/n?(e=n*(s/a),s):a*((e=r)/n),i.drawImage(h.videoElement,0,0,e,o,-1*this.left(),this.top(),n,a),i.restore())},this.videoView.step=function(){this.changed()},this.addBody(new AlignmentMorph("column",this.padding/2)),this.body.add(this.videoView),this.body.fixLayout(),this.addButton("ok","Save"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew()},CamSnapshotDialogMorph.prototype.ok=function(){this.accept(new Costume(this.videoView.fullImageClassic(),this.sprite.newCostumeName("camera")).flipped())},CamSnapshotDialogMorph.prototype.disable=function(){CamSnapshotDialogMorph.prototype.enabled=!1,document.dispatchEvent(new Event("cameraDisabled"))},CamSnapshotDialogMorph.prototype.destroy=function(){this.oncancel.call(this),this.close()},CamSnapshotDialogMorph.prototype.close=function(){this.videoElement&&this.videoElement.stream&&(this.videoElement.stream.getTracks()[0].stop(),this.videoElement.remove()),CamSnapshotDialogMorph.uber.destroy.call(this)},SoundRecorderDialogMorph.prototype=new DialogBoxMorph,(SoundRecorderDialogMorph.prototype.constructor=SoundRecorderDialogMorph).uber=DialogBoxMorph.prototype,SoundRecorderDialogMorph.prototype.init=function(t){var e=this;this.padding=10,this.accept=t,this.mediaRecorder=null,this.audioElement=document.createElement("audio"),this.audioElement.hidden=!0,this.audioElement.onended=function(t){e.stop()},document.body.appendChild(this.audioElement),this.recordButton=null,this.stopButton=null,this.playButton=null,this.progressBar=new BoxMorph,SoundRecorderDialogMorph.uber.init.call(this),this.labelString="Sound Recorder",this.createLabel(),this.buildContents()},SoundRecorderDialogMorph.prototype.buildContents=function(){var i=this,r=[];this.recordButton=new PushButtonMorph(this,"record",new SymbolMorph("circleSolid",10)),this.recordButton.drawNew(),this.recordButton.fixLayout(),this.stopButton=new PushButtonMorph(this,"stop",new SymbolMorph("rectangleSolid",10)),this.stopButton.drawNew(),this.stopButton.fixLayout(),this.playButton=new PushButtonMorph(this,"play",new SymbolMorph("pointRight",10)),this.playButton.drawNew(),this.playButton.fixLayout(),this.buildProgressBar(),this.addBody(new AlignmentMorph("row",this.padding)),this.body.add(this.recordButton),this.body.add(this.stopButton),this.body.add(this.playButton),this.body.add(this.progressBar),this.body.fixLayout(),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({audio:!0}).then(function(t){i.mediaRecorder=new MediaRecorder(t),i.mediaRecorder.ondataavailable=function(t){r.push(t.data)},i.mediaRecorder.onstop=function(t){var e=new Blob(r),o=new window.FileReader;o.readAsDataURL(e),o.onloadend=function(){var t="data:audio/ogg;base64,"+(t=o.result).split(",")[1];i.audioElement.src=t,i.audioElement.load(),r=[]}}}),this.addButton("ok","Save"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew()},SoundRecorderDialogMorph.prototype.buildProgressBar=function(){var e=new Morph,t=this;this.progressBar.setExtent(new Point(150,20)),this.progressBar.setColor(new Color(200,200,200)),this.progressBar.setBorderWidth(1),this.progressBar.setBorderColor(new Color(150,150,150)),e.setExtent(new Point(130,2)),e.setColor(new Color(50,50,50)),e.setCenter(this.progressBar.center()),this.progressBar.add(e),this.progressBar.indicator=new Morph,this.progressBar.indicator.setExtent(new Point(5,15)),this.progressBar.indicator.setColor(new Color(50,200,50)),this.progressBar.indicator.setCenter(e.leftCenter()),this.progressBar.add(this.progressBar.indicator),this.progressBar.setPercentage=function(t){this.indicator.setLeft(e.left()+e.width()/100*t-this.indicator.width()/2)},this.progressBar.step=function(){t.audioElement.duration?this.setPercentage(t.audioElement.currentTime/t.audioElement.duration*100):this.setPercentage(0)}},SoundRecorderDialogMorph.prototype.record=function(){this.mediaRecorder&&"inactive"!==this.mediaRecorder.state?this.stop():(this.mediaRecorder.start(),this.recordButton.label.setColor(new Color(255,0,0)),this.playButton.label.setColor(new Color(0,0,0)))},SoundRecorderDialogMorph.prototype.stop=function(){this.mediaRecorder&&"inactive"!==this.mediaRecorder.state&&this.mediaRecorder.stop(),this.audioElement.pause(),this.audioElement.currentTime=0,this.recordButton.label.setColor(new Color(0,0,0)),this.playButton.label.setColor(new Color(0,0,0))},SoundRecorderDialogMorph.prototype.play=function(){this.stop(),this.audioElement.oncanplaythrough=function(){this.play(),this.oncanplaythrough=nop},this.playButton.label.setColor(new Color(0,255,0))},SoundRecorderDialogMorph.prototype.ok=function(){var t=this;this.stop(),this.audioElement.oncanplaythrough=function(){this.duration&&this.duration!==1/0?(t.accept(this),this.oncanplaythrough=nop,t.destroy()):(t.buttons.children.forEach(function(t){t.disable()}),this.play())}},SoundRecorderDialogMorph.prototype.destroy=function(){this.stop(),this.audioElement.remove(),this.mediaRecorder&&this.mediaRecorder.stream.getTracks()[0].stop(),SoundRecorderDialogMorph.uber.destroy.call(this)};</script>
        <script>var PaintEditorMorph,PaintCanvasMorph,PaintColorPickerMorph;function PaintEditorMorph(){this.init()}function PaintColorPickerMorph(t,i){this.init(t,i)}function PaintCanvasMorph(t){this.init(t)}modules.paint="2019-February-22",PaintEditorMorph.prototype=new DialogBoxMorph,(PaintEditorMorph.prototype.constructor=PaintEditorMorph).uber=DialogBoxMorph.prototype,PaintEditorMorph.prototype.padding=10,PaintEditorMorph.prototype.init=function(){this.paper=null,this.oncancel=null,PaintEditorMorph.uber.init.call(this),this.labelString="Paint Editor",this.createLabel(),this.buildContents()},PaintEditorMorph.prototype.buildContents=function(){var t=this;this.paper=new PaintCanvasMorph(function(){return t.shift}),this.paper.setExtent(StageMorph.prototype.dimensions),this.addBody(new AlignmentMorph("row",this.padding)),this.controls=new AlignmentMorph("column",this.padding/2),this.controls.alignment="left",this.edits=new AlignmentMorph("row",this.padding/2),this.buildEdits(),this.controls.add(this.edits),this.body.color=this.color,this.body.add(this.controls),this.body.add(this.paper),this.toolbox=new BoxMorph,this.toolbox.color=SpriteMorph.prototype.paletteColor.lighter(8),this.toolbox.borderColor=this.toolbox.color.lighter(40),MorphicPreferences.isFlat&&(this.toolbox.edge=0),this.buildToolbox(),this.controls.add(this.toolbox),this.scaleBox=new AlignmentMorph("row",this.padding/2),this.buildScaleBox(),this.controls.add(this.scaleBox),this.propertiesControls={colorpicker:null,penSizeSlider:null,penSizeField:null,primaryColorButton:null,primaryColorViewer:null,constrain:null},this.populatePropertiesMenu(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.refreshToolButtons(),this.fixLayout(),this.drawNew()},PaintEditorMorph.prototype.buildToolbox=function(){var o={brush:"Paintbrush tool\n(free draw)",rectangle:"Stroked Rectangle\n(shift: square)",circle:"Stroked Ellipse\n(shift: circle)",eraser:"Eraser tool",crosshairs:"Set the rotation center",line:"Line tool\n(shift: vertical/horizontal)",rectangleSolid:"Filled Rectangle\n(shift: square)",circleSolid:"Filled Ellipse\n(shift: circle)",paintbucket:"Fill a region",pipette:"Pipette tool\n(pick a color anywhere)"},e=this,r=this.toolbox.left(),s=this.toolbox.top(),n=0,a=0;Object.keys(o).forEach(function(t){var i=e.toolButton(t,o[t]);i.setPosition(new Point(r+n,s+a)),n+=i.width()+2,"crosshairs"===t&&(n=0,a+=i.height()+2,e.paper.drawcrosshair()),e.toolbox[t]=i,e.toolbox.add(i)}),this.toolbox.bounds=this.toolbox.fullBounds().expandBy(10),this.toolbox.drawNew()},PaintEditorMorph.prototype.buildEdits=function(){var t=this,i=this.paper;this.edits.add(this.pushButton("undo",function(){i.undo()})),this.edits.add(this.pushButton("clear",function(){i.clearCanvas()})),this.edits.add(this.pushButton("Vector",function(){0<t.paper.undoBuffer.length?t.ide.confirm("This will erase your current drawing.\nAre you sure you want to continue?","Switch to vector editor?",function(){t.switchToVector()},nop):t.switchToVector()})),this.edits.fixLayout()},PaintEditorMorph.prototype.buildScaleBox=function(){var t=this.paper;this.scaleBox.add(this.pushButton("grow",function(){t.scale(.05,.05)})),this.scaleBox.add(this.pushButton("shrink",function(){t.scale(-.05,-.05)})),this.scaleBox.add(this.pushButton("flip ",function(){t.scale(-2,0)})),this.scaleBox.add(this.pushButton("flip ",function(){t.scale(0,-2)})),this.scaleBox.fixLayout()},PaintEditorMorph.prototype.openIn=function(t,i,o,e,r){this.oldim=i,this.callback=e||nop,this.ide=r,this.processKeyUp=function(){this.shift=!1,this.propertiesControls.constrain.refresh()},this.processKeyDown=function(){this.shift=16===this.world().currentKey,this.propertiesControls.constrain.refresh()},this.oldim&&(this.paper.automaticCrosshairs=isNil(o),this.paper.centermerge(this.oldim,this.paper.paper),this.paper.rotationCenter=(o||new Point(0,0)).add(new Point((this.paper.paper.width-this.oldim.width)/2,(this.paper.paper.height-this.oldim.height)/2)),this.paper.drawNew()),this.key="paint",this.popUp(t)},PaintEditorMorph.prototype.fixLayout=function(){var t=Morph.prototype.trackChanges;this.changed(),t=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.paper&&(this.paper.buildContents(),this.paper.drawNew()),this.controls&&this.controls.fixLayout(),this.body&&this.body.fixLayout(),PaintEditorMorph.uber.fixLayout.call(this),Morph.prototype.trackChanges=t,this.changed()},PaintEditorMorph.prototype.refreshToolButtons=function(){this.toolbox.children.forEach(function(t){t.refresh()})},PaintEditorMorph.prototype.ok=function(){this.paper.updateAutomaticCenter(),this.callback(this.paper.paper,this.paper.rotationCenter),this.destroy()},PaintEditorMorph.prototype.cancel=function(){this.oncancel&&this.oncancel(),this.destroy()},PaintEditorMorph.prototype.switchToVector=function(){var t=this;this.object=new SVG_Costume(new Image,"",new Point(0,0)),this.object.edit(this.world(),this.ide,!0,this.oncancel,function(){t.ide.currentSprite.changed()})},PaintEditorMorph.prototype.populatePropertiesMenu=function(){var t=this.controls,s=this,n=this.propertiesControls,i=new AlignmentMorph("row",this.padding);n.primaryColorViewer=new Morph,n.primaryColorViewer.setExtent(new Point(180,50)),n.primaryColorViewer.color=new Color(0,0,0),n.colorpicker=new PaintColorPickerMorph(new Point(180,100),function(t){var i,o,e=newCanvas(n.primaryColorViewer.extent()),r=e.getContext("2d");if("transparent"===(s.paper.settings.primarycolor=t))for(i=0;i<180;i+=5)for(o=0;o<15;o+=5)r.fillStyle=(o+i)/5%2==0?"rgba(0, 0, 0, 0.2)":"rgba(0, 0, 0, 0.5)",r.fillRect(i,o,5,5);else r.fillStyle=t.toString(),r.fillRect(0,0,180,15);r.strokeStyle="black",r.lineWidth=Math.min(s.paper.settings.linewidth,20),r.beginPath(),r.lineCap="round",r.moveTo(20,30),r.lineTo(160,30),r.stroke(),n.primaryColorViewer.image=e,n.primaryColorViewer.changed()}),n.colorpicker.action(new Color(0,0,0)),n.penSizeSlider=new SliderMorph(0,20,5,5),n.penSizeSlider.orientation="horizontal",n.penSizeSlider.setHeight(15),n.penSizeSlider.setWidth(150),n.penSizeSlider.action=function(t){n.penSizeField&&n.penSizeField.setContents(t),s.paper.settings.linewidth=t,n.colorpicker.action(s.paper.settings.primarycolor)},n.penSizeField=new InputFieldMorph("5",!0,null,!1),n.penSizeField.contents().minWidth=20,n.penSizeField.setWidth(25),n.penSizeField.accept=function(){var t=parseFloat(n.penSizeField.getValue());n.penSizeSlider.value=t,n.penSizeSlider.drawNew(),n.penSizeSlider.updateValue(),this.setContents(t),s.paper.settings.linewidth=t,this.world().keyboardReceiver=s,n.colorpicker.action(s.paper.settings.primarycolor)},i.add(n.penSizeSlider),i.add(n.penSizeField),i.color=s.color,i.fixLayout(),n.penSizeField.drawNew(),n.constrain=new ToggleMorph("checkbox",this,function(){s.shift=!s.shift},"Constrain proportions of shapes?\n(you can also hold shift)",function(){return s.shift}),t.add(n.colorpicker),t.add(n.primaryColorViewer),t.add(new TextMorph(localize("Brush size"))),t.add(i),t.add(n.constrain)},PaintEditorMorph.prototype.toolButton=function(t,i){var o=this,e=new ToggleButtonMorph(null,this,function(){o.paper.currentTool=t,o.paper.toolChanged(t),o.refreshToolButtons(),"pipette"===t&&o.getUserColor()},new SymbolMorph(t,18),function(){return o.paper.currentTool===t});return e.hint=i,e.drawNew(),e.fixLayout(),e},PaintEditorMorph.prototype.pushButton=function(t,i,o){return new PushButtonMorph(this,i,t,null,o)},PaintEditorMorph.prototype.getUserColor=function(){var o=this,e=this.world(),r=e.hand,s=getDocumentPositionOf(e.worldCanvas),t=r.processMouseMove,i=r.processMouseDown,n=r.processMouseUp;r.processMouseMove=function(t){var i;r.setPosition(new Point(t.pageX-s.x,t.pageY-s.y)),(i=e.getGlobalPixelColor(r.position())).a&&(i.a=255,o.propertiesControls.colorpicker.action(i))},r.processMouseDown=nop,r.processMouseUp=function(){o.paper.currentTool="brush",o.paper.toolChanged("brush"),o.refreshToolButtons(),r.processMouseMove=t,r.processMouseDown=i,r.processMouseUp=n}},PaintColorPickerMorph.prototype=new Morph,(PaintColorPickerMorph.prototype.constructor=PaintColorPickerMorph).uber=Morph.prototype,PaintColorPickerMorph.prototype.init=function(t,i){this.setExtent(t||new Point(200,100)),this.action=i||nop,this.drawNew()},PaintColorPickerMorph.prototype.drawNew=function(){for(var t,i,o=0,e=0,r=newCanvas(this.extent()),s=r.getContext("2d"),o=0;o<this.width();o+=1)for(e=0;e<this.height()-20;e+=1)s.fillStyle="hsl("+360*o/this.width()+",100%,"+100*e/(this.height()-20)+"%)",s.fillRect(o,e,1,1);for(o=0;o<this.width();o+=1)i=Math.floor(255*o/this.width()),s.fillStyle="rgb("+i+", "+i+", "+i+")",s.fillRect(o,this.height()-20,1,10);for(t=["black","white","gray"],o=0;o<t.length;o+=1)s.fillStyle=t[o],s.fillRect(o*this.width()/t.length,this.height()-10,this.width()/t.length,10);for(o=2*this.width()/3;o<this.width();o+=2)for(e=this.height()-10;e<this.height();e+=2)(o+e)/2%2==0&&(s.fillStyle="#DDD",s.fillRect(o,e,2,2));this.image=r},PaintColorPickerMorph.prototype.mouseDownLeft=function(t){t.subtract(this.position()).x>2*this.width()/3&&t.subtract(this.position()).y>this.height()-10?this.action("transparent"):this.action(this.getPixelColor(t))},PaintColorPickerMorph.prototype.mouseMove=PaintColorPickerMorph.prototype.mouseDownLeft,PaintCanvasMorph.prototype=new Morph,(PaintCanvasMorph.prototype.constructor=PaintCanvasMorph).uber=Morph.prototype,PaintCanvasMorph.prototype.init=function(t){this.rotationCenter=new Point(240,180),this.dragRect=null,this.previousDragPoint=null,this.currentTool="brush",this.dragRect=new Rectangle,this.mask=newCanvas(this.extent(),!0),this.paper=newCanvas(this.extent(),!0),this.erasermask=newCanvas(this.extent(),!0),this.background=newCanvas(this.extent()),this.settings={primarycolor:new Color(0,0,0,255),secondarycolor:new Color(0,0,0,255),linewidth:3},this.brushBuffer=[],this.undoBuffer=[],this.isShiftPressed=t||function(){return 16===this.world().currentKey},this.automaticCrosshairs=!0,this.noticesTransparentClick=!0,this.buildContents()},PaintCanvasMorph.prototype.calculateCanvasCenter=function(t){var i=Costume.prototype.canvasBoundingBox(t);return null===i?null:new Point((i.origin.x+i.corner.x)/2,(i.origin.y+i.corner.y)/2)},PaintCanvasMorph.prototype.updateAutomaticCenter=function(){var t;!this.automaticCrosshairs||null!==(t=this.calculateCanvasCenter(this.paper))&&(this.rotationCenter=t)},PaintCanvasMorph.prototype.scale=function(t,i){this.updateAutomaticCenter(),this.mask=newCanvas(this.extent(),!0);var o=newCanvas(this.extent(),!0);o.getContext("2d").save(),o.getContext("2d").translate(this.rotationCenter.x,this.rotationCenter.y),o.getContext("2d").scale(1+t,1+i),o.getContext("2d").drawImage(this.paper,-this.rotationCenter.x,-this.rotationCenter.y),o.getContext("2d").restore(),this.paper=o,this.drawNew(),this.changed()},PaintCanvasMorph.prototype.cacheUndo=function(){var t=newCanvas(this.extent(),!0);this.merge(this.paper,t),this.undoBuffer.push(t)},PaintCanvasMorph.prototype.undo=function(){0<this.undoBuffer.length&&(this.paper=newCanvas(this.extent(),!0),this.mask.width=this.mask.width+1-1,this.merge(this.undoBuffer.pop(),this.paper),this.drawNew(),this.changed())},PaintCanvasMorph.prototype.merge=function(t,i){i.getContext("2d").drawImage(t,0,0)},PaintCanvasMorph.prototype.centermerge=function(t,i){i.getContext("2d").drawImage(t,(i.width-t.width)/2,(i.height-t.height)/2)},PaintCanvasMorph.prototype.clearCanvas=function(){this.buildContents(),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.toolChanged=function(t){this.mask=newCanvas(this.extent(),!0),"crosshairs"===t&&(this.updateAutomaticCenter(),this.drawcrosshair()),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.drawcrosshair=function(t){var i=t||this.mask.getContext("2d"),o=this.rotationCenter;i.lineWidth=1,i.strokeStyle="black",i.clearRect(0,0,this.mask.width,this.mask.height),i.globalAlpha=.5,i.fillStyle="white",i.beginPath(),i.arc(o.x,o.y,20,radians(0),radians(360),!1),i.closePath(),i.fill(),i.stroke(),i.beginPath(),i.arc(o.x,o.y,10,radians(0),radians(360),!1),i.stroke(),i.beginPath(),i.moveTo(0,o.y),i.lineTo(this.mask.width,o.y),i.stroke(),i.beginPath(),i.moveTo(o.x,0),i.lineTo(o.x,this.mask.height),i.stroke(),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.floodfill=function(t){var i,o=this.paper.width,e=this.paper.height,r=this.paper.getContext("2d"),s=r.getImageData(0,0,o,e),n=s.data,a=[Math.round(Math.round(t.y)*o+t.x)],h=function(t){var i=4*t;return[n[i],n[1+i],n[2+i],n[3+i]]},p=h(a[0]),l=function(t){return t[0]===p[0]&&t[1]===p[1]&&t[2]===p[2]&&t[3]===p[3]};if((0!==p[3]||"transparent"!==this.settings.primarycolor)&&!(p[0]===this.settings.primarycolor.r&&p[1]===this.settings.primarycolor.g&&p[2]===this.settings.primarycolor.b&&p[3]===255*this.settings.primarycolor.a||0===p[3]&&0===this.settings.primarycolor.a)){for(;0<a.length;)l(h(i=a.pop()))&&(1<i%o&&(a.push(i+1),a.push(i-1)),0<i&&i<e*o&&(a.push(i+o),a.push(i-o))),"transparent"===this.settings.primarycolor?n[4*i+3]=0:(n[4*i]=this.settings.primarycolor.r,n[4*i+1]=this.settings.primarycolor.g,n[4*i+2]=this.settings.primarycolor.b,n[4*i+3]=255*this.settings.primarycolor.a);r.putImageData(s,0,0),this.drawNew(),this.changed()}},PaintCanvasMorph.prototype.mouseDownLeft=function(t){return this.cacheUndo(),this.dragRect.origin=t.subtract(this.bounds.origin),this.dragRect.corner=t.subtract(this.bounds.origin),this.previousDragPoint=this.dragRect.corner.copy(),"crosshairs"===this.currentTool?(this.rotationCenter=t.subtract(this.bounds.origin),void this.drawcrosshair()):"paintbucket"===this.currentTool?this.floodfill(t.subtract(this.bounds.origin)):void("transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool&&(this.erasermask=newCanvas(this.extent(),!0),this.merge(this.paper,this.erasermask)))},PaintCanvasMorph.prototype.mouseMove=function(t){if("paintbucket"!==this.currentTool){var i,o=t.subtract(this.bounds.origin),e=this.mask.getContext("2d"),r=this.paper.getContext("2d"),s=this.dragRect.origin.x,n=this.dragRect.origin.y,a=o.x,h=o.y,p=(a-s)/2,l=(h-n)/2,c=this.paper.width;switch(e.save(),this.brushBuffer.push([a,h]),e.lineWidth=this.settings.linewidth,e.clearRect(0,0,this.bounds.width(),this.bounds.height()),this.dragRect.corner=o.subtract(this.dragRect.origin),"transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool?(this.merge(this.erasermask,this.mask),r.clearRect(0,0,this.bounds.width(),this.bounds.height()),e.globalCompositeOperation="destination-out"):(e.fillStyle=this.settings.primarycolor.toString(),e.strokeStyle=this.settings.primarycolor.toString()),this.currentTool){case"rectangle":this.isShiftPressed()?e.strokeRect(s,n,2*d(),2*u()):e.strokeRect(s,n,2*p,2*l);break;case"rectangleSolid":this.isShiftPressed()?e.fillRect(s,n,2*d(),2*u()):e.fillRect(s,n,2*p,2*l);break;case"brush":for(e.lineCap="round",e.lineJoin="round",e.beginPath(),e.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]),i=0;i<this.brushBuffer.length;i+=1)e.lineTo(this.brushBuffer[i][0],this.brushBuffer[i][1]);e.stroke();break;case"line":e.beginPath(),e.moveTo(s,n),this.isShiftPressed()?Math.abs(l)>Math.abs(p)?e.lineTo(s,h):e.lineTo(a,n):e.lineTo(a,h),e.stroke();break;case"circle":case"circleSolid":if(e.beginPath(),this.isShiftPressed())e.arc(s,n,new Point(s,n).distanceTo(new Point(a,h)),0,2*Math.PI,!1);else{for(i=0;i<c;i+=1)e.lineTo(i,2*l*Math.sqrt(2-Math.pow((i-s)/(2*p),2))+n);for(i=c;0<i;--i)e.lineTo(i,2*l*-1*Math.sqrt(2-Math.pow((i-s)/(2*p),2))+n)}e.closePath(),"circleSolid"===this.currentTool?e.fill():"circle"===this.currentTool&&e.stroke();break;case"crosshairs":this.automaticCrosshairs=!1,this.rotationCenter=o.copy(),this.drawcrosshair(e);break;case"eraser":for(this.merge(this.paper,this.mask),e.save(),e.globalCompositeOperation="destination-out",e.beginPath(),e.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]),i=0;i<this.brushBuffer.length;i+=1)e.lineTo(this.brushBuffer[i][0],this.brushBuffer[i][1]);e.stroke(),e.restore(),this.paper=newCanvas(this.extent(),!0),this.merge(this.mask,this.paper);break;default:nop()}this.previousDragPoint=o,this.drawNew(),this.changed(),e.restore()}function d(){return Math.max(Math.abs(p),Math.abs(l))*(p/Math.abs(p))}function u(){return Math.max(Math.abs(p),Math.abs(l))*(l/Math.abs(l))}},PaintCanvasMorph.prototype.mouseClickLeft=function(){"crosshairs"!==this.currentTool&&this.merge(this.mask,this.paper),this.brushBuffer=[]},PaintCanvasMorph.prototype.mouseLeaveDragging=PaintCanvasMorph.prototype.mouseClickLeft,PaintCanvasMorph.prototype.buildContents=function(){this.background=newCanvas(this.extent()),this.paper=newCanvas(this.extent(),!0),this.mask=newCanvas(this.extent(),!0),this.erasermask=newCanvas(this.extent(),!0);for(var t,i=this.background.getContext("2d"),o=0;o<this.background.width;o+=5)for(t=0;t<this.background.height;t+=5)i.fillStyle=(o+t)/5%2==1?"rgba(255, 255, 255, 1)":"rgba(255, 255, 255, 0.3)",i.fillRect(o,t,5,5)},PaintCanvasMorph.prototype.drawNew=function(){var t=newCanvas(this.extent(),!0);this.merge(this.background,t),this.merge(this.paper,t),this.merge(this.mask,t),this.image=t,this.drawFrame()},PaintCanvasMorph.prototype.drawFrame=function(){var t=this.image.getContext("2d"),i=this.parent?(this.color=this.parent.color.lighter(.75*this.contrast),this.parent.color):new Color(120,120,120);t.fillStyle=this.color.toString(),this.cachedClr=i.toString(),this.cachedClrBright=i.lighter(this.contrast).toString(),this.cachedClrDark=i.darker(this.contrast).toString(),this.drawRectBorder(t)},PaintCanvasMorph.prototype.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,PaintCanvasMorph.prototype.edge=InputFieldMorph.prototype.edge,PaintCanvasMorph.prototype.fontSize=InputFieldMorph.prototype.fontSize,PaintCanvasMorph.prototype.typeInPadding=InputFieldMorph.prototype.typeInPadding,PaintCanvasMorph.prototype.contrast=InputFieldMorph.prototype.contrast;</script>
        <script>var List,ListWatcherMorph;function List(t){this.type=null,this.contents=t||[],this.first=null,this.rest=null,this.isLinked=!1,this.lastChanged=Date.now()}function ListWatcherMorph(t,e){this.init(t,e)}modules.lists="2019-July-01",List.prototype.enableTables=!0,List.prototype.toString=function(){return"a List ["+this.length()+" elements]"},List.prototype.changed=function(){this.lastChanged=Date.now()},List.prototype.cons=function(t,e){var n=new List;if(!(e instanceof List||isNil(e)))throw new Error("cdr isn't a list: "+e);return n.first=isNil(t)?null:t,n.rest=e||null,n.isLinked=!0,n},List.prototype.cdr=function(){var t,e;if(this.isLinked)return this.rest||new List;if(this.contents.length<2)return new List;for(t=new List,e=this.contents.length;1<e;--e)t=this.cons(this.at(e),t);return t},List.prototype.add=function(t,e){var n=e||this.length()+1,s=isNil(t)?null:t;this.becomeArray(),this.contents.splice(n-1,0,s),this.changed()},List.prototype.put=function(t,e){var n=0===t?0:!1!==t&&(t||null);this.becomeArray(),this.contents[e-1]=n,this.changed()},List.prototype.remove=function(t){this.becomeArray(),this.contents.splice(t-1,1),this.changed()},List.prototype.clear=function(){this.contents=[],this.first=null,this.rest=null,this.isLinked=!1,this.changed()},List.prototype.length=function(){if(this.isLinked){for(var t=this,e=0;t&&t.isLinked;)e+=1,t=t.rest;return e+(t?t.contents.length:0)}return this.contents.length},List.prototype.at=function(t){for(var e,n=+t,s=this;s.isLinked;){if(!(1<n))return s.first;s=s.rest,--n}return e=s.contents[n-1],isNil(e)?"":e},List.prototype.contains=function(e){for(var t=this;t.isLinked;){if(snapEquals(t.first,e))return!0;t=t.rest}return t.contents.some(function(t){return snapEquals(t,e)})},List.prototype.isEmpty=function(){return this.isLinked?isNil(this.first):!this.contents.length},List.prototype.isTable=function(){return this.enableTables&&(100<this.length()||1<this.cols())},List.prototype.get=function(t,e){var n,s,i;return t?e?(n=this.at(e))instanceof List?(s=n.length(),i=this.cols(),s<t?null:1===i&&1<s?[n]:i<=t&&i<s?new Variable(n.at(t)):n.at(t)):1===t&&e<=this.rows()?[n]:null:1===this.cols()?localize("items"):this.colName(t):e?e>this.rows()?null:this.rowName(e):[this.length()]},List.prototype.rows=function(){return this.length()},List.prototype.cols=function(){var t=this.at(1);return t instanceof List?t.length():1},List.prototype.colName=function(t){return t>this.cols()?null:String.fromCharCode(64+(t%26||26)).repeat(Math.floor((t-1)/26)+1)},List.prototype.rowName=function(t){return t},List.prototype.columnNames=function(){return[]},List.prototype.version=function(t,e,n,s){for(var i,o=Math.min(t+e,this.length()),r=this.lastChanged,h=t;h<=o;h+=1)r=(i=this.at(h))instanceof Costume?Math.max(r,i.version):i instanceof List?Math.max(r,i.version(n,s)):Math.max(r,i.lastChanged?i.lastChanged:0);return r},List.prototype.asArray=function(){return this.becomeArray(),this.contents},List.prototype.itemsArray=function(){if(this.isLinked){for(var t,e=this,n=[];e&&e.isLinked;)n.push(e.first),e=e.rest;if(e)for(t=1;t<=e.contents.length;t+=1)n.push(e.at(t));return n}return this.contents},List.prototype.asText=function(){for(var t,e,n,s="",i=this;i.isLinked;)s=(e=i.first)instanceof List?s.concat(e.asText()):(e=isNil(e)?"":e.toString(),s.concat(e)),i=i.rest;for(t=i.length(),n=1;n<=t;n+=1)s=(e=i.at(n))instanceof List?s.concat(e.asText()):(e=isNil(e)?"":e.toString(),s.concat(e));return s},List.prototype.becomeArray=function(){this.isLinked&&(this.contents=this.itemsArray(),this.isLinked=!1,this.first=null,this.rest=null)},List.prototype.becomeLinked=function(){var t,e,n=this;if(!this.isLinked){for(e=this.length(),t=0;t<e;t+=1)n.first=this.contents[t],t<e&&(n.rest=new List,n.isLinked=!0,n=n.rest);this.contents=[],this.isLinked=!0}},List.prototype.asCSV=function(){var t=this.itemsArray(),e=[];function n(t){var e,n=t.toString();return-1===n.indexOf('"')&&-1===n.indexOf("\n")&&-1===n.indexOf(",")?n:(e=['"'],n.split("").forEach(function(t){e.push(t),'"'===t&&e.push(t)}),e.push('"'),e.join(""))}return t.some(function(t){return t instanceof List})?(t.forEach(function(t){t instanceof List?e.push(t.itemsArray().map(n).join(",")):e.push(n(t))}),e.join("\n")):t.map(n).join(",")},List.prototype.asJSON=function(t){return JSON.stringify(function n(t,s){var e=t.itemsArray(),i={};return function(t){var s;return t.every(function(t){return t instanceof List&&t.length()<3})&&(s=t.map(function(t){return t.at(1)})).every(function(t){return isString(t)&&(e=t,(n=s).indexOf(e)===n.lastIndexOf(e));var e,n})}(e)?(e.forEach(function(t){var e=2===t.length()?t.at(2):void 0;i[t.at(1)]=e instanceof List?n(e,s):e}),i):e.map(function(t){return t instanceof List?n(t,s):t})}(this,t))},List.prototype.equalTo=function(t){var e,n,s,i=this,o=t;if(!(t instanceof List))return!1;for(;i.isLinked&&o.isLinked;){if(!snapEquals(i.first,o.first))return!1;i=i.rest,o=o.rest}for(o.isLinked&&(e=o,o=i,i=e),n=0;i.isLinked;){if(!snapEquals(i.first,o.contents[n]))return!1;i=i.rest,n+=1}if(e=0,i.contents.length!==o.contents.length-n)return!1;for(s=i.contents.length;0<s;){if(--s,!snapEquals(i.contents[e],o.contents[n]))return!1;e+=1,n+=1}return!0},List.prototype.canBeCSV=function(){return this.itemsArray().every(function(t){return!isNaN(+t)&&"boolean"!=typeof t||isString(t)||t instanceof List&&t.hasOnlyAtomicData()})},List.prototype.canBeJSON=function(){return this.itemsArray().every(function(t){return!isNaN(+t)||isString(t)||!0===t||!1===t||t instanceof List&&t.canBeJSON()})},List.prototype.hasOnlyAtomicData=function(){return this.itemsArray().every(function(t){return!isNaN(+t)&&"boolean"!=typeof t||isString(t)})},ListWatcherMorph.prototype=new BoxMorph,(ListWatcherMorph.prototype.constructor=ListWatcherMorph).uber=BoxMorph.prototype,ListWatcherMorph.prototype.cellColor=SpriteMorph.prototype.blockColor.lists,ListWatcherMorph.prototype.init=function(t,e){var n=this;this.list=t||new List,this.start=1,this.range=100,this.lastUpdated=0,this.lastCell=null,this.parentCell=e||null,this.label=new StringMorph(localize("length: ")+this.list.length(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),this.label.mouseClickLeft=function(){n.startIndexMenu()},this.frame=new ScrollFrameMorph(null,10),this.frame.alpha=0,this.frame.acceptsDrops=!1,this.frame.contents.acceptsDrops=!1,this.handle=new HandleMorph(this,80,70,3,3),this.handle.setExtent(new Point(13,13)),this.arrow=new ArrowMorph("down",SyntaxElementMorph.prototype.fontSize),this.arrow.mouseClickLeft=function(){n.startIndexMenu()},this.arrow.setRight(this.handle.right()),this.arrow.setBottom(this.handle.top()),this.handle.add(this.arrow),this.plusButton=new PushButtonMorph(this.list,"add","+"),this.plusButton.padding=0,this.plusButton.edge=0,this.plusButton.outlineColor=this.color,this.plusButton.drawNew(),this.plusButton.fixLayout(),ListWatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1.000001,new Color(120,120,120)),this.color=new Color(220,220,220),this.isDraggable=!1,this.setExtent(new Point(80,70).multiplyBy(SyntaxElementMorph.prototype.scale)),this.add(this.label),this.add(this.frame),this.add(this.plusButton),this.add(this.handle),this.handle.drawNew(),this.update(),this.fixLayout()},ListWatcherMorph.prototype.update=function(t){var e,n,s,i,o,r,h,a,l,c;if(this.frame.contents.children.forEach(function(t){t instanceof CellMorph&&(t.contentsMorph instanceof ListWatcherMorph?t.contentsMorph.update():(isSnapObject(t.contents)||t.contents instanceof Costume)&&t.update())}),this.lastUpdated===this.list.lastChanged&&!t)return null;for(this.updateLength(!0),this.start=Math.max(Math.min(this.start,Math.floor((this.list.length()-1)/this.range)*this.range+1),1),l=Math.min(this.start+this.range-1,this.list.length()),s=Math.min(3*(l-this.start+1),this.frame.contents.children.length),e=0;e<s;e+=3)n=this.start+e/3,o=this.frame.contents.children[e],h=this.frame.contents.children[e+1],a=this.frame.contents.children[e+2],r=this.list.at(n),o.contents!==r&&(o.contents=r,o.drawNew(),this.lastCell&&o.setLeft(this.lastCell.left())),this.lastCell=o,h.text!==n.toString()&&(h.text=n.toString(),h.drawNew()),a.action=n;for(i=3*(l-this.start+1);this.frame.contents.children.length>i;)this.frame.contents.children[i].destroy();if(s=i,e=this.frame.contents.children.length,c=Date.now(),e+1<s)for(;e<s;e+=3){if(1e3<Date.now()-c)return this.fixLayout(),this.frame.contents.adjustBounds(),this.frame.contents.setLeft(this.frame.left()),null;n=this.start+e/3,h=new StringMorph(n.toString(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),o=new CellMorph(this.list.at(n),this.cellColor,n,this.parentCell),(a=new PushButtonMorph(this.list.remove,n,"-",this.list)).padding=1,a.edge=0,a.corner=1,a.outlineColor=this.color.darker(),a.drawNew(),a.fixLayout(),this.frame.contents.add(o),this.lastCell?o.setPosition(this.lastCell.bottomLeft()):o.setTop(this.frame.contents.top()),this.lastCell=o,h.setCenter(o.center()),h.setRight(o.left()-2),this.frame.contents.add(h),this.frame.contents.add(a)}this.lastCell=null,this.fixLayout(),this.frame.contents.adjustBounds(),this.frame.contents.setLeft(this.frame.left()),this.updateLength(),this.lastUpdated=this.list.lastChanged},ListWatcherMorph.prototype.updateLength=function(t){this.label.text=localize("length: ")+this.list.length(),this.label.color=t?new Color(0,0,100):new Color(0,0,0),this.label.drawNew(),this.label.setCenter(this.center()),this.label.setBottom(this.bottom()-3)},ListWatcherMorph.prototype.startIndexMenu=function(){var t,e,n=this,s=Math.ceil(this.list.length()/this.range),i=new MenuMorph(function(t){n.setStartIndex(t)},null,n);for(i.addItem("1...",1),t=1;t<s;t+=1)e=100*t+1,i.addItem(e+"...",e);i.popUpAtHand(this.world())},ListWatcherMorph.prototype.setStartIndex=function(t){this.start=t,this.list.changed()},ListWatcherMorph.prototype.fixLayout=function(){this.label&&(Morph.prototype.trackChanges=!1,this.frame&&(this.arrangeCells(),this.frame.silentSetPosition(this.position().add(3)),this.frame.bounds.corner=this.bounds.corner.subtract(new Point(3,17)),this.frame.drawNew(),this.frame.contents.adjustBounds()),this.label.setCenter(this.center()),this.label.setBottom(this.bottom()-3),this.plusButton.setLeft(this.left()+3),this.plusButton.setBottom(this.bottom()-3),Morph.prototype.trackChanges=!0,this.changed(),this.parent&&this.parent.fixLayout&&this.parent.fixLayout())},ListWatcherMorph.prototype.arrangeCells=function(){for(var t,e,n,s,i=this.frame.contents.children.length,o=0;o<i;o+=3)t=this.frame.contents.children[o],e=this.frame.contents.children[o+1],n=this.frame.contents.children[o+2],s&&t.setTop(s.bottom()),e&&(e.setTop(t.center().y-e.height()/2),e.setRight(t.left()-2)),n&&(n.setCenter(t.center()),n.setLeft(t.right()+2)),s=t;this.frame.contents.adjustBounds()},ListWatcherMorph.prototype.expand=function(t){var e=this.frame.contents.extent(),n=new Point(e.x+6,e.y+this.label.height()+6);t&&(n=n.min(t)),this.setExtent(n),this.handle.setRight(this.right()-3),this.handle.setBottom(this.bottom()-3)},ListWatcherMorph.prototype.userMenu=function(){if(!List.prototype.enableTables)return this.escalateEvent("userMenu");var t=new MenuMorph(this),e=this;return t.addItem("table view...","showTableView"),t.addLine(),t.addItem("open in dialog...",function(){new TableDialogMorph(e.list).popUp(e.world())}),t},ListWatcherMorph.prototype.showTableView=function(){var t=this.parentThatIsA(SpriteBubbleMorph,SpeechBubbleMorph,CellMorph);t&&(t instanceof SpriteBubbleMorph?(t.changed(),t.drawNew(!0)):t instanceof SpeechBubbleMorph?(t.contents=new TableFrameMorph(new TableMorph(this.list,10)),t.contents.expand(this.extent()),t.drawNew(!0)):(t.drawNew(!0,"table"),t.contentsMorph.expand(this.extent())),t.fixLayout())},ListWatcherMorph.prototype.mouseDoubleClick=function(t){List.prototype.enableTables?new TableDialogMorph(this.list).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},ListWatcherMorph.prototype.show=function(){ListWatcherMorph.uber.show.call(this),this.frame.contents.adjustBounds()},ListWatcherMorph.prototype.drawNew=function(){WatcherMorph.prototype.drawNew.call(this),this.fixLayout()};</script>
        <script>undefined</script>
        <script>var Table,TableCellMorph,TableMorph,TableFrameMorph;function Table(t,i){this.colCount=+t,this.rowCount=+i,this.colNames=[],this.rowNames=[],this.contents=new Array(+i);for(var o=0;o<i;o+=1)this.contents[o]=new Array(+t);this.lastChanged=Date.now()}function TableCellMorph(t,i,o){this.init(t,i,o)}function TableMorph(t,i,o,e,s,h,a,r,l,n){this.init(t,i,o,e,s,h,a,r,l,n)}function TableFrameMorph(t,i){this.init(t,i)}function TableDialogMorph(t,i,o,e){this.init(t,i,o,e)}modules.tables="2019-June-04",Table.prototype.demo=function(t){this.fillWithTestData(),new TableDialogMorph(this).popUp(t)},Table.prototype.changed=function(){this.lastChanged=Date.now()},Table.prototype.get=function(t,i){return t?i?t>this.colCount||i>this.rowCount?null:(this.contents[i-1]||[])[t-1]:this.colName(t):i?this.rowName(i):[this.rowCount]},Table.prototype.row=function(t){return this.contents[t-1]},Table.prototype.col=function(t){for(var i=[],o=t-1,e=0;e<this.rowCount;e+=1)i.push(this.contents[e][o]);return i},Table.prototype.colName=function(t){if(t>this.colCount)return null;var i=this.colNames[t-1];return void 0!==i?i:String.fromCharCode(64+(t%26||26)).repeat(Math.floor((t-1)/26)+1)},Table.prototype.rowName=function(t){return t>this.rowCount?null:this.rowNames[t-1]||t},Table.prototype.rows=function(){return this.rowCount},Table.prototype.cols=function(){return this.colCount},Table.prototype.columnNames=function(){return this.colNames},Table.prototype.set=function(t,i,o){this.contents[o-1][i-1]=t,this.changed()},Table.prototype.setRows=function(t,i,o){this.contents=t,i&&(this.colNames=i),o&&(this.rowNames=o),this.changed()},Table.prototype.setCols=function(t,i,o){for(var e,s=0;s<this.colCount;s+=1)for(e=0;e<this.rowCount;e+=1)this.contents[e][s]=t[s][e];i&&(this.colNames=i),o&&(this.rowNames=o),this.changed()},Table.prototype.setColNames=function(t){this.colNames=t||[],this.changed()},Table.prototype.setRowNames=function(t){this.rowNames=t||[],this.changed()},Table.prototype.setColName=function(t,i){this.colNames[t+1]=i,this.changed()},Table.prototype.setRowName=function(t,i){this.rowNames[t+1]=i,this.changed()},Table.prototype.addRow=function(t,i){this.contents[this.rowCount]=t||new Array(this.rowCount),this.rowNames[this.rowCount]=i,this.rowCount+=1,this.changed()},Table.prototype.addCol=function(t,i){var o;if(t)for(o=0;o<this.col;o+=1)this.contents[o][this.colCount]=t[o];this.colNames[this.colCount]=i,this.colCount+=1,this.changed()},Table.prototype.toList=function(){return new List(this.contents.map(function(t){return new List(t)}))},Table.prototype.fillWithTestData=function(){for(var t,i=1;i<=this.colCount;i+=1)for(t=1;t<=this.rowCount;t+=1)this.set(this.colName(i)+this.rowName(t),i,t)},TableCellMorph.prototype=new Morph,(TableCellMorph.prototype.constructor=TableCellMorph).uber=Morph.prototype,TableCellMorph.prototype.listSymbol=ArgMorph.prototype.listIcon(),TableCellMorph.prototype.init=function(t,i,o){this.data=t,this.isLabel=o||!1,TableCellMorph.uber.init.call(this,!0),this.noticesTransparentClick=!0,i&&this.silentSetExtent(i),this.drawNew()},TableCellMorph.prototype.setData=function(t,i){this.data=t,i&&!i.eq(this.extent())?(this.silentSetExtent(i),this.drawNew()):this.drawData()},TableCellMorph.prototype.getData=function(){return this.data instanceof Array?this.data[0]:this.data},TableCellMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent()),this.drawData()},TableCellMorph.prototype.drawData=function(t,i){var o,e,s,h,a=t||this.dataRepresentation(this.data),r=this.image.getContext("2d"),l=SyntaxElementMorph.prototype.fontSize,n=TableMorph.prototype.highContrast?"rgb(220, 220, 220)":"transparent",p=(this.isLabel?this.data instanceof Array?"italic":"":this.shouldBeList()?"bold":"")+" "+l+"px Helvetica, Arial, sans-serif",c=i||(this.isLabel?n:this.shouldBeList()?"rgb(217, 77, 17)":!this.isOvershooting()&&isNil(this.data)?n:"white"),u=!this.isLabel&&this.shouldBeList()?"white":"black",d=this.width(),b=this.height();r.clearRect(0,0,d,b),r.fillStyle=c,this.shouldBeList()?(BoxMorph.prototype.outlinePath.call(this,r,SyntaxElementMorph.prototype.corner+1,0),r.fill()):this.isOvershooting()?(this.raggedBoxPath(r),r.fill()):r.fillRect(0,0,d,b),a&&(a instanceof HTMLCanvasElement?(s=Math.max((d-a.width)/2,0),h=Math.max((b-a.height)/2,0),r.shadowOffsetX=4,r.shadowOffsetY=4,r.shadowBlur=4,r.shadowColor="lightgray",r.drawImage(a,s,h)):(r.font=p,r.textAlign="left",r.textBaseline="bottom",o=r.measureText(a).width,e=fontHeight(l),r.fillStyle=u,s=Math.max((d-o)/2,0),h=Math.max((b-e)/2,0),r.fillText(a,s,e+h)))},TableCellMorph.prototype.dataRepresentation=function(t){return t instanceof Morph?isSnapObject(t)?t.thumbnail(new Point(40,40)):t.fullImageClassic():isString(t)?100<t.length?t.slice(0,100)+"...":t:"number"==typeof t?t.toString():"boolean"==typeof t?SpriteMorph.prototype.booleanMorph.call(null,t).fullImage():t instanceof Array?this.dataRepresentation(t[0]):t instanceof Variable?this.dataRepresentation(t.value):t instanceof HTMLCanvasElement?t:t instanceof Context?t.image():t instanceof Costume?t.thumbnail(new Point(40,40)):t instanceof Sound?new SymbolMorph("notes",30).image:t instanceof List?this.listSymbol:t?t.toString():0===t?"0":null},TableCellMorph.prototype.raggedBoxPath=function(t){var i=this.width(),o=this.height(),e=.75*i,s=o/6,h=0;for(t.beginPath(),t.moveTo(0,0),t.lineTo(i,0),h=0;h<o;h+=2*s)t.lineTo(e,h+s),t.lineTo(i,h+2*s);t.lineTo(i,o),t.lineTo(0,o),t.closePath()},TableCellMorph.prototype.shouldBeList=function(){return this.data instanceof Array},TableCellMorph.prototype.isOvershooting=function(){return this.data instanceof Variable},TableCellMorph.prototype.mouseDoubleClick=function(t){this.data instanceof Table||this.data instanceof List?new TableDialogMorph(this.data).popUp(this.world()):this.data instanceof Array&&this.data[0]instanceof List?new TableDialogMorph(this.data[0]).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},TableCellMorph.prototype.mouseEnter=function(){var t,i,o;this.isLabel&&(i=(t=this.parentThatIsA(TableMorph)).world().hand.left()-t.left(),0<(o=t.columnAt(i))&&(this.drawData(o,"rgb(220, 220, 250)"),this.changed()))},TableCellMorph.prototype.mouseLeave=function(){this.isLabel&&(this.drawData(),this.changed())},TableMorph.prototype=new FrameMorph,(TableMorph.prototype.constructor=TableMorph).uber=FrameMorph.prototype,TableMorph.prototype.highContrast=!1,TableMorph.prototype.init=function(t,i,o,e,s,h,a,r,l,n){this.table=t,this.scrollBarSize=i||MorphicPreferences.scrollBarSize,this.startRow=e||1,this.startCol=s||1,this.textHeight=Math.ceil(1.3*fontHeight(SyntaxElementMorph.prototype.fontSize)),this.rowHeight=r||this.textHeight,this.colWidths=a||[],this.globalColWidth=h||Math.ceil(3.5*this.textHeight),this.colLabelHeight=l||this.textHeight,this.padding=n||SyntaxElementMorph.prototype.scale,this.tableVersion=this.table.lastChanged,this.hBar=null,this.vBar=null,this.rowLabelWidth=0,this.columns=[],this.rows=0,this.maxStartRow=null,this.maxStartCol=null,this.dragAnchor=null,this.resizeAnchor=null,this.resizeCol=null,this.resizeRow=null,this.wantsUpdate=!1,Morph.prototype.init.call(this,!0),o&&this.silentSetExtent(o),this.initScrollBars(),this.drawNew()},TableMorph.prototype.initScrollBars=function(){var i=this;this.hBar=new SliderMorph(1,null,null,null,"horizontal"),this.hBar.setHeight(this.scrollBarSize),this.hBar.action=function(t){i.showData(t,null,!0)},this.hBar.isDraggable=!1,this.add(this.hBar),this.vBar=new SliderMorph(1,null,null,null,"vertical"),this.vBar.setWidth(this.scrollBarSize),this.vBar.action=function(t){i.showData(null,t,!0)},this.vBar.isDraggable=!1,this.add(this.vBar)},TableMorph.prototype.updateScrollBars=function(){1===this.maxStartCol?this.hBar.hide():(this.hBar.show(),this.hBar.stop=this.maxStartCol,this.hBar.value=this.startCol,this.hBar.size=Math.max(this.hBar.rangeSize()*this.columns.length/this.table.cols(),this.hBar.rangeSize()/10),this.hBar.drawNew()),this.vBar.stop=this.maxStartRow,this.vBar.value=this.startRow,1===this.maxStartRow?this.vBar.hide():(this.vBar.show(),this.vBar.size=Math.max(this.vBar.rangeSize()*this.rows/this.table.rows(),this.vBar.rangeSize()/10),this.vBar.drawNew())},TableMorph.prototype.drawNew=function(){var t,i,o;if(this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle="rgb(220, 220, 220)",BoxMorph.prototype.outlinePath.call(this,t,SyntaxElementMorph.prototype.corner+1,0),t.fill(),this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.highContrast&&1<this.table.cols()){for(i=this.padding,o=this.startCol;o<=this.table.cols();o+=1)i+=this.colWidth(o)+this.padding;t.fillStyle="darkGray",t.fillRect(this.padding+this.rowLabelWidth,this.padding+this.colLabelHeight,i,(this.rowHeight+this.padding)*(this.table.rows()+1-this.startRow)+this.padding)}this.buildCells(),this.hBar.setWidth(this.width()-this.vBar.width()),this.hBar.setLeft(this.left()),this.hBar.setBottom(this.bottom()),this.vBar.setHeight(this.height()-this.hBar.height()),this.vBar.setRight(this.right()),this.vBar.setTop(this.top())},TableMorph.prototype.buildCells=function(){var t,i,o,e=this.position();for(this.children=[],o=0;o<=this.columns.length;o+=1)for(i=0;i<=this.rows;i+=1)(t=new TableCellMorph(this.table.get(o?o+this.startCol-1:o,i?i+this.startRow-1:i),new Point(o?this.colWidth(o+this.startCol-1):this.rowLabelWidth,i?this.rowHeight:this.colLabelHeight),!(i&&o),!1)).setPosition(new Point(o?this.columns[o-1]:this.padding,i?2*this.padding+this.colLabelHeight+(i-1)*(this.rowHeight+this.padding):this.padding).add(e)),this.add(t),isSnapObject(t.getData())&&(this.wantsUpdate=!0);this.add(this.hBar),this.add(this.vBar),this.updateScrollBars(),this.changed()},TableMorph.prototype.drawData=function(t){for(var i,o,e=0,s=0;s<=this.columns.length;s+=1)for(o=0;o<=this.rows;o+=1)i=this.children[e],e+=1,i.setData(this.table.get(s?s+this.startCol-1:s,o?o+this.startRow-1:o)),isSnapObject(i.getData())&&(this.wantsUpdate=!0);t||this.updateScrollBars(),this.changed()},TableMorph.prototype.scroll=function(t,i){this.showData(Math.min(this.maxStartCol,Math.max(1,this.startCol+Math.round(t))),Math.min(this.maxStartRow,Math.max(1,this.startRow+Math.round(i)))),this.updateScrollBars()},TableMorph.prototype.showData=function(t,i,o){var e=t||this.startCol,s=i||this.startRow;if(e===this.startCol){if(s===this.startRow)return;this.startRow=s,this.rows=this.visibleRows(),this.drawData(o)}else this.startCol=e,this.startRow=s,this.rows=this.visibleRows(),this.colWidths.length?(this.columns=this.columnsLayout(),this.buildCells()):this.drawData(o)},TableMorph.prototype.step=function(){this.dragAnchor?this.shiftCells(this.world().hand.position()):this.resizeAnchor&&this.resizeCells(this.world().hand.position()),this.update()},TableMorph.prototype.update=function(){var t,i,o=this.table instanceof List?this.table.version(this.startRow,this.rows,this.startCol,this.columns.length):this.table.lastChanged;this.tableVersion===o&&!this.wantsUpdate||(this.wantsUpdate=!1,this.table instanceof List?(t=this.columns.length,i=this.rows,this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.columns.length!==t||this.rows!==i?this.buildCells():this.drawData()):this.drawData(),this.tableVersion=o)},TableMorph.prototype.rowLabelsWidth=function(){var i=newCanvas().getContext("2d");return i.font="italic "+SyntaxElementMorph.prototype.fontSize+"px Helvetica, Arial, sans-serif",Math.max(0,Math.max.apply(null,this.table.columnNames().map(function(t){return t?i.measureText(t).width:0})))||i.measureText(this.table.rows().toString()).width+6*SyntaxElementMorph.prototype.scale},TableMorph.prototype.columnsLayout=function(){for(var t=[],i=2*this.padding+this.rowLabelWidth,o=this.table.cols(),e=i;e<this.width()&&0<o;)e+=this.colWidth(o),--o;for(0===o&&e<this.width()?this.maxStartCol=1:this.maxStartCol=Math.min(o+2,this.table.cols()),this.startCol=Math.min(this.startCol,this.maxStartCol),o=this.startCol;i<this.width()&&o<this.table.cols()+this.startCol;)e=this.colWidth(o),t.push(i),i+=e,i+=this.padding,o+=1;return t},TableMorph.prototype.colWidth=function(t){return this.colWidths[t-1]||this.globalColWidth},TableMorph.prototype.visibleRows=function(){var t,i=this.height()-this.colLabelHeight-this.padding;return i<0?0:(t=Math.ceil(i/(this.rowHeight+this.padding)),this.maxStartRow=Math.max(1,this.table.rows()-t+2),this.startRow=Math.min(this.startRow,this.maxStartRow),Math.min(this.table.rows(),t))},TableMorph.prototype.globalExtent=function(){for(var t=this.rowLabelsWidth()+2,i=this.table.cols(),o=0;o<i;o+=1)t+=this.colWidth(o+1),t+=this.padding;return 1===i&&(t+=this.scrollBarSize,t+=2*this.padding),new Point(t+this.padding,this.colLabelHeight+2*this.padding+(this.rowHeight+this.padding)*this.table.rows())},TableMorph.prototype.mouseScroll=function(t,i){this.scroll(-(i*MorphicPreferences.mouseScrollAmount)/4,-(t*MorphicPreferences.mouseScrollAmount))},TableMorph.prototype.mouseDownLeft=function(t){var i=t.subtract(this.position());i.x<=this.rowLabelWidth||i.y<=this.colLabelHeight?(16===this.world().currentKey?this.resizeCol=0:this.resizeCol=this.columnAt(i.x),this.resizeRow=i.y>this.colLabelHeight,this.resizeAnchor=t):(this.resizeRow=null,this.dragAnchor=t)},TableMorph.prototype.mouseClickLeft=function(t){this.dragAnchor=null,this.resizeAnchor=null,this.resizeRow=null},TableMorph.prototype.mouseLeaveDragging=function(t){this.dragAnchor=null,this.resizeAnchor=null,this.resizeRow=null},TableMorph.prototype.mouseDoubleClick=function(t){this.parentThatIsA(TableDialogMorph)?this.escalateEvent("mouseDoubleClick",t):new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight).popUp(this.world())},TableMorph.prototype.shiftCells=function(t){var i=this.dragAnchor.subtract(t),o=Math.round(i.x/this.globalColWidth),e=Math.round(i.y/this.rowHeight);(o||e)&&(this.scroll(o,e),this.dragAnchor=t)},TableMorph.prototype.resizeCells=function(t){var i,o=t.subtract(this.resizeAnchor);if(this.resizeCol)this.colWidths[this.resizeCol-1]=Math.max(16,(this.colWidths[this.resizeCol-1]||this.globalColWidth)+o.x);else if(this.resizeRow)this.rowHeight=Math.max(16,this.rowHeight+o.y);else for(this.globalColWidth=Math.max(16,this.globalColWidth+o.x),i=0;i<this.colWidths.length;i+=1)this.colWidths[i]&&(this.colWidths[i]=Math.max(16,this.colWidths[i]+o.x));this.highContrast?this.drawNew():(this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.buildCells()),this.resizeAnchor=t},TableMorph.prototype.columnAt=function(t){var i=0;if(t<this.columns[0])return 0;for(;t>this.columns[i];)i+=1;return i+this.startCol-1},TableMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return this.parentThatIsA(TableDialogMorph)?(this.colWidths.length&&(t.addItem("reset columns","resetColumns"),t.addLine()),t.addItem("open in another dialog...","openInDialog")):(this.colWidths.length&&t.addItem("reset columns","resetColumns"),t.addItem("list view...","showListView"),t.addLine(),t.addItem("open in dialog...","openInDialog")),t},TableMorph.prototype.resetColumns=function(){this.colWidths=[],this.highContrast?this.drawNew():(this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.buildCells())},TableMorph.prototype.openInDialog=function(){new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight).popUp(this.world())},TableMorph.prototype.showListView=function(){var t=this.parentThatIsA(SpriteBubbleMorph,SpeechBubbleMorph,CellMorph);t&&(t instanceof SpriteBubbleMorph?(t.changed(),t.drawNew(!0)):t instanceof SpeechBubbleMorph?(t.contents=new ListWatcherMorph(this.table),t.contents.step=t.contents.update,t.contents.expand(this.extent()),t.drawNew(!0)):(t.drawNew(!0),t.contentsMorph.expand(this.extent())),t.fixLayout())},TableMorph.prototype.show=function(){TableMorph.uber.show.call(this),this.updateScrollBars()},TableFrameMorph.prototype=new Morph,(TableFrameMorph.prototype.constructor=TableFrameMorph).uber=Morph.prototype,TableFrameMorph.prototype.init=function(t,i){this.tableMorph=t,this.handle=null,TableFrameMorph.uber.init.call(this,!0),this.color="transparent",this.noticesTransparentClick=!1,this.bounds=this.tableMorph.bounds.copy(),this.add(this.tableMorph),i||(this.handle=new HandleMorph(this,80,25,null,null)),this.drawNew()},TableFrameMorph.prototype.fixLayout=function(){var t=this.extent();this.tableMorph.extent().eq(t)||(this.tableMorph.setExtent(this.extent()),this.parent&&this.parent.fixLayout&&this.parent.fixLayout())},TableFrameMorph.prototype.setExtent=function(t,i){TableFrameMorph.uber.setExtent.call(this,t,i),this.fixLayout()},TableFrameMorph.prototype.expand=function(t){var i=this.tableMorph.globalExtent();t&&(i=i.min(t)),this.setExtent(i),this.handle.setRight(this.right()),this.handle.setBottom(this.bottom())},TableDialogMorph.prototype=new DialogBoxMorph,(TableDialogMorph.prototype.constructor=TableDialogMorph).uber=DialogBoxMorph.prototype,TableDialogMorph.prototype.init=function(t,i,o,e){this.handle=null,this.data=t,this.tableView=null,TableDialogMorph.uber.init.call(this),this.labelString="Table view",this.createLabel(),this.buildContents(t,i,o,e)},TableDialogMorph.prototype.buildContents=function(t,i,o,e){this.tableView=new TableMorph(t,null,null,null,null,i,o,e,null,null),this.addBody(new TableFrameMorph(this.tableView,!0)),this.addButton("ok","OK")},TableDialogMorph.prototype.setInitialDimensions=function(){var t=this.world().extent().subtract(new Point(this.padding,this.padding)),i=fontHeight(this.titleFontSize)+3*this.titlePadding,o=this.buttons.height();this.setExtent(this.tableView.globalExtent().add(new Point(2*this.padding,2*this.padding+i+o)).min(t).max(new Point(100,100))),this.setCenter(this.world().center())},TableDialogMorph.prototype.popUp=function(t){t&&(TableDialogMorph.uber.popUp.call(this,t),this.setInitialDimensions(),this.handle=new HandleMorph(this,100,100,this.corner,this.corner))},TableDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout;</script>
        <script>var SymbolMorph;function SymbolMorph(t,e,o,r,i){this.init(t,e,o,r,i)}modules.symbols="2019-February-07",SymbolMorph.prototype=new Morph,(SymbolMorph.prototype.constructor=SymbolMorph).uber=Morph.prototype,SymbolMorph.prototype.names=["square","pointRight","stepForward","gears","file","fullScreen","normalScreen","smallStage","normalStage","turtle","stage","turtleOutline","pause","flag","octagon","cloud","cloudOutline","cloudGradient","turnRight","turnLeft","storage","poster","flash","brush","rectangle","rectangleSolid","circle","circleSolid","ellipse","line","cross","crosshairs","paintbucket","eraser","pipette","speechBubble","speechBubbleOutline","loop","turnBack","turnForward","arrowUp","arrowUpOutline","arrowLeft","arrowLeftOutline","arrowDown","arrowDownOutline","arrowRight","arrowRightOutline","robot","magnifyingGlass","magnifierOutline","selection","polygon","closedBrush","notes","camera","location","footprints","keyboard","keyboardFilled","globe"],SymbolMorph.prototype.init=function(t,e,o,r,i){this.isProtectedLabel=!1,this.isReadOnly=!0,this.name=t||"square",this.size=e||(0===e?0:50),this.shadowOffset=r||new Point(0,0),this.shadowColor=i||null,SymbolMorph.uber.init.call(this,!0),this.color=o||new Color(0,0,0),this.drawNew()},SymbolMorph.prototype.setLabelColor=function(t,e,o){this.shadowOffset=o||new Point,this.shadowColor=e,this.setColor(t)},SymbolMorph.prototype.drawNew=function(){var t,e,o,r,i;this.image=newCanvas(new Point(this.symbolWidth()+Math.abs(this.shadowOffset.x),this.size+Math.abs(this.shadowOffset.y))),this.silentSetWidth(this.image.width),this.silentSetHeight(this.image.height),t=this.image.getContext("2d"),r=this.shadowOffset.x<0?0:this.shadowOffset.x,i=this.shadowOffset.y<0?0:this.shadowOffset.y,e=this.shadowOffset.x<0?Math.abs(this.shadowOffset.x):0,o=this.shadowOffset.y<0?Math.abs(this.shadowOffset.y):0,this.shadowColor&&t.drawImage(this.symbolCanvasColored(this.shadowColor),r,i),t.drawImage(this.symbolCanvasColored(this.color),e,o)},SymbolMorph.prototype.symbolCanvasColored=function(t){if(this.name instanceof Costume)return this.name.thumbnail(new Point(this.symbolWidth(),this.size));var e=newCanvas(new Point(this.symbolWidth(),this.size));switch(this.name){case"square":return this.drawSymbolStop(e,t);case"pointRight":return this.drawSymbolPointRight(e,t);case"stepForward":return this.drawSymbolStepForward(e,t);case"gears":return this.drawSymbolGears(e,t);case"file":return this.drawSymbolFile(e,t);case"fullScreen":return this.drawSymbolFullScreen(e,t);case"normalScreen":return this.drawSymbolNormalScreen(e,t);case"smallStage":return this.drawSymbolSmallStage(e,t);case"normalStage":return this.drawSymbolNormalStage(e,t);case"turtle":return this.drawSymbolTurtle(e,t);case"stage":return this.drawSymbolStop(e,t);case"turtleOutline":return this.drawSymbolTurtleOutline(e,t);case"pause":return this.drawSymbolPause(e,t);case"flag":return this.drawSymbolFlag(e,t);case"octagon":return this.drawSymbolOctagon(e,t);case"cloud":return this.drawSymbolCloud(e,t);case"cloudOutline":return this.drawSymbolCloudOutline(e,t);case"cloudGradient":return this.drawSymbolCloudGradient(e,t);case"turnRight":return this.drawSymbolTurnRight(e,t);case"turnLeft":return this.drawSymbolTurnLeft(e,t);case"storage":return this.drawSymbolStorage(e,t);case"poster":return this.drawSymbolPoster(e,t);case"flash":return this.drawSymbolFlash(e,t);case"brush":return this.drawSymbolBrush(e,t);case"rectangle":return this.drawSymbolRectangle(e,t);case"rectangleSolid":return this.drawSymbolRectangleSolid(e,t);case"circle":return this.drawSymbolCircle(e,t);case"circleSolid":return this.drawSymbolCircleSolid(e,t);case"ellipse":return this.drawSymbolCircle(e,t);case"line":return this.drawSymbolLine(e,t);case"cross":return this.drawSymbolCross(e,t);case"crosshairs":return this.drawSymbolCrosshairs(e,t);case"paintbucket":return this.drawSymbolPaintbucket(e,t);case"eraser":return this.drawSymbolEraser(e,t);case"pipette":return this.drawSymbolPipette(e,t);case"speechBubble":return this.drawSymbolSpeechBubble(e,t);case"speechBubbleOutline":return this.drawSymbolSpeechBubbleOutline(e,t);case"loop":return this.drawSymbolLoop(e,t);case"turnBack":return this.drawSymbolTurnBack(e,t);case"turnForward":return this.drawSymbolTurnForward(e,t);case"arrowUp":return this.drawSymbolArrowUp(e,t);case"arrowUpOutline":return this.drawSymbolArrowUpOutline(e,t);case"arrowLeft":return this.drawSymbolArrowLeft(e,t);case"arrowLeftOutline":return this.drawSymbolArrowLeftOutline(e,t);case"arrowDown":return this.drawSymbolArrowDown(e,t);case"arrowDownOutline":return this.drawSymbolArrowDownOutline(e,t);case"arrowRight":return this.drawSymbolArrowRight(e,t);case"arrowRightOutline":return this.drawSymbolArrowRightOutline(e,t);case"robot":return this.drawSymbolRobot(e,t);case"magnifyingGlass":return this.drawSymbolMagnifyingGlass(e,t);case"magnifierOutline":return this.drawSymbolMagnifierOutline(e,t);case"selection":return this.drawSymbolSelection(e,t);case"polygon":return this.drawSymbolOctagonOutline(e,t);case"closedBrush":return this.drawSymbolClosedBrushPath(e,t);case"notes":return this.drawSymbolNotes(e,t);case"camera":return this.drawSymbolCamera(e,t);case"location":return this.drawSymbolLocation(e,t);case"footprints":return this.drawSymbolFootprints(e,t);case"keyboard":return this.drawSymbolKeyboard(e,t);case"keyboardFilled":return this.drawSymbolKeyboardFilled(e,t);case"globe":return this.drawSymbolGlobe(e,t);default:return e}},SymbolMorph.prototype.symbolWidth=function(){var t=this.size;if(this.name instanceof Costume)return t/this.name.height()*this.name.width();switch(this.name){case"pointRight":return Math.sqrt(t*t-Math.pow(t/2,2));case"location":return.6*t;case"flash":case"file":return.8*t;case"smallStage":case"normalStage":return 1.2*t;case"turtle":case"turtleOutline":case"stage":return 1.3*t;case"cloud":case"cloudGradient":case"cloudOutline":case"turnBack":case"turnForward":case"keyboard":case"keyboardFilled":return 1.6*t;case"turnRight":case"turnLeft":return t/3*2;case"loop":return 2*t;default:return t}},SymbolMorph.prototype.drawSymbolStop=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.fillRect(0,0,t.width,t.height),t},SymbolMorph.prototype.drawSymbolPointRight=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(t.width,Math.round(t.height/2)),o.lineTo(0,t.height),o.lineTo(0,0),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolStepForward=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(.75*t.width,Math.round(t.height/2)),o.lineTo(0,t.height),o.lineTo(0,0),o.closePath(),o.fill(),o.fillRect(.75*t.width,0,.25*t.width,t.height),t},SymbolMorph.prototype.drawSymbolGears=function(t,e){var o=t.getContext("2d"),r=t.width,i=r/2,a=r/6;return o.strokeStyle=e.toString(),o.lineWidth=t.width/7,o.beginPath(),o.arc(i,i,r,radians(0),radians(360),!0),o.arc(i,i,1.5*a,radians(0),radians(360),!1),o.closePath(),o.clip(),o.moveTo(0,i),o.lineTo(r,i),o.stroke(),o.moveTo(i,0),o.lineTo(i,r),o.stroke(),o.moveTo(a,a),o.lineTo(r-a,r-a),o.stroke(),o.moveTo(r-a,a),o.lineTo(a,r-a),o.stroke(),t},SymbolMorph.prototype.drawSymbolFile=function(t,e){var o=t.getContext("2d"),r=Math.min(t.width,t.height)/2;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(r,0),o.lineTo(r,r),o.lineTo(t.width,r),o.lineTo(t.width,t.height),o.lineTo(0,t.height),o.closePath(),o.fill(),o.fillStyle=e.darker(25).toString(),o.beginPath(),o.moveTo(r,0),o.lineTo(t.width,r),o.lineTo(r,r),o.lineTo(r,0),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolFullScreen=function(t,e){var o=t.getContext("2d"),r=t.height,i=t.width/2,a=t.width/20,l=t.width/2;return o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(i-a,i+a),o.lineTo(0,r),o.stroke(),o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(i+a,i-a),o.lineTo(r,0),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,r),o.lineTo(0,r-l),o.lineTo(l,r),o.closePath(),o.fill(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(r,0),o.lineTo(r-l,0),o.lineTo(r,l),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolNormalScreen=function(t,e){var o=t.getContext("2d"),r=t.height,i=t.width/2,a=t.width/20,l=t.width;return o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(i-3*a,i+3*a),o.lineTo(0,r),o.stroke(),o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(i+3*a,i-3*a),o.lineTo(r,0),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(i+a,i-a),o.lineTo(l,i-a),o.lineTo(i+a,0),o.closePath(),o.fill(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(i-a,i+a),o.lineTo(0,i+a),o.lineTo(i-a,l),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolSmallStage=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=r/2,l=i/2;return o.fillStyle=e.darker(40).toString(),o.fillRect(0,0,r,i),o.fillStyle=e.toString(),o.fillRect(a,0,a,l),t},SymbolMorph.prototype.drawSymbolNormalStage=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=r/2,l=i/2;return o.fillStyle=e.toString(),o.fillRect(0,0,r,i),o.fillStyle=e.darker(25).toString(),o.fillRect(a,0,a,l),t},SymbolMorph.prototype.drawSymbolTurtle=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(t.width,t.height/2),o.lineTo(0,t.height),o.lineTo(t.height/2,t.height/2),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolTurtleOutline=function(t,e){var o=t.getContext("2d");return o.strokeStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(t.width,t.height/2),o.lineTo(0,t.height),o.lineTo(t.height/2,t.height/2),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolPause=function(t,e){var o=t.getContext("2d"),r=t.width/5;return o.fillStyle=e.toString(),o.fillRect(0,0,2*r,t.height),o.fillRect(3*r,0,2*r,t.height),t},SymbolMorph.prototype.drawSymbolFlag=function(t,e){var o=t.getContext("2d"),r=t.width,i=Math.max(r/12,1),a=t.height;return o.lineWidth=i,o.strokeStyle=e.toString(),o.beginPath(),o.moveTo(i/2,0),o.lineTo(i/2,t.height),o.stroke(),o.lineWidth=a/2,o.beginPath(),o.moveTo(0,a/4),o.bezierCurveTo(.8*r,a/4,.1*r,.5*a,r,.5*a),o.stroke(),t},SymbolMorph.prototype.drawSymbolOctagon=function(t,e){var o=t.getContext("2d"),r=t.width,i=(r-.383*r)/2;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(i,0),o.lineTo(r-i,0),o.lineTo(r,i),o.lineTo(r,r-i),o.lineTo(r-i,r),o.lineTo(i,r),o.lineTo(0,r-i),o.lineTo(0,i),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolCloud=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=2*i/5,l=i/4,n=3*i/10,h=i/5;return o.fillStyle=e.toString(),o.beginPath(),o.arc(l,i-l,l,radians(90),radians(259),!1),o.arc(r/20*5,i/9*4,h,radians(165),radians(300),!1),o.arc(r/20*11,a,a,radians(200),radians(357),!1),o.arc(r-n,i-n,n,radians(269),radians(90),!1),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolCloudGradient=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=2*i/5,l=i/4,n=3*i/10,h=i/5,s=o.createRadialGradient(0,0,0,0,0,r);return s.addColorStop(0,e.lighter(25).toString()),s.addColorStop(1,e.darker(25).toString()),o.fillStyle=s,o.beginPath(),o.arc(l,i-l,l,radians(90),radians(259),!1),o.arc(r/20*5,i/9*4,h,radians(165),radians(300),!1),o.arc(r/20*11,a,a,radians(200),radians(357),!1),o.arc(r-n,i-n,n,radians(269),radians(90),!1),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolCloudOutline=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=2*i/5,l=i/4,n=3*i/10,h=i/5;return o.strokeStyle=e.toString(),o.beginPath(),o.arc(1+l,i-l-1,l,radians(90),radians(259),!1),o.arc(r/20*5,i/9*4,h,radians(165),radians(300),!1),o.arc(r/20*11,1+a,a,radians(200),radians(357),!1),o.arc(r-n-1,i-n-1,n,radians(269),radians(90),!1),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolTurnRight=function(t,e){var o=t.getContext("2d"),r=t.width,i=Math.max(r/10,1),a=r/2;return o.lineWidth=i,o.strokeStyle=e.toString(),o.beginPath(),o.arc(a,2*a,a-i/2,radians(0),radians(-90),!1),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(r,a),o.lineTo(a,0),o.lineTo(a,2*a),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolTurnLeft=function(t,e){var o=t.getContext("2d"),r=t.width,i=Math.max(r/10,1),a=r/2;return o.lineWidth=i,o.strokeStyle=e.toString(),o.beginPath(),o.arc(a,2*a,a-i/2,radians(180),radians(-90),!0),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,a),o.lineTo(a,0),o.lineTo(a,2*a),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolStorage=function(t,o){var r=t.getContext("2d"),i=t.width,a=t.height,l=t.height,n=t.height/11;function e(t,e){r.fillStyle=o.toString(),r.beginPath(),r.arc(i/2,t-a,l,radians(60),radians(120),!1),r.lineTo(0,t-2*n),r.arc(i/2,t-a-2*n,l,radians(120),radians(60),!0),r.closePath(),r.fill(),r.fillStyle=o.darker(25).toString(),r.beginPath(),e&&r.arc(i/2,t-a-2*n,l,radians(120),radians(60),!0),r.arc(i/2,t+6*n+1,l,radians(60),radians(120),!0),r.closePath(),e?r.fill():r.stroke()}return r.strokeStyle=o.toString(),e(a),e(a-3*n),e(a-6*n,!1),t},SymbolMorph.prototype.drawSymbolPoster=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=.75*i,l=t.height/5;return o.fillStyle=e.toString(),o.strokeStyle=e.toString(),o.lineWidth=r/15,o.moveTo(r/2,i/3),o.lineTo(r/6,i),o.stroke(),o.moveTo(r/2,i/3),o.lineTo(r/2,i),o.stroke(),o.moveTo(r/2,i/3),o.lineTo(5*r/6,i),o.stroke(),o.fillRect(0,0,r,a),o.clearRect(0,a,r,r/20),o.clearRect(r-l,a-l,1+l,1+l),o.fillStyle=e.darker(25).toString(),o.beginPath(),o.moveTo(r,a-l),o.lineTo(r-l,a-l),o.lineTo(r-l,a),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolFlash=function(t,e){var o=t.getContext("2d"),r=t.width,i=r/3,a=t.height,l=a/3,n=l/3;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(i,0),o.lineTo(0,l),o.lineTo(i,l),o.lineTo(0,2*l),o.lineTo(i,2*l),o.lineTo(0,a),o.lineTo(r,2*l-n),o.lineTo(2*i,2*l-n),o.lineTo(r,l-n),o.lineTo(2*i,l-n),o.lineTo(r,0),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolBrush=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=Math.max(r/30,.5);return o.fillStyle=e.toString(),o.lineWidth=2*a,o.beginPath(),o.moveTo(r/8*3,i/2),o.quadraticCurveTo(0,i/2,a,i-a),o.quadraticCurveTo(r/2,i,r/2,i/8*5),o.closePath(),o.fill(),o.lineJoin="round",o.lineCap="round",o.strokeStyle=e.toString(),o.moveTo(r/8*3,i/2),o.lineTo(.75*r,a),o.quadraticCurveTo(r,0,r-a,.25*i),o.stroke(),o.moveTo(r/2,i/8*5),o.lineTo(r-a,.25*i),o.stroke(),t},SymbolMorph.prototype.drawSymbolRectangle=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.width,a=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*a,o.beginPath(),o.moveTo(a,a),o.lineTo(r-a,a),o.lineTo(r-a,i-a),o.lineTo(a,i-a),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolRectangleSolid=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.width;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(r,0),o.lineTo(r,i),o.lineTo(0,i),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolCircle=function(t,e){var o=t.getContext("2d"),r=t.width,i=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*i,o.arc(r/2,r/2,r/2-i,radians(0),radians(360),!1),o.stroke(),t},SymbolMorph.prototype.drawSymbolCircleSolid=function(t,e){var o=t.getContext("2d"),r=t.width;return o.fillStyle=e.toString(),o.arc(r/2,r/2,r/2,radians(0),radians(360),!1),o.fill(),t},SymbolMorph.prototype.drawSymbolLine=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*a,o.lineCap="round",o.moveTo(a,a),o.lineTo(r-a,i-a),o.stroke(),t},SymbolMorph.prototype.drawSymbolCross=function(t,e){var o=t.getContext("2d"),r=t.width,i=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*i,o.lineCap="round",o.moveTo(i,r/2),o.lineTo(r-i,r/2),o.stroke(),o.moveTo(r/2,i),o.lineTo(r/2,r-i),o.stroke(),t},SymbolMorph.prototype.drawSymbolCrosshairs=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height;return o.strokeStyle=e.toString(),o.lineWidth=1,o.moveTo(.5,i/2),o.lineTo(r-.5,i/2),o.stroke(),o.moveTo(r/2,.5),o.lineTo(r/2,i-.5),o.stroke(),o.moveTo(r/2,i/2),o.arc(r/2,r/2,r/3-.5,radians(0),radians(360),!1),o.stroke(),t},SymbolMorph.prototype.drawSymbolPaintbucket=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=t.width/5,l=Math.max(r/30,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*l,o.beginPath(),o.moveTo(2*a,a),o.lineTo(4*a,3*a),o.lineTo(3*a,4*a),o.quadraticCurveTo(2*a,i,a,4*a),o.quadraticCurveTo(0,3*a,a,2*a),o.closePath(),o.stroke(),o.lineWidth=l,o.moveTo(2*a,2.5*a),o.arc(2*a,2.5*a,l,radians(0),radians(360),!1),o.stroke(),o.moveTo(2*a,2.5*a),o.lineTo(2*a,a/2+l),o.stroke(),o.arc(1.5*a,a/2+l,a/2,radians(0),radians(180),!0),o.stroke(),o.moveTo(a,a/2+l),o.lineTo(a,2*a),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(3.5*a,3.5*a),o.quadraticCurveTo(r,3.5*a,r-l,i),o.lineTo(r,i),o.quadraticCurveTo(r,2*a,2.5*a,1.5*a),o.lineTo(4*a,3*a),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolEraser=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=t.width/4,l=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*l,o.beginPath(),o.moveTo(3*a,l),o.lineTo(l,3*a),o.quadraticCurveTo(a,i,2*a,3*a),o.lineTo(r-l,a),o.closePath(),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(3*a,0),o.lineTo(1.5*a,1.5*a),o.lineTo(2.5*a,2.5*a),o.lineTo(r,a),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolPipette=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=t.width/4,l=a/2,n=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*n,o.beginPath(),o.moveTo(n,i-n),o.quadraticCurveTo(l,i-l,l,i-a),o.lineTo(2*a,1.5*a),o.stroke(),o.beginPath(),o.moveTo(n,i-n),o.quadraticCurveTo(l,i-l,a,i-l),o.lineTo(2.5*a,2*a),o.stroke(),o.fillStyle=e.toString(),o.arc(3*a,a,a-n,radians(0),radians(360),!1),o.fill(),o.beginPath(),o.moveTo(2*a,a),o.lineTo(3*a,2*a),o.stroke(),t},SymbolMorph.prototype.drawSymbolSpeechBubble=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=t.width/3,l=Math.max(r/20,.5);return o.fillStyle=e.toString(),o.lineWidth=2*l,o.beginPath(),o.moveTo(a,2*a),o.quadraticCurveTo(l,2*a,l,a),o.quadraticCurveTo(l,l,a,l),o.lineTo(2*a,l),o.quadraticCurveTo(r-l,l,r-l,a),o.quadraticCurveTo(r-l,2*a,2*a,2*a),o.lineTo(a/2,i-l),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolSpeechBubbleOutline=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=t.width/3,l=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*l,o.beginPath(),o.moveTo(a,2*a),o.quadraticCurveTo(l,2*a,l,a),o.quadraticCurveTo(l,l,a,l),o.lineTo(2*a,l),o.quadraticCurveTo(r-l,l,r-l,a),o.quadraticCurveTo(r-l,2*a,2*a,2*a),o.lineTo(a/2,i-l),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolLoop=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=t.width/2,l=a/2,n=t.height/2,h=Math.max(i/10,.5);return o.lineWidth=2*h,o.strokeStyle=e.toString(),o.beginPath(),o.moveTo(0,i-h),o.lineTo(a,i-h),o.arc(a,n,n-h,radians(90),radians(0),!0),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(3*l-h,0),o.lineTo(a-h,n),o.lineTo(r,n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolTurnBack=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=t.width/2,l=t.height/2,n=Math.max(r/20,.5);return o.fillStyle=e.toString(),o.lineWidth=2*n,o.beginPath(),o.moveTo(0,l),o.lineTo(a,0),o.lineTo(a,i),o.closePath(),o.fill(),o.lineWidth=3*n,o.strokeStyle=e.toString(),o.beginPath(),o.arc(a,i,l,radians(0),radians(-90),!0),o.stroke(),t},SymbolMorph.prototype.drawSymbolTurnForward=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=t.width/2,l=t.height/2,n=Math.max(r/20,.5);return o.fillStyle=e.toString(),o.lineWidth=2*n,o.beginPath(),o.moveTo(r,l),o.lineTo(a,0),o.lineTo(a,i),o.closePath(),o.fill(),o.lineWidth=3*n,o.strokeStyle=e.toString(),o.beginPath(),o.arc(a,i,l,radians(-180),radians(-90),!1),o.stroke(),t},SymbolMorph.prototype.drawSymbolArrowUp=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=t.width/2,l=Math.max(r/20,.5);return o.fillStyle=e.toString(),o.lineWidth=2*l,o.beginPath(),o.moveTo(l,a),o.lineTo(a,l),o.lineTo(r-l,a),o.lineTo(.65*r,a),o.lineTo(.65*r,i-l),o.lineTo(.35*r,i-l),o.lineTo(.35*r,a),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolArrowUpOutline=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=t.width/2,l=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*l,o.beginPath(),o.moveTo(l,a),o.lineTo(a,l),o.lineTo(r-l,a),o.lineTo(.65*r,a),o.lineTo(.65*r,i-l),o.lineTo(.35*r,i-l),o.lineTo(.35*r,a),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolArrowDown=function(t,e){var o=t.getContext("2d"),r=t.width;return o.save(),o.translate(r,r),o.rotate(radians(180)),this.drawSymbolArrowUp(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowDownOutline=function(t,e){var o=t.getContext("2d"),r=t.width;return o.save(),o.translate(r,r),o.rotate(radians(180)),this.drawSymbolArrowUpOutline(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowLeft=function(t,e){var o=t.getContext("2d"),r=t.width;return o.save(),o.translate(0,r),o.rotate(radians(-90)),this.drawSymbolArrowUp(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowLeftOutline=function(t,e){var o=t.getContext("2d"),r=t.width;return o.save(),o.translate(0,r),o.rotate(radians(-90)),this.drawSymbolArrowUpOutline(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowRight=function(t,e){var o=t.getContext("2d"),r=t.width;return o.save(),o.translate(r,0),o.rotate(radians(90)),this.drawSymbolArrowUp(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowRightOutline=function(t,e){var o=t.getContext("2d"),r=t.width;return o.save(),o.translate(r,0),o.rotate(radians(90)),this.drawSymbolArrowUpOutline(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolRobot=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=t.width/6,l=a/2,n=Math.max(r/20,.5);return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(a+n,a),o.lineTo(2*a,a),o.lineTo(2.5*a,1.5*a),o.lineTo(3.5*a,1.5*a),o.lineTo(4*a,a),o.lineTo(5*a-n,a),o.lineTo(4*a,3*a),o.lineTo(4*a,4*a-n),o.lineTo(2*a,4*a-n),o.lineTo(2*a,3*a),o.closePath(),o.fill(),o.beginPath(),o.moveTo(2.75*a,a+n),o.lineTo(2.4*a,a),o.lineTo(2.2*a,0),o.lineTo(3.8*a,0),o.lineTo(3.6*a,a),o.lineTo(3.25*a,a+n),o.closePath(),o.fill(),o.beginPath(),o.moveTo(2.5*a,4*a),o.lineTo(a,4*a),o.lineTo(l+n,i),o.lineTo(2*a,i),o.closePath(),o.fill(),o.beginPath(),o.moveTo(3.5*a,4*a),o.lineTo(5*a,4*a),o.lineTo(r-(l+n),i),o.lineTo(4*a,i),o.closePath(),o.fill(),o.beginPath(),o.moveTo(a,a),o.lineTo(n,1.5*a),o.lineTo(n,3.25*a),o.lineTo(1.5*a,3.5*a),o.closePath(),o.fill(),o.beginPath(),o.moveTo(5*a,a),o.lineTo(r-n,1.5*a),o.lineTo(r-n,3.25*a),o.lineTo(4.5*a,3.5*a),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolMagnifyingGlass=function(t,e){var o,r=t.getContext("2d"),i=t.width,a=t.height,l=.3*i,n=2*i/3-Math.sqrt(l),h=a/3+Math.sqrt(l),s=Math.max(i/5,.5);return r.strokeStyle=e.toString(),(o=r.createRadialGradient(n,h,0,n+l,h+l,i)).addColorStop(0,e.inverted().lighter(50).toString()),o.addColorStop(1,e.inverted().darker(25).toString()),r.fillStyle=o,r.arc(n,h,l,radians(0),radians(360),!1),r.fill(),r.lineWidth=s/2,r.arc(n,h,l,radians(0),radians(360),!1),r.stroke(),r.lineWidth=s,r.beginPath(),r.moveTo(s/2,a-s/2),r.lineTo(n-Math.sqrt(l+s),h+Math.sqrt(l+s)),r.closePath(),r.stroke(),t},SymbolMorph.prototype.drawSymbolMagnifierOutline=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=.3*r,l=2*r/3-Math.sqrt(a),n=i/3+Math.sqrt(a),h=Math.max(r/5,.5);return o.strokeStyle=e.toString(),o.lineWidth=.5*h,o.arc(l,n,a,radians(0),radians(360),!1),o.stroke(),o.lineWidth=h,o.beginPath(),o.moveTo(h/2,i-h/2),o.lineTo(l-Math.sqrt(a+h),n+Math.sqrt(a+h)),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolSelection=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height;return o.save(),o.setLineDash([3]),this.drawSymbolRectangle(t,e),o.restore(),o.save(),o.fillStyle=e.toString(),o.translate(.7*r,.4*i),o.scale(.5,.5),o.rotate(radians(135)),this.drawSymbolArrowDownOutline(t,e),o.fill(),o.restore(),t},SymbolMorph.prototype.drawSymbolOctagonOutline=function(t,e){var o=t.getContext("2d"),r=t.width,i=(r-.383*r)/2,a=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*a,o.beginPath(),o.moveTo(i,a),o.lineTo(r-i,a),o.lineTo(r-a,i),o.lineTo(r-a,r-i),o.lineTo(r-i,r-a),o.lineTo(i,r-a),o.lineTo(a,r-i),o.lineTo(a,i),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolClosedBrushPath=SymbolMorph.prototype.drawSymbolCloudOutline,SymbolMorph.prototype.drawSymbolNotes=function(t,e){var o=t.getContext("2d"),r=t.width,i=r/6,a=Math.max(i/3,1);return o.strokeStyle=e.toString(),o.fillStyle=e.toString(),o.arc(i,r-i,i,radians(0),radians(360),!1),o.fill(),o.arc(r-i,r-2*i,i,radians(0),radians(360),!1),o.fill(),o.beginPath(),o.moveTo(2*i-a,i),o.lineTo(r,0),o.lineTo(r,i),o.lineTo(2*i-a,2*i),o.closePath(),o.fill(),o.lineWidth=a,o.beginPath(),o.moveTo(2*i-a/2,r-i),o.lineTo(2*i-a/2,i+a),o.stroke(),o.beginPath(),o.moveTo(r-a/2,r-2*i),o.lineTo(r-a/2,a),o.stroke(),t},SymbolMorph.prototype.drawSymbolCamera=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.width,a=.16*r,l=Math.max(r/20,.5);return o.lineWidth=2*l,o.fillStyle=e.toString(),o.beginPath(),o.moveTo(l,5*i/6),o.lineTo(r-l,5*i/6),o.lineTo(r-l,i/4),o.lineTo(3*r/4,i/4),o.lineTo(5*r/8,l),o.lineTo(3*r/8,l),o.lineTo(r/4,i/4),o.lineTo(l,i/4),o.closePath(),o.fill(),o.save(),o.globalCompositeOperation="destination-out",o.beginPath(),o.arc(r/2,i/2,a,radians(0),radians(360),!1),o.fill(),o.restore(),t},SymbolMorph.prototype.drawSymbolLocation=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,a=r/2;return o.fillStyle=e.toString(),o.beginPath(),o.arc(a,a,a,radians(-210),radians(30),!1),o.lineTo(a,i),o.closePath(),o.fill(),o.globalCompositeOperation="destination-out",o.beginPath(),o.arc(a,a,.5*a,radians(0),radians(360),!1),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolFootprints=function(t,e){var o=t.getContext("2d"),r=t.width,i=r/10,a=1.5*i;return o.fillStyle=e.toString(),o.beginPath(),o.arc(a,a,a,radians(-200),radians(0),!1),o.lineTo(2*a,5.5*i),o.lineTo(i,6*i),o.closePath(),o.fill(),o.beginPath(),o.arc(2.25*i,6.75*i,i,radians(-40),radians(-170),!1),o.closePath(),o.fill(),o.beginPath(),o.arc(r-a,4.5*i,a,radians(-180),radians(20),!1),o.lineTo(r-i,8.5*i),o.lineTo(r-2*a,8*i),o.closePath(),o.fill(),o.beginPath(),o.arc(r-2.25*i,9*i,i,radians(0),radians(-150),!1),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolKeyboard=function(t,e){var o,r,i=t.getContext("2d"),a=t.height,l=a/10,n=a/5;for(i.fillStyle=e.toString(),o=0;o<2;o+=1)for(r=0;r<5;r+=1)i.fillRect((l+n)*r+l,(l+n)*o+l,n,n);return i.fillRect(4*l,7*l,4*n,n),t},SymbolMorph.prototype.drawSymbolKeyboardFilled=function(t,e){var o,r,i=t.getContext("2d"),a=t.width,l=t.height,n=l/10,h=l/5;for(i.fillStyle=e.toString(),i.fillRect(0,0,a,l),i.globalCompositeOperation="destination-out",o=0;o<2;o+=1)for(r=0;r<5;r+=1)i.fillRect((n+h)*r+n,(n+h)*o+n,h,h);return i.fillRect(4*n,7*n,4*h,h),t},SymbolMorph.prototype.drawSymbolGlobe=function(t,e){var o=t.getContext("2d"),r=t.width,i=Math.max(r/30,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*i,o.arc(r/2,r/2,r/2-i,radians(0),radians(360),!1),o.stroke(),o.moveTo(i,r/2),o.lineTo(r-i,r/2),o.stroke(),o.moveTo(r/2,0),o.arcTo(0,r/2,r/2,r,.75*r),o.stroke(),o.moveTo(r/2,0),o.arcTo(r,r/2,r/2,r,.75*r),o.stroke(),t};</script>
        <script>var VectorShape,VectorRectangle,VectorLine,VectorEllipse,VectorPolygon,VectorSelection,VectorPaintEditorMorph,VectorPaintCanvasMorph;function VectorShape(t,e,i){this.init(t,e,i)}function VectorRectangle(t,e,i,o,r){VectorRectangle.uber.init.call(this,t,e,i),this.init(o,r)}function VectorLine(t,e,i,o){VectorLine.uber.init.call(this,t,e),this.init(i,o)}function VectorEllipse(t,e,i,o,r){VectorEllipse.uber.init.call(this,t,e,i),this.init(o,r)}function VectorPolygon(t,e,i,o,r,n){VectorPolygon.uber.init.call(this,t,e,i),this.init(o,r,n)}function VectorSelection(t,e){VectorRectangle.uber.init.call(this,1,new Color(0,0,0,255),null),this.init(t,e)}function Crosshair(t,e){this.init(t,e)}function VectorPaintEditorMorph(){this.init()}function VectorPaintCanvasMorph(t){this.init(t)}modules.sketch="2019-February-22",VectorShape.prototype={},(VectorShape.prototype.constructor=VectorShape).uber=Object.prototype,VectorShape.prototype.init=function(t,e,i){this.borderWidth=e&&e.a?t:0,this.borderColor=e||new Color(0,0,0,0),this.fillColor=i||new Color(0,0,0,0),this.image=newCanvas(),this.isPolygon=!1,this.isSelection=!1,this.isCrosshair=!1,this.origin=new Point,this.destination=new Point},VectorShape.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])},VectorShape.prototype.asSVG=function(t){var e=new XML_Element(t);return this.borderColor&&this.borderColor.a?(e.attributes.stroke=this.borderColor.toRGBstring(),e.attributes["stroke-linejoin"]="miter",e.attributes["stroke-width"]=this.borderWidth):e.attributes.stroke="none",this.fillColor&&this.fillColor.a?e.attributes.fill=this.fillColor.toRGBstring():e.attributes.fill="none",e.attributes.prototype=this.constructor.name,e},VectorShape.prototype.imageURL=function(){var t=new XML_Element("svg"),e=this.bounds();return t.attributes.xmlns="http://www.w3.org/2000/svg",t.attributes.version="1.1",t.attributes.preserveAspectRatio="xMinYMin meet",t.attributes.viewBox=e.left()+" "+e.top()+" "+(e.right()-e.left())+" "+(e.bottom()-e.top()),t.attributes.width=e.right()-e.left(),t.attributes.height=e.bottom()-e.top(),t.children=[this.asSVG()],"data:image/svg+xml;base64,"+t},VectorShape.prototype.copy=function(t){var e=t||new VectorShape(this.borderWidth,this.borderColor,this.fillColor);return e.image.width=this.image.width,e.image.height=this.image.height,e.image.getContext("2d").drawImage(this.image,0,0),e},VectorShape.prototype.bounds=function(){return new Rectangle(Math.min(this.origin.x,this.destination.x)-this.borderWidth/2,Math.min(this.origin.y,this.destination.y)-this.borderWidth/2,Math.max(this.origin.x,this.destination.x)+this.borderWidth/2,Math.max(this.origin.y,this.destination.y)+this.borderWidth/2)},VectorShape.prototype.containsPoint=function(t){return this.bounds().containsPoint(t)},VectorShape.prototype.update=function(t,e){this.destination=e?this.constraintPoint(t):t},VectorShape.prototype.constraintPoint=function(t){var e=t.subtract(this.origin),i=new Point(Math.max(Math.abs(e.x),Math.abs(e.y))*(e.x/Math.abs(e.x)),Math.max(Math.abs(e.x),Math.abs(e.y))*(e.y/Math.abs(e.y)));return this.origin.add(i)},VectorShape.prototype.setColor=function(t,e){e?this.borderColor=t:this.fillColor=t},VectorShape.prototype.setBorderWidth=function(t){this.borderColor&&this.borderColor.a&&(this.borderWidth=t)},VectorShape.prototype.moveBy=function(t){this.origin=this.origin.add(t),this.destination=this.destination.add(t)},VectorShape.prototype.resizeBy=function(t,e){this.origin=this.origin.subtract(e).multiplyBy(t).add(e),this.destination=this.destination.subtract(e).multiplyBy(t).add(e)},VectorShape.prototype.drawOn=function(t){var e=this,i=this.bounds().origin.subtract(t.position()),o=new Image;this.image=newCanvas(t.extent()),o.onload=function(){e.image.getContext("2d").drawImage(o,i.x,i.y),t.redraw=!0},o.src=this.imageURL()},VectorRectangle.prototype=new VectorShape,(VectorRectangle.prototype.constructor=VectorRectangle).uber=VectorShape.prototype,VectorRectangle.prototype.init=function(t,e){this.origin=t,this.destination=e},VectorRectangle.fromSVG=function(t){var e=t.attributes;return new VectorRectangle(parseInt(e["stroke-width"]),"none"===e.stroke?null:Color.fromString(e.stroke),"none"===e.fill?null:Color.fromString(e.fill),new Point(parseInt(e.x),parseInt(e.y)),new Point(parseInt(e.x)+parseInt(e.width),parseInt(e.y)+parseInt(e.height)))},VectorRectangle.prototype.copy=function(){var t=new VectorRectangle(this.borderWidth,this.borderColor,this.fillColor,this.origin.copy(),this.destination.copy());return VectorRectangle.uber.copy.call(this,t)},VectorRectangle.prototype.toString=function(){return VectorRectangle.uber.toString.call(this)+this.bounds().toString()},VectorRectangle.prototype.width=function(){return Math.abs(this.origin.x-this.destination.x)},VectorRectangle.prototype.height=function(){return Math.abs(this.origin.y-this.destination.y)},VectorRectangle.prototype.x=function(){return Math.min(this.origin.x,this.destination.x)},VectorRectangle.prototype.y=function(){return Math.min(this.origin.y,this.destination.y)},VectorRectangle.prototype.asSVG=function(){var t=VectorRectangle.uber.asSVG.call(this,"rect");return t.attributes.width=this.width(),t.attributes.height=this.height(),t.attributes.x=this.x(),t.attributes.y=this.y(),t},VectorRectangle.prototype.drawOn=function(t){var e,i=t.position();this.image=newCanvas(t.extent()),(e=this.image.getContext("2d")).beginPath(),e.rect(this.x()-i.x,this.y()-i.y,this.width(),this.height()),0<this.fillColor.a&&(e.fillStyle=this.fillColor.toRGBstring(),e.fill()),0<this.borderColor.a&&(e.lineWidth=this.borderWidth,e.strokeStyle=this.borderColor.toRGBstring(),e.stroke()),t.redraw=!0},VectorLine.prototype=new VectorShape,(VectorLine.prototype.constructor=VectorLine).uber=VectorShape.prototype,VectorLine.prototype.init=function(t,e){this.origin=t,this.destination=e},VectorLine.fromSVG=function(t){var e=t.attributes;return new VectorLine(parseInt(e["stroke-width"]),Color.fromString(e.stroke),new Point(parseInt(e.x1),parseInt(e.y1)),new Point(parseInt(e.x2),parseInt(e.y2)))},VectorLine.prototype.copy=function(){var t=new VectorLine(this.borderWidth,this.borderColor.copy(),this.origin.copy(),this.destination.copy());return VectorLine.uber.copy.call(this,t)},VectorLine.prototype.containsPoint=function(t){var e=this.origin.distanceTo(this.destination),i=t.distanceTo(this.origin)+t.distanceTo(this.destination);return Math.abs(e-i)<=Math.sqrt(this.borderWidth/2)/2},VectorLine.prototype.constraintPoint=function(t){var e=t,i=e.subtract(this.origin).abs().degrees();return i<22.5?e.y=this.origin.y:67.5<i?e.x=this.origin.x:e=VectorLine.uber.constraintPoint.call(this,t),e},VectorLine.prototype.setColor=function(t,e){VectorLine.uber.setColor.call(this,t,!e)},VectorLine.prototype.toString=function(){return VectorLine.uber.toString.call(this)+this.bounds().toString()},VectorLine.prototype.asSVG=function(){var t=VectorLine.uber.asSVG.call(this,"line");return t.attributes.x1=this.origin.x,t.attributes.y1=this.origin.y,t.attributes.x2=this.destination.x,t.attributes.y2=this.destination.y,t},VectorLine.prototype.drawOn=function(t){var e,i=this.origin.subtract(t.position()),o=this.destination.subtract(t.position());this.image=newCanvas(t.extent()),(e=this.image.getContext("2d")).beginPath(),0<this.borderColor.a&&(e.lineWidth=this.borderWidth,e.strokeStyle=this.borderColor.toRGBstring(),e.moveTo(i.x,i.y),e.lineTo(o.x,o.y),e.stroke()),t.redraw=!0},VectorEllipse.prototype=new VectorShape,(VectorEllipse.prototype.constructor=VectorEllipse).uber=VectorShape.prototype,VectorEllipse.prototype.init=function(t,e){this.origin=t,this.destination=e},VectorEllipse.fromSVG=function(t){var e=t.attributes;return new VectorEllipse(parseInt(e["stroke-width"]),"none"===e.stroke?null:Color.fromString(e.stroke),"none"===e.fill?null:Color.fromString(e.fill),new Point(parseInt(e.cx),parseInt(e.cy)),new Point(parseInt(e.cx)+parseInt(e.rx),parseInt(e.cy)+parseInt(e.ry)))},VectorEllipse.prototype.copy=function(){var t=new VectorEllipse(this.borderWidth,this.borderColor,this.fillColor,this.origin.copy(),this.destination.copy());return VectorEllipse.uber.copy.call(this,t)},VectorEllipse.prototype.hRadius=function(){return Math.abs(this.destination.x-this.origin.x)},VectorEllipse.prototype.vRadius=function(){return Math.abs(this.destination.y-this.origin.y)},VectorEllipse.prototype.toString=function(){return VectorEllipse.uber.toString.call(this)+" center: "+this.origin.toString()+" radii: "+this.hRadius().toString()+","+this.vRadius().toString()},VectorEllipse.prototype.bounds=function(){var t=this.hRadius(),e=this.vRadius();return new Rectangle(this.origin.x-t-this.borderWidth/2,this.origin.y-e-this.borderWidth/2,this.origin.x+t+this.borderWidth/2,this.origin.y+e+this.borderWidth/2)},VectorEllipse.prototype.containsPoint=function(t){return Math.pow(t.x-this.origin.x,2)/Math.pow(this.hRadius()+this.borderWidth/2,2)+Math.pow(t.y-this.origin.y,2)/Math.pow(this.vRadius()+this.borderWidth/2,2)<1},VectorEllipse.prototype.asSVG=function(){var t=VectorEllipse.uber.asSVG.call(this,"ellipse");return t.attributes.cx=this.origin.x,t.attributes.cy=this.origin.y,t.attributes.rx=this.hRadius(),t.attributes.ry=this.vRadius(),t},VectorEllipse.prototype.drawOn=function(t){var e,i=t.position();this.image=newCanvas(t.extent()),(e=this.image.getContext("2d")).beginPath(),e.ellipse(this.origin.x-i.x,this.origin.y-i.y,this.hRadius(),this.vRadius(),0,0,2*Math.PI,!0),this.fillColor&&0<this.fillColor.a&&(e.fillStyle=this.fillColor.toRGBstring(),e.fill()),0<this.borderColor.a&&(e.lineWidth=this.borderWidth,e.strokeStyle=this.borderColor.toRGBstring(),e.stroke()),t.redraw=!0},VectorPolygon.prototype=new VectorShape,(VectorPolygon.prototype.constructor=VectorPolygon).uber=VectorShape.prototype,VectorPolygon.prototype.init=function(t,e,i){this.points=t||[],this.isClosed=e,this.isFreeHand=i,this.isPolygon=!0},VectorPolygon.fromSVG=function(t){var e=t.attributes,i=e.d.slice(1).split(/L */).map(function(t){var e=t.split(" ");return new Point(parseInt(e[0]),parseInt(e[1]))});return new VectorPolygon(parseInt(e["stroke-width"]),"none"===e.stroke?null:Color.fromString(e.stroke),"none"===e.fill?null:Color.fromString(e.fill),i,i[0].eq(i[i.length-1]),!1)},VectorPolygon.prototype.copy=function(){var t=new VectorPolygon(this.borderWidth,this.borderColor,this.fillColor,this.points.map(function(t){return t.copy()}),this.isClosed,this.isFreeHand);return VectorPolygon.uber.copy.call(this,t)},VectorPolygon.prototype.toString=function(){return VectorPolygon.uber.toString.call(this)+this.points},VectorPolygon.prototype.bounds=function(){var e=this.points[0].x,i=this.points[0].y,o=this.points[this.points.length-1].x,r=this.points[this.points.length-1].y;return this.points.forEach(function(t){e=Math.min(e,t.x),i=Math.min(i,t.y),o=Math.max(o,t.x),r=Math.max(r,t.y)}),new Rectangle(e-this.borderWidth/2,i-this.borderWidth/2,o+this.borderWidth/2,r+this.borderWidth/2)},VectorPolygon.prototype.containsPoint=function(t){for(var e,i,o,r=this,n=this.points.length,s=!1,a=1;a<n;a+=1)if(i=this.points[a-1],o=this.points[a],Math.abs(i.distanceTo(o)-(t.distanceTo(i)+t.distanceTo(o)))<=Math.sqrt(r.borderWidth/2)/2)return!0;if(this.isClosed){for(a=0,e=n-1;a<n;a+=1)this.points[a].y>t.y!=this.points[e].y>t.y&&t.x<(this.points[e].x-this.points[a].x)*(t.y-this.points[a].y)/(this.points[e].y-this.points[a].y)+this.points[a].x&&(s=!s),e=a;return s}return!1},VectorPolygon.prototype.update=function(t,e){this.isFreeHand||1===this.points.length?this.points.push(t):this.isFreeHand||(e&&(this.origin=this.points[this.points.length-2],t=VectorLine.prototype.constraintPoint.call(this,t)),this.points[this.points.length-1]=t)},VectorPolygon.prototype.setColor=function(t,e){VectorPolygon.uber.setColor.call(this,t,!this.isClosed||e)},VectorPolygon.prototype.moveBy=function(e){this.points.forEach(function(t){t.x+=e.x,t.y+=e.y})},VectorPolygon.prototype.resizeBy=function(e,i){this.points=this.points.map(function(t){return t.subtract(i).multiplyBy(e).add(i)})},VectorPolygon.prototype.close=function(){this.isClosed&&this.points.push(this.points[0].copy())},VectorPolygon.prototype.asSVG=function(){var e=VectorPolygon.uber.asSVG.call(this,"path");return e.attributes["stroke-linejoin"]="round",e.attributes["stroke-linecap"]="round",e.attributes.d="M"+this.points[0].x+" "+this.points[0].y,this.points.slice(1).forEach(function(t){e.attributes.d+=" L "+t.x+" "+t.y}),e},VectorPolygon.prototype.drawOn=function(e){var i,t=this.points.map(function(t){return t.subtract(e.position())});this.image=newCanvas(e.extent()),(i=this.image.getContext("2d")).lineCap="round",i.lineJoin="round",i.beginPath(),i.moveTo(t[0].x,t[0].y),t.slice(1).forEach(function(t){i.lineTo(t.x,t.y)}),this.fillColor&&0<this.fillColor.a&&(i.fillStyle=this.fillColor.toRGBstring(),i.fill()),0<this.borderColor.a?(i.lineWidth=this.borderWidth,i.strokeStyle=this.borderColor.toRGBstring(),i.stroke()):2===this.points.length&&(i.lineWidth=1,i.strokeStyle=this.fillColor.toRGBstring(),i.stroke()),e.redraw=!0},VectorSelection.prototype=new VectorRectangle,(VectorSelection.prototype.constructor=VectorSelection).uber=VectorRectangle.prototype,VectorSelection.prototype.init=function(t,e){VectorSelection.uber.init.call(this,t,e),this.isSelection=!0,this.threshold=5},VectorSelection.prototype.corners=function(){var t=this.bounds();return[t.topLeft(),t.topRight(),t.bottomLeft(),t.bottomRight()]},VectorSelection.prototype.cornerAt=function(e){var i=this.threshold;return this.corners().find(function(t){return e.distanceTo(t)<=i})},VectorSelection.prototype.cornerOppositeTo=function(i){return this.corners().reduce(function(t,e){return i.distanceTo(t)>i.distanceTo(e)?t:e})},VectorSelection.prototype.drawOn=function(t){var i,e=this.bounds(),o=t.position(),r=e.origin.subtract(o),n=this.threshold;function s(t,e){i.beginPath(),i.arc(t-o.x,e-o.y,n,0,2*Math.PI),i.stroke()}this.image=newCanvas(t.extent()),(i=this.image.getContext("2d")).rect(r.x,r.y,this.width(),this.height()),i.setLineDash([5]),i.stroke(),i.setLineDash([]),s(e.left(),e.top()),s(e.left(),e.bottom()),s(e.right(),e.top()),s(e.right(),e.bottom()),t.redraw=!0},Crosshair.prototype=VectorShape,(Crosshair.prototype.constructor=Crosshair).uber=VectorShape.prototype,Crosshair.prototype.init=function(t,e){this.center=t,this.paper=e,this.image=newCanvas(),this.isCrosshair=!0},Crosshair.prototype.update=function(t){this.center=t.subtract(this.paper.position())},Crosshair.prototype.moveBy=function(t){this.center=this.center.add(t)},Crosshair.prototype.drawOn=function(t){this.image=newCanvas(t.extent()),t.rotationCenter=this.center.copy(),t.drawcrosshair(this.image.getContext("2d")),t.redraw=!0},VectorPaintEditorMorph.prototype=new PaintEditorMorph,(VectorPaintEditorMorph.prototype.constructor=VectorPaintEditorMorph).uber=PaintEditorMorph.prototype,VectorPaintEditorMorph.prototype.init=function(){this.paper=null,this.shapes=[],this.selection=[],this.selecting=!1,this.originalSelection=null,this.moving=!1,this.resizing=!1,this.lastDragPosition=null,this.history=[],this.clipboard=[],this.currentShape=null,VectorPaintEditorMorph.uber.init.call(this),this.labelString="Vector Paint Editor",this.createLabel(),this.fixLayout()},VectorPaintEditorMorph.prototype.buildEdits=function(){var t=this;this.edits.add(this.pushButton("undo",function(){t.undo()})),this.edits.add(this.pushButton("clear",function(){t.paper.clearCanvas()})),this.edits.add(this.pushButton("Bitmap",function(){0<t.shapes.length?t.ide.confirm("This will convert your vector objects into\nbitmaps, and you will not be able to convert\nthem back into vector drawings.\nAre you sure you want to continue?","Convert to bitmap?",function(){t.convertToBitmap()},nop):t.convertToBitmap()})),this.edits.fixLayout()},VectorPaintEditorMorph.prototype.convertToBitmap=function(){var e=newCanvas(StageMorph.prototype.dimensions);this.object=new Costume,this.shapes.forEach(function(t){e.getContext("2d").drawImage(t.image,0,0)}),this.object.rotationCenter=this.paper.rotationCenter.copy(),this.object.contents=e,this.object.edit(this.world(),this.ide,!1,this.oncancel),this.destroy()},VectorPaintEditorMorph.prototype.buildScaleBox=function(){var e=this;["Top","Bottom","Up","Down"].forEach(function(t){e.scaleBox.add(e.pushButton(t,function(){e.changeSelectionLayer(t.toLowerCase())}))}),this.scaleBox.fixLayout()},VectorPaintEditorMorph.prototype.openIn=function(t,e,i,o,r,n){var s=this,a=isNil(n)||0===n.length;VectorPaintEditorMorph.uber.openIn.call(this,t,null,i,o),this.ide=r,this.paper.drawNew(),this.paper.changed(),n.forEach(function(t){t.drawOn(s.paper)}),this.shapes=n.map(function(t){return t.copy()}),this.shapes.forEach(function(t){t.drawOn(s.paper)}),i&&!a?(this.paper.automaticCrosshairs=!1,this.paper.rotationCenter=this.getBounds(this.shapes).origin.subtract(this.paper.bounds.origin).add(i)):this.paper.automaticCrosshairs=!0,this.updateHistory(),this.processKeyUp=function(){this.shift=!1,this.ctrl=!1,this.propertiesControls.constrain.refresh()},this.processKeyDown=function(t){var e,i=this;switch(this.shift=t.shiftKey,this.ctrl=t.ctrlKey,this.world().currentKey){case 46:case 8:this.sortSelection(),this.selection.slice().reverse().forEach(function(t){i.shapes.splice(i.shapes.indexOf(t),1)}),this.clearSelection(),this.updateHistory();break;case 13:this.currentShape&&this.currentShape.isPolygon&&(this.currentShape.close(),this.currentShape.drawOn(this.paper),this.shapes.push(this.currentShape),this.currentShape=null,this.updateHistory());break;case 33:this.changeSelectionLayer("up");break;case 34:this.changeSelectionLayer("down");break;case 35:this.changeSelectionLayer("bottom");break;case 36:this.changeSelectionLayer("top");break;case 90:this.ctrl&&this.undo();break;case 67:this.ctrl&&this.selection.length&&(this.clipboard=this.selection.map(function(t){return t.copy()}));break;case 86:e=this.world().hand.position(),this.ctrl&&this.paper.bounds.containsPoint(e)&&(this.paper.pasteAt(e),this.updateHistory());break;case 65:this.ctrl&&(this.paper.currentTool="selection",this.paper.toolChanged("selection"),this.refreshToolButtons(),this.paper.selectShapes(this.shapes));break;case 27:this.clearSelection();break;case 37:this.moveSelectionBy(new Point(-1,0)),this.updateHistory();break;case 38:this.moveSelectionBy(new Point(0,-1)),this.updateHistory();break;case 39:this.moveSelectionBy(new Point(1,0)),this.updateHistory();break;case 40:this.moveSelectionBy(new Point(0,1)),this.updateHistory();break;default:nop()}this.propertiesControls.constrain.refresh(),this.drawNew()}},VectorPaintEditorMorph.prototype.buildContents=function(){VectorPaintEditorMorph.uber.buildContents.call(this),this.paper.destroy(),this.paper=new VectorPaintCanvasMorph(this.shift),this.paper.setExtent(StageMorph.prototype.dimensions),this.body.add(this.paper),this.refreshToolButtons(),this.fixLayout(),this.drawNew()},VectorPaintEditorMorph.prototype.buildToolbox=function(){var i={brush:"Paintbrush tool\n(free draw)",rectangle:"Rectangle\n(shift: square)",ellipse:"Ellipse\n(shift: circle)",selection:"Selection tool",crosshairs:"Set the rotation center",line:"Line tool\n(shift: constrain to 45º)",closedBrush:"Closed brush\n(free draw)",polygon:"Polygon",paintbucket:"Paint a shape\n(shift: edge color)",pipette:"Pipette tool\n(pick a color from anywhere\nshift: fill color)"},o=this,r=this.toolbox.left(),n=this.toolbox.top(),s=0,a=0;Object.keys(i).forEach(function(t){var e=o.toolButton(t,i[t]);e.setPosition(new Point(r+s,n+a)),s+=e.width()+2,"crosshairs"===t&&(s=0,a+=e.height()+2,o.paper.drawcrosshair()),o.toolbox[t]=e,o.toolbox.add(e)}),this.toolbox.bounds=this.toolbox.fullBounds().expandBy(10),this.toolbox.drawNew()},VectorPaintEditorMorph.prototype.populatePropertiesMenu=function(){var t=this.controls,i=this,o=this.propertiesControls,e=new AlignmentMorph("row",this.padding),r=new AlignmentMorph("row",this.padding),n=new AlignmentMorph("row",this.padding);o.primaryColorViewer=new Morph,o.primaryColorViewer.setExtent(new Point(85,15)),o.primaryColorViewer.color=new Color(0,0,0),o.secondaryColorViewer=new Morph,o.secondaryColorViewer.setExtent(new Point(85,15)),o.secondaryColorViewer.color=new Color(0,0,0),o.colorpicker=new PaintColorPickerMorph(new Point(180,100),function(t,e){i.selectColor(t,!e)}),o.colorpicker.mouseDownRight=function(t){t.subtract(this.position()).x>2*this.width()/3&&t.subtract(this.position()).y>this.height()-10?this.action("transparent",!0):this.action(this.getPixelColor(t),!0)},o.colorpicker.action(new Color(0,0,0)),o.colorpicker.action("transparent",!0),o.penSizeSlider=new SliderMorph(0,20,5,5),o.penSizeSlider.orientation="horizontal",o.penSizeSlider.setHeight(15),o.penSizeSlider.setWidth(150),o.penSizeSlider.action=function(e){o.penSizeField&&o.penSizeField.setContents(e),i.paper.settings.lineWidth=e,i.selection.forEach(function(t){t.setBorderWidth(e),t.drawOn(i.paper),i.paper.updateSelection()}),i.updateHistory()},o.penSizeField=new InputFieldMorph("3",!0,null,!1),o.penSizeField.contents().minWidth=20,o.penSizeField.setWidth(25),o.penSizeField.accept=function(e){var t=parseFloat(o.penSizeField.getValue());o.penSizeSlider.value=t,o.penSizeSlider.drawNew(),o.penSizeSlider.updateValue(),this.setContents(t),i.paper.settings.lineWidth=t,(this.world().keyboardReceiver=i).selection.forEach(function(t){t.setBorderWidth(e),t.drawOn(i.paper),i.paper.updateSelection()}),i.updateHistory()},e.add(o.penSizeSlider),e.add(o.penSizeField),e.color=i.color,e.fixLayout(),o.penSizeField.drawNew(),o.constrain=new ToggleMorph("checkbox",this,function(){i.shift=!i.shift},"Constrain proportions of shapes?\n(you can also hold shift)",function(){return i.shift}),r.add(o.secondaryColorViewer),r.add(o.primaryColorViewer),r.fixLayout(),n.add(new TextMorph(localize("Edge color\n(left click)"),null,null,null,null,"center",85)),n.add(new TextMorph(localize("Fill color\n(right click)"),null,null,null,null,"center",85)),n.fixLayout(),t.add(o.colorpicker),t.add(n),t.add(r),t.add(new TextMorph(localize("Brush size"))),t.add(e),t.add(o.constrain)},VectorPaintEditorMorph.prototype.selectColor=function(e,t){var i,o,r=this,n=!this.paper.isShiftPressed()&&t,s=(n?"secondary":"primary")+"Color",a=newCanvas(this.propertiesControls[s+"Viewer"].extent()),h=a.getContext("2d");if(this.paper.settings[s]=e,this.selection.length&&(this.selection.forEach(function(t){t.setColor(e,n),t.drawOn(r.paper)}),this.updateHistory()),"transparent"===e)for(i=0;i<180;i+=5)for(o=0;o<15;o+=5)h.fillStyle=(o+i)/5%2==0?"rgba(0, 0, 0, 0.2)":"rgba(0, 0, 0, 0.5)",h.fillRect(i,o,5,5);else h.fillStyle=e.toString(),h.fillRect(0,0,180,15);h.strokeStyle="black",h.lineWidth=Math.min(this.paper.settings.lineWidth,20),h.beginPath(),h.lineCap="round",h.moveTo(20,30),h.lineTo(160,30),h.stroke(),this.propertiesControls[s+"Viewer"].image=a,this.propertiesControls[s+"Viewer"].changed()},VectorPaintEditorMorph.prototype.changeSelectionLayer=function(t){var i=this;switch(this.sortSelection(),t){case"top":this.selection.forEach(function(t){i.shapes.splice(i.shapes.indexOf(t),1),i.shapes.push(t)});break;case"bottom":this.selection.slice().reverse().forEach(function(t){i.shapes.splice(i.shapes.indexOf(t),1),i.shapes.splice(0,0,t)});break;case"up":this.selection.forEach(function(t){var e=i.shapes.indexOf(t);i.shapes.splice(e,1),i.shapes.splice(e+i.selection.length,0,t)});break;case"down":this.shapes[0]!==this.selection[0]&&this.selection.forEach(function(t){var e=i.shapes.indexOf(t);i.shapes.splice(e,1),i.shapes.splice(e-1,0,t)})}this.updateHistory(),this.paper.redraw=!0},VectorPaintEditorMorph.prototype.dragSelection=function(t){var e,i,o;this.lastDragPosition?this.moving?(o=t.subtract(this.lastDragPosition),this.moveSelectionBy(o)):this.resizing&&(this.shift&&(e=this.originalSelection.origin,i=Math.max((t.x-e.x)/(this.originalSelection.destination.x-e.x),(t.y-e.y)/(this.originalSelection.destination.y-e.y)),t=this.originalSelection.destination.subtract(e).multiplyBy(i).add(e)),o=t.subtract(this.currentShape.origin).divideBy(this.lastDragPosition.subtract(this.currentShape.origin)),this.resizeSelectionBy(o)):this.resizing&&(this.originalSelection=this.currentShape.copy()),this.lastDragPosition=t},VectorPaintEditorMorph.prototype.moveSelectionBy=function(e){var i=this.paper;this.selection.forEach(function(t){t.moveBy(e),t.drawOn(i)}),this.currentShape&&this.currentShape.isSelection&&(this.currentShape.moveBy(e),this.currentShape.drawOn(i))},VectorPaintEditorMorph.prototype.resizeSelectionBy=function(e){var i,o=this.paper;this.currentShape&&this.currentShape.isSelection&&(i=this.currentShape,this.selection.forEach(function(t){t.resizeBy(e,i.origin),t.drawOn(o)}),i.resizeBy(e,i.origin),i.drawOn(o))},VectorPaintEditorMorph.prototype.sortSelection=function(){var i=this;this.selection.sort(function(t,e){return i.shapes.indexOf(t)>i.shapes.indexOf(e)})},VectorPaintEditorMorph.prototype.clearSelection=function(){this.currentShape=null,this.selection=[],this.paper.redraw=!0},VectorPaintEditorMorph.prototype.getSVG=function(){var t=new XML_Element("svg"),e=this.getBounds(this.shapes);return t.attributes.xmlns="http://www.w3.org/2000/svg",t.attributes.snap="http://snap.berkeley.edu/run",t.attributes.version="1.1",t.attributes.preserveAspectRatio="xMinYMin meet",t.attributes.viewBox=e.left()+" "+e.top()+" "+(e.right()-e.left())+" "+(e.bottom()-e.top()),t.attributes.width=e.right()-e.left(),t.attributes.height=e.bottom()-e.top(),t.children=this.shapes.map(function(t){return t.asSVG()}),window.btoa(t)},VectorPaintEditorMorph.prototype.getBounds=function(t){var e=t.map(function(t){return t.bounds()});return 0===e.length?null:e.reduce(function(t,e){return new Rectangle(Math.min(t.left(),e.left()),Math.min(e.top(),t.top()),Math.max(t.right(),e.right()),Math.max(t.bottom(),e.bottom()))})},VectorPaintEditorMorph.prototype.silentMoveBy=function(e){VectorPaintEditorMorph.uber.silentMoveBy.call(this,e),this.currentShape&&this.currentShape.moveBy(e),this.shapes.forEach(function(t){t.moveBy(e)})},VectorPaintEditorMorph.prototype.ok=function(){var t,e,i=this,o=new Image;0!==this.shapes.length?(t=this.getBounds(this.shapes).origin,e=t.subtract(this.paper.bounds.origin),this.paper.updateAutomaticCenter(),o.src="data:image/svg+xml;base64,"+this.getSVG().toString(),o.onload=function(){i.callback(o,i.paper.rotationCenter.subtract(e),i.shapes)},this.destroy()):this.cancel()},VectorPaintEditorMorph.prototype.updateHistory=function(){this.history.push(this.shapes.map(function(t){return t.copy()}))},VectorPaintEditorMorph.prototype.undo=function(){var e=this.paper,t=this.checksum(),i=t;function o(t){t.drawOn(e)}for(;this.shapes.length&&t==i;)this.shapes=this.history.pop()||[],this.shapes.forEach(o),i=this.checksum();this.clearSelection()},VectorPaintEditorMorph.prototype.checksum=function(){return JSON.stringify(this.shapes).split("").reduce(function(t,e){return t+e.charCodeAt(0)},0)},VectorPaintCanvasMorph.prototype=new PaintCanvasMorph,(VectorPaintCanvasMorph.prototype.constructor=VectorPaintCanvasMorph).uber=PaintCanvasMorph.prototype,VectorPaintCanvasMorph.prototype.init=function(t){VectorPaintCanvasMorph.uber.init.call(this,t),this.pointBuffer=[],this.currentTool="brush",this.settings={primaryColor:new Color(0,0,0,0),secondaryColor:new Color(0,0,0,255),lineWidth:3}},VectorPaintCanvasMorph.prototype.calculateCanvasCenter=function(){var t=this.bounds;return new Point(t.width()/2,t.height()/2)},VectorPaintCanvasMorph.prototype.updateAutomaticCenter=function(){var t,e=this.parentThatIsA(VectorPaintEditorMorph),i=e.getBounds(e.shapes);this.automaticCrosshairs&&i?(t=i.origin.subtract(this.bounds.origin),this.rotationCenter=new Point(i.width()/2,i.height()/2).add(t)):this.automaticCrosshairs&&this.calculateCanvasCenter()},VectorPaintCanvasMorph.prototype.clearCanvas=function(){var t=this.parentThatIsA(VectorPaintEditorMorph);t.updateHistory(),t.shapes=[],t.clearSelection(),this.mask.getContext("2d").clearRect(0,0,this.bounds.width(),this.bounds.height()),this.redraw=!0},VectorPaintCanvasMorph.prototype.toolChanged=function(t){var e=this.parentThatIsA(VectorPaintEditorMorph);if(VectorPaintCanvasMorph.uber.toolChanged.call(this,t),e.currentShape&&e.currentShape.isPolygon&&(e.currentShape.close(),e.currentShape.drawOn(this),e.shapes.push(e.currentShape)),"crosshairs"===t)e.clearSelection(),e.currentShape=new Crosshair(this.rotationCenter,this),e.currentShape.drawOn(this),this.automaticCrosshairs=!1;else{if("pipette"===t&&e.selection)return;e.clearSelection(),e.currentShape=null}},VectorPaintCanvasMorph.prototype.drawNew=function(){var e=this,t=this.parentThatIsA(VectorPaintEditorMorph),i=newCanvas(this.extent());this.merge(this.background,i),this.merge(this.paper,i),t.shapes.forEach(function(t){e.merge(t.image,i)}),t.currentShape&&this.merge(t.currentShape.image,i),this.image=i,this.drawFrame()},VectorPaintCanvasMorph.prototype.step=function(){this.redraw&&(this.drawNew(),this.changed(),this.redraw=!1)},VectorPaintCanvasMorph.prototype.mouseMove=function(t){var e,i,o=this.parentThatIsA(VectorPaintEditorMorph),r=this.settings.primaryColor,n=this.settings.secondaryColor,s=this.settings.lineWidth;"paintbucket"!==this.currentTool&&(o.currentShape&&o.currentShape.isSelection&&!o.selecting?(e=o.currentShape.cornerAt(t),o.resizing||o.moving?o.dragSelection(t):e?(i=o.currentShape.cornerOppositeTo(e),o.currentShape=new VectorSelection(i,e),o.currentShape.drawOn(this),o.resizing=!0,document.body.style.cursor="move"):o.currentShape.containsPoint(t)&&(o.moving=!0,document.body.style.cursor="move")):(!o.currentShape||o.currentShape.isSelection&&!o.selecting?this.beginShape(s,r,n,t):o.currentShape.update(t,o.shift),o.currentShape.drawOn(this)))},VectorPaintCanvasMorph.prototype.mouseEnter=function(){"selection"===this.currentTool?document.body.style.cursor="crosshair":document.body.style.cursor="default"},VectorPaintCanvasMorph.prototype.mouseLeave=function(){document.body.style.cursor="default"},VectorPaintCanvasMorph.prototype.mouseClickLeft=function(t){var e=this.parentThatIsA(VectorPaintEditorMorph),i=e.currentShape;i?i.isPolygon&&!i.isFreeHand?i.points.push(i.points[i.points.length-1].copy()):i.isPolygon?(i.close(),i.drawOn(this),e.shapes.push(i),e.currentShape=null):i.isSelection?e.selecting?(i.destination=t,this.selectInside(i),e.selecting=!1):e.moving||e.resizing?(e.moving=!1,e.resizing=!1,this.updateSelection()):this.selectAtPoint(t):i.isCrosshair?this.rotationCenter=t.subtract(this.bounds.origin):(i.update(t,e.shift),e.shapes.push(i),e.currentShape=null):"selection"===this.currentTool&&this.selectAtPoint(t),e.lastDragPosition=null,this.mouseEnter(),e.updateHistory()},VectorPaintCanvasMorph.prototype.mouseDoubleClick=function(t){var e=this.parentThatIsA(VectorPaintEditorMorph),i=e.currentShape;i&&i.isPolygon&&(i.close(),i.drawOn(this),e.shapes.push(i),e.currentShape=null,e.updateHistory())},VectorPaintCanvasMorph.prototype.beginShape=function(t,e,i,o){switch(this.currentTool){case"brush":this.beginPolygon(t,i,null,o,!1,!0);break;case"line":this.beginLine(t,i,o);break;case"rectangle":this.beginRectangle(t,i,e,o);break;case"ellipse":this.beginEllipse(t,i,e,o);break;case"polygon":this.beginPolygon(t,i,e,o,!0,!1);break;case"closedBrush":this.beginPolygon(t,i,e,o,!0,!0);break;case"selection":this.beginSelection(o)}},VectorPaintCanvasMorph.prototype.beginPolygon=function(t,e,i,o,r,n){this.parentThatIsA(VectorPaintEditorMorph).currentShape=new VectorPolygon(t,e,i,[o],r,n)},VectorPaintCanvasMorph.prototype.beginLine=function(t,e,i){this.parentThatIsA(VectorPaintEditorMorph).currentShape=new VectorLine(t,e,i,i)},VectorPaintCanvasMorph.prototype.beginRectangle=function(t,e,i,o){this.parentThatIsA(VectorPaintEditorMorph).currentShape=new VectorRectangle(t,e,i,o,o)},VectorPaintCanvasMorph.prototype.beginEllipse=function(t,e,i,o){this.parentThatIsA(VectorPaintEditorMorph).currentShape=new VectorEllipse(t,e,i,o,o)},VectorPaintCanvasMorph.prototype.beginSelection=function(t){var e=this.parentThatIsA(VectorPaintEditorMorph);e.currentShape=new VectorSelection(t,t),e.selecting=!0},VectorPaintCanvasMorph.prototype.selectInside=function(t){var e=t.bounds(),i=this.parentThatIsA(VectorPaintEditorMorph);i.selection=i.shapes.filter(function(t){return e.containsRectangle(t.bounds())}),0<i.selection.length?(e=i.getBounds(i.selection),t.origin=e.topLeft(),t.destination=e.bottomRight(),t.drawOn(this)):(i.currentShape=null,this.redraw=!0)},VectorPaintCanvasMorph.prototype.selectAtPoint=function(t){var e,i,o=this.parentThatIsA(VectorPaintEditorMorph),r=this.shapeAt(t);r&&(o.shift?-1<(i=o.selection.indexOf(r))?o.selection.splice(i,1):o.selection.push(r):o.selection=[r],e=o.getBounds(o.selection)),e?(o.currentShape=new VectorSelection(e.topLeft(),e.bottomRight()),o.currentShape.drawOn(this)):o.clearSelection()},VectorPaintCanvasMorph.prototype.selectShapes=function(t){var e,i=this.parentThatIsA(VectorPaintEditorMorph);0<t.length&&(e=i.getBounds(t),i.selection=t,i.currentShape=new VectorSelection(e.topLeft(),e.bottomRight()),i.currentShape.drawOn(this))},VectorPaintCanvasMorph.prototype.updateSelection=function(){var t=this.parentThatIsA(VectorPaintEditorMorph);this.selectShapes(t.selection)},VectorPaintCanvasMorph.prototype.shapeAt=function(e){var t=this.parentThatIsA(VectorPaintEditorMorph);return detect(t.shapes.slice().reverse(),function(t){return t.containsPoint(e)})},VectorPaintCanvasMorph.prototype.pasteAt=function(t){var i,o=this.parentThatIsA(VectorPaintEditorMorph),r=this,e=o.clipboard,n=[];0<e.length&&(i=t.subtract(e[0].bounds().origin)),e.forEach(function(t){var e=t.copy();e.moveBy(i),o.selection.push(e),o.shapes.push(e),e.drawOn(r),n.push(e)}),0<n.length&&(this.selectShapes(n),o.updateHistory())},VectorPaintCanvasMorph.prototype.floodfill=function(t){var e=this.parentThatIsA(VectorPaintEditorMorph),i=this.shapeAt(t.add(this.position()));i&&(i.setColor(e.shift?this.settings.secondaryColor:this.settings.primaryColor,e.shift),i.drawOn(this))};</script>
        <script>var VideoMotion;function VideoMotion(t,i){this.width=t,this.height=i,this.frameNumber=0,this.winSize=8,this.lastAnalyzedFrame=0,this.motionAmount=0,this.motionDirection=0,this.imageBuffer=new ArrayBuffer(this.width*this.height*2),this.curr=new Uint8ClampedArray(this.imageBuffer,0,this.width*this.height),this.prev=new Uint8ClampedArray(this.imageBuffer,this.width*this.height,this.width*this.height),this.threshold=30,this.amountScale=100,this.toDegree=180/Math.PI}modules.video="2019-May-22",VideoMotion.prototype.reset=function(t,i){this.width=t,this.height=i,this.frameNumber=0,this.lastAnalyzedFrame=0,this.imageBuffer=new ArrayBuffer(this.width*this.height*2),this.curr=new Uint8ClampedArray(this.imageBuffer,0,this.width*this.height),this.prev=new Uint8ClampedArray(this.imageBuffer,this.width*this.height,this.width*this.height)},VideoMotion.prototype.addFrame=function(t){var i,h=this.prev,e=new Uint32Array(t.buffer.slice(0));for(this.frameNumber++,this.prev=this.curr,this.curr=h,i=0;i<e.length;i++)this.curr[i]=255&e[i]},VideoMotion.prototype.getStageMotion=function(){var t,i,h,e,o,r,s,a,n,m,u,f,d,w=0,l=0,M=0,c={u:0,v:0},g=2*this.winSize+1,p=this.width-this.winSize-1,v=this.height-this.winSize-1;if(this.curr&&this.prev){if(this.lastAnalyzedFrame!==this.frameNumber){for(this.lastAnalyzedFrame=this.frameNumber,t=this.winSize+1;t<v;t+=g)for(i=this.winSize+1;i<p;i+=g){for(m=n=a=s=r=0,e=(h=(t-this.winSize)*this.width+i-this.winSize)+g,o=(t+this.winSize)*this.width+i+this.winSize;h<=o;h+=this.width-g,e+=this.width)for(;h<=e;h+=1)d=this.prev[h]-this.curr[h],r+=(u=this.curr[h-1]-this.curr[h+1])*u,s+=u*(f=this.curr[h-this.width]-this.curr[h+this.width]),a+=f*f,m+=u*d,n+=f*d;-g<(c=this.getMotionVector(r,s,a,m,n)).u&&c.u<g&&-g<c.v&&c.v<g&&(w+=c.u,l+=c.v,M++)}w/=M,l/=M,this.motionAmount=Math.round(this.amountScale*Math.hypot(w,l)),this.motionAmount>this.threshold&&(this.motionDirection=((Math.atan2(l,w)*this.toDegree+270)%360-180).toFixed(2))}}else this.motionAmount=this.motionDirection=-1},VideoMotion.prototype.getMotionVector=function(t,i,h,e,o){var r,s,a,n,m,u=i*i-t*h,f={u:0,v:0};return u?(a=-(o*i-e*h),n=-(i*e-t*o),m=8/u,f.u=a*m,f.v=n*m):(r=(i+t)*(i+t)+(h+i)*(h+i))?(s=8/r,f.u=(i+t)*(-(o+e)*s),f.v=(h+i)*(-(o+e)*s)):(f.u=0,f.v=0),f},VideoMotion.prototype.getLocalMotion=function(t){var i,h,e,o,r,s,a,n,m,u,f,d,w=t.parentThatIsA(StageMorph),l=0,M=Math.floor(t.width()/w.scale),c=this.winSize,g={u:0,v:0},p=0,v=0,y=0,A=0,S=0,x=this.threshold/3,z=2e-4*this.amountScale,b=0,V=0;if(this.curr&&this.prev){if(t.frameNumber!==this.frameNumber){for(u=t.getImageData(),f=function(t){var i=t.parentThatIsA(StageMorph),h=i.scale,e={sx:0,sy:0,sw:Math.floor(t.extent().x/h),sh:Math.floor(t.extent().y/h)};t.left()<i.left()&&(e.sw=Math.max(Math.floor((t.right()-i.left())/h),0),e.sx=Math.floor(t.width()/h-e.sw));t.right()>i.right()&&(e.sw=Math.max(Math.floor((i.right()-t.left())/h),0));t.top()<i.top()&&(e.sh=Math.max(Math.floor((t.bottom()-i.top())/h),0),e.sy=Math.floor(t.height()/h-e.sh));t.bottom()>i.bottom()&&(e.sh=Math.max(Math.floor((i.bottom()-t.top())/h),0));return e}(t),e=Math.max(Math.floor((t.left()-w.left())/w.scale),0),r=Math.max(Math.floor((t.top()-w.top())/w.scale),0),o=Math.min(f.sw+e,w.dimensions.x),s=Math.min(f.sh+r,w.dimensions.y-1),d=f.sy*M+f.sx,i=r;i<s;i++,d+=M-f.sw)for(h=e;h<o;h++,++d)0<h&&h<this.width&&0<i&&i<this.height&&255==(u[d]>>24&255)&&(V=i*this.width+h,a=this.prev[V]-this.curr[V],p+=(n=this.curr[V-1]-this.curr[V+1])*n,v+=n*(m=this.curr[V-this.width]-this.curr[V+this.width]),y+=m*m,S+=n*a,A+=m*a,b++);g=this.getMotionVector(p,v,y,S,A),b&&(l=b,b/=2*c*2*c,g.u=g.u/b,g.v=g.v/b),t.motionAmount=Math.round(z*l*Math.hypot(g.u,g.v)),100<t.motionAmount&&(t.motionAmount=Math.min(100,100)),t.motionAmount>x&&(t.motionDirection=((Math.atan2(g.v,g.u)*this.toDegree+270)%360-180).toFixed(2)),t.frameNumber=this.frameNumber}}else t.motionAmount=t.motionDirection=-1};</script>
        <script>function WorldMap(t){this.tileServers={OpenStreetMap:{url:"tile.openstreetmap.org",type:"zxy",subdomains:["a","b","c"],key:null,min:0,max:19,credits:"Map data © OpenStreetMap contributorsCC-BY-SA, Imagery © Mapnik"},Wikimedia:{url:"maps.wikimedia.org/osm-intl",type:"zxy",subdomains:null,key:null,min:0,max:19,credits:"Map data © OpenStreetMap contributors, CC-BY-SA, Imagery © Wikimedia"},Watercolor:{url:"stamen-tiles.a.ssl.fastly.net/watercolor",type:"zxy",subdomains:null,key:null,min:0,max:20,credits:"Map data © OpenStreetMap contributors, CC-BY-SA, Imagery © Stamen, CC-BY-3.0."},Toner:{url:"stamen-tiles.a.ssl.fastly.net/toner",type:"zxy",subdomains:null,key:null,min:0,max:20,credits:"Map data © OpenStreetMap contributors, CC-BY-SA, Imagery © Stamen, CC-BY-3.0."},Terrain:{url:"stamen-tiles.a.ssl.fastly.net/terrain",type:"zxy",subdomains:null,key:null,min:0,max:16,credits:"Map data © OpenStreetMap contributors, CC-BY-SA, Imagery © Stamen, CC-BY-3.0."},Topographic:{url:"tile.opentopomap.org",type:"zxy",subdomains:null,key:null,min:0,max:17,credits:"Map data © OpenStreetMap contributors, CC-BY-SA, Imagery © Opentopomaps"},Satellite:{url:"services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile",type:"zyx",subdomains:null,key:null,min:0,max:19,credits:"Imagery © ArcGIS"},Streets:{url:"services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile",type:"zyx",subdomains:null,key:null,min:0,max:19,credits:"Imagery © ArcGIS"},Shading:{url:"services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile",type:"zyx",subdomains:null,key:null,min:0,max:19,credits:"Imagery © ArcGIS"},"Mapbox (experimental)":{url:"api.tiles.mapbox.com/v4/mapbox.streets",type:"zxy",subdomains:null,key:"?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw",min:0,max:20,credits:"Map data © OpenStreetMap contributors, CC-BY-SA, Imagery © Mapbox"}},this.api=this.tileServers[t||"Wikimedia"],this.lon=-122.257852,this.lat=37.872099,this.zoom=13,this.position=new Point(this.tileXfromLon(this.lon),this.tileYfromLat(this.lat)),this.extent=new Point(480,360),this.tileSize=256,this.canvas=null,this.creditsTxt=null,this.creditsBG=null,this.initializeCredits(),this.loading=0}modules.maps="2019-June-06",WorldMap.prototype.setHost=function(t){this.api=this.tileServers[t||"Wikimedia"],this.initializeCredits(),this.setZoom(this.zoom)},WorldMap.prototype.setView=function(t,i){this.lat=i,this.lon=t,this.refresh()},WorldMap.prototype.setZoom=function(t){this.zoom=Math.max(Math.min(this.api.max,Math.floor(t)),this.api.min),this.refresh()},WorldMap.prototype.panBy=function(t,i){this.lon=this.lonFromTileX(this.position.x+t/this.tileSize),this.lat=this.latFromTileY(this.position.y+i/this.tileSize),this.refresh()},WorldMap.prototype.refresh=function(){this.position=new Point(this.wrapTile(this.tileXfromLon(this.lon)),this.tileYfromLat(this.lat))},WorldMap.prototype.wrapTile=function(t){var i=Math.pow(2,this.zoom);return t<0?i+t:t%i},WorldMap.prototype.tileXfromLon=function(t){return(parseFloat(t)+180)/360*Math.pow(2,this.zoom)},WorldMap.prototype.tileYfromLat=function(t){return(1-Math.log(Math.tan(parseFloat(t)*Math.PI/180)+1/Math.cos(parseFloat(t)*Math.PI/180))/Math.PI)/2*Math.pow(2,this.zoom)},WorldMap.prototype.lonFromTileX=function(t){return t/Math.pow(2,this.zoom)*360-180},WorldMap.prototype.latFromTileY=function(t){var i=Math.PI-2*Math.PI*t/Math.pow(2,this.zoom);return 180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))},WorldMap.prototype.lonFromSnapX=function(t){return this.lonFromTileX(this.position.x+t/this.tileSize)},WorldMap.prototype.latFromSnapY=function(t){return this.latFromTileY(this.position.y-t/this.tileSize)},WorldMap.prototype.snapXfromLon=function(t){return(this.tileXfromLon(t)-this.position.x)*this.tileSize},WorldMap.prototype.snapYfromLat=function(t){return(this.tileYfromLat(t)-this.position.y)*-this.tileSize},WorldMap.prototype.distanceInKm=function(t,i,e,a){var s=radians(e-t),o=radians(a-i),r=Math.sin(s/2)*Math.sin(s/2)+Math.cos(radians(+t))*Math.cos(radians(+e))*Math.sin(o/2)*Math.sin(o/2);return 6371*(2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)))},WorldMap.prototype.render=function(){var t,i,e,a,s,o,r,n=this.extent.divideBy(2),l=this.tileSize,p=this.position.floor(),h=new Point(this.position.x%1,this.position.y%1).multiplyBy(l),m=n.subtract(h),d=m.floorDivideBy(l).add(1),c=this.extent.floorDivideBy(l).add(2),u=p.subtract(d),y=m.subtract(d.multiplyBy(l)),M=0,x=this,f=Math.pow(2,this.zoom);function S(){--x.loading,a.drawImage(this,y.x+this.cx*l,y.y+this.cy*l),z()}function g(){--x.loading,z()}function z(){x.loading||x.addCredits()}for(this.canvas=newCanvas(this.extent,!0),a=this.canvas.getContext("2d"),t=0;t<c.x;t+=1)for(i=0;i<c.y;i+=1)if(s=this.wrapTile(u.x+t),o=u.y+i,0<=s&&s<f&&0<=o&&o<f){switch((e=new Image).cx=t,e.cy=i,e.crossOrigin="",e.onload=S,e.onerror=g,x.loading+=1,this.api.type){case"zxy":r=this.zoom+"/"+s+"/"+o;break;case"zyx":r=this.zoom+"/"+o+"/"+s;break;case"xyz":r=s+"/"+o+"/"+this.zoom}e.src="https://"+(this.api.subdomains?this.api.subdomains[M]+".":"")+this.api.url+"/"+r+".png"+(this.api.key||""),this.api.subdomains&&(M+=1)===this.api.subdomains.length&&(M=0)}},WorldMap.prototype.initializeCredits=function(){var t;this.creditsTxt=new StringMorph(" "+this.api.credits+" ",8),normalizeCanvas(this.creditsTxt.image),this.creditsBG=newCanvas(this.creditsTxt.extent(),!0),(t=this.creditsBG.getContext("2d")).fillStyle="white",t.fillRect(0,0,this.creditsBG.width,this.creditsBG.height)},WorldMap.prototype.addCredits=function(){var t=this.canvas.getContext("2d"),i=this.creditsTxt.image;t.globalAlpha=.5,t.drawImage(this.creditsBG,this.canvas.width-i.width,this.canvas.height-i.height),t.globalAlpha=1,t.drawImage(i,this.canvas.width-i.width,this.canvas.height-i.height)};</script>
        <script>var ReadStream,XML_Element;function ReadStream(t){this.contents=t||"",this.index=0}function XML_Element(t,e,n){this.init(t,e,n)}modules.xml="2018-November-12",ReadStream.prototype.nonSpace=/\S|$/g,ReadStream.prototype.nonWord=/[\s\>\/\=]|$/g,ReadStream.prototype.next=function(t){var e,n;return void 0===t?(e=this.contents[this.index],this.index+=1,e):(n=this.index,this.index+=t,this.contents.slice(n,this.index))},ReadStream.prototype.peek=function(){return this.contents[this.index]},ReadStream.prototype.skip=function(t){this.index+=t||1},ReadStream.prototype.atEnd=function(){return this.index>this.contents.length-1},ReadStream.prototype.upTo=function(t){var e=this.contents.indexOf(t,this.index);return-1===e?"":this.contents.slice(this.index,this.index=e)},ReadStream.prototype.peekUpTo=function(t){var e=this.contents.indexOf(t,this.index);return-1===e?"":this.contents.slice(this.index,e)},ReadStream.prototype.skipSpace=function(){this.nonSpace.lastIndex=this.index;var t=this.nonSpace.exec(this.contents);t&&(this.index=t.index)},ReadStream.prototype.word=function(){this.nonWord.lastIndex=this.index;var t=this.nonWord.exec(this.contents);return t?this.contents.slice(this.index,this.index=t.index):""},XML_Element.prototype=Object.create(Node.prototype),(XML_Element.prototype.constructor=XML_Element).uber=Node.prototype,XML_Element.prototype.indentation="  ",XML_Element.prototype.init=function(t,e,n){this.tag=t||"unnamed",this.attributes={},this.contents=e||"",XML_Element.uber.init.call(this),n&&n.addChild(this)},XML_Element.prototype.require=function(t,e){var n=this.childNamed(t);if(n)return n;if(e instanceof Function)return e();if(!isNil(e))return e;throw new Error("Missing required element <"+t+">!")},XML_Element.prototype.childNamed=function(e){return detect(this.children,function(t){return t.tag===e})},XML_Element.prototype.childrenNamed=function(e){return this.children.filter(function(t){return t.tag===e})},XML_Element.prototype.parentNamed=function(t){return this.tag===t?this:this.parent?this.parent.parentNamed(t):null},XML_Element.prototype.toString=function(e,t){var n,i,r="",o="",s=t||0;if(e){for(i=0;i<s;i+=1)o+=this.indentation;r+=o}for(n in r+="<"+this.tag,this.attributes)Object.prototype.hasOwnProperty.call(this.attributes,n)&&this.attributes[n]&&(r+=" "+n+'="'+this.escape(this.attributes[n])+'"');return this.contents.length||this.children.length?(r+=">",r+=this.escape(this.contents),this.children.forEach(function(t){e&&(r+="\n"),r+=t.toString(e,s+1)}),e&&this.children.length&&(r+="\n"+o),r+="</"+this.tag+">"):r+="/>",r},XML_Element.prototype.escape=function(t,e){for(var n,i=isNil(t)?"":t.toString(),r="",o=0;o<i.length;o+=1)switch(n=i[o]){case"'":r+="&apos;";break;case'"':r+=e?n:"&quot;";break;case"<":r+="&lt;";break;case">":r+="&gt;";break;case"&":r+="&amp;";break;case"\n":r+="&#xD;";break;case"~":r+="&#126;";break;default:r+=n}return r},XML_Element.prototype.unescape=function(t){return t.replace(/&(amp|apos|quot|lt|gt|#xD|#126);/g,function(t,e){switch(e){case"amp":return"&";case"apos":return"'";case"quot":return'"';case"lt":return"<";case"gt":return">";case"#xD":return"\n";case"#126":return"~";default:console.warn("unreachable")}})},XML_Element.prototype.parseString=function(t){var e=new ReadStream(t);e.upTo("<"),e.skip(),this.parseStream(e)},XML_Element.prototype.parseStream=function(t){var e,n,i;for(this.tag=t.word(),t.skipSpace(),i=t.peek();">"!==i&&"/"!==i;){if(e=t.word(),t.skipSpace(),"="!==t.next())throw new Error('Expected "=" after attribute name');if(t.skipSpace(),'"'!==(i=t.next())&&"'"!==i)throw new Error("Expected single- or double-quoted attribute value");n=t.upTo(i),t.skip(1),t.skipSpace(),this.attributes[e]=this.unescape(n),i=t.peek()}if("/"!==i){if(">"!==t.next())throw new Error('Expected ">" after tag name and attributes');for(;!t.atEnd();)if("<"===(i=t.next())){if("/"===t.peek()){if(t.skip(),t.word()!==this.tag)throw new Error("Expected to close "+this.tag);return t.upTo(">"),t.skip(),void(this.contents=this.unescape(this.contents))}new XML_Element(null,null,this).parseStream(t)}else this.contents+=i}else if(t.skip(),">"!==t.next())throw new Error('Expected ">" after "/" in empty tag')};</script>
        <script>function XML_Serializer(){this.contents=[],this.media=[],this.isCollectingMedia=!1,this.isExportingBlocksLibrary=!1}var SnapSerializer;function SnapSerializer(){this.init()}modules.store="2019-June-02",XML_Serializer.prototype.idProperty="serializationID",XML_Serializer.prototype.mediaIdProperty="serializationMediaID",XML_Serializer.prototype.mediaDetectionProperty="isMedia",XML_Serializer.prototype.version=1,XML_Serializer.prototype.serialize=function(t,e){var o;return this.flush(),this.flushMedia(),this.isExportingBlocksLibrary=e,o=this.store(t),this.flush(),o},XML_Serializer.prototype.store=function(t,e){return isNil(t)||!t.toXML?"":this.isCollectingMedia&&t[this.mediaDetectionProperty]?(this.addMedia(t,e),this.format('<ref mediaID="@"></ref>',t[this.mediaIdProperty])):t[this.idProperty]?this.format('<ref id="@"></ref>',t[this.idProperty]):(this.add(t),t.toXML(this,e).replace("~",this.format('id="@"',t[this.idProperty])))},XML_Serializer.prototype.mediaXML=function(){var o="<media>",r=this;return this.media.forEach(function(t){var e=t.toXML(r).replace("~",r.format('mediaID="@"',t[r.mediaIdProperty]));o+=e}),o+"</media>"},XML_Serializer.prototype.add=function(t){return t[this.idProperty]?-1:(this.contents.push(t),t[this.idProperty]=this.contents.length,this.contents.length)},XML_Serializer.prototype.addMedia=function(t,e){return t[this.mediaIdProperty]?-1:(this.media.push(t),t[this.mediaIdProperty]=e?e+"_"+t.name:this.media.length,this.media.length)},XML_Serializer.prototype.at=function(t){return this.contents[t-1]},XML_Serializer.prototype.flush=function(){var e=this;this.contents.forEach(function(t){delete t[e.idProperty]}),this.contents=[]},XML_Serializer.prototype.flushMedia=function(){var e=this;this.media instanceof Array&&this.media.forEach(function(t){delete t[e.mediaIdProperty]}),this.media=[],this.isExportingBlocksLibrary=!1},XML_Serializer.prototype.escape=XML_Element.prototype.escape,XML_Serializer.prototype.unescape=XML_Element.prototype.unescape,XML_Serializer.prototype.format=function(t){var o,r=this,i=-1,a=arguments;return t.replace(/[@$%]([\d]+)?/g,function(t,e){return e=parseInt(e,10),o=isNaN(e)?a[(i+=1)+1]:a[e+1],"@"===t?r.escape(o):"$"===t?r.escape(o,!0):o})},XML_Serializer.prototype.load=function(t){throw nop(t),new Error("loading should be implemented in heir of XML_Serializer")},XML_Serializer.prototype.parse=function(t){var e=new XML_Element;return e.parseString(t),e},SnapSerializer.prototype=new XML_Serializer,(SnapSerializer.prototype.constructor=SnapSerializer).uber=XML_Serializer.prototype,SnapSerializer.prototype.app="Snap! 5.0, http://snap.berkeley.edu",SnapSerializer.prototype.thumbnailSize=new Point(160,120),SnapSerializer.prototype.watcherLabels={xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",reportShown:"shown?",getTempo:"tempo",getVolume:"volume",getPan:"balance",getPenDown:"pen down?",getLastAnswer:"answer",getLastMessage:"message",getTimer:"timer",getCostumeIdx:"costume #",reportMouseX:"mouse x",reportMouseY:"mouse y",reportThreadCount:"processes"},SnapSerializer.prototype.init=function(){this.project={},this.objects={},this.mediaDict={}},XML_Serializer.prototype.mediaXML=function(t){var o='<media name="'+(t||"untitled")+'" app="'+this.app+'" version="'+this.version+'">',r=this;return this.media.forEach(function(t){var e=t.toXML(r).replace("~",r.format('mediaID="@"',t[r.mediaIdProperty]));o+=e}),o+"</media>"},SnapSerializer.prototype.load=function(t,e){return this.loadProjectModel(this.parse(t),e)},SnapSerializer.prototype.loadProjectModel=function(t,e,o){var r=t.attributes.app,i=r?r.split(" ")[0]:null;return e&&i&&i!==this.app.split(" ")[0]&&e.inform(i+" Project","This project has been created by a different app:\n\n"+i+"\n\nand may be incompatible or fail to load here."),this.rawLoadProjectModel(t,o)},SnapSerializer.prototype.rawLoadProjectModel=function(t,e){var o,r,n=this,l={sprites:{}};if(this.project=l,o={project:t},+t.attributes.version>this.version)throw"Project uses newer version of Serializer";if(this.objects={},l.name=o.project.attributes.name,!l.name){for(r=1;Object.prototype.hasOwnProperty.call(localStorage,"-snap-project-Untitled "+r);)r+=1;l.name="Untitled "+r}return o.notes=o.project.childNamed("notes"),o.notes&&(l.notes=o.notes.contents),o.globalVariables=o.project.childNamed("variables"),l.globalVariables=new VariableFrame,o.stage=o.project.require("stage"),StageMorph.prototype.frameRate=0,l.stage=new StageMorph(l.globalVariables),l.stage.remixID=e,Object.prototype.hasOwnProperty.call(o.stage.attributes,"id")&&(this.objects[o.stage.attributes.id]=l.stage),o.stage.attributes.name&&(l.stage.name=o.stage.attributes.name),o.stage.attributes.color&&(l.stage.color=this.loadColor(o.stage.attributes.color),l.stage.cachedHSV=l.stage.color.hsv()),"true"===o.stage.attributes.scheduled&&(l.stage.fps=30,StageMorph.prototype.frameRate=30),o.stage.attributes.volume&&(l.stage.volume=+o.stage.attributes.volume),o.stage.attributes.pan&&(l.stage.pan=+o.stage.attributes.pan),o.pentrails=o.stage.childNamed("pentrails"),o.pentrails&&(l.pentrails=new Image,l.pentrails.onload=function(){l.stage.trailsCanvas&&(normalizeCanvas(l.stage.trailsCanvas),l.stage.trailsCanvas.getContext("2d").drawImage(l.pentrails,0,0),l.stage.changed())},l.pentrails.src=o.pentrails.contents),l.stage.setTempo(o.stage.attributes.tempo),StageMorph.prototype.dimensions=new Point(480,360),o.stage.attributes.width&&(StageMorph.prototype.dimensions.x=Math.max(+o.stage.attributes.width,240)),o.stage.attributes.height&&(StageMorph.prototype.dimensions.y=Math.max(+o.stage.attributes.height,180)),l.stage.setExtent(StageMorph.prototype.dimensions),SpriteMorph.prototype.useFlatLineEnds="flat"===o.stage.attributes.lines,BooleanSlotMorph.prototype.isTernary="false"!==o.stage.attributes.ternary,l.stage.isThreadSafe="true"===o.stage.attributes.threadsafe,StageMorph.prototype.enableCodeMapping="true"===o.stage.attributes.codify,StageMorph.prototype.enableInheritance="false"!==o.stage.attributes.inheritance,StageMorph.prototype.enableSublistIDs="true"===o.stage.attributes.sublistIDs,o.hiddenPrimitives=o.project.childNamed("hidden"),o.hiddenPrimitives&&o.hiddenPrimitives.contents.split(" ").forEach(function(t){t&&(StageMorph.prototype.hiddenPrimitives[t]=!0)}),o.codeHeaders=o.project.childNamed("headers"),o.codeHeaders&&o.codeHeaders.children.forEach(function(t){StageMorph.prototype.codeHeaders[t.tag]=t.contents}),o.codeMappings=o.project.childNamed("code"),o.codeMappings&&o.codeMappings.children.forEach(function(t){StageMorph.prototype.codeMappings[t.tag]=t.contents}),o.globalBlocks=o.project.childNamed("blocks"),o.globalBlocks&&(this.loadCustomBlocks(l.stage,o.globalBlocks,!0),this.populateCustomBlocks(l.stage,o.globalBlocks,!0)),this.loadObject(l.stage,o.stage),o.sprites=o.stage.require("sprites"),l.sprites[l.stage.name]=l.stage,o.sprites.childrenNamed("sprite").forEach(function(t){n.loadValue(t)}),n.project.stage.children.forEach(function(t){var e,o;t.inheritanceInfo&&((e=n.project.sprites[t.inheritanceInfo.exemplar])&&t.setExemplar(e),t.inheritedAttributes=t.inheritanceInfo.delegated||[],t.updatePropagationCache()),t.nestingInfo&&((o=n.project.sprites[t.nestingInfo.anchor])&&o.attachPart(t),t.rotatesWithAnchor="true"===t.nestingInfo.synch)}),n.project.stage.children.forEach(function(e){var t;e.nestingInfo&&(e.nestingScale=+(e.nestingInfo.scale||e.scale),delete e.nestingInfo),["scripts","costumes","sounds"].forEach(function(t){e.inheritsAttribute(t)&&e.refreshInheritedAttribute(t)}),e.inheritsAttribute("costumes")&&(t=e.costumes.asArray()[e.inheritanceInfo.costumeNumber-1])&&(t.loaded?e.wearCostume(t,!0):t.loaded=function(){e.wearCostume(t,!0),this.loaded=!0}),delete e.inheritanceInfo}),o.globalVariables&&this.loadVariables(l.globalVariables,o.globalVariables),this.objects={},o.sprites.childrenNamed("watcher").forEach(function(t){var e,o,r=n.loadColor(t.attributes.color),i=Object.prototype.hasOwnProperty.call(t.attributes,"scope")?l.sprites[t.attributes.scope]:null,a=Object.prototype.hasOwnProperty.call(t.attributes,"hidden")&&"false"!==t.attributes.hidden,s=Object.prototype.hasOwnProperty.call(t.attributes,"var")?new WatcherMorph(t.attributes.var,r,isNil(i)?l.globalVariables:i.variables,t.attributes.var,a):new WatcherMorph(localize(n.watcherLabels[t.attributes.s]),r,i,t.attributes.s,a);s.setStyle(t.attributes.style||"normal"),"slider"===s.style&&(s.setSliderMin(t.attributes.min||"1",!0),s.setSliderMax(t.attributes.max||"100",!0)),s.setPosition(l.stage.topLeft().add(new Point(+t.attributes.x||0,+t.attributes.y||0))),l.stage.add(s),s.onNextStep=function(){this.currentValue=null},s.currentValue instanceof List&&((e=t.attributes.extX)&&s.cellMorph.contentsMorph.setWidth(+e),(o=t.attributes.extY)&&s.cellMorph.contentsMorph.setHeight(+o),s.cellMorph.contentsMorph.handle.drawNew())}),n.project.stage.children.forEach(function(t){t.inheritedMethodsCache=[]}),this.objects={},l},SnapSerializer.prototype.loadBlocks=function(t,e){var o,r=new StageMorph;if(this.project={stage:r,sprites:{},targetStage:e},+(o=this.parse(t)).attributes.version>this.version)throw"Module uses newer version of Serializer";return this.loadCustomBlocks(r,o,!0),this.populateCustomBlocks(r,o,!0),this.objects={},r.globalBlocks.forEach(function(t){t.receiver=null}),this.objects={},this.project={},this.mediaDict={},r.globalBlocks},SnapSerializer.prototype.loadSprites=function(t,o){var e,r=this,i=this.project={globalVariables:o.globalVariables,stage:o.stage,sprites:{}};if(i.sprites[i.stage.name]=i.stage,+(e=this.parse(t)).attributes.version>this.version)throw"Module uses newer version of Serializer";e.childrenNamed("sprite").forEach(function(t){var e=new SpriteMorph(i.globalVariables);t.attributes.id&&(r.objects[t.attributes.id]=e),t.attributes.name&&(e.name=o.newSpriteName(t.attributes.name),i.sprites[e.name]=e),t.attributes.color&&(e.color=r.loadColor(t.attributes.color),e.cachedHSV=e.color.hsv()),t.attributes.pen&&(e.penPoint=t.attributes.pen),t.attributes.volume&&(e.volume=+t.attributes.volume),t.attributes.pan&&(e.pan=+t.attributes.pan),i.stage.add(e),o.sprites.add(e),e.scale=parseFloat(t.attributes.scale||"1"),e.rotationStyle=parseFloat(t.attributes.rotation||"1"),e.isDraggable="false"!==t.attributes.draggable,e.isVisible="true"!==t.attributes.hidden,e.heading=parseFloat(t.attributes.heading)||0,e.drawNew(),e.gotoXY(+t.attributes.x||0,+t.attributes.y||0),r.loadObject(e,t)}),i.stage.children.forEach(function(t){var e,o;t.inheritanceInfo&&(e=i.sprites[t.inheritanceInfo.exemplar])&&t.setExemplar(e),t.nestingInfo&&((o=i.sprites[t.nestingInfo.anchor])&&o.attachPart(t),t.rotatesWithAnchor="true"===t.nestingInfo.synch)}),i.stage.children.forEach(function(t){delete t.inheritanceInfo,t.nestingInfo&&(t.nestingScale=+(t.nestingInfo.scale||t.scale),delete t.nestingInfo)}),this.objects={},this.project={},this.mediaDict={},o.createCorral(),o.fixLayout()},SnapSerializer.prototype.loadMedia=function(t){return this.loadMediaModel(this.parse(t))},SnapSerializer.prototype.loadMediaModel=function(t){var e=this,o=t;if(this.mediaDict={},+o.attributes.version>this.version)throw"Module uses newer version of Serializer";return o.children.forEach(function(t){e.loadValue(t)}),this.mediaDict},SnapSerializer.prototype.loadObject=function(t,e){var o=e.require("blocks"),r=e.childNamed("dispatches");e.attributes.instrument&&(t.instrument=+e.attributes.instrument),this.loadInheritanceInfo(t,e),this.loadNestingInfo(t,e),t.inheritanceInfo&&t.inheritanceInfo.delegated instanceof Array&&contains(t.inheritanceInfo.delegated,"costumes")||this.loadCostumes(t,e),t.inheritanceInfo&&t.inheritanceInfo.delegated instanceof Array&&contains(t.inheritanceInfo.delegated,"sounds")||this.loadSounds(t,e),this.loadCustomBlocks(t,o),r&&this.loadCustomBlocks(t,r,!1,!0),this.populateCustomBlocks(t,o),this.loadVariables(t.variables,e.require("variables"),t),t.inheritanceInfo&&t.inheritanceInfo.delegated instanceof Array&&contains(t.inheritanceInfo.delegated,"scripts")||this.loadScripts(t,t.scripts,e.require("scripts"))},SnapSerializer.prototype.loadInheritanceInfo=function(t,e){var o,r=e.childNamed("inherit");r&&(t.inheritanceInfo=r.attributes,(o=r.childNamed("list"))&&(t.inheritanceInfo.delegated=this.loadValue(o).asArray()),t.inheritanceInfo.costumeNumber=e.attributes.costume)},SnapSerializer.prototype.loadNestingInfo=function(t,e){var o=e.childNamed("nest");o&&(t.nestingInfo=o.attributes)},SnapSerializer.prototype.loadCostumes=function(t,e){var o,r=e.childNamed("costumes");r&&(t.costumes=this.loadValue(r.require("list",function(){return console.log(t.name+": missing required costumes list, improvising..."),new XML_Element("list")})),t.costumes.type="costume"),Object.prototype.hasOwnProperty.call(e.attributes,"costume")&&(o=t.costumes.asArray()[e.attributes.costume-1])&&(o.loaded?t.wearCostume(o,!0):o.loaded=function(){t.wearCostume(o,!0),this.loaded=!0})},SnapSerializer.prototype.loadSounds=function(t,e){var o=e.childNamed("sounds");o&&(t.sounds=this.loadValue(o.require("list",function(){return console.log(t.name+": missing required sounds list, improvising..."),new XML_Element("list")})),t.sounds.type="sound")},SnapSerializer.prototype.loadVariables=function(r,t,i){var a=this;t.children.forEach(function(t){var e,o;"variable"===t.tag&&(o=t.children[0],(e=new Variable).isTransient="true"===t.attributes.transient,e.value=e.isTransient||!o?0:a.loadValue(o,i),r.vars[t.attributes.name]=e)})},SnapSerializer.prototype.loadCustomBlocks=function(p,t,h,u){var d=this;t.children.forEach(function(t){var o,r,e,i,a,s,n,l,c;"block-definition"===t.tag&&((o=new CustomBlockDefinition(t.attributes.s||"",p)).category=t.attributes.category||"other",o.type=t.attributes.type||"command",o.isGlobal=!0===h,u?p.inheritedMethodsCache.push(o):o.isGlobal?p.globalBlocks.push(o):p.customBlocks.push(o),r=o.parseSpec(o.spec).filter(function(t){return"%"===t.charAt(0)&&1<t.length}).map(function(t){return t.substr(1)}),o.names=r,(e=t.childNamed("inputs"))&&(c=-1,e.children.forEach(function(t){var e=t.childNamed("options");"input"===t.tag&&(c+=1,o.declarations.set(r[c],[t.attributes.type,contains(["%b","%boolUE"],t.attributes.type)?t.contents?"true"===t.contents:null:t.contents,e?e.contents:void 0,"true"===t.attributes.readonly]))})),(i=t.childNamed("variables"))&&(o.variableNames=d.loadValue(i.require("list")).asArray()),(a=t.childNamed("header"))&&(o.codeHeader=a.contents),(s=t.childNamed("code"))&&(o.codeMapping=s.contents),(n=t.childNamed("translations"))&&o.updateTranslations(n.contents),(l=t.childNamed("comment"))&&(o.comment=d.loadComment(l)))})},SnapSerializer.prototype.populateCustomBlocks=function(a,t,s){var n=this;t.children.forEach(function(t,e){var o,r,i;"block-definition"===t.tag&&(o=s?a.globalBlocks[e]:a.customBlocks[e],(r=t.childNamed("script"))&&(o.body=new Context(null,r?n.loadScript(r,a):null,null,a),o.body.inputs=o.names.slice(0)),(i=t.childNamed("scripts"))&&(o.scripts=n.loadScriptsArray(i,a)),delete o.names)})},SnapSerializer.prototype.loadScripts=function(o,r,t){var i=this,a=SyntaxElementMorph.prototype.scale;r.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture,t.children.forEach(function(t){var e;if("script"===t.tag){if(!(e=i.loadScript(t,o)))return;e.setPosition(new Point((+t.attributes.x||0)*a,(+t.attributes.y||0)*a).add(r.topLeft())),r.add(e),e.fixBlockColor(null,!0),e.allComments().forEach(function(t){t.align(e)})}else if("comment"===t.tag){if(!(e=i.loadComment(t)))return;e.setPosition(new Point((+t.attributes.x||0)*a,(+t.attributes.y||0)*a).add(r.topLeft())),r.add(e)}})},SnapSerializer.prototype.loadScriptsArray=function(t,o){var r=this,i=SyntaxElementMorph.prototype.scale,a=[];return t.children.forEach(function(t){var e;if("script"===t.tag){if(!(e=r.loadScript(t,o)))return;e.setPosition(new Point((+t.attributes.x||0)*i,(+t.attributes.y||0)*i)),a.push(e),e.fixBlockColor(null,!0)}else if("comment"===t.tag){if(!(e=r.loadComment(t)))return;e.setPosition(new Point((+t.attributes.x||0)*i,(+t.attributes.y||0)*i)),a.push(e)}}),a},SnapSerializer.prototype.loadScript=function(t,e){var o,r,i,a=this;return this.project.stage||(this.project.stage=e.parentThatIsA(StageMorph),this.project.targetStage=this.project.stage),t.children.forEach(function(t){if(i=a.loadBlock(t,!1,e)){if(r){if(!(r.nextBlock&&i instanceof CommandBlockMorph))return console.log("SNAP: expecting a command but getting a reporter:\n  "+r.blockSpec+"\n  "+i.blockSpec),o;r.nextBlock(i)}else o=i;r=i}}),o},SnapSerializer.prototype.loadComment=function(t){var e=new CommentMorph(t.contents),o=SyntaxElementMorph.prototype.scale;return e.isCollapsed="true"===t.attributes.collapsed,e.setTextWidth(t.attributes.w*o),e},SnapSerializer.prototype.loadBlock=function(e,t,o){var r,i,a,s,n,l,c=0;if("block"===e.tag)Object.prototype.hasOwnProperty.call(e.attributes,"var")?r=SpriteMorph.prototype.variableBlock(e.attributes.var):(r=SpriteMorph.prototype.blockForSelector(e.attributes.s),(l=SpriteMorph.prototype.blockMigrations[e.attributes.s])&&(c=l.offset));else if("custom-block"===e.tag){if(n=(s=!e.attributes.scope)?this.project.stage:o,s?!(i=detect(n.globalBlocks,function(t){return t.blockSpec()===e.attributes.s}))&&this.project.targetStage&&(i=detect(this.project.targetStage.globalBlocks,function(t){return t.blockSpec()===e.attributes.s})):i=detect(n.customBlocks,function(t){return t.blockSpec()===e.attributes.s})||(n.inheritedMethodsCache?detect(n.inheritedMethodsCache,function(t){return t.blockSpec()===e.attributes.s}):null),!i||!contains(SpriteMorph.prototype.categories,i.category))return this.obsoleteBlock(t);r="command"===i.type?new CustomCommandBlockMorph(i,!1):new CustomReporterBlockMorph(i,"predicate"===i.type,!1)}return null===r&&(r=this.obsoleteBlock(t)),r.isDraggable=!0,a=r.inputs(),e.children.forEach(function(t,e){"variables"===t.tag?this.loadVariables(r.variables,t,o):"comment"===t.tag?(r.comment=this.loadComment(t),r.comment.block=r):"receiver"===t.tag?nop():this.loadInput(t,a[e+c],r,o)},this),r.cachedInputs=null,r},SnapSerializer.prototype.obsoleteBlock=function(t){var e=new(t?ReporterBlockMorph:CommandBlockMorph);return e.selector="errorObsolete",e.color=new Color(200,0,20),e.setSpec("Obsolete!"),e.isDraggable=!0,e},SnapSerializer.prototype.loadInput=function(t,e,o,r){var i,a,s=this;if(!isNil(e))if("script"===t.tag)(i=this.loadScript(t,r))&&("reifyReporter"===o.selector?e.silentReplaceInput(e.children[0],i):e.add(i),e.fixLayout());else if("autolambda"===t.tag&&t.children[0])(i=this.loadBlock(t.children[0],!0,r))&&(e.silentReplaceInput(e.children[0],i),e.fixLayout());else if("list"===t.tag){for(;0<e.inputs().length;)e.removeInput();t.children.forEach(function(t){e.addInput(),s.loadInput(t,e.children[e.children.length-2],e,r)}),e.fixLayout()}else"block"===t.tag||"custom-block"===t.tag?o.silentReplaceInput(e,this.loadBlock(t,!0,r)):"color"===t.tag?e.setColor(this.loadColor(t.contents)):(a=this.loadValue(t),isNil(a)||isNil(e)||!e.setContents||e.setContents(this.loadValue(t)))},SnapSerializer.prototype.loadValue=function(i,a){var s,e,t,n,o,r,l,c,p,h,u,d,m,b,f=this;function g(){Object.prototype.hasOwnProperty.call(i.attributes,"id")&&(f.objects[i.attributes.id]=s),Object.prototype.hasOwnProperty.call(i.attributes,"mediaID")&&(f.mediaDict[i.attributes.mediaID]=s)}switch(i.tag){case"ref":if(Object.prototype.hasOwnProperty.call(i.attributes,"id"))return this.objects[i.attributes.id];if(Object.prototype.hasOwnProperty.call(i.attributes,"mediaID"))return this.mediaDict[i.attributes.mediaID];throw new Error("expecting a reference id");case"l":return(h=i.childNamed("option"))?[h.contents]:(u=i.childNamed("bool"))?this.loadValue(u):(m=i.childNamed("wish"))?this.loadValue(m):i.contents;case"bool":return"true"===i.contents;case"list":return i.attributes.hasOwnProperty("linked")?"atomic"===i.attributes.struct?((s=Process.prototype.parseCSV(i.contents)).becomeLinked(),g(),s):((s=new List).isLinked=!0,g(),t=s,(n=i.childrenNamed("item")).forEach(function(t,e){var o=t.children[0];s.first=o?f.loadValue(o,a):0;var r=i.childNamed("list")||i.childNamed("ref");r?s.rest=f.loadValue(r,a):e<n.length-1&&(s.rest=new List,(s=s.rest).isLinked=!0)}),t):("atomic"===i.attributes.struct?(s=Process.prototype.parseCSV(i.contents),g()):(s=new List,g(),s.contents=i.childrenNamed("item").map(function(t){var e=t.children[0];return e?f.loadValue(e,a):0})),s);case"sprite":return s=new SpriteMorph(f.project.globalVariables),i.attributes.id&&(f.objects[i.attributes.id]=s),i.attributes.name&&(s.name=i.attributes.name,f.project.sprites[i.attributes.name]=s),i.attributes.idx&&(s.idx=+i.attributes.idx),i.attributes.color&&(s.color=f.loadColor(i.attributes.color),s.cachedHSV=s.color.hsv()),i.attributes.pen&&(s.penPoint=i.attributes.pen),i.attributes.volume&&(s.volume=+i.attributes.volume),i.attributes.pan&&(s.pan=+i.attributes.pan),f.project.stage.add(s),s.scale=parseFloat(i.attributes.scale||"1"),s.rotationStyle=parseFloat(i.attributes.rotation||"1"),s.isDraggable="false"!==i.attributes.draggable,s.isVisible="true"!==i.attributes.hidden,s.heading=parseFloat(i.attributes.heading)||0,s.drawNew(),s.gotoXY(+i.attributes.x||0,+i.attributes.y||0),f.loadObject(s,i),s;case"context":return s=new Context(null),g(),(o=(o=i.childNamed("origin"))&&(o.childNamed("ref")||o.childNamed("sprite")))&&(s.origin=this.loadValue(o)),(o=(o=i.childNamed("receiver"))&&(o.childNamed("ref")||o.childNamed("sprite")))&&(s.receiver=this.loadValue(o)),d=s.origin||s.receiver||a,(o=i.childNamed("script"))?s.expression=this.loadScript(o,d):(o=i.childNamed("block")||i.childNamed("custom-block"))?s.expression=this.loadBlock(o,null,d):(o=i.childNamed("l"))&&(u=o.childNamed("bool"),s.expression=u?new BooleanSlotMorph(this.loadValue(u)):new InputSlotMorph(o.contents)),s.expression instanceof BlockMorph&&(e=0,s.expression.allEmptySlots().forEach(function(t){e+=1,t instanceof MultiArgMorph?t.bindingID=["arguments"]:t.bindingID=e}),s.emptySlots=e),(o=i.childNamed("inputs"))&&o.children.forEach(function(t){"input"===t.tag&&s.inputs.push(t.contents)}),(o=i.childNamed("variables"))&&this.loadVariables(s.variables,o,d),(o=i.childNamed("context"))&&(s.outerContext=this.loadValue(o,d)),s.outerContext&&s.receiver&&!s.outerContext.variables.parentFrame&&(s.outerContext.variables.parentFrame=s.receiver.variables),s;case"costume":return r=new Point,Object.prototype.hasOwnProperty.call(i.attributes,"center-x")&&(r.x=parseFloat(i.attributes["center-x"])),Object.prototype.hasOwnProperty.call(i.attributes,"center-y")&&(r.y=parseFloat(i.attributes["center-y"])),Object.prototype.hasOwnProperty.call(i.attributes,"name")&&(c=i.attributes.name),Object.prototype.hasOwnProperty.call(i.attributes,"image")&&(l=new Image,0!==i.attributes.image.indexOf("data:image/svg+xml")||MorphicPreferences.rasterizeSVGs?(s=new Costume(null,c,r),l.onload=function(){var t=newCanvas(new Point(l.width,l.height),!0);t.getContext("2d").drawImage(l,0,0),s.contents=t,s.version=+new Date,"function"==typeof s.loaded?s.loaded():s.loaded=!0}):(s=new SVG_Costume(null,c,r),l.onload=function(){s.contents=l,s.version=+new Date,"function"==typeof s.loaded?s.loaded():s.loaded=!0}),l.src=i.attributes.image),g(),s;case"sound":return(p=new Audio).src=i.attributes.sound,s=new Sound(p,i.attributes.name),Object.prototype.hasOwnProperty.call(i.attributes,"mediaID")&&(f.mediaDict[i.attributes.mediaID]=s),g(),s;case"wish":return(b=new CustomBlockDefinition(i.attributes.s)).type=i.attributes.type,b.category=i.attributes.category,b.storedSemanticSpec=i.attributes.s,b.updateTranslations(i.contents),b.blockInstance(!0)}},SnapSerializer.prototype.loadColor=function(t){var e=(t||"").split(",");return new Color(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]))},SnapSerializer.prototype.openProject=function(t,e){var o,r=e.stage,i=[];t&&t.stage&&(e.projectName=t.name,e.projectNotes=t.notes||"",e.globalVariables&&(e.globalVariables=t.globalVariables),r&&r.destroy(),e.add(t.stage),e.stage=t.stage,(i=e.stage.children.filter(function(t){return t instanceof SpriteMorph})).sort(function(t,e){return t.idx-e.idx}),e.sprites=new List(i),o=i[0]||t.stage,0<sizeOf(this.mediaDict)?(e.hasChangedMedia=!1,this.mediaDict={}):e.hasChangedMedia=!0,t.stage.drawNew(),e.createCorral(),e.selectSprite(o),e.fixLayout(),e.world().keyboardReceiver=t.stage)},Array.prototype.toXML=function(o){return this.reduce(function(t,e){return t+o.store(e)},"")},StageMorph.prototype.toXML=function(t){var e,o=normalizeCanvas(this.thumbnail(SnapSerializer.prototype.thumbnailSize),!0),r=this.parentThatIsA(IDE_Morph);try{e=o.toDataURL("image/png")}catch(t){e=null}function i(e){var o="";return Object.keys(StageMorph.prototype[e]).forEach(function(t){o+="<"+t+">"+XML_Element.prototype.escape(StageMorph.prototype[e][t])+"</"+t+">"}),o}return this.removeAllClones(),t.format('<project name="@" app="@" version="@"><notes>$</notes><thumbnail>$</thumbnail><stage name="@" width="@" height="@" costume="@" color="@,@,@,@" tempo="@" threadsafe="@" %volume="@" pan="@" lines="@" ternary="@" codify="@" inheritance="@" sublistIDs="@" scheduled="@" ~><pentrails>$</pentrails><costumes>%</costumes><sounds>%</sounds><variables>%</variables><blocks>%</blocks><scripts>%</scripts><sprites>%</sprites></stage><hidden>$</hidden><headers>%</headers><code>%</code><blocks>%</blocks><variables>%</variables></project>',r&&r.projectName?r.projectName:localize("Untitled"),t.app,t.version,r&&r.projectNotes?r.projectNotes:"",e,this.name,StageMorph.prototype.dimensions.x,StageMorph.prototype.dimensions.y,this.getCostumeIdx(),this.color.r,this.color.g,this.color.b,this.color.a,this.getTempo(),this.isThreadSafe,this.instrument?' instrument="'+parseInt(this.instrument)+'" ':"",this.volume,this.pan,SpriteMorph.prototype.useFlatLineEnds?"flat":"round",BooleanSlotMorph.prototype.isTernary,this.enableCodeMapping,this.enableInheritance,this.enableSublistIDs,0!==StageMorph.prototype.frameRate,normalizeCanvas(this.trailsCanvas,!0).toDataURL("image/png"),t.store(this.costumes,this.name+"_cst"),t.store(this.sounds,this.name+"_snd"),t.store(this.variables),t.store(this.customBlocks),t.store(this.scripts),t.store(this.children),Object.keys(StageMorph.prototype.hiddenPrimitives).reduce(function(t,e){return t+" "+e},""),i("codeHeaders"),i("codeMappings"),t.store(this.globalBlocks),r&&r.globalVariables?t.store(r.globalVariables):"")},SpriteMorph.prototype.toXML=function(t){var e=this.parentThatIsA(StageMorph),o=e?e.parentThatIsA(IDE_Morph):null,r=o?o.sprites.asArray().indexOf(this)+1:0,i=this.inheritsAttribute("costumes"),a=this.inheritsAttribute("sounds"),s=this.inheritsAttribute("scripts");return t.format('<sprite name="@" idx="@" x="@" y="@" heading="@" scale="@" volume="@" pan="@" rotation="@"% draggable="@"% costume="@" color="@,@,@,@" pen="@" ~>%%'+(i?"%":"<costumes>%</costumes>")+(a?"%":"<sounds>%</sounds>")+"<blocks>%</blocks><variables>%</variables>"+(this.exemplar?"<dispatches>%</dispatches>":"%")+(s?"%":"<scripts>%</scripts>")+"</sprite>",this.name,r,this.xPosition(),this.yPosition(),this.heading,this.scale,this.volume,this.pan,this.rotationStyle,this.instrument?' instrument="'+parseInt(this.instrument)+'" ':"",this.isDraggable,this.isVisible?"":' hidden="true"',this.getCostumeIdx(),this.color.r,this.color.g,this.color.b,this.color.a,this.penPoint,this.exemplar?'<inherit exemplar="'+this.exemplar.name+'">'+(this.inheritedAttributes.length?t.store(new List(this.inheritedAttributes)):"")+"</inherit>":"",this.anchor?'<nest anchor="'+this.anchor.name+'" synch="'+this.rotatesWithAnchor+(this.scale===this.nestingScale?"":'" scale="'+this.nestingScale)+'"/>':"",i?"":t.store(this.costumes,this.name+"_cst"),a?"":t.store(this.sounds,this.name+"_snd"),this.customBlocks?t.store(this.customBlocks):"",t.store(this.variables),this.exemplar?t.store(this.inheritedMethods()):"",s?"":t.store(this.scripts))},Costume.prototype[XML_Serializer.prototype.mediaDetectionProperty]=!0,Costume.prototype.toXML=function(t){return t.format('<costume name="@" center-x="@" center-y="@" image="@" ~/>',this.name,this.rotationCenter.x,this.rotationCenter.y,this instanceof SVG_Costume?this.contents.src:normalizeCanvas(this.contents).toDataURL("image/png"))},Sound.prototype[XML_Serializer.prototype.mediaDetectionProperty]=!0,Sound.prototype.toXML=function(t){return t.format('<sound name="@" sound="@" ~/>',this.name,this.toDataURL())},VariableFrame.prototype.toXML=function(i){var a=this;return Object.keys(this.vars).reduce(function(t,e){var o=a.vars[e].value,r=a.vars[e].isTransient?i.format('<variable name="@" transient="true"/>',e):null==o?i.format('<variable name="@"/>',e):i.format('<variable name="@">%</variable>',e,"object"==typeof o?isSnapObject(o)?"":i.store(o):"boolean"==typeof o?i.format("<bool>$</bool>",o):i.format("<l>$</l>",o));return t+r},"")},WatcherMorph.prototype.toXML=function(t){var e=this.target instanceof VariableFrame,o=this.currentValue instanceof List,r=this.readoutColor,i=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();return this.isTemporary()?"":t.format('<watcher% % style="@"% x="@" y="@" color="@,@,@"%%/>',e&&this.target.owner||!e&&this.target?t.format(' scope="@"',e?this.target.owner.name:this.target.name):"",t.format(e?'var="@"':'s="@"',this.getter),this.style,e&&"slider"===this.style?t.format(' min="@" max="@"',this.sliderMorph.start,this.sliderMorph.stop):"",i.x,i.y,r.r,r.g,r.b,o?t.format(' extX="@" extY="@"',this.cellMorph.contentsMorph.width(),this.cellMorph.contentsMorph.height()):"",this.isVisible?"":' hidden="true"')},ScriptsMorph.prototype.toXML=function(o){return this.children.reduce(function(t,e){return e instanceof BlockMorph?t+e.toScriptXML(o,!0):e instanceof CommentMorph&&!e.block?t+e.toXML(o):t},"")},BlockMorph.prototype.toXML=BlockMorph.prototype.toScriptXML=function(t,e){for(var o=SyntaxElementMorph.prototype.scale,r=this,i=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),a=e?t.format('<script x="@" y="@">',i.x/o,i.y/o):"<script>";a+=r.toBlockXML(t),r=r.nextBlock(););return a+="<\/script>"},BlockMorph.prototype.toBlockXML=function(t){return t.format('<block s="@">%%</block>',this.selector,t.store(this.inputs()),this.comment?this.comment.toXML(t):"")},ReporterBlockMorph.prototype.toXML=function(t){return"reportGetVar"===this.selector?this.comment?t.format('<block var="@">%</block>',this.blockSpec,this.comment.toXML(t)):t.format('<block var="@"/>',this.blockSpec):this.toBlockXML(t)},ReporterBlockMorph.prototype.toScriptXML=function(t,e){var o=SyntaxElementMorph.prototype.scale,r=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();return e?t.format('<script x="@" y="@">%<\/script>',r.x/o,r.y/o,this.toXML(t)):t.format("<script>%<\/script>",this.toXML(t))},CustomCommandBlockMorph.prototype.toBlockXML=function(t){var e=this.isGlobal?void 0:"local";return t.format('<custom-block s="@"%>%%%</custom-block>',this.semanticSpec,this.isGlobal?"":t.format(' scope="@"',e),t.store(this.inputs()),this.isGlobal&&this.definition.variableNames.length&&!t.isExportingBlocksLibrary?"<variables>"+this.variables.toXML(t)+"</variables>":"",this.comment?this.comment.toXML(t):"")},CustomReporterBlockMorph.prototype.toBlockXML=CustomCommandBlockMorph.prototype.toBlockXML,CustomBlockDefinition.prototype.toXML=function(o){var r=this;return o.format('<block-definition s="@" type="@" category="@">%'+(this.variableNames.length?"<variables>%</variables>":"@")+"<header>@</header><code>@</code><translations>@</translations><inputs>%</inputs>%%</block-definition>",this.spec,this.type,this.category||"other",this.comment?this.comment.toXML(o):"",this.variableNames.length?o.store(new List(this.variableNames)):"",this.codeHeader||"",this.codeMapping||"",this.translationsAsText(),Array.from(this.declarations.keys()).reduce(function(t,e){return t+o.format('<input type="@"$>$%</input>',r.declarations.get(e)[0],r.declarations.get(e)[3]?' readonly="true"':"",r.declarations.get(e)[1],r.declarations.get(e)[2]?o.format("<options>@</options>",r.declarations.get(e)[2]):"")},""),this.body?o.store(this.body.expression):"",0<this.scripts.length?"<scripts>"+this.scripts.reduce(function(t,e){return e instanceof BlockMorph?t+e.toScriptXML(o,!0):e instanceof CommentMorph&&!e.block?t+e.toXML(o):t},"")+"</scripts>":"")},ArgMorph.prototype.toXML=function(){return"<l/>"},BooleanSlotMorph.prototype.toXML=function(){return"boolean"==typeof this.value?"<l><bool>"+this.value+"</bool></l>":"<l/>"},InputSlotMorph.prototype.toXML=function(t){return this.selectedBlock?t.format('<l><wish s="@" type="@" category="@">@</wish></l>',this.selectedBlock.semanticSpec,this.selectedBlock instanceof CommandBlockMorph?"command":this.selectedBlock.isPredicate?"predicate":"reporter",this.selectedBlock.category,this.selectedBlock.storedTranslations):this.constant?t.format("<l><option>$</option></l>",this.constant):t.format("<l>$</l>",this.contents().text)},TemplateSlotMorph.prototype.toXML=function(t){return t.format("<l>$</l>",this.contents())},CommandSlotMorph.prototype.toXML=function(t){var e=this.nestedBlock();return e instanceof BlockMorph?e instanceof ReporterBlockMorph?t.format("<autolambda>%</autolambda>",t.store(e)):t.store(e):"<script><\/script>"},FunctionSlotMorph.prototype.toXML=CommandSlotMorph.prototype.toXML,MultiArgMorph.prototype.toXML=function(t){return t.format("<list>%</list>",t.store(this.inputs()))},ArgLabelMorph.prototype.toXML=function(t){return t.format("%",t.store(this.inputs()[0]))},ColorSlotMorph.prototype.toXML=function(t){return t.format("<color>$,$,$,$</color>",this.color.r,this.color.g,this.color.b,this.color.a)},List.prototype.toXML=function(o,r){var t,e,i;if(this.hasOnlyAtomicData()&&(!this.isLinked||!StageMorph.prototype.enableSublistIDs))return o.format('<list struct="atomic" '+(this.isLinked?'linked="linked" ':"")+"~>@</list>",this.asCSV());if(this.isLinked){if(t='<list linked="linked" ~>',StageMorph.prototype.enableSublistIDs)return e=this.first,isNil(e)||(t+=o.format("<item>%</item>","object"==typeof e?isSnapObject(e)?"":o.store(e,r):"boolean"==typeof e?o.format("<bool>$</bool>",e):o.format("<l>$</l>",e))),isNil(this.rest)||(t+=o.store(this.rest,r)),t+"</list>";for(i=this;e=i.first,isNil(e)||(t+=o.format("<item>%</item>","object"==typeof e?isSnapObject(e)?"":o.store(e,r):"boolean"==typeof e?o.format("<bool>$</bool>",e):o.format("<l>$</l>",e))),i=i.rest,!isNil(i););return t+"</list>"}return o.format("<list ~>%</list>",this.contents.reduce(function(t,e){return t+o.format("<item>%</item>","object"==typeof e?isSnapObject(e)?"":o.store(e,r):"boolean"==typeof e?o.format("<bool>$</bool>",e):o.format("<l>$</l>",e))},""))},Context.prototype.toXML=function(o){return this.isContinuation?"":o.format("<context ~><inputs>%</inputs><variables>%</variables>%<receiver>%</receiver><origin>%</origin>%</context>",this.inputs.reduce(function(t,e){return t+o.format("<input>$</input>",e)},""),this.variables?o.store(this.variables):"",this.expression?o.store(this.expression):"",this.receiver?o.store(this.receiver):"",this.receiver?o.store(this.origin):"",this.outerContext?o.store(this.outerContext):"")},CommentMorph.prototype.toXML=function(t){var e,o=SyntaxElementMorph.prototype.scale;return this.block?t.format('<comment w="@" collapsed="@">%</comment>',this.textWidth()/o,this.isCollapsed,t.escape(this.text())):(e=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),t.format('<comment x="@" y="@" w="@" collapsed="@">%</comment>',e.x/o,e.y/o,this.textWidth()/o,this.isCollapsed,t.escape(this.text())))};</script>
        <script>var Localizer;modules.locale="2019-June-25";var SnapTranslator=new Localizer;function localize(a){return SnapTranslator.translate(a)}function Localizer(a,n){this.language=a||"en",this.dict=n||{}}Localizer.prototype.translate=function(a){return Object.prototype.hasOwnProperty.call(this.dict[this.language],a)?this.dict[this.language][a]:a},Localizer.prototype.languages=function(){var a,n=[];for(a in this.dict)Object.prototype.hasOwnProperty.call(this.dict,a)&&n.push(a);return n.sort()},Localizer.prototype.languageName=function(a){return this.dict[a].language_name||a},Localizer.prototype.credits=function(){var n="",e=this;return this.languages().forEach(function(a){n=n+"\n"+e.languageName(a)+" ("+a+") - "+e.dict[a].language_translator+" - "+e.dict[a].last_changed}),n},Localizer.prototype.unload=function(){var e,t=["language_name","language_translator","last_changed"],r=this;this.languages().forEach(function(a){var n;if("en"!==a)for(n in e=r.dict[a])Object.prototype.hasOwnProperty.call(e,n)&&!contains(t,n)&&delete e[n]})},SnapTranslator.dict.en={language_name:"English",language_translator:"Jens Mönig","translator_e-mail":"jens@moenig.org",last_changed:"2015-12-22",any:"random","file menu import hint":"load an exported project file\nor block library, a costume\nor a sound","settings menu prefer empty slots hint":"check to focus on empty slots\nwhen dragging & dropping reporters","costumes tab help":"import a picture from another web page or from\na file on your computer by dropping it here\n","block deletion dialog text":"Are you sure you want to delete this\ncustom block and all its instances?","download to disk text":"This item could not be opened in a new tab.\nIt has been saved to your browser's downloads folder.","unable to export text":"This item could not be exported from Snap!.\nIt's likely that your project may contain a lot of media (sounds and images) or that you are using an older browser.Please try using a recent version of Chrome, Firefox, or Safari."},SnapTranslator.dict.de={language_name:"Deutsch",language_translator:"Jens Mönig, Jadga Hügle","translator_e-mail":"jens@moenig.org, jadga.huegle@sap.com",last_changed:"2019-06-25"},SnapTranslator.dict.it={language_name:"Italiano",language_translator:"Stefano Federici, Alberto Firpo, Massimo Ghisalberti","translator_e-mail":"s_federici@yahoo.com, albertofirpo12@gmail.com, zairik@gmail.com",last_changed:"2016-05-10"},SnapTranslator.dict.ja={language_name:"å,",language_translator:"Kazuhiro Abe","translator_e-mail":"abee@squeakland.jp",last_changed:"2018-10-23"},SnapTranslator.dict.ja_HIRA={language_name:"k{T",language_translator:"Kazuhiro Abe","translator_e-mail":"abee@squeakland.jp",last_changed:"2018-10-23"},SnapTranslator.dict.ko={language_name:"\m´",language_translator:"Yunjae Jang","translator_e-mail":"janggoons@gmail.com",last_changed:"2015-01-21"},SnapTranslator.dict.pt={language_name:"Português",language_translator:"Manuel Menezes de Sequeira","translator_e-mail":"mmsequeira@gmail.com",last_changed:"2019-06-25"},SnapTranslator.dict.cs={language_name:"esky",language_translator:"Michal Moc, Jan Tomsa","translator_e-mail":"info@iguru.eu, jan.tomsa.1976@gmail.com",last_changed:"2015-11-16"},SnapTranslator.dict.zh_CN={language_name:"S-",language_translator:"~ /_N","translator_e-mail":"ubertao@qq.com/djh@rhjxx.cn",last_changed:"2019-01-11"},SnapTranslator.dict.eo={language_name:"Esperanto",language_translator:"Sebastian Cyprych","translator_e-mail":"sebacyp(heliko)gmail(punkto)com",last_changed:"2017-10-01"},SnapTranslator.dict.fr={language_name:"Français",language_translator:"Jean-Jacques Valliet, Mark Rafter, Martin Quinson, Damien Caselli","translator_e-mail":"i.scool@mac.com",last_changed:"2019-06-25"},SnapTranslator.dict.si={language_name:"Slovenaina",language_translator:"Sasa Divjak, Gorazd Breskvar","translator_e-mail":"sasa.divjak@fri.uni-lj.si",last_changed:"2016-04-22"},SnapTranslator.dict.ru={language_name:" CAA:89",language_translator:"Svetlana Ptashnaya, @>A:C@=Q2 @BQ<","translator_e-mail":"svetlanap@berkeley.edu, tema@school830.ru",last_changed:"2018-02-05"},SnapTranslator.dict.es={language_name:"Español",language_translator:"Víctor Manuel Muratalla Morales / Cristián Rizzi Iribarren / Alfonso Ruzafa","translator_e-mail":"victor.muratalla@yahoo.com / rizzi.cristian@gmail.com",last_changed:"2019-06-25"},SnapTranslator.dict.nl={language_name:"Nederlands",language_translator:"Sjoerd Dirk Meijer, Frank Sierens, Jan-Gerard van der Toorn","translator_e-mail":"sjoerddirk@fromScratchEd.nl, frank.sierens@telenet.be, jg.2019@xs4all.nl",last_changed:"2017-09-01"},SnapTranslator.dict.pl={language_name:"Polski",language_translator:"Witek Kranas & deKrain","translator_e-mail":"witek@oeiizk.waw.pl",last_changed:"2017-11-09"},SnapTranslator.dict.zh_TW={language_name:"AÔ-",language_translator:"cch","translator_e-mail":"cchuang2009@gmail.com",last_changed:"2013-8-14"},SnapTranslator.dict.no={language_name:"Norsk",language_translator:"Olav A Marschall","translator_e-mail":"mattebananer@gmail.com",last_changed:"2013-09-16"},SnapTranslator.dict.dk={language_name:"Dansk",language_translator:"FAB, Pelle Hjek","translator_e-mail":"fab@nielsen.mail.dk, hjek@mail.com",last_changed:"2016-11-16"},SnapTranslator.dict.el={language_name:"»»·½¹º¬",language_translator:"Ino Samaras , Alexandros Prekates","translator_e-mail":"ino.samaras@berkeley.edu , aprekates@sch.gr",last_changed:"2019-01-28"},SnapTranslator.dict.ca={language_name:"Català",language_translator:"Bernat Romagosa Carrasquer, Joan Guillén i Pelegay","translator_e-mail":"bernat@snap4arduino.rocks, jguille2@xtec.cat",last_changed:"2019-06-25"},SnapTranslator.dict.ca_VA={language_name:"Català - Valencià",language_translator:"Bernat Romagosa Carrasquer, Joan Guillén i Pelegay, Pilar Embid","translator_e-mail":"bernat@snap4arduino.rocks, jguille2@xtec.cat, embid_mar@gva.es",last_changed:"2018-02-08"},SnapTranslator.dict.fi={language_name:"suomi",language_translator:"Jouni K. Seppänen","translator_e-mail":"jks@iki.fi",last_changed:"2014-04-18"},SnapTranslator.dict.sv={language_name:"svenska",language_translator:"Erik A. Olsson","translator_e-mail":"eolsson@gmail.com",last_changed:"2016-06-09"},SnapTranslator.dict.pt_BR={language_name:"Português do Brasil",language_translator:"Aldo von Wangenheim","translator_e-mail":"awangenh@inf.ufsc.br",last_changed:"2014-04-20"},SnapTranslator.dict.bn={language_name:"¬¾²¾",language_translator:"Dr. Mokter Hossain","translator_e-mail":"mokter@gmail.com",last_changed:"2014-07-02"},SnapTranslator.dict.kn={language_name:"¨Í¨¡",language_translator:"Vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2014-12-02"},SnapTranslator.dict.ml={language_name:"Malayalam",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"},SnapTranslator.dict.ta={language_name:"Tamil",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"},SnapTranslator.dict.te={language_name:"Telagu",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"},SnapTranslator.dict.tr={language_name:"Türkçe",language_translator:"Hakan Atas - www.3drobolab.com, Turgut Güneysu","translator_e-mail":"hakanatas@gmail.com, tguneysu@msn.com, mustafaipekbayrak@gmail.com",last_changed:"2019-01-22"},SnapTranslator.dict.hu={language_name:"Magyar",language_translator:"Makány György","translator_e-mail":"makany.gyorgy@gmail.com",last_changed:"2015-07-27"},SnapTranslator.dict.ia={language_name:"Interlingua",language_translator:"Ken Dickey","translator_e-mail":"Ken.Dickey@whidbey.com",last_changed:"2015-08-09"},SnapTranslator.dict.hr={language_name:"Hrvatski",language_translator:"}eljko Hrvoj","translator_e-mail":"zeljko.hrvoj@zg.t-com.hr",last_changed:"2017-08-15"},SnapTranslator.dict.bg={language_name:"J;30@A:8",language_translator:"Ivan Savov","translator_e-mail":"ivan.savov@gmail.com",last_changed:"2015-11-16"},SnapTranslator.dict.ro={language_name:"Român",language_translator:"Cristian Macarascu","translator_e-mail":"",last_changed:"2015-10-24"},SnapTranslator.dict.ar={language_name:"'D91(J)",language_translator:"7'1B ,D'D","translator_e-mail":"tarekgalal46@hotmail.com",last_changed:"2016-02-24"},SnapTranslator.dict.id={language_name:"Bahasa Indonesia",language_translator:"Alexander Raphael Liu, Emmanuella Rumanti","translator_e-mail":"raphaxander@gmail.com",last_changed:"2019-01-21"},SnapTranslator.dict.et={language_name:"Eesti",language_translator:"Hasso Tepper","translator_e-mail":"hasso.tepper@gmail.com",last_changed:"2016-05-03"},SnapTranslator.dict.gl={language_name:"Galego",language_translator:"tecnoloxia","translator_e-mail":"",last_changed:"2016-11-09"},SnapTranslator.dict.eu={language_name:"Euskara",language_translator:"Asier Iturralde Sarasola","translator_e-mail":"aiturralde@iametza.eus",last_changed:"2018-06-26"},SnapTranslator.dict.ua={language_name:"#:@0W=AL:0",language_translator:"Serhiy Kryzhanovsky","translator_e-mail":"kseryj@gmail.com",last_changed:"2018-10-14"};</script>
        <script>var Cloud;function Cloud(){this.init()}modules=modules||{},modules.cloud="2019-July-17",Cloud.prototype.init=function(){this.urlBasePath="/api/v1",this.url=this.determineCloudDomain()+this.urlBasePath,this.username=null},Cloud.MAX_FILE_SIZE=10485760,Cloud.prototype.knownDomains={"Snap!Cloud":"https://cloud.snap.berkeley.edu","Snap!Cloud (cs10)":"https://snap-cloud.cs10.org","Snap!Cloud (staging)":"https://snap-staging.cs10.org",localhost:"http://localhost:8080","localhost (secure)":"https://localhost:4431"},Cloud.prototype.defaultDomain=Cloud.prototype.knownDomains["Snap!Cloud"],Cloud.prototype.determineCloudDomain=function(){var t=window.location.host,e=document.head.querySelector("[name='snap-cloud-domain']"),n=this.defaultDomain,s=this.knownDomains;return e?e.getAttribute("location"):(Object.keys(s).some(function(e){var o=s[e];return!!Cloud.isMatchingDomain(t,o)&&(n=o,!0)}),n)},Cloud.isMatchingDomain=function(e,o){var t=o.indexOf(e);switch(t){case-1:return!1;case 0:return e===o;default:return/[\.\/]/.test(o[t-1])&&o.length===t+e.length}},Cloud.prototype.parseDict=function(e){var s={};return e&&e.split("&").forEach(function(e){var o=e.split("="),t=decodeURIComponent(o[0]),n=decodeURIComponent(o[1]);s[t]=n}),s},Cloud.prototype.encodeDict=function(e){var o,t,n="";if(!e)return null;for(t in e)e.hasOwnProperty(t)&&(o=encodeURIComponent(t)+"="+encodeURIComponent(e[t]),0<n.length&&(n+="&"),n+=o);return n},Cloud.genericErrorMessage="There was an error while trying to access\na Snap!Cloud service. Please try again later.",Cloud.prototype.genericError=function(){throw new Error(Cloud.genericErrorMessage)},Cloud.prototype.request=function(e,o,t,n,s,r,i){var u=new XMLHttpRequest,c=this,l=this.url+(-1<o.indexOf("%username")?o.replace("%username",encodeURIComponent(this.username)):o);try{u.open(e,l,!0),u.setRequestHeader("Content-Type","application/json; charset=utf-8"),u.withCredentials=!0,u.onreadystatechange=function(){var e;4===u.readyState&&(u.responseText?(e=r&&0!==u.responseText.indexOf('{"errors"')?u.responseText:JSON.parse(u.responseText)).errors?n.call(null,e.errors[0],s):t&&t.call(null,e.message||e):n?n.call(null,s||Cloud.genericErrorMessage,c.url):c.genericError())},u.send(i)}catch(e){n.call(this,e.toString(),"Cloud Error")}},Cloud.prototype.withCredentialsRequest=function(o,t,n,s,r,i,u){var c=this;this.checkCredentials(function(e){e?c.request(o,t,n,s,r,i,u):s.call(this,"You are not logged in","Snap!Cloud")})},Cloud.prototype.initSession=function(e){var o=this;"file:"!==location.protocol&&this.request("POST","/init",function(){o.checkCredentials(e)},function(){},null,!0)},Cloud.prototype.checkCredentials=function(o,e,t){var n=this;this.getCurrentUser(function(e){e.username&&(n.username=e.username,n.verified=e.verified),o&&o.call(null,e.username,e.role,t?JSON.parse(t):null)},e)},Cloud.prototype.getCurrentUser=function(e,o){this.request("GET","/users/c",e,o,"Could not retrieve current user")},Cloud.prototype.getUser=function(e,o,t){this.request("GET","/users/"+encodeURIComponent(e),o,t,"Could not retrieve user")},Cloud.prototype.logout=function(e,o){this.username=null,this.request("POST","/logout",e,o,"logout failed")},Cloud.prototype.login=function(e,o,t,n,s){var r=this;this.request("POST","/users/"+encodeURIComponent(e)+"/login?"+this.encodeDict({persist:t}),function(e){r.checkCredentials(n,s,e)},s,"login failed","false",hex_sha512(o))},Cloud.prototype.signup=function(e,o,t,n,s,r){this.request("POST","/users/"+encodeURIComponent(e)+"?"+this.encodeDict({email:n,password:hex_sha512(o),password_repeat:hex_sha512(t)}),s,r,"signup failed")},Cloud.prototype.changePassword=function(e,o,t,n,s){this.withCredentialsRequest("POST","/users/%username/newpassword?"+this.encodeDict({oldpassword:hex_sha512(e),password_repeat:hex_sha512(t),newpassword:hex_sha512(o)}),n,s,"Could not change password")},Cloud.prototype.resetPassword=function(e,o,t){this.request("POST","/users/"+encodeURIComponent(e)+"/password_reset",o,t,"Password reset request failed")},Cloud.prototype.resendVerification=function(e,o,t){this.request("POST","/users/"+encodeURIComponent(e)+"/resendverification",o,t,"Could not send verification email")},Cloud.prototype.saveProject=function(o,t,n,s){var r=this;this.checkCredentials(function(e){e?r.request("POST","/projects/"+encodeURIComponent(e)+"/"+encodeURIComponent(o),n,s,"Project could not be saved",!1,JSON.stringify(t)):s.call(this,"You are not logged in","Snap!Cloud")})},Cloud.prototype.getProjectList=function(e,o,t){var n="/projects/%username?updatingnotes=true";t&&(n+="&withthumbnail=true"),this.withCredentialsRequest("GET",n,e,o,"Could not fetch projects")},Cloud.prototype.getPublishedProjectList=function(e,o,t,n,s,r,i){var u="/projects"+(e?"/"+encodeURIComponent(e):"")+"?ispublished=true";i&&(u+="&withthumbnail=true"),o&&(u+="&page="+o+"&pagesize="+(t||16)),n&&(u+="&matchtext="+encodeURIComponent(n)),this.request("GET",u,s,r,"Could not fetch projects")},Cloud.prototype.getThumbnail=function(e,o,t,n){this[e?"request":"withCredentialsRequest"]("GET","/projects/"+(e?encodeURIComponent(e):"%username")+"/"+encodeURIComponent(o)+"/thumbnail",t,n,"Could not fetch thumbnail",!0)},Cloud.prototype.getProject=function(e,o,t,n){this.withCredentialsRequest("GET","/projects/%username/"+encodeURIComponent(e)+(o?"?delta="+o:""),t,n,"Could not fetch project "+e,!0)},Cloud.prototype.getPublicProject=function(e,o,t,n){this.request("GET","/projects/"+encodeURIComponent(o)+"/"+encodeURIComponent(e),t,n,"Could not fetch project "+e,!0)},Cloud.prototype.getProjectMetadata=function(e,o,t,n){this.request("GET","/projects/"+encodeURIComponent(o)+"/"+encodeURIComponent(e)+"/metadata",t,n,"Could not fetch metadata for "+e)},Cloud.prototype.getProjectVersionMetadata=function(e,o,t){this.withCredentialsRequest("GET","/projects/%username/"+encodeURIComponent(e)+"/versions",o,t,"Could not fetch versions for project "+e)},Cloud.prototype.getRemixes=function(e,o,t,n,s,r){var i="/projects/"+encodeURIComponent(e)+"/"+encodeURIComponent(o)+"/remixes";t&&(i+="?page="+t+"&pagesize="+(n||16)),this.request("GET",i,s,r,"Could not fetch remixes for project "+o)},Cloud.prototype.deleteProject=function(e,o,t,n){this[o?"request":"withCredentialsRequest"]("DELETE","/projects/"+(o?encodeURIComponent(o):"%username")+"/"+encodeURIComponent(e),t,n,"Could not delete project")},Cloud.prototype.shareProject=function(e,o,t,n){this[o?"request":"withCredentialsRequest"]("POST","/projects/"+(o?encodeURIComponent(o):"%username")+"/"+encodeURIComponent(e)+"/metadata?ispublic=true",t,n,"Could not share project")},Cloud.prototype.unshareProject=function(e,o,t,n){this[o?"request":"withCredentialsRequest"]("POST","/projects/"+(o?encodeURIComponent(o):"%username")+"/"+encodeURIComponent(e)+"/metadata?ispublic=false&ispublished=false",t,n,"Could not unshare project")},Cloud.prototype.publishProject=function(e,o,t,n){this[o?"request":"withCredentialsRequest"]("POST","/projects/"+(o?encodeURIComponent(o):"%username")+"/"+encodeURIComponent(e)+"/metadata?ispublished=true",t,n,"Could not publish project")},Cloud.prototype.unpublishProject=function(e,o,t,n){this[o?"request":"withCredentialsRequest"]("POST","/projects/"+(o?encodeURIComponent(o):"%username")+"/"+encodeURIComponent(e)+"/metadata?ispublished=false",t,n,"Could not unpublish project")},Cloud.prototype.updateNotes=function(e,o,t,n){this.withCredentialsRequest("POST","/projects/%username/"+encodeURIComponent(e)+"/metadata",t,n,"Could not update project notes",!1,JSON.stringify({notes:o}))},Cloud.prototype.updateProjectName=function(e,o,t,n){this.withCredentialsRequest("POST","/projects/%username/"+encodeURIComponent(e)+"/metadata",t,n,"Could not update project name",!1,JSON.stringify({projectname:o}))},Cloud.prototype.newCollection=function(e,o,t){this.withCredentialsRequest("POST","/users/%username/collections/"+encodeURIComponent(e),o,t,"Could not create collection")},Cloud.prototype.getCollectionMetadata=function(e,o,t,n){this.request("GET","/users/"+(e?encodeURIComponent(e):"%username")+"/collections/"+encodeURIComponent(o)+"/metadata",t,n,"Could not fetch metadata for "+o)},Cloud.prototype.getCollectionProjects=function(e,o,t,n,s,r,i){var u="/users/"+(e?encodeURIComponent(e):"%username")+"/collections/"+encodeURIComponent(n)+"/projects";o&&(u+="?page="+o+"&pagesize="+(t||16)),i&&(u+=(o?"&":"?")+"withthumbnail=true"),this.request("GET",u,s,r,"Could not fetch projects")},Cloud.prototype.setCollectionThumbnail=function(e,o,t,n,s){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(e)+"/collections/"+encodeURIComponent(o)+"/thumbnail?id="+encodeURIComponent(t),n,s,"Could not set project thumbnail")},Cloud.prototype.updateCollectionDescription=function(e,o,t,n,s){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(e)+"/collections/"+encodeURIComponent(o)+"/metadata",n,s,"Could not update collection description",!1,JSON.stringify({description:t}))},Cloud.prototype.updateCollectionName=function(e,o,t,n,s){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(e)+"/collections/"+encodeURIComponent(o)+"/metadata",n,s,"Could not update collection name",!1,JSON.stringify({name:t}))},Cloud.prototype.shareCollection=function(e,o,t,n){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(e)+"/collections/"+encodeURIComponent(o)+"/metadata?shared=true",t,n,"Could not share collection")},Cloud.prototype.unshareCollection=function(e,o,t,n){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(e)+"/collections/"+encodeURIComponent(o)+"/metadata?shared=false&published=false",t,n,"Could not unshare collection")},Cloud.prototype.publishCollection=function(e,o,t,n){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(e)+"/collections/"+encodeURIComponent(o)+"/metadata?published=true",t,n,"Could not publish collection")},Cloud.prototype.unpublishCollection=function(e,o,t,n){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(e)+"/collections/"+encodeURIComponent(o)+"/metadata?published=false",t,n,"Could not unpublish collection")},Cloud.prototype.addProjectToCollection=function(e,o,t,n,s,r){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(e)+"/collections/"+encodeURIComponent(o)+"/projects",s,r,"Could not add project to collection",!1,JSON.stringify({username:t,projectname:n}))},Cloud.prototype.removeProjectFromCollection=function(e,o,t,n,s){this.withCredentialsRequest("DELETE","/users/"+encodeURIComponent(e)+"/collections/"+encodeURIComponent(o)+"/projects/"+encodeURIComponent(t),n,s,"Could not remove project from collection")},Cloud.prototype.getUserCollections=function(e,o,t,n,s,r){this[e!==this.username?"request":"withCredentialsRequest"]("GET","/users/"+(e?encodeURIComponent(e):"%username")+"/collections?"+this.encodeDict(0<o?{page:o,pagesize:t||16,matchtext:n?encodeURIComponent(n):""}:{}),s,r,"Could not fetch collections")},Cloud.prototype.getCollectionsContainingProject=function(e,o,t,n,s,r){var i="/projects/"+encodeURIComponent(e)+"/"+encodeURIComponent(o)+"/collections";t&&(i+="?page="+t+"&pagesize="+(n||16)),this.request("GET",i,s,r,"Could not fetch collections for project "+o)},Cloud.prototype.getCollections=function(e,o,t,n,s){var r={page:e,pagesize:e?o||16:""};t&&(r.matchtext=encodeURIComponent(t)),this.request("GET","/collections?"+this.encodeDict(r),n,s,"Could not fetch collections")},Cloud.prototype.deleteCollection=function(e,o,t,n){this.withCredentialsRequest("DELETE","/users/"+encodeURIComponent(e)+"/collections/"+encodeURIComponent(o),t,n,"Could not remove collection")},Cloud.prototype.addEditorToCollection=function(e,o,t,n,s){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(e)+"/collections/"+encodeURIComponent(o)+"/editors",n,s,"Could not add editor to collection",!1,JSON.stringify({editor_username:t}))},Cloud.prototype.removeEditorFromCollection=function(e,o,t,n,s){this.withCredentialsRequest("DELETE","/users/"+encodeURIComponent(e)+"/collections/"+encodeURIComponent(o)+"/editors/"+encodeURIComponent(t),n,s,"Could not remove editor from collection")};</script>
        <script>var hex_sha512=function(t){function t(t){return l.SHA512(function(t){var r,n,e="",i=-1;for(;++i<t.length;)r=t.charCodeAt(i),n=i+1<t.length?t.charCodeAt(i+1):0,55296<=r&&r<=56319&&56320<=n&&n<=57343&&(r=65536+((1023&r)<<10)+(1023&n),i++),r<=127?e+=String.fromCharCode(r):r<=2047?e+=String.fromCharCode(192|r>>>6&31,128|63&r):r<=65535?e+=String.fromCharCode(224|r>>>12&15,128|r>>>6&63,128|63&r):r<=2097151&&(e+=String.fromCharCode(240|r>>>18&7,128|r>>>12&63,128|r>>>6&63,128|63&r));return e}(t)).toString(l.enc.Hex)}var r,n,i,o,e,s,h,a,c,rt,nt,l=l||function(h){var t={},r=t.lib={},n=r.Base={extend:function(t){l.prototype=this;var r=new l;return t&&r.mixIn(t),r.$super=this,r},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var r in t)t.hasOwnProperty(r)&&(this[r]=t[r]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.$super.extend(this)}},a=r.WordArray=n.extend({init:function(t,r){t=this.words=t||[],this.sigBytes=null!=r?r:4*t.length},toString:function(t){return(t||i).stringify(this)},concat:function(t){var r=this.words,n=t.words,e=this.sigBytes,t=t.sigBytes;if(this.clamp(),e%4)for(var i=0;i<t;i++)r[e+i>>>2]|=(n[i>>>2]>>>24-i%4*8&255)<<24-(e+i)%4*8;else if(65535<n.length)for(i=0;i<t;i+=4)r[e+i>>>2]=n[i>>>2];else r.push.apply(r,n);return this.sigBytes+=t,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=h.ceil(r/4)},clone:function(){var t=n.clone.call(this);return t.words=this.words.slice(0),t},random:function(t){for(var r=[],n=0;n<t;n+=4)r.push(4294967296*h.random()|0);return a.create(r,t)}}),e=t.enc={},i=e.Hex={stringify:function(t){for(var r=t.words,t=t.sigBytes,n=[],e=0;e<t;e++){var i=r[e>>>2]>>>24-e%4*8&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16))}return n.join("")},parse:function(t){for(var r=t.length,n=[],e=0;e<r;e+=2)n[e>>>3]|=parseInt(t.substr(e,2),16)<<24-e%8*4;return a.create(n,r/2)}},o=e.Latin1={stringify:function(t){for(var r=t.words,t=t.sigBytes,n=[],e=0;e<t;e++)n.push(String.fromCharCode(r[e>>>2]>>>24-e%4*8&255));return n.join("")},parse:function(t){for(var r=t.length,n=[],e=0;e<r;e++)n[e>>>2]|=(255&t.charCodeAt(e))<<24-e%4*8;return a.create(n,r)}},s=e.Utf8={stringify:function(t){try{return decodeURIComponent(escape(o.stringify(t)))}catch(t){throw Error("Malformed UTF-8 data")}},parse:function(t){return o.parse(unescape(encodeURIComponent(t)))}},c=r.BufferedBlockAlgorithm=n.extend({reset:function(){this._data=a.create(),this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=s.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(t){var r=this._data,n=r.words,e=r.sigBytes,i=this.blockSize,o=e/(4*i),t=(o=t?h.ceil(o):h.max((0|o)-this._minBufferSize,0))*i,e=h.min(4*t,e);if(t){for(var s=0;s<t;s+=i)this._doProcessBlock(n,s);s=n.splice(0,t),r.sigBytes-=e}return a.create(s,e)},clone:function(){var t=n.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0});function l(){}r.Hasher=c.extend({init:function(){this.reset()},reset:function(){c.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize(),this._hash},clone:function(){var t=c.clone.call(this);return t._hash=this._hash.clone(),t},blockSize:16,_createHelper:function(n){return function(t,r){return n.create(r).finalize(t)}},_createHmacHelper:function(n){return function(t,r){return u.HMAC.create(n,r).finalize(t)}}});var u=t.algo={};return t}(Math);function u(){return h.create.apply(h,arguments)}return n=(r=l).lib,i=n.Base,o=n.WordArray,(r=r.x64={}).Word=i.extend({init:function(t,r){this.high=t,this.low=r}}),r.WordArray=i.extend({init:function(t,r){t=this.words=t||[],this.sigBytes=null!=r?r:8*t.length},toX32:function(){for(var t=this.words,r=t.length,n=[],e=0;e<r;e++){var i=t[e];n.push(i.high),n.push(i.low)}return o.create(n,this.sigBytes)},clone:function(){for(var t=i.clone.call(this),r=t.words=this.words.slice(0),n=r.length,e=0;e<n;e++)r[e]=r[e].clone();return t}}),s=(e=l).lib.Hasher,h=(c=e.x64).Word,a=c.WordArray,c=e.algo,rt=[u(1116352408,3609767458),u(1899447441,602891725),u(3049323471,3964484399),u(3921009573,2173295548),u(961987163,4081628472),u(1508970993,3053834265),u(2453635748,2937671579),u(2870763221,3664609560),u(3624381080,2734883394),u(310598401,1164996542),u(607225278,1323610764),u(1426881987,3590304994),u(1925078388,4068182383),u(2162078206,991336113),u(2614888103,633803317),u(3248222580,3479774868),u(3835390401,2666613458),u(4022224774,944711139),u(264347078,2341262773),u(604807628,2007800933),u(770255983,1495990901),u(1249150122,1856431235),u(1555081692,3175218132),u(1996064986,2198950837),u(2554220882,3999719339),u(2821834349,766784016),u(2952996808,2566594879),u(3210313671,3203337956),u(3336571891,1034457026),u(3584528711,2466948901),u(113926993,3758326383),u(338241895,168717936),u(666307205,1188179964),u(773529912,1546045734),u(1294757372,1522805485),u(1396182291,2643833823),u(1695183700,2343527390),u(1986661051,1014477480),u(2177026350,1206759142),u(2456956037,344077627),u(2730485921,1290863460),u(2820302411,3158454273),u(3259730800,3505952657),u(3345764771,106217008),u(3516065817,3606008344),u(3600352804,1432725776),u(4094571909,1467031594),u(275423344,851169720),u(430227734,3100823752),u(506948616,1363258195),u(659060556,3750685593),u(883997877,3785050280),u(958139571,3318307427),u(1322822218,3812723403),u(1537002063,2003034995),u(1747873779,3602036899),u(1955562222,1575990012),u(2024104815,1125592928),u(2227730452,2716904306),u(2361852424,442776044),u(2428436474,593698344),u(2756734187,3733110249),u(3204031479,2999351573),u(3329325298,3815920427),u(3391569614,3928383900),u(3515267271,566280711),u(3940187606,3454069534),u(4118630271,4000239992),u(116418474,1914138554),u(174292421,2731055270),u(289380356,3203993006),u(460393269,320620315),u(685471733,587496836),u(852142971,1086792851),u(1017036298,365543100),u(1126000580,2618297676),u(1288033470,3409855158),u(1501505948,4234509866),u(1607167915,987167468),u(1816402316,1246189591)],nt=[],function(){for(var t=0;t<80;t++)nt[t]=u()}(),c=c.SHA512=s.extend({_doReset:function(){this._hash=a.create([u(1779033703,4089235720),u(3144134277,2227873595),u(1013904242,4271175723),u(2773480762,1595750129),u(1359893119,2917565137),u(2600822924,725511199),u(528734635,4215389547),u(1541459225,327033209)])},_doProcessBlock:function(t,r){for(var n=(c=this._hash.words)[0],e=c[1],i=c[2],o=c[3],s=c[4],h=c[5],a=c[6],c=c[7],l=n.high,u=n.low,f=e.high,g=e.low,d=i.high,p=i.low,w=o.high,_=o.low,y=s.high,v=s.low,B=h.high,m=h.low,S=a.high,x=a.low,C=c.high,H=c.low,A=l,z=u,b=f,k=g,W=d,I=p,P=w,R=_,U=y,D=v,F=B,M=m,j=S,O=x,X=C,$=H,E=0;E<80;E++){var L,T=nt[E];E<16?(L=T.high=0|t[r+2*E],G=T.low=0|t[r+2*E+1]):(G=(L=nt[E-15]).high,L=((Q=L.low)<<31|G>>>1)^(Q<<24|G>>>8)^G>>>7,Q=(G<<31|Q>>>1)^(G<<24|Q>>>8)^(G<<25|Q>>>7),G=(V=nt[E-2]).high,V=((q=V.low)<<13|G>>>19)^(G<<3|q>>>29)^G>>>6,q=(G<<13|q>>>19)^(q<<3|G>>>29)^(G<<26|q>>>6),J=(G=nt[E-7]).high,tt=(K=nt[E-16]).high,K=K.low,L=(L=(L=L+J+((G=Q+G.low)>>>0<Q>>>0?1:0))+V+((G=G+q)>>>0<q>>>0?1:0))+tt+((G=G+K)>>>0<K>>>0?1:0),T.high=L,T.low=G);var q,G,J=U&F^~U&j,K=D&M^~D&O,T=A&b^A&W^b&W,N=z&k^z&I^k&I,Q=(z<<4|A>>>28)^(A<<30|z>>>2)^(A<<25|z>>>7),V=(A<<4|z>>>28)^(z<<30|A>>>2)^(z<<25|A>>>7),Y=(q=rt[E]).high,Z=q.low,tt=X+((D<<18|U>>>14)^(D<<14|U>>>18)^(U<<23|D>>>9))+((q=$+((U<<18|D>>>14)^(U<<14|D>>>18)^(D<<23|U>>>9)))>>>0<$>>>0?1:0),X=j,$=O,j=F,O=M,F=U,M=D,U=P+(tt=(tt=(tt=tt+J+((q=q+K)>>>0<K>>>0?1:0))+Y+((q=q+Z)>>>0<Z>>>0?1:0))+L+((q=q+G)>>>0<G>>>0?1:0))+((D=R+q|0)>>>0<R>>>0?1:0)|0,P=W,R=I,W=b,I=k,b=A,k=z,A=tt+(T=Q+T+((G=V+N)>>>0<V>>>0?1:0))+((z=q+G|0)>>>0<q>>>0?1:0)|0}u=n.low=u+z|0,n.high=l+A+(u>>>0<z>>>0?1:0)|0,g=e.low=g+k|0,e.high=f+b+(g>>>0<k>>>0?1:0)|0,p=i.low=p+I|0,i.high=d+W+(p>>>0<I>>>0?1:0)|0,_=o.low=_+R|0,o.high=w+P+(_>>>0<R>>>0?1:0)|0,v=s.low=v+D|0,s.high=y+U+(v>>>0<D>>>0?1:0)|0,m=h.low=m+M|0,h.high=B+F+(m>>>0<M>>>0?1:0)|0,x=a.low=x+O|0,a.high=S+j+(x>>>0<O>>>0?1:0)|0,H=c.low=H+$|0,c.high=C+X+(H>>>0<$>>>0?1:0)|0},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,e=8*t.sigBytes;r[e>>>5]|=128<<24-e%32,r[31+(128+e>>>10<<5)]=n,t.sigBytes=4*r.length,this._process(),this._hash=this._hash.toX32()},blockSize:32}),e.SHA512=s._createHelper(c),e.HmacSHA512=s._createHmacHelper(c),t}({});</script>
        <script>var saveAs=saveAs||function(d){"use strict";if(!(void 0===d||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var e=d.document,s=function(){return d.URL||d.webkitURL||d},f=e.createElementNS("http://www.w3.org/1999/xhtml","a"),u="download"in f,c=/constructor/i.test(d.HTMLElement)||d.safari,l=/CriOS\/[\d]+/.test(navigator.userAgent),p=function(e){setTimeout(function(){"string"==typeof e?s().revokeObjectURL(e):e.remove()},4e4)},v=function(e,t,n){for(var o=(t=[].concat(t)).length;o--;){var r=e["on"+t[o]];if("function"==typeof r)try{r.call(e,n||e)}catch(e){!function(e){(d.setImmediate||d.setTimeout)(function(){throw e},0)}(e)}}},w=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},o=function(e,n,t){t||(e=w(e));function o(){v(a,"writestart progress write writeend".split(" "))}var r,a=this,i="application/octet-stream"===e.type;if(a.readyState=a.INIT,u)return r=s().createObjectURL(e),void setTimeout(function(){var e,t;f.href=r,f.download=n,e=f,t=new MouseEvent("click"),e.dispatchEvent(t),o(),p(r),a.readyState=a.DONE});!function(){if((l||i&&c)&&d.FileReader){var t=new FileReader;return t.onloadend=function(){var e=l?t.result:t.result.replace(/^data:[^;]*;/,"data:attachment/file;");d.open(e,"_blank")||(d.location.href=e),e=void 0,a.readyState=a.DONE,o()},t.readAsDataURL(e),a.readyState=a.INIT}r=r||s().createObjectURL(e),!i&&d.open(r,"_blank")||(d.location.href=r),a.readyState=a.DONE,o(),p(r)}()},t=o.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return t=t||e.name||"download",n||(e=w(e)),navigator.msSaveOrOpenBlob(e,t)}:(t.abort=function(){},t.readyState=t.INIT=0,t.WRITING=1,t.DONE=2,t.error=t.onwritestart=t.onprogress=t.onwrite=t.onabort=t.onerror=t.onwriteend=null,function(e,t,n){return new o(e,t||e.name||"download",n)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs});</script>
        <script type="text/javascript">var world;function loop(){requestAnimationFrame(loop),world.doOneCycle()}window.onload=function(){world=new WorldMorph(document.getElementById("world")),(new IDE_Morph).openIn(world),loop()}</script>
    </head>
    <body style="margin:0">
        <canvas id="world" tabindex="1" style="position:absolute">
    </body>
</html>

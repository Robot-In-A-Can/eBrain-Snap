<blocks app="Snap! 7, https://snap.berkeley.edu" version="2"><palette><category name="Advanced eBrain" color="0,116,143,1"/></palette><block-definition s="G-code to plotter %&apos;g-code&apos;" type="command" category="Advanced eBrain"><header></header><code></code><translations></translations><inputs><input type="%s"></input></inputs><script><custom-block s="Unpause $pointRight plotter"></custom-block><block s="doDeclareVariables"><list><l>master list</l><l>x coords</l><l>y coords</l><l>previousX</l><l>previousY</l></list></block><block s="doSetVar"><l>master list</l><block s="evaluate"><block s="reportJSFunction"><list><l>gcode</l></list><l>if (typeof world.plotterState === &apos;undefined&apos;) {&#xD;  world.plotterState = {paused: false, position:{X:0, Y:0}};&#xD;}&#xD;function badParsed(val) {&#xD;  if (isNaN(val)) {&#xD;    return !(val === undefined || val === null);&#xD;  } else {&#xD;    return false;&#xD;  }&#xD;} &#xD;&#xD;var units = "mm";&#xD;// Implemented commands:&#xD;// g20: inches g21: millimeters&#xD;// M2: program end&#xD;&#xD;// Unimplemented, but might implement:&#xD;// g90: absolute positioning&#xD;// g91: relative positioning&#xD;&#xD;var points = [];&#xD;var lines = gcode.split(/\r?\n/);&#xD;for (l of lines) {&#xD;  // cut comment if it exists&#xD;  if (l.includes(";")) {&#xD;    l = l.split(";")[0];&#xD;  }&#xD;  if (l.startsWith("G20")) {&#xD;    units = "inches";&#xD;  } else if (l.startsWith("G21")) {&#xD;    units = "mm";&#xD;  } else if (l.startsWith("G1") || l.startsWith("G0")) {&#xD;    var line = l.split(" ");&#xD;    var point = {};&#xD;    for (const c of line) {&#xD;      if (c.startsWith("X")) {&#xD;        point.X = parseFloat(c.substring(1));&#xD;        if (units === "inches") {&#xD;          point.X *= 25.4;&#xD;        }&#xD;      } else if (c.startsWith("Y")) {&#xD;        point.Y = parseFloat(c.substring(1));&#xD;        if (units === "inches") {&#xD;          point.Y *= 25.4;&#xD;        }&#xD;      }&#xD;    }&#xD;    // if saw an X or Y but could not parse the number, stop parsing.&#xD;    if (badParsed(point.X) || badParsed(point.Y)) {&#xD;      morphicAlert("Error!", "Invalid point " + l + " for command G1");&#xD;      return new List([]);&#xD;    } else {&#xD;      // if the G1 is missing an X or Y, silently ignore it&#xD;      if (typeof point.X === &apos;number&apos; &amp;&amp; typeof point.Y === &apos;number&apos;) {&#xD;        points.push(point);&#xD;      }&#xD;    }&#xD;  } else if (l.startsWith("M2")) {&#xD;    break; // stop job when we see M2&#xD;  }&#xD;}&#xD;if (points.length === 0) {&#xD;  morphicAlert("Error!", "No points were found in the Gcode");&#xD;  return new List([]);&#xD;}&#xD;var Xcoords = [];&#xD;var Ycoords = [];&#xD;for (const point of points) {&#xD;  Xcoords.push(point.X);&#xD;  Ycoords.push(point.Y);&#xD;}&#xD;return new List([new List(Xcoords), new List(Ycoords)]);&#xD;</l></block><list><block var="g-code"/></list></block></block><block s="doIf"><block s="reportEquals"><l>0</l><block s="reportListAttribute"><l><option>length</option></l><block var="master list"/></block></block><script><block s="doStopThis"><l><option>this block</option></l></block></script></block><block s="doSetVar"><l>x coords</l><block s="reportListItem"><l>1</l><block var="master list"/></block></block><block s="doSetVar"><l>y coords</l><block s="reportListItem"><l>2</l><block var="master list"/></block></block><block s="doFor"><l>i</l><l>1</l><block s="reportListAttribute"><l><option>length</option></l><block var="x coords"/></block><script><block s="doWaitUntil"><block s="evaluate"><block s="reportJSFunction"><list></list><l>return world.plotterState.paused === false;</l></block><list></list></block></block><custom-block s="Move plotter to position X %n Y %n"><block s="reportListItem"><block var="i"/><block var="x coords"/></block><block s="reportListItem"><block var="i"/><block var="y coords"/></block></custom-block></script></block></script><scripts><script x="84.16666666666667" y="1314.6666666666667"><custom-block s="Reset plotter position to X=0 Y=0"></custom-block></script><script x="295" y="1313.5"><custom-block s="Pause $pause plotter"></custom-block></script><script x="416.6666666666667" y="1309.6666666666667"><custom-block s="Unpause $pointRight plotter"></custom-block></script><script x="107.5" y="1378.3333333333335"><custom-block s="Move plotter to position X %n Y %n"><l>0</l><l>0</l></custom-block></script><script x="371.6666666666667" y="1377.8333333333335"><custom-block s="Move plotter relative X %n Y %n"><l>0</l><l>0</l></custom-block></script></scripts></block-definition><block-definition s="Reset plotter position to X=0 Y=0" type="command" category="Advanced eBrain"><header></header><code></code><translations></translations><inputs></inputs><script><block s="doRun"><block s="reportJSFunction"><list></list><l>if (typeof world.plotterState === &apos;undefined&apos;) {&#xD;  world.plotterState = {paused: false, position:{X:0, Y:0}};&#xD;}&#xD;world.plotterState.position = {X:0, Y:0};</l></block><list></list></block></script></block-definition><block-definition s="Pause $pause plotter" type="command" category="Advanced eBrain"><header></header><code></code><translations></translations><inputs></inputs><script><block s="doRun"><block s="reportJSFunction"><list></list><l>if (typeof world.plotterState === &apos;undefined&apos;) {&#xD;  world.plotterState = {paused: false, position:{X:0, Y:0}};&#xD;}&#xD;world.plotterState.paused = true;</l></block><list></list></block></script></block-definition><block-definition s="Unpause $pointRight plotter" type="command" category="Advanced eBrain"><header></header><code></code><translations></translations><inputs></inputs><script><block s="doRun"><block s="reportJSFunction"><list></list><l>if (typeof world.plotterState === &apos;undefined&apos;) {&#xD;  world.plotterState = {paused: false, position:{X:0, Y:0}};&#xD;}&#xD;world.plotterState.paused = false;</l></block><list></list></block></script></block-definition><block-definition s="Move plotter to position X %&apos;X&apos; Y %&apos;Y&apos;" type="command" category="Advanced eBrain"><header></header><code></code><translations></translations><inputs><input type="%n">0</input><input type="%n">0</input></inputs><script><block s="doRun"><block s="reportJSFunction"><list></list><l>if (typeof world.plotterState === &apos;undefined&apos;) {&#xD;  world.plotterState = {paused: false, position:{X:0, Y:0}};&#xD;}</l></block><list></list></block><block s="doDeclareVariables"><list><l>deltax</l><l>deltay</l></list></block><block s="doSetVar"><l>deltax</l><block s="evaluate"><block s="reportJSFunction"><list><l>X</l></list><l>return X - world.plotterState.position.X;</l></block><list><block var="X"/></list></block></block><block s="doSetVar"><l>deltay</l><block s="evaluate"><block s="reportJSFunction"><list><l>Y</l></list><l>return Y - world.plotterState.position.Y;</l></block><list><block var="Y"/></list></block></block><custom-block s="Move plotter relative X %n Y %n"><block var="deltax"/><block var="deltay"/></custom-block><block s="doRun"><block s="reportJSFunction"><list><l>x</l><l>y</l></list><l>world.plotterState.position.X = x;&#xD;world.plotterState.position.Y = y;</l></block><list><block var="X"/><block var="Y"/></list></block></script></block-definition><block-definition s="Move plotter relative X %&apos;deltax&apos; Y %&apos;deltay&apos;" type="command" category="Advanced eBrain"><header></header><code></code><translations></translations><inputs><input type="%n">0</input><input type="%n">0</input></inputs><script><block s="doRun"><block s="reportJSFunction"><list></list><l>if (typeof world.plotterState === &apos;undefined&apos;) {&#xD;  world.plotterState = {paused: false, position:{X:0, Y:0}};&#xD;}</l></block><list></list></block><block s="doIfElse"><block s="reportGreaterThan"><block s="reportMonadic"><l><option>abs</option></l><block var="deltax"/></block><block s="reportMonadic"><l><option>abs</option></l><block var="deltay"/></block></block><script><custom-block s="Advanced Move Left distance: %s speed: %s Right distance: %s speed: %s"><block s="reportProduct"><l>-1</l><block var="deltax"/></block><l>1</l><block var="deltay"/><block s="reportIfElse"><block s="reportEquals"><block var="deltay"/><l>0</l></block><l>1</l><block s="reportQuotient"><block s="reportMonadic"><l><option>abs</option></l><block var="deltay"/></block><block s="reportMonadic"><l><option>abs</option></l><block var="deltax"/></block></block></block></custom-block></script><script><custom-block s="Advanced Move Left distance: %s speed: %s Right distance: %s speed: %s"><block s="reportProduct"><l>-1</l><block var="deltax"/></block><block s="reportIfElse"><block s="reportEquals"><block var="deltax"/><l>0</l></block><l>1</l><block s="reportQuotient"><block s="reportMonadic"><l><option>abs</option></l><block var="deltax"/></block><block s="reportMonadic"><l><option>abs</option></l><block var="deltay"/></block></block></block><block var="deltay"/><l>1</l></custom-block></script></block><block s="doRun"><block s="reportJSFunction"><list><l>deltax</l><l>deltay</l></list><l>world.plotterState.position.X += deltax;&#xD;world.plotterState.position.Y += deltay;</l></block><list><block var="deltax"/><block var="deltay"/></list></block></script></block-definition></blocks>